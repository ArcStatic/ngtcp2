cscope 15 $HOME/Documents/L5project/rtp-quic/mininet/ngtcp2 -q 0000003731 0001048265
	@config.h

11 
	#HAVE_ARPA_INET_H
 1

	)

14 
	#HAVE_CXX14
 1

	)

17 
	#HAVE_DLFCN_H
 1

	)

20 
	#HAVE_INTTYPES_H
 1

	)

23 
	#HAVE_MEMMOVE
 1

	)

26 
	#HAVE_MEMORY_H
 1

	)

29 
	#HAVE_MEMSET
 1

	)

32 
	#HAVE_PTRDIFF_T
 1

	)

35 
	#HAVE_STDDEF_H
 1

	)

38 
	#HAVE_STDINT_H
 1

	)

41 
	#HAVE_STDLIB_H
 1

	)

44 
	#HAVE_STRINGS_H
 1

	)

47 
	#HAVE_STRING_H
 1

	)

50 
	#HAVE_SYS_STAT_H
 1

	)

53 
	#HAVE_SYS_TYPES_H
 1

	)

56 
	#HAVE_UNISTD_H
 1

	)

59 
	#LT_OBJDIR
 ".libs/"

	)

62 
	#PACKAGE
 "ngtı2"

	)

65 
	#PACKAGE_BUGREPORT
 "t-tujikawa@u£rs.sourûfÜge.Ãt"

	)

68 
	#PACKAGE_NAME
 "ngtı2"

	)

71 
	#PACKAGE_STRING
 "ngtı2 0.1.0-DEV"

	)

74 
	#PACKAGE_TARNAME
 "ngtı2"

	)

77 
	#PACKAGE_URL
 ""

	)

80 
	#PACKAGE_VERSION
 "0.1.0-DEV"

	)

83 
	#STDC_HEADERS
 1

	)

86 #iâdeà
_ALL_SOURCE


87 
	#_ALL_SOURCE
 1

	)

90 #iâdeà
_GNU_SOURCE


91 
	#_GNU_SOURCE
 1

	)

94 #iâdeà
_POSIX_PTHREAD_SEMANTICS


95 
	#_POSIX_PTHREAD_SEMANTICS
 1

	)

98 #iâdeà
_TANDEM_SOURCE


99 
	#_TANDEM_SOURCE
 1

	)

102 #iâdeà
__EXTENSIONS__


103 
	#__EXTENSIONS__
 1

	)

108 
	#VERSION
 "0.1.0-DEV"

	)

112 #ià
defšed
 
AC_APPLE_UNIVERSAL_BUILD


113 #ià
defšed
 
__BIG_ENDIAN__


114 
	#WORDS_BIGENDIAN
 1

	)

117 #iâdeà
WORDS_BIGENDIAN


123 #iâdeà
_DARWIN_USE_64_BIT_INODE


124 
	#_DARWIN_USE_64_BIT_INODE
 1

	)

163 #iâdeà
__ılu¥lus


	@examples/client.cc

25 
	~<c¡dlib
>

26 
	~<ÿs£¹
>

27 
	~<û¼no
>

28 
	~<io¡»am
>

29 
	~<®gÜ™hm
>

30 
	~<memÜy
>

31 
	~<f¡»am
>

34 
	~<uni¡d.h
>

35 
	~<g‘İt.h
>

36 
	~<sys/ty³s.h
>

37 
	~<sys/¡©.h
>

38 
	~<fú.h
>

39 
	~<sys/sock‘.h
>

40 
	~<Ãtdb.h
>

41 
	~<sys/mmª.h
>

43 
	~<İ’s¦/bio.h
>

44 
	~<İ’s¦/”r.h
>

46 
	~"ş›Á.h
"

47 
	~"ÃtwÜk.h
"

48 
	~"debug.h
"

49 
	~"ut.h
"

50 
	~"üy±o.h
"

51 
	~"sh¬ed.h
"

52 
	~"keylog.h
"

54 
usšg
 
Çme¥aû
 
	gngtı2
;

56 
	gÇme¥aû
 {

57 autØ
	g¿ndg’
 = 
ut
::
make_mt19937
();

60 
	gÇme¥aû
 {

61 
CÚfig
 
	gcÚfig
{};

64 
	gBufãr
::
	$Bufãr
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
)

65 : 
buf
{
d©a
, d©¨+ 
d©®’
},

66 
begš
(
buf
.
d©a
()),

67 
h—d
(
begš
),

68 

(
begš
 + 
d©®’
) {}

69 
	gBufãr
::
	$Bufãr
(
ušt8_t
 *
begš
, ušt8_ˆ*
’d
)

70 : 
	`begš
(
begš
), 
	`h—d
(begš), 
	$
(
’d
è{
	}
}

71 
	gBufãr
::
	$Bufãr
(
size_t
 
d©®’
)

72 : 
	`buf
(
d©®’
), 
	`begš
(
buf
.
	`d©a
()), 
	`h—d
(
begš
), 
	$
(
begš
è{
	}
}

73 
	gBufãr
::
	$Bufãr
(è: 
	`begš
(
buf
.
	`d©a
()), 
	`h—d
(
begš
), 
	$
(
begš
è{
	}
}

75 
	gSŒ—m
::
	$SŒ—m
(
ušt64_t
 
¡»am_id
)

76 : 
	`¡»am_id
(
¡»am_id
),

77 
	`¡»ambuf_idx
(0),

78 
	`tx_¡»am_off£t
(0),

79 
	$should_£nd_fš
(
çl£
è{
	}
}

81 
	gSŒ—m
::~
	$SŒ—m
(è{
	}
}

83 
SŒ—m
::
	$bufãr_fe
() {

84 
¡»ambuf
.
	`em¶aû_back
(
cÚfig
.
d©a
, cÚfig.d©¨+ cÚfig.
d©®’
);

85 
should_£nd_fš
 = 
Œue
;

86 
	}
}

88 
	gÇme¥aû
 {

89 
key_cb
(
SSL
 *
s¦
, 
Çme
, cÚ¡ *
£ü‘
, 
size_t
 
£ü‘Ën
,

90 *
¬g
) {

91 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
¬g
);

93 ià(
	gc
->
Ú_key
(
Çme
, 
£ü‘
, 
£ü‘Ën
) != 0) {

97 
	gkeylog
::
log_£ü‘
(
s¦
, 
Çme
, 
£ü‘
, 
£ü‘Ën
);

103 
	gCl›Á
::
	$Ú_key
(
Çme
, cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
) {

104 
rv
;

106 
Çme
) {

107 
SSL_KEY_CLIENT_EARLY_TRAFFIC
:

108 
SSL_KEY_CLIENT_HANDSHAKE_TRAFFIC
:

109 
SSL_KEY_SERVER_HANDSHAKE_TRAFFIC
:

111 
SSL_KEY_CLIENT_APPLICATION_TRAFFIC
:

112 
tx_£ü‘_
.
	`assign
(
£ü‘
, seü‘ + 
£ü‘Ën
);

114 
SSL_KEY_SERVER_APPLICATION_TRAFFIC
:

115 
rx_£ü‘_
.
	`assign
(
£ü‘
, seü‘ + 
£ü‘Ën
);

122 
rv
 = 
üy±o
::
	`ÃgÙŸ‹d_´f
(
üy±o_ùx_
, 
s¦_
);

123 ià(
rv
 != 0) {

126 
rv
 = 
üy±o
::
	`ÃgÙŸ‹d_«ad
(
üy±o_ùx_
, 
s¦_
);

127 ià(
rv
 != 0) {

131 
¡d
::
¬¿y
<
ušt8_t
, 64> 
key
, 
iv
, 
hp
;

132 autØ
keyËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_key
(

133 
key
.
	`d©a
(), key.
	`size
(), 
£ü‘
, 
£ü‘Ën
, 
üy±o_ùx_
);

134 ià(
keyËn
 < 0) {

138 autØ
ivËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_iv
(
iv
.
	`d©a
(), iv.
	`size
(), 
£ü‘
,

139 
£ü‘Ën
, 
üy±o_ùx_
);

140 ià(
ivËn
 < 0) {

144 autØ
h¶’
 = 
üy±o
::
	`d”ive_h—d”_´ÙeùiÚ_key
(

145 
hp
.
	`d©a
(), hp.
	`size
(), 
£ü‘
, 
£ü‘Ën
, 
üy±o_ùx_
);

146 ià(
h¶’
 < 0) {

151 
	`ngtı2_cÚn_£t_«ad_ov”h—d
(
cÚn_
, 
üy±o
::
	`«ad_max_ov”h—d
(
üy±o_ùx_
));

153 
Çme
) {

154 
SSL_KEY_CLIENT_EARLY_TRAFFIC
:

155 ià(!
cÚfig
.
qu›t
) {

156 
¡d
::
û¼
 << "ş›Á_—¾y_Œaffic" << std::
’dl
;

158 
	`ngtı2_cÚn_š¡®l_—¾y_keys
(
cÚn_
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.d©a(), 
ivËn
,

159 
hp
.
	`d©a
(), 
h¶’
);

161 
SSL_KEY_CLIENT_HANDSHAKE_TRAFFIC
:

162 ià(!
cÚfig
.
qu›t
) {

163 
¡d
::
û¼
 << "ş›Á_hªdshake_Œaffic" << std::
’dl
;

165 
	`ngtı2_cÚn_š¡®l_hªdshake_tx_keys
(
cÚn_
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.data(),

166 
ivËn
, 
hp
.
	`d©a
(), 
h¶’
);

168 
SSL_KEY_CLIENT_APPLICATION_TRAFFIC
:

169 ià(!
cÚfig
.
qu›t
) {

170 
¡d
::
û¼
 << "ş›Á_­¶iÿtiÚ_Œaffic" << std::
’dl
;

172 
	`ngtı2_cÚn_š¡®l_tx_keys
(
cÚn_
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.d©a(), 
ivËn
,

173 
hp
.
	`d©a
(), 
h¶’
);

175 
SSL_KEY_SERVER_HANDSHAKE_TRAFFIC
:

176 ià(!
cÚfig
.
qu›t
) {

177 
¡d
::
û¼
 << "£rv”_hªdshake_Œaffic" << std::
’dl
;

179 
	`ngtı2_cÚn_š¡®l_hªdshake_rx_keys
(
cÚn_
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.data(),

180 
ivËn
, 
hp
.
	`d©a
(), 
h¶’
);

182 
SSL_KEY_SERVER_APPLICATION_TRAFFIC
:

183 ià(!
cÚfig
.
qu›t
) {

184 
¡d
::
û¼
 << "£rv”_­¶iÿtiÚ_Œaffic" << std::
’dl
;

186 
	`ngtı2_cÚn_š¡®l_rx_keys
(
cÚn_
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.d©a(), 
ivËn
,

187 
hp
.
	`d©a
(), 
h¶’
);

191 ià(!
cÚfig
.
qu›t
) {

192 
debug
::
	`´št_£ü‘s
(
£ü‘
, 
£ü‘Ën
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.data(),

193 
ivËn
, 
hp
.
	`d©a
(), 
h¶’
);

197 
	}
}

199 
	gÇme¥aû
 {

200 
msg_cb
(
wr™e_p
, 
v”siÚ
, 
cÚ‹Á_ty³
, cÚ¡ *
buf
,

201 
size_t
 
Ën
, 
SSL
 *
s¦
, *
¬g
) {

202 
	grv
;

204 ià(!
	gcÚfig
.
	gqu›t
) {

205 
	g¡d
::
û¼
 << "msg_cb: wr™e_p=" << 
wr™e_p
 << " v”siÚ=" << 
v”siÚ


206 << " cÚ‹Á_ty³=" << 
cÚ‹Á_ty³
 << "†’=" << 
Ën


207 << 
¡d
::
’dl
;

210 ià(!
	gwr™e_p
) {

214 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
¬g
);

215 autØ
	gmsg
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
buf
);

217 
	gcÚ‹Á_ty³
) {

218 
	gSSL3_RT_HANDSHAKE
:

220 
	gSSL3_RT_ALERT
:

221 
as£¹
(
Ën
 == 2);

222 ià(
	gmsg
[0] != 2 ) {

225 
	gc
->
£t_s_®”t
(
msg
[1]);

231 
	grv
 = 
c
->
wr™e_ş›Á_hªdshake
(
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
buf
), 
Ën
);

233 
as£¹
(0 =ğ
rv
);

237 
	gÇme¥aû
 {

238 
bio_wr™e
(
BIO
 *
b
, cÚ¡ *
buf
, 
Ën
) {

239 
as£¹
(0);

244 
	gÇme¥aû
 {

245 
bio_»ad
(
BIO
 *
b
, *
buf
, 
Ën
) {

246 
BIO_ş—r_»Œy_æags
(
b
);

248 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
BIO_g‘_d©a
(
b
));

250 
	gËn
 = 
c
->
»ad_£rv”_hªdshake
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
buf
), 
Ën
);

251 ià(
	gËn
 == 0) {

252 
BIO_£t_»Œy_»ad
(
b
);

256  
	gËn
;

260 
	gÇme¥aû
 {

261 
bio_puts
(
BIO
 *
b
, cÚ¡ *
¡r
è{  
bio_wr™e
(b, sŒ, 
¡¾’
(str)); }

264 
	gÇme¥aû
 {

265 
bio_g‘s
(
BIO
 *
b
, *
buf
, 
Ën
) {  -1; }

268 
	gÇme¥aû
 {

269 
bio_ù¾
(
BIO
 *
b
, 
cmd
, 
num
, *
±r
) {

270 
	gcmd
) {

271 
	gBIO_CTRL_FLUSH
:

279 
	gÇme¥aû
 {

280 
bio_ü—‹
(
BIO
 *
b
) {

281 
BIO_£t_š™
(
b
, 1);

286 
	gÇme¥aû
 {

287 
bio_de¡roy
(
BIO
 *
b
) {

288 ià(
	gb
 =ğ
nuÎ±r
) {

296 
	gÇme¥aû
 {

297 
BIO_METHOD
 *
ü—‹_bio_m‘hod
() {

298 autØ
	gm‘h
 = 
BIO_m‘h_Ãw
(
BIO_TYPE_FD
, "bio");

299 
BIO_m‘h_£t_wr™e
(
m‘h
, 
bio_wr™e
);

300 
BIO_m‘h_£t_»ad
(
m‘h
, 
bio_»ad
);

301 
BIO_m‘h_£t_puts
(
m‘h
, 
bio_puts
);

302 
BIO_m‘h_£t_g‘s
(
m‘h
, 
bio_g‘s
);

303 
BIO_m‘h_£t_ù¾
(
m‘h
, 
bio_ù¾
);

304 
BIO_m‘h_£t_ü—‹
(
m‘h
, 
bio_ü—‹
);

305 
BIO_m‘h_£t_de¡roy
(
m‘h
, 
bio_de¡roy
);

306  
	gm‘h
;

310 
	gÇme¥aû
 {

311 
wr™e_¹p_cb
(
ev_loİ
 *
loİ
, 
ev_tim”
 *
w
, 
»v’ts
) {

314 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
w
->
d©a
);

316 
	gc
->
	g¹p_£qnum_
 += 1;

318 
	gc
->
	g¹p_time¡amp_
 += 3000;

322 
	gc
->
£nd_¹p
();

329 
	gÇme¥aû
 {

330 
wr™ecb
(
ev_loİ
 *
loİ
, 
ev_io
 *
w
, 
»v’ts
) {

331 
	g¡d
::
û¼
 << "wr™ecb" << 
¡d
::
’dl
;

332 
ev_io_¡İ
(
loİ
, 
w
);

334 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
w
->
d©a
);

336 autØ
	grv
 = 
c
->
Ú_wr™e
();

337 
	grv
) {

340 
	gNETWORK_ERR_SEND_NON_FATAL
:

341 
c
->
¡¬t_wev
();

347 
	gÇme¥aû
 {

348 
»adcb
(
ev_loİ
 *
loİ
, 
ev_io
 *
w
, 
»v’ts
) {

349 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
w
->
d©a
);

351 ià(
	gc
->
Ú_»ad
() != 0) {

354 autØ
	grv
 = 
c
->
Ú_wr™e
();

355 
	grv
) {

358 
	gNETWORK_ERR_SEND_NON_FATAL
:

359 
c
->
¡¬t_wev
();

365 
	gÇme¥aû
 {

366 
¡dš_»adcb
(
ev_loİ
 *
loİ
, 
ev_io
 *
w
, 
»v’ts
) {

367 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
w
->
d©a
);

369 ià(
	gc
->
£nd_š‹¿ùive_šput
()) {

370 
	gc
->
discÚÃù
();

375 
	gÇme¥aû
 {

376 
timeoutcb
(
ev_loİ
 *
loİ
, 
ev_tim”
 *
w
, 
»v’ts
) {

377 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
w
->
d©a
);

379 ià(!
	gcÚfig
.
	gqu›t
) {

380 
	g¡d
::
û¼
 << "Timeout" << 
¡d
::
’dl
;

383 
	gc
->
discÚÃù
();

387 
	gÇme¥aû
 {

388 
»Œªsm™cb
(
ev_loİ
 *
loİ
, 
ev_tim”
 *
w
, 
»v’ts
) {

389 
	grv
;

390 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
w
->
d©a
);

391 autØ
	gcÚn
 = 
c
->
cÚn
();

392 autØ
	gnow
 = 
ut
::
time¡amp
(
loİ
);

394 ià(
ngtı2_cÚn_loss_d‘eùiÚ_expœy
(
cÚn
è<ğ
now
) {

395 
rv
 = 
c
->
Ú_wr™e
(
Œue
);

396 ià(
	grv
 != 0) {

397 
ç
;

401 ià(
ngtı2_cÚn_ack_d–ay_expœy
(
cÚn
è<ğ
now
) {

402 
rv
 = 
c
->
Ú_wr™e
();

403 ià(
	grv
 != 0) {

404 
ç
;

410 
	gç
:

411 
rv
) {

412 
NETWORK_ERR_SEND_NON_FATAL
:

413 
c
->
¡¬t_wev
();

416 
c
->
discÚÃù
();

422 
	gÇme¥aû
 {

423 
chªge_loÿl_addrcb
(
ev_loİ
 *
loİ
, 
ev_tim”
 *
w
, 
»v’ts
) {

424 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
w
->
d©a
);

426 
	gc
->
chªge_loÿl_addr
();

430 
	gÇme¥aû
 {

431 
key_upd©ecb
(
ev_loİ
 *
loİ
, 
ev_tim”
 *
w
, 
»v’ts
) {

432 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
w
->
d©a
);

434 ià(
	gc
->
š™Ÿ‹_key_upd©e
() != 0) {

435 
c
->
discÚÃù
();

440 
	gÇme¥aû
 {

441 
sigšthªdËr
(
ev_loİ
 *
loİ
, 
ev_sigÇl
 *
w
, 
»v’ts
) {

442 
ev_b»ak
(
loİ
, 
EVBREAK_ALL
);

446 
	gCl›Á
::
	$Cl›Á
(
ev_loİ
 *
loİ
, 
SSL_CTX
 *
s¦_ùx
)

447 : 
»mÙe_addr_
{
	}
},

448 
max_pk’_
(0),

449 
loİ_
(
loİ
),

450 
s¦_ùx_
(
s¦_ùx
),

451 
s¦_
(
nuÎ±r
),

452 
fd_
(-1),

453 
d©afd_
(-1),

454 
chªdshake_idx_
(0),

455 
tx_üy±o_off£t_
(0),

456 
n¤—d_
(0),

457 
cÚn_
(
nuÎ±r
),

458 
addr_
(
nuÎ±r
),

459 
	ghs_üy±o_ùx_
{},

460 
	güy±o_ùx_
{},

461 
	g£ndbuf_
{
	gNGTCP2_MAX_PKTLEN_IPV4
},

462 
Ï¡_¡»am_id_
(
UINT64_MAX
),

463 
n¡»ams_dÚe_
(0),

464 
v”siÚ_
(0),

465 
s_®”t_
(0),

466 
»sum±iÚ_
(
çl£
),

468 
¹p_time¡amp_
(0),

469 
	$¹p_£qnum_
(0) {

471 
	`ev_io_š™
(&
wev_
, 
wr™ecb
, 0, 
EV_WRITE
);

472 
	`ev_io_š™
(&
»v_
, 
»adcb
, 0, 
EV_READ
);

473 
	`ev_io_š™
(&
¡dš»v_
, 
¡dš_»adcb
, 0, 
EV_READ
);

476 
wev_
.
d©a
 = 
this
;

477 
»v_
.
d©a
 = 
this
;

478 
¡dš»v_
.
d©a
 = 
this
;

480 
	`ev_tim”_š™
(&
tim”_
, 
timeoutcb
, 0., 
cÚfig
.
timeout
);

481 
tim”_
.
d©a
 = 
this
;

482 
	`ev_tim”_š™
(&
¹tim”_
, 
»Œªsm™cb
, 0., 0.);

483 
¹tim”_
.
d©a
 = 
this
;

487 
	`ev_tim”_š™
(&
¹±im”_
, 
wr™e_¹p_cb
, 1.0, (1.0/50.0));

488 
¹±im”_
.
d©a
 = 
this
;

489 
	`ev_sigÇl_š™
(&
sigš‹v_
, 
sigšthªdËr
, 
SIGINT
);

490 
	}
}

492 
	gCl›Á
::~
	$Cl›Á
() {

493 
	`discÚÃù
();

494 
	`şo£
();

495 
	}
}

497 
	gCl›Á
::
	$discÚÃù
(è{ 
	`discÚÃù
(0); 
	}
}

499 
	gCl›Á
::
	$discÚÃù
(
lib”r
) {

500 
cÚfig
.
tx_loss_´ob
 = 0;

502 
	`ev_tim”_¡İ
(
loİ_
, &
key_upd©e_tim”_
);

503 
	`ev_tim”_¡İ
(
loİ_
, &
chªge_loÿl_addr_tim”_
);

504 
	`ev_tim”_¡İ
(
loİ_
, &
¹tim”_
);

505 
	`ev_tim”_¡İ
(
loİ_
, &
tim”_
);

507 
	`ev_io_¡İ
(
loİ_
, &
¡dš»v_
);

508 
	`ev_io_¡İ
(
loİ_
, &
»v_
);

510 
	`ev_sigÇl_¡İ
(
loİ_
, &
sigš‹v_
);

512 
	`hªdË_”rÜ
(
lib”r
);

513 
	}
}

515 
	gCl›Á
::
	$şo£
() {

516 
	`ev_io_¡İ
(
loİ_
, &
wev_
);

518 ià(
cÚn_
) {

519 
	`ngtı2_cÚn_d–
(
cÚn_
);

520 
cÚn_
 = 
nuÎ±r
;

523 ià(
s¦_
) {

524 
	`SSL_ä“
(
s¦_
);

525 
s¦_
 = 
nuÎ±r
;

528 ià(
fd_
 != -1) {

529 ::
	`şo£
(
fd_
);

530 
fd_
 = -1;

532 
	}
}

534 
	gÇme¥aû
 {

535 
ş›Á_š™Ÿl
(
ngtı2_cÚn
 *
cÚn
, *
u£r_d©a
) {

536 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
u£r_d©a
);

538 ià(
	gc
->
s_hªdshake
(
Œue
) != 0) {

539  
NGTCP2_ERR_CALLBACK_FAILURE
;

546 
	gÇme¥aû
 {

547 
»cv_üy±o_d©a
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
off£t
, cÚ¡ 
ušt8_t
 *
d©a
,

548 
size_t
 
d©®’
, *
u£r_d©a
) {

549 ià(!
	gcÚfig
.
	gqu›t
) {

550 
	gdebug
::
´št_üy±o_d©a
(
d©a
, 
d©®’
);

553 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
u£r_d©a
);

555 
	gc
->
wr™e_£rv”_hªdshake
(
d©a
, 
d©®’
);

557 ià(!
ngtı2_cÚn_g‘_hªdshake_com¶‘ed
(
c
->
cÚn
())) {

558 ià(
	gc
->
s_hªdshake
() != 0) {

559  
NGTCP2_ERR_CRYPTO
;

566  
	gc
->
»ad_s
();

570 
	gÇme¥aû
 {

571 
»cv_¡»am_d©a
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
¡»am_id
, 
fš
,

572 
ušt64_t
 
off£t
, cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
,

573 *
u£r_d©a
, *
¡»am_u£r_d©a
) {

574 ià(!
	gcÚfig
.
	gqu›t
) {

575 
	gdebug
::
´št_¡»am_d©a
(
¡»am_id
, 
d©a
, 
d©®’
);

577 
ngtı2_cÚn_ex‹nd_max_¡»am_off£t
(
cÚn
, 
¡»am_id
, 
d©®’
);

578 
ngtı2_cÚn_ex‹nd_max_off£t
(
cÚn
, 
d©®’
);

583 
	gÇme¥aû
 {

584 
acked_üy±o_off£t
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
off£t
, 
size_t
 
d©®’
,

585 *
u£r_d©a
) {

586 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
u£r_d©a
);

587 
	gc
->
»move_tx_üy±o_d©a
(
off£t
, 
d©®’
);

593 
	gÇme¥aû
 {

594 
acked_¡»am_d©a_off£t
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
¡»am_id
,

595 
ušt64_t
 
off£t
, 
size_t
 
d©®’
, *
u£r_d©a
,

596 *
¡»am_u£r_d©a
) {

597 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
u£r_d©a
);

598 ià(
	gc
->
»move_tx_¡»am_d©a
(
¡»am_id
, 
off£t
, 
d©®’
) != 0) {

599  
NGTCP2_ERR_CALLBACK_FAILURE
;

605 
	gÇme¥aû
 {

606 
hªdshake_com¶‘ed
(
ngtı2_cÚn
 *
cÚn
, *
u£r_d©a
) {

607 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
u£r_d©a
);

609 ià(!
	gcÚfig
.
	gqu›t
) {

610 
	gdebug
::
hªdshake_com¶‘ed
(
cÚn
, 
u£r_d©a
);

613 ià(
	gcÚfig
.
	gchªge_loÿl_addr
) {

614 
	gc
->
¡¬t_chªge_loÿl_addr_tim”
();

616 ià(
	gcÚfig
.
	gkey_upd©e
) {

617 
	gc
->
¡¬t_key_upd©e_tim”
();

624 
	gÇme¥aû
 {

625 
»cv_»Œy
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

626 cÚ¡ 
ngtı2_pkt_»Œy
 *
»Œy
, *
u£r_d©a
) {

629 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
u£r_d©a
);

631 
	gc
->
Ú_»cv_»Œy
();

637 
	gÇme¥aû
 {

638 
¡»am_şo£
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
¡»am_id
, 
ušt16_t
 
­p_”rÜ_code
,

639 *
u£r_d©a
, *
¡»am_u£r_d©a
) {

640 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
u£r_d©a
);

642 
	gc
->
Ú_¡»am_şo£
(
¡»am_id
);

648 
	gÇme¥aû
 {

649 
ex‹nd_max_¡»ams_bidi
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
max_¡»ams
,

650 *
u£r_d©a
) {

651 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
u£r_d©a
);

653 ià(
	gc
->
Ú_ex‹nd_max_¡»ams
() != 0) {

654  
NGTCP2_ERR_CALLBACK_FAILURE
;

661 
	gÇme¥aû
 {

662 
¿nd
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, 
ngtı2_¿nd_ùx
 
ùx
,

663 *
u£r_d©a
) {

664 autØ
	gdis
 = 
¡d
::
unifÜm_št_di¡ributiÚ
<
ušt8_t
>(0, 255);

665 
	g¡d
::
g’”©e
(
de¡
, de¡ + 
de¡Ën
, [&
dis
](è{  dis(
¿ndg’
); });

670 
	gÇme¥aû
 {

671 
g‘_Ãw_cÚÃùiÚ_id
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_cid
 *
cid
, 
ušt8_t
 *
tok’
,

672 
size_t
 
cidËn
, *
u£r_d©a
) {

673 autØ
	gdis
 = 
¡d
::
unifÜm_št_di¡ributiÚ
<
ušt8_t
>(0, 255);

674 autØ
	gf
 = [&
dis
](è{  dis(
¿ndg’
); };

676 
	g¡d
::
g’”©e_n
(
cid
->
d©a
, 
cidËn
, 
f
);

677 
	gcid
->
	gd©®’
 = 
cidËn
;

678 
	g¡d
::
g’”©e_n
(
tok’
, 
NGTCP2_STATELESS_RESET_TOKENLEN
, 
f
);

684 
	gÇme¥aû
 {

685 
»move_cÚÃùiÚ_id
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_cid
 *
cid
,

686 *
u£r_d©a
) {

691 
	gÇme¥aû
 {

692 
ssize_t
 
do_hs_’üy±
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

693 cÚ¡ 
ušt8_t
 *
¶aš‹xt
, 
size_t
 
¶aš‹x’
,

694 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, cÚ¡ ušt8_ˆ*
nÚû
,

695 
size_t
 
nÚûËn
, cÚ¡ 
ušt8_t
 *
ad
, size_ˆ
adËn
,

696 *
u£r_d©a
) {

697 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
u£r_d©a
);

699 autØ
	gnwr™e
 = 
c
->
hs_’üy±_d©a
(
de¡
, 
de¡Ën
, 
¶aš‹xt
, 
¶aš‹x’
, 
key
,

700 
keyËn
, 
nÚû
, 
nÚûËn
, 
ad
, 
adËn
);

701 ià(
	gnwr™e
 < 0) {

702  
	gNGTCP2_ERR_CALLBACK_FAILURE
;

705  
	gnwr™e
;

709 
	gÇme¥aû
 {

710 
ssize_t
 
do_hs_deüy±
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

711 cÚ¡ 
ušt8_t
 *
ch”‹xt
, 
size_t
 
ch”‹x’
,

712 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, cÚ¡ ušt8_ˆ*
nÚû
,

713 
size_t
 
nÚûËn
, cÚ¡ 
ušt8_t
 *
ad
, size_ˆ
adËn
,

714 *
u£r_d©a
) {

715 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
u£r_d©a
);

717 autØ
	gnwr™e
 = 
c
->
hs_deüy±_d©a
(
de¡
, 
de¡Ën
, 
ch”‹xt
, 
ch”‹x’
,

718 
key
, 
keyËn
, 
nÚû
, 
nÚûËn
, 
ad
, 
adËn
);

719 ià(
	gnwr™e
 < 0) {

720  
	gNGTCP2_ERR_TLS_DECRYPT
;

723  
	gnwr™e
;

727 
	gÇme¥aû
 {

728 
ssize_t
 
do_’üy±
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

729 cÚ¡ 
ušt8_t
 *
¶aš‹xt
, 
size_t
 
¶aš‹x’
,

730 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, cÚ¡ ušt8_ˆ*
nÚû
,

731 
size_t
 
nÚûËn
, cÚ¡ 
ušt8_t
 *
ad
, size_ˆ
adËn
,

732 *
u£r_d©a
) {

733 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
u£r_d©a
);

735 autØ
	gnwr™e
 = 
c
->
’üy±_d©a
(
de¡
, 
de¡Ën
, 
¶aš‹xt
, 
¶aš‹x’
, 
key
,

736 
keyËn
, 
nÚû
, 
nÚûËn
, 
ad
, 
adËn
);

737 ià(
	gnwr™e
 < 0) {

738  
	gNGTCP2_ERR_CALLBACK_FAILURE
;

741  
	gnwr™e
;

745 
	gÇme¥aû
 {

746 
ssize_t
 
do_deüy±
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

747 cÚ¡ 
ušt8_t
 *
ch”‹xt
, 
size_t
 
ch”‹x’
,

748 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, cÚ¡ ušt8_ˆ*
nÚû
,

749 
size_t
 
nÚûËn
, cÚ¡ 
ušt8_t
 *
ad
, size_ˆ
adËn
,

750 *
u£r_d©a
) {

751 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
u£r_d©a
);

753 autØ
	gnwr™e
 = 
c
->
deüy±_d©a
(
de¡
, 
de¡Ën
, 
ch”‹xt
, 
ch”‹x’
, 
key
,

754 
keyËn
, 
nÚû
, 
nÚûËn
, 
ad
, 
adËn
);

755 ià(
	gnwr™e
 < 0) {

756  
	gNGTCP2_ERR_TLS_DECRYPT
;

759  
	gnwr™e
;

763 
	gÇme¥aû
 {

764 
ssize_t
 
do_š_hp_mask
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

765 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, cÚ¡ ušt8_ˆ*
§m¶e
,

766 
size_t
 
§m¶–’
, *
u£r_d©a
) {

767 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
u£r_d©a
);

769 autØ
	gnwr™e
 = 
c
->
š_hp_mask
(
de¡
, 
de¡Ën
, 
key
, 
keyËn
, 
§m¶e
, 
§m¶–’
);

770 ià(
	gnwr™e
 < 0) {

771  
	gNGTCP2_ERR_CALLBACK_FAILURE
;

774 ià(!
	gcÚfig
.
	gqu›t
 && cÚfig.
	gshow_£ü‘
) {

775 
	gdebug
::
´št_hp_mask
(
de¡
, 
de¡Ën
, 
§m¶e
, 
§m¶–’
);

778  
	gnwr™e
;

782 
	gÇme¥aû
 {

783 
ssize_t
 
do_hp_mask
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

784 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, cÚ¡ ušt8_ˆ*
§m¶e
,

785 
size_t
 
§m¶–’
, *
u£r_d©a
) {

786 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
u£r_d©a
);

788 autØ
	gnwr™e
 = 
c
->
hp_mask
(
de¡
, 
de¡Ën
, 
key
, 
keyËn
, 
§m¶e
, 
§m¶–’
);

789 ià(
	gnwr™e
 < 0) {

790  
	gNGTCP2_ERR_CALLBACK_FAILURE
;

793 ià(!
	gcÚfig
.
	gqu›t
 && cÚfig.
	gshow_£ü‘
) {

794 
	gdebug
::
´št_hp_mask
(
de¡
, 
de¡Ën
, 
§m¶e
, 
§m¶–’
);

797  
	gnwr™e
;

801 
	gÇme¥aû
 {

802 
upd©e_key
(
ngtı2_cÚn
 *
cÚn
, *
u£r_d©a
) {

803 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
u£r_d©a
);

805 ià(
	gc
->
upd©e_key
() != 0) {

806  
NGTCP2_ERR_CALLBACK_FAILURE
;

813 
	gÇme¥aû
 {

814 
·th_v®id©iÚ
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_·th
 *
·th
,

815 
ngtı2_·th_v®id©iÚ_»suÉ
 
»s
, *
u£r_d©a
) {

816 ià(!
	gcÚfig
.
	gqu›t
) {

817 
	gdebug
::
·th_v®id©iÚ
(
·th
, 
»s
);

823 
	gCl›Á
::
	$š™_s¦
() {

824 ià(
s¦_
) {

825 
	`SSL_ä“
(
s¦_
);

828 
s¦_
 = 
	`SSL_Ãw
(
s¦_ùx_
);

829 autØ
bio
 = 
	`BIO_Ãw
(
	`ü—‹_bio_m‘hod
());

830 
	`BIO_£t_d©a
(
bio
, 
this
);

831 
	`SSL_£t_bio
(
s¦_
, 
bio
, bio);

832 
	`SSL_£t_­p_d©a
(
s¦_
, 
this
);

833 
	`SSL_£t_cÚÃù_¡©e
(
s¦_
);

834 
	`SSL_£t_msg_ÿÎback
(
s¦_
, 
msg_cb
);

835 
	`SSL_£t_msg_ÿÎback_¬g
(
s¦_
, 
this
);

836 
	`SSL_£t_key_ÿÎback
(
s¦_
, 
key_cb
, 
this
);

838 cÚ¡ 
ušt8_t
 *
®²
 = 
nuÎ±r
;

839 
size_t
 
®²Ën
;

841 
v”siÚ_
) {

842 
NGTCP2_PROTO_VER_D17
:

843 
®²
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
NGTCP2_ALPN_D17
);

844 
®²Ën
 = 
	`¡r_size
(
NGTCP2_ALPN_D17
);

847 ià(
®²
) {

848 
	`SSL_£t_®²_´Ùos
(
s¦_
, 
®²
, 
®²Ën
);

851 ià(
ut
::
	`num”ic_ho¡
(
addr_
)) {

854 
	`SSL_£t_£xt_ho¡_Çme
(
s¦_
, "localhost");

856 
	`SSL_£t_£xt_ho¡_Çme
(
s¦_
, 
addr_
);

859 ià(
cÚfig
.
£ssiÚ_fe
) {

860 autØ
f
 = 
	`BIO_Ãw_fe
(
cÚfig
.
£ssiÚ_fe
, "r");

861 ià(
f
 =ğ
nuÎ±r
) {

862 
¡d
::
û¼
 << "Could‚Ù„—d TLS sessiÚ f" << 
cÚfig
.
£ssiÚ_fe


863 << 
¡d
::
’dl
;

865 autØ
£ssiÚ
 = 
	`PEM_»ad_bio_SSL_SESSION
(
f
, 
nuÎ±r
, 0,‚ullptr);

866 
	`BIO_ä“
(
f
);

867 ià(
£ssiÚ
 =ğ
nuÎ±r
) {

868 
¡d
::
û¼
 << "Could‚Ù„—d TLS sessiÚ f" << 
cÚfig
.
£ssiÚ_fe


869 << 
¡d
::
’dl
;

871 ià(!
	`SSL_£t_£ssiÚ
(
s¦_
, 
£ssiÚ
)) {

872 
¡d
::
û¼
 << "Could‚Ù s‘ sessiÚ" << std::
’dl
;

874 
»sum±iÚ_
 = 
Œue
;

876 
	`SSL_SESSION_ä“
(
£ssiÚ
);

882 
	}
}

884 
	gCl›Á
::
	$š™
(
fd
, cÚ¡ 
Add»ss
 &
loÿl_addr
, cÚ¡ Add»s &
»mÙe_addr
,

885 cÚ¡ *
addr
, cÚ¡ *
pÜt
, 
d©afd
,

886 
ušt32_t
 
v”siÚ
) {

887 
rv
;

889 
loÿl_addr_
 = 
loÿl_addr
;

890 
»mÙe_addr_
 = 
»mÙe_addr
;

892 
»mÙe_addr_
.
su
.
¡Üage
.
ss_çmy
) {

893 
AF_INET
:

894 
max_pk’_
 = 
NGTCP2_MAX_PKTLEN_IPV4
;

896 
AF_INET6
:

897 
max_pk’_
 = 
NGTCP2_MAX_PKTLEN_IPV6
;

903 
fd_
 = 
fd
;

904 
d©afd_
 = 
d©afd
;

905 
addr_
 = 
addr
;

906 
pÜt_
 = 
pÜt
;

907 
v”siÚ_
 = 
v”siÚ
;

909 ià(
	`š™_s¦
() != 0) {

913 autØ
ÿÎbacks
 = 
ngtı2_cÚn_ÿÎbacks
{

914 
ş›Á_š™Ÿl
,

915 
nuÎ±r
,

916 
»cv_üy±o_d©a
,

917 
hªdshake_com¶‘ed
,

918 
nuÎ±r
,

919 
do_hs_’üy±
,

920 
do_hs_deüy±
,

921 
do_’üy±
,

922 
do_deüy±
,

923 
do_š_hp_mask
,

924 
do_hp_mask
,

925 
»cv_¡»am_d©a
,

926 
acked_üy±o_off£t
,

927 
acked_¡»am_d©a_off£t
,

928 
nuÎ±r
,

929 
¡»am_şo£
,

930 
nuÎ±r
,

931 
»cv_»Œy
,

932 
ex‹nd_max_¡»ams_bidi
,

933 
nuÎ±r
,

934 
¿nd
,

935 
g‘_Ãw_cÚÃùiÚ_id
,

936 
»move_cÚÃùiÚ_id
,

937 ::
upd©e_key
,

938 
·th_v®id©iÚ
,

941 autØ
dis
 = 
¡d
::
unifÜm_št_di¡ributiÚ
<
ušt8_t
>(

942 0, 
¡d
::
num”ic_lim™s
<
ušt8_t
>::
	`max
());

944 
ngtı2_cid
 
scid
, 
dcid
;

945 
scid
.
d©®’
 = 17;

946 
¡d
::
	`g’”©e
(¡d::
	`begš
(
scid
.
d©a
), std::begš(scid.d©aè+ scid.
d©®’
,

947 [&
dis
](è{  
	`dis
(
¿ndg’
); });

948 ià(
cÚfig
.
dcid
.
d©®’
 == 0) {

949 
dcid
.
d©®’
 = 18;

950 
¡d
::
	`g’”©e
(¡d::
	`begš
(
dcid
.
d©a
), std::begš(dcid.d©aè+ dcid.
d©®’
,

951 [&
dis
](è{  
	`dis
(
¿ndg’
); });

953 
dcid
 = 
cÚfig
.dcid;

956 
ngtı2_£‰šgs
 
£‰šgs
{};

957 
£‰šgs
.
log_´štf
 = 
cÚfig
.
qu›t
 ? 
nuÎ±r
 : 
debug
::log_printf;

958 
£‰šgs
.
š™Ÿl_ts
 = 
ut
::
	`time¡amp
(
loİ_
);

959 
£‰šgs
.
max_¡»am_d©a_bidi_loÿl
 = 256
_k
;

960 
£‰šgs
.
max_¡»am_d©a_bidi_»mÙe
 = 256
_k
;

961 
£‰šgs
.
max_¡»am_d©a_uni
 = 256
_k
;

962 
£‰šgs
.
max_d©a
 = 1
_m
;

964 
£‰šgs
.
max_¡»ams_bidi
 = 10;

966 
£‰šgs
.
max_¡»ams_uni
 = 1;

967 
£‰šgs
.
idË_timeout
 = 
cÚfig
.
timeout
;

968 
£‰šgs
.
max_·ck‘_size
 = 
NGTCP2_MAX_PKT_SIZE
;

969 
£‰šgs
.
ack_d–ay_expÚ’t
 = 
NGTCP2_DEFAULT_ACK_DELAY_EXPONENT
;

970 
£‰šgs
.
max_ack_d–ay
 = 
NGTCP2_DEFAULT_MAX_ACK_DELAY
;

972 autØ
·th
 = 
ngtı2_·th
{

973 {
loÿl_addr
.
Ën
, 
cÚ¡_ÿ¡
<
ušt8_t
 *>(

974 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(&
loÿl_addr
.
su
))},

975 {
»mÙe_addr
.
Ën
, 
cÚ¡_ÿ¡
<
ušt8_t
 *>(
»š‹½»t_ÿ¡
<const uint8_t *>(

976 &
»mÙe_addr
.
su
))}};

977 
rv
 = 
	`ngtı2_cÚn_ş›Á_Ãw
(&
cÚn_
, &
dcid
, &
scid
, &
·th
, 
v”siÚ
, &
ÿÎbacks
,

978 &
£‰šgs
, 
this
);

979 ià(
rv
 != 0) {

980 
¡d
::
û¼
 << "ngtı2_cÚn_ş›Á_Ãw: " << 
	`ngtı2_¡»¼Ü
(
rv
è<< std::
’dl
;

984 
rv
 = 
	`£tup_š™Ÿl_üy±o_cÚ‹xt
();

985 ià(
rv
 != 0) {

989 
	`ev_io_£t
(&
wev_
, 
fd_
, 
EV_WRITE
);

990 
	`ev_io_£t
(&
»v_
, 
fd_
, 
EV_READ
);

992 
	`ev_io_¡¬t
(
loİ_
, &
»v_
);

993 
	`ev_tim”_agaš
(
loİ_
, &
tim”_
);

995 
	`ev_sigÇl_¡¬t
(
loİ_
, &
sigš‹v_
);

998 
	}
}

1000 
	gCl›Á
::
	$£tup_š™Ÿl_üy±o_cÚ‹xt
() {

1001 
rv
;

1003 
¡d
::
¬¿y
<
ušt8_t
, 32> 
š™Ÿl_£ü‘
, 
£ü‘
;

1004 autØ
dcid
 = 
	`ngtı2_cÚn_g‘_dcid
(
cÚn_
);

1005 
rv
 = 
üy±o
::
	`d”ive_š™Ÿl_£ü‘
(

1006 
š™Ÿl_£ü‘
.
	`d©a
(), in™Ÿl_£ü‘.
	`size
(), 
dcid
,

1007 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
NGTCP2_INITIAL_SALT
),

1008 
	`¡r_size
(
NGTCP2_INITIAL_SALT
));

1009 ià(
rv
 != 0) {

1010 
¡d
::
û¼
 << "üy±o::d”ive_š™Ÿl_£ü‘(èçed" << std::
’dl
;

1014 ià(!
cÚfig
.
qu›t
 && cÚfig.
show_£ü‘
) {

1015 
debug
::
	`´št_š™Ÿl_£ü‘
(
š™Ÿl_£ü‘
.
	`d©a
(), in™Ÿl_£ü‘.
	`size
());

1018 
üy±o
::
	`´f_sha256
(
hs_üy±o_ùx_
);

1019 
üy±o
::
	`«ad_«s_128_gcm
(
hs_üy±o_ùx_
);

1021 
rv
 = 
üy±o
::
	`d”ive_ş›Á_š™Ÿl_£ü‘
(
£ü‘
.
	`d©a
(), seü‘.
	`size
(),

1022 
š™Ÿl_£ü‘
.
	`d©a
(),

1023 
š™Ÿl_£ü‘
.
	`size
());

1024 ià(
rv
 != 0) {

1025 
¡d
::
û¼
 << "üy±o::d”ive_ş›Á_š™Ÿl_£ü‘(èçed" << std::
’dl
;

1029 
¡d
::
¬¿y
<
ušt8_t
, 16> 
key
, 
iv
, 
hp
;

1031 autØ
keyËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_key
(

1032 
key
.
	`d©a
(), key.
	`size
(), 
£ü‘
.d©a(), seü‘.size(), 
hs_üy±o_ùx_
);

1033 ià(
keyËn
 < 0) {

1037 autØ
ivËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_iv
(

1038 
iv
.
	`d©a
(), iv.
	`size
(), 
£ü‘
.d©a(), seü‘.size(), 
hs_üy±o_ùx_
);

1039 ià(
ivËn
 < 0) {

1043 autØ
h¶’
 = 
üy±o
::
	`d”ive_h—d”_´ÙeùiÚ_key
(

1044 
hp
.
	`d©a
(), hp.
	`size
(), 
£ü‘
.d©a(), seü‘.size(), 
hs_üy±o_ùx_
);

1045 ià(
h¶’
 < 0) {

1049 ià(!
cÚfig
.
qu›t
 && cÚfig.
show_£ü‘
) {

1050 
debug
::
	`´št_ş›Á_š_£ü‘
(
£ü‘
.
	`d©a
(), seü‘.
	`size
());

1051 
debug
::
	`´št_ş›Á_µ_key
(
key
.
	`d©a
(), 
keyËn
);

1052 
debug
::
	`´št_ş›Á_µ_iv
(
iv
.
	`d©a
(), 
ivËn
);

1053 
debug
::
	`´št_ş›Á_µ_hp
(
hp
.
	`d©a
(), 
h¶’
);

1056 
	`ngtı2_cÚn_š¡®l_š™Ÿl_tx_keys
(
cÚn_
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.data(),

1057 
ivËn
, 
hp
.
	`d©a
(), 
h¶’
);

1059 
rv
 = 
üy±o
::
	`d”ive_£rv”_š™Ÿl_£ü‘
(
£ü‘
.
	`d©a
(), seü‘.
	`size
(),

1060 
š™Ÿl_£ü‘
.
	`d©a
(),

1061 
š™Ÿl_£ü‘
.
	`size
());

1062 ià(
rv
 != 0) {

1063 
¡d
::
û¼
 << "üy±o::d”ive_£rv”_š™Ÿl_£ü‘(èçed" << std::
’dl
;

1067 
keyËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_key
(

1068 
key
.
	`d©a
(), key.
	`size
(), 
£ü‘
.d©a(), seü‘.size(), 
hs_üy±o_ùx_
);

1069 ià(
keyËn
 < 0) {

1073 
ivËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_iv
(

1074 
iv
.
	`d©a
(), iv.
	`size
(), 
£ü‘
.d©a(), seü‘.size(), 
hs_üy±o_ùx_
);

1075 ià(
ivËn
 < 0) {

1079 
h¶’
 = 
üy±o
::
	`d”ive_h—d”_´ÙeùiÚ_key
(

1080 
hp
.
	`d©a
(), hp.
	`size
(), 
£ü‘
.d©a(), seü‘.size(), 
hs_üy±o_ùx_
);

1081 ià(
h¶’
 < 0) {

1085 ià(!
cÚfig
.
qu›t
 && cÚfig.
show_£ü‘
) {

1086 
debug
::
	`´št_£rv”_š_£ü‘
(
£ü‘
.
	`d©a
(), seü‘.
	`size
());

1087 
debug
::
	`´št_£rv”_µ_key
(
key
.
	`d©a
(), 
keyËn
);

1088 
debug
::
	`´št_£rv”_µ_iv
(
iv
.
	`d©a
(), 
ivËn
);

1089 
debug
::
	`´št_£rv”_µ_hp
(
hp
.
	`d©a
(), 
h¶’
);

1092 
	`ngtı2_cÚn_š¡®l_š™Ÿl_rx_keys
(
cÚn_
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.data(),

1093 
ivËn
, 
hp
.
	`d©a
(), 
h¶’
);

1096 
	}
}

1098 
	gCl›Á
::
	$s_hªdshake
(
boŞ
 
š™Ÿl
) {

1099 
	`ERR_ş—r_”rÜ
();

1101 
rv
;

1104 ià(
š™Ÿl
 && 
»sum±iÚ_
 &&

1105 
	`SSL_SESSION_g‘_max_—¾y_d©a
(
	`SSL_g‘_£ssiÚ
(
s¦_
))) {

1106 
size_t
 
nwr™e
;

1110 
rv
 = 
	`SSL_wr™e_—¾y_d©a
(
s¦_
, "", 0, &
nwr™e
);

1111 ià(
rv
 == 0) {

1112 autØ
”r
 = 
	`SSL_g‘_”rÜ
(
s¦_
, 
rv
);

1113 
”r
) {

1114 
SSL_ERROR_SSL
:

1115 
¡d
::
û¼
 << "TLS handshakeƒrror: "

1116 << 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
nuÎ±r
è<< 
¡d
::
’dl
;

1119 
¡d
::
û¼
 << "TLS hªdshak”rÜ: " << 
”r
 << std::
’dl
;

1125 
rv
 = 
	`SSL_do_hªdshake
(
s¦_
);

1126 ià(
rv
 <= 0) {

1127 autØ
”r
 = 
	`SSL_g‘_”rÜ
(
s¦_
, 
rv
);

1128 
”r
) {

1129 
SSL_ERROR_WANT_READ
:

1130 
SSL_ERROR_WANT_WRITE
:

1132 
SSL_ERROR_SSL
:

1133 
¡d
::
û¼
 << "TLS handshakeƒrror: "

1134 << 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
nuÎ±r
è<< 
¡d
::
’dl
;

1137 
¡d
::
û¼
 << "TLS hªdshak”rÜ: " << 
”r
 << std::
’dl
;

1143 ià(
»sum±iÚ_
 &&

1144 
	`SSL_g‘_—¾y_d©a_¡©us
(
s¦_
è!ğ
SSL_EARLY_DATA_ACCEPTED
) {

1145 
¡d
::
û¼
 << "E¬ly d©¨wa »jeùed by s”v”" << std::
’dl
;

1146 
rv
 = 
	`ngtı2_cÚn_—¾y_d©a_»jeùed
(
cÚn_
);

1147 ià(
rv
 != 0) {

1148 
¡d
::
û¼
 << "ngtı2_cÚn_—¾y_d©a_»jeùed: " << 
	`ngtı2_¡»¼Ü
(
rv
)

1149 << 
¡d
::
’dl
;

1154 
	`ngtı2_cÚn_hªdshake_com¶‘ed
(
cÚn_
);

1156 ià(
	`»ad_s
() != 0) {

1160 ià(!
cÚfig
.
qu›t
) {

1161 
¡d
::
û¼
 << "NegÙŸ‹d ch” su™i " << 
	`SSL_g‘_ch”_Çme
(
s¦_
)

1162 << 
¡d
::
’dl
;

1164 cÚ¡ *
®²
 = 
nuÎ±r
;

1165 
®²Ën
;

1167 
	`SSL_g‘0_®²_£Ëùed
(
s¦_
, &
®²
, &
®²Ën
);

1168 ià(
®²
) {

1169 
¡d
::
û¼
 << "Negotiated ALPN is ";

1170 
¡d
::
û¼
.
	`wr™e
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
®²
), 
®²Ën
);

1171 
¡d
::
û¼
 << std::
’dl
;

1176 
	}
}

1178 
	gCl›Á
::
	$»ad_s
() {

1179 
	`ERR_ş—r_”rÜ
();

1181 
¡d
::
¬¿y
<
ušt8_t
, 4096> 
buf
;

1182 
size_t
 
Ä—d
;

1185 autØ
rv
 = 
	`SSL_»ad_ex
(
s¦_
, 
buf
.
	`d©a
(), buf.
	`size
(), &
Ä—d
);

1186 ià(
rv
 == 1) {

1187 ià(!
cÚfig
.
qu›t
) {

1188 
¡d
::
û¼
 << "R—d " << 
Ä—d
 << " bytes from TLS crypto stream"

1189 << 
¡d
::
’dl
;

1193 autØ
”r
 = 
	`SSL_g‘_”rÜ
(
s¦_
, 0);

1194 
”r
) {

1195 
SSL_ERROR_WANT_READ
:

1196 
SSL_ERROR_WANT_WRITE
:

1198 
SSL_ERROR_SSL
:

1199 
SSL_ERROR_ZERO_RETURN
:

1200 
¡d
::
û¼
 << "TLS„eadƒrror: "

1201 << 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
nuÎ±r
è<< 
¡d
::
’dl
;

1202  
NGTCP2_ERR_CRYPTO
;

1204 
¡d
::
û¼
 << "TLS„—dƒ¼Ü: " << 
”r
 << std::
’dl
;

1205  
NGTCP2_ERR_CRYPTO
;

1208 
	}
}

1210 
	gCl›Á
::
	$ãed_d©a
(cÚ¡ 
sockaddr
 *
§
, 
sockËn_t
 
§Ën
, 
ušt8_t
 *
d©a
,

1211 
size_t
 
d©®’
) {

1212 
rv
;

1214 ià(
	`ngtı2_cÚn_g‘_hªdshake_com¶‘ed
(
cÚn_
)) {

1215 autØ
·th
 = 
ngtı2_·th
{

1216 {
loÿl_addr_
.
Ën
, 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(&loÿl_addr_.
su
)},

1217 {
§Ën
, 
cÚ¡_ÿ¡
<
ušt8_t
 *>(
»š‹½»t_ÿ¡
<cÚ¡ ušt8_ˆ*>(
§
))}};

1218 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn_
, &
·th
, 
d©a
, 
d©®’
,

1219 
ut
::
	`time¡amp
(
loİ_
));

1220 ià(
rv
 != 0) {

1221 
¡d
::
û¼
 << "ngtı2_cÚn_»ad_pkt: " << 
	`ngtı2_¡»¼Ü
(
rv
è<< std::
’dl
;

1222 
	`discÚÃù
(
rv
);

1226  
	`do_hªdshake
(
d©a
, 
d©®’
);

1230 
	}
}

1232 
	gCl›Á
::
	$do_hªdshake_»ad_Úû
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
) {

1233 autØ
rv
 =

1234 
	`ngtı2_cÚn_»ad_hªdshake
(
cÚn_
, 
d©a
, 
d©®’
, 
ut
::
	`time¡amp
(
loİ_
));

1235 ià(
rv
 < 0) {

1236 
¡d
::
û¼
 << "ngtı2_cÚn_»ad_hªdshake: " << 
	`ngtı2_¡»¼Ü
(
rv
)

1237 << 
¡d
::
’dl
;

1238 
	`discÚÃù
(
rv
);

1243 
	}
}

1245 
ssize_t
 
	gCl›Á
::
	$do_hªdshake_wr™e_Úû
() {

1246 autØ
nwr™e
 = 
	`ngtı2_cÚn_wr™e_hªdshake
(
cÚn_
, 
£ndbuf_
.
	`wpos
(), 
max_pk’_
,

1247 
ut
::
	`time¡amp
(
loİ_
));

1248 ià(
nwr™e
 < 0) {

1249 
¡d
::
û¼
 << "ngtı2_cÚn_wr™e_hªdshake: " << 
	`ngtı2_¡»¼Ü
(
nwr™e
)

1250 << 
¡d
::
’dl
;

1251 
	`discÚÃù
(
nwr™e
);

1255 ià(
nwr™e
 == 0) {

1259 
£ndbuf_
.
	`push
(
nwr™e
);

1261 autØ
rv
 = 
	`£nd_·ck‘
();

1262 ià(
rv
 =ğ
NETWORK_ERR_SEND_NON_FATAL
) {

1263 
	`scheduË_»Œªsm™
();

1264  
rv
;

1266 ià(
rv
 !ğ
NETWORK_ERR_OK
) {

1267  
rv
;

1270  
nwr™e
;

1271 
	}
}

1273 
	gCl›Á
::
	$do_hªdshake
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
) {

1274 
ssize_t
 
nwr™e
;

1276 ià(
£ndbuf_
.
	`size
() > 0) {

1277 autØ
rv
 = 
	`£nd_·ck‘
();

1278 ià(
rv
 !ğ
NETWORK_ERR_OK
) {

1279  
rv
;

1283 autØ
rv
 = 
	`do_hªdshake_»ad_Úû
(
d©a
, 
d©®’
);

1284 ià(
rv
 != 0) {

1285  
rv
;

1289 
rv
 = 
	`wr™e_0¹t_¡»ams
();

1290 ià(
rv
 != 0) {

1291  
rv
;

1295 
nwr™e
 = 
	`do_hªdshake_wr™e_Úû
();

1296 ià(
nwr™e
 < 0) {

1297  
nwr™e
;

1299 ià(
nwr™e
 == 0) {

1303 
	}
}

1305 
	gCl›Á
::
	$Ú_»ad
() {

1306 
¡d
::
¬¿y
<
ušt8_t
, 65536> 
buf
;

1307 
sockaddr_uniÚ
 
su
;

1308 
sockËn_t
 
add¾’
;

1311 
add¾’
 = (
su
);

1312 autØ
Ä—d
 =

1313 
	`»cväom
(
fd_
, 
buf
.
	`d©a
(), buf.
	`size
(), 
MSG_DONTWAIT
, &
su
.
§
, &
add¾’
);

1315 ià(
Ä—d
 == -1) {

1316 ià(
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EWOULDBLOCK
) {

1317 
¡d
::
û¼
 << "»cväom: " << 
	`¡»¼Ü
(
”ºo
è<< std::
’dl
;

1322 ià(!
cÚfig
.
qu›t
) {

1323 
¡d
::
û¼
 << "Reûived…ack‘ from " << 
ut
::
	`¡¿ddr
(&
su
.
§
, 
add¾’
)

1324 << 
¡d
::
’dl
;

1327 ià(
debug
::
	`·ck‘_lo¡
(
cÚfig
.
rx_loss_´ob
)) {

1328 ià(!
cÚfig
.
qu›t
) {

1329 
¡d
::
û¼
 << "** SimuÏ‹d incomšg…ack‘†os **" << std::
’dl
;

1334 ià(
	`ãed_d©a
(&
su
.
§
, 
add¾’
, 
buf
.
	`d©a
(), 
Ä—d
) != 0) {

1339 
	`ev_tim”_agaš
(
loİ_
, &
tim”_
);

1342 
	}
}

1344 
	gCl›Á
::
	$Ú_wr™e
(
boŞ
 
»Œªsm™
) {

1345 
¡d
::
û¼
 << "Ú_wr™e" << std::
’dl
;

1346 ià(
£ndbuf_
.
	`size
() > 0) {

1347 autØ
rv
 = 
	`£nd_·ck‘
();

1348 ià(
rv
 !ğ
NETWORK_ERR_OK
) {

1349 ià(
rv
 !ğ
NETWORK_ERR_SEND_NON_FATAL
) {

1350 
	`discÚÃù
(
NGTCP2_ERR_INTERNAL
);

1352  
rv
;

1356 
	`as£¹
(
£ndbuf_
.
	`Ëá
(è>ğ
max_pk’_
);

1358 ià(
»Œªsm™
) {

1359 
¡d
::
û¼
 << "»Œªsm™ =ğŒue" << std::
’dl
;

1360 autØ
rv
 =

1361 
	`ngtı2_cÚn_Ú_loss_d‘eùiÚ_tim”
(
cÚn_
, 
ut
::
	`time¡amp
(
loİ_
));

1362 ià(
rv
 != 0) {

1363 
¡d
::
û¼
 << "ngtcp2_conn_on_loss_detection_timer: "

1364 << 
	`ngtı2_¡»¼Ü
(
rv
è<< 
¡d
::
’dl
;

1365 
	`discÚÃù
(
NGTCP2_ERR_INTERNAL
);

1370 ià(!
	`ngtı2_cÚn_g‘_hªdshake_com¶‘ed
(
cÚn_
)) {

1371 autØ
rv
 = 
	`do_hªdshake
(
nuÎ±r
, 0);

1372 
¡d
::
û¼
 << "hªdshakcom¶‘ed" << std::
’dl
;

1373 
	`scheduË_»Œªsm™
();

1374  
rv
;

1378 autØ
n
 = 
	`ngtı2_cÚn_wr™e_pkt
(
cÚn_
, 
nuÎ±r
, 
£ndbuf_
.
	`wpos
(), 
max_pk’_
,

1379 
ut
::
	`time¡amp
(
loİ_
));

1380 
¡d
::
û¼
 << "ngtı2_cÚn_wr™e_pkt" << std::
’dl
;

1381 ià(
n
 < 0) {

1382 
¡d
::
û¼
 << "ngtı2_cÚn_wr™e_pkt: " << 
	`ngtı2_¡»¼Ü
(
n
è<< std::
’dl
;

1383 
	`discÚÃù
(
n
);

1386 ià(
n
 == 0) {

1390 
£ndbuf_
.
	`push
(
n
);

1391 
¡d
::
û¼
 << "cÚ‹Á…ushedØ£ndbuf_" << std::
’dl
;

1393 autØ
rv
 = 
	`£nd_·ck‘
();

1394 ià(
rv
 =ğ
NETWORK_ERR_SEND_NON_FATAL
) {

1395 
	`scheduË_»Œªsm™
();

1396  
rv
;

1398 ià(
rv
 !ğ
NETWORK_ERR_OK
) {

1399  
rv
;

1403 ià(!
»Œªsm™
) {

1404 autØ
rv
 = 
	`wr™e_¡»ams
();

1405 ià(
rv
 != 0) {

1406  
rv
;

1410 
	`scheduË_»Œªsm™
();

1412 
	}
}

1414 
	gCl›Á
::
	$wr™e_¡»ams
() {

1415 
¡d
::
û¼
 << "wr™e_¡»ams" << std::
’dl
;

1416 autØ&
p
 : 
¡»ams_
) {

1417 autØ&
¡»am
 = 
p
.
£cÚd
;

1418 autØ&
¡»ambuf
 = 
¡»am
->streambuf;

1419 autØ&
¡»ambuf_idx
 = 
¡»am
->streambuf_idx;

1421 autØ
™
 = 
¡d
::
	`begš
(
¡»ambuf
è+ 
¡»ambuf_idx
;

1422 
™
 !ğ
¡d
::
	`’d
(
¡»ambuf
); ++it) {

1423 autØ&
v
 = *
™
;

1424 autØ
fš
 = 
¡»am
->
should_£nd_fš
 && 
™
 + 1 =ğ
¡d
::
	`’d
(
¡»ambuf
);

1425 autØ
rv
 = 
	`Ú_wr™e_¡»am
(
¡»am
->
¡»am_id
, 
fš
, 
v
);

1426 ià(
rv
 != 0) {

1427 ià(
rv
 =ğ
NETWORK_ERR_SEND_NON_FATAL
) {

1428 
	`scheduË_»Œªsm™
();

1431  
rv
;

1433 ià(
v
.
	`size
() > 0) {

1436 ++
¡»ambuf_idx
;

1441 
	}
}

1443 
	gCl›Á
::
	$Ú_wr™e_¡»am
(
ušt64_t
 
¡»am_id
, 
ušt8_t
 
fš
, 
Bufãr
 &
d©a
) {

1444 
¡d
::
û¼
 << "Ú_wr™e_¡»am" << std::
’dl
;

1446 
ssize_t
 
nd©®’
;

1449 autØ
n
 = 
	`ngtı2_cÚn_wr™e_¡»am
(

1450 
cÚn_
, 
nuÎ±r
, 
£ndbuf_
.
	`wpos
(), 
max_pk’_
, &
nd©®’
, 
¡»am_id
, 
fš
,

1451 
d©a
.
	`½os
(), d©a.
	`size
(), 
ut
::
	`time¡amp
(
loİ_
));

1452 ià(
n
 < 0) {

1453 
n
) {

1454 
NGTCP2_ERR_EARLY_DATA_REJECTED
:

1455 
NGTCP2_ERR_STREAM_DATA_BLOCKED
:

1456 
NGTCP2_ERR_STREAM_SHUT_WR
:

1457 
NGTCP2_ERR_STREAM_NOT_FOUND
:

1461 
¡d
::
û¼
 << "ngtı2_cÚn_wr™e_¡»am: " << 
	`ngtı2_¡»¼Ü
(
n
)

1462 << 
¡d
::
’dl
;

1463 
	`discÚÃù
(
n
);

1467 ià(
n
 == 0) {

1471 ià(
nd©®’
 > 0) {

1472 
d©a
.
	`£ek
(
nd©®’
);

1475 
£ndbuf_
.
	`push
(
n
);

1476 
¡d
::
û¼
 << "cÚ‹Á…ushedØ£ndbuf_ from on_wr™e_¡»am" << std::
’dl
;

1478 autØ
rv
 = 
	`£nd_·ck‘
();

1479 ià(
rv
 !ğ
NETWORK_ERR_OK
) {

1480  
rv
;

1483 ià(
d©a
.
	`size
() == 0) {

1489 
	}
}

1491 
	gCl›Á
::
	$wr™e_0¹t_¡»ams
() {

1492 autØ&
p
 : 
¡»ams_
) {

1493 autØ&
¡»am
 = 
p
.
£cÚd
;

1494 autØ&
¡»ambuf
 = 
¡»am
->streambuf;

1495 autØ&
¡»ambuf_idx
 = 
¡»am
->streambuf_idx;

1496 autØ
™
 = 
¡d
::
	`begš
(
¡»ambuf
è+ 
¡»ambuf_idx
;

1497 
™
 !ğ
¡d
::
	`’d
(
¡»ambuf
); ++it) {

1498 autØ&
v
 = *
™
;

1499 autØ
fš
 = 
¡»am
->
should_£nd_fš
 && 
™
 + 1 =ğ
¡d
::
	`’d
(
¡»ambuf
);

1500 autØ
rv
 = 
	`Ú_wr™e_0¹t_¡»am
(
¡»am
->
¡»am_id
, 
fš
, 
v
);

1501 ià(
rv
 != 0) {

1502 ià(
rv
 =ğ
NETWORK_ERR_SEND_NON_FATAL
) {

1503 
	`scheduË_»Œªsm™
();

1506  
rv
;

1508 ià(
v
.
	`size
() > 0) {

1511 ++
¡»ambuf_idx
;

1516 
	}
}

1518 
	gCl›Á
::
	$Ú_wr™e_0¹t_¡»am
(
ušt64_t
 
¡»am_id
, 
ušt8_t
 
fš
,

1519 
Bufãr
 &
d©a
) {

1520 
ssize_t
 
nd©®’
;

1523 
ngtı2_vec
 
d©av
{
cÚ¡_ÿ¡
<
ušt8_t
 *>(
d©a
.
	`½os
()), d©a.
	`size
()};

1524 autØ
n
 = 
	`ngtı2_cÚn_ş›Á_wr™e_hªdshake
(

1525 
cÚn_
, 
£ndbuf_
.
	`wpos
(), 
max_pk’_
, &
nd©®’
, 
¡»am_id
, 
fš
, &
d©av
,

1526 1, 
ut
::
	`time¡amp
(
loİ_
));

1527 ià(
n
 < 0) {

1528 
n
) {

1529 
NGTCP2_ERR_EARLY_DATA_REJECTED
:

1530 
NGTCP2_ERR_STREAM_DATA_BLOCKED
:

1531 
NGTCP2_ERR_STREAM_SHUT_WR
:

1532 
NGTCP2_ERR_STREAM_NOT_FOUND
:

1536 
¡d
::
û¼
 << "ngtı2_cÚn_ş›Á_wr™e_hªdshake: " << 
	`ngtı2_¡»¼Ü
(
n
)

1537 << 
¡d
::
’dl
;

1538 
	`discÚÃù
(
n
);

1542 ià(
n
 == 0) {

1546 ià(
nd©®’
 > 0) {

1547 
d©a
.
	`£ek
(
nd©®’
);

1550 
£ndbuf_
.
	`push
(
n
);

1552 autØ
rv
 = 
	`£nd_·ck‘
();

1553 ià(
rv
 !ğ
NETWORK_ERR_OK
) {

1554  
rv
;

1557 ià(
d©a
.
	`size
() == 0) {

1563 
	}
}

1565 
	gCl›Á
::
	$scheduË_»Œªsm™
() {

1566 autØ
expœy
 = 
¡d
::
	`mš
(
	`ngtı2_cÚn_loss_d‘eùiÚ_expœy
(
cÚn_
),

1567 
	`ngtı2_cÚn_ack_d–ay_expœy
(
cÚn_
));

1569 autØ
now
 = 
ut
::
	`time¡amp
(
loİ_
);

1570 autØ
t
 = 
expœy
 < 
now
 ? 1e-9

1571 : 
¡©ic_ÿ¡
<
ev_t¡amp
>(
expœy
 - 
now
è/ 
NGTCP2_SECONDS
;

1572 
¹tim”_
.
»³©
 = 
t
;

1573 
	`ev_tim”_agaš
(
loİ_
, &
¹tim”_
);

1574 
	}
}

1576 
	gCl›Á
::
	$wr™e_ş›Á_hªdshake
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
) {

1577 
	`wr™e_ş›Á_hªdshake
(
chªdshake_
, 
chªdshake_idx_
, 
d©a
, 
d©®’
);

1580 
	}
}

1582 
	gCl›Á
::
wr™e_ş›Á_hªdshake
(
¡d
::
deque
<
Bufãr
> &
de¡
, 
size_t
 &
idx
,

1583 cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
) {

1584 
	gde¡
.
em¶aû_back
(
d©a
, 
d©®’
);

1585 ++
	gidx
;

1587 autØ&
	gbuf
 = 
de¡
.
back
();

1589 
ngtı2_cÚn_subm™_üy±o_d©a
(
cÚn_
, 
buf
.
½os
(), buf.
size
());

1592 
size_t
 
	gCl›Á
::
	$»ad_ş›Á_hªdshake
(cÚ¡ 
ušt8_t
 **
pde¡
) {

1593 ià(
chªdshake_idx_
 =ğ
chªdshake_
.
	`size
()) {

1596 cÚ¡‡utØ&
v
 = 
chªdshake_
[
chªdshake_idx_
++];

1597 *
pde¡
 = 
v
.
	`½os
();

1598  
v
.
	`size
();

1599 
	}
}

1601 
size_t
 
	gCl›Á
::
	$»ad_£rv”_hªdshake
(
ušt8_t
 *
buf
, 
size_t
 
buæ’
) {

1602 autØ
n
 = 
¡d
::
	`mš
(
buæ’
, 
shªdshake_
.
	`size
(è- 
n¤—d_
);

1603 
¡d
::
	`cİy_n
(¡d::
	`begš
(
shªdshake_
è+ 
n¤—d_
, 
n
, 
buf
);

1604 
n¤—d_
 +ğ
n
;

1605  
n
;

1606 
	}
}

1608 
	gCl›Á
::
	$wr™e_£rv”_hªdshake
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
) {

1609 
¡d
::
	`cİy_n
(
d©a
, 
d©®’
, std::
	`back_š£¹”
(
shªdshake_
));

1610 
	}
}

1612 
ssize_t
 
	gCl›Á
::
	$hs_’üy±_d©a
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

1613 cÚ¡ 
ušt8_t
 *
¶aš‹xt
, 
size_t
 
¶aš‹x’
,

1614 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

1615 cÚ¡ 
ušt8_t
 *
nÚû
, 
size_t
 
nÚûËn
,

1616 cÚ¡ 
ušt8_t
 *
ad
, 
size_t
 
adËn
) {

1617  
üy±o
::
	`’üy±
(
de¡
, 
de¡Ën
, 
¶aš‹xt
, 
¶aš‹x’
, 
hs_üy±o_ùx_
,

1618 
key
, 
keyËn
, 
nÚû
, 
nÚûËn
, 
ad
, 
adËn
);

1619 
	}
}

1621 
ssize_t
 
	gCl›Á
::
	$hs_deüy±_d©a
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

1622 cÚ¡ 
ušt8_t
 *
ch”‹xt
, 
size_t
 
ch”‹x’
,

1623 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

1624 cÚ¡ 
ušt8_t
 *
nÚû
, 
size_t
 
nÚûËn
,

1625 cÚ¡ 
ušt8_t
 *
ad
, 
size_t
 
adËn
) {

1626  
üy±o
::
	`deüy±
(
de¡
, 
de¡Ën
, 
ch”‹xt
, 
ch”‹x’
,

1627 
hs_üy±o_ùx_
, 
key
, 
keyËn
, 
nÚû
, 
nÚûËn
, 
ad
,

1628 
adËn
);

1629 
	}
}

1631 
ssize_t
 
	gCl›Á
::
	$’üy±_d©a
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

1632 cÚ¡ 
ušt8_t
 *
¶aš‹xt
, 
size_t
 
¶aš‹x’
,

1633 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

1634 cÚ¡ 
ušt8_t
 *
nÚû
, 
size_t
 
nÚûËn
,

1635 cÚ¡ 
ušt8_t
 *
ad
, 
size_t
 
adËn
) {

1636  
üy±o
::
	`’üy±
(
de¡
, 
de¡Ën
, 
¶aš‹xt
, 
¶aš‹x’
, 
üy±o_ùx_
,

1637 
key
, 
keyËn
, 
nÚû
, 
nÚûËn
, 
ad
, 
adËn
);

1638 
	}
}

1640 
ssize_t
 
	gCl›Á
::
	$deüy±_d©a
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

1641 cÚ¡ 
ušt8_t
 *
ch”‹xt
, 
size_t
 
ch”‹x’
,

1642 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

1643 cÚ¡ 
ušt8_t
 *
nÚû
, 
size_t
 
nÚûËn
,

1644 cÚ¡ 
ušt8_t
 *
ad
, 
size_t
 
adËn
) {

1645  
üy±o
::
	`deüy±
(
de¡
, 
de¡Ën
, 
ch”‹xt
, 
ch”‹x’
, 
üy±o_ùx_
,

1646 
key
, 
keyËn
, 
nÚû
, 
nÚûËn
, 
ad
, 
adËn
);

1647 
	}
}

1649 
ssize_t
 
	gCl›Á
::
	$š_hp_mask
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
key
,

1650 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
§m¶e
,

1651 
size_t
 
§m¶–’
) {

1652  
üy±o
::
	`hp_mask
(
de¡
, 
de¡Ën
, 
hs_üy±o_ùx_
, 
key
, 
keyËn
, 
§m¶e
,

1653 
§m¶–’
);

1654 
	}
}

1656 
ssize_t
 
	gCl›Á
::
	$hp_mask
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
key
,

1657 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
§m¶e
,

1658 
size_t
 
§m¶–’
) {

1659  
üy±o
::
	`hp_mask
(
de¡
, 
de¡Ën
, 
üy±o_ùx_
, 
key
, 
keyËn
, 
§m¶e
,

1660 
§m¶–’
);

1661 
	}
}

1663 
	gCl›Á
::
	$Ú_»cv_»Œy
(è{ 
	`£tup_š™Ÿl_üy±o_cÚ‹xt
(); 
	}
}

1665 
	gÇme¥aû
 {

1666 
bšd_addr
(
Add»ss
 &
loÿl_addr
, 
fd
, 
çmy
) {

1667 
addršfo
 
	ghšts
{};

1668 
addršfo
 *
	g»s
, *
	g½
;

1669 
	grv
;

1671 
	ghšts
.
	gai_çmy
 = 
çmy
;

1672 
	ghšts
.
	gai_sockty³
 = 
SOCK_DGRAM
;

1673 
	ghšts
.
	gai_æags
 = 
AI_PASSIVE
;

1675 
	grv
 = 
g‘addršfo
(
nuÎ±r
, "0", &
hšts
, &
»s
);

1676 ià(
	grv
 != 0) {

1677 
¡d
::
û¼
 << "g‘addršfo: " << 
gai_¡»¼Ü
(
rv
è<< std::
’dl
;

1681 autØ
	g»s_d
 = 
deãr
(
ä“addršfo
, 
»s
);

1683 
	g½
 = 
»s
;„p;„°ğ
½
->
ai_Ãxt
) {

1684 ià(
bšd
(
fd
, 
½
->
ai_addr
,„p->
ai_add¾’
) != -1) {

1689 ià(!
	g½
) {

1690 
	g¡d
::
û¼
 << "Could‚Ù bšd" << 
¡d
::
’dl
;

1694 
sockËn_t
 
	gËn
 = (
loÿl_addr
.
su
.
¡Üage
);

1695 
	grv
 = 
g‘sockÇme
(
fd
, &
loÿl_addr
.
su
.
§
, &
Ën
);

1696 ià(
	grv
 == -1) {

1697 
¡d
::
û¼
 << "g‘sockÇme: " << 
¡»¼Ü
(
”ºo
è<< std::
’dl
;

1700 
	gloÿl_addr
.
	gËn
 = 
Ën
;

1706 
	gÇme¥aû
 {

1707 
ü—‹_sock
(
Add»ss
 &
»mÙe_addr
, cÚ¡ *
addr
, cÚ¡ *
pÜt
) {

1708 
addršfo
 
	ghšts
{};

1709 
addršfo
 *
	g»s
, *
	g½
;

1710 
	grv
;

1712 
	ghšts
.
	gai_çmy
 = 
AF_UNSPEC
;

1713 
	ghšts
.
	gai_sockty³
 = 
SOCK_DGRAM
;

1715 
	grv
 = 
g‘addršfo
(
addr
, 
pÜt
, &
hšts
, &
»s
);

1716 ià(
	grv
 != 0) {

1717 
¡d
::
û¼
 << "g‘addršfo: " << 
gai_¡»¼Ü
(
rv
è<< std::
’dl
;

1721 autØ
	g»s_d
 = 
deãr
(
ä“addršfo
, 
»s
);

1723 
	gfd
 = -1;

1725 
	g½
 = 
»s
;„p;„°ğ
½
->
ai_Ãxt
) {

1726 
fd
 = 
sock‘
(
½
->
ai_çmy
,„p->
ai_sockty³
,„p->
ai_´ÙocŞ
);

1727 ià(
	gfd
 == -1) {

1734 ià(!
	g½
) {

1735 
	g¡d
::
û¼
 << "Could‚Ù cÚÃù" << 
¡d
::
’dl
;

1739 autØ
	gv®
 = 1;

1740 ià(
£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
v®
,

1741 
¡©ic_ÿ¡
<
sockËn_t
>((
v®
))) == -1) {

1745 
	g»mÙe_addr
.
	gËn
 = 
½
->
ai_add¾’
;

1746 
memıy
(&
»mÙe_addr
.
su
, 
½
->
ai_addr
,„p->
ai_add¾’
);

1748  
	gfd
;

1752 
ngtı2_cÚn
 *
	gCl›Á
::
	$cÚn
(ècÚ¡ {  
cÚn_
; 
	}
}

1754 
	gCl›Á
::
	$¡¬t_chªge_loÿl_addr_tim”
() {

1755 
	`ev_tim”_¡¬t
(
loİ_
, &
chªge_loÿl_addr_tim”_
);

1756 
	}
}

1758 
	gCl›Á
::
	$chªge_loÿl_addr
() {

1759 
Add»ss
 
»mÙe_addr
, 
loÿl_addr
;

1760 
rv
;

1762 ià(!
cÚfig
.
qu›t
) {

1763 
¡d
::
û¼
 << "Chªgšg†oÿÈadd»ss" << std::
’dl
;

1766 autØ
nfd
 = 
	`ü—‹_sock
(
»mÙe_addr
, 
addr_
, 
pÜt_
);

1767 ià(
nfd
 == -1) {

1771 ià(
	`bšd_addr
(
loÿl_addr
, 
nfd
, 
»mÙe_addr
.
su
.
§
.
§_çmy
) != 0) {

1772 ::
	`şo£
(
nfd
);

1776 ::
	`şo£
(
fd_
);

1778 
fd_
 = 
nfd
;

1779 
loÿl_addr_
 = 
loÿl_addr
;

1780 
»mÙe_addr_
 = 
»mÙe_addr
;

1782 ià(
cÚfig
.
Çt_»bšdšg
) {

1783 
ngtı2_addr
 
addr
;

1784 
	`ngtı2_cÚn_£t_loÿl_addr
(

1785 
cÚn_
, 
	`ngtı2_addr_š™
(&
addr
, &
loÿl_addr
.
su
,†oÿl_addr.
Ën
));

1787 autØ
·th
 = 
ngtı2_·th
{

1788 {
loÿl_addr
.
Ën
, 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(&loÿl_addr.
su
)},

1789 {
»mÙe_addr
.
Ën
, 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(&»mÙe_addr.
su
)}};

1790 
rv
 = 
	`ngtı2_cÚn_š™Ÿ‹_mig¿tiÚ
(
cÚn_
, &
·th
, 
ut
::
	`time¡amp
(
loİ_
));

1791 ià(
rv
 != 0) {

1792 
¡d
::
û¼
 << "ngtı2_cÚn_š™Ÿ‹_mig¿tiÚ: " << 
	`ngtı2_¡»¼Ü
(
rv
)

1793 << 
¡d
::
’dl
;

1797 autØ
wev_aùive
 = 
	`ev_is_aùive
(&
wev_
);

1799 
	`ev_io_¡İ
(
loİ_
, &
wev_
);

1800 
	`ev_io_¡İ
(
loİ_
, &
»v_
);

1801 
	`ev_io_£t
(&
wev_
, 
fd_
, 
EV_WRITE
);

1802 
	`ev_io_£t
(&
»v_
, 
fd_
, 
EV_READ
);

1803 ià(
wev_aùive
) {

1804 
	`ev_io_¡¬t
(
loİ_
, &
wev_
);

1806 
	`ev_io_¡¬t
(
loİ_
, &
»v_
);

1809 
	}
}

1811 
	gCl›Á
::
	$¡¬t_key_upd©e_tim”
() {

1812 
	`ev_tim”_¡¬t
(
loİ_
, &
key_upd©e_tim”_
);

1813 
	}
}

1815 
	gCl›Á
::
	$upd©e_key
() {

1816 ià(!
cÚfig
.
qu›t
) {

1817 
¡d
::
û¼
 << "Upd©šg¿ffiøkey" << std::
’dl
;

1820 
rv
;

1821 
¡d
::
¬¿y
<
ušt8_t
, 64> 
£ü‘
, 
key
, 
iv
;

1823 ++
nkey_upd©e_
;

1825 autØ
£ü‘Ën
 = 
üy±o
::
	`upd©e_Œaffic_£ü‘
(

1826 
£ü‘
.
	`d©a
(), seü‘.
	`size
(), 
tx_£ü‘_
.data(),x_secret_.size(),

1827 
üy±o_ùx_
);

1828 ià(
£ü‘Ën
 < 0) {

1832 
tx_£ü‘_
.
	`assign
(
¡d
::
	`begš
(
£ü‘
), std::
	`’d
(secret));

1834 autØ
keyËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_key
(

1835 
key
.
	`d©a
(), key.
	`size
(), 
£ü‘
.d©a(), 
£ü‘Ën
, 
üy±o_ùx_
);

1836 ià(
keyËn
 < 0) {

1840 autØ
ivËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_iv
(

1841 
iv
.
	`d©a
(), iv.
	`size
(), 
£ü‘
.d©a(), 
£ü‘Ën
, 
üy±o_ùx_
);

1842 ià(
ivËn
 < 0) {

1846 
rv
 = 
	`ngtı2_cÚn_upd©e_tx_key
(
cÚn_
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.d©a(), 
ivËn
);

1847 ià(
rv
 != 0) {

1848 
¡d
::
û¼
 << "ngtı2_cÚn_upd©e_tx_key: " << 
	`ngtı2_¡»¼Ü
(
rv
)

1849 << 
¡d
::
’dl
;

1853 ià(!
cÚfig
.
qu›t
) {

1854 
¡d
::
û¼
 << "ş›Á_­¶iÿtiÚ_Œaffiø" << 
nkey_upd©e_
 << std::
’dl
;

1855 
debug
::
	`´št_£ü‘s
(
£ü‘
.
	`d©a
(), 
£ü‘Ën
, 
key
.d©a(), 
keyËn
,

1856 
iv
.
	`d©a
(), 
ivËn
);

1859 
£ü‘Ën
 = 
üy±o
::
	`upd©e_Œaffic_£ü‘
(
£ü‘
.
	`d©a
(), seü‘.
	`size
(),

1860 
rx_£ü‘_
.
	`d©a
(),

1861 
rx_£ü‘_
.
	`size
(), 
üy±o_ùx_
);

1862 ià(
£ü‘Ën
 < 0) {

1866 
rx_£ü‘_
.
	`assign
(
¡d
::
	`begš
(
£ü‘
), std::
	`’d
(secret));

1868 
keyËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_key
(

1869 
key
.
	`d©a
(), key.
	`size
(), 
£ü‘
.d©a(), 
£ü‘Ën
, 
üy±o_ùx_
);

1870 ià(
keyËn
 < 0) {

1874 
ivËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_iv
(

1875 
iv
.
	`d©a
(), iv.
	`size
(), 
£ü‘
.d©a(), 
£ü‘Ën
, 
üy±o_ùx_
);

1876 ià(
ivËn
 < 0) {

1880 
rv
 = 
	`ngtı2_cÚn_upd©e_rx_key
(
cÚn_
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.d©a(), 
ivËn
);

1881 ià(
rv
 != 0) {

1882 
¡d
::
û¼
 << "ngtı2_cÚn_upd©e_rx_key: " << 
	`ngtı2_¡»¼Ü
(
rv
)

1883 << 
¡d
::
’dl
;

1887 ià(!
cÚfig
.
qu›t
) {

1888 
¡d
::
û¼
 << "£rv”_­¶iÿtiÚ_Œaffiø" << 
nkey_upd©e_
 << std::
’dl
;

1889 
debug
::
	`´št_£ü‘s
(
£ü‘
.
	`d©a
(), 
£ü‘Ën
, 
key
.d©a(), 
keyËn
,

1890 
iv
.
	`d©a
(), 
ivËn
);

1894 
	}
}

1896 
	gCl›Á
::
	$š™Ÿ‹_key_upd©e
() {

1897 
rv
;

1899 ià(
	`upd©e_key
() != 0) {

1903 
rv
 = 
	`ngtı2_cÚn_š™Ÿ‹_key_upd©e
(
cÚn_
);

1904 ià(
rv
 != 0) {

1905 
¡d
::
û¼
 << "ngtı2_cÚn_š™Ÿ‹_key_upd©e: " << 
	`ngtı2_¡»¼Ü
(
rv
)

1906 << 
¡d
::
’dl
;

1911 
	}
}

1913 
	gCl›Á
::
	$£nd_·ck‘
() {

1914 
¡d
::
û¼
 << "£nd_·ck‘" << std::
’dl
;

1915 ià(
debug
::
	`·ck‘_lo¡
(
cÚfig
.
tx_loss_´ob
)) {

1916 ià(!
cÚfig
.
qu›t
) {

1917 
¡d
::
û¼
 << "** SimuÏ‹d outgošg…ack‘†os **" << std::
’dl
;

1919 
£ndbuf_
.
	`»£t
();

1920  
NETWORK_ERR_OK
;

1923 
ešŒ_»Œ›s
 = 5;

1924 
ssize_t
 
nwr™e
 = 0;

1927 
nwr™e
 = 
	`£ndto
(
fd_
, 
£ndbuf_
.
	`½os
(), s’dbuf_.
	`size
(), 0,

1928 &
»mÙe_addr_
.
su
.
§
,„emÙe_addr_.
Ën
);

1929 } (
nwr™e
 =ğ-1è&& (
”ºo
 =ğ
EINTR
è&& (
ešŒ_»Œ›s
-- > 0));

1931 ià(
nwr™e
 == -1) {

1932 
”ºo
) {

1933 
EAGAIN
:

1934 
EINTR
:

1936  
NETWORK_ERR_SEND_NON_FATAL
;

1938 
¡d
::
û¼
 << "£nd: " << 
	`¡»¼Ü
(
”ºo
è<< std::
’dl
;

1939  
NETWORK_ERR_SEND_FATAL
;

1943 
	`as£¹
(
¡©ic_ÿ¡
<
size_t
>(
nwr™e
è=ğ
£ndbuf_
.
	`size
());

1944 
£ndbuf_
.
	`»£t
();

1946 ià(!
cÚfig
.
qu›t
) {

1947 
¡d
::
û¼
 << "Sent…acketo "

1948 << 
ut
::
	`¡¿ddr
(&
»mÙe_addr_
.
su
.
§
,„emÙe_addr_.
Ën
) << " "

1949 << 
nwr™e
 << " by‹s" << 
¡d
::
’dl
;

1952  
NETWORK_ERR_OK
;

1953 
	}
}

1955 
	gCl›Á
::
	$¡¬t_š‹¿ùive_šput
() {

1956 
rv
;

1958 
¡d
::
û¼
 << "Interactive session started. Hit Ctrl-Doƒndhe session."

1959 << 
¡d
::
’dl
;

1961 
	`ev_io_£t
(&
¡dš»v_
, 
d©afd_
, 
EV_READ
);

1962 
	`ev_io_¡¬t
(
loİ_
, &
¡dš»v_
);

1964 
ušt64_t
 
¡»am_id
;

1966 
rv
 = 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn_
, &
¡»am_id
, 
nuÎ±r
);

1967 ià(
rv
 != 0) {

1968 
¡d
::
û¼
 << "ngtı2_cÚn_İ’_bidi_¡»am: " << 
	`ngtı2_¡»¼Ü
(
rv
)

1969 << 
¡d
::
’dl
;

1970 ià(
rv
 =ğ
NGTCP2_ERR_STREAM_ID_BLOCKED
) {

1976 
¡d
::
û¼
 << "Th¡»am " << 
¡»am_id
 << " ha İ’ed." << std::
’dl
;

1978 
Ï¡_¡»am_id_
 = 
¡»am_id
;

1980 autØ
¡»am
 = 
¡d
::
make_unique
<
SŒ—m
>(
¡»am_id
);

1982 
¡»ams_
.
	`em¶aû
(
¡»am_id
, 
¡d
::
	`move
(
¡»am
));

1985 
	}
}

1987 
	gCl›Á
::
	$£nd_š‹¿ùive_šput
() {

1988 
ssize_t
 
Ä—d
;

1989 
¡d
::
¬¿y
<
ušt8_t
, 1
_k
> 
buf
;

1991 (
Ä—d
 = 
	`»ad
(
d©afd_
, 
buf
.
	`d©a
(), buf.
	`size
())) == -1 &&

1992 
”ºo
 =ğ
EINTR
)

1994 ià(
Ä—d
 == -1) {

1995  
	`¡İ_š‹¿ùive_šput
();

1997 ià(
Ä—d
 == 0) {

1998  
	`¡İ_š‹¿ùive_šput
();

2002 
	`as£¹
(!
¡»ams_
.
	`em±y
());

2004 autØ&
¡»am
 = 
¡»ams_
[
Ï¡_¡»am_id_
];

2006 
¡»am
->
¡»ambuf
.
	`em¶aû_back
(
buf
.
	`d©a
(), 
Ä—d
);

2008 
	`ev_ãed_ev’t
(
loİ_
, &
wev_
, 
EV_WRITE
);

2011 
	}
}

2013 
	gCl›Á
::
	$¡İ_š‹¿ùive_šput
() {

2014 
	`as£¹
(!
¡»ams_
.
	`em±y
());

2016 autØ&
¡»am
 = (*
¡d
::
	`begš
(
¡»ams_
)).
£cÚd
;

2018 
¡»am
->
should_£nd_fš
 = 
Œue
;

2019 ià(
¡»am
->
¡»ambuf
.
	`em±y
()) {

2020 
¡»am
->
¡»ambuf
.
	`em¶aû_back
();

2022 
	`ev_io_¡İ
(
loİ_
, &
¡dš»v_
);

2024 
¡d
::
û¼
 << "IÁ”aùiv£ssiÚ ha ’ded." << std::
’dl
;

2026 
	`ev_ãed_ev’t
(
loİ_
, &
wev_
, 
EV_WRITE
);

2029 
	}
}

2034 
	gCl›Á
::
	$¡¬t_¹p
() {

2036 
rv
;

2038 
¡d
::
û¼
 << "RTP session started."

2039 << 
¡d
::
’dl
;

2041 
ušt64_t
 
¡»am_id
;

2044 
rv
 = 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn_
, &
¡»am_id
, 
nuÎ±r
);

2045 ià(
rv
 != 0) {

2046 
¡d
::
û¼
 << "ngtı2_cÚn_İ’_bidi_¡»am: " << 
	`ngtı2_¡»¼Ü
(
rv
)

2047 << 
¡d
::
’dl
;

2048 ià(
rv
 =ğ
NGTCP2_ERR_STREAM_ID_BLOCKED
) {

2054 
¡d
::
û¼
 << "Th¡»am " << 
¡»am_id
 << " ha İ’ed fÜ RTP." << std::
’dl
;

2057 
Ï¡_¡»am_id_
 = 
¡»am_id
;

2060 autØ
¡»am
 = 
¡d
::
make_unique
<
SŒ—m
>(
¡»am_id
);

2063 
¡»ams_
.
	`em¶aû
(
¡»am_id
, 
¡d
::
	`move
(
¡»am
));

2067 
	`ev_tim”_¡¬t
 (
loİ_
, &
¹±im”_
);

2071 
	}
}

2073 
	gCl›Á
::
	$£nd_¹p
() {

2074 
¡d
::
û¼
 << "RTP funùiÚ s¹ed" << std::
’dl
;

2075 
¡d
::
û¼
 << "Ï¡_¡—m_id = " << 
Ï¡_¡»am_id_
 << std::
’dl
;

2076 
¡d
::
û¼
 << "¡»ams_ sizğ" << 
¡»ams_
.
	`size
(è<< std::
’dl
;

2077 
ssize_t
 
Ä—d
;

2079 
rv
;

2080 
ušt8_t
 * 
bufãr
;

2084 autØ&
¹p_¡»am
 = 
¡»ams_
[
Ï¡_¡»am_id_
];

2088 
¡d
::
û¼
 << "wr™šgØRTP sŒ—m..." << std::
’dl
;

2089 
cÚ¡ex´
 
ušt8_t
 
hw
[] = "Test RTP data!";

2090 
bufãr
 = (
ušt8_t
*è
	`m®loc
(
	`¡r_size
(
hw
));

2091 
¡d
::
	`cİy
(
hw
, hw + 
	`¡r_size
(hw), 
bufãr
);

2094 
¹p_¡»am
->
¡»ambuf
.
	`em¶aû_back
(
bufãr
, 
	`¡r_size
(
hw
));

2095 
¡d
::
û¼
 << "RTP sŒ—m wr™‹n" << std::
’dl
;

2098 
	`ev_ãed_ev’t
(
loİ_
, &
wev_
, 
EV_WRITE
);

2101 
	}
}

2103 
	gCl›Á
::
	$¡İ_¹p
() {

2104 
	`as£¹
(!
¡»ams_
.
	`em±y
());

2106 autØ&
¡»am
 = (*
¡d
::
	`begš
(
¡»ams_
)).
£cÚd
;

2108 
¡»am
->
should_£nd_fš
 = 
Œue
;

2109 ià(
¡»am
->
¡»ambuf
.
	`em±y
()) {

2110 
¡»am
->
¡»ambuf
.
	`em¶aû_back
();

2113 
¡d
::
û¼
 << "RTP sessiÚ ha ’ded." << std::
’dl
;

2115 
	`ev_ãed_ev’t
(
loİ_
, &
wev_
, 
EV_WRITE
);

2118 
	}
}

2122 
	gCl›Á
::
	$hªdË_”rÜ
(
lib”r
) {

2123 ià(!
cÚn_
 || 
	`ngtı2_cÚn_is_š_şosšg_³riod
(conn_)) {

2127 
£ndbuf_
.
	`»£t
();

2128 
	`as£¹
(
£ndbuf_
.
	`Ëá
(è>ğ
max_pk’_
);

2130 ià(
lib”r
 =ğ
NGTCP2_ERR_RECV_VERSION_NEGOTIATION
) {

2134 
ušt16_t
 
”r_code
;

2135 ià(
s_®”t_
) {

2136 
”r_code
 = 
NGTCP2_CRYPTO_ERROR
 | 
s_®”t_
;

2138 
”r_code
 = 
	`ngtı2_”r_šãr_quic_Œª¥Üt_”rÜ_code
(
lib”r
);

2141 autØ
n
 = 
	`ngtı2_cÚn_wr™e_cÚÃùiÚ_şo£
(
cÚn_
, 
nuÎ±r
, 
£ndbuf_
.
	`wpos
(),

2142 
max_pk’_
, 
”r_code
,

2143 
ut
::
	`time¡amp
(
loİ_
));

2144 ià(
n
 < 0) {

2145 
¡d
::
û¼
 << "ngtı2_cÚn_wr™e_cÚÃùiÚ_şo£: " << 
	`ngtı2_¡»¼Ü
(
n
)

2146 << 
¡d
::
’dl
;

2150 
£ndbuf_
.
	`push
(
n
);

2152  
	`£nd_·ck‘
();

2153 
	}
}

2155 
	gÇme¥aû
 {

2156 
size_t
 
»move_tx_¡»am_d©a
(
¡d
::
deque
<
Bufãr
> &
d
, size_ˆ&
idx
,

2157 
ušt64_t
 &
tx_off£t
, ušt64_ˆ
off£t
) {

2158 
size_t
 
	gËn
 = 0;

2159 ; !
	gd
.
em±y
(è&& 
	gtx_off£t
 + d.
äÚt
().
bufsize
(è<ğ
off£t
;) {

2160 --
	gidx
;

2161 
	gtx_off£t
 +ğ
d
.
äÚt
().
bufsize
();

2162 
	gËn
 +ğ
d
.
äÚt
().
bufsize
();

2163 
	gd
.
pİ_äÚt
();

2165  
	gËn
;

2169 
	gCl›Á
::
	$»move_tx_üy±o_d©a
(
ušt64_t
 
off£t
, 
size_t
 
d©®’
) {

2171 ::
	`»move_tx_¡»am_d©a
(
chªdshake_
, 
chªdshake_idx_
, 
tx_üy±o_off£t_
,

2172 
off£t
 + 
d©®’
);

2173 
	}
}

2175 
	gCl›Á
::
	$»move_tx_¡»am_d©a
(
ušt64_t
 
¡»am_id
, ušt64_ˆ
off£t
,

2176 
size_t
 
d©®’
) {

2177 autØ
™
 = 
¡»ams_
.
	`fšd
(
¡»am_id
);

2178 ià(
™
 =ğ
¡d
::
	`’d
(
¡»ams_
)) {

2179 
¡d
::
û¼
 << "SŒ—m " << 
¡»am_id
 << "nÙ found" << std::
’dl
;

2182 autØ&
¡»am
 = (*
™
).
£cÚd
;

2183 ::
	`»move_tx_¡»am_d©a
(
¡»am
->
¡»ambuf
, sŒ—m->
¡»ambuf_idx
,

2184 
¡»am
->
tx_¡»am_off£t
, 
off£t
 + 
d©®’
);

2187 
	}
}

2189 
	gCl›Á
::
	$Ú_¡»am_şo£
(
ušt64_t
 
¡»am_id
) {

2190 autØ
™
 = 
¡»ams_
.
	`fšd
(
¡»am_id
);

2192 ià(
™
 =ğ
¡d
::
	`’d
(
¡»ams_
)) {

2196 ià(
cÚfig
.
š‹¿ùive
) {

2197 
	`ev_io_¡İ
(
loİ_
, &
¡dš»v_
);

2200 
¡d
::
û¼
 << "Ú_¡»am_şo£" << std::
’dl
;

2201 
¡»ams_
.
	`”a£
(
™
);

2202 
	}
}

2204 
	gÇme¥aû
 {

2205 
wr™e_Œª¥Üt_·¿ms
(cÚ¡ *
·th
,

2206 cÚ¡ 
ngtı2_Œª¥Üt_·¿ms
 *
·¿ms
) {

2207 autØ
	gf
 = 
¡d
::
of¡»am
(
·th
);

2208 ià(!
	gf
) {

2212 
	gf
 << "š™Ÿl_max_¡»ams_bidi=" << 
	g·¿ms
->
	gš™Ÿl_max_¡»ams_bidi
 << "\n"

2213 << "š™Ÿl_max_¡»ams_uni=" << 
	g·¿ms
->
	gš™Ÿl_max_¡»ams_uni
 << "\n"

2215 << 
	g·¿ms
->
	gš™Ÿl_max_¡»am_d©a_bidi_loÿl
 << "\n"

2217 << 
	g·¿ms
->
	gš™Ÿl_max_¡»am_d©a_bidi_»mÙe
 << "\n"

2218 << "š™Ÿl_max_¡»am_d©a_uni=" << 
	g·¿ms
->
	gš™Ÿl_max_¡»am_d©a_uni


2220 << "š™Ÿl_max_d©a=" << 
	g·¿ms
->
	gš™Ÿl_max_d©a
 << "\n";

2222 
	gf
.
şo£
();

2223 ià(!
	gf
) {

2231 
	gÇme¥aû
 {

2232 
»ad_Œª¥Üt_·¿ms
(cÚ¡ *
·th
, 
ngtı2_Œª¥Üt_·¿ms
 *
·¿ms
) {

2233 autØ
	gf
 = 
¡d
::
if¡»am
(
·th
);

2234 ià(!
	gf
) {

2238 
	g¡d
::
¡ršg
 
lše
; std::
g‘lše
(
f
,†ine);) {

2239 ià(
	gut
::
i¡¬ts_w™h_l
(
lše
, "initial_max_streams_bidi=")) {

2240 
	g·¿ms
->
	gš™Ÿl_max_¡»ams_bidi
 = 
¡¹oul
(

2241 
lše
.
c_¡r
(è+ 
¡r_size
("š™Ÿl_max_¡»ams_bidi="), 
nuÎ±r
, 10);

2242 } ià(
	gut
::
i¡¬ts_w™h_l
(
lše
, "initial_max_streams_uni=")) {

2243 
	g·¿ms
->
	gš™Ÿl_max_¡»ams_uni
 = 
¡¹oul
(

2244 
lše
.
c_¡r
(è+ 
¡r_size
("š™Ÿl_max_¡»ams_uni="), 
nuÎ±r
, 10);

2245 } ià(
	gut
::
i¡¬ts_w™h_l
(
lše
,

2247 
	g·¿ms
->
	gš™Ÿl_max_¡»am_d©a_bidi_loÿl
 = 
¡¹oul
(

2248 
lše
.
c_¡r
(è+ 
¡r_size
("initial_max_stream_data_bidi_local="),

2249 
nuÎ±r
, 10);

2250 } ià(
	gut
::
i¡¬ts_w™h_l
(
lše
,

2252 
	g·¿ms
->
	gš™Ÿl_max_¡»am_d©a_bidi_»mÙe
 = 
¡¹oul
(

2253 
lše
.
c_¡r
(è+ 
¡r_size
("initial_max_stream_data_bidi_remote="),

2254 
nuÎ±r
, 10);

2255 } ià(
	gut
::
i¡¬ts_w™h_l
(
lše
, "initial_max_stream_data_uni=")) {

2256 
	g·¿ms
->
	gš™Ÿl_max_¡»am_d©a_uni
 = 
¡¹oul
(

2257 
lše
.
c_¡r
(è+ 
¡r_size
("š™Ÿl_max_¡»am_d©a_uni="), 
nuÎ±r
, 10);

2258 } ià(
	gut
::
i¡¬ts_w™h_l
(
lše
, "initial_max_data=")) {

2259 
	g·¿ms
->
	gš™Ÿl_max_d©a
 =

2260 
¡¹oul
(
lše
.
c_¡r
(è+ 
¡r_size
("š™Ÿl_max_d©a="), 
nuÎ±r
, 10);

2268 
	gCl›Á
::
	$make_¡»am_—¾y
() {

2269 
rv
;

2271 ià(
cÚfig
.
š‹¿ùive
 || 
d©afd_
 == -1) {

2275 ià(
n¡»ams_dÚe_
 >ğ
cÚfig
.
n¡»ams
) {

2279 ++
n¡»ams_dÚe_
;

2281 
ušt64_t
 
¡»am_id
;

2282 
rv
 = 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn_
, &
¡»am_id
, 
nuÎ±r
);

2283 ià(
rv
 != 0) {

2284 
¡d
::
û¼
 << "ngtı2_cÚn_İ’_bidi_¡»am: " << 
	`ngtı2_¡»¼Ü
(
rv
)

2285 << 
¡d
::
’dl
;

2289 autØ
¡»am
 = 
¡d
::
make_unique
<
SŒ—m
>(
¡»am_id
);

2290 
¡»am
->
	`bufãr_fe
();

2291 
¡»ams_
.
	`em¶aû
(
¡»am_id
, 
¡d
::
	`move
(
¡»am
));

2292 
	}
}

2294 
	gCl›Á
::
	$Ú_ex‹nd_max_¡»ams
() {

2295 
rv
;

2297 ià(
cÚfig
.
š‹¿ùive
 || cÚfig.
¹p
) {

2299 ià(
Ï¡_¡»am_id_
 !ğ
UINT64_MAX
) {

2306 ià(
	`¡¬t_¹p
() != 0) {

2314 ià(
d©afd_
 != -1) {

2315 ; 
n¡»ams_dÚe_
 < 
cÚfig
.
n¡»ams
; ++nstreams_done_) {

2316 
ušt64_t
 
¡»am_id
;

2318 
rv
 = 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn_
, &
¡»am_id
, 
nuÎ±r
);

2319 ià(
rv
 != 0) {

2320 
	`as£¹
(
NGTCP2_ERR_STREAM_ID_BLOCKED
 =ğ
rv
);

2324 
Ï¡_¡»am_id_
 = 
¡»am_id
;

2326 autØ
¡»am
 = 
¡d
::
make_unique
<
SŒ—m
>(
¡»am_id
);

2327 
¡»am
->
	`bufãr_fe
();

2329 
¡»ams_
.
	`em¶aû
(
¡»am_id
, 
¡d
::
	`move
(
¡»am
));

2335 
	}
}

2337 
	gCl›Á
::
	$¡¬t_wev
(è{ 
¡d
::
û¼
 << "RTP funùiÚ s¹ed" << std::
’dl
;

2339 
	`ev_io_¡¬t
(
loİ_
, &
wev_
); 
	}
}

2341 
	gCl›Á
::
	$£t_s_®”t
(
ušt8_t
 
®”t
è{ 
s_®”t_
 =‡Ë¹; 
	}
}

2343 
	gÇme¥aû
 {

2344 
Œª¥Üt_·¿ms_add_cb
(
SSL
 *
s¦
, 
ext_ty³
,

2345 
cÚ‹Á
, cÚ¡ **
out
,

2346 
size_t
 *
ou’
, 
X509
 *
x
, size_ˆ
chašidx
, *
®
,

2347 *
add_¬g
) {

2348 
	grv
;

2349 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
SSL_g‘_­p_d©a
(
s¦
));

2350 autØ
	gcÚn
 = 
c
->
cÚn
();

2352 
ngtı2_Œª¥Üt_·¿ms
 
	g·¿ms
;

2354 
	grv
 = 
ngtı2_cÚn_g‘_loÿl_Œª¥Üt_·¿ms
(

2355 
cÚn
, &
·¿ms
, 
NGTCP2_TRANSPORT_PARAMS_TYPE_CLIENT_HELLO
);

2356 ià(
	grv
 != 0) {

2357 *
®
 = 
SSL_AD_INTERNAL_ERROR
;

2361 
cÚ¡ex´
 
size_t
 
	gbufsize
 = 64;

2362 autØ
	gbuf
 = 
¡d
::
make_unique
<
ušt8_t
[]>(
bufsize
);

2364 autØ
	gnwr™e
 = 
ngtı2_’code_Œª¥Üt_·¿ms
(

2365 
buf
.
g‘
(), 
bufsize
, 
NGTCP2_TRANSPORT_PARAMS_TYPE_CLIENT_HELLO
, &
·¿ms
);

2366 ià(
	gnwr™e
 < 0) {

2367 
	g¡d
::
û¼
 << "ngtı2_’code_Œª¥Üt_·¿ms: " << 
ngtı2_¡»¼Ü
(
nwr™e
)

2368 << 
¡d
::
’dl
;

2369 *
	g®
 = 
SSL_AD_INTERNAL_ERROR
;

2373 *
	gout
 = 
buf
.
»Ëa£
();

2374 *
	gou’
 = 
¡©ic_ÿ¡
<
size_t
>(
nwr™e
);

2380 
	gÇme¥aû
 {

2381 
Œª¥Üt_·¿ms_ä“_cb
(
SSL
 *
s¦
, 
ext_ty³
,

2382 
cÚ‹xt
, cÚ¡ *
out
,

2383 *
add_¬g
) {

2384 
	gd–‘e
[] 
	gcÚ¡_ÿ¡
<*>(
	gout
);

2388 
	gÇme¥aû
 {

2389 
Œª¥Üt_·¿ms_·r£_cb
(
SSL
 *
s¦
, 
ext_ty³
,

2390 
cÚ‹xt
, cÚ¡ *
š
,

2391 
size_t
 
šËn
, 
X509
 *
x
, size_ˆ
chašidx
, *
®
,

2392 *
·r£_¬g
) {

2393 autØ
	gc
 = 
¡©ic_ÿ¡
<
Cl›Á
 *>(
SSL_g‘_­p_d©a
(
s¦
));

2394 autØ
	gcÚn
 = 
c
->
cÚn
();

2396 
	grv
;

2398 
ngtı2_Œª¥Üt_·¿ms
 
	g·¿ms
;

2400 
	grv
 = 
ngtı2_decode_Œª¥Üt_·¿ms
(

2401 &
·¿ms
, 
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
, 
š
, 
šËn
);

2402 ià(
	grv
 != 0) {

2403 
¡d
::
û¼
 << "ngtı2_decode_Œª¥Üt_·¿ms: " << 
ngtı2_¡»¼Ü
(
rv
)

2404 << 
¡d
::
’dl
;

2405 *
	g®
 = 
SSL_AD_ILLEGAL_PARAMETER
;

2409 
	grv
 = 
ngtı2_cÚn_£t_»mÙe_Œª¥Üt_·¿ms
(

2410 
cÚn
, 
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
, &
·¿ms
);

2411 ià(
	grv
 != 0) {

2412 
¡d
::
û¼
 << "ngtcp2_conn_set_remote_transport_params: "

2413 << 
ngtı2_¡»¼Ü
(
rv
è<< 
¡d
::
’dl
;

2414 *
	g®
 = 
SSL_AD_ILLEGAL_PARAMETER
;

2418 ià(
	gcÚfig
.
	g_fe
 && 
wr™e_Œª¥Üt_·¿ms
(
cÚfig
.
_fe
, &
·¿ms
) != 0) {

2419 
¡d
::
û¼
 << "Could‚Ù wr™Œª¥Üˆ·¿m‘” š " << 
cÚfig
.
_fe


2420 << 
¡d
::
’dl
;

2427 
	gÇme¥aû
 {

2428 
Ãw_£ssiÚ_cb
(
SSL
 *
s¦
, 
SSL_SESSION
 *
£ssiÚ
) {

2429 ià(
SSL_SESSION_g‘_max_—¾y_d©a
(
£ssiÚ
) !=

2430 
¡d
::
num”ic_lim™s
<
ušt32_t
>::
max
()) {

2431 
¡d
::
û¼
 << "max_—¾y_d©a_sizi nÙ 0xffffffff" << std::
’dl
;

2433 autØ
	gf
 = 
BIO_Ãw_fe
(
cÚfig
.
£ssiÚ_fe
, "w");

2434 ià(
	gf
 =ğ
nuÎ±r
) {

2435 
¡d
::
û¼
 << "Could‚Ù wr™TLS sessiÚ iÀ" << 
cÚfig
.
£ssiÚ_fe


2436 << 
¡d
::
’dl
;

2440 
PEM_wr™e_bio_SSL_SESSION
(
f
, 
£ssiÚ
);

2441 
BIO_ä“
(
f
);

2447 
	gÇme¥aû
 {

2448 
SSL_CTX
 *
ü—‹_s¦_ùx
() {

2449 autØ
	gs¦_ùx
 = 
SSL_CTX_Ãw
(
TLS_m‘hod
());

2451 
SSL_CTX_£t_mš_´Ùo_v”siÚ
(
s¦_ùx
, 
TLS1_3_VERSION
);

2452 
SSL_CTX_£t_max_´Ùo_v”siÚ
(
s¦_ùx
, 
TLS1_3_VERSION
);

2456 
SSL_CTX_ş—r_İtiÚs
(
s¦_ùx
, 
SSL_OP_ENABLE_MIDDLEBOX_COMPAT
);

2458 
SSL_CTX_£t_deçuÉ_v”ify_·ths
(
s¦_ùx
);

2460 ià(
SSL_CTX_£t_ch”su™es
(
s¦_ùx
, 
cÚfig
.
ch”s
) != 1) {

2461 
¡d
::
û¼
 << "SSL_CTX_set_ciphersuites: "

2462 << 
ERR_”rÜ_¡ršg
(
ERR_g‘_”rÜ
(), 
nuÎ±r
è<< 
¡d
::
’dl
;

2463 
ex™
(
EXIT_FAILURE
);

2466 ià(
SSL_CTX_£t1_groups_li¡
(
s¦_ùx
, 
cÚfig
.
groups
) != 1) {

2467 
¡d
::
û¼
 << "SSL_CTX_£t1_groups_li¡ faed" << std::
’dl
;

2468 
ex™
(
EXIT_FAILURE
);

2471 
SSL_CTX_£t_mode
(
s¦_ùx
, 
SSL_MODE_QUIC_HACK
);

2473 ià(
SSL_CTX_add_cu¡om_ext
(

2474 
s¦_ùx
, 
NGTCP2_TLSEXT_QUIC_TRANSPORT_PARAMETERS
,

2475 
SSL_EXT_CLIENT_HELLO
 | 
SSL_EXT_TLS1_3_ENCRYPTED_EXTENSIONS
,

2476 
Œª¥Üt_·¿ms_add_cb
, 
Œª¥Üt_·¿ms_ä“_cb
, 
nuÎ±r
,

2477 
Œª¥Üt_·¿ms_·r£_cb
, 
nuÎ±r
) != 1) {

2478 
¡d
::
û¼
 << "SSL_CTX_add_custom_ext(NGTCP2_TLSEXT_QUIC_TRANSPORT_"

2480 << 
ERR_”rÜ_¡ršg
(
ERR_g‘_”rÜ
(), 
nuÎ±r
è<< 
¡d
::
’dl
;

2481 
ex™
(
EXIT_FAILURE
);

2484 ià(
	gcÚfig
.
	g£ssiÚ_fe
) {

2485 
SSL_CTX_£t_£ssiÚ_ÿche_mode
(

2486 
s¦_ùx
, 
SSL_SESS_CACHE_CLIENT
 | 
SSL_SESS_CACHE_NO_INTERNAL_STORE
);

2487 
SSL_CTX_£ss_£t_Ãw_cb
(
s¦_ùx
, 
Ãw_£ssiÚ_cb
);

2490  
	gs¦_ùx
;

2494 
	gÇme¥aû
 {

2495 
run
(
Cl›Á
 &
c
, cÚ¡ *
addr
, cÚ¡ *
pÜt
) {

2496 
Add»ss
 
	g»mÙe_addr
, 
	gloÿl_addr
;

2497 
ssize_t
 
	gnwr™e
;

2499 autØ
	gfd
 = 
ü—‹_sock
(
»mÙe_addr
, 
addr
, 
pÜt
);

2500 ià(
	gfd
 == -1) {

2504 ià(
bšd_addr
(
loÿl_addr
, 
fd
, 
»mÙe_addr
.
su
.
§
.
§_çmy
) != 0) {

2505 
şo£
(
fd
);

2509 ià(
	gc
.
š™
(
fd
, 
loÿl_addr
, 
»mÙe_addr
, 
addr
, 
pÜt
, 
cÚfig
.fd,

2510 
cÚfig
.
v”siÚ
) != 0) {

2514 ià(
	gcÚfig
.
	g_fe
) {

2515 
ngtı2_Œª¥Üt_·¿ms
 
	g·¿ms
;

2516 ià(
»ad_Œª¥Üt_·¿ms
(
cÚfig
.
_fe
, &
·¿ms
) != 0) {

2517 
¡d
::
û¼
 << "Could‚Ù„—d¿n¥Üˆ·¿m‘” äom " << 
cÚfig
.
_fe


2518 << 
¡d
::
’dl
;

2520 
ngtı2_cÚn_£t_—¾y_»mÙe_Œª¥Üt_·¿ms
(
c
.
cÚn
(), &
·¿ms
);

2521 
	gc
.
make_¡»am_—¾y
();

2526 autØ
	grv
 = 
c
.
wr™e_0¹t_¡»ams
();

2527 ià(
	grv
 != 0) {

2528  
rv
;

2531 
	gnwr™e
 = 
c
.
do_hªdshake_wr™e_Úû
();

2532 ià(
	gnwr™e
 < 0) {

2533  
	gnwr™e
;

2536 
	gc
.
scheduË_»Œªsm™
();

2538 
ev_run
(
EV_DEFAULT
, 0);

2544 
	gÇme¥aû
 {

2545 
	g¡d
::
of¡»am
 
keylog_fe
;

2546 
keylog_ÿÎback
(cÚ¡ 
SSL
 *
s¦
, cÚ¡ *
lše
) {

2547 
	gkeylog_fe
.
wr™e
(
lše
, 
¡¾’
(line));

2548 
	gkeylog_fe
.
put
('\n');

2549 
	gkeylog_fe
.
æush
();

2553 
	gÇme¥aû
 {

2554 
´št_u§ge
() {

2555 
	g¡d
::
û¼
 << "U§ge: cl›Á [OPTIONS] <ADDR> <PORT>" << 
¡d
::
’dl
;

2559 
	gÇme¥aû
 {

2560 
cÚfig_£t_deçuÉ
(
CÚfig
 &
cÚfig
) {

2561 
	gcÚfig
 = 
CÚfig
{};

2562 
	gcÚfig
.
	gtx_loss_´ob
 = 0.;

2563 
	gcÚfig
.
	grx_loss_´ob
 = 0.;

2564 
	gcÚfig
.
	gfd
 = -1;

2565 
	gcÚfig
.
	gch”s
 = "TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_"

2567 
	gcÚfig
.
	ggroups
 = "P-256:X25519:P-384:P-521";

2568 
	gcÚfig
.
	gn¡»ams
 = 1;

2569 
	gcÚfig
.
	gd©a
 = 
nuÎ±r
;

2570 
	gcÚfig
.
	gd©®’
 = 0;

2571 
	gcÚfig
.
	gv”siÚ
 = 
NGTCP2_PROTO_VER_D17
;

2572 
	gcÚfig
.
	gtimeout
 = 30;

2576 
	gÇme¥aû
 {

2577 
´št_h–p
() {

2578 
´št_u§ge
();

2580 
cÚfig_£t_deçuÉ
(
cÚfig
);

2582 
	g¡d
::
cout
 << 
R
"(

2583 <
ADDR
> 
RemÙe
 
£rv”
 
add»ss


2584 <
PORT
> 
RemÙe
 
£rv”
 
pÜt


2585 
O±iÚs
:

2586 -
t
, --
	gtx
-
	gloss
=<
P
>

2587 
The
 
´obab™y
 
of
 
losšg
 
outgošg
 
·ck‘s
. <
P
> 
mu¡
 
be


2588 [0.0, 1.0], 
	gšşusive
. 0.0 
m—ns
 
no
 
·ck‘
 
	gloss
. 1.0

2589 
	gm—ns
 100% 
·ck‘
 
	gloss
.

2590 -
	gr
, --
	grx
-
	gloss
=<
P
>

2591 
The
 
´obab™y
 
of
 
losšg
 
šcomšg
 
·ck‘s
. <
P
> 
mu¡
 
be


2592 [0.0, 1.0], 
	gšşusive
. 0.0 
m—ns
 
no
 
·ck‘
 
	gloss
. 1.0

2593 
	gm—ns
 100% 
·ck‘
 
	gloss
.

2594 -
	gi
, --
š‹¿ùive


2595 
R—d
 
šput
 
äom
 
	g¡dš
, 
ªd
 
£nd
 
them
 
as
 
STREAM
 
	gd©a
.

2596 -
	gd
, --
	gd©a
=<
PATH
>

2597 
R—d
 
d©a
 
äom
 <
PATH
>, 
ªd
 
£nd
 
them
 
as
 
STREAM
 
	gd©a
.

2598 -
	gn
, --
	gn¡»ams
=<
N
>

2599 
Wh’
 
u£d
 
w™h
 --
d©a
, 
this
 
İtiÚ
 
¥ecif›s
 
the
 
numb”


2600 
of
 
¡»ams
 
to
 
£nd
 
the
 
d©a
 
¥ecif›d
 
	gby
 --
	gd©a
.

2601 -
	gv
, --
	gv”siÚ
=<
HEX
>

2602 
S³cify
 
QUIC
 
v”siÚ
 
to
 
u£
 
š
 
hex
 
¡ršg
.

2603 
DeçuÉ
: )"

2604 << 
¡d
::
hex
 << "0x" << 
cÚfig
.
v”siÚ
 << std::
dec
 << 
R
"(

2605 -
q
, --
qu›t
 
Suµ»ss
 
debug
 
	gouut
.

2606 -
	gs
, --
	gshow
-
£ü‘


2607 
Pršt
 
out
 
£ü‘s
 
	guÆess
 --
qu›t
 
is
 
	gu£d
.

2608 --
	gtimeout
=<
T
>

2609 
S³cify
 
idË
 
timeout
 
š
 
£cÚds
.

2610 
DeçuÉ
: )"

2611 << 
cÚfig
.
timeout
 << 
R
"(

2612 --
ch”s
=<
CIPHERS
>

2613 
S³cify
 
the
 
ch”
 
su™e
 
li¡
 
to
 
’abË
.

2614 
DeçuÉ
: )"

2615 << 
cÚfig
.
ch”s
 << 
R
"(

2616 --
groups
=<
GROUPS
>

2617 
S³cify
 
the
 
suµÜ‹d
 
groups
.

2618 
DeçuÉ
: )"

2619 << 
cÚfig
.
groups
 << 
R
"(

2620 --
£ssiÚ
-
fe
=<
PATH
>

2621 
R—d
/
wr™e
 
TLS
 
£ssiÚ
 
äom
/
to
 <
PATH
>. 
To
 
»sume
 
a


2622 
£ssiÚ
, 
the
 
´evious
 sessiÚ 
mu¡
 
be
 
suµl›d
 
w™h
 
this


2623 
	gİtiÚ
.

2624 --
	g
-
	gfe
=<
PATH
>

2625 
R—d
/
wr™e
 
QUIC
 
Œª¥Üt
 
·¿m‘”s
 
äom
/
to
 <
PATH
>. 
To


2626 
£nd
 0-
RTT
 
d©a
, 
the
 
Œª¥Üt
 
·¿m‘”s
 
»ûived
 
äom


2627 
the
 
´evious
 
£ssiÚ
 
mu¡
 
be
 
suµl›d
 
w™h
 
this
 
	gİtiÚ
.

2628 -
	gh
, --
h–p
 
Di¥Ïy
 
this
 h–°
ªd
 
	gex™
.

2633 
	$maš
(
¬gc
, **
¬gv
) {

2634 
	`cÚfig_£t_deçuÉ
(
cÚfig
);

2635 *
d©a_·th
 = 
nuÎ±r
;

2638 
æag
 = 0;

2639 
cÚ¡ex´
 
İtiÚ
 
lÚg_İts
[] = {

2640 {"h–p", 
no_¬gum’t
, 
nuÎ±r
, 'h'},

2641 {"tx-loss", 
»quœed_¬gum’t
, 
nuÎ±r
, 't'},

2642 {"rx-loss", 
»quœed_¬gum’t
, 
nuÎ±r
, 'r'},

2643 {"š‹¿ùive", 
no_¬gum’t
, 
nuÎ±r
, 'i'},

2644 {"d©a", 
»quœed_¬gum’t
, 
nuÎ±r
, 'd'},

2645 {"n¡»ams", 
»quœed_¬gum’t
, 
nuÎ±r
, 'n'},

2646 {"v”siÚ", 
»quœed_¬gum’t
, 
nuÎ±r
, 'v'},

2649 {"¹p", 
no_¬gum’t
, 
nuÎ±r
, 'e'},

2651 {"qu›t", 
no_¬gum’t
, 
nuÎ±r
, 'q'},

2652 {"show-£ü‘", 
no_¬gum’t
, 
nuÎ±r
, 's'},

2653 {"ch”s", 
»quœed_¬gum’t
, &
æag
, 1},

2654 {"groups", 
»quœed_¬gum’t
, &
æag
, 2},

2655 {"timeout", 
»quœed_¬gum’t
, &
æag
, 3},

2656 {"£ssiÚ-fe", 
»quœed_¬gum’t
, &
æag
, 4},

2657 {"-fe", 
»quœed_¬gum’t
, &
æag
, 5},

2658 {
nuÎ±r
, 0,‚ullptr, 0},

2661 autØ
İtidx
 = 0;

2663 autØ
c
 = 
	`g‘İt_lÚg
(
¬gc
, 
¬gv
, "d:hš:eqr:¡:v:", 
lÚg_İts
, &
İtidx
);

2664 ià(
c
 == -1) {

2667 
c
) {

2670 
d©a_·th
 = 
İrg
;

2674 
	`´št_h–p
();

2675 
	`ex™
(
EXIT_SUCCESS
);

2678 
cÚfig
.
n¡»ams
 = 
	`¡¹Ş
(
İrg
, 
nuÎ±r
, 10);

2682 
cÚfig
.
qu›t
 = 
Œue
;

2686 
cÚfig
.
rx_loss_´ob
 = 
	`¡¹od
(
İrg
, 
nuÎ±r
);

2690 
cÚfig
.
show_£ü‘
 = 
Œue
;

2694 
cÚfig
.
tx_loss_´ob
 = 
	`¡¹od
(
İrg
, 
nuÎ±r
);

2698 
cÚfig
.
fd
 = 
	`f’o
(
¡dš
);

2699 
cÚfig
.
š‹¿ùive
 = 
Œue
;

2703 
cÚfig
.
v”siÚ
 = 
	`¡¹Ş
(
İrg
, 
nuÎ±r
, 16);

2708 
cÚfig
.
¹p
 = 
Œue
;

2711 
	`´št_u§ge
();

2712 
	`ex™
(
EXIT_FAILURE
);

2714 
æag
) {

2717 
cÚfig
.
ch”s
 = 
İrg
;

2721 
cÚfig
.
groups
 = 
İrg
;

2725 
cÚfig
.
timeout
 = 
	`¡¹Ş
(
İrg
, 
nuÎ±r
, 10);

2729 
cÚfig
.
£ssiÚ_fe
 = 
İrg
;

2733 
cÚfig
.
_fe
 = 
İrg
;

2742 ià(
¬gc
 - 
İtšd
 < 2) {

2743 
¡d
::
û¼
 << "ToØãw‡rgum’ts" << std::
’dl
;

2744 
	`´št_u§ge
();

2745 
	`ex™
(
EXIT_FAILURE
);

2748 ià(
d©a_·th
 && 
cÚfig
.
¹p
 && cÚfig.
š‹¿ùive
) {

2749 
¡d
::
û¼


2751 << 
¡d
::
’dl
;

2752 
	`ex™
(
EXIT_FAILURE
);

2755 ià(
d©a_·th
) {

2756 autØ
fd
 = 
	`İ’
(
d©a_·th
, 
O_RDONLY
);

2757 ià(
fd
 == -1) {

2758 
¡d
::
û¼
 << "d©a: Could‚Ù o³Àf" << 
d©a_·th
 << ": "

2759 << 
	`¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

2760 
	`ex™
(
EXIT_FAILURE
);

2762 
¡©
 
¡
;

2763 ià(
	`f¡©
(
fd
, &
¡
) != 0) {

2764 
¡d
::
û¼
 << "d©a: Could‚Ù sˆf" << 
d©a_·th
 << ": "

2765 << 
	`¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

2766 
	`ex™
(
EXIT_FAILURE
);

2768 
cÚfig
.
fd
 = fd;

2769 
cÚfig
.
d©®’
 = 
¡
.
¡_size
;

2770 
cÚfig
.
d©a
 = 
¡©ic_ÿ¡
<
ušt8_t
 *>(

2771 
	`mm­
(
nuÎ±r
, 
cÚfig
.
d©®’
, 
PROT_READ
, 
MAP_SHARED
, 
fd
, 0));

2774 autØ
addr
 = 
¬gv
[
İtšd
++];

2775 autØ
pÜt
 = 
¬gv
[
İtšd
++];

2777 autØ
s¦_ùx
 = 
	`ü—‹_s¦_ùx
();

2778 autØ
s¦_ùx_d
 = 
	`deãr
(
SSL_CTX_ä“
, 
s¦_ùx
);

2780 autØ
ev_loİ_d
 = 
	`deãr
(
ev_loİ_de¡roy
, 
EV_DEFAULT
);

2782 ià(
	`i§‰y
(
STDOUT_FILENO
)) {

2783 
debug
::
	`£t_cŞÜ_ouut
(
Œue
);

2786 autØ
keylog_f’ame
 = 
	`g‘’v
("SSLKEYLOGFILE");

2787 ià(
keylog_f’ame
) {

2788 
keylog_fe
.
	`İ’
(
keylog_f’ame
, 
¡d
::
ios_ba£
::
­p
);

2789 ià(
keylog_fe
) {

2790 
	`SSL_CTX_£t_keylog_ÿÎback
(
s¦_ùx
, 
keylog_ÿÎback
);

2794 
Cl›Á
 
	`c
(
EV_DEFAULT
, 
s¦_ùx
);

2796 ià(
	`run
(
c
, 
addr
, 
pÜt
) != 0) {

2797 
	`ex™
(
EXIT_FAILURE
);

2800  
EXIT_SUCCESS
;

2801 
	}
}

	@examples/client.h

25 #iâdeà
CLIENT_H


26 
	#CLIENT_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<veùÜ
>

33 
	~<deque
>

34 
	~<m­
>

36 
	~<ngtı2/ngtı2.h
>

38 
	~<İ’s¦/s¦.h
>

40 
	~<ev.h
>

42 
	~"ÃtwÜk.h
"

43 
	~"üy±o.h
"

44 
	~"‹m¶©e.h
"

46 
usšg
 
Çme¥aû
 
	gngtı2
;

48 
	sCÚfig
 {

49 
ngtı2_cid
 
	mdcid
;

51 
	mtx_loss_´ob
;

53 
	mrx_loss_´ob
;

55 
	mfd
;

57 cÚ¡ *
	mch”s
;

59 cÚ¡ *
	mgroups
;

61 
boŞ
 
	mš‹¿ùive
;

64 
boŞ
 
	m¹p
;

66 
size_t
 
	mn¡»ams
;

69 
ušt8_t
 *
	md©a
;

71 
size_t
 
	md©®’
;

73 
ušt32_t
 
	mv”siÚ
;

76 
boŞ
 
	mqu›t
;

78 
ušt32_t
 
	mtimeout
;

80 cÚ¡ *
	m£ssiÚ_fe
;

83 cÚ¡ *
	m_fe
;

85 
boŞ
 
	mshow_£ü‘
;

88 
ušt32_t
 
	mchªge_loÿl_addr
;

91 
ušt32_t
 
	mkey_upd©e
;

93 
boŞ
 
	mÇt_»bšdšg
;

96 
	sBufãr
 {

97 
Bufãr
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
);

98 
Bufãr
(
ušt8_t
 *
begš
, ušt8_ˆ*
’d
);

99 
ex¶ic™
 
Bufãr
(
size_t
 
d©®’
);

100 
Bufãr
();

102 
size_t
 
size
(ècÚ¡ {  
	m
 - 
	mh—d
; }

103 
size_t
 
Ëá
(ècÚ¡ {  
	mbuf
.
d©a
(è+ buf.
size
(è- 
	m
; }

104 
ušt8_t
 *cÚ¡ 
wpos
(è{  
	m
; }

105 cÚ¡ 
ušt8_t
 *
½os
(ècÚ¡ {  
	mh—d
; }

106 
£ek
(
size_t
 
Ën
è{ 
	mh—d
 +=†en; }

107 
push
(
size_t
 
Ën
è{ 
	m
 +=†en; }

108 
»£t
() {

109 
	mh—d
 = 
begš
;

110 
	m
 = 
begš
;

112 
size_t
 
bufsize
(ècÚ¡ {  
	m
 - 
	mbegš
; }

114 
	m¡d
::
veùÜ
<
ušt8_t
> 
buf
;

118 
ušt8_t
 *
	mbegš
;

121 
ušt8_t
 *
	mh—d
;

124 
ušt8_t
 *
	m
;

127 
	sSŒ—m
 {

128 
SŒ—m
(
ušt64_t
 
¡»am_id
);

129 ~
SŒ—m
();

131 
bufãr_fe
();

133 
ušt64_t
 
	m¡»am_id
;

134 
	m¡d
::
deque
<
Bufãr
> 
¡»ambuf
;

137 
size_t
 
	m¡»ambuf_idx
;

140 
ušt64_t
 
	mtx_¡»am_off£t
;

141 
boŞ
 
	mshould_£nd_fš
;

144 şas 
	cCl›Á
 {

145 
	mpublic
:

146 
Cl›Á
(
ev_loİ
 *
loİ
, 
SSL_CTX
 *
s¦_ùx
);

147 ~
Cl›Á
();

149 
š™
(
fd
, cÚ¡ 
Add»ss
 &
loÿl_addr
, cÚ¡ Add»s &
»mÙe_addr
,

150 cÚ¡ *
addr
, cÚ¡ *
pÜt
, 
d©afd
, 
ušt32_t
 
v”siÚ
);

151 
š™_s¦
();

152 
discÚÃù
();

153 
discÚÃù
(
lib”r
);

154 
şo£
();

156 
¡¬t_wev
();

158 
s_hªdshake
(
boŞ
 
š™Ÿl
 = 
çl£
);

159 
»ad_s
();

160 
Ú_»ad
();

161 
Ú_wr™e
(
boŞ
 
»Œªsm™
 = 
çl£
);

162 
wr™e_¡»ams
();

163 
Ú_wr™e_¡»am
(
ušt64_t
 
¡»am_id
, 
ušt8_t
 
fš
, 
Bufãr
 &
d©a
);

164 
wr™e_0¹t_¡»ams
();

165 
Ú_wr™e_0¹t_¡»am
(
ušt64_t
 
¡»am_id
, 
ušt8_t
 
fš
, 
Bufãr
 &
d©a
);

166 
ãed_d©a
(cÚ¡ 
sockaddr
 *
§
, 
sockËn_t
 
§Ën
, 
ušt8_t
 *
d©a
,

167 
size_t
 
d©®’
);

168 
do_hªdshake
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
);

169 
do_hªdshake_»ad_Úû
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
);

170 
ssize_t
 
do_hªdshake_wr™e_Úû
();

171 
scheduË_»Œªsm™
();

173 
wr™e_ş›Á_hªdshake
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
);

174 
wr™e_ş›Á_hªdshake
(
¡d
::
deque
<
Bufãr
> &
de¡
, 
size_t
 &
idx
,

175 cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
);

176 
size_t
 
»ad_ş›Á_hªdshake
(cÚ¡ 
ušt8_t
 **
pde¡
);

178 
size_t
 
»ad_£rv”_hªdshake
(
ušt8_t
 *
buf
, size_ˆ
buæ’
);

179 
wr™e_£rv”_hªdshake
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
);

181 
£tup_š™Ÿl_üy±o_cÚ‹xt
();

182 
ssize_t
 
hs_’üy±_d©a
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

183 cÚ¡ 
ušt8_t
 *
¶aš‹xt
, 
size_t
 
¶aš‹x’
,

184 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

185 cÚ¡ 
ušt8_t
 *
nÚû
, 
size_t
 
nÚûËn
,

186 cÚ¡ 
ušt8_t
 *
ad
, 
size_t
 
adËn
);

187 
ssize_t
 
hs_deüy±_d©a
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

188 cÚ¡ 
ušt8_t
 *
ch”‹xt
, 
size_t
 
ch”‹x’
,

189 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

190 cÚ¡ 
ušt8_t
 *
nÚû
, 
size_t
 
nÚûËn
,

191 cÚ¡ 
ušt8_t
 *
ad
, 
size_t
 
adËn
);

192 
ssize_t
 
’üy±_d©a
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
¶aš‹xt
,

193 
size_t
 
¶aš‹x’
, cÚ¡ 
ušt8_t
 *
key
, size_ˆ
keyËn
,

194 cÚ¡ 
ušt8_t
 *
nÚû
, 
size_t
 
nÚûËn
, cÚ¡ ušt8_ˆ*
ad
,

195 
size_t
 
adËn
);

196 
ssize_t
 
deüy±_d©a
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
ch”‹xt
,

197 
size_t
 
ch”‹x’
, cÚ¡ 
ušt8_t
 *
key
, size_ˆ
keyËn
,

198 cÚ¡ 
ušt8_t
 *
nÚû
, 
size_t
 
nÚûËn
, cÚ¡ ušt8_ˆ*
ad
,

199 
size_t
 
adËn
);

200 
ssize_t
 
š_hp_mask
(
ušt8_t
 *
d©a
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
key
,

201 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
§m¶e
, size_ˆ
§m¶–’
);

202 
ssize_t
 
hp_mask
(
ušt8_t
 *
d©a
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
key
,

203 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
§m¶e
, size_ˆ
§m¶–’
);

204 
ngtı2_cÚn
 *
	$cÚn
() const;

205 
	`£nd_·ck‘
();

206 
	`¡¬t_š‹¿ùive_šput
();

207 
	`£nd_š‹¿ùive_šput
();

208 
	`¡İ_š‹¿ùive_šput
();

210 
	`¡¬t_¹p
();

211 
	`£nd_¹p
();

212 
	`¡İ_¹p
();

214 
	`»move_tx_üy±o_d©a
(
ušt64_t
 
off£t
, 
size_t
 
d©®’
);

215 
	`»move_tx_¡»am_d©a
(
ušt64_t
 
¡»am_id
, ušt64_ˆ
off£t
,

216 
size_t
 
d©®’
);

217 
	`Ú_¡»am_şo£
(
ušt64_t
 
¡»am_id
);

218 
	`Ú_ex‹nd_max_¡»ams
();

219 
	`hªdË_”rÜ
(
lib”r
);

220 
	`make_¡»am_—¾y
();

221 
	`Ú_»cv_»Œy
();

222 
	`chªge_loÿl_addr
();

223 
	`¡¬t_chªge_loÿl_addr_tim”
();

224 
	`upd©e_key
();

225 
	`š™Ÿ‹_key_upd©e
();

226 
	`¡¬t_key_upd©e_tim”
();

228 
	`Ú_key
(
Çme
, cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
);

230 
	`£t_s_®”t
(
ušt8_t
 
®”t
);

233 
¹p_time¡amp_
;

234 
¹p_£qnum_
;

236 
´iv©e
:

237 
Add»ss
 
loÿl_addr_
;

238 
Add»ss
 
»mÙe_addr_
;

239 
size_t
 
max_pk’_
;

240 
ev_io
 
wev_
;

241 
ev_io
 
»v_
;

242 
ev_io
 
¡dš»v_
;

243 
ev_tim”
 
tim”_
;

244 
ev_tim”
 
¹tim”_
;

245 
ev_tim”
 
¹±im”_
;

246 
ev_tim”
 
chªge_loÿl_addr_tim”_
;

247 
ev_tim”
 
key_upd©e_tim”_
;

248 
ev_sigÇl
 
sigš‹v_
;

249 
ev_loİ
 *
loİ_
;

250 
SSL_CTX
 *
s¦_ùx_
;

251 
SSL
 *
s¦_
;

252 
fd_
;

253 
d©afd_
;

254 
¡d
::
m­
<
ušt32_t
, std::
unique_±r
<
SŒ—m
>> 
¡»ams_
;

255 
¡d
::
deque
<
Bufãr
> 
chªdshake_
;

258 
size_t
 
chªdshake_idx_
;

259 
ušt64_t
 
tx_üy±o_off£t_
;

260 
¡d
::
veùÜ
<
ušt8_t
> 
shªdshake_
;

261 
¡d
::
veùÜ
<
ušt8_t
> 
tx_£ü‘_
;

262 
¡d
::
veùÜ
<
ušt8_t
> 
rx_£ü‘_
;

263 
size_t
 
n¤—d_
;

264 
ngtı2_cÚn
 *
cÚn_
;

266 cÚ¡ *
addr_
;

268 cÚ¡ *
pÜt_
;

269 
üy±o
::
CÚ‹xt
 
hs_üy±o_ùx_
;

270 
üy±o
::
CÚ‹xt
 
üy±o_ùx_
;

272 
Bufãr
 
£ndbuf_
;

273 
ušt64_t
 
Ï¡_¡»am_id_
;

275 
ušt64_t
 
n¡»ams_dÚe_
;

277 
size_t
 
nkey_upd©e_
;

278 
ušt32_t
 
v”siÚ_
;

281 
ušt8_t
 
s_®”t_
;

283 
boŞ
 
»sum±iÚ_
;

	@examples/crypto.cc

25 
	~"üy±o.h
"

27 #ifdeà
HAVE_ARPA_INET_H


28 
	~<¬·/š‘.h
>

31 
	~<®gÜ™hm
>

33 
	~"‹m¶©e.h
"

35 
Çme¥aû
 
	gngtı2
 {

37 
Çme¥aû
 
	güy±o
 {

39 #ifdeà
WORDS_BIGENDIAN


40 
	#bsw­64
(
N
è(N)

	)

42 
	#bsw­64
(
N
) \

43 ((
ušt64_t
)(
	`Áohl
((
ušt32_t
)(
N
))è<< 32 |‚tohl((ušt32_t)((Nè>> 32)))

	)

46 
d”ive_š™Ÿl_£ü‘
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

47 cÚ¡ 
ngtı2_cid
 *
£ü‘
, cÚ¡ 
ušt8_t
 *
§É
,

48 
size_t
 
§ÉËn
) {

49 
CÚ‹xt
 
	gùx
;

50 
´f_sha256
(
ùx
);

51  
hkdf_exŒaù
(
de¡
, 
de¡Ën
, 
£ü‘
->
d©a
, seü‘->
d©®’
, 
§É
,

52 
§ÉËn
, 
ùx
);

55 
d”ive_ş›Á_š™Ÿl_£ü‘
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

56 cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
) {

57 
cÚ¡ex´
 
ušt8_t
 
	gLABEL
[] = "client in";

58 
CÚ‹xt
 
	gùx
;

59 
´f_sha256
(
ùx
);

60  
	güy±o
::
hkdf_ex·nd_Ïb–
(
de¡
, 
de¡Ën
, 
£ü‘
, 
£ü‘Ën
, 
LABEL
,

61 
¡r_size
(
LABEL
), 
ùx
);

64 
d”ive_£rv”_š™Ÿl_£ü‘
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

65 cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
) {

66 
cÚ¡ex´
 
ušt8_t
 
	gLABEL
[] = "server in";

67 
CÚ‹xt
 
	gùx
;

68 
´f_sha256
(
ùx
);

69  
	güy±o
::
hkdf_ex·nd_Ïb–
(
de¡
, 
de¡Ën
, 
£ü‘
, 
£ü‘Ën
, 
LABEL
,

70 
¡r_size
(
LABEL
), 
ùx
);

73 
ssize_t
 
upd©e_Œaffic_£ü‘
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

74 cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
,

75 cÚ¡ 
CÚ‹xt
 &
ùx
) {

76 
	grv
;

77 
cÚ¡ex´
 
ušt8_t
 
	gLABEL
[] = "traffic upd";

79 ià(
	gde¡Ën
 < 
	g£ü‘Ën
) {

83 
	grv
 = 
üy±o
::
hkdf_ex·nd_Ïb–
(
de¡
, 
£ü‘Ën
, 
£ü‘
, seü‘Ën, 
LABEL
,

84 
¡r_size
(
LABEL
), 
ùx
);

85 ià(
	grv
 != 0) {

89  
	g£ü‘Ën
;

92 
ssize_t
 
d”ive_·ck‘_´ÙeùiÚ_key
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

93 cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
,

94 cÚ¡ 
CÚ‹xt
 &
ùx
) {

95 
	grv
;

96 
cÚ¡ex´
 
ušt8_t
 
	gLABEL
[] = "quic key";

98 autØ
	gkeyËn
 = 
«ad_key_Ëngth
(
ùx
);

99 ià(
	gkeyËn
 > 
	gde¡Ën
) {

103 
	grv
 = 
üy±o
::
hkdf_ex·nd_Ïb–
(
de¡
, 
keyËn
, 
£ü‘
, 
£ü‘Ën
, 
LABEL
,

104 
¡r_size
(
LABEL
), 
ùx
);

105 ià(
	grv
 != 0) {

109  
	gkeyËn
;

112 
ssize_t
 
d”ive_·ck‘_´ÙeùiÚ_iv
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

113 cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
,

114 cÚ¡ 
CÚ‹xt
 &
ùx
) {

115 
	grv
;

116 
cÚ¡ex´
 
ušt8_t
 
	gLABEL
[] = "quic iv";

118 autØ
	givËn
 = 
¡d
::
max
(
¡©ic_ÿ¡
<
size_t
>(8), 
«ad_nÚû_Ëngth
(
ùx
));

119 ià(
	givËn
 > 
	gde¡Ën
) {

123 
	grv
 = 
üy±o
::
hkdf_ex·nd_Ïb–
(
de¡
, 
ivËn
, 
£ü‘
, 
£ü‘Ën
, 
LABEL
,

124 
¡r_size
(
LABEL
), 
ùx
);

125 ià(
	grv
 != 0) {

129  
	givËn
;

132 
ssize_t
 
d”ive_h—d”_´ÙeùiÚ_key
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

133 cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
,

134 cÚ¡ 
CÚ‹xt
 &
ùx
) {

135 
	grv
;

136 
cÚ¡ex´
 
ušt8_t
 
	gLABEL
[] = "quic hp";

138 autØ
	gkeyËn
 = 
«ad_key_Ëngth
(
ùx
);

139 ià(
	gkeyËn
 > 
	gde¡Ën
) {

143 
	grv
 = 
üy±o
::
hkdf_ex·nd_Ïb–
(
de¡
, 
keyËn
, 
£ü‘
, 
£ü‘Ën
, 
LABEL
,

144 
¡r_size
(
LABEL
), 
ùx
);

146 ià(
	grv
 != 0) {

150  
	gkeyËn
;

153 
hkdf_ex·nd_Ïb–
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
£ü‘
,

154 
size_t
 
£ü‘Ën
, cÚ¡ 
ušt8_t
 *
Ïb–
, size_ˆ
Ïb–Ën
,

155 cÚ¡ 
CÚ‹xt
 &
ùx
) {

156 
	g¡d
::
¬¿y
<
ušt8_t
, 256> 
	gšfo
;

157 
cÚ¡ex´
 cÚ¡ 
ušt8_t
 
	gLABEL
[] = "tls13 ";

159 autØ
	gp
 = 
¡d
::
begš
(
šfo
);

160 *
	gp
++ = 
de¡Ën
 / 256;

161 *
	gp
++ = 
de¡Ën
 % 256;

162 *
	gp
++ = 
¡r_size
(
LABEL
è+ 
Ïb–Ën
;

163 
	gp
 = 
¡d
::
cİy_n
(
LABEL
, 
¡r_size
(LABEL), 
p
);

164 
	gp
 = 
¡d
::
cİy_n
(
Ïb–
, 
Ïb–Ën
, 
p
);

165 *
	gp
++ = 0;

167  
hkdf_ex·nd
(
de¡
, 
de¡Ën
, 
£ü‘
, 
£ü‘Ën
, 
šfo
.
d©a
(),

168 
p
 - 
¡d
::
begš
(
šfo
), 
ùx
);

	@examples/crypto.h

25 #iâdeà
CRYPTO_H


26 
	#CRYPTO_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<¬¿y
>

34 
	~<ngtı2/ngtı2.h
>

36 
	~<İ’s¦/s¦.h
>

38 
Çme¥aû
 
	gngtı2
 {

40 
Çme¥aû
 
	güy±o
 {

42 
	sCÚ‹xt
 {

43 #ià
defšed
(
OPENSSL_IS_BORINGSSL
)

44 cÚ¡ 
EVP_AEAD
 *
	g«ad
;

46 cÚ¡ 
EVP_CIPHER
 *
	g«ad
;

48 cÚ¡ 
EVP_CIPHER
 *
	ghp
;

49 cÚ¡ 
EVP_MD
 *
	g´f
;

50 
	g¡d
::
¬¿y
<
ušt8_t
, 64> 
	gtx_£ü‘
, 
	grx_£ü‘
;

51 
size_t
 
	g£ü‘Ën
;

56 
ÃgÙŸ‹d_´f
(
CÚ‹xt
 &
ùx
, 
SSL
 *
s¦
);

60 
ÃgÙŸ‹d_«ad
(
CÚ‹xt
 &
ùx
, 
SSL
 *
s¦
);

64 
d”ive_š™Ÿl_£ü‘
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

65 cÚ¡ 
ngtı2_cid
 *
£ü‘
, cÚ¡ 
ušt8_t
 *
§É
,

66 
size_t
 
§ÉËn
);

69 
d”ive_ş›Á_š™Ÿl_£ü‘
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

70 cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
);

73 
d”ive_£rv”_š™Ÿl_£ü‘
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

74 cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
);

80 
ssize_t
 
upd©e_Œaffic_£ü‘
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

81 cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
,

82 cÚ¡ 
CÚ‹xt
 &
ùx
);

88 
ssize_t
 
d”ive_·ck‘_´ÙeùiÚ_key
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

89 cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
,

90 cÚ¡ 
CÚ‹xt
 &
ùx
);

95 
ssize_t
 
d”ive_·ck‘_´ÙeùiÚ_iv
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

96 cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
,

97 cÚ¡ 
CÚ‹xt
 &
ùx
);

103 
ssize_t
 
d”ive_h—d”_´ÙeùiÚ_key
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

104 cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
,

105 cÚ¡ 
CÚ‹xt
 &
ùx
);

112 
ssize_t
 
’üy±
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
¶aš‹xt
,

113 
size_t
 
¶aš‹x’
, cÚ¡ 
CÚ‹xt
 &
ùx
, cÚ¡ 
ušt8_t
 *
key
,

114 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
nÚû
, size_ˆ
nÚûËn
,

115 cÚ¡ 
ušt8_t
 *
ad
, 
size_t
 
adËn
);

122 
ssize_t
 
deüy±
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
ch”‹xt
,

123 
size_t
 
ch”‹x’
, cÚ¡ 
CÚ‹xt
 &
ùx
, cÚ¡ 
ušt8_t
 *
key
,

124 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
nÚû
, size_ˆ
nÚûËn
,

125 cÚ¡ 
ušt8_t
 *
ad
, 
size_t
 
adËn
);

128 
size_t
 
«ad_max_ov”h—d
(cÚ¡ 
CÚ‹xt
 &
ùx
);

131 
size_t
 
«ad_key_Ëngth
(cÚ¡ 
CÚ‹xt
 &
ùx
);

134 
size_t
 
«ad_nÚû_Ëngth
(cÚ¡ 
CÚ‹xt
 &
ùx
);

139 
ssize_t
 
hp_mask
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ 
CÚ‹xt
 &
ùx
,

140 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, cÚ¡ ušt8_ˆ*
§m¶e
,

141 
size_t
 
§m¶–’
);

146 
hkdf_ex·nd_Ïb–
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
£ü‘
,

147 
size_t
 
£ü‘Ën
, cÚ¡ 
ušt8_t
 *
Ïb–
, size_ˆ
Ïb–Ën
,

148 cÚ¡ 
CÚ‹xt
 &
ùx
);

152 
hkdf_ex·nd
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
£ü‘
,

153 
size_t
 
£ü‘Ën
, cÚ¡ 
ušt8_t
 *
Ïb–
, size_ˆ
Ïb–Ën
,

154 cÚ¡ 
CÚ‹xt
 &
ùx
);

158 
hkdf_exŒaù
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
£ü‘
,

159 
size_t
 
£ü‘Ën
, cÚ¡ 
ušt8_t
 *
§É
, size_ˆ
§ÉËn
,

160 cÚ¡ 
CÚ‹xt
 &
ùx
);

163 
´f_sha256
(
CÚ‹xt
 &
ùx
);

166 
«ad_«s_128_gcm
(
CÚ‹xt
 &
ùx
);

172 
mes§ge_dige¡
(
ušt8_t
 *
»s
, cÚ¡ 
EVP_MD
 *
m‘h
, cÚ¡ ušt8_ˆ*
d©a
,

173 
size_t
 
Ën
);

179 #ià
defšed
(
OPENSSL_IS_BORINGSSL
)

180 
šlše
 *
	$BIO_g‘_d©a
(
BIO
 *
bio
è{  bio->
±r
; 
	}
}

181 
šlše
 
	$BIO_£t_d©a
(
BIO
 *
bio
, *
±r
è{ bio->±¸ğ±r; 
	}
}

182 
šlše
 
	$BIO_£t_š™
(
BIO
 *
bio
, 
š™
è{ bio->š™ = in™; 
	}
}

184 
šlše
 
BIO_METHOD
 *
	$BIO_m‘h_Ãw
(
ty³
, cÚ¡ *
Çme
) {

185  
Ãw
 
BIO_METHOD
{
ty³
, 
Çme
};

186 
	}
}

187 
šlše
 
	$BIO_m‘h_£t_wr™e
(
BIO_METHOD
 *
m‘h
,

188 (*
wr™e
)(
BIO
 *, const *, )) {

189 
m‘h
->
bwr™e
 = 
wr™e
;

191 
	}
}

192 
šlše
 
	$BIO_m‘h_£t_»ad
(
BIO_METHOD
 *
m‘h
,

193 (*
»ad
)(
BIO
 *, *, )) {

194 
m‘h
->
b»ad
 = 
»ad
;

196 
	}
}

197 
šlše
 
	$BIO_m‘h_£t_puts
(
BIO_METHOD
 *
m‘h
,

198 (*
puts
)(
BIO
 *, const *)) {

199 
m‘h
->
bputs
 = 
puts
;

201 
	}
}

202 
šlše
 
	$BIO_m‘h_£t_g‘s
(
BIO_METHOD
 *
m‘h
,

203 (*
g‘s
)(
BIO
 *, *, )) {

204 
m‘h
->
bg‘s
 = 
g‘s
;

206 
	}
}

207 
šlše
 
	$BIO_m‘h_£t_ù¾
(
BIO_METHOD
 *
m‘h
,

208 (*
ù¾
)(
BIO
 *, , , *)) {

209 
m‘h
->
ù¾
 = ctrl;

211 
	}
}

212 
šlše
 
	$BIO_m‘h_£t_ü—‹
(
BIO_METHOD
 *
m‘h
, (*
ü—‹
)(
BIO
 *)) {

213 
m‘h
->
ü—‹
 = create;

215 
	}
}

216 
šlše
 
	$BIO_m‘h_£t_de¡roy
(
BIO_METHOD
 *
m‘h
, (*
de¡roy
)(
BIO
 *)) {

217 
m‘h
->
de¡roy
 = destroy;

219 
	}
}

	@examples/crypto_openssl.cc

25 
	~"üy±o.h
"

27 #ià!
defšed
(
OPENSSL_IS_BORINGSSL
)

29 
	~<ÿs£¹
>

31 
	~<İ’s¦/evp.h
>

32 
	~<İ’s¦/kdf.h
>

34 
	~"‹m¶©e.h
"

36 
Çme¥aû
 
	gngtı2
 {

38 
Çme¥aû
 
	güy±o
 {

40 
ÃgÙŸ‹d_´f
(
CÚ‹xt
 &
ùx
, 
SSL
 *
s¦
) {

41 
SSL_CIPHER_g‘_id
(
SSL_g‘_cu¼’t_ch”
(
s¦
))) {

44 
ùx
.
´f
 = 
EVP_sha256
();

47 
ùx
.
´f
 = 
EVP_sha384
();

54 
ÃgÙŸ‹d_«ad
(
CÚ‹xt
 &
ùx
, 
SSL
 *
s¦
) {

55 
SSL_CIPHER_g‘_id
(
SSL_g‘_cu¼’t_ch”
(
s¦
))) {

57 
ùx
.
«ad
 = 
EVP_«s_128_gcm
();

58 
	gùx
.
	ghp
 = 
EVP_«s_128_ùr
();

61 
ùx
.
«ad
 = 
EVP_«s_256_gcm
();

62 
	gùx
.
	ghp
 = 
EVP_«s_256_ùr
();

65 
ùx
.
«ad
 = 
EVP_chacha20_pŞy1305
();

66 
	gùx
.
	ghp
 = 
EVP_chacha20
();

73 
size_t
 
«ad_g_Ëngth
(cÚ¡ 
CÚ‹xt
 &
ùx
) {

74 ià(
	gùx
.
	g«ad
 =ğ
EVP_«s_128_gcm
(è|| 
ùx
.
«ad
 =ğ
EVP_«s_256_gcm
()) {

75  
EVP_GCM_TLS_TAG_LEN
;

77 ià(
	gùx
.
	g«ad
 =ğ
EVP_chacha20_pŞy1305
()) {

78  
EVP_CHACHAPOLY_TLS_TAG_LEN
;

80 
as£¹
(0);

83 
ssize_t
 
’üy±
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
¶aš‹xt
,

84 
size_t
 
¶aš‹x’
, cÚ¡ 
CÚ‹xt
 &
ùx
, cÚ¡ 
ušt8_t
 *
key
,

85 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
nÚû
, size_ˆ
nÚûËn
,

86 cÚ¡ 
ušt8_t
 *
ad
, 
size_t
 
adËn
) {

87 autØ
	ggËn
 = 
«ad_g_Ëngth
(
ùx
);

89 ià(
	gde¡Ën
 < 
	g¶aš‹x’
 + 
	ggËn
) {

93 autØ
	gaùx
 = 
EVP_CIPHER_CTX_Ãw
();

94 ià(
	gaùx
 =ğ
nuÎ±r
) {

98 autØ
	gaùx_d
 = 
deãr
(
EVP_CIPHER_CTX_ä“
, 
aùx
);

100 ià(
EVP_Enüy±In™_ex
(
aùx
, 
ùx
.
«ad
, 
nuÎ±r
,‚ullptr,‚ullptr) != 1) {

104 ià(
EVP_CIPHER_CTX_ù¾
(
aùx
, 
EVP_CTRL_AEAD_SET_IVLEN
, 
nÚûËn
, 
nuÎ±r
) !=

109 ià(
EVP_Enüy±In™_ex
(
aùx
, 
nuÎ±r
,‚uÎ±r, 
key
, 
nÚû
) != 1) {

113 
size_t
 
	gou’
 = 0;

114 
	gËn
;

116 ià(
EVP_Enüy±Upd©e
(
aùx
, 
nuÎ±r
, &
Ën
, 
ad
, 
adËn
) != 1) {

120 ià(
EVP_Enüy±Upd©e
(
aùx
, 
de¡
, &
Ën
, 
¶aš‹xt
, 
¶aš‹x’
) != 1) {

124 
	gou’
 = 
Ën
;

126 ià(
EVP_Enüy±Fš®_ex
(
aùx
, 
de¡
 + 
ou’
, &
Ën
) != 1) {

130 
	gou’
 +ğ
Ën
;

132 
as£¹
(
ou’
 + 
gËn
 <ğ
de¡Ën
);

134 ià(
EVP_CIPHER_CTX_ù¾
(
aùx
, 
EVP_CTRL_AEAD_GET_TAG
, 
gËn
, 
de¡
 + 
ou’
) !=

139 
	gou’
 +ğ
gËn
;

141  
	gou’
;

144 
ssize_t
 
deüy±
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
ch”‹xt
,

145 
size_t
 
ch”‹x’
, cÚ¡ 
CÚ‹xt
 &
ùx
, cÚ¡ 
ušt8_t
 *
key
,

146 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
nÚû
, size_ˆ
nÚûËn
,

147 cÚ¡ 
ušt8_t
 *
ad
, 
size_t
 
adËn
) {

148 autØ
	ggËn
 = 
«ad_g_Ëngth
(
ùx
);

150 ià(
	ggËn
 > 
	gch”‹x’
 || 
	gde¡Ën
 +aglen < ciphertextlen) {

154 
	gch”‹x’
 -ğ
gËn
;

155 autØ
	gg
 = 
ch”‹xt
 + 
ch”‹x’
;

157 autØ
	gaùx
 = 
EVP_CIPHER_CTX_Ãw
();

158 ià(
	gaùx
 =ğ
nuÎ±r
) {

162 autØ
	gaùx_d
 = 
deãr
(
EVP_CIPHER_CTX_ä“
, 
aùx
);

164 ià(
EVP_Deüy±In™_ex
(
aùx
, 
ùx
.
«ad
, 
nuÎ±r
,‚ullptr,‚ullptr) != 1) {

168 ià(
EVP_CIPHER_CTX_ù¾
(
aùx
, 
EVP_CTRL_AEAD_SET_IVLEN
, 
nÚûËn
, 
nuÎ±r
) !=

173 ià(
EVP_Deüy±In™_ex
(
aùx
, 
nuÎ±r
,‚uÎ±r, 
key
, 
nÚû
) != 1) {

177 
size_t
 
	gou’
;

178 
	gËn
;

180 ià(
EVP_Deüy±Upd©e
(
aùx
, 
nuÎ±r
, &
Ën
, 
ad
, 
adËn
) != 1) {

184 ià(
EVP_Deüy±Upd©e
(
aùx
, 
de¡
, &
Ën
, 
ch”‹xt
, 
ch”‹x’
) != 1) {

188 
	gou’
 = 
Ën
;

190 ià(
EVP_CIPHER_CTX_ù¾
(
aùx
, 
EVP_CTRL_AEAD_SET_TAG
, 
gËn
,

191 
cÚ¡_ÿ¡
<
ušt8_t
 *>(
g
)) != 1) {

195 ià(
EVP_Deüy±Fš®_ex
(
aùx
, 
de¡
 + 
ou’
, &
Ën
) != 1) {

199 
	gou’
 +ğ
Ën
;

201  
	gou’
;

204 
size_t
 
«ad_max_ov”h—d
(cÚ¡ 
CÚ‹xt
 &
ùx
è{  
«ad_g_Ëngth
(ctx); }

206 
size_t
 
«ad_key_Ëngth
(cÚ¡ 
CÚ‹xt
 &
ùx
) {

207  
EVP_CIPHER_key_Ëngth
(
ùx
.
«ad
);

210 
size_t
 
«ad_nÚû_Ëngth
(cÚ¡ 
CÚ‹xt
 &
ùx
) {

211  
EVP_CIPHER_iv_Ëngth
(
ùx
.
«ad
);

214 
ssize_t
 
hp_mask
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ 
CÚ‹xt
 &
ùx
,

215 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, cÚ¡ ušt8_ˆ*
§m¶e
,

216 
size_t
 
§m¶–’
) {

217 
cÚ¡ex´
 
ušt8_t
 
	gPLAINTEXT
[] = "\x00\x00\x00\x00\x00";

219 autØ
	gaùx
 = 
EVP_CIPHER_CTX_Ãw
();

220 ià(
	gaùx
 =ğ
nuÎ±r
) {

224 autØ
	gaùx_d
 = 
deãr
(
EVP_CIPHER_CTX_ä“
, 
aùx
);

226 ià(
EVP_Enüy±In™_ex
(
aùx
, 
ùx
.
hp
, 
nuÎ±r
, 
key
, 
§m¶e
) != 1) {

230 
size_t
 
	gou’
 = 0;

231 
	gËn
;

233 ià(
EVP_Enüy±Upd©e
(
aùx
, 
de¡
, &
Ën
, 
PLAINTEXT
, 
¡r_size
(PLAINTEXT)) !=

238 
as£¹
(
Ën
 == 5);

240 
	gou’
 = 
Ën
;

242 ià(
EVP_Enüy±Fš®_ex
(
aùx
, 
de¡
 + 
ou’
, &
Ën
) != 1) {

246 
as£¹
(
Ën
 == 0);

248  
	gou’
;

251 
hkdf_ex·nd
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
£ü‘
,

252 
size_t
 
£ü‘Ën
, cÚ¡ 
ušt8_t
 *
šfo
, size_ˆ
šfŞ’
,

253 cÚ¡ 
CÚ‹xt
 &
ùx
) {

254 autØ
	gpùx
 = 
EVP_PKEY_CTX_Ãw_id
(
EVP_PKEY_HKDF
, 
nuÎ±r
);

255 ià(
	gpùx
 =ğ
nuÎ±r
) {

259 autØ
	gpùx_d
 = 
deãr
(
EVP_PKEY_CTX_ä“
, 
pùx
);

261 ià(
EVP_PKEY_d”ive_š™
(
pùx
) != 1) {

265 ià(
EVP_PKEY_CTX_hkdf_mode
(
pùx
, 
EVP_PKEY_HKDEF_MODE_EXPAND_ONLY
) != 1) {

269 ià(
EVP_PKEY_CTX_£t_hkdf_md
(
pùx
, 
ùx
.
´f
) != 1) {

273 ià(
EVP_PKEY_CTX_£t1_hkdf_§É
(
pùx
, "", 0) != 1) {

277 ià(
EVP_PKEY_CTX_£t1_hkdf_key
(
pùx
, 
£ü‘
, 
£ü‘Ën
) != 1) {

281 ià(
EVP_PKEY_CTX_add1_hkdf_šfo
(
pùx
, 
šfo
, 
šfŞ’
) != 1) {

285 ià(
EVP_PKEY_d”ive
(
pùx
, 
de¡
, &
de¡Ën
) != 1) {

292 
hkdf_exŒaù
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
£ü‘
,

293 
size_t
 
£ü‘Ën
, cÚ¡ 
ušt8_t
 *
§É
, size_ˆ
§ÉËn
,

294 cÚ¡ 
CÚ‹xt
 &
ùx
) {

295 autØ
	gpùx
 = 
EVP_PKEY_CTX_Ãw_id
(
EVP_PKEY_HKDF
, 
nuÎ±r
);

296 ià(
	gpùx
 =ğ
nuÎ±r
) {

300 autØ
	gpùx_d
 = 
deãr
(
EVP_PKEY_CTX_ä“
, 
pùx
);

302 ià(
EVP_PKEY_d”ive_š™
(
pùx
) != 1) {

306 ià(
EVP_PKEY_CTX_hkdf_mode
(
pùx
, 
EVP_PKEY_HKDEF_MODE_EXTRACT_ONLY
) != 1) {

310 ià(
EVP_PKEY_CTX_£t_hkdf_md
(
pùx
, 
ùx
.
´f
) != 1) {

314 ià(
EVP_PKEY_CTX_£t1_hkdf_§É
(
pùx
, 
§É
, 
§ÉËn
) != 1) {

318 ià(
EVP_PKEY_CTX_£t1_hkdf_key
(
pùx
, 
£ü‘
, 
£ü‘Ën
) != 1) {

322 ià(
EVP_PKEY_d”ive
(
pùx
, 
de¡
, &
de¡Ën
) != 1) {

329 
´f_sha256
(
CÚ‹xt
 &
ùx
è{ 
	gùx
.
	g´f
 = 
EVP_sha256
(); }

331 
«ad_«s_128_gcm
(
CÚ‹xt
 &
ùx
) {

332 
	gùx
.
	g«ad
 = 
EVP_«s_128_gcm
();

333 
	gùx
.
	ghp
 = 
EVP_«s_128_ùr
();

336 
mes§ge_dige¡
(
ušt8_t
 *
»s
, cÚ¡ 
EVP_MD
 *
m‘h
, cÚ¡ ušt8_ˆ*
d©a
,

337 
size_t
 
Ën
) {

338 
	grv
;

340 autØ
	gùx
 = 
EVP_MD_CTX_Ãw
();

341 ià(
	gùx
 =ğ
nuÎ±r
) {

345 autØ
	gùx_d–‘”
 = 
deãr
(
EVP_MD_CTX_ä“
, 
ùx
);

347 
	grv
 = 
EVP_Dige¡In™_ex
(
ùx
, 
m‘h
, 
nuÎ±r
);

348 ià(
	grv
 != 1) {

352 
	grv
 = 
EVP_Dige¡Upd©e
(
ùx
, 
d©a
, 
Ën
);

353 ià(
	grv
 != 1) {

357 
	gmdËn
 = 
EVP_MD_size
(
m‘h
);

359 
	grv
 = 
EVP_Dige¡Fš®_ex
(
ùx
, 
»s
, &
mdËn
);

360 ià(
	grv
 != 1) {

	@examples/debug.cc

25 
	~"debug.h
"

27 
	~<¿ndom
>

28 
	~<io¡»am
>

30 
	~"ut.h
"

32 
Çme¥aû
 
	gngtı2
 {

34 
Çme¥aû
 
	gdebug
 {

36 
	gÇme¥aû
 {

37 autØ
	g¿ndg’
 = 
ut
::
make_mt19937
();

40 
	gÇme¥aû
 {

41 autØ
	gcŞÜ_ouut
 = 
çl£
;

44 
£t_cŞÜ_ouut
(
boŞ
 
f
è{ 
	gcŞÜ_ouut
 = f; }

46 
	gÇme¥aû
 {

47 autØ*
	goutfe
 = 
¡d”r
;

50 
hªdshake_com¶‘ed
(
ngtı2_cÚn
 *
cÚn
, *
u£r_d©a
) {

51 
årštf
(
outfe
, "QUIC handshake has completed\n");

55 
boŞ
 
·ck‘_lo¡
(
´ob
) {

56 autØ
	gp
 = 
¡d
::
unifÜm_»®_di¡ributiÚ
<>(0, 1)(
	g¿ndg’
);

57  
	gp
 < 
	g´ob
;

60 
´št_üy±o_d©a
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
) {

61 
årštf
(
outfe
, "Ordered CRYPTO data\n");

62 
	gut
::
hexdump
(
outfe
, 
d©a
, 
d©®’
);

65 
´št_¡»am_d©a
(
ušt64_t
 
¡»am_id
, cÚ¡ 
ušt8_t
 *
d©a
,

66 
size_t
 
d©®’
) {

67 
årštf
(
outfe
, "Ord”ed STREAM d©¨¡»am_id=0x%" 
PRIx64
 "\n", 
¡»am_id
);

68 
	gut
::
hexdump
(
outfe
, 
d©a
, 
d©®’
);

71 
´št_š™Ÿl_£ü‘
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
) {

72 
årštf
(
outfe
, "š™Ÿl_£ü‘=%s\n", 
ut
::
fÜm©_hex
(
d©a
, 
Ën
).
c_¡r
());

75 
´št_ş›Á_š_£ü‘
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
) {

76 
årštf
(
outfe
, "client_in_secret=%s\n",

77 
ut
::
fÜm©_hex
(
d©a
, 
Ën
).
c_¡r
());

80 
´št_£rv”_š_£ü‘
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
) {

81 
årštf
(
outfe
, "server_in_secret=%s\n",

82 
ut
::
fÜm©_hex
(
d©a
, 
Ën
).
c_¡r
());

85 
´št_hªdshake_£ü‘
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
) {

86 
årštf
(
outfe
, "handshake_secret=%s\n",

87 
ut
::
fÜm©_hex
(
d©a
, 
Ën
).
c_¡r
());

90 
´št_ş›Á_hs_£ü‘
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
) {

91 
årštf
(
outfe
, "client_hs_secret=%s\n",

92 
ut
::
fÜm©_hex
(
d©a
, 
Ën
).
c_¡r
());

95 
´št_£rv”_hs_£ü‘
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
) {

96 
årštf
(
outfe
, "server_hs_secret=%s\n",

97 
ut
::
fÜm©_hex
(
d©a
, 
Ën
).
c_¡r
());

100 
´št_ş›Á_0¹t_£ü‘
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
) {

101 
årštf
(
outfe
, "client_0rtt_secret=%s\n",

102 
ut
::
fÜm©_hex
(
d©a
, 
Ën
).
c_¡r
());

105 
´št_ş›Á_1¹t_£ü‘
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
) {

106 
årštf
(
outfe
, "client_1rtt_secret=%s\n",

107 
ut
::
fÜm©_hex
(
d©a
, 
Ën
).
c_¡r
());

110 
´št_£rv”_1¹t_£ü‘
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
) {

111 
årštf
(
outfe
, "server_1rtt_secret=%s\n",

112 
ut
::
fÜm©_hex
(
d©a
, 
Ën
).
c_¡r
());

115 
´št_ş›Á_µ_key
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
) {

116 
årštf
(
outfe
, "+ cl›Á_µ_key=%s\n", 
ut
::
fÜm©_hex
(
d©a
, 
Ën
).
c_¡r
());

119 
´št_£rv”_µ_key
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
) {

120 
årštf
(
outfe
, "+ s”v”_µ_key=%s\n", 
ut
::
fÜm©_hex
(
d©a
, 
Ën
).
c_¡r
());

123 
´št_ş›Á_µ_iv
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
) {

124 
årštf
(
outfe
, "+ cl›Á_µ_iv=%s\n", 
ut
::
fÜm©_hex
(
d©a
, 
Ën
).
c_¡r
());

127 
´št_£rv”_µ_iv
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
) {

128 
årštf
(
outfe
, "+ s”v”_µ_iv=%s\n", 
ut
::
fÜm©_hex
(
d©a
, 
Ën
).
c_¡r
());

131 
´št_ş›Á_µ_hp
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
) {

132 
årštf
(
outfe
, "+ cl›Á_µ_hp=%s\n", 
ut
::
fÜm©_hex
(
d©a
, 
Ën
).
c_¡r
());

135 
´št_£rv”_µ_hp
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
) {

136 
årštf
(
outfe
, "+ s”v”_µ_hp=%s\n", 
ut
::
fÜm©_hex
(
d©a
, 
Ën
).
c_¡r
());

139 
´št_£ü‘s
(cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
, cÚ¡ ušt8_ˆ*
key
,

140 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
iv
, size_ˆ
ivËn
,

141 cÚ¡ 
ušt8_t
 *
hp
, 
size_t
 
h¶’
) {

142 
	g¡d
::
û¼
 << "+ seü‘=" << 
ut
::
fÜm©_hex
(
£ü‘
, 
£ü‘Ën
) << "\n"

143 << "+ key=" << 
	gut
::
fÜm©_hex
(
key
, 
keyËn
) << "\n"

144 << "+ iv=" << 
	gut
::
fÜm©_hex
(
iv
, 
ivËn
) << "\n"

145 << "+ hp=" << 
	gut
::
fÜm©_hex
(
hp
, 
h¶’
è<< 
	g¡d
::
’dl
;

148 
´št_£ü‘s
(cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
, cÚ¡ ušt8_ˆ*
key
,

149 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
iv
, size_ˆ
ivËn
) {

150 
	g¡d
::
û¼
 << "+ seü‘=" << 
ut
::
fÜm©_hex
(
£ü‘
, 
£ü‘Ën
) << "\n"

151 << "+ key=" << 
	gut
::
fÜm©_hex
(
key
, 
keyËn
) << "\n"

152 << "+ iv=" << 
	gut
::
fÜm©_hex
(
iv
, 
ivËn
è<< 
	g¡d
::
’dl
;

155 
´št_hp_mask
(cÚ¡ 
ušt8_t
 *
mask
, 
size_t
 
maskËn
, cÚ¡ ušt8_ˆ*
§m¶e
,

156 
size_t
 
§m¶–’
) {

157 
årštf
(
outfe
, "mask=%s sample=%s\n",

158 
ut
::
fÜm©_hex
(
mask
, 
maskËn
).
c_¡r
(),

159 
ut
::
fÜm©_hex
(
§m¶e
, 
§m¶–’
).
c_¡r
());

162 
log_´štf
(*
u£r_d©a
, cÚ¡ *
fmt
, ...) {

163 
va_li¡
 
	g­
;

165 
va_¡¬t
(
­
, 
fmt
);

166 
vårštf
(
¡d”r
, 
fmt
, 
­
);

167 
va_’d
(
­
);

170 
·th_v®id©iÚ
(cÚ¡ 
ngtı2_·th
 *
·th
,

171 
ngtı2_·th_v®id©iÚ_»suÉ
 
»s
) {

172 autØ
	gloÿl_addr
 = 
ut
::
¡¿ddr
(

173 
»š‹½»t_ÿ¡
<
sockaddr
 *>(
·th
->
loÿl
.
addr
),…©h->loÿl.
Ën
);

174 autØ
	g»mÙe_addr
 = 
ut
::
¡¿ddr
(

175 
»š‹½»t_ÿ¡
<
sockaddr
 *>(
·th
->
»mÙe
.
addr
),…©h->»mÙe.
Ën
);

177 
	g¡d
::
û¼
 << "P©h v®id©iÚ‡gaš¡…©h {loÿl:" << 
loÿl_addr


178 << ",„emÙe:" << 
»mÙe_addr
 << "} "

179 << (
»s
 =ğ
NGTCP2_PATH_VALIDATION_RESULT_SUCCESS
 ? "succeeded"

181 << 
¡d
::
’dl
;

	@examples/debug.h

25 #iâdeà
DEBUG_H


26 
	#DEBUG_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

33 
	#__STDC_FORMAT_MACROS


	)

34 
	~<cš‰y³s
>

36 
	~<chrÚo
>

38 
	~<ngtı2/ngtı2.h
>

40 
Çme¥aû
 
	gngtı2
 {

42 
Çme¥aû
 
	gdebug
 {

44 
£t_cŞÜ_ouut
(
boŞ
 
f
);

46 
hªdshake_com¶‘ed
(
ngtı2_cÚn
 *
cÚn
, *
u£r_d©a
);

48 
boŞ
 
·ck‘_lo¡
(
´ob
);

50 
´št_üy±o_d©a
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
);

52 
´št_¡»am_d©a
(
ušt64_t
 
¡»am_id
, cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
);

54 
´št_š™Ÿl_£ü‘
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
);

56 
´št_ş›Á_š_£ü‘
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
);

57 
´št_£rv”_š_£ü‘
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
);

59 
´št_hªdshake_£ü‘
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
);

61 
´št_ş›Á_hs_£ü‘
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
);

62 
´št_£rv”_hs_£ü‘
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
);

64 
´št_ş›Á_0¹t_£ü‘
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
);

66 
´št_ş›Á_1¹t_£ü‘
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
);

67 
´št_£rv”_1¹t_£ü‘
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
);

69 
´št_ş›Á_µ_key
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
);

70 
´št_£rv”_µ_key
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
);

72 
´št_ş›Á_µ_iv
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
);

73 
´št_£rv”_µ_iv
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
);

75 
´št_ş›Á_µ_hp
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
);

76 
´št_£rv”_µ_hp
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
);

78 
´št_£ü‘s
(cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
, cÚ¡ ušt8_ˆ*
key
,

79 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
iv
, size_ˆ
ivËn
,

80 cÚ¡ 
ušt8_t
 *
hp
, 
size_t
 
h¶’
);

82 
´št_£ü‘s
(cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
, cÚ¡ ušt8_ˆ*
key
,

83 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
iv
, size_ˆ
ivËn
);

85 
´št_hp_mask
(cÚ¡ 
ušt8_t
 *
mask
, 
size_t
 
maskËn
, cÚ¡ ušt8_ˆ*
§m¶e
,

86 
size_t
 
§m¶–’
);

88 
log_´štf
(*
u£r_d©a
, cÚ¡ *
fmt
, ...);

90 
·th_v®id©iÚ
(cÚ¡ 
ngtı2_·th
 *
·th
,

91 
ngtı2_·th_v®id©iÚ_»suÉ
 
»s
);

	@examples/examplestest.cc

26 #ifdeà
HAVE_CONFIG_H


27 
	~<cÚfig.h
>

30 
	~<¡dio.h
>

31 
	~<¡ršg.h
>

32 
	~<CUn™/Basic.h
>

34 
	~"ut_‹¡.h
"

36 
	$š™_su™e1
(è{  0; 
	}
}

38 
	$ş—n_su™e1
(è{  0; 
	}
}

40 
	$maš
(
¬gc
, *
¬gv
[]) {

41 
CU_pSu™e
 
pSu™e
 = 
NULL
;

42 
num_‹¡s_çed
;

45 ià(
CUE_SUCCESS
 !ğ
	`CU_š™Ÿlize_»gi¡ry
())

46  
	`CU_g‘_”rÜ
();

49 
pSu™e
 = 
	`CU_add_su™e
("Te¡Su™e", 
š™_su™e1
, 
ş—n_su™e1
);

50 ià(
NULL
 =ğ
pSu™e
) {

51 
	`CU_ş—nup_»gi¡ry
();

52  
	`CU_g‘_”rÜ
();

56 ià(!
	`CU_add_‹¡
(
pSu™e
, "util_format_duration",

57 
ngtı2
::
‹¡_ut_fÜm©_du¿tiÚ
)) {

58 
	`CU_ş—nup_»gi¡ry
();

59  
	`CU_g‘_”rÜ
();

63 
	`CU_basic_£t_mode
(
CU_BRM_VERBOSE
);

64 
	`CU_basic_run_‹¡s
();

65 
num_‹¡s_çed
 = 
	`CU_g‘_numb”_of_‹¡s_çed
();

66 
	`CU_ş—nup_»gi¡ry
();

67 ià(
	`CU_g‘_”rÜ
(è=ğ
CUE_SUCCESS
) {

68  
num_‹¡s_çed
;

70 
	`´štf
("CUn™ E¼Ü: %s\n", 
	`CU_g‘_”rÜ_msg
());

71  
	`CU_g‘_”rÜ
();

73 
	}
}

	@examples/http.cc

26 
	~"h‰p.h
"

28 
Çme¥aû
 
	gngtı2
 {

30 
Çme¥aû
 
	gh‰p
 {

32 
	g¡d
::
¡ršg
 
g‘_»asÚ_ph¿£
(
¡©us_code
) {

33 
¡©us_code
) {

	@examples/http.h

25 #iâdeà
HTTP_H


26 
	#HTTP_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<¡ršg
>

34 
Çme¥aû
 
	gngtı2
 {

36 
Çme¥aû
 
	gh‰p
 {

38 
	g¡d
::
¡ršg
 
g‘_»asÚ_ph¿£
(
¡©us_code
);

	@examples/keylog.cc

25 
	~<¡ršg
>

27 
	~"keylog.h
"

28 
	~"ut.h
"

30 
Çme¥aû
 
	gngtı2
 {

32 
Çme¥aû
 
	gkeylog
 {

34 
log_£ü‘
(
SSL
 *
s¦
, 
Çme
, cÚ¡ *
£ü‘
,

35 
size_t
 
£ü‘Ën
) {

36 ià×utØ
	gkeylog_cb
 = 
SSL_CTX_g‘_keylog_ÿÎback
(
SSL_g‘_SSL_CTX
(
s¦
))) {

37 
üªdom
[32];

38 ià(
SSL_g‘_ş›Á_¿ndom
(
s¦
, 
üªdom
, 32) != 32) {

41 
	g¡d
::
¡ršg
 
lše
;

42 
	gÇme
) {

43 
	gSSL_KEY_CLIENT_EARLY_TRAFFIC
:

44 
lše
 = "QUIC_CLIENT_EARLY_TRAFFIC_SECRET";

46 
	gSSL_KEY_CLIENT_HANDSHAKE_TRAFFIC
:

47 
lše
 = "QUIC_CLIENT_HANDSHAKE_TRAFFIC_SECRET";

49 
	gSSL_KEY_CLIENT_APPLICATION_TRAFFIC
:

50 
lše
 = "QUIC_CLIENT_TRAFFIC_SECRET_0";

52 
	gSSL_KEY_SERVER_HANDSHAKE_TRAFFIC
:

53 
lše
 = "QUIC_SERVER_HANDSHAKE_TRAFFIC_SECRET";

55 
	gSSL_KEY_SERVER_APPLICATION_TRAFFIC
:

56 
lše
 = "QUIC_SERVER_TRAFFIC_SECRET_0";

61 
	glše
 +ğ" " + 
ut
::
fÜm©_hex
(
üªdom
, 32);

62 
	glše
 +ğ" " + 
ut
::
fÜm©_hex
(
£ü‘
, 
£ü‘Ën
);

63 
keylog_cb
(
s¦
, 
lše
.
c_¡r
());

	@examples/keylog.h

25 #iâdeà
KEYLOG_H


26 
	#KEYLOG_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

34 
	~<İ’s¦/s¦.h
>

36 
Çme¥aû
 
	gngtı2
 {

38 
Çme¥aû
 
	gkeylog
 {

40 
log_£ü‘
(
SSL
 *
s¦
, 
Çme
, cÚ¡ *
£ü‘
,

41 
size_t
 
£ü‘Ën
);

	@examples/network.h

26 #iâdeà
NETWORK_H


27 
	#NETWORK_H


	)

29 #ifdeà
HAVE_CONFIG_H


30 
	~<cÚfig.h
>

33 
	~<sys/ty³s.h
>

34 #ifdeà
HAVE_SYS_SOCKET_H


35 
	~<sys/sock‘.h
>

37 
	~<sys/un.h
>

38 #ifdeà
HAVE_NETINET_IN_H


39 
	~<Ãtš‘/š.h
>

41 #ifdeà
HAVE_ARPA_INET_H


42 
	~<¬·/š‘.h
>

45 
	~<¬¿y
>

47 
Çme¥aû
 
	gngtı2
 {

49 
	eÃtwÜk_”rÜ
 {

50 
	gNETWORK_ERR_OK
 = 0,

51 
	gNETWORK_ERR_SEND_FATAL
 = -10,

52 
	gNETWORK_ERR_SEND_NON_FATAL
 = -11,

53 
	gNETWORK_ERR_CLOSE_WAIT
 = -12,

56 
	usockaddr_uniÚ
 {

57 
sockaddr_¡Üage
 
	g¡Üage
;

58 
sockaddr
 
	g§
;

59 
sockaddr_š6
 
	gš6
;

60 
sockaddr_š
 
	gš
;

63 
	sAdd»ss
 {

64 
sockËn_t
 
	gËn
;

65 
sockaddr_uniÚ
 
	gsu
;

68 
	sP©hStÜage
 {

69 
P©hStÜage
() {

70 
	g·th
.
	gloÿl
.
	gaddr
 = 
loÿl_addrbuf
.
d©a
();

71 
	g·th
.
	g»mÙe
.
	gaddr
 = 
»mÙe_addrbuf
.
d©a
();

74 
ngtı2_·th
 
	g·th
;

75 
	g¡d
::
¬¿y
<
ušt8_t
, (
	gsockaddr_¡Üage
)> 
	gloÿl_addrbuf
;

76 
	g¡d
::
¬¿y
<
ušt8_t
, (
	gsockaddr_¡Üage
)> 
	g»mÙe_addrbuf
;

	@examples/server.cc

25 
	~<c¡dlib
>

26 
	~<ÿs£¹
>

27 
	~<io¡»am
>

28 
	~<®gÜ™hm
>

29 
	~<memÜy
>

30 
	~<f¡»am
>

32 
	~<uni¡d.h
>

33 
	~<g‘İt.h
>

34 
	~<sys/ty³s.h
>

35 
	~<sys/sock‘.h
>

36 
	~<Ãtdb.h
>

37 
	~<sys/¡©.h
>

38 
	~<fú.h
>

39 
	~<sys/mmª.h
>

41 
	~<İ’s¦/bio.h
>

42 
	~<İ’s¦/”r.h
>

44 
	~"£rv”.h
"

45 
	~"ÃtwÜk.h
"

46 
	~"debug.h
"

47 
	~"ut.h
"

48 
	~"üy±o.h
"

49 
	~"sh¬ed.h
"

50 
	~"h‰p.h
"

51 
	~"keylog.h
"

53 
usšg
 
Çme¥aû
 
	gngtı2
;

55 
	gÇme¥aû
 {

56 
cÚ¡ex´
 
size_t
 
	gNGTCP2_SV_SCIDLEN
 = 18;

59 
	gÇme¥aû
 {

60 
cÚ¡ex´
 
size_t
 
	gTOKEN_RAND_DATALEN
 = 16;

63 
	gÇme¥aû
 {

64 autØ
	g¿ndg’
 = 
ut
::
make_mt19937
();

67 
	gÇme¥aû
 {

68 
CÚfig
 
	gcÚfig
{};

71 
	gBufãr
::
	$Bufãr
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
)

72 : 
buf
{
d©a
, d©¨+ 
d©®’
},

73 
begš
(
buf
.
d©a
()),

74 
h—d
(
begš
),

75 

(
begš
 + 
d©®’
) {}

76 
	gBufãr
::
	$Bufãr
(
ušt8_t
 *
begš
, ušt8_ˆ*
’d
)

77 : 
	`begš
(
begš
), 
	`h—d
(begš), 
	$
(
’d
è{
	}
}

78 
	gBufãr
::
	$Bufãr
(
size_t
 
d©®’
)

79 : 
	`buf
(
d©®’
), 
	`begš
(
buf
.
	`d©a
()), 
	`h—d
(
begš
), 
	$
(
begš
è{
	}
}

80 
	gBufãr
::
	$Bufãr
(è: 
	`begš
(
buf
.
	`d©a
()), 
	`h—d
(
begš
), 
	$
(
begš
è{
	}
}

82 
	gÇme¥aû
 {

83 
key_cb
(
SSL
 *
s¦
, 
Çme
, cÚ¡ *
£ü‘
, 
size_t
 
£ü‘Ën
,

84 *
¬g
) {

85 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
¬g
);

87 ià(
	gh
->
Ú_key
(
Çme
, 
£ü‘
, 
£ü‘Ën
) != 0) {

91 
	gkeylog
::
log_£ü‘
(
s¦
, 
Çme
, 
£ü‘
, 
£ü‘Ën
);

97 
	gHªdËr
::
	$Ú_key
(
Çme
, cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
) {

98 
rv
;

100 
Çme
) {

101 
SSL_KEY_CLIENT_EARLY_TRAFFIC
:

102 
SSL_KEY_CLIENT_HANDSHAKE_TRAFFIC
:

103 
SSL_KEY_SERVER_HANDSHAKE_TRAFFIC
:

105 
SSL_KEY_CLIENT_APPLICATION_TRAFFIC
:

106 
rx_£ü‘_
.
	`assign
(
£ü‘
, seü‘ + 
£ü‘Ën
);

108 
SSL_KEY_SERVER_APPLICATION_TRAFFIC
:

109 
tx_£ü‘_
.
	`assign
(
£ü‘
, seü‘ + 
£ü‘Ën
);

116 
rv
 = 
üy±o
::
	`ÃgÙŸ‹d_´f
(
üy±o_ùx_
, 
s¦_
);

117 ià(
rv
 != 0) {

120 
rv
 = 
üy±o
::
	`ÃgÙŸ‹d_«ad
(
üy±o_ùx_
, 
s¦_
);

121 ià(
rv
 != 0) {

125 
¡d
::
¬¿y
<
ušt8_t
, 64> 
key
, 
iv
, 
hp
;

126 autØ
keyËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_key
(

127 
key
.
	`d©a
(), key.
	`size
(), 
£ü‘
, 
£ü‘Ën
, 
üy±o_ùx_
);

128 ià(
keyËn
 < 0) {

132 autØ
ivËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_iv
(
iv
.
	`d©a
(), iv.
	`size
(), 
£ü‘
,

133 
£ü‘Ën
, 
üy±o_ùx_
);

134 ià(
ivËn
 < 0) {

138 autØ
h¶’
 = 
üy±o
::
	`d”ive_h—d”_´ÙeùiÚ_key
(

139 
hp
.
	`d©a
(), hp.
	`size
(), 
£ü‘
, 
£ü‘Ën
, 
üy±o_ùx_
);

140 ià(
h¶’
 < 0) {

145 
	`ngtı2_cÚn_£t_«ad_ov”h—d
(
cÚn_
, 
üy±o
::
	`«ad_max_ov”h—d
(
üy±o_ùx_
));

147 
Çme
) {

148 
SSL_KEY_CLIENT_EARLY_TRAFFIC
:

149 ià(!
cÚfig
.
qu›t
) {

150 
¡d
::
û¼
 << "ş›Á_—¾y_Œaffic" << std::
’dl
;

152 
	`ngtı2_cÚn_š¡®l_—¾y_keys
(
cÚn_
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.d©a(), 
ivËn
,

153 
hp
.
	`d©a
(), 
h¶’
);

155 
SSL_KEY_CLIENT_HANDSHAKE_TRAFFIC
:

156 ià(!
cÚfig
.
qu›t
) {

157 
¡d
::
û¼
 << "ş›Á_hªdshake_Œaffic" << std::
’dl
;

159 
	`ngtı2_cÚn_š¡®l_hªdshake_rx_keys
(
cÚn_
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.data(),

160 
ivËn
, 
hp
.
	`d©a
(), 
h¶’
);

162 
SSL_KEY_CLIENT_APPLICATION_TRAFFIC
:

163 ià(!
cÚfig
.
qu›t
) {

164 
¡d
::
û¼
 << "ş›Á_­¶iÿtiÚ_Œaffic" << std::
’dl
;

166 
	`ngtı2_cÚn_š¡®l_rx_keys
(
cÚn_
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.d©a(), 
ivËn
,

167 
hp
.
	`d©a
(), 
h¶’
);

169 
SSL_KEY_SERVER_HANDSHAKE_TRAFFIC
:

170 ià(!
cÚfig
.
qu›t
) {

171 
¡d
::
û¼
 << "£rv”_hªdshake_Œaffic" << std::
’dl
;

173 
	`ngtı2_cÚn_š¡®l_hªdshake_tx_keys
(
cÚn_
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.data(),

174 
ivËn
, 
hp
.
	`d©a
(), 
h¶’
);

176 
SSL_KEY_SERVER_APPLICATION_TRAFFIC
:

177 ià(!
cÚfig
.
qu›t
) {

178 
¡d
::
û¼
 << "£rv”_­¶iÿtiÚ_Œaffic" << std::
’dl
;

180 
	`ngtı2_cÚn_š¡®l_tx_keys
(
cÚn_
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.d©a(), 
ivËn
,

181 
hp
.
	`d©a
(), 
h¶’
);

185 ià(!
cÚfig
.
qu›t
) {

186 
debug
::
	`´št_£ü‘s
(
£ü‘
, 
£ü‘Ën
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.data(),

187 
ivËn
, 
hp
.
	`d©a
(), 
h¶’
);

191 
	}
}

193 
	gÇme¥aû
 {

194 
msg_cb
(
wr™e_p
, 
v”siÚ
, 
cÚ‹Á_ty³
, cÚ¡ *
buf
,

195 
size_t
 
Ën
, 
SSL
 *
s¦
, *
¬g
) {

196 
	grv
;

198 ià(!
	gcÚfig
.
	gqu›t
) {

199 
	g¡d
::
û¼
 << "msg_cb: wr™e_p=" << 
wr™e_p
 << " v”siÚ=" << 
v”siÚ


200 << " cÚ‹Á_ty³=" << 
cÚ‹Á_ty³
 << "†’=" << 
Ën


201 << 
¡d
::
’dl
;

204 ià(!
	gwr™e_p
) {

208 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
¬g
);

209 autØ
	gmsg
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
buf
);

211 
	gcÚ‹Á_ty³
) {

212 
	gSSL3_RT_HANDSHAKE
:

214 
	gSSL3_RT_ALERT
:

215 
as£¹
(
Ën
 == 2);

216 ià(
	gmsg
[0] != 2 ) {

219 
	gh
->
£t_s_®”t
(
msg
[1]);

225 
	grv
 = 
h
->
wr™e_£rv”_hªdshake
(
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
buf
), 
Ën
);

227 
as£¹
(0 =ğ
rv
);

231 
	gÇme¥aû
 {

232 
bio_wr™e
(
BIO
 *
b
, cÚ¡ *
buf
, 
Ën
) {

233 
as£¹
(0);

238 
	gÇme¥aû
 {

239 
bio_»ad
(
BIO
 *
b
, *
buf
, 
Ën
) {

240 
BIO_ş—r_»Œy_æags
(
b
);

242 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
BIO_g‘_d©a
(
b
));

244 
	gËn
 = 
h
->
»ad_ş›Á_hªdshake
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
buf
), 
Ën
);

245 ià(
	gËn
 == 0) {

246 
BIO_£t_»Œy_»ad
(
b
);

250  
	gËn
;

254 
	gÇme¥aû
 {

255 
bio_puts
(
BIO
 *
b
, cÚ¡ *
¡r
è{  
bio_wr™e
(b, sŒ, 
¡¾’
(str)); }

258 
	gÇme¥aû
 {

259 
bio_g‘s
(
BIO
 *
b
, *
buf
, 
Ën
) {  -1; }

262 
	gÇme¥aû
 {

263 
bio_ù¾
(
BIO
 *
b
, 
cmd
, 
num
, *
±r
) {

264 
	gcmd
) {

265 
	gBIO_CTRL_FLUSH
:

273 
	gÇme¥aû
 {

274 
bio_ü—‹
(
BIO
 *
b
) {

275 
BIO_£t_š™
(
b
, 1);

280 
	gÇme¥aû
 {

281 
bio_de¡roy
(
BIO
 *
b
) {

282 ià(
	gb
 =ğ
nuÎ±r
) {

290 
	gÇme¥aû
 {

291 
BIO_METHOD
 *
ü—‹_bio_m‘hod
() {

292 autØ
	gm‘h
 = 
BIO_m‘h_Ãw
(
BIO_TYPE_FD
, "bio");

293 
BIO_m‘h_£t_wr™e
(
m‘h
, 
bio_wr™e
);

294 
BIO_m‘h_£t_»ad
(
m‘h
, 
bio_»ad
);

295 
BIO_m‘h_£t_puts
(
m‘h
, 
bio_puts
);

296 
BIO_m‘h_£t_g‘s
(
m‘h
, 
bio_g‘s
);

297 
BIO_m‘h_£t_ù¾
(
m‘h
, 
bio_ù¾
);

298 
BIO_m‘h_£t_ü—‹
(
m‘h
, 
bio_ü—‹
);

299 
BIO_m‘h_£t_de¡roy
(
m‘h
, 
bio_de¡roy
);

300  
	gm‘h
;

304 
	gÇme¥aû
 {

305 
Ú_msg_begš
(
h‰p_·r£r
 *
h
) {

306 autØ
	gs
 = 
¡©ic_ÿ¡
<
SŒ—m
 *>(
h
->
d©a
);

307 ià(
	gs
->
	g»¥_¡©e
 !ğ
RESP_IDLE
) {

314 
	gÇme¥aû
 {

315 
Ú_u¾_cb
(
h‰p_·r£r
 *
h
, cÚ¡ *
d©a
, 
size_t
 
d©®’
) {

316 autØ
	gs
 = 
¡©ic_ÿ¡
<
SŒ—m
 *>(
h
->
d©a
);

317 
	gs
->
	guri
.
­³nd
(
d©a
, 
d©®’
);

322 
	gÇme¥aû
 {

323 
Ú_h—d”_f›ld
(
h‰p_·r£r
 *
h
, cÚ¡ *
d©a
, 
size_t
 
d©®’
) {

324 autØ
	gs
 = 
¡©ic_ÿ¡
<
SŒ—m
 *>(
h
->
d©a
);

325 ià(
	gs
->
	g´ev_hdr_key
) {

326 
	gs
->
	ghdrs
.
back
().
	gfœ¡
.
­³nd
(
d©a
, 
d©®’
);

328 
	gs
->
	g´ev_hdr_key
 = 
Œue
;

329 
	gs
->
	ghdrs
.
em¶aû_back
(
¡d
::
¡ršg
(
d©a
, 
d©®’
), "");

335 
	gÇme¥aû
 {

336 
Ú_h—d”_v®ue
(
h‰p_·r£r
 *
h
, cÚ¡ *
d©a
, 
size_t
 
d©®’
) {

337 autØ
	gs
 = 
¡©ic_ÿ¡
<
SŒ—m
 *>(
h
->
d©a
);

338 
	gs
->
	g´ev_hdr_key
 = 
çl£
;

339 
	gs
->
	ghdrs
.
back
().
	g£cÚd
.
­³nd
(
d©a
, 
d©®’
);

344 
	gÇme¥aû
 {

345 
Ú_h—d”s_com¶‘e
(
h‰p_·r£r
 *
h
) {

346 autØ
	gs
 = 
¡©ic_ÿ¡
<
SŒ—m
 *>(
h
->
d©a
);

347 ià(
	gs
->
¡¬t_»¥Ú£
() != 0) {

354 autØ
	gh_£‰šgs
 = 
h‰p_·r£r_£‰šgs
{

355 
Ú_msg_begš
,

356 
Ú_u¾_cb
,

357 
nuÎ±r
,

358 
Ú_h—d”_f›ld
,

359 
Ú_h—d”_v®ue
,

360 
Ú_h—d”s_com¶‘e
,

361 
nuÎ±r
,

362 
nuÎ±r
,

363 
nuÎ±r
,

364 
nuÎ±r
,

367 
	gSŒ—m
::
	$SŒ—m
(
ušt64_t
 
¡»am_id
)

368 : 
	`¡»am_id
(
¡»am_id
),

369 
	`¡»ambuf_idx
(0),

370 
	`tx_¡»am_off£t
(0),

371 
	`should_£nd_fš
(
çl£
),

372 
	`»¥_¡©e
(
RESP_IDLE
),

373 
	`h‰p_majÜ
(0),

374 
	`h‰p_mšÜ
(0),

375 
	`´ev_hdr_key
(
çl£
),

376 
	`fd
(-1),

377 
	`d©a
(
nuÎ±r
),

378 
	$d©®’
(0) {

379 
	`h‰p_·r£r_š™
(&
h
, 
HTTP_REQUEST
);

380 
h
.
d©a
 = 
this
;

381 
	}
}

383 
	gSŒ—m
::~
	$SŒ—m
() {

384 
	`munm­
(
d©a
, 
d©®’
);

385 ià(
fd
 != -1) {

386 
	`şo£
(
fd
);

388 
	}
}

390 
	gSŒ—m
::
	$»cv_d©a
(
ušt8_t
 
fš
, cÚ¡ ušt8_ˆ*
d©a
, 
size_t
 
d©®’
) {

391 autØ
Ä—d
 = 
	`h‰p_·r£r_execu‹
(

392 &
h
, &
h_£‰šgs
, 
»š‹½»t_ÿ¡
<cÚ¡ *>(
d©a
), 
d©®’
);

393 ià(
Ä—d
 !ğ
d©®’
) {

398 
	}
}

400 
	gÇme¥aû
 {

401 
cÚ¡ex´
 
	gNGTCP2_SERVER
[] = "ngtcp2";

404 
	gÇme¥aû
 {

405 
	g¡d
::
¡ršg
 
make_¡©us_body
(
¡©us_code
) {

406 autØ
¡©us_¡ršg
 = 
¡d
::
to_¡ršg
(
¡©us_code
);

407 autØ
	g»asÚ_ph¿£
 = 
h‰p
::
g‘_»asÚ_ph¿£
(
¡©us_code
);

409 
	g¡d
::
¡ršg
 
body
;

410 
	gbody
 = "<html><head><title>";

411 
	gbody
 +ğ
¡©us_¡ršg
;

412 
	gbody
 += ' ';

413 
	gbody
 +ğ
»asÚ_ph¿£
;

414 
	gbody
 += "</title></head><body><h1>";

415 
	gbody
 +ğ
¡©us_¡ršg
;

416 
	gbody
 += ' ';

417 
	gbody
 +ğ
»asÚ_ph¿£
;

418 
	gbody
 += "</h1><hr><address>";

419 
	gbody
 +ğ
NGTCP2_SERVER
;

420 
	gbody
 += "‡t…ort ";

421 
	gbody
 +ğ
¡d
::
to_¡ršg
(
cÚfig
.
pÜt
);

422 
	gbody
 += "</address>";

423 
	gbody
 += "</body></html>";

424  
	gbody
;

428 
	gÇme¥aû
 {

429 
	g¡d
::
¡ršg
 
»que¡_·th
(cÚ¡ 
¡d
::¡ršg &
uri
, 
boŞ
 
is_cÚÃù
) {

430 
h‰p_·r£r_u¾
 
	gu
;

432 
h‰p_·r£r_u¾_š™
(&
u
);

434 autØ
	grv
 = 
h‰p_·r£r_·r£_u¾
(
uri
.
c_¡r
(), uri.
size
(), 
is_cÚÃù
, &
u
);

435 ià(
	grv
 != 0) {

439 ià(
	gu
.
	gf›ld_£t
 & (1 << 
	gUF_PATH
)) {

441 autØ
	g»q_·th
 = 
¡d
::
¡ršg
(
uri
.
c_¡r
(è+ 
u
.
f›ld_d©a
[
UF_PATH
].
off
,

442 
u
.
f›ld_d©a
[
UF_PATH
].
Ën
);

443 ià(!
	g»q_·th
.
em±y
(è&&„eq_·th.
back
() == '/') {

444 
»q_·th
 += "index.html";

446  
	g»q_·th
;

453 
	gÇme¥aû
 {

454 
	g¡d
::
¡ršg
 
»sŞve_·th
(cÚ¡ 
¡d
::¡ršg &
»q_·th
) {

455 autØ
¿w_·th
 = 
cÚfig
.
htdocs
 + 
»q_·th
;

456 autØ
	gm®loûd_·th
 = 
»®·th
(
¿w_·th
.
c_¡r
(), 
nuÎ±r
);

457 ià(
	gm®loûd_·th
 =ğ
nuÎ±r
) {

460 autØ
	g·th
 = 
¡d
::
¡ršg
(
m®loûd_·th
);

461 
ä“
(
m®loûd_·th
);

463 ià(
	g·th
.
size
(è< 
	gcÚfig
.
	ghtdocs
.size() ||

464 !
	g¡d
::
equ®
(
¡d
::
begš
(
cÚfig
.
htdocs
), std::
’d
(config.htdocs),

465 
¡d
::
begš
(
·th
))) {

468  
	g·th
;

472 
	gSŒ—m
::
	$İ’_fe
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

473 
fd
 = 
	`İ’
(
·th
.
	`c_¡r
(), 
O_RDONLY
);

474 ià(
fd
 == -1) {

479 
	}
}

481 
	gSŒ—m
::
	$m­_fe
(
size_t
 
Ën
) {

482 ià(
Ën
 == 0) {

485 
d©a
 =

486 
¡©ic_ÿ¡
<
ušt8_t
 *>(
	`mm­
(
nuÎ±r
, 
Ën
, 
PROT_READ
, 
MAP_SHARED
, 
fd
, 0));

487 ià(
d©a
 =ğ
MAP_FAILED
) {

488 
¡d
::
û¼
 << "mm­: " << 
	`¡»¼Ü
(
”ºo
è<< std::
’dl
;

491 
d©®’
 = 
Ën
;

493 
	}
}

495 
	gSŒ—m
::
	$bufãr_fe
() {

496 
¡»ambuf
.
	`em¶aû_back
(
d©a
, d©¨+ 
d©®’
);

497 
should_£nd_fš
 = 
Œue
;

498 
	}
}

500 
	gSŒ—m
::
	$£nd_¡©us_»¥Ú£
(
¡©us_code
,

501 cÚ¡ 
¡d
::
¡ršg
 &
exŒa_h—d”s
) {

502 autØ
body
 = 
	`make_¡©us_body
(
¡©us_code
);

503 
¡d
::
¡ršg
 
hdr
;

504 ià(
h‰p_majÜ
 >= 1) {

505 
hdr
 += "HTTP/";

506 
hdr
 +ğ
¡d
::
	`to_¡ršg
(
h‰p_majÜ
);

507 
hdr
 += '.';

508 
hdr
 +ğ
¡d
::
	`to_¡ršg
(
h‰p_mšÜ
);

509 
hdr
 += ' ';

510 
hdr
 +ğ
¡d
::
	`to_¡ršg
(
¡©us_code
);

511 
hdr
 += " ";

512 
hdr
 +ğ
h‰p
::
	`g‘_»asÚ_ph¿£
(
¡©us_code
);

513 
hdr
 += "\r\n";

514 
hdr
 += "Server: ";

515 
hdr
 +ğ
NGTCP2_SERVER
;

516 
hdr
 += "\r\n";

517 
hdr
 += "Content-Type:ext/html; charset=UTF-8\r\n";

518 
hdr
 += "Content-Length: ";

519 
hdr
 +ğ
¡d
::
	`to_¡ršg
(
body
.
	`size
());

520 
hdr
 += "\r\n";

521 
hdr
 +ğ
exŒa_h—d”s
;

522 
hdr
 += "\r\n";

525 autØ
v
 = 
Bufãr
{
hdr
.
	`size
(è+ ((
h
.
m‘hod
 =ğ
HTTP_HEAD
è? 0 : 
body
.size())};

526 autØ
p
 = 
¡d
::
	`begš
(
v
.
buf
);

527 
p
 = 
¡d
::
	`cİy
(¡d::
	`begš
(
hdr
), std::
	`’d
(hdr),…);

528 ià(
h
.
m‘hod
 !ğ
HTTP_HEAD
) {

529 
p
 = 
¡d
::
	`cİy
(¡d::
	`begš
(
body
), std::
	`’d
(body),…);

531 
v
.
	`push
(
¡d
::
	`di¡ªû
(¡d::
	`begš
(v.
buf
), 
p
));

532 
¡»ambuf
.
	`em¶aû_back
(
¡d
::
	`move
(
v
));

533 
should_£nd_fš
 = 
Œue
;

534 
»¥_¡©e
 = 
RESP_COMPLETED
;

535 
	}
}

537 
	gSŒ—m
::
	$£nd_»dœeù_»¥Ú£
(
¡©us_code
,

538 cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

539 
¡d
::
¡ršg
 
hdrs
 = "Location: ";

540 
hdrs
 +ğ
·th
;

541 
hdrs
 += "\r\n";

542 
	`£nd_¡©us_»¥Ú£
(
¡©us_code
, 
hdrs
);

543 
	}
}

545 
	gSŒ—m
::
	$¡¬t_»¥Ú£
() {

546 
h‰p_majÜ
 = 
h
.http_major;

547 
h‰p_mšÜ
 = 
h
.http_minor;

549 autØ
»q_·th
 = 
	`»que¡_·th
(
uri
, 
h
.
m‘hod
 =ğ
HTTP_CONNECT
);

550 autØ
·th
 = 
	`»sŞve_·th
(
»q_·th
);

551 ià(
·th
.
	`em±y
(è|| 
	`İ’_fe
(path) != 0) {

552 
	`£nd_¡©us_»¥Ú£
(404);

556 
¡©
 
¡
 {};

558 
št64_t
 
cÚ‹Á_Ëngth
 = -1;

560 ià(
	`f¡©
(
fd
, &
¡
) == 0) {

561 ià(
¡
.
¡_mode
 & 
S_IFDIR
) {

562 
	`£nd_»dœeù_»¥Ú£
(308, 
·th
.
	`sub¡r
(
cÚfig
.
htdocs
.
	`size
() - 1) + '/');

565 
cÚ‹Á_Ëngth
 = 
¡
.
¡_size
;

567 
	`£nd_¡©us_»¥Ú£
(404);

571 ià(
	`m­_fe
(
cÚ‹Á_Ëngth
) != 0) {

572 
	`£nd_¡©us_»¥Ú£
(500);

576 ià(
h‰p_majÜ
 >= 1) {

577 
¡d
::
¡ršg
 
hdr
;

578 
hdr
 += "HTTP/";

579 
hdr
 +ğ
¡d
::
	`to_¡ršg
(
h‰p_majÜ
);

580 
hdr
 += '.';

581 
hdr
 +ğ
¡d
::
	`to_¡ršg
(
h‰p_mšÜ
);

582 
hdr
 += " 200 OK\r\n";

583 
hdr
 += "Server: ";

584 
hdr
 +ğ
NGTCP2_SERVER
;

585 
hdr
 += "\r\n";

586 ià(
cÚ‹Á_Ëngth
 != -1) {

587 
hdr
 += "Content-Length: ";

588 
hdr
 +ğ
¡d
::
	`to_¡ršg
(
cÚ‹Á_Ëngth
);

589 
hdr
 += "\r\n";

591 
hdr
 += "\r\n";

593 autØ
v
 = 
Bufãr
{
hdr
.
	`size
()};

594 autØ
p
 = 
¡d
::
	`begš
(
v
.
buf
);

595 
p
 = 
¡d
::
	`cİy
(¡d::
	`begš
(
hdr
), std::
	`’d
(hdr),…);

596 
v
.
	`push
(
¡d
::
	`di¡ªû
(¡d::
	`begš
(v.
buf
), 
p
));

597 
¡»ambuf
.
	`em¶aû_back
(
¡d
::
	`move
(
v
));

600 
»¥_¡©e
 = 
RESP_COMPLETED
;

602 
h
.
m‘hod
) {

603 
HTTP_HEAD
:

604 
should_£nd_fš
 = 
Œue
;

605 
	`şo£
(
fd
);

606 
fd
 = -1;

609 
	`bufãr_fe
();

613 
	}
}

615 
	gÇme¥aû
 {

616 
timeoutcb
(
ev_loİ
 *
loİ
, 
ev_tim”
 *
w
, 
»v’ts
) {

617 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
w
->
d©a
);

618 autØ
	gs
 = 
h
->
£rv”
();

620 ià(
ngtı2_cÚn_is_š_şosšg_³riod
(
h
->
cÚn
())) {

621 ià(!
	gcÚfig
.
	gqu›t
) {

622 
	g¡d
::
û¼
 << "Closšg P”iod i ov”" << 
¡d
::
’dl
;

625 
	gs
->
»move
(
h
);

628 ià(
	gh
->
d¿ššg
()) {

629 ià(!
	gcÚfig
.
	gqu›t
) {

630 
	g¡d
::
û¼
 << "D¿ššg P”iod i ov”" << 
¡d
::
’dl
;

633 
	gs
->
»move
(
h
);

637 ià(!
	gcÚfig
.
	gqu›t
) {

638 
	g¡d
::
û¼
 << "Timeout" << 
¡d
::
’dl
;

641 
	gh
->
¡¬t_d¿ššg_³riod
();

645 
	gÇme¥aû
 {

646 
»Œªsm™cb
(
ev_loİ
 *
loİ
, 
ev_tim”
 *
w
, 
»v’ts
) {

647 
	grv
;

649 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
w
->
d©a
);

650 autØ
	gs
 = 
h
->
£rv”
();

651 autØ
	gcÚn
 = 
h
->
cÚn
();

652 autØ
	gnow
 = 
ut
::
time¡amp
(
loİ
);

654 ià(
ngtı2_cÚn_loss_d‘eùiÚ_expœy
(
cÚn
è<ğ
now
) {

655 
rv
 = 
h
->
Ú_wr™e
(
Œue
);

656 
	grv
) {

658 
NETWORK_ERR_CLOSE_WAIT
:

660 
	gNETWORK_ERR_SEND_NON_FATAL
:

661 
s
->
¡¬t_wev
();

664 
s
->
»move
(
h
);

669 ià(
ngtı2_cÚn_ack_d–ay_expœy
(
cÚn
è<ğ
now
) {

670 
rv
 = 
h
->
Ú_wr™e
();

671 
	grv
) {

673 
NETWORK_ERR_CLOSE_WAIT
:

675 
	gNETWORK_ERR_SEND_NON_FATAL
:

676 
s
->
¡¬t_wev
();

679 
s
->
»move
(
h
);

686 
	gHªdËr
::
	$HªdËr
(
ev_loİ
 *
loİ
, 
SSL_CTX
 *
s¦_ùx
, 
S”v”
 *
£rv”
,

687 cÚ¡ 
ngtı2_cid
 *
rcid
)

688 : 
»mÙe_addr_
{
	}
},

689 
max_pk’_
(0),

690 
loİ_
(
loİ
),

691 
s¦_ùx_
(
s¦_ùx
),

692 
s¦_
(
nuÎ±r
),

693 
£rv”_
(
£rv”
),

694 
fd_
(-1),

695 
nü—d_
(0),

696 
shªdshake_idx_
(0),

697 
cÚn_
(
nuÎ±r
),

698 
rcid_
(*
rcid
),

699 
	ghs_üy±o_ùx_
{},

700 
	güy±o_ùx_
{},

701 
	g£ndbuf_
{
	gNGTCP2_MAX_PKTLEN_IPV4
},

702 
tx_üy±o_off£t_
(0),

703 
nkey_upd©e_
(0),

704 
s_®”t_
(0),

705 
š™Ÿl_
(
Œue
),

706 
	$d¿ššg_
(
çl£
) {

707 
	`ev_tim”_š™
(&
tim”_
, 
timeoutcb
, 0., 
cÚfig
.
timeout
);

708 
tim”_
.
d©a
 = 
this
;

709 
	`ev_tim”_š™
(&
¹tim”_
, 
»Œªsm™cb
, 0., 0.);

710 
¹tim”_
.
d©a
 = 
this
;

711 
	}
}

713 
	gHªdËr
::~
	$HªdËr
() {

714 ià(!
cÚfig
.
qu›t
) {

715 
¡d
::
û¼
 << "Closšg QUIC cÚÃùiÚ" << std::
’dl
;

718 
	`ev_tim”_¡İ
(
loİ_
, &
¹tim”_
);

719 
	`ev_tim”_¡İ
(
loİ_
, &
tim”_
);

721 ià(
cÚn_
) {

722 
	`ngtı2_cÚn_d–
(
cÚn_
);

725 ià(
s¦_
) {

726 
	`SSL_ä“
(
s¦_
);

728 
	}
}

730 
	gÇme¥aû
 {

731 
»cv_ş›Á_š™Ÿl
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_cid
 *
dcid
,

732 *
u£r_d©a
) {

733 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
u£r_d©a
);

735 ià(
	gh
->
»cv_ş›Á_š™Ÿl
(
dcid
) != 0) {

736  
NGTCP2_ERR_CALLBACK_FAILURE
;

743 
	gÇme¥aû
 {

744 
hªdshake_com¶‘ed
(
ngtı2_cÚn
 *
cÚn
, *
u£r_d©a
) {

745 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
u£r_d©a
);

747 ià(!
	gcÚfig
.
	gqu›t
) {

748 
	gdebug
::
hªdshake_com¶‘ed
(
cÚn
, 
u£r_d©a
);

751 
	gh
->
£nd_g»‘šg
();

757 
	gÇme¥aû
 {

758 
ssize_t
 
do_hs_’üy±
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

759 cÚ¡ 
ušt8_t
 *
¶aš‹xt
, 
size_t
 
¶aš‹x’
,

760 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, cÚ¡ ušt8_ˆ*
nÚû
,

761 
size_t
 
nÚûËn
, cÚ¡ 
ušt8_t
 *
ad
, size_ˆ
adËn
,

762 *
u£r_d©a
) {

763 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
u£r_d©a
);

765 autØ
	gnwr™e
 = 
h
->
hs_’üy±_d©a
(
de¡
, 
de¡Ën
, 
¶aš‹xt
, 
¶aš‹x’
, 
key
,

766 
keyËn
, 
nÚû
, 
nÚûËn
, 
ad
, 
adËn
);

767 ià(
	gnwr™e
 < 0) {

768  
	gNGTCP2_ERR_CALLBACK_FAILURE
;

771  
	gnwr™e
;

775 
	gÇme¥aû
 {

776 
ssize_t
 
do_hs_deüy±
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

777 cÚ¡ 
ušt8_t
 *
ch”‹xt
, 
size_t
 
ch”‹x’
,

778 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, cÚ¡ ušt8_ˆ*
nÚû
,

779 
size_t
 
nÚûËn
, cÚ¡ 
ušt8_t
 *
ad
, size_ˆ
adËn
,

780 *
u£r_d©a
) {

781 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
u£r_d©a
);

783 autØ
	gnwr™e
 = 
h
->
hs_deüy±_d©a
(
de¡
, 
de¡Ën
, 
ch”‹xt
, 
ch”‹x’
,

784 
key
, 
keyËn
, 
nÚû
, 
nÚûËn
, 
ad
, 
adËn
);

785 ià(
	gnwr™e
 < 0) {

786  
	gNGTCP2_ERR_TLS_DECRYPT
;

789  
	gnwr™e
;

793 
	gÇme¥aû
 {

794 
ssize_t
 
do_’üy±
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

795 cÚ¡ 
ušt8_t
 *
¶aš‹xt
, 
size_t
 
¶aš‹x’
,

796 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, cÚ¡ ušt8_ˆ*
nÚû
,

797 
size_t
 
nÚûËn
, cÚ¡ 
ušt8_t
 *
ad
, size_ˆ
adËn
,

798 *
u£r_d©a
) {

799 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
u£r_d©a
);

801 autØ
	gnwr™e
 = 
h
->
’üy±_d©a
(
de¡
, 
de¡Ën
, 
¶aš‹xt
, 
¶aš‹x’
, 
key
,

802 
keyËn
, 
nÚû
, 
nÚûËn
, 
ad
, 
adËn
);

803 ià(
	gnwr™e
 < 0) {

804  
	gNGTCP2_ERR_CALLBACK_FAILURE
;

807  
	gnwr™e
;

811 
	gÇme¥aû
 {

812 
ssize_t
 
do_deüy±
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

813 cÚ¡ 
ušt8_t
 *
ch”‹xt
, 
size_t
 
ch”‹x’
,

814 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, cÚ¡ ušt8_ˆ*
nÚû
,

815 
size_t
 
nÚûËn
, cÚ¡ 
ušt8_t
 *
ad
, size_ˆ
adËn
,

816 *
u£r_d©a
) {

817 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
u£r_d©a
);

819 autØ
	gnwr™e
 = 
h
->
deüy±_d©a
(
de¡
, 
de¡Ën
, 
ch”‹xt
, 
ch”‹x’
, 
key
,

820 
keyËn
, 
nÚû
, 
nÚûËn
, 
ad
, 
adËn
);

821 ià(
	gnwr™e
 < 0) {

822  
	gNGTCP2_ERR_TLS_DECRYPT
;

825  
	gnwr™e
;

829 
	gÇme¥aû
 {

830 
ssize_t
 
do_š_hp_mask
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

831 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, cÚ¡ ušt8_ˆ*
§m¶e
,

832 
size_t
 
§m¶–’
, *
u£r_d©a
) {

833 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
u£r_d©a
);

835 autØ
	gnwr™e
 = 
h
->
š_hp_mask
(
de¡
, 
de¡Ën
, 
key
, 
keyËn
, 
§m¶e
, 
§m¶–’
);

836 ià(
	gnwr™e
 < 0) {

837  
	gNGTCP2_ERR_CALLBACK_FAILURE
;

840 ià(!
	gcÚfig
.
	gqu›t
 && cÚfig.
	gshow_£ü‘
) {

841 
	gdebug
::
´št_hp_mask
(
de¡
, 
de¡Ën
, 
§m¶e
, 
§m¶–’
);

844  
	gnwr™e
;

848 
	gÇme¥aû
 {

849 
ssize_t
 
do_hp_mask
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

850 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, cÚ¡ ušt8_ˆ*
§m¶e
,

851 
size_t
 
§m¶–’
, *
u£r_d©a
) {

852 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
u£r_d©a
);

854 autØ
	gnwr™e
 = 
h
->
hp_mask
(
de¡
, 
de¡Ën
, 
key
, 
keyËn
, 
§m¶e
, 
§m¶–’
);

855 ià(
	gnwr™e
 < 0) {

856  
	gNGTCP2_ERR_CALLBACK_FAILURE
;

859 ià(!
	gcÚfig
.
	gqu›t
 && cÚfig.
	gshow_£ü‘
) {

860 
	gdebug
::
´št_hp_mask
(
de¡
, 
de¡Ën
, 
§m¶e
, 
§m¶–’
);

863  
	gnwr™e
;

867 
	gÇme¥aû
 {

868 
»cv_üy±o_d©a
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
off£t
, cÚ¡ 
ušt8_t
 *
d©a
,

869 
size_t
 
d©®’
, *
u£r_d©a
) {

870 
	grv
;

872 ià(!
	gcÚfig
.
	gqu›t
) {

873 
	gdebug
::
´št_üy±o_d©a
(
d©a
, 
d©®’
);

876 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
u£r_d©a
);

878 
	gh
->
wr™e_ş›Á_hªdshake
(
d©a
, 
d©®’
);

880 ià(!
ngtı2_cÚn_g‘_hªdshake_com¶‘ed
(
h
->
cÚn
())) {

881 
	grv
 = 
h
->
s_hªdshake
();

882 ià(
	grv
 != 0) {

883  
rv
;

890  
	gh
->
»ad_s
();

894 
	gÇme¥aû
 {

895 
»cv_¡»am_d©a
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
¡»am_id
, 
fš
,

896 
ušt64_t
 
off£t
, cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
,

897 *
u£r_d©a
, *
¡»am_u£r_d©a
) {

898 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
u£r_d©a
);

900 ià(
	gh
->
»cv_¡»am_d©a
(
¡»am_id
, 
fš
, 
d©a
, 
d©®’
) != 0) {

901  
NGTCP2_ERR_CALLBACK_FAILURE
;

908 
	gÇme¥aû
 {

909 
acked_üy±o_off£t
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
off£t
, 
size_t
 
d©®’
,

910 *
u£r_d©a
) {

911 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
u£r_d©a
);

912 
	gh
->
»move_tx_üy±o_d©a
(
off£t
, 
d©®’
);

917 
	gÇme¥aû
 {

918 
acked_¡»am_d©a_off£t
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
¡»am_id
,

919 
ušt64_t
 
off£t
, 
size_t
 
d©®’
, *
u£r_d©a
,

920 *
¡»am_u£r_d©a
) {

921 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
u£r_d©a
);

922 ià(
	gh
->
»move_tx_¡»am_d©a
(
¡»am_id
, 
off£t
, 
d©®’
) != 0) {

923  
NGTCP2_ERR_CALLBACK_FAILURE
;

929 
	gÇme¥aû
 {

930 
¡»am_şo£
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
¡»am_id
, 
ušt16_t
 
­p_”rÜ_code
,

931 *
u£r_d©a
, *
¡»am_u£r_d©a
) {

932 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
u£r_d©a
);

933 
	gh
->
Ú_¡»am_şo£
(
¡»am_id
);

938 
	gÇme¥aû
 {

939 
¿nd
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, 
ngtı2_¿nd_ùx
 
ùx
,

940 *
u£r_d©a
) {

941 autØ
	gdis
 = 
¡d
::
unifÜm_št_di¡ributiÚ
<
ušt8_t
>(0, 255);

942 
	g¡d
::
g’”©e
(
de¡
, de¡ + 
de¡Ën
, [&
dis
](è{  dis(
¿ndg’
); });

947 
	gÇme¥aû
 {

948 
g‘_Ãw_cÚÃùiÚ_id
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_cid
 *
cid
, 
ušt8_t
 *
tok’
,

949 
size_t
 
cidËn
, *
u£r_d©a
) {

950 autØ
	gdis
 = 
¡d
::
unifÜm_št_di¡ributiÚ
<
ušt8_t
>(0, 255);

951 autØ
	gf
 = [&
dis
](è{  dis(
¿ndg’
); };

953 
	g¡d
::
g’”©e_n
(
cid
->
d©a
, 
cidËn
, 
f
);

954 
	gcid
->
	gd©®’
 = 
cidËn
;

955 
	g¡d
::
g’”©e_n
(
tok’
, 
NGTCP2_STATELESS_RESET_TOKENLEN
, 
f
);

957 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
u£r_d©a
);

958 
	gh
->
£rv”
()->
assocŸ‹_cid
(
cid
, 
h
);

964 
	gÇme¥aû
 {

965 
»move_cÚÃùiÚ_id
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_cid
 *
cid
,

966 *
u£r_d©a
) {

967 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
u£r_d©a
);

968 
	gh
->
£rv”
()->
dissocŸ‹_cid
(
cid
);

973 
	gÇme¥aû
 {

974 
upd©e_key
(
ngtı2_cÚn
 *
cÚn
, *
u£r_d©a
) {

975 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
u£r_d©a
);

976 ià(
	gh
->
upd©e_key
() != 0) {

977  
NGTCP2_ERR_CALLBACK_FAILURE
;

983 
	gÇme¥aû
 {

984 
·th_v®id©iÚ
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_·th
 *
·th
,

985 
ngtı2_·th_v®id©iÚ_»suÉ
 
»s
, *
u£r_d©a
) {

986 ià(!
	gcÚfig
.
	gqu›t
) {

987 
	gdebug
::
·th_v®id©iÚ
(
·th
, 
»s
);

993 
	gHªdËr
::
	$š™
(
fd
, cÚ¡ 
sockaddr
 *
§
, 
sockËn_t
 
§Ën
,

994 cÚ¡ 
ngtı2_cid
 *
dcid
, cÚ¡‚gtı2_cid *
ocid
,

995 
ušt32_t
 
v”siÚ
) {

996 
rv
;

998 
»mÙe_addr_
.
Ën
 = 
§Ën
;

999 
	`memıy
(&
»mÙe_addr_
.
su
.
§
, sa, 
§Ën
);

1001 
»mÙe_addr_
.
su
.
¡Üage
.
ss_çmy
) {

1002 
AF_INET
:

1003 
max_pk’_
 = 
NGTCP2_MAX_PKTLEN_IPV4
;

1005 
AF_INET6
:

1006 
max_pk’_
 = 
NGTCP2_MAX_PKTLEN_IPV6
;

1012 
fd_
 = 
fd
;

1013 
s¦_
 = 
	`SSL_Ãw
(
s¦_ùx_
);

1014 autØ
bio
 = 
	`BIO_Ãw
(
	`ü—‹_bio_m‘hod
());

1015 
	`BIO_£t_d©a
(
bio
, 
this
);

1016 
	`SSL_£t_bio
(
s¦_
, 
bio
, bio);

1017 
	`SSL_£t_­p_d©a
(
s¦_
, 
this
);

1018 
	`SSL_£t_acû±_¡©e
(
s¦_
);

1019 
	`SSL_£t_msg_ÿÎback
(
s¦_
, 
msg_cb
);

1020 
	`SSL_£t_msg_ÿÎback_¬g
(
s¦_
, 
this
);

1021 
	`SSL_£t_key_ÿÎback
(
s¦_
, 
key_cb
, 
this
);

1023 autØ
ÿÎbacks
 = 
ngtı2_cÚn_ÿÎbacks
{

1024 
nuÎ±r
,

1025 ::
»cv_ş›Á_š™Ÿl
,

1026 
»cv_üy±o_d©a
,

1027 
hªdshake_com¶‘ed
,

1028 
nuÎ±r
,

1029 
do_hs_’üy±
,

1030 
do_hs_deüy±
,

1031 
do_’üy±
,

1032 
do_deüy±
,

1033 
do_š_hp_mask
,

1034 
do_hp_mask
,

1035 ::
»cv_¡»am_d©a
,

1036 
acked_üy±o_off£t
,

1037 
acked_¡»am_d©a_off£t
,

1038 
nuÎ±r
,

1039 
¡»am_şo£
,

1040 
nuÎ±r
,

1041 
nuÎ±r
,

1042 
nuÎ±r
,

1043 
nuÎ±r
,

1044 
¿nd
,

1045 
g‘_Ãw_cÚÃùiÚ_id
,

1046 
»move_cÚÃùiÚ_id
,

1047 ::
upd©e_key
,

1048 
·th_v®id©iÚ
,

1051 
ngtı2_£‰šgs
 
£‰šgs
{};

1053 
£‰šgs
.
log_´štf
 = 
cÚfig
.
qu›t
 ? 
nuÎ±r
 : 
debug
::log_printf;

1054 
£‰šgs
.
š™Ÿl_ts
 = 
ut
::
	`time¡amp
(
loİ_
);

1055 
£‰šgs
.
max_¡»am_d©a_bidi_loÿl
 = 256
_k
;

1056 
£‰šgs
.
max_¡»am_d©a_bidi_»mÙe
 = 256
_k
;

1057 
£‰šgs
.
max_¡»am_d©a_uni
 = 256
_k
;

1058 
£‰šgs
.
max_d©a
 = 1
_m
;

1059 
£‰šgs
.
max_¡»ams_bidi
 = 100;

1060 
£‰šgs
.
max_¡»ams_uni
 = 0;

1061 
£‰šgs
.
idË_timeout
 = 
cÚfig
.
timeout
;

1062 
£‰šgs
.
max_·ck‘_size
 = 
NGTCP2_MAX_PKT_SIZE
;

1063 
£‰šgs
.
ack_d–ay_expÚ’t
 = 
NGTCP2_DEFAULT_ACK_DELAY_EXPONENT
;

1064 
£‰šgs
.
¡©–ess_»£t_tok’_´e£Á
 = 1;

1065 
£‰šgs
.
max_ack_d–ay
 = 
NGTCP2_DEFAULT_MAX_ACK_DELAY
;

1067 autØ
dis
 = 
¡d
::
unifÜm_št_di¡ributiÚ
<
ušt8_t
>(0, 255);

1068 
¡d
::
	`g’”©e
(¡d::
	`begš
(
£‰šgs
.
¡©–ess_»£t_tok’
),

1069 
¡d
::
	`’d
(
£‰šgs
.
¡©–ess_»£t_tok’
),

1070 [&
dis
](è{  
	`dis
(
¿ndg’
); });

1072 
scid_
.
d©®’
 = 
NGTCP2_SV_SCIDLEN
;

1073 
¡d
::
	`g’”©e
(
scid_
.
d©a
, scid_.d©¨+ scid_.
d©®’
,

1074 [&
dis
](è{  
	`dis
(
¿ndg’
); });

1076 autØ&
loÿl_addr
 = 
£rv”_
->
	`g‘_loÿl_addr
();

1077 autØ
·th
 = 
ngtı2_·th
{

1078 {
loÿl_addr
.
Ën
, 
cÚ¡_ÿ¡
<
ušt8_t
 *>(

1079 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(&
loÿl_addr
.
su
))},

1080 {
§Ën
, 
cÚ¡_ÿ¡
<
ušt8_t
 *>(
»š‹½»t_ÿ¡
<cÚ¡ ušt8_ˆ*>(
§
))}};

1081 
rv
 = 
	`ngtı2_cÚn_£rv”_Ãw
(&
cÚn_
, 
dcid
, &
scid_
, &
·th
, 
v”siÚ
, &
ÿÎbacks
,

1082 &
£‰šgs
, 
this
);

1083 ià(
rv
 != 0) {

1084 
¡d
::
û¼
 << "ngtı2_cÚn_£rv”_Ãw: " << 
	`ngtı2_¡»¼Ü
(
rv
è<< std::
’dl
;

1088 ià(
ocid
) {

1089 
	`ngtı2_cÚn_£t_»Œy_ocid
(
cÚn_
, 
ocid
);

1092 
	`ev_tim”_agaš
(
loİ_
, &
tim”_
);

1095 
	}
}

1097 
	gHªdËr
::
	$s_hªdshake
() {

1098 
	`ERR_ş—r_”rÜ
();

1100 
rv
;

1102 ià(
š™Ÿl_
) {

1103 
¡d
::
¬¿y
<
ušt8_t
, 8> 
buf
;

1104 
size_t
 
Ä—d
;

1105 
rv
 = 
	`SSL_»ad_—¾y_d©a
(
s¦_
, 
buf
.
	`d©a
(), buf.
	`size
(), &
Ä—d
);

1106 
š™Ÿl_
 = 
çl£
;

1107 
rv
) {

1108 
SSL_READ_EARLY_DATA_ERROR
: {

1109 ià(!
cÚfig
.
qu›t
) {

1110 
¡d
::
û¼
 << "SSL_READ_EARLY_DATA_ERROR" << std::
’dl
;

1112 autØ
”r
 = 
	`SSL_g‘_”rÜ
(
s¦_
, 
rv
);

1113 
”r
) {

1114 
SSL_ERROR_WANT_READ
:

1115 
SSL_ERROR_WANT_WRITE
: {

1118 
SSL_ERROR_SSL
:

1119 
¡d
::
û¼
 << "TLS handshakeƒrror: "

1120 << 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
nuÎ±r
è<< 
¡d
::
’dl
;

1121  
NGTCP2_ERR_CRYPTO
;

1123 
¡d
::
û¼
 << "TLS hªdshak”rÜ: " << 
”r
 << std::
’dl
;

1124  
NGTCP2_ERR_CRYPTO
;

1128 
SSL_READ_EARLY_DATA_SUCCESS
:

1129 ià(!
cÚfig
.
qu›t
) {

1130 
¡d
::
û¼
 << "SSL_READ_EARLY_DATA_SUCCESS" << std::
’dl
;

1133 ià(
Ä—d
 > 0) {

1134  
NGTCP2_ERR_PROTO
;

1137 
SSL_READ_EARLY_DATA_FINISH
:

1138 ià(!
cÚfig
.
qu›t
) {

1139 
¡d
::
û¼
 << "SSL_READ_EARLY_DATA_FINISH" << std::
’dl
;

1145 
rv
 = 
	`SSL_do_hªdshake
(
s¦_
);

1146 ià(
rv
 <= 0) {

1147 autØ
”r
 = 
	`SSL_g‘_”rÜ
(
s¦_
, 
rv
);

1148 
”r
) {

1149 
SSL_ERROR_WANT_READ
:

1150 
SSL_ERROR_WANT_WRITE
:

1152 
SSL_ERROR_SSL
:

1153 
¡d
::
û¼
 << "TLS handshakeƒrror: "

1154 << 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
nuÎ±r
è<< 
¡d
::
’dl
;

1155  
NGTCP2_ERR_CRYPTO
;

1157 
¡d
::
û¼
 << "TLS hªdshak”rÜ: " << 
”r
 << std::
’dl
;

1158  
NGTCP2_ERR_CRYPTO
;

1166 
	`ngtı2_cÚn_hªdshake_com¶‘ed
(
cÚn_
);

1168 ià(!
cÚfig
.
qu›t
) {

1169 
¡d
::
û¼
 << "NegÙŸ‹d ch” su™i " << 
	`SSL_g‘_ch”_Çme
(
s¦_
)

1170 << 
¡d
::
’dl
;

1172 cÚ¡ *
®²
 = 
nuÎ±r
;

1173 
®²Ën
;

1175 
	`SSL_g‘0_®²_£Ëùed
(
s¦_
, &
®²
, &
®²Ën
);

1176 ià(
®²
) {

1177 
¡d
::
û¼
 << "Negotiated ALPN is ";

1178 
¡d
::
û¼
.
	`wr™e
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
®²
), 
®²Ën
);

1179 
¡d
::
û¼
 << std::
’dl
;

1184 
	}
}

1186 
	gHªdËr
::
	$»ad_s
() {

1187 
	`ERR_ş—r_”rÜ
();

1189 
¡d
::
¬¿y
<
ušt8_t
, 4096> 
buf
;

1190 
size_t
 
Ä—d
;

1193 autØ
rv
 = 
	`SSL_»ad_ex
(
s¦_
, 
buf
.
	`d©a
(), buf.
	`size
(), &
Ä—d
);

1194 ià(
rv
 == 1) {

1195 
¡d
::
û¼
 << "R—d " << 
Ä—d
 << " bytes from TLS crypto stream"

1196 << 
¡d
::
’dl
;

1197  
NGTCP2_ERR_PROTO
;

1199 autØ
”r
 = 
	`SSL_g‘_”rÜ
(
s¦_
, 0);

1200 
”r
) {

1201 
SSL_ERROR_WANT_READ
:

1202 
SSL_ERROR_WANT_WRITE
:

1204 
SSL_ERROR_SSL
:

1205 
SSL_ERROR_ZERO_RETURN
:

1206 
¡d
::
û¼
 << "TLS„eadƒrror: "

1207 << 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
nuÎ±r
è<< 
¡d
::
’dl
;

1208  
NGTCP2_ERR_CRYPTO
;

1210 
¡d
::
û¼
 << "TLS„—dƒ¼Ü: " << 
”r
 << std::
’dl
;

1211  
NGTCP2_ERR_CRYPTO
;

1214 
	}
}

1216 
	gHªdËr
::
	$wr™e_£rv”_hªdshake
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
) {

1217 
	`wr™e_£rv”_hªdshake
(
shªdshake_
, 
shªdshake_idx_
, 
d©a
, 
d©®’
);

1220 
	}
}

1222 
	gHªdËr
::
wr™e_£rv”_hªdshake
(
¡d
::
deque
<
Bufãr
> &
de¡
, 
size_t
 &
idx
,

1223 cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
) {

1224 
	gde¡
.
em¶aû_back
(
d©a
, 
d©®’
);

1225 ++
	gidx
;

1227 autØ&
	gbuf
 = 
de¡
.
back
();

1229 
ngtı2_cÚn_subm™_üy±o_d©a
(
cÚn_
, 
buf
.
½os
(), buf.
size
());

1232 
size_t
 
	gHªdËr
::
	$»ad_£rv”_hªdshake
(cÚ¡ 
ušt8_t
 **
pde¡
) {

1233 ià(
shªdshake_idx_
 =ğ
shªdshake_
.
	`size
()) {

1236 autØ&
v
 = 
shªdshake_
[
shªdshake_idx_
++];

1237 *
pde¡
 = 
v
.
	`½os
();

1238  
v
.
	`size
();

1239 
	}
}

1241 
size_t
 
	gHªdËr
::
	$»ad_ş›Á_hªdshake
(
ušt8_t
 *
buf
, 
size_t
 
buæ’
) {

1242 autØ
n
 = 
¡d
::
	`mš
(
buæ’
, 
chªdshake_
.
	`size
(è- 
nü—d_
);

1243 
¡d
::
	`cİy_n
(¡d::
	`begš
(
chªdshake_
è+ 
nü—d_
, 
n
, 
buf
);

1244 
nü—d_
 +ğ
n
;

1245  
n
;

1246 
	}
}

1248 
	gHªdËr
::
	$wr™e_ş›Á_hªdshake
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
) {

1249 
¡d
::
	`cİy_n
(
d©a
, 
d©®’
, std::
	`back_š£¹”
(
chªdshake_
));

1250 
	}
}

1252 
	gHªdËr
::
	$»cv_ş›Á_š™Ÿl
(cÚ¡ 
ngtı2_cid
 *
dcid
) {

1253 
rv
;

1254 
¡d
::
¬¿y
<
ušt8_t
, 32> 
š™Ÿl_£ü‘
, 
£ü‘
;

1256 
rv
 = 
üy±o
::
	`d”ive_š™Ÿl_£ü‘
(

1257 
š™Ÿl_£ü‘
.
	`d©a
(), in™Ÿl_£ü‘.
	`size
(), 
dcid
,

1258 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
NGTCP2_INITIAL_SALT
),

1259 
	`¡r_size
(
NGTCP2_INITIAL_SALT
));

1260 ià(
rv
 != 0) {

1261 
¡d
::
û¼
 << "üy±o::d”ive_š™Ÿl_£ü‘(èçed" << std::
’dl
;

1265 ià(!
cÚfig
.
qu›t
 && cÚfig.
show_£ü‘
) {

1266 
debug
::
	`´št_š™Ÿl_£ü‘
(
š™Ÿl_£ü‘
.
	`d©a
(), in™Ÿl_£ü‘.
	`size
());

1269 
üy±o
::
	`´f_sha256
(
hs_üy±o_ùx_
);

1270 
üy±o
::
	`«ad_«s_128_gcm
(
hs_üy±o_ùx_
);

1272 
rv
 = 
üy±o
::
	`d”ive_£rv”_š™Ÿl_£ü‘
(
£ü‘
.
	`d©a
(), seü‘.
	`size
(),

1273 
š™Ÿl_£ü‘
.
	`d©a
(),

1274 
š™Ÿl_£ü‘
.
	`size
());

1275 ià(
rv
 != 0) {

1276 
¡d
::
û¼
 << "üy±o::d”ive_£rv”_š™Ÿl_£ü‘(èçed" << std::
’dl
;

1280 
¡d
::
¬¿y
<
ušt8_t
, 16> 
key
, 
iv
, 
hp
;

1281 autØ
keyËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_key
(

1282 
key
.
	`d©a
(), key.
	`size
(), 
£ü‘
.d©a(), seü‘.size(), 
hs_üy±o_ùx_
);

1283 ià(
keyËn
 < 0) {

1287 autØ
ivËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_iv
(

1288 
iv
.
	`d©a
(), iv.
	`size
(), 
£ü‘
.d©a(), seü‘.size(), 
hs_üy±o_ùx_
);

1289 ià(
ivËn
 < 0) {

1293 autØ
h¶’
 = 
üy±o
::
	`d”ive_h—d”_´ÙeùiÚ_key
(

1294 
hp
.
	`d©a
(), hp.
	`size
(), 
£ü‘
.d©a(), seü‘.size(), 
hs_üy±o_ùx_
);

1295 ià(
h¶’
 < 0) {

1299 ià(!
cÚfig
.
qu›t
 && cÚfig.
show_£ü‘
) {

1300 
debug
::
	`´št_£rv”_š_£ü‘
(
£ü‘
.
	`d©a
(), seü‘.
	`size
());

1301 
debug
::
	`´št_£rv”_µ_key
(
key
.
	`d©a
(), 
keyËn
);

1302 
debug
::
	`´št_£rv”_µ_iv
(
iv
.
	`d©a
(), 
ivËn
);

1303 
debug
::
	`´št_£rv”_µ_hp
(
hp
.
	`d©a
(), 
h¶’
);

1306 
	`ngtı2_cÚn_š¡®l_š™Ÿl_tx_keys
(
cÚn_
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.data(),

1307 
ivËn
, 
hp
.
	`d©a
(), 
h¶’
);

1309 
rv
 = 
üy±o
::
	`d”ive_ş›Á_š™Ÿl_£ü‘
(
£ü‘
.
	`d©a
(), seü‘.
	`size
(),

1310 
š™Ÿl_£ü‘
.
	`d©a
(),

1311 
š™Ÿl_£ü‘
.
	`size
());

1312 ià(
rv
 != 0) {

1313 
¡d
::
û¼
 << "üy±o::d”ive_ş›Á_š™Ÿl_£ü‘(èçed" << std::
’dl
;

1317 
keyËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_key
(

1318 
key
.
	`d©a
(), key.
	`size
(), 
£ü‘
.d©a(), seü‘.size(), 
hs_üy±o_ùx_
);

1319 ià(
keyËn
 < 0) {

1323 
ivËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_iv
(

1324 
iv
.
	`d©a
(), iv.
	`size
(), 
£ü‘
.d©a(), seü‘.size(), 
hs_üy±o_ùx_
);

1325 ià(
ivËn
 < 0) {

1329 
h¶’
 = 
üy±o
::
	`d”ive_h—d”_´ÙeùiÚ_key
(

1330 
hp
.
	`d©a
(), hp.
	`size
(), 
£ü‘
.d©a(), seü‘.size(), 
hs_üy±o_ùx_
);

1331 ià(
h¶’
 < 0) {

1335 ià(!
cÚfig
.
qu›t
 && cÚfig.
show_£ü‘
) {

1336 
debug
::
	`´št_ş›Á_š_£ü‘
(
£ü‘
.
	`d©a
(), seü‘.
	`size
());

1337 
debug
::
	`´št_ş›Á_µ_key
(
key
.
	`d©a
(), 
keyËn
);

1338 
debug
::
	`´št_ş›Á_µ_iv
(
iv
.
	`d©a
(), 
ivËn
);

1339 
debug
::
	`´št_ş›Á_µ_hp
(
hp
.
	`d©a
(), 
h¶’
);

1342 
	`ngtı2_cÚn_š¡®l_š™Ÿl_rx_keys
(
cÚn_
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.data(),

1343 
ivËn
, 
hp
.
	`d©a
(), 
h¶’
);

1346 
	}
}

1348 
ssize_t
 
	gHªdËr
::
	$hs_’üy±_d©a
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

1349 cÚ¡ 
ušt8_t
 *
¶aš‹xt
, 
size_t
 
¶aš‹x’
,

1350 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

1351 cÚ¡ 
ušt8_t
 *
nÚû
, 
size_t
 
nÚûËn
,

1352 cÚ¡ 
ušt8_t
 *
ad
, 
size_t
 
adËn
) {

1353  
üy±o
::
	`’üy±
(
de¡
, 
de¡Ën
, 
¶aš‹xt
, 
¶aš‹x’
, 
hs_üy±o_ùx_
,

1354 
key
, 
keyËn
, 
nÚû
, 
nÚûËn
, 
ad
, 
adËn
);

1355 
	}
}

1357 
ssize_t
 
	gHªdËr
::
	$hs_deüy±_d©a
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

1358 cÚ¡ 
ušt8_t
 *
ch”‹xt
,

1359 
size_t
 
ch”‹x’
, cÚ¡ 
ušt8_t
 *
key
,

1360 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
nÚû
,

1361 
size_t
 
nÚûËn
, cÚ¡ 
ušt8_t
 *
ad
,

1362 
size_t
 
adËn
) {

1363  
üy±o
::
	`deüy±
(
de¡
, 
de¡Ën
, 
ch”‹xt
, 
ch”‹x’
,

1364 
hs_üy±o_ùx_
, 
key
, 
keyËn
, 
nÚû
, 
nÚûËn
, 
ad
,

1365 
adËn
);

1366 
	}
}

1368 
ssize_t
 
	gHªdËr
::
	$’üy±_d©a
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

1369 cÚ¡ 
ušt8_t
 *
¶aš‹xt
, 
size_t
 
¶aš‹x’
,

1370 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

1371 cÚ¡ 
ušt8_t
 *
nÚû
, 
size_t
 
nÚûËn
,

1372 cÚ¡ 
ušt8_t
 *
ad
, 
size_t
 
adËn
) {

1373  
üy±o
::
	`’üy±
(
de¡
, 
de¡Ën
, 
¶aš‹xt
, 
¶aš‹x’
, 
üy±o_ùx_
,

1374 
key
, 
keyËn
, 
nÚû
, 
nÚûËn
, 
ad
, 
adËn
);

1375 
	}
}

1377 
ssize_t
 
	gHªdËr
::
	$deüy±_d©a
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

1378 cÚ¡ 
ušt8_t
 *
ch”‹xt
, 
size_t
 
ch”‹x’
,

1379 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

1380 cÚ¡ 
ušt8_t
 *
nÚû
, 
size_t
 
nÚûËn
,

1381 cÚ¡ 
ušt8_t
 *
ad
, 
size_t
 
adËn
) {

1382  
üy±o
::
	`deüy±
(
de¡
, 
de¡Ën
, 
ch”‹xt
, 
ch”‹x’
, 
üy±o_ùx_
,

1383 
key
, 
keyËn
, 
nÚû
, 
nÚûËn
, 
ad
, 
adËn
);

1384 
	}
}

1386 
ssize_t
 
	gHªdËr
::
	$š_hp_mask
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
key
,

1387 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
§m¶e
,

1388 
size_t
 
§m¶–’
) {

1389  
üy±o
::
	`hp_mask
(
de¡
, 
de¡Ën
, 
hs_üy±o_ùx_
, 
key
, 
keyËn
, 
§m¶e
,

1390 
§m¶–’
);

1391 
	}
}

1393 
ssize_t
 
	gHªdËr
::
	$hp_mask
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
key
,

1394 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
§m¶e
,

1395 
size_t
 
§m¶–’
) {

1396  
üy±o
::
	`hp_mask
(
de¡
, 
de¡Ën
, 
üy±o_ùx_
, 
key
, 
keyËn
, 
§m¶e
,

1397 
§m¶–’
);

1398 
	}
}

1400 
	gHªdËr
::
	$do_hªdshake_»ad_Úû
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
) {

1401 autØ
rv
 =

1402 
	`ngtı2_cÚn_»ad_hªdshake
(
cÚn_
, 
d©a
, 
d©®’
, 
ut
::
	`time¡amp
(
loİ_
));

1403 ià(
rv
 != 0) {

1404 
¡d
::
û¼
 << "ngtı2_cÚn_»ad_hªdshake: " << 
	`ngtı2_¡»¼Ü
(
rv
)

1405 << 
¡d
::
’dl
;

1409 
	}
}

1411 
ssize_t
 
	gHªdËr
::
	$do_hªdshake_wr™e_Úû
() {

1412 autØ
nwr™e
 = 
	`ngtı2_cÚn_wr™e_hªdshake
(
cÚn_
, 
£ndbuf_
.
	`wpos
(), 
max_pk’_
,

1413 
ut
::
	`time¡amp
(
loİ_
));

1414 ià(
nwr™e
 < 0) {

1415 
¡d
::
û¼
 << "ngtı2_cÚn_wr™e_hªdshake: " << 
	`ngtı2_¡»¼Ü
(
nwr™e
)

1416 << 
¡d
::
’dl
;

1420 ià(
nwr™e
 == 0) {

1424 
£ndbuf_
.
	`push
(
nwr™e
);

1426 autØ
rv
 = 
£rv”_
->
	`£nd_·ck‘
(
»mÙe_addr_
, 
£ndbuf_
);

1427 ià(
rv
 =ğ
NETWORK_ERR_SEND_NON_FATAL
) {

1428 
	`scheduË_»Œªsm™
();

1429  
rv
;

1431 ià(
rv
 !ğ
NETWORK_ERR_OK
) {

1432  
rv
;

1435  
nwr™e
;

1436 
	}
}

1438 
	gHªdËr
::
	$do_hªdshake
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
) {

1439 autØ
rv
 = 
	`do_hªdshake_»ad_Úû
(
d©a
, 
d©®’
);

1440 ià(
rv
 != 0) {

1441  
rv
;

1444 ià(
£ndbuf_
.
	`size
() > 0) {

1445 autØ
rv
 = 
£rv”_
->
	`£nd_·ck‘
(
»mÙe_addr_
, 
£ndbuf_
);

1446 ià(
rv
 !ğ
NETWORK_ERR_OK
) {

1447  
rv
;

1452 autØ
nwr™e
 = 
	`do_hªdshake_wr™e_Úû
();

1453 ià(
nwr™e
 < 0) {

1454  
nwr™e
;

1456 ià(
nwr™e
 == 0) {

1460 
	}
}

1462 
	gHªdËr
::
	$upd©e_»mÙe_addr
(cÚ¡ 
ngtı2_addr
 *
addr
) {

1463 
»mÙe_addr_
.
Ën
 = 
addr
->len;

1464 
	`memıy
(&
»mÙe_addr_
.
su
, 
addr
->addr, ×ddr->
Ën
));

1465 
	}
}

1467 
	gHªdËr
::
	$ãed_d©a
(cÚ¡ 
sockaddr
 *
§
, 
sockËn_t
 
§Ën
, 
ušt8_t
 *
d©a
,

1468 
size_t
 
d©®’
) {

1469 
rv
;

1471 ià(
	`ngtı2_cÚn_g‘_hªdshake_com¶‘ed
(
cÚn_
)) {

1472 autØ&
loÿl_addr
 = 
£rv”_
->
	`g‘_loÿl_addr
();

1473 autØ
·th
 = 
ngtı2_·th
{

1474 {
loÿl_addr
.
Ën
,

1475 
cÚ¡_ÿ¡
<
ušt8_t
 *>(

1476 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(&
loÿl_addr
.
su
))},

1477 {
§Ën
, 
cÚ¡_ÿ¡
<
ušt8_t
 *>(
»š‹½»t_ÿ¡
<cÚ¡ ušt8_ˆ*>(
§
))}};

1478 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn_
, &
·th
, 
d©a
, 
d©®’
,

1479 
ut
::
	`time¡amp
(
loİ_
));

1480 ià(
rv
 != 0) {

1481 
¡d
::
û¼
 << "ngtı2_cÚn_»ad_pkt: " << 
	`ngtı2_¡»¼Ü
(
rv
è<< std::
’dl
;

1482 ià(
rv
 =ğ
NGTCP2_ERR_DRAINING
) {

1483 
	`¡¬t_d¿ššg_³riod
();

1484  
NETWORK_ERR_CLOSE_WAIT
;

1486  
	`hªdË_”rÜ
(
rv
);

1489 
rv
 = 
	`do_hªdshake
(
d©a
, 
d©®’
);

1490 ià(
rv
 != 0) {

1491  
	`hªdË_”rÜ
(
rv
);

1496 
	}
}

1498 
	gHªdËr
::
	$Ú_»ad
(cÚ¡ 
sockaddr
 *
§
, 
sockËn_t
 
§Ën
, 
ušt8_t
 *
d©a
,

1499 
size_t
 
d©®’
) {

1500 
rv
;

1502 
rv
 = 
	`ãed_d©a
(
§
, 
§Ën
, 
d©a
, 
d©®’
);

1503 ià(
rv
 != 0) {

1504  
rv
;

1507 
	`ev_tim”_agaš
(
loİ_
, &
tim”_
);

1510 
	}
}

1512 
	gHªdËr
::
	$Ú_wr™e
(
boŞ
 
»Œªsm™
) {

1513 
rv
;

1515 ià(
	`ngtı2_cÚn_is_š_şosšg_³riod
(
cÚn_
)) {

1519 ià(
£ndbuf_
.
	`size
() > 0) {

1520 autØ
rv
 = 
£rv”_
->
	`£nd_·ck‘
(
»mÙe_addr_
, 
£ndbuf_
);

1521 ià(
rv
 !ğ
NETWORK_ERR_OK
) {

1522  
rv
;

1526 
	`as£¹
(
£ndbuf_
.
	`Ëá
(è>ğ
max_pk’_
);

1528 ià(
»Œªsm™
) {

1529 
rv
 = 
	`ngtı2_cÚn_Ú_loss_d‘eùiÚ_tim”
(
cÚn_
, 
ut
::
	`time¡amp
(
loİ_
));

1530 ià(
rv
 != 0) {

1531 
¡d
::
û¼
 << "ngtcp2_conn_on_loss_detection_timer: "

1532 << 
	`ngtı2_¡»¼Ü
(
rv
è<< 
¡d
::
’dl
;

1537 ià(!
	`ngtı2_cÚn_g‘_hªdshake_com¶‘ed
(
cÚn_
)) {

1538 
rv
 = 
	`do_hªdshake
(
nuÎ±r
, 0);

1539 ià(
rv
 =ğ
NETWORK_ERR_SEND_NON_FATAL
) {

1540 
	`scheduË_»Œªsm™
();

1542 ià(
rv
 !ğ
NETWORK_ERR_OK
) {

1543  
rv
;

1547 autØ&
p
 : 
¡»ams_
) {

1548 autØ&
¡»am
 = 
p
.
£cÚd
;

1549 
rv
 = 
	`Ú_wr™e_¡»am
(*
¡»am
);

1550 ià(
rv
 != 0) {

1551 ià(
rv
 =ğ
NETWORK_ERR_SEND_NON_FATAL
) {

1552 
	`scheduË_»Œªsm™
();

1553  
rv
;

1555  
rv
;

1559 ià(!
	`ngtı2_cÚn_g‘_hªdshake_com¶‘ed
(
cÚn_
)) {

1560 
	`scheduË_»Œªsm™
();

1564 
P©hStÜage
 
·th
;

1567 autØ
n
 = 
	`ngtı2_cÚn_wr™e_pkt
(
cÚn_
, &
·th
.·th, 
£ndbuf_
.
	`wpos
(),

1568 
max_pk’_
, 
ut
::
	`time¡amp
(
loİ_
));

1569 ià(
n
 < 0) {

1570 
¡d
::
û¼
 << "ngtı2_cÚn_wr™e_pkt: " << 
	`ngtı2_¡»¼Ü
(
n
è<< std::
’dl
;

1571  
	`hªdË_”rÜ
(
n
);

1573 ià(
n
 == 0) {

1577 
£ndbuf_
.
	`push
(
n
);

1579 
	`upd©e_»mÙe_addr
(&
·th
.·th.
»mÙe
);

1581 autØ
rv
 = 
£rv”_
->
	`£nd_·ck‘
(
»mÙe_addr_
, 
£ndbuf_
);

1582 ià(
rv
 =ğ
NETWORK_ERR_SEND_NON_FATAL
) {

1583 
	`scheduË_»Œªsm™
();

1584  
rv
;

1586 ià(
rv
 !ğ
NETWORK_ERR_OK
) {

1587  
rv
;

1591 
	`scheduË_»Œªsm™
();

1593 
	}
}

1595 
	gHªdËr
::
	$Ú_wr™e_¡»am
(
SŒ—m
 &
¡»am
) {

1596 ià(
¡»am
.
¡»ambuf_idx
 =ğ¡»am.
¡»ambuf
.
	`size
()) {

1597 ià(
¡»am
.
should_£nd_fš
) {

1598 autØ
v
 = 
Bufãr
{};

1599 ià(
	`wr™e_¡»am_d©a
(
¡»am
, 1, 
v
) != 0) {

1606 autØ
™
 = 
¡d
::
	`begš
(
¡»am
.
¡»ambuf
è+ sŒ—m.
¡»ambuf_idx
;

1607 
™
 !ğ
¡d
::
	`’d
(
¡»am
.
¡»ambuf
); ++it) {

1608 autØ&
v
 = *
™
;

1609 autØ
fš
 = 
¡»am
.
should_£nd_fš
 &&

1610 
¡»am
.
¡»ambuf_idx
 =ğ¡»am.
¡»ambuf
.
	`size
() - 1;

1611 autØ
rv
 = 
	`wr™e_¡»am_d©a
(
¡»am
, 
fš
, 
v
);

1612 ià(
rv
 != 0) {

1613  
rv
;

1615 ià(
v
.
	`size
() > 0) {

1618 ++
¡»am
.
¡»ambuf_idx
;

1622 
	}
}

1624 
	gHªdËr
::
	$wr™e_¡»am_d©a
(
SŒ—m
 &
¡»am
, 
fš
, 
Bufãr
 &
d©a
) {

1625 
ssize_t
 
nd©®’
;

1626 
P©hStÜage
 
·th
;

1629 autØ
n
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn_
, &
·th
.·th, 
£ndbuf_
.
	`wpos
(),

1630 
max_pk’_
, &
nd©®’
, 
¡»am
.
¡»am_id
,

1631 
fš
, 
d©a
.
	`½os
(), d©a.
	`size
(),

1632 
ut
::
	`time¡amp
(
loİ_
));

1633 ià(
n
 < 0) {

1634 
n
) {

1635 
NGTCP2_ERR_STREAM_DATA_BLOCKED
:

1636 
NGTCP2_ERR_STREAM_SHUT_WR
:

1639 
¡d
::
û¼
 << "ngtı2_cÚn_wr™e_¡»am: " << 
	`ngtı2_¡»¼Ü
(
n
)

1640 << 
¡d
::
’dl
;

1641  
	`hªdË_”rÜ
(
n
);

1644 ià(
n
 == 0) {

1648 ià(
nd©®’
 >= 0) {

1649 ià(
fš
 && 
¡©ic_ÿ¡
<
size_t
>(
nd©®’
è=ğ
d©a
.
	`size
()) {

1650 
¡»am
.
should_£nd_fš
 = 
çl£
;

1653 
d©a
.
	`£ek
(
nd©®’
);

1656 
£ndbuf_
.
	`push
(
n
);

1658 
	`upd©e_»mÙe_addr
(&
·th
.·th.
»mÙe
);

1660 autØ
rv
 = 
£rv”_
->
	`£nd_·ck‘
(
»mÙe_addr_
, 
£ndbuf_
);

1661 ià(
rv
 !ğ
NETWORK_ERR_OK
) {

1662  
rv
;

1665 ià(
nd©®’
 >ğ0 && 
d©a
.
	`size
() == 0) {

1671 
	}
}

1673 
boŞ
 
	gHªdËr
::
	$d¿ššg
(ècÚ¡ {  
d¿ššg_
; 
	}
}

1675 
	gHªdËr
::
	$¡¬t_d¿ššg_³riod
() {

1676 
d¿ššg_
 = 
Œue
;

1678 
	`ev_tim”_¡İ
(
loİ_
, &
¹tim”_
);

1680 
tim”_
.
»³©
 = 15.;

1681 
	`ev_tim”_agaš
(
loİ_
, &
tim”_
);

1683 ià(!
cÚfig
.
qu›t
) {

1684 
¡d
::
û¼
 << "D¿ššg…”iod ha ¡¬‹d" << std::
’dl
;

1686 
	}
}

1688 
	gHªdËr
::
	$¡¬t_şosšg_³riod
(
lib”r
) {

1689 ià(!
cÚn_
 || 
	`ngtı2_cÚn_is_š_şosšg_³riod
(conn_)) {

1693 
	`ev_tim”_¡İ
(
loİ_
, &
¹tim”_
);

1695 
tim”_
.
»³©
 = 15.;

1696 
	`ev_tim”_agaš
(
loİ_
, &
tim”_
);

1698 ià(!
cÚfig
.
qu›t
) {

1699 
¡d
::
û¼
 << "Closšg…”iod ha ¡¬‹d" << std::
’dl
;

1702 
£ndbuf_
.
	`»£t
();

1703 
	`as£¹
(
£ndbuf_
.
	`Ëá
(è>ğ
max_pk’_
);

1705 
cÚn_şo£buf_
 = 
¡d
::
make_unique
<
Bufãr
>(
NGTCP2_MAX_PKTLEN_IPV4
);

1707 
ušt16_t
 
”r_code
;

1708 ià(
s_®”t_
) {

1709 
”r_code
 = 
NGTCP2_CRYPTO_ERROR
 | 
s_®”t_
;

1711 
”r_code
 = 
	`ngtı2_”r_šãr_quic_Œª¥Üt_”rÜ_code
(
lib”r
);

1714 autØ
n
 = 
	`ngtı2_cÚn_wr™e_cÚÃùiÚ_şo£
(

1715 
cÚn_
, 
nuÎ±r
, 
cÚn_şo£buf_
->
	`wpos
(), 
max_pk’_
, 
”r_code
,

1716 
ut
::
	`time¡amp
(
loİ_
));

1717 ià(
n
 < 0) {

1718 
¡d
::
û¼
 << "ngtı2_cÚn_wr™e_cÚÃùiÚ_şo£: " << 
	`ngtı2_¡»¼Ü
(
n
)

1719 << 
¡d
::
’dl
;

1723 
cÚn_şo£buf_
->
	`push
(
n
);

1726 
	}
}

1728 
	gHªdËr
::
	$hªdË_”rÜ
(
lib”r
) {

1729 
rv
;

1731 
rv
 = 
	`¡¬t_şosšg_³riod
(
lib”r
);

1732 ià(
rv
 != 0) {

1736 
rv
 = 
	`£nd_cÚn_şo£
();

1737 ià(
rv
 !ğ
NETWORK_ERR_OK
) {

1738  
rv
;

1741  
NETWORK_ERR_CLOSE_WAIT
;

1742 
	}
}

1744 
	gHªdËr
::
	$£nd_cÚn_şo£
() {

1745 ià(!
cÚfig
.
qu›t
) {

1746 
¡d
::
û¼
 << "Closšg P”iod: TX CONNECTION_CLOSE" << std::
’dl
;

1749 
	`as£¹
(
cÚn_şo£buf_
 && cÚn_şo£buf_->
	`size
());

1751 ià(
£ndbuf_
.
	`size
() == 0) {

1752 
¡d
::
	`cİy_n
(
cÚn_şo£buf_
->
	`½os
(), cÚn_şo£buf_->
	`size
(),

1753 
£ndbuf_
.
	`wpos
());

1754 
£ndbuf_
.
	`push
(
cÚn_şo£buf_
->
	`size
());

1757  
£rv”_
->
	`£nd_·ck‘
(
»mÙe_addr_
, 
£ndbuf_
);

1758 
	}
}

1760 
	gHªdËr
::
	$scheduË_»Œªsm™
() {

1761 autØ
expœy
 = 
¡d
::
	`mš
(
	`ngtı2_cÚn_loss_d‘eùiÚ_expœy
(
cÚn_
),

1762 
	`ngtı2_cÚn_ack_d–ay_expœy
(
cÚn_
));

1763 autØ
now
 = 
ut
::
	`time¡amp
(
loİ_
);

1764 autØ
t
 = 
expœy
 < 
now
 ? 1e-9

1765 : 
¡©ic_ÿ¡
<
ev_t¡amp
>(
expœy
 - 
now
è/ 
NGTCP2_SECONDS
;

1766 
¹tim”_
.
»³©
 = 
t
;

1767 
	`ev_tim”_agaš
(
loİ_
, &
¹tim”_
);

1768 
	}
}

1770 
	gHªdËr
::
	$»cv_¡»am_d©a
(
ušt64_t
 
¡»am_id
, 
ušt8_t
 
fš
,

1771 cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
) {

1772 
rv
;

1774 ià(!
cÚfig
.
qu›t
) {

1775 
debug
::
	`´št_¡»am_d©a
(
¡»am_id
, 
d©a
, 
d©®’
);

1778 autØ
™
 = 
¡»ams_
.
	`fšd
(
¡»am_id
);

1779 ià(
™
 =ğ
¡d
::
	`’d
(
¡»ams_
)) {

1780 
™
 = 
¡»ams_
.
	`em¶aû
(
¡»am_id
, 
¡d
::
make_unique
<
SŒ—m
>(¡»am_id)).
fœ¡
;

1783 autØ&
¡»am
 = (*
™
).
£cÚd
;

1785 
	`ngtı2_cÚn_ex‹nd_max_¡»am_off£t
(
cÚn_
, 
¡»am_id
, 
d©®’
);

1786 
	`ngtı2_cÚn_ex‹nd_max_off£t
(
cÚn_
, 
d©®’
);

1788 ià(
¡»am
->
	`»cv_d©a
(
fš
, 
d©a
, 
d©®’
) != 0) {

1789 ià(
¡»am
->
»¥_¡©e
 =ğ
RESP_IDLE
) {

1790 
¡»am
->
	`£nd_¡©us_»¥Ú£
(400);

1791 
rv
 = 
	`ngtı2_cÚn_shutdown_¡»am_»ad
(
cÚn_
, 
¡»am_id
, 
NGTCP2_APP_PROTO
);

1792 ià(
rv
 != 0) {

1793 
¡d
::
û¼
 << "ngtı2_cÚn_shutdown_¡»am_»ad: " << 
	`ngtı2_¡»¼Ü
(
rv
)

1794 << 
¡d
::
’dl
;

1798 
rv
 = 
	`ngtı2_cÚn_shutdown_¡»am
(
cÚn_
, 
¡»am_id
, 
NGTCP2_APP_PROTO
);

1799 ià(
rv
 != 0) {

1800 
¡d
::
û¼
 << "ngtı2_cÚn_shutdown_¡»am: " << 
	`ngtı2_¡»¼Ü
(
rv
)

1801 << 
¡d
::
’dl
;

1808 
	}
}

1810 
	gHªdËr
::
	$upd©e_key
() {

1811 
rv
;

1812 
¡d
::
¬¿y
<
ušt8_t
, 64> 
£ü‘
, 
key
, 
iv
;

1814 ++
nkey_upd©e_
;

1816 autØ
£ü‘Ën
 = 
üy±o
::
	`upd©e_Œaffic_£ü‘
(

1817 
£ü‘
.
	`d©a
(), seü‘.
	`size
(), 
tx_£ü‘_
.data(),x_secret_.size(),

1818 
üy±o_ùx_
);

1819 ià(
£ü‘Ën
 < 0) {

1823 
tx_£ü‘_
.
	`assign
(
¡d
::
	`begš
(
£ü‘
), std::
	`’d
(secret));

1825 autØ
keyËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_key
(

1826 
key
.
	`d©a
(), key.
	`size
(), 
£ü‘
.d©a(), 
£ü‘Ën
, 
üy±o_ùx_
);

1827 ià(
keyËn
 < 0) {

1831 autØ
ivËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_iv
(

1832 
iv
.
	`d©a
(), iv.
	`size
(), 
£ü‘
.d©a(), 
£ü‘Ën
, 
üy±o_ùx_
);

1833 ià(
ivËn
 < 0) {

1837 
rv
 = 
	`ngtı2_cÚn_upd©e_tx_key
(
cÚn_
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.d©a(), 
ivËn
);

1838 ià(
rv
 != 0) {

1839 
¡d
::
û¼
 << "ngtı2_cÚn_upd©e_tx_key: " << 
	`ngtı2_¡»¼Ü
(
rv
)

1840 << 
¡d
::
’dl
;

1844 ià(!
cÚfig
.
qu›t
) {

1845 
¡d
::
û¼
 << "£rv”_­¶iÿtiÚ_Œaffiø" << 
nkey_upd©e_
 << std::
’dl
;

1846 
debug
::
	`´št_£ü‘s
(
£ü‘
.
	`d©a
(), 
£ü‘Ën
, 
key
.d©a(), 
keyËn
,

1847 
iv
.
	`d©a
(), 
ivËn
);

1850 
£ü‘Ën
 = 
üy±o
::
	`upd©e_Œaffic_£ü‘
(
£ü‘
.
	`d©a
(), seü‘.
	`size
(),

1851 
rx_£ü‘_
.
	`d©a
(),

1852 
rx_£ü‘_
.
	`size
(), 
üy±o_ùx_
);

1853 ià(
£ü‘Ën
 < 0) {

1857 
rx_£ü‘_
.
	`assign
(
¡d
::
	`begš
(
£ü‘
), std::
	`’d
(secret));

1859 
keyËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_key
(

1860 
key
.
	`d©a
(), key.
	`size
(), 
£ü‘
.d©a(), 
£ü‘Ën
, 
üy±o_ùx_
);

1861 ià(
keyËn
 < 0) {

1865 
ivËn
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_iv
(

1866 
iv
.
	`d©a
(), iv.
	`size
(), 
£ü‘
.d©a(), 
£ü‘Ën
, 
üy±o_ùx_
);

1867 ià(
ivËn
 < 0) {

1871 
rv
 = 
	`ngtı2_cÚn_upd©e_rx_key
(
cÚn_
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.d©a(), 
ivËn
);

1872 ià(
rv
 != 0) {

1873 
¡d
::
û¼
 << "ngtı2_cÚn_upd©e_rx_key: " << 
	`ngtı2_¡»¼Ü
(
rv
)

1874 << 
¡d
::
’dl
;

1878 ià(!
cÚfig
.
qu›t
) {

1879 
¡d
::
û¼
 << "ş›Á_­¶iÿtiÚ_Œaffiø" << 
nkey_upd©e_
 << std::
’dl
;

1880 
debug
::
	`´št_£ü‘s
(
£ü‘
.
	`d©a
(), 
£ü‘Ën
, 
key
.d©a(), 
keyËn
,

1881 
iv
.
	`d©a
(), 
ivËn
);

1885 
	}
}

1887 cÚ¡ 
ngtı2_cid
 *
	gHªdËr
::
	$scid
(ècÚ¡ {  &
scid_
; 
	}
}

1889 cÚ¡ 
ngtı2_cid
 *
	gHªdËr
::
	$rcid
(ècÚ¡ {  &
rcid_
; 
	}
}

1891 
S”v”
 *
	gHªdËr
::
	$£rv”
(ècÚ¡ {  
£rv”_
; 
	}
}

1893 cÚ¡ 
	gAdd»ss
 &
	gHªdËr
::
	$»mÙe_addr
(ècÚ¡ {  
»mÙe_addr_
; 
	}
}

1895 
ngtı2_cÚn
 *
	gHªdËr
::
	$cÚn
(ècÚ¡ {  
cÚn_
; 
	}
}

1897 
	gÇme¥aû
 {

1898 
size_t
 
»move_tx_¡»am_d©a
(
¡d
::
deque
<
Bufãr
> &
d
, size_ˆ&
idx
,

1899 
ušt64_t
 &
tx_off£t
, ušt64_ˆ
off£t
) {

1900 
size_t
 
	gËn
 = 0;

1901 ; !
	gd
.
em±y
(è&& 
	gtx_off£t
 + d.
äÚt
().
bufsize
(è<ğ
off£t
;) {

1902 --
	gidx
;

1903 autØ&
	gv
 = 
d
.
äÚt
();

1904 
	gËn
 +ğ
v
.
bufsize
();

1905 
	gtx_off£t
 +ğ
v
.
bufsize
();

1906 
	gd
.
pİ_äÚt
();

1908  
	gËn
;

1912 
	gHªdËr
::
	$»move_tx_üy±o_d©a
(
ušt64_t
 
off£t
, 
size_t
 
d©®’
) {

1913 ::
	`»move_tx_¡»am_d©a
(
shªdshake_
, 
shªdshake_idx_
, 
tx_üy±o_off£t_
,

1914 
off£t
 + 
d©®’
);

1915 
	}
}

1917 
	gHªdËr
::
	$»move_tx_¡»am_d©a
(
ušt64_t
 
¡»am_id
, ušt64_ˆ
off£t
,

1918 
size_t
 
d©®’
) {

1919 
rv
;

1921 autØ
™
 = 
¡»ams_
.
	`fšd
(
¡»am_id
);

1922 
	`as£¹
(
™
 !ğ
¡d
::
	`’d
(
¡»ams_
));

1923 autØ&
¡»am
 = (*
™
).
£cÚd
;

1924 ::
	`»move_tx_¡»am_d©a
(
¡»am
->
¡»ambuf
, sŒ—m->
¡»ambuf_idx
,

1925 
¡»am
->
tx_¡»am_off£t
, 
off£t
 + 
d©®’
);

1927 ià(
¡»am
->
¡»ambuf
.
	`em±y
(è&& sŒ—m->
»¥_¡©e
 =ğ
RESP_COMPLETED
) {

1928 
rv
 = 
	`ngtı2_cÚn_shutdown_¡»am_»ad
(
cÚn_
, 
¡»am_id
, 
NGTCP2_APP_NOERROR
);

1929 ià(
rv
 !ğ0 &&„v !ğ
NGTCP2_ERR_STREAM_NOT_FOUND
) {

1930 
¡d
::
û¼
 << "ngtı2_cÚn_shutdown_¡»am_»ad: " << 
	`ngtı2_¡»¼Ü
(
rv
)

1931 << 
¡d
::
’dl
;

1937 
	}
}

1939 
	gHªdËr
::
	$£nd_g»‘šg
() {

1940 
rv
;

1941 
ušt64_t
 
¡»am_id
;

1943 
rv
 = 
	`ngtı2_cÚn_İ’_uni_¡»am
(
cÚn_
, &
¡»am_id
, 
nuÎ±r
);

1944 ià(
rv
 != 0) {

1948 autØ
¡»am
 = 
¡d
::
make_unique
<
SŒ—m
>(
¡»am_id
);

1950 
cÚ¡ex´
 
ušt8_t
 
hw
[] = "Hello World!";

1951 
¡»am
->
¡»ambuf
.
	`em¶aû_back
(
hw
, 
	`¡r_size
(hw));

1952 
¡»am
->
should_£nd_fš
 = 
Œue
;

1953 
¡»am
->
»¥_¡©e
 = 
RESP_COMPLETED
;

1955 
¡»ams_
.
	`em¶aû
(
¡»am_id
, 
¡d
::
	`move
(
¡»am
));

1958 
	}
}

1960 
	gHªdËr
::
	$Ú_¡»am_şo£
(
ušt64_t
 
¡»am_id
) {

1961 autØ
™
 = 
¡»ams_
.
	`fšd
(
¡»am_id
);

1962 
	`as£¹
(
™
 !ğ
¡d
::
	`’d
(
¡»ams_
));

1963 
¡»ams_
.
	`”a£
(
™
);

1964 
	}
}

1966 
	gHªdËr
::
	$£t_s_®”t
(
ušt8_t
 
®”t
è{ 
s_®”t_
 =‡Ë¹; 
	}
}

1968 
	gÇme¥aû
 {

1969 
swr™ecb
(
ev_loİ
 *
loİ
, 
ev_io
 *
w
, 
»v’ts
) {

1970 
ev_io_¡İ
(
loİ
, 
w
);

1972 autØ
	gs
 = 
¡©ic_ÿ¡
<
S”v”
 *>(
w
->
d©a
);

1974 autØ
	grv
 = 
s
->
Ú_wr™e
();

1975 ià(
	grv
 != 0) {

1976 ià(
rv
 =ğ
NETWORK_ERR_SEND_NON_FATAL
) {

1977 
s
->
¡¬t_wev
();

1983 
	gÇme¥aû
 {

1984 
¤—dcb
(
ev_loİ
 *
loİ
, 
ev_io
 *
w
, 
»v’ts
) {

1985 autØ
	gs
 = 
¡©ic_ÿ¡
<
S”v”
 *>(
w
->
d©a
);

1987 
	gs
->
Ú_»ad
();

1991 
	gÇme¥aû
 {

1992 
sigšthªdËr
(
ev_loİ
 *
loİ
, 
ev_sigÇl
 *
w©ch”
, 
»v’ts
) {

1993 
ev_b»ak
(
loİ
, 
EVBREAK_ALL
);

1997 
	gS”v”
::
	$S”v”
(
ev_loİ
 *
loİ
, 
SSL_CTX
 *
s¦_ùx
)

1998 : 
	`loİ_
(
loİ
), 
	`s¦_ùx_
(
s¦_ùx
), 
tok’_üy±o_ùx_
{
	}
}, 
fd_
(-1) {

1999 
ev_io_š™
(&
wev_
, 
swr™ecb
, 0, 
EV_WRITE
);

2000 
ev_io_š™
(&
»v_
, 
¤—dcb
, 0, 
EV_READ
);

2001 
	gwev_
.
	gd©a
 = 
this
;

2002 
	g»v_
.
	gd©a
 = 
this
;

2003 
ev_sigÇl_š™
(&
sigš‹v_
, 
sigšthªdËr
, 
SIGINT
);

2005 
	güy±o
::
«ad_«s_128_gcm
(
tok’_üy±o_ùx_
);

2006 
	güy±o
::
´f_sha256
(
tok’_üy±o_ùx_
);

2008 autØ
	gdis
 = 
¡d
::
unifÜm_št_di¡ributiÚ
<
ušt8_t
>(0, 255);

2009 
	g¡d
::
g’”©e
(
¡d
::
begš
(
tok’_£ü‘_
), std::
’d
(token_secret_),

2010 [&
dis
](è{  dis(
¿ndg’
); });

2013 
	gS”v”
::~
	$S”v”
() {

2014 
	`discÚÃù
();

2015 
	`şo£
();

2016 
	}
}

2018 
	gS”v”
::
	$discÚÃù
(è{ 
	`discÚÃù
(0); 
	}
}

2020 
	gS”v”
::
	$discÚÃù
(
lib”r
) {

2021 
cÚfig
.
tx_loss_´ob
 = 0;

2023 
	`ev_io_¡İ
(
loİ_
, &
»v_
);

2025 
	`ev_sigÇl_¡İ
(
loİ_
, &
sigš‹v_
);

2027 !
hªdËrs_
.
	`em±y
()) {

2028 autØ
™
 = 
¡d
::
	`begš
(
hªdËrs_
);

2029 autØ&
h
 = (*
™
).
£cÚd
;

2031 
h
->
	`hªdË_”rÜ
(0);

2033 
	`»move
(
™
);

2035 
	}
}

2037 
	gS”v”
::
	$şo£
() {

2038 
	`ev_io_¡İ
(
loİ_
, &
wev_
);

2040 ià(
fd_
 != -1) {

2041 ::
	`şo£
(
fd_
);

2042 
fd_
 = -1;

2044 
	}
}

2046 
	gS”v”
::
	$š™
(
fd
, cÚ¡ 
Add»ss
 &
loÿl_addr
) {

2047 
loÿl_addr_
 = 
loÿl_addr
;

2048 
fd_
 = 
fd
;

2050 
	`ev_io_£t
(&
wev_
, 
fd_
, 
EV_WRITE
);

2051 
	`ev_io_£t
(&
»v_
, 
fd_
, 
EV_READ
);

2053 
	`ev_io_¡¬t
(
loİ_
, &
»v_
);

2055 
	`ev_sigÇl_¡¬t
(
loİ_
, &
sigš‹v_
);

2058 
	}
}

2060 
	gS”v”
::
	$Ú_wr™e
() {

2061 autØ
™
 = 
¡d
::
	`cbegš
(
hªdËrs_
); iˆ!ğ¡d::
	`ûnd
(handlers_);) {

2062 autØ
h
 = 
™
->
£cÚd
.
	`g‘
();

2063 autØ
rv
 = 
h
->
	`Ú_wr™e
();

2064 
rv
) {

2066 
NETWORK_ERR_CLOSE_WAIT
:

2067 ++
™
;

2069 
NETWORK_ERR_SEND_NON_FATAL
:

2070  
NETWORK_ERR_SEND_NON_FATAL
;

2072 
™
 = 
	`»move
(it);

2075  
NETWORK_ERR_OK
;

2076 
	}
}

2078 
	gS”v”
::
	$Ú_»ad
() {

2079 
sockaddr_uniÚ
 
su
;

2080 
sockËn_t
 
add¾’
;

2081 
¡d
::
¬¿y
<
ušt8_t
, 64
_k
> 
buf
;

2082 
rv
;

2083 
ngtı2_pkt_hd
 
hd
;

2085 
Œue
) {

2086 
add¾’
 = (
su
);

2087 autØ
Ä—d
 =

2088 
	`»cväom
(
fd_
, 
buf
.
	`d©a
(), buf.
	`size
(), 
MSG_DONTWAIT
, &
su
.
§
, &
add¾’
);

2089 ià(
Ä—d
 == -1) {

2090 ià(!(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
ENOTCONN
)) {

2091 
¡d
::
û¼
 << "»cväom: " << 
	`¡»¼Ü
(
”ºo
è<< std::
’dl
;

2096 ià(!
cÚfig
.
qu›t
) {

2097 
¡d
::
û¼
 << "Reûived…ack‘ from " << 
ut
::
	`¡¿ddr
(&
su
.
§
, 
add¾’
)

2098 << 
¡d
::
’dl
;

2101 ià(
debug
::
	`·ck‘_lo¡
(
cÚfig
.
rx_loss_´ob
)) {

2102 ià(!
cÚfig
.
qu›t
) {

2103 
¡d
::
û¼
 << "** SimuÏ‹d incomšg…ack‘†os **" << std::
’dl
;

2108 ià(
Ä—d
 == 0) {

2112 ià(
buf
[0] & 0x80) {

2113 
rv
 = 
	`ngtı2_pkt_decode_hd_lÚg
(&
hd
, 
buf
.
	`d©a
(), 
Ä—d
);

2116 
rv
 =

2117 
	`ngtı2_pkt_decode_hd_shÜt
(&
hd
, 
buf
.
	`d©a
(), 
Ä—d
, 
NGTCP2_SV_SCIDLEN
);

2119 ià(
rv
 < 0) {

2120 
¡d
::
û¼
 << "Could‚ot decode QUIC…acket header: "

2121 << 
	`ngtı2_¡»¼Ü
(
rv
è<< 
¡d
::
’dl
;

2125 autØ
dcid_key
 = 
ut
::
	`make_cid_key
(&
hd
.
dcid
);

2127 autØ
hªdËr_™
 = 
hªdËrs_
.
	`fšd
(
dcid_key
);

2128 ià(
hªdËr_™
 =ğ
¡d
::
	`’d
(
hªdËrs_
)) {

2129 autØ
ùos_™
 = 
ùos_
.
	`fšd
(
dcid_key
);

2130 ià(
ùos_™
 =ğ
¡d
::
	`’d
(
ùos_
)) {

2131 
rv
 = 
	`ngtı2_acû±
(&
hd
, 
buf
.
	`d©a
(), 
Ä—d
);

2132 ià(
rv
 == -1) {

2133 ià(!
cÚfig
.
qu›t
) {

2134 
¡d
::
û¼
 << "UÃx³ùed…ack‘„eûived:†’gth=" << 
Ä—d


2135 << 
¡d
::
’dl
;

2140 ià(
rv
 == 1) {

2141 ià(!
cÚfig
.
qu›t
) {

2142 
¡d
::
û¼
 << "Unsupported version: Send Version Negotiation"

2143 << 
¡d
::
’dl
;

2145 
	`£nd_v”siÚ_ÃgÙŸtiÚ
(&
hd
, &
su
.
§
, 
add¾’
);

2149 
ngtı2_cid
 
ocid
;

2150 
ngtı2_cid
 *
pocid
 = 
nuÎ±r
;

2151 ià(
cÚfig
.
v®id©e_addr
 && 
hd
.
ty³
 =ğ
NGTCP2_PKT_INITIAL
) {

2152 
¡d
::
û¼
 << "P”fÜm s‹Ës add»s v®id©iÚ" << std::
’dl
;

2153 ià(
hd
.
tok’Ën
 == 0 ||

2154 
	`v”ify_tok’
(&
ocid
, &
hd
, &
su
.
§
, 
add¾’
) != 0) {

2155 
	`£nd_»Œy
(&
hd
, &
su
.
§
, 
add¾’
);

2158 
pocid
 = &
ocid
;

2161 autØ
h
 = 
¡d
::
make_unique
<
HªdËr
>(
loİ_
, 
s¦_ùx_
, 
this
, &
hd
.
dcid
);

2162 
h
->
	`š™
(
fd_
, &
su
.
§
, 
add¾’
, &
hd
.
scid
, 
pocid
, hd.
v”siÚ
);

2164 ià(
h
->
	`Ú_»ad
(&
su
.
§
, 
add¾’
, 
buf
.
	`d©a
(), 
Ä—d
) != 0) {

2167 
rv
 = 
h
->
	`Ú_wr™e
();

2168 
rv
) {

2171 
NETWORK_ERR_SEND_NON_FATAL
:

2172 
	`¡¬t_wev
();

2178 autØ
scid
 = 
h
->
	`scid
();

2179 autØ
scid_key
 = 
ut
::
	`make_cid_key
(
scid
);

2180 
hªdËrs_
.
	`em¶aû
(
scid_key
, 
¡d
::
	`move
(
h
));

2181 
ùos_
.
	`em¶aû
(
dcid_key
, 
scid_key
);

2184 ià(!
cÚfig
.
qu›t
) {

2185 
¡d
::
û¼
 << "FÜw¬d CID=" << 
ut
::
	`fÜm©_hex
((*
ùos_™
).
fœ¡
)

2186 << "ØCID=" << 
ut
::
	`fÜm©_hex
((*
ùos_™
).
£cÚd
)

2187 << 
¡d
::
’dl
;

2189 
hªdËr_™
 = 
hªdËrs_
.
	`fšd
((*
ùos_™
).
£cÚd
);

2190 
	`as£¹
(
hªdËr_™
 !ğ
¡d
::
	`’d
(
hªdËrs_
));

2193 autØ
h
 = (*
hªdËr_™
).
£cÚd
.
	`g‘
();

2194 ià(
	`ngtı2_cÚn_is_š_şosšg_³riod
(
h
->
	`cÚn
())) {

2196 
rv
 = 
h
->
	`£nd_cÚn_şo£
();

2197 
rv
) {

2199 
NETWORK_ERR_SEND_NON_FATAL
:

2202 
	`»move
(
hªdËr_™
);

2206 ià(
h
->
	`d¿ššg
()) {

2210 
rv
 = 
h
->
	`Ú_»ad
(&
su
.
§
, 
add¾’
, 
buf
.
	`d©a
(), 
Ä—d
);

2211 ià(
rv
 != 0) {

2212 ià(
rv
 !ğ
NETWORK_ERR_CLOSE_WAIT
) {

2213 
	`»move
(
hªdËr_™
);

2218 
rv
 = 
h
->
	`Ú_wr™e
();

2219 
rv
) {

2221 
NETWORK_ERR_CLOSE_WAIT
:

2223 
NETWORK_ERR_SEND_NON_FATAL
:

2224 
	`¡¬t_wev
();

2227 
	`»move
(
hªdËr_™
);

2231 
	}
}

2233 
	gÇme¥aû
 {

2234 
ušt32_t
 
g’”©e_»£rved_v”siÚ
(cÚ¡ 
sockaddr
 *
§
, 
sockËn_t
 
§Ën
,

2235 
ušt32_t
 
v”siÚ
) {

2236 
ušt32_t
 
	gh
 = 0x811C9DC5u;

2237 cÚ¡ 
ušt8_t
 *
	gp
 = (cÚ¡ ušt8_ˆ*)
§
;

2238 cÚ¡ 
ušt8_t
 *
	g•
 = 
p
 + 
§Ën
;

2239 ; 
	gp
 !ğ
•
; ++p) {

2240 
	gh
 ^ğ*
p
;

2241 
	gh
 *= 0x01000193u;

2243 
	gv”siÚ
 = 
htÚl
(
v”siÚ
);

2244 
	gp
 = (cÚ¡ 
ušt8_t
 *)&
v”siÚ
;

2245 
	g•
 = 
p
 + (
v”siÚ
);

2246 ; 
	gp
 !ğ
•
; ++p) {

2247 
	gh
 ^ğ*
p
;

2248 
	gh
 *= 0x01000193u;

2250 
	gh
 &= 0xf0f0f0f0u;

2251 
	gh
 |= 0x0a0a0a0au;

2252  
	gh
;

2256 
	gS”v”
::
	$£nd_v”siÚ_ÃgÙŸtiÚ
(cÚ¡ 
ngtı2_pkt_hd
 *
chd
,

2257 cÚ¡ 
sockaddr
 *
§
, 
sockËn_t
 
§Ën
) {

2258 
Bufãr
 
buf
{
NGTCP2_MAX_PKTLEN_IPV4
};

2259 
¡d
::
¬¿y
<
ušt32_t
, 2> 
sv
;

2261 
sv
[0] = 
	`g’”©e_»£rved_v”siÚ
(
§
, 
§Ën
, 
chd
->
v”siÚ
);

2262 
sv
[1] = 
NGTCP2_PROTO_VER_D17
;

2264 autØ
nwr™e
 = 
	`ngtı2_pkt_wr™e_v”siÚ_ÃgÙŸtiÚ
(

2265 
buf
.
	`wpos
(), buf.
	`Ëá
(),

2266 
¡d
::
unifÜm_št_di¡ributiÚ
<
ušt8_t
>(

2267 0, 
¡d
::
num”ic_lim™s
<
ušt8_t
>::
	`max
())(
¿ndg’
),

2268 &
chd
->
scid
, &chd->
dcid
, 
sv
.
	`d©a
(), sv.
	`size
());

2269 ià(
nwr™e
 < 0) {

2270 
¡d
::
û¼
 << "ngtcp2_pkt_write_version_negotiation: "

2271 << 
	`ngtı2_¡»¼Ü
(
nwr™e
è<< 
¡d
::
’dl
;

2275 
buf
.
	`push
(
nwr™e
);

2277 
Add»ss
 
»mÙe_addr
;

2278 
»mÙe_addr
.
Ën
 = 
§Ën
;

2279 
	`memıy
(&
»mÙe_addr
.
su
.
§
, sa, 
§Ën
);

2281 ià(
	`£nd_·ck‘
(
»mÙe_addr
, 
buf
è!ğ
NETWORK_ERR_OK
) {

2286 
	}
}

2288 
	gS”v”
::
	$£nd_»Œy
(cÚ¡ 
ngtı2_pkt_hd
 *
chd
, cÚ¡ 
sockaddr
 *
§
,

2289 
sockËn_t
 
§Ën
) {

2290 
¡d
::
¬¿y
<, 
NI_MAXHOST
> 
ho¡
;

2291 
¡d
::
¬¿y
<, 
NI_MAXSERV
> 
pÜt
;

2292 
rv
;

2294 
rv
 = 
	`g‘Çmešfo
(
§
, 
§Ën
, 
ho¡
.
	`d©a
(), ho¡.
	`size
(), 
pÜt
.data(),

2295 
pÜt
.
	`size
(), 
NI_NUMERICHOST
 | 
NI_NUMERICSERV
);

2296 ià(
rv
 != 0) {

2297 
¡d
::
û¼
 << "g‘Çmešfo: " << 
	`gai_¡»¼Ü
(
rv
è<< std::
’dl
;

2301 ià(!
cÚfig
.
qu›t
) {

2302 
¡d
::
û¼
 << "S’dšg R‘ry…ack‘Ø[" << 
ho¡
.
	`d©a
()

2303 << "]:" << 
pÜt
.
	`d©a
(è<< 
¡d
::
’dl
;

2306 
¡d
::
¬¿y
<
ušt8_t
, 256> 
tok’
;

2307 
size_t
 
tok’Ën
 = 
tok’
.
	`size
();

2309 ià(
	`g’”©e_tok’
(
tok’
.
	`d©a
(), 
tok’Ën
, 
§
, 
§Ën
, &
chd
->
dcid
) != 0) {

2313 ià(!
cÚfig
.
qu›t
) {

2314 
¡d
::
û¼
 << "G’”©ed‡dd»s v®id©iÚok’:" << std::
’dl
;

2315 
ut
::
	`hexdump
(
¡d”r
, 
tok’
.
	`d©a
(), 
tok’Ën
);

2318 
Bufãr
 
buf
{
NGTCP2_MAX_PKTLEN_IPV4
};

2319 
ngtı2_pkt_hd
 
hd
;

2321 
hd
.
v”siÚ
 = 
chd
->version;

2322 
hd
.
æags
 = 
NGTCP2_PKT_FLAG_LONG_FORM
;

2323 
hd
.
ty³
 = 
NGTCP2_PKT_RETRY
;

2324 
hd
.
pkt_num
 = 0;

2325 
hd
.
tok’
 = 
NULL
;

2326 
hd
.
tok’Ën
 = 0;

2327 
hd
.
Ën
 = 0;

2328 
hd
.
dcid
 = 
chd
->
scid
;

2329 
hd
.
scid
.
d©®’
 = 
NGTCP2_SV_SCIDLEN
;

2330 autØ
dis
 = 
¡d
::
unifÜm_št_di¡ributiÚ
<
ušt8_t
>(0, 255);

2331 
¡d
::
	`g’”©e
(
hd
.
scid
.
d©a
, hd.scid.d©¨+ hd.scid.
d©®’
,

2332 [&
dis
](è{  
	`dis
(
¿ndg’
); });

2334 autØ
nwr™e
 = 
	`ngtı2_pkt_wr™e_»Œy
(
buf
.
	`wpos
(), buf.
	`Ëá
(), &
hd
, &
chd
->
dcid
,

2335 
tok’
.
	`d©a
(), 
tok’Ën
);

2336 ià(
nwr™e
 < 0) {

2337 
¡d
::
û¼
 << "ngtı2_pkt_wr™e_»Œy: " << 
	`ngtı2_¡»¼Ü
(
nwr™e
)

2338 << 
¡d
::
’dl
;

2342 
buf
.
	`push
(
nwr™e
);

2344 
Add»ss
 
»mÙe_addr
;

2345 
»mÙe_addr
.
Ën
 = 
§Ën
;

2346 
	`memıy
(&
»mÙe_addr
.
su
.
§
, sa, 
§Ën
);

2348 ià(
	`£nd_·ck‘
(
»mÙe_addr
, 
buf
è!ğ
NETWORK_ERR_OK
) {

2353 
	}
}

2355 
	gS”v”
::
	$d”ive_tok’_key
(
ušt8_t
 *
key
, 
size_t
 &
keyËn
, ušt8_ˆ*
iv
,

2356 
size_t
 &
ivËn
, cÚ¡ 
ušt8_t
 *
¿nd_d©a
,

2357 
size_t
 
¿nd_d©®’
) {

2358 
¡d
::
¬¿y
<
ušt8_t
, 32> 
£ü‘
;

2360 ià(
üy±o
::
	`hkdf_exŒaù
(
£ü‘
.
	`d©a
(), seü‘.
	`size
(), 
tok’_£ü‘_
.data(),

2361 
tok’_£ü‘_
.
	`size
(), 
¿nd_d©a
, 
¿nd_d©®’
,

2362 
tok’_üy±o_ùx_
) != 0) {

2366 autØ
¦’
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_key
(

2367 
key
, 
keyËn
, 
£ü‘
.
	`d©a
(), seü‘.
	`size
(), 
tok’_üy±o_ùx_
);

2368 ià(
¦’
 < 0) {

2371 
keyËn
 = 
¦’
;

2373 
¦’
 = 
üy±o
::
	`d”ive_·ck‘_´ÙeùiÚ_iv
(
iv
, 
ivËn
, 
£ü‘
.
	`d©a
(),

2374 
£ü‘
.
	`size
(), 
tok’_üy±o_ùx_
);

2375 ià(
¦’
 < 0) {

2378 
ivËn
 = 
¦’
;

2381 
	}
}

2383 
	gS”v”
::
	$g’”©e_¿nd_d©a
(
ušt8_t
 *
buf
, 
size_t
 
Ën
) {

2384 
¡d
::
¬¿y
<
ušt8_t
, 16> 
¿nd
;

2385 
¡d
::
¬¿y
<
ušt8_t
, 32> 
md
;

2386 autØ
dis
 = 
¡d
::
unifÜm_št_di¡ributiÚ
<
ušt8_t
>(0, 255);

2387 
¡d
::
	`g’”©e_n
(
¿nd
.
	`d©a
(),„ªd.
	`size
(), [&
dis
](è{  
	`dis
(
¿ndg’
); });

2388 ià(
üy±o
::
	`mes§ge_dige¡
(
md
.
	`d©a
(), 
	`EVP_sha256
(), 
¿nd
.data(),

2389 
¿nd
.
	`size
()) != 0) {

2392 
	`as£¹
(
Ën
 <ğ
md
.
	`size
());

2393 
¡d
::
	`cİy_n
(¡d::
	`begš
(
md
), 
Ën
, 
buf
);

2395 
	}
}

2397 
	gS”v”
::
	$g’”©e_tok’
(
ušt8_t
 *
tok’
, 
size_t
 &
tok’Ën
, cÚ¡ 
sockaddr
 *
§
,

2398 
sockËn_t
 
§Ën
, cÚ¡ 
ngtı2_cid
 *
ocid
) {

2399 
¡d
::
¬¿y
<
ušt8_t
, 4096> 
¶aš‹xt
;

2401 
ušt64_t
 
t
 = 
¡d
::
chrÚo
::
du¿tiÚ_ÿ¡
<¡d::chrÚo::
Çno£cÚds
>(

2402 
¡d
::
chrÚo
::
sy¡em_şock
::
	`now
().
	`time_sšû_•och
())

2403 .
	`couÁ
();

2405 autØ
p
 = 
¡d
::
	`begš
(
¶aš‹xt
);

2406 
p
 = 
¡d
::
	`cİy_n
(
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
§
), 
§Ën
,…);

2408 
p
 = 
¡d
::
	`cİy_n
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(&
t
), (t),…);

2409 
p
 = 
¡d
::
	`cİy_n
(
ocid
->
d©a
, ocid->
d©®’
,…);

2411 
¡d
::
¬¿y
<
ušt8_t
, 
TOKEN_RAND_DATALEN
> 
¿nd_d©a
;

2412 
¡d
::
¬¿y
<
ušt8_t
, 32> 
key
, 
iv
;

2413 autØ
keyËn
 = 
key
.
	`size
();

2414 autØ
ivËn
 = 
iv
.
	`size
();

2416 ià(
	`g’”©e_¿nd_d©a
(
¿nd_d©a
.
	`d©a
(),„ªd_d©a.
	`size
()) != 0) {

2419 ià(
	`d”ive_tok’_key
(
key
.
	`d©a
(), 
keyËn
, 
iv
.d©a(), 
ivËn
, 
¿nd_d©a
.data(),

2420 
¿nd_d©a
.
	`size
()) != 0) {

2424 autØ
n
 = 
üy±o
::
	`’üy±
(
tok’
, 
tok’Ën
, 
¶aš‹xt
.
	`d©a
(),

2425 
¡d
::
	`di¡ªû
(¡d::
	`begš
(
¶aš‹xt
), 
p
),

2426 
tok’_üy±o_ùx_
, 
key
.
	`d©a
(), 
keyËn
, 
iv
.data(),

2427 
ivËn
, 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
§
), 
§Ën
);

2429 ià(
n
 < 0) {

2433 
	`memıy
(
tok’
 + 
n
, 
¿nd_d©a
.
	`d©a
(),„ªd_d©a.
	`size
());

2435 
tok’Ën
 = 
n
 + 
¿nd_d©a
.
	`size
();

2438 
	}
}

2440 
	gS”v”
::
	$v”ify_tok’
(
ngtı2_cid
 *
ocid
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

2441 cÚ¡ 
sockaddr
 *
§
, 
sockËn_t
 
§Ën
) {

2442 
¡d
::
¬¿y
<, 
NI_MAXHOST
> 
ho¡
;

2443 
¡d
::
¬¿y
<, 
NI_MAXSERV
> 
pÜt
;

2444 
rv
;

2446 
rv
 = 
	`g‘Çmešfo
(
§
, 
§Ën
, 
ho¡
.
	`d©a
(), ho¡.
	`size
(), 
pÜt
.data(),

2447 
pÜt
.
	`size
(), 
NI_NUMERICHOST
 | 
NI_NUMERICSERV
);

2448 ià(
rv
 != 0) {

2449 
¡d
::
û¼
 << "g‘Çmešfo: " << 
	`gai_¡»¼Ü
(
rv
è<< std::
’dl
;

2453 ià(!
cÚfig
.
qu›t
) {

2454 
¡d
::
û¼
 << "V”ifyšgok’ from [" << 
ho¡
.
	`d©a
(è<< "]:" << 
pÜt
.data()

2455 << 
¡d
::
’dl
;

2458 ià(!
cÚfig
.
qu›t
) {

2459 
¡d
::
û¼
 << "Reûived‡dd»s v®id©iÚok’:" << std::
’dl
;

2460 
ut
::
	`hexdump
(
¡d”r
, 
hd
->
tok’
, hd->
tok’Ën
);

2463 ià(
hd
->
tok’Ën
 < 
TOKEN_RAND_DATALEN
) {

2464 ià(!
cÚfig
.
qu›t
) {

2465 
¡d
::
û¼
 << "Tok’ i toØshÜt" << std::
’dl
;

2470 autØ
¿nd_d©a
 = 
hd
->
tok’
 + hd->
tok’Ën
 - 
TOKEN_RAND_DATALEN
;

2471 autØ
ch”‹xt
 = 
hd
->
tok’
;

2472 autØ
ch”‹x’
 = 
hd
->
tok’Ën
 - 
TOKEN_RAND_DATALEN
;

2474 
¡d
::
¬¿y
<
ušt8_t
, 32> 
key
, 
iv
;

2475 autØ
keyËn
 = 
key
.
	`size
();

2476 autØ
ivËn
 = 
iv
.
	`size
();

2478 ià(
	`d”ive_tok’_key
(
key
.
	`d©a
(), 
keyËn
, 
iv
.d©a(), 
ivËn
, 
¿nd_d©a
,

2479 
TOKEN_RAND_DATALEN
) != 0) {

2483 
¡d
::
¬¿y
<
ušt8_t
, 4096> 
¶aš‹xt
;

2485 autØ
n
 = 
üy±o
::
	`deüy±
(
¶aš‹xt
.
	`d©a
(),…Ïš‹xt.
	`size
(), 
ch”‹xt
,

2486 
ch”‹x’
, 
tok’_üy±o_ùx_
, 
key
.
	`d©a
(), 
keyËn
,

2487 
iv
.
	`d©a
(), 
ivËn
,

2488 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
§
), 
§Ën
);

2489 ià(
n
 < 0) {

2490 ià(!
cÚfig
.
qu›t
) {

2491 
¡d
::
û¼
 << "Could‚Ù deüy±ok’" << std::
’dl
;

2496 ià(
¡©ic_ÿ¡
<
size_t
>(
n
è< 
§Ën
 + (
ušt64_t
)) {

2497 ià(!
cÚfig
.
qu›t
) {

2498 
¡d
::
û¼
 << "Badok’ cÚ¡ruùiÚ" << std::
’dl
;

2503 autØ
c
 = 
¡©ic_ÿ¡
<
size_t
>(
n
è- 
§Ën
 - (
ušt64_t
);

2504 ià(
c
 !ğ0 && (c < 
NGTCP2_MIN_CIDLEN
 || c > 
NGTCP2_MAX_CIDLEN
)) {

2505 ià(!
cÚfig
.
qu›t
) {

2506 
¡d
::
û¼
 << "Badok’ cÚ¡ruùiÚ" << std::
’dl
;

2511 ià(
	`memcmp
(
¶aš‹xt
.
	`d©a
(), 
§
, 
§Ën
) != 0) {

2512 ià(!
cÚfig
.
qu›t
) {

2513 
¡d
::
û¼
 << "Cl›Á‡dd»s dÛ nÙ m©ch" << std::
’dl
;

2518 
ušt64_t
 
t
;

2519 
	`memıy
(&
t
, 
¶aš‹xt
.
	`d©a
(è+ 
§Ën
, (
ušt64_t
));

2521 
ušt64_t
 
now
 = 
¡d
::
chrÚo
::
du¿tiÚ_ÿ¡
<¡d::chrÚo::
Çno£cÚds
>(

2522 
¡d
::
chrÚo
::
sy¡em_şock
::
	`now
().
	`time_sšû_•och
())

2523 .
	`couÁ
();

2526 ià(
t
 + 10ULL * 
NGTCP2_SECONDS
 < 
now
) {

2527 ià(!
cÚfig
.
qu›t
) {

2528 
¡d
::
û¼
 << "Tok’ ha b“Àexpœed" << std::
’dl
;

2533 
	`ngtı2_cid_š™
(
ocid
, 
¶aš‹xt
.
	`d©a
(è+ 
§Ën
 + (
ušt64_t
), 
c
);

2536 
	}
}

2538 
	gS”v”
::
	$£nd_·ck‘
(
Add»ss
 &
»mÙe_addr
, 
Bufãr
 &
buf
) {

2539 ià(
debug
::
	`·ck‘_lo¡
(
cÚfig
.
tx_loss_´ob
)) {

2540 ià(!
cÚfig
.
qu›t
) {

2541 
¡d
::
û¼
 << "** SimuÏ‹d outgošg…ack‘†os **" << std::
’dl
;

2543 
buf
.
	`»£t
();

2544  
NETWORK_ERR_OK
;

2547 
ešŒ_»Œ›s
 = 5;

2548 
ssize_t
 
nwr™e
 = 0;

2551 
nwr™e
 = 
	`£ndto
(
fd_
, 
buf
.
	`½os
(), buf.
	`size
(), 0, &
»mÙe_addr
.
su
.
§
,

2552 
»mÙe_addr
.
Ën
);

2553 } (
nwr™e
 =ğ-1è&& (
”ºo
 =ğ
EINTR
è&& (
ešŒ_»Œ›s
-- > 0));

2555 ià(
nwr™e
 == -1) {

2556 
”ºo
) {

2557 
EAGAIN
:

2558 
EINTR
:

2560  
NETWORK_ERR_SEND_NON_FATAL
;

2562 
¡d
::
û¼
 << "£ndto: " << 
	`¡»¼Ü
(
”ºo
è<< std::
’dl
;

2565 
buf
.
	`»£t
();

2566  
NETWORK_ERR_OK
;

2570 
	`as£¹
(
¡©ic_ÿ¡
<
size_t
>(
nwr™e
è=ğ
buf
.
	`size
());

2571 
buf
.
	`»£t
();

2573 ià(!
cÚfig
.
qu›t
) {

2574 
¡d
::
û¼
 << "Sent…acketo "

2575 << 
ut
::
	`¡¿ddr
(&
»mÙe_addr
.
su
.
§
,„emÙe_addr.
Ën
) << " "

2576 << 
nwr™e
 << " by‹s" << 
¡d
::
’dl
;

2579  
NETWORK_ERR_OK
;

2580 
	}
}

2582 
	gS”v”
::
	$assocŸ‹_cid
(cÚ¡ 
ngtı2_cid
 *
cid
, 
HªdËr
 *
h
) {

2583 
ùos_
.
	`em¶aû
(
ut
::
	`make_cid_key
(
cid
), ut::make_cid_key(
h
->
	`scid
()));

2584 
	}
}

2586 
	gS”v”
::
	$dissocŸ‹_cid
(cÚ¡ 
ngtı2_cid
 *
cid
) {

2587 
ùos_
.
	`”a£
(
ut
::
	`make_cid_key
(
cid
));

2588 
	}
}

2590 
	gS”v”
::
	$»move
(cÚ¡ 
HªdËr
 *
h
) {

2591 
ùos_
.
	`”a£
(
ut
::
	`make_cid_key
(
h
->
	`rcid
()));

2593 autØ
cÚn
 = 
h
->
	`cÚn
();

2594 
¡d
::
veùÜ
<
ngtı2_cid
> 
	`cids
(
	`ngtı2_cÚn_g‘_num_scid
(
cÚn
));

2595 
	`ngtı2_cÚn_g‘_scid
(
cÚn
, 
cids
.
	`d©a
());

2597 autØ&
cid
 : 
cids
) {

2598 
ùos_
.
	`”a£
(
ut
::
	`make_cid_key
(&
cid
));

2601 
hªdËrs_
.
	`”a£
(
ut
::
	`make_cid_key
(
h
->
	`scid
()));

2602 
	}
}

2604 
	g¡d
::
m­
<
¡d
::
¡ršg
, std::
unique_±r
<
HªdËr
>>::
cÚ¡_™”©Ü
 
S”v”
::
»move
(

2605 
¡d
::
m­
<¡d::
¡ršg
, std::
unique_±r
<
HªdËr
>>::
cÚ¡_™”©Ü
 
™
) {

2606 
ùos_
.
”a£
(
ut
::
make_cid_key
((*
™
).
£cÚd
->
rcid
()));

2607  
	ghªdËrs_
.
”a£
(
™
);

2610 
	gS”v”
::
	$¡¬t_wev
(è{ 
	`ev_io_¡¬t
(
loİ_
, &
wev_
); 
	}
}

2612 cÚ¡ 
	gAdd»ss
 &
	gS”v”
::
	$g‘_loÿl_addr
(ècÚ¡ {  
loÿl_addr_
; 
	}
}

2614 
	gÇme¥aû
 {

2615 
®²_£Ëù_´Ùo_cb
(
SSL
 *
s¦
, cÚ¡ **
out
,

2616 *
ou’
, cÚ¡ *
š
,

2617 
šËn
, *
¬g
) {

2618 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
SSL_g‘_­p_d©a
(
s¦
));

2619 cÚ¡ 
ušt8_t
 *
	g®²
;

2620 
size_t
 
	g®²Ën
;

2621 autØ
	gv”siÚ
 = 
ngtı2_cÚn_g‘_ÃgÙŸ‹d_v”siÚ
(
h
->
cÚn
());

2623 
	gv”siÚ
) {

2624 
	gNGTCP2_PROTO_VER_D17
:

2625 
®²
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
NGTCP2_ALPN_D17
);

2626 
	g®²Ën
 = 
¡r_size
(
NGTCP2_ALPN_D17
);

2629 ià(!
cÚfig
.
qu›t
) {

2630 
¡d
::
û¼
 << "UÃx³ùed quiø´ÙocŞ v”siÚ: " << std::
hex
 << "0x"

2631 << 
v”siÚ
 << 
¡d
::
’dl
;

2633  
	gSSL_TLSEXT_ERR_NOACK
;

2636 autØ
	gp
 = 
š
, 
	g’d
 = iÀ+ 
šËn
;… + 
	g®²Ën
 <ğ
’d
;… +ğ*
p
 + 1) {

2637 ià(
¡d
::
equ®
(
®²
,‡ÍÀ+ 
®²Ën
, 
p
)) {

2638 *
out
 = 
p
 + 1;

2639 *
	gou’
 = *
p
;

2640  
	gSSL_TLSEXT_ERR_OK
;

2644 *
	gout
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
®²
 + 1);

2645 *
	gou’
 = 
®²
[0];

2647 ià(!
	gcÚfig
.
	gqu›t
) {

2648 
	g¡d
::
û¼
 << "Cl›Á did‚Ù…»£Á ALPN " << 
NGTCP2_ALPN_D17
 + 1

2649 << 
¡d
::
’dl
;

2652  
	gSSL_TLSEXT_ERR_OK
;

2656 
	gÇme¥aû
 {

2657 
Œª¥Üt_·¿ms_add_cb
(
SSL
 *
s¦
, 
ext_ty³
,

2658 
cÚ‹xt
, cÚ¡ **
out
,

2659 
size_t
 *
ou’
, 
X509
 *
x
, size_ˆ
chašidx
, *
®
,

2660 *
add_¬g
) {

2661 
	grv
;

2662 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
SSL_g‘_­p_d©a
(
s¦
));

2663 autØ
	gcÚn
 = 
h
->
cÚn
();

2665 
ngtı2_Œª¥Üt_·¿ms
 
	g·¿ms
;

2667 
	grv
 = 
ngtı2_cÚn_g‘_loÿl_Œª¥Üt_·¿ms
(

2668 
cÚn
, &
·¿ms
, 
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
);

2669 ià(
	grv
 != 0) {

2670 *
®
 = 
SSL_AD_INTERNAL_ERROR
;

2674 
	g·¿ms
.
	gv
.
	g“
.
	gËn
 = 1;

2675 
	g·¿ms
.
	gv
.
	g“
.
	gsuµÜ‹d_v”siÚs
[0] = 
NGTCP2_PROTO_VER_D17
;

2677 
cÚ¡ex´
 
size_t
 
	gbufsize
 = 512;

2678 autØ
	gbuf
 = 
¡d
::
make_unique
<
ušt8_t
[]>(
bufsize
);

2680 autØ
	gnwr™e
 = 
ngtı2_’code_Œª¥Üt_·¿ms
(

2681 
buf
.
g‘
(), 
bufsize
, 
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
,

2682 &
·¿ms
);

2683 ià(
	gnwr™e
 < 0) {

2684 
	g¡d
::
û¼
 << "ngtcp2_encode_transport_params: "

2685 << 
ngtı2_¡»¼Ü
(
¡©ic_ÿ¡
<>(
nwr™e
)è<< 
¡d
::
’dl
;

2686 *
	g®
 = 
SSL_AD_INTERNAL_ERROR
;

2690 *
	gout
 = 
buf
.
»Ëa£
();

2691 *
	gou’
 = 
¡©ic_ÿ¡
<
size_t
>(
nwr™e
);

2697 
	gÇme¥aû
 {

2698 
Œª¥Üt_·¿ms_ä“_cb
(
SSL
 *
s¦
, 
ext_ty³
,

2699 
cÚ‹xt
, cÚ¡ *
out
,

2700 *
add_¬g
) {

2701 
	gd–‘e
[] 
	gcÚ¡_ÿ¡
<*>(
	gout
);

2705 
	gÇme¥aû
 {

2706 
Œª¥Üt_·¿ms_·r£_cb
(
SSL
 *
s¦
, 
ext_ty³
,

2707 
cÚ‹xt
, cÚ¡ *
š
,

2708 
size_t
 
šËn
, 
X509
 *
x
, size_ˆ
chašidx
, *
®
,

2709 *
·r£_¬g
) {

2710 ià(
	gcÚ‹xt
 !ğ
SSL_EXT_CLIENT_HELLO
) {

2711 *
®
 = 
SSL_AD_ILLEGAL_PARAMETER
;

2715 autØ
	gh
 = 
¡©ic_ÿ¡
<
HªdËr
 *>(
SSL_g‘_­p_d©a
(
s¦
));

2716 autØ
	gcÚn
 = 
h
->
cÚn
();

2718 
	grv
;

2720 
ngtı2_Œª¥Üt_·¿ms
 
	g·¿ms
;

2722 
	grv
 = 
ngtı2_decode_Œª¥Üt_·¿ms
(

2723 &
·¿ms
, 
NGTCP2_TRANSPORT_PARAMS_TYPE_CLIENT_HELLO
, 
š
, 
šËn
);

2724 ià(
	grv
 != 0) {

2725 
¡d
::
û¼
 << "ngtı2_decode_Œª¥Üt_·¿ms: " << 
ngtı2_¡»¼Ü
(
rv
)

2726 << 
¡d
::
’dl
;

2727 *
	g®
 = 
SSL_AD_ILLEGAL_PARAMETER
;

2731 
	grv
 = 
ngtı2_cÚn_£t_»mÙe_Œª¥Üt_·¿ms
(

2732 
cÚn
, 
NGTCP2_TRANSPORT_PARAMS_TYPE_CLIENT_HELLO
, &
·¿ms
);

2733 ià(
	grv
 != 0) {

2734 
¡d
::
û¼
 << "ngtcp2_conn_set_remote_transport_params: "

2735 << 
ngtı2_¡»¼Ü
(
rv
è<< 
¡d
::
’dl
;

2736 *
	g®
 = 
SSL_AD_ILLEGAL_PARAMETER
;

2744 
	gÇme¥aû
 {

2745 
SSL_CTX
 *
ü—‹_s¦_ùx
(cÚ¡ *
´iv©e_key_fe
, cÚ¡ *
û¹_fe
) {

2746 autØ
	gs¦_ùx
 = 
SSL_CTX_Ãw
(
TLS_m‘hod
());

2748 
cÚ¡ex´
‡utØ
	gs¦_İts
 = (
SSL_OP_ALL
 & ~
SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS
) |

2749 
SSL_OP_SINGLE_ECDH_USE
 |

2750 
SSL_OP_CIPHER_SERVER_PREFERENCE
 |

2751 
SSL_OP_NO_ANTI_REPLAY
;

2753 
SSL_CTX_£t_İtiÚs
(
s¦_ùx
, 
s¦_İts
);

2754 
SSL_CTX_ş—r_İtiÚs
(
s¦_ùx
, 
SSL_OP_ENABLE_MIDDLEBOX_COMPAT
);

2756 ià(
SSL_CTX_£t_ch”su™es
(
s¦_ùx
, 
cÚfig
.
ch”s
) != 1) {

2757 
¡d
::
û¼
 << "SSL_CTX_set_ciphersuites: "

2758 << 
ERR_”rÜ_¡ršg
(
ERR_g‘_”rÜ
(), 
nuÎ±r
è<< 
¡d
::
’dl
;

2759 
	gç
;

2762 ià(
SSL_CTX_£t1_groups_li¡
(
s¦_ùx
, 
cÚfig
.
groups
) != 1) {

2763 
¡d
::
û¼
 << "SSL_CTX_£t1_groups_li¡ faed" << std::
’dl
;

2764 
	gç
;

2767 
SSL_CTX_£t_mode
(
s¦_ùx
, 
SSL_MODE_RELEASE_BUFFERS
 | 
SSL_MODE_QUIC_HACK
);

2769 
SSL_CTX_£t_mš_´Ùo_v”siÚ
(
s¦_ùx
, 
TLS1_3_VERSION
);

2770 
SSL_CTX_£t_max_´Ùo_v”siÚ
(
s¦_ùx
, 
TLS1_3_VERSION
);

2772 
SSL_CTX_£t_®²_£Ëù_cb
(
s¦_ùx
, 
®²_£Ëù_´Ùo_cb
, 
nuÎ±r
);

2774 
SSL_CTX_£t_deçuÉ_v”ify_·ths
(
s¦_ùx
);

2776 ià(
SSL_CTX_u£_Priv©eKey_fe
(
s¦_ùx
, 
´iv©e_key_fe
,

2777 
SSL_FILETYPE_PEM
) != 1) {

2778 
¡d
::
û¼
 << "SSL_CTX_use_PrivateKey_file: "

2779 << 
ERR_”rÜ_¡ršg
(
ERR_g‘_”rÜ
(), 
nuÎ±r
è<< 
¡d
::
’dl
;

2780 
	gç
;

2783 ià(
SSL_CTX_u£_û¹ifiÿ‹_chaš_fe
(
s¦_ùx
, 
û¹_fe
) != 1) {

2784 
¡d
::
û¼
 << "SSL_CTX_use_certificate_file: "

2785 << 
ERR_”rÜ_¡ršg
(
ERR_g‘_”rÜ
(), 
nuÎ±r
è<< 
¡d
::
’dl
;

2786 
	gç
;

2789 ià(
SSL_CTX_check_´iv©e_key
(
s¦_ùx
) != 1) {

2790 
¡d
::
û¼
 << "SSL_CTX_check_private_key: "

2791 << 
ERR_”rÜ_¡ršg
(
ERR_g‘_”rÜ
(), 
nuÎ±r
è<< 
¡d
::
’dl
;

2792 
	gç
;

2795 ià(
SSL_CTX_add_cu¡om_ext
(

2796 
s¦_ùx
, 
NGTCP2_TLSEXT_QUIC_TRANSPORT_PARAMETERS
,

2797 
SSL_EXT_CLIENT_HELLO
 | 
SSL_EXT_TLS1_3_ENCRYPTED_EXTENSIONS
,

2798 
Œª¥Üt_·¿ms_add_cb
, 
Œª¥Üt_·¿ms_ä“_cb
, 
nuÎ±r
,

2799 
Œª¥Üt_·¿ms_·r£_cb
, 
nuÎ±r
) != 1) {

2800 
¡d
::
û¼
 << "SSL_CTX_add_custom_ext(NGTCP2_TLSEXT_QUIC_TRANSPORT_"

2802 << 
ERR_”rÜ_¡ršg
(
ERR_g‘_”rÜ
(), 
nuÎ±r
è<< 
¡d
::
’dl
;

2803 
	gç
;

2806 
SSL_CTX_£t_max_—¾y_d©a
(
s¦_ùx
, 
¡d
::
num”ic_lim™s
<
ušt32_t
>::
max
());

2808  
	gs¦_ùx
;

2810 
	gç
:

2811 
SSL_CTX_ä“
(
s¦_ùx
);

2812  
	gnuÎ±r
;

2816 
	gÇme¥aû
 {

2817 
ü—‹_sock
(
Add»ss
 &
loÿl_addr
, cÚ¡ *
addr
, cÚ¡ *
pÜt
,

2818 
çmy
) {

2819 
addršfo
 
	ghšts
{};

2820 
addršfo
 *
	g»s
, *
	g½
;

2821 
	grv
;

2822 
	gv®
 = 1;

2824 
	ghšts
.
	gai_çmy
 = 
çmy
;

2825 
	ghšts
.
	gai_sockty³
 = 
SOCK_DGRAM
;

2826 
	ghšts
.
	gai_æags
 = 
AI_PASSIVE
;

2828 ià(
¡rcmp
("addr", "*") == 0) {

2829 
addr
 = 
nuÎ±r
;

2832 
	grv
 = 
g‘addršfo
(
addr
, 
pÜt
, &
hšts
, &
»s
);

2833 ià(
	grv
 != 0) {

2834 
¡d
::
û¼
 << "g‘addršfo: " << 
gai_¡»¼Ü
(
rv
è<< std::
’dl
;

2838 autØ
	g»s_d
 = 
deãr
(
ä“addršfo
, 
»s
);

2840 
	gfd
 = -1;

2842 
	g½
 = 
»s
;„p;„°ğ
½
->
ai_Ãxt
) {

2843 
fd
 = 
sock‘
(
½
->
ai_çmy
,„p->
ai_sockty³
,„p->
ai_´ÙocŞ
);

2844 ià(
	gfd
 == -1) {

2848 ià(
	g½
->
	gai_çmy
 =ğ
AF_INET6
) {

2849 ià(
£tsockİt
(
fd
, 
IPPROTO_IPV6
, 
IPV6_V6ONLY
, &
v®
,

2850 
¡©ic_ÿ¡
<
sockËn_t
>((
v®
))) == -1) {

2851 
şo£
(
fd
);

2856 ià(
bšd
(
fd
, 
½
->
ai_addr
,„p->
ai_add¾’
) != -1) {

2860 
şo£
(
fd
);

2863 ià(!
	g½
) {

2864 
	g¡d
::
û¼
 << "Could‚Ù bšd" << 
¡d
::
’dl
;

2868 ià(
£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
v®
,

2869 
¡©ic_ÿ¡
<
sockËn_t
>((
v®
))) == -1) {

2873 
sockËn_t
 
	gËn
 = (
loÿl_addr
.
su
.
¡Üage
);

2874 
	grv
 = 
g‘sockÇme
(
fd
, &
loÿl_addr
.
su
.
§
, &
Ën
);

2875 ià(
	grv
 == -1) {

2876 
¡d
::
û¼
 << "g‘sockÇme: " << 
¡»¼Ü
(
”ºo
è<< std::
’dl
;

2879 
	gloÿl_addr
.
	gËn
 = 
Ën
;

2881  
	gfd
;

2886 
	gÇme¥aû
 {

2887 
£rve
(
S”v”
 &
s
, cÚ¡ *
addr
, cÚ¡ *
pÜt
, 
çmy
) {

2888 
Add»ss
 
	gloÿl_addr
;

2890 autØ
	gfd
 = 
ü—‹_sock
(
loÿl_addr
, 
addr
, 
pÜt
, 
çmy
);

2891 ià(
	gfd
 == -1) {

2895 ià(
	gs
.
š™
(
fd
, 
loÿl_addr
) != 0) {

2903 
	gÇme¥aû
 {

2904 
şo£
(
S”v”
 &
s
) {

2905 
	gs
.
discÚÃù
();

2907 
	gs
.
şo£
();

2911 
	gÇme¥aû
 {

2912 
	g¡d
::
of¡»am
 
keylog_fe
;

2913 
keylog_ÿÎback
(cÚ¡ 
SSL
 *
s¦
, cÚ¡ *
lše
) {

2914 
	gkeylog_fe
.
wr™e
(
lše
, 
¡¾’
(line));

2915 
	gkeylog_fe
.
put
('\n');

2916 
	gkeylog_fe
.
æush
();

2920 
	gÇme¥aû
 {

2921 
´št_u§ge
() {

2922 
	g¡d
::
û¼
 << "Usage: server [OPTIONS] <ADDR> <PORT> <PRIVATE_KEY_FILE> "

2924 << 
¡d
::
’dl
;

2928 
	gÇme¥aû
 {

2929 
cÚfig_£t_deçuÉ
(
CÚfig
 &
cÚfig
) {

2930 
	gcÚfig
 = 
CÚfig
{};

2931 
	gcÚfig
.
	gtx_loss_´ob
 = 0.;

2932 
	gcÚfig
.
	grx_loss_´ob
 = 0.;

2933 
	gcÚfig
.
	gch”s
 = "TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_"

2935 
	gcÚfig
.
	ggroups
 = "P-256:X25519:P-384:P-521";

2936 
	gcÚfig
.
	gtimeout
 = 30;

2938 autØ
	g·th
 = 
»®·th
(".", 
nuÎ±r
);

2939 
	gcÚfig
.
	ghtdocs
 = 
·th
;

2940 
ä“
(
·th
);

2945 
	gÇme¥aû
 {

2946 
´št_h–p
() {

2947 
´št_u§ge
();

2949 
cÚfig_£t_deçuÉ
(
cÚfig
);

2951 
	g¡d
::
cout
 << 
R
"(

2952 <
ADDR
> 
Add»ss
 
to
 
li¡’
o. '*' 
bšds
Ø
ªy
 
add»ss
.

2953 <
PORT
> 
PÜt


2954 <
PRIVATE_KEY_FILE
>

2955 
P©h
 
to
 
´iv©e
 
key
 
fe


2956 <
CERTIFICATE_FILE
>

2957 
P©h
 
to
 
û¹ifiÿ‹
 
fe


2958 
O±iÚs
:

2959 -
t
, --
	gtx
-
	gloss
=<
P
>

2960 
The
 
´obab™y
 
of
 
losšg
 
outgošg
 
·ck‘s
. <
P
> 
mu¡
 
be


2961 [0.0, 1.0], 
	gšşusive
. 0.0 
m—ns
 
no
 
·ck‘
 
	gloss
. 1.0

2962 
	gm—ns
 100% 
·ck‘
 
	gloss
.

2963 -
	gr
, --
	grx
-
	gloss
=<
P
>

2964 
The
 
´obab™y
 
of
 
losšg
 
šcomšg
 
·ck‘s
. <
P
> 
mu¡
 
be


2965 [0.0, 1.0], 
	gšşusive
. 0.0 
m—ns
 
no
 
·ck‘
 
	gloss
. 1.0

2966 
	gm—ns
 100% 
·ck‘
 
	gloss
.

2967 --
	gch”s
=<
CIPHERS
>

2968 
S³cify
 
the
 
ch”
 
su™e
 
li¡
 
to
 
’abË
.

2969 
DeçuÉ
: )"

2970 << 
cÚfig
.
ch”s
 << 
R
"(

2971 --
groups
=<
GROUPS
>

2972 
S³cify
 
the
 
suµÜ‹d
 
groups
.

2973 
DeçuÉ
: )"

2974 << 
cÚfig
.
groups
 << 
R
"(

2975 -
d
, --
	ghtdocs
=<
PATH
>

2976 
S³cify
 
docum’t
 
roÙ
. 
If
 
this
 
İtiÚ
 
is
 
nÙ
 
¥ecif›d
,

2977 
the
 
docum’t
 
roÙ
 
is
h
cu¼’t
 
wÜkšg
 
	gdœeùÜy
.

2978 -
	gq
, --
qu›t
 
Suµ»ss
 
debug
 
	gouut
.

2979 -
	gs
, --
	gshow
-
£ü‘


2980 
Pršt
 
out
 
£ü‘s
 
	guÆess
 --
qu›t
 
is
 
	gu£d
.

2981 --
	gtimeout
=<
T
>

2982 
S³cify
 
idË
 
timeout
 
š
 
£cÚds
.

2983 
DeçuÉ
: )"

2984 << 
cÚfig
.
timeout
 << 
R
"(

2985 -
V
, --
	gv®id©e
-
addr


2986 
P”fÜm
 
add»ss
 
	gv®id©iÚ
.

2987 -
	gh
, --
h–p
 
Di¥Ïy
 
this
 h–°
ªd
 
	gex™
.

2992 
	$maš
(
¬gc
, **
¬gv
) {

2993 
	`cÚfig_£t_deçuÉ
(
cÚfig
);

2996 
æag
 = 0;

2997 
cÚ¡ex´
 
İtiÚ
 
lÚg_İts
[] = {

2998 {"h–p", 
no_¬gum’t
, 
nuÎ±r
, 'h'},

2999 {"tx-loss", 
»quœed_¬gum’t
, 
nuÎ±r
, 't'},

3000 {"rx-loss", 
»quœed_¬gum’t
, 
nuÎ±r
, 'r'},

3001 {"htdocs", 
»quœed_¬gum’t
, 
nuÎ±r
, 'd'},

3002 {"qu›t", 
no_¬gum’t
, 
nuÎ±r
, 'q'},

3003 {"show-£ü‘", 
no_¬gum’t
, 
nuÎ±r
, 's'},

3004 {"v®id©e-addr", 
no_¬gum’t
, 
nuÎ±r
, 'V'},

3005 {"ch”s", 
»quœed_¬gum’t
, &
æag
, 1},

3006 {"groups", 
»quœed_¬gum’t
, &
æag
, 2},

3007 {"timeout", 
»quœed_¬gum’t
, &
æag
, 3},

3008 {
nuÎ±r
, 0,‚ullptr, 0}};

3010 autØ
İtidx
 = 0;

3011 autØ
c
 = 
	`g‘İt_lÚg
(
¬gc
, 
¬gv
, "d:hqr:¡:V", 
lÚg_İts
, &
İtidx
);

3012 ià(
c
 == -1) {

3015 
c
) {

3018 autØ
·th
 = 
	`»®·th
(
İrg
, 
nuÎ±r
);

3019 ià(
·th
 =ğ
nuÎ±r
) {

3020 
¡d
::
û¼
 << "·th: inv®id…©h " << 
İrg
 << std::
’dl
;

3021 
	`ex™
(
EXIT_FAILURE
);

3023 
cÚfig
.
htdocs
 = 
·th
;

3024 
	`ä“
(
·th
);

3029 
	`´št_h–p
();

3030 
	`ex™
(
EXIT_SUCCESS
);

3033 
cÚfig
.
qu›t
 = 
Œue
;

3037 
cÚfig
.
rx_loss_´ob
 = 
	`¡¹od
(
İrg
, 
nuÎ±r
);

3041 
cÚfig
.
show_£ü‘
 = 
Œue
;

3045 
cÚfig
.
tx_loss_´ob
 = 
	`¡¹od
(
İrg
, 
nuÎ±r
);

3049 
cÚfig
.
v®id©e_addr
 = 
Œue
;

3052 
	`´št_u§ge
();

3053 
	`ex™
(
EXIT_FAILURE
);

3055 
æag
) {

3058 
cÚfig
.
ch”s
 = 
İrg
;

3062 
cÚfig
.
groups
 = 
İrg
;

3066 
cÚfig
.
timeout
 = 
	`¡¹Ş
(
İrg
, 
nuÎ±r
, 10);

3075 ià(
¬gc
 - 
İtšd
 < 4) {

3076 
¡d
::
û¼
 << "ToØãw‡rgum’ts" << std::
’dl
;

3077 
	`´št_u§ge
();

3078 
	`ex™
(
EXIT_FAILURE
);

3081 autØ
addr
 = 
¬gv
[
İtšd
++];

3082 autØ
pÜt
 = 
¬gv
[
İtšd
++];

3083 autØ
´iv©e_key_fe
 = 
¬gv
[
İtšd
++];

3084 autØ
û¹_fe
 = 
¬gv
[
İtšd
++];

3086 
”ºo
 = 0;

3087 
cÚfig
.
pÜt
 = 
	`¡¹oul
ÕÜt, 
nuÎ±r
, 10);

3088 ià(
”ºo
 != 0) {

3089 
¡d
::
û¼
 << "pÜt: inv®id…Üˆnumb”" << std::
’dl
;

3090 
	`ex™
(
EXIT_FAILURE
);

3093 autØ
s¦_ùx
 = 
	`ü—‹_s¦_ùx
(
´iv©e_key_fe
, 
û¹_fe
);

3094 ià(
s¦_ùx
 =ğ
nuÎ±r
) {

3095 
	`ex™
(
EXIT_FAILURE
);

3098 ià(
cÚfig
.
htdocs
.
	`back
() != '/') {

3099 
cÚfig
.
htdocs
 += '/';

3102 
¡d
::
û¼
 << "Usšg docum’ˆroÙ " << 
cÚfig
.
htdocs
 << std::
’dl
;

3104 autØ
s¦_ùx_d
 = 
	`deãr
(
SSL_CTX_ä“
, 
s¦_ùx
);

3106 autØ
ev_loİ_d
 = 
	`deãr
(
ev_loİ_de¡roy
, 
EV_DEFAULT
);

3108 ià(
	`i§‰y
(
STDOUT_FILENO
)) {

3109 
debug
::
	`£t_cŞÜ_ouut
(
Œue
);

3112 autØ
keylog_f’ame
 = 
	`g‘’v
("SSLKEYLOGFILE");

3113 ià(
keylog_f’ame
) {

3114 
keylog_fe
.
	`İ’
(
keylog_f’ame
, 
¡d
::
ios_ba£
::
­p
);

3115 ià(
keylog_fe
) {

3116 
	`SSL_CTX_£t_keylog_ÿÎback
(
s¦_ùx
, 
keylog_ÿÎback
);

3120 autØ
»ady
 = 
çl£
;

3122 
S”v”
 
	`s4
(
EV_DEFAULT
, 
s¦_ùx
);

3123 ià(!
ut
::
	`num”ic_ho¡
(
addr
, 
AF_INET6
)) {

3124 ià(
	`£rve
(
s4
, 
addr
, 
pÜt
, 
AF_INET
) == 0) {

3125 
»ady
 = 
Œue
;

3129 
S”v”
 
	`s6
(
EV_DEFAULT
, 
s¦_ùx
);

3130 ià(!
ut
::
	`num”ic_ho¡
(
addr
, 
AF_INET
)) {

3131 ià(
	`£rve
(
s6
, 
addr
, 
pÜt
, 
AF_INET6
) == 0) {

3132 
»ady
 = 
Œue
;

3136 ià(!
»ady
) {

3137 
	`ex™
(
EXIT_FAILURE
);

3140 
	`ev_run
(
EV_DEFAULT
, 0);

3142 
	`şo£
(
s6
);

3143 
	`şo£
(
s4
);

3145  
EXIT_SUCCESS
;

3146 
	}
}

	@examples/server.h

25 #iâdeà
SERVER_H


26 
	#SERVER_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<veùÜ
>

33 
	~<deque
>

34 
	~<m­
>

35 
	~<¡ršg
>

37 
	~<ngtı2/ngtı2.h
>

39 
	~<İ’s¦/s¦.h
>

40 
	~<ev.h
>

41 
	~<h‰p-·r£r/h‰p_·r£r.h
>

43 
	~"ÃtwÜk.h
"

44 
	~"üy±o.h
"

45 
	~"‹m¶©e.h
"

47 
usšg
 
Çme¥aû
 
	gngtı2
;

49 
	sCÚfig
 {

51 
	mtx_loss_´ob
;

53 
	mrx_loss_´ob
;

55 cÚ¡ *
	mch”s
;

57 cÚ¡ *
	mgroups
;

59 
	m¡d
::
¡ršg
 
htdocs
;

62 
ušt16_t
 
	mpÜt
;

65 
boŞ
 
	mqu›t
;

67 
ušt32_t
 
	mtimeout
;

69 
boŞ
 
	mshow_£ü‘
;

71 
boŞ
 
	mv®id©e_addr
;

74 
	sBufãr
 {

75 
Bufãr
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
);

76 
Bufãr
(
ušt8_t
 *
begš
, ušt8_ˆ*
’d
);

77 
ex¶ic™
 
Bufãr
(
size_t
 
d©®’
);

78 
Bufãr
();

80 
size_t
 
size
(ècÚ¡ {  
	m
 - 
	mh—d
; }

81 
size_t
 
Ëá
(ècÚ¡ {  
	mbuf
.
d©a
(è+ buf.
size
(è- 
	m
; }

82 
ušt8_t
 *cÚ¡ 
wpos
(è{  
	m
; }

83 cÚ¡ 
ušt8_t
 *
½os
(ècÚ¡ {  
	mh—d
; }

84 
£ek
(
size_t
 
Ën
è{ 
	mh—d
 +=†en; }

85 
push
(
size_t
 
Ën
è{ 
	m
 +=†en; }

86 
»£t
(è{ 
	mh—d
 = 

 = 
begš
; }

87 
size_t
 
bufsize
(ècÚ¡ {  
	m
 - 
	mbegš
; }

89 
	m¡d
::
veùÜ
<
ušt8_t
> 
buf
;

93 
ušt8_t
 *
	mbegš
;

96 
ušt8_t
 *
	mh—d
;

99 
ušt8_t
 *
	m
;

103 
	mRESP_IDLE
,

104 
	mRESP_STARTED
,

105 
	mRESP_COMPLETED
,

108 
	sSŒ—m
 {

109 
SŒ—m
(
ušt64_t
 
¡»am_id
);

110 ~
SŒ—m
();

112 
»cv_d©a
(
ušt8_t
 
fš
, cÚ¡ ušt8_ˆ*
d©a
, 
size_t
 
d©®’
);

113 
¡¬t_»¥Ú£
();

114 
İ’_fe
(cÚ¡ 
¡d
::
¡ršg
 &
·th
);

115 
m­_fe
(
size_t
 
Ën
);

116 
bufãr_fe
();

117 
£nd_¡©us_»¥Ú£
(
¡©us_code
,

118 cÚ¡ 
¡d
::
¡ršg
 &
exŒa_h—d”s
 = "");

119 
£nd_»dœeù_»¥Ú£
(
¡©us_code
,

120 cÚ¡ 
¡d
::
¡ršg
 &
·th
);

122 
ušt64_t
 
	m¡»am_id
;

123 
	m¡d
::
deque
<
Bufãr
> 
¡»ambuf
;

126 
size_t
 
	m¡»ambuf_idx
;

129 
ušt64_t
 
	mtx_¡»am_off£t
;

132 
boŞ
 
	mshould_£nd_fš
;

134 
	m»¥_¡©e
;

135 
h‰p_·r£r
 
	mh
;

136 
	mh‰p_majÜ
;

137 
	mh‰p_mšÜ
;

139 
	m¡d
::
¡ršg
 
uri
;

141 
	m¡d
::
veùÜ
<
¡d
::
·œ
<¡d::
¡ršg
, std::¡ršg>> 
hdrs
;

144 
boŞ
 
	m´ev_hdr_key
;

147 
	mfd
;

149 
ušt8_t
 *
	md©a
;

151 
ušt64_t
 
	md©®’
;

154 
şass
 
	gS”v”
;

156 şas 
	cHªdËr
 {

157 
	mpublic
:

158 
HªdËr
(
ev_loİ
 *
loİ
, 
SSL_CTX
 *
s¦_ùx
, 
S”v”
 *
£rv”
,

159 cÚ¡ 
ngtı2_cid
 *
rcid
);

160 ~
HªdËr
();

162 
š™
(
fd
, cÚ¡ 
sockaddr
 *
§
, 
sockËn_t
 
§Ën
, cÚ¡ 
ngtı2_cid
 *
dcid
,

163 cÚ¡ 
ngtı2_cid
 *
ocid
, 
ušt32_t
 
v”siÚ
);

165 
s_hªdshake
();

166 
»ad_s
();

167 
Ú_»ad
(cÚ¡ 
sockaddr
 *
§
, 
sockËn_t
 
§Ën
, 
ušt8_t
 *
d©a
,

168 
size_t
 
d©®’
);

169 
Ú_wr™e
(
boŞ
 
»Œªsm™
 = 
çl£
);

170 
Ú_wr™e_¡»am
(
SŒ—m
 &
¡»am
);

171 
wr™e_¡»am_d©a
(
SŒ—m
 &
¡»am
, 
fš
, 
Bufãr
 &
d©a
);

172 
ãed_d©a
(cÚ¡ 
sockaddr
 *
§
, 
sockËn_t
 
§Ën
, 
ušt8_t
 *
d©a
,

173 
size_t
 
d©®’
);

174 
do_hªdshake_»ad_Úû
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
);

175 
ssize_t
 
do_hªdshake_wr™e_Úû
();

176 
do_hªdshake
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
);

177 
scheduË_»Œªsm™
();

178 
sigÇl_wr™e
();

180 
wr™e_£rv”_hªdshake
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
);

181 
wr™e_£rv”_hªdshake
(
¡d
::
deque
<
Bufãr
> &
de¡
, 
size_t
 &
idx
,

182 cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
);

183 
size_t
 
»ad_£rv”_hªdshake
(cÚ¡ 
ušt8_t
 **
pde¡
);

185 
size_t
 
»ad_ş›Á_hªdshake
(
ušt8_t
 *
buf
, size_ˆ
buæ’
);

186 
wr™e_ş›Á_hªdshake
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
);

188 
»cv_ş›Á_š™Ÿl
(cÚ¡ 
ngtı2_cid
 *
dcid
);

189 
ssize_t
 
hs_’üy±_d©a
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

190 cÚ¡ 
ušt8_t
 *
¶aš‹xt
, 
size_t
 
¶aš‹x’
,

191 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

192 cÚ¡ 
ušt8_t
 *
nÚû
, 
size_t
 
nÚûËn
,

193 cÚ¡ 
ušt8_t
 *
ad
, 
size_t
 
adËn
);

194 
ssize_t
 
hs_deüy±_d©a
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

195 cÚ¡ 
ušt8_t
 *
ch”‹xt
, 
size_t
 
ch”‹x’
,

196 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

197 cÚ¡ 
ušt8_t
 *
nÚû
, 
size_t
 
nÚûËn
,

198 cÚ¡ 
ušt8_t
 *
ad
, 
size_t
 
adËn
);

199 
ssize_t
 
’üy±_d©a
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
¶aš‹xt
,

200 
size_t
 
¶aš‹x’
, cÚ¡ 
ušt8_t
 *
key
, size_ˆ
keyËn
,

201 cÚ¡ 
ušt8_t
 *
nÚû
, 
size_t
 
nÚûËn
, cÚ¡ ušt8_ˆ*
ad
,

202 
size_t
 
adËn
);

203 
ssize_t
 
deüy±_d©a
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
ch”‹xt
,

204 
size_t
 
ch”‹x’
, cÚ¡ 
ušt8_t
 *
key
, size_ˆ
keyËn
,

205 cÚ¡ 
ušt8_t
 *
nÚû
, 
size_t
 
nÚûËn
, cÚ¡ ušt8_ˆ*
ad
,

206 
size_t
 
adËn
);

207 
ssize_t
 
š_hp_mask
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
key
,

208 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
§m¶e
, size_ˆ
§m¶–’
);

209 
ssize_t
 
hp_mask
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, cÚ¡ ušt8_ˆ*
key
,

210 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
§m¶e
, size_ˆ
§m¶–’
);

211 
S”v”
 *
	$£rv”
() const;

212 cÚ¡ 
Add»ss
 &
	$»mÙe_addr
() const;

213 
ngtı2_cÚn
 *
	$cÚn
() const;

214 
	`»cv_¡»am_d©a
(
ušt64_t
 
¡»am_id
, 
ušt8_t
 
fš
, cÚ¡ ušt8_ˆ*
d©a
,

215 
size_t
 
d©®’
);

216 cÚ¡ 
ngtı2_cid
 *
	$scid
() const;

217 cÚ¡ 
ngtı2_cid
 *
	$rcid
() const;

218 
ušt32_t
 
	$v”siÚ
() const;

219 
	`»move_tx_üy±o_d©a
(
ušt64_t
 
off£t
, 
size_t
 
d©®’
);

220 
	`»move_tx_¡»am_d©a
(
ušt64_t
 
¡»am_id
, ušt64_ˆ
off£t
,

221 
size_t
 
d©®’
);

222 
	`Ú_¡»am_şo£
(
ušt64_t
 
¡»am_id
);

223 
	`¡¬t_d¿ššg_³riod
();

224 
	`¡¬t_şosšg_³riod
(
lib”rÜ
);

225 
boŞ
 
	$d¿ššg
() const;

226 
	`hªdË_”rÜ
(
lib”rÜ
);

227 
	`£nd_cÚn_şo£
();

228 
	`upd©e_»mÙe_addr
(cÚ¡ 
ngtı2_addr
 *
addr
);

230 
	`£nd_g»‘šg
();

232 
	`Ú_key
(
Çme
, cÚ¡ 
ušt8_t
 *
£ü‘
, 
size_t
 
£ü‘Ën
);

234 
	`£t_s_®”t
(
ušt8_t
 
®”t
);

236 
	`upd©e_key
();

238 
´iv©e
:

239 
Add»ss
 
»mÙe_addr_
;

240 
size_t
 
max_pk’_
;

241 
ev_loİ
 *
loİ_
;

242 
SSL_CTX
 *
s¦_ùx_
;

243 
SSL
 *
s¦_
;

244 
S”v”
 *
£rv”_
;

245 
fd_
;

246 
ev_tim”
 
tim”_
;

247 
ev_tim”
 
¹tim”_
;

248 
¡d
::
veùÜ
<
ušt8_t
> 
chªdshake_
;

249 
size_t
 
nü—d_
;

250 
¡d
::
deque
<
Bufãr
> 
shªdshake_
;

253 
size_t
 
shªdshake_idx_
;

254 
ngtı2_cÚn
 *
cÚn_
;

255 
ngtı2_cid
 
scid_
;

256 
ngtı2_cid
 
rcid_
;

257 
üy±o
::
CÚ‹xt
 
hs_üy±o_ùx_
;

258 
üy±o
::
CÚ‹xt
 
üy±o_ùx_
;

259 
¡d
::
m­
<
ušt32_t
, std::
unique_±r
<
SŒ—m
>> 
¡»ams_
;

261 
Bufãr
 
£ndbuf_
;

265 
¡d
::
unique_±r
<
Bufãr
> 
cÚn_şo£buf_
;

266 
¡d
::
veùÜ
<
ušt8_t
> 
tx_£ü‘_
;

267 
¡d
::
veùÜ
<
ušt8_t
> 
rx_£ü‘_
;

270 
ušt64_t
 
tx_üy±o_off£t_
;

272 
size_t
 
nkey_upd©e_
;

275 
ušt8_t
 
s_®”t_
;

278 
boŞ
 
š™Ÿl_
;

280 
boŞ
 
d¿ššg_
;

283 
cÚ¡ex´
 
size_t
 
TOKEN_SECRETLEN
 = 16;

285 şas 
	cS”v”
 {

286 
public
:

287 
	`S”v”
(
ev_loİ
 *
loİ
, 
SSL_CTX
 *
s¦_ùx
);

288 ~
	`S”v”
();

290 
	`š™
(
fd
, cÚ¡ 
Add»ss
 &
loÿl_addr
);

291 
	`discÚÃù
();

292 
	`discÚÃù
(
lib”r
);

293 
	`şo£
();

295 
	`Ú_wr™e
();

296 
	`Ú_»ad
();

297 
	`£nd_v”siÚ_ÃgÙŸtiÚ
(cÚ¡ 
ngtı2_pkt_hd
 *
hd
, cÚ¡ 
sockaddr
 *
§
,

298 
sockËn_t
 
§Ën
);

299 
	`£nd_»Œy
(cÚ¡ 
ngtı2_pkt_hd
 *
chd
, cÚ¡ 
sockaddr
 *
§
, 
sockËn_t
 
§Ën
);

300 
	`g’”©e_tok’
(
ušt8_t
 *
tok’
, 
size_t
 &
tok’Ën
, cÚ¡ 
sockaddr
 *
§
,

301 
sockËn_t
 
§Ën
, cÚ¡ 
ngtı2_cid
 *
ocid
);

302 
	`v”ify_tok’
(
ngtı2_cid
 *
ocid
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

303 cÚ¡ 
sockaddr
 *
§
, 
sockËn_t
 
§Ën
);

304 
	`£nd_·ck‘
(
Add»ss
 &
»mÙe_addr
, 
Bufãr
 &
buf
);

305 
	`»move
(cÚ¡ 
HªdËr
 *
h
);

306 
¡d
::
m­
<¡d::
¡ršg
, std::
unique_±r
<
HªdËr
>>::
cÚ¡_™”©Ü


307 
	`»move
(
¡d
::
m­
<¡d::
¡ršg
, std::
unique_±r
<
HªdËr
>>::
cÚ¡_™”©Ü
 
™
);

308 
	`¡¬t_wev
();

310 
	`d”ive_tok’_key
(
ušt8_t
 *
key
, 
size_t
 &
keyËn
, ušt8_ˆ*
iv
, size_ˆ&
ivËn
,

311 cÚ¡ 
ušt8_t
 *
¿nd_d©a
, 
size_t
 
¿nd_d©®’
);

312 
	`g’”©e_¿nd_d©a
(
ušt8_t
 *
buf
, 
size_t
 
Ën
);

313 
	`assocŸ‹_cid
(cÚ¡ 
ngtı2_cid
 *
cid
, 
HªdËr
 *
h
);

314 
	`dissocŸ‹_cid
(cÚ¡ 
ngtı2_cid
 *
cid
);

315 cÚ¡ 
Add»ss
 &
	$g‘_loÿl_addr
() const;

317 
´iv©e
:

318 
Add»ss
 
loÿl_addr_
;

319 
¡d
::
m­
<¡d::
¡ršg
, std::
unique_±r
<
HªdËr
>> 
hªdËrs_
;

322 
¡d
::
m­
<¡d::
¡ršg
, std::¡ršg> 
ùos_
;

323 
ev_loİ
 *
loİ_
;

324 
SSL_CTX
 *
s¦_ùx_
;

325 
üy±o
::
CÚ‹xt
 
tok’_üy±o_ùx_
;

326 
¡d
::
¬¿y
<
ušt8_t
, 
TOKEN_SECRETLEN
> 
tok’_£ü‘_
;

327 
fd_
;

328 
ev_io
 
wev_
;

329 
ev_io
 
»v_
;

330 
ev_sigÇl
 
sigš‹v_
;

	@examples/shared.h

25 #iâdeà
SHARED_H


26 
	#SHARED_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

34 
Çme¥aû
 
	gngtı2
 {

36 
cÚ¡ex´
 
ušt16_t
 
	gNGTCP2_APP_NOERROR
 = 0xff00;

37 
cÚ¡ex´
 
ušt16_t
 
	gNGTCP2_APP_PROTO
 = 0xff01;

	@examples/template.h

26 #iâdeà
TEMPLATE_H


27 
	#TEMPLATE_H


	)

29 
	~<funùiÚ®
>

30 
	~<ut™y
>

31 
	~<ty³_Œa™s
>

35 
	g‹m¶©e
 <
ty³Çme
 
	gF
, 
	gty³Çme
... 
	gT
> 
	sDeãr
 {

36 
Deãr
(
F
 &&
f
, 
T
 &&... 
t
)

37 : 
f
(
¡d
::
bšd
(¡d::
fÜw¬d
<
F
>(f), std::fÜw¬d<
T
>(
t
)...)) {}

38 
Deãr
(Deã¸&&
o
è
nÛxû±
 : 
f
(
¡d
::
move
(o.f)) {}

39 ~
Deãr
(è{ 
f
(); }

41 
usšg
 
	mResuÉTy³
 = 
ty³Çme
 
¡d
::
»suÉ_of
<ty³Çm¡d::
deÿy
<
F
>::
ty³
(

42 
ty³Çme
 
¡d
::
deÿy
<
T
>::
ty³
...)>::type;

43 
	m¡d
::
funùiÚ
<
ResuÉTy³
()> 
f
;

46 
	g‹m¶©e
 <
ty³Çme
 
	gF
, 
	gty³Çme
... 
	gT
> 
	gDeãr
<F, T...> 
	$deãr
(
F
 &&
f
, 
T
 &&... 
t
) {

47  
Deãr
<
F
, 
T
...>(
¡d
::
fÜw¬d
<F>(
f
), std::fÜw¬d<T>(
t
)...);

48 
	}
}

50 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
size_t
 
	gN
> 
cÚ¡ex´
 size_ˆ
¬¿y_size
(
T
 (&)[
N
]) {

51  
	gN
;

54 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
size_t
 
	gN
> 
cÚ¡ex´
 size_ˆ
¡r_size
(
T
 (&)[
N
]) {

55  
	gN
 - 1;

60 
cÚ¡ex´
 
	gİ”©Ü
"" 
	$_k
(
k
) {

61  
k
 * 1024;

62 
	}
}

64 
cÚ¡ex´
 
	gİ”©Ü
"" 
	$_m
(
m
) {

65  
m
 * 1024 * 1024;

66 
	}
}

68 
cÚ¡ex´
 
	gİ”©Ü
"" 
	$_g
(
g
) {

69  
g
 * 1024 * 1024 * 1024;

70 
	}
}

	@examples/util.cc

26 
	~"ut.h
"

28 #ifdeà
HAVE_ARPA_INET_H


29 
	~<¬·/š‘.h
>

31 
	~<Ãtdb.h
>

33 
	~<ÿs£¹
>

34 
	~<chrÚo
>

35 
	~<¬¿y
>

36 
	~<io¡»am
>

38 
Çme¥aû
 
	gngtı2
 {

40 
Çme¥aû
 
	gut
 {

42 
	gÇme¥aû
 {

43 
cÚ¡ex´
 
	gLOWER_XDIGITS
[] = "0123456789abcdef";

46 
	g¡d
::
¡ršg
 
fÜm©_hex
(
ušt8_t
 
c
) {

47 
¡d
::
¡ršg
 
s
;

48 
	gs
.
»size
(2);

50 
	gs
[0] = 
LOWER_XDIGITS
[
c
 >> 4];

51 
	gs
[1] = 
LOWER_XDIGITS
[
c
 & 0xf];

53  
	gs
;

56 
	g¡d
::
¡ršg
 
fÜm©_hex
(cÚ¡ 
ušt8_t
 *
s
, 
size_t
 
Ën
) {

57 
	g¡d
::
¡ršg
 
»s
;

58 
	g»s
.
»size
(
Ën
 * 2);

60 
size_t
 
	gi
 = 0; i < 
	gËn
; ++i) {

61 autØ
	gc
 = 
s
[
i
];

63 
	g»s
[
i
 * 2] = 
LOWER_XDIGITS
[
c
 >> 4];

64 
	g»s
[
i
 * 2 + 1] = 
LOWER_XDIGITS
[
c
 & 0x0f];

66  
	g»s
;

69 
	g¡d
::
¡ršg
 
fÜm©_hex
(cÚ¡ 
¡d
::¡ršg &
s
) {

70  
fÜm©_hex
(
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
s
.
d©a
()), s.
size
());

73 
	gÇme¥aû
 {

74 
ušt32_t
 
hex_to_ušt
(
c
) {

75 ià(
	gc
 <= '9') {

76  
c
 - '0';

78 ià(
	gc
 <= 'Z') {

79  
c
 - 'A' + 10;

81 ià(
	gc
 <= 'z') {

82  
c
 - 'a' + 10;

88 
	g¡d
::
¡ršg
 
decode_hex
(cÚ¡ 
¡d
::¡ršg &
s
) {

89 
as£¹
(
s
.
size
() % 2 == 0);

90 
	g¡d
::
¡ršg
 
»s
(
s
.
size
() / 2, '0');

91 autØ
	gp
 = 
¡d
::
begš
(
»s
);

92 autØ
	g™
 = 
¡d
::
begš
(
s
); iˆ!ğ¡d::
’d
(s); it += 2) {

93 *
p
++ = (
hex_to_ušt
(*
™
) << 4) | hex_to_uint(*(it + 1));

95  
	g»s
;

98 
	gÇme¥aû
 {

103 
	g¡d
::
¡ršg
 
fÜm©_äaùiÚ2
(
ušt32_t
 
n
) {

104 
n
 /= 10;

106 ià(
	gn
 < 10) {

107  {'.', '0', 
	g¡©ic_ÿ¡
<>('0' + 
	gn
)};

109  {'.', 
	g¡©ic_ÿ¡
<>('0' + 
	gn
 / 10),

110 
	g¡©ic_ÿ¡
<>('0' + (
	gn
 % 10))};

114 
	gÇme¥aû
 {

117 
ušt64_t
 
round2ev’
(ušt64_ˆ
n
) {

118 ià(
	gn
 % 10 == 5) {

119 ià((
n
 / 10) & 1) {

120 
n
 += 10;

123 
	gn
 += 5;

125  
	gn
;

129 
	g¡d
::
¡ršg
 
fÜm©_du¿tiÚ
(
ušt64_t
 
ns
) {

130 
cÚ¡ex´
 cÚ¡ *
un™s
[] = {"us", "ms", "s"};

131 ià(
	gns
 < 1000) {

132  
	g¡d
::
to_¡ršg
(
ns
) + "ns";

134 autØ
	gun™
 = 0;

135 ià(
	gns
 < 1000000) {

137 } ià(
	gns
 < 1000000000) {

138 
	gns
 /= 1000;

139 
	gun™
 = 1;

141 
	gns
 /= 1000000;

142 
	gun™
 = 2;

145 
	gns
 = 
round2ev’
(
ns
);

147 ià(
	gns
 / 1000 >ğ1000 && 
un™
 < 2) {

148 
ns
 /= 1000;

149 ++
	gun™
;

152  
	g¡d
::
to_¡ršg
(
ns
 / 1000è+ 
fÜm©_äaùiÚ2
Ò % 1000è+ 
un™s
[
un™
];

155 
	g¡d
::
mt19937
 
make_mt19937
() {

156 
¡d
::
¿ndom_deviû
 
rd
;

157  
	g¡d
::
mt19937
(
rd
());

160 
ngtı2_t¡amp
 
time¡amp
(
ev_loİ
 *
loİ
) {

161  
ev_now
(
loİ
è* 
	gNGTCP2_SECONDS
;

164 
boŞ
 
num”ic_ho¡
(cÚ¡ *
ho¡Çme
) {

165  
num”ic_ho¡
(
ho¡Çme
, 
AF_INET
è||‚um”ic_ho¡(ho¡Çme, 
AF_INET6
);

168 
boŞ
 
num”ic_ho¡
(cÚ¡ *
ho¡Çme
, 
çmy
) {

169 
	grv
;

170 
	g¡d
::
¬¿y
<
ušt8_t
, (
	gš6_addr
)> 
	gd¡
;

172 
	grv
 = 
š‘_±Ú
(
çmy
, 
ho¡Çme
, 
d¡
.
d©a
());

174  
	grv
 == 1;

177 
	gÇme¥aû
 {

178 
hexdump8
(
FILE
 *
out
, cÚ¡ 
ušt8_t
 *
fœ¡
, cÚ¡ ušt8_ˆ*
Ï¡
) {

179 autØ
	g¡İ
 = 
¡d
::
mš
(
fœ¡
 + 8, 
Ï¡
);

180 autØ
	gk
 = 
fœ¡
; k !ğ
¡İ
; ++k) {

181 
årštf
(
out
, "%02x ", *
k
);

184 ; 
	g¡İ
 !ğ
fœ¡
 + 8; ++stop) {

185 
åuts
(" ", 
out
);

188 
åutc
(' ', 
out
);

192 
hexdump
(
FILE
 *
out
, cÚ¡ 
ušt8_t
 *
¤c
, 
size_t
 
Ën
) {

193 ià(
	gËn
 == 0) {

196 
size_t
 
	gbuæ’
 = 0;

197 autØ
	g»³©ed
 = 
çl£
;

198 
	g¡d
::
¬¿y
<
ušt8_t
, 16> 
	gbuf
{};

199 autØ
	g’d
 = 
¤c
 + 
Ën
;

200 autØ
	gi
 = 
¤c
;

202 autØ
	gÃx’
 =

203 
¡d
::
mš
(
¡©ic_ÿ¡
<
size_t
>(16), stic_ÿ¡<size_t>(
’d
 - 
i
));

204 ià(
	gÃx’
 =ğ
buæ’
 &&

205 
¡d
::
equ®
(¡d::
begš
(
buf
), std::begš(bufè+ 
buæ’
, 
i
)) {

208 ià(!
	g»³©ed
) {

209 
	g»³©ed
 = 
Œue
;

210 
åuts
("*\n", 
out
);

212 
	gi
 +ğ
Ãx’
;

215 
	g»³©ed
 = 
çl£
;

216 
årštf
(
out
, "%08lx", 
¡©ic_ÿ¡
<>(
i
 - 
¤c
));

217 ià(
	gi
 =ğ
’d
) {

218 
åutc
('\n', 
out
);

221 
åuts
(" ", 
out
);

222 
hexdump8
(
out
, 
i
, 
’d
);

223 
hexdump8
(
out
, 
i
 + 8, 
¡d
::
max
(˜+ 8, 
’d
));

224 
åutc
('|', 
out
);

225 autØ
	g¡İ
 = 
¡d
::
mš
(
i
 + 16, 
’d
);

226 
	gbuæ’
 = 
¡İ
 - 
i
;

227 autØ
	gp
 = 
buf
.
d©a
();

228 ; 
	gi
 !ğ
¡İ
; ++i) {

229 *
	gp
++ = *
i
;

230 ià(0x20 <ğ*
i
 && *i <= 0x7e) {

231 
åutc
(*
i
, 
out
);

233 
åutc
('.', 
out
);

236 
åuts
("|\n", 
out
);

240 
	g¡d
::
¡ršg
 
make_cid_key
(cÚ¡ 
ngtı2_cid
 *
cid
) {

241  
¡d
::
¡ršg
(
cid
->
d©a
, cid->d©¨+ cid->
d©®’
);

244 
	g¡d
::
¡ršg
 
¡¿ddr
(cÚ¡ 
sockaddr
 *
§
, 
sockËn_t
 
§Ën
) {

245 
	g¡d
::
¬¿y
<, 
	gNI_MAXHOST
> 
	gho¡
;

246 
	g¡d
::
¬¿y
<, 
	gNI_MAXSERV
> 
	gpÜt
;

248 autØ
	grv
 = 
g‘Çmešfo
(
§
, 
§Ën
, 
ho¡
.
d©a
(), ho¡.
size
(), 
pÜt
.data(),

249 
pÜt
.
size
(), 
NI_NUMERICHOST
 | 
NI_NUMERICSERV
);

250 ià(
	grv
 != 0) {

251 
¡d
::
û¼
 << "g‘Çmešfo: " << 
gai_¡»¼Ü
(
rv
è<< std::
’dl
;

254 
	g¡d
::
¡ršg
 
»s
 = "[";

255 
	g»s
.
­³nd
(
ho¡
.
d©a
(), 
¡¾’
(host.data()));

256 
	g»s
 += "]:";

257 
	g»s
.
­³nd
(
pÜt
.
d©a
(), 
¡¾’
(port.data()));

258  
	g»s
;

	@examples/util.h

26 #iâdeà
UTIL_H


27 
	#UTIL_H


	)

29 #ifdeà
HAVE_CONFIG_H


30 
	~<cÚfig.h
>

33 
	~<sys/sock‘.h
>

35 
	~<¡ršg
>

36 
	~<¿ndom
>

38 
	~<ngtı2/ngtı2.h
>

40 
	~<ev.h
>

42 
Çme¥aû
 
	gngtı2
 {

44 
Çme¥aû
 
	gut
 {

46 
	g¡d
::
¡ršg
 
fÜm©_hex
(
ušt8_t
 
c
);

48 
	g¡d
::
¡ršg
 
fÜm©_hex
(cÚ¡ 
ušt8_t
 *
s
, 
size_t
 
Ën
);

50 
	g¡d
::
¡ršg
 
fÜm©_hex
(cÚ¡ 
¡d
::¡ršg &
s
);

52 
	g‹m¶©e
 <
size_t
 
	gN
> 
	g¡d
::
¡ršg
 
fÜm©_hex
(cÚ¡ 
ušt8_t
 (&
s
)[
N
]) {

53  
fÜm©_hex
(
s
, 
N
);

56 
	g¡d
::
¡ršg
 
decode_hex
(cÚ¡ 
¡d
::¡ršg &
s
);

63 
	g¡d
::
¡ršg
 
fÜm©_du¿tiÚ
(
ušt64_t
 
ns
);

65 
	g¡d
::
mt19937
 
make_mt19937
();

67 
ngtı2_t¡amp
 
time¡amp
(
ev_loİ
 *
loİ
);

69 
boŞ
 
num”ic_ho¡
(cÚ¡ *
ho¡Çme
);

71 
boŞ
 
num”ic_ho¡
(cÚ¡ *
ho¡Çme
, 
çmy
);

74 
hexdump
(
FILE
 *
out
, cÚ¡ 
ušt8_t
 *
¤c
, 
size_t
 
Ën
);

76 
šlše
 
lowÿ£
(
c
) {

77 
cÚ¡ex´
 
	gtbl
[] = {

97  
	gtbl
[
¡©ic_ÿ¡
<>(
c
)];

100 
	sCa£Cmp
 {

101 
boŞ
 
İ”©Ü
()(
	glhs
, 
	grhs
) const {

102  
lowÿ£
(
lhs
è=ğlowÿ£(
rhs
);

106 
	g‹m¶©e
 <
ty³Çme
 
	gIÅutI‹¿tÜ1
,y³Çm
	gIÅutI‹¿tÜ2
>

107 
boŞ
 
i¡¬ts_w™h
(
IÅutI‹¿tÜ1
 
fœ¡1
, IÅutI‹¿tÜ1 
Ï¡1
,

108 
IÅutI‹¿tÜ2
 
fœ¡2
, IÅutI‹¿tÜ2 
Ï¡2
) {

109 ià(
	gÏ¡1
 - 
	gfœ¡1
 < 
	gÏ¡2
 - 
	gfœ¡2
) {

110  
	gçl£
;

112  
	g¡d
::
equ®
(
fœ¡2
, 
Ï¡2
, 
fœ¡1
, 
Ca£Cmp
());

115 
	g‹m¶©e
 <
ty³Çme
 
	gS
,y³Çm
	gT
> 
boŞ
 
i¡¬ts_w™h
(cÚ¡ 
S
 &
a
, cÚ¡ 
T
 &
b
) {

116  
i¡¬ts_w™h
(
a
.
begš
(),‡.
’d
(), 
b
.begin(), b.end());

119 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gCh¬T
, 
size_t
 
	gN
>

120 
boŞ
 
i¡¬ts_w™h_l
(cÚ¡ 
T
 &
a
, cÚ¡ 
Ch¬T
 (&
b
)[
N
]) {

121  
i¡¬ts_w™h
(
a
.
begš
(),‡.
’d
(), 
b
, b + 
N
 - 1);

125 
	g¡d
::
¡ršg
 
make_cid_key
(cÚ¡ 
ngtı2_cid
 *
cid
);

128 
	g¡d
::
¡ršg
 
¡¿ddr
(cÚ¡ 
sockaddr
 *
§
, 
sockËn_t
 
§Ën
);

	@examples/util_test.cc

25 
	~"ut_‹¡.h
"

27 
	~<CUn™/CUn™.h
>

29 
	~"ut.h
"

31 
Çme¥aû
 
	gngtı2
 {

33 
‹¡_ut_fÜm©_du¿tiÚ
() {

34 
CU_ASSERT
("0ns" =ğ
ut
::
fÜm©_du¿tiÚ
(0));

35 
CU_ASSERT
("999ns" =ğ
ut
::
fÜm©_du¿tiÚ
(999));

36 
CU_ASSERT
("1.00us" =ğ
ut
::
fÜm©_du¿tiÚ
(1000));

37 
CU_ASSERT
("1.00us" =ğ
ut
::
fÜm©_du¿tiÚ
(1004));

38 
CU_ASSERT
("1.00us" =ğ
ut
::
fÜm©_du¿tiÚ
(1005));

39 
CU_ASSERT
("1.02us" =ğ
ut
::
fÜm©_du¿tiÚ
(1015));

40 
CU_ASSERT
("2.00us" =ğ
ut
::
fÜm©_du¿tiÚ
(1999));

41 
CU_ASSERT
("1.00ms" =ğ
ut
::
fÜm©_du¿tiÚ
(999999));

42 
CU_ASSERT
("3.50ms" =ğ
ut
::
fÜm©_du¿tiÚ
(3500111));

43 
CU_ASSERT
("9999.99s" =ğ
ut
::
fÜm©_du¿tiÚ
(9999990000000llu));

	@examples/util_test.h

25 #iâdeà
UTIL_TEST_H


26 
	#UTIL_TEST_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~"cÚfig.h
"

32 
Çme¥aû
 
	gngtı2
 {

34 
‹¡_ut_fÜm©_du¿tiÚ
();

	@lib/includes/ngtcp2/ngtcp2.h

26 #iâdeà
NGTCP2_H


27 
	#NGTCP2_H


	)

31 #ià(
defšed
(
_WIN32
è|| defšed(
__WIN32__
)è&& !defšed(
WIN32
)

32 
	#WIN32


	)

35 #ifdeà
__ılu¥lus


39 
	~<¡dlib.h
>

40 #ià
defšed
(
_MSC_VER
) && (_MSC_VER < 1800)

44 
	~<¡dšt.h
>

46 
	~<š‰y³s.h
>

48 
	~<sys/ty³s.h
>

49 
	~<¡d¬g.h
>

51 
	~<ngtı2/v”siÚ.h
>

53 #ifdeà
NGTCP2_STATICLIB


54 
	#NGTCP2_EXTERN


	)

55 #–ià
defšed
(
WIN32
)

56 #ifdeà
BUILDING_NGTCP2


57 
	#NGTCP2_EXTERN
 
	`__deş¥ec
(
dÎexpÜt
)

	)

59 
	#NGTCP2_EXTERN
 
	`__deş¥ec
(
dÎimpÜt
)

	)

62 #ifdeà
BUILDING_NGTCP2


63 
	#NGTCP2_EXTERN
 
	`__©Œibu‹__
((
	`visib™y
("deçuÉ")))

	)

65 
	#NGTCP2_EXTERN


	)

75 *(*
	tngtı2_m®loc
)(
	tsize_t
 
	tsize
, *
	tmem_u£r_d©a
);

83 (*
ngtı2_ä“
)(*
	t±r
, *
	tmem_u£r_d©a
);

91 *(*
	tngtı2_ÿÎoc
)(
	tsize_t
 
	tnmemb
, size_ˆ
	tsize
, *
	tmem_u£r_d©a
);

99 *(*
	tngtı2_»®loc
)(*
	t±r
, 
	tsize_t
 
	tsize
, *
	tmem_u£r_d©a
);

139 *
mem_u£r_d©a
;

143 
ngtı2_m®loc
 
m®loc
;

147 
ngtı2_ä“
 
ä“
;

151 
ngtı2_ÿÎoc
 
ÿÎoc
;

155 
ngtı2_»®loc
 
»®loc
;

156 } 
	tngtı2_mem
;

160 
	#NGTCP2_PROTO_VER_D17
 0xff000011u

	)

163 
	#NGTCP2_PROTO_VER_MAX
 
NGTCP2_PROTO_VER_D17


	)

168 
	#NGTCP2_ALPN_D17
 "\x5hq-17"

	)

170 
	#NGTCP2_MAX_PKTLEN_IPV4
 1252

	)

171 
	#NGTCP2_MAX_PKTLEN_IPV6
 1232

	)

175 
	#NGTCP2_MIN_INITIAL_PKTLEN
 1200

	)

179 
	#NGTCP2_MAX_INITIAL_PKT_NUM
 0xfffffbffu

	)

183 
	#NGTCP2_STATELESS_RESET_TOKENLEN
 16

	)

187 
	#NGTCP2_MIN_STATELESS_RESET_RANDLEN
 23

	)

191 
	#NGTCP2_INITIAL_SALT
 \

193 "\x09\xa0"

	)

196 
	#NGTCP2_HP_MASKLEN
 5

	)

199 
	#NGTCP2_DURATION_TICK
 1000000000

	)

202 
	#NGTCP2_SECONDS
 1000000000

	)

206 
	#NGTCP2_MILLISECONDS
 1000000

	)

210 
	#NGTCP2_MICROSECONDS
 1000

	)

214 
	#NGTCP2_NANOSECONDS
 1

	)

217 
NGTCP2_ERR_INVALID_ARGUMENT
 = -201,

218 
NGTCP2_ERR_UNKNOWN_PKT_TYPE
 = -202,

219 
NGTCP2_ERR_NOBUF
 = -203,

220 
NGTCP2_ERR_PROTO
 = -205,

221 
NGTCP2_ERR_INVALID_STATE
 = -206,

222 
NGTCP2_ERR_ACK_FRAME
 = -207,

223 
NGTCP2_ERR_STREAM_ID_BLOCKED
 = -208,

224 
NGTCP2_ERR_STREAM_IN_USE
 = -209,

225 
NGTCP2_ERR_STREAM_DATA_BLOCKED
 = -210,

226 
NGTCP2_ERR_FLOW_CONTROL
 = -211,

227 
NGTCP2_ERR_STREAM_LIMIT
 = -213,

228 
NGTCP2_ERR_FINAL_OFFSET
 = -214,

229 
NGTCP2_ERR_CRYPTO
 = -215,

230 
NGTCP2_ERR_PKT_NUM_EXHAUSTED
 = -216,

231 
NGTCP2_ERR_REQUIRED_TRANSPORT_PARAM
 = -217,

232 
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
 = -218,

233 
NGTCP2_ERR_FRAME_ENCODING
 = -219,

234 
NGTCP2_ERR_TLS_DECRYPT
 = -220,

235 
NGTCP2_ERR_STREAM_SHUT_WR
 = -221,

236 
NGTCP2_ERR_STREAM_NOT_FOUND
 = -222,

237 
NGTCP2_ERR_VERSION_NEGOTIATION
 = -223,

238 
NGTCP2_ERR_STREAM_STATE
 = -226,

239 
NGTCP2_ERR_NOKEY
 = -227,

240 
NGTCP2_ERR_EARLY_DATA_REJECTED
 = -228,

241 
NGTCP2_ERR_RECV_VERSION_NEGOTIATION
 = -229,

242 
NGTCP2_ERR_CLOSING
 = -230,

243 
NGTCP2_ERR_DRAINING
 = -231,

244 
NGTCP2_ERR_TRANSPORT_PARAM
 = -234,

245 
NGTCP2_ERR_DISCARD_PKT
 = -235,

246 
NGTCP2_ERR_FATAL
 = -500,

247 
NGTCP2_ERR_NOMEM
 = -501,

248 
NGTCP2_ERR_CALLBACK_FAILURE
 = -502,

249 
NGTCP2_ERR_INTERNAL
 = -503

250 } 
	tngtı2_lib_”rÜ
;

253 
NGTCP2_PKT_FLAG_NONE
 = 0,

254 
NGTCP2_PKT_FLAG_LONG_FORM
 = 0x01,

255 
NGTCP2_PKT_FLAG_KEY_PHASE
 = 0x04

256 } 
	tngtı2_pkt_æag
;

261 
NGTCP2_PKT_VERSION_NEGOTIATION
 = 0xf0,

262 
NGTCP2_PKT_INITIAL
 = 0x0,

263 
NGTCP2_PKT_0RTT_PROTECTED
 = 0x1,

264 
NGTCP2_PKT_HANDSHAKE
 = 0x2,

265 
NGTCP2_PKT_RETRY
 = 0x3,

267 
NGTCP2_PKT_SHORT
 = 0x70

268 } 
	tngtı2_pkt_ty³
;

271 
NGTCP2_FRAME_PADDING
 = 0x00,

272 
NGTCP2_FRAME_PING
 = 0x01,

273 
NGTCP2_FRAME_ACK
 = 0x02,

274 
NGTCP2_FRAME_ACK_ECN
 = 0x03,

275 
NGTCP2_FRAME_RESET_STREAM
 = 0x04,

276 
NGTCP2_FRAME_STOP_SENDING
 = 0x05,

277 
NGTCP2_FRAME_CRYPTO
 = 0x06,

278 
NGTCP2_FRAME_NEW_TOKEN
 = 0x07,

279 
NGTCP2_FRAME_STREAM
 = 0x08,

280 
NGTCP2_FRAME_MAX_DATA
 = 0x10,

281 
NGTCP2_FRAME_MAX_STREAM_DATA
 = 0x11,

282 
NGTCP2_FRAME_MAX_STREAMS_BIDI
 = 0x12,

283 
NGTCP2_FRAME_MAX_STREAMS_UNI
 = 0x13,

284 
NGTCP2_FRAME_DATA_BLOCKED
 = 0x14,

285 
NGTCP2_FRAME_STREAM_DATA_BLOCKED
 = 0x15,

286 
NGTCP2_FRAME_STREAMS_BLOCKED_BIDI
 = 0x16,

287 
NGTCP2_FRAME_STREAMS_BLOCKED_UNI
 = 0x17,

288 
NGTCP2_FRAME_NEW_CONNECTION_ID
 = 0x18,

289 
NGTCP2_FRAME_RETIRE_CONNECTION_ID
 = 0x19,

290 
NGTCP2_FRAME_PATH_CHALLENGE
 = 0x1a,

291 
NGTCP2_FRAME_PATH_RESPONSE
 = 0x1b,

292 
NGTCP2_FRAME_CONNECTION_CLOSE
 = 0x1c,

293 
NGTCP2_FRAME_CONNECTION_CLOSE_APP
 = 0x1d

294 } 
	tngtı2_äame_ty³
;

297 
NGTCP2_NO_ERROR
 = 0x0u,

298 
NGTCP2_INTERNAL_ERROR
 = 0x1u,

299 
NGTCP2_SERVER_BUSY
 = 0x2u,

300 
NGTCP2_FLOW_CONTROL_ERROR
 = 0x3u,

301 
NGTCP2_STREAM_LIMIT_ERROR
 = 0x4u,

302 
NGTCP2_STREAM_STATE_ERROR
 = 0x5u,

303 
NGTCP2_FINAL_OFFSET_ERROR
 = 0x6u,

304 
NGTCP2_FRAME_ENCODING_ERROR
 = 0x7u,

305 
NGTCP2_TRANSPORT_PARAMETER_ERROR
 = 0x8u,

306 
NGTCP2_VERSION_NEGOTIATION_ERROR
 = 0x9u,

307 
NGTCP2_PROTOCOL_VIOLATION
 = 0xau,

308 
NGTCP2_INVALID_MIGRATION
 = 0xcu,

309 
NGTCP2_CRYPTO_ERROR
 = 0x100

310 } 
	tngtı2_Œª¥Üt_”rÜ
;

313 
NGTCP2_PATH_VALIDATION_RESULT_SUCCESS
,

314 
NGTCP2_PATH_VALIDATION_RESULT_FAILURE
,

315 } 
	tngtı2_·th_v®id©iÚ_»suÉ
;

320 
ušt64_t
 
	tngtı2_t¡amp
;

326 
ušt64_t
 
	tngtı2_du¿tiÚ
;

329 
	#NGTCP2_MAX_CIDLEN
 18

	)

331 
	#NGTCP2_MIN_CIDLEN
 4

	)

339 
size_t
 
d©®’
;

340 
ušt8_t
 
d©a
[
NGTCP2_MAX_CIDLEN
];

341 } 
	tngtı2_cid
;

351 
ušt8_t
 *
ba£
;

354 
size_t
 
Ën
;

355 } 
	tngtı2_vec
;

365 
NGTCP2_EXTERN
 
ngtı2_cid_š™
(
ngtı2_cid
 *
cid
, cÚ¡ 
ušt8_t
 *
d©a
,

366 
size_t
 
d©®’
);

369 
ngtı2_cid
 
dcid
;

370 
ngtı2_cid
 
scid
;

371 
ušt64_t
 
pkt_num
;

372 
ušt8_t
 *
tok’
;

373 
size_t
 
tok’Ën
;

377 
size_t
 
pkt_numËn
;

382 
size_t
 
Ën
;

383 
ušt32_t
 
v”siÚ
;

384 
ušt8_t
 
ty³
;

385 
ušt8_t
 
æags
;

386 } 
	tngtı2_pkt_hd
;

389 cÚ¡ 
ušt8_t
 *
¡©–ess_»£t_tok’
;

390 cÚ¡ 
ušt8_t
 *
¿nd
;

391 
size_t
 
¿ndËn
;

392 } 
	tngtı2_pkt_¡©–ess_»£t
;

395 
ngtı2_cid
 
odcid
;

396 cÚ¡ 
ušt8_t
 *
tok’
;

397 
size_t
 
tok’Ën
;

398 } 
	tngtı2_pkt_»Œy
;

401 
ušt8_t
 
ty³
;

406 
ušt8_t
 
æags
;

407 
ušt8_t
 
fš
;

408 
ušt64_t
 
¡»am_id
;

409 
ušt64_t
 
off£t
;

413 
size_t
 
d©aút
;

415 
ngtı2_vec
 
d©a
[1];

416 } 
	tngtı2_¡»am
;

419 
ušt64_t
 
g­
;

420 
ušt64_t
 
blkËn
;

421 } 
	tngtı2_ack_blk
;

424 
ušt8_t
 
ty³
;

425 
ušt64_t
 
Ïrge¡_ack
;

426 
ušt64_t
 
ack_d–ay
;

432 
ngtı2_du¿tiÚ
 
ack_d–ay_unsÿËd
;

433 
ušt64_t
 
fœ¡_ack_blkËn
;

434 
size_t
 
num_blks
;

435 
ngtı2_ack_blk
 
blks
[1];

436 } 
	tngtı2_ack
;

439 
ušt8_t
 
ty³
;

443 
size_t
 
Ën
;

444 } 
	tngtı2_·ddšg
;

447 
ušt8_t
 
ty³
;

448 
ušt64_t
 
¡»am_id
;

449 
ušt16_t
 
­p_”rÜ_code
;

450 
ušt64_t
 
fš®_off£t
;

451 } 
	tngtı2_»£t_¡»am
;

454 
ušt8_t
 
ty³
;

455 
ušt16_t
 
”rÜ_code
;

456 
ušt8_t
 
äame_ty³
;

457 
size_t
 
»asÚËn
;

458 
ušt8_t
 *
»asÚ
;

459 } 
	tngtı2_cÚÃùiÚ_şo£
;

462 
ušt8_t
 
ty³
;

466 
ušt64_t
 
max_d©a
;

467 } 
	tngtı2_max_d©a
;

470 
ušt8_t
 
ty³
;

471 
ušt64_t
 
¡»am_id
;

472 
ušt64_t
 
max_¡»am_d©a
;

473 } 
	tngtı2_max_¡»am_d©a
;

476 
ušt8_t
 
ty³
;

477 
ušt64_t
 
max_¡»ams
;

478 } 
	tngtı2_max_¡»ams
;

481 
ušt8_t
 
ty³
;

482 } 
	tngtı2_pšg
;

485 
ušt8_t
 
ty³
;

486 
ušt64_t
 
off£t
;

487 } 
	tngtı2_d©a_blocked
;

490 
ušt8_t
 
ty³
;

491 
ušt64_t
 
¡»am_id
;

492 
ušt64_t
 
off£t
;

493 } 
	tngtı2_¡»am_d©a_blocked
;

496 
ušt8_t
 
ty³
;

497 
ušt64_t
 
¡»am_lim™
;

498 } 
	tngtı2_¡»ams_blocked
;

501 
ušt8_t
 
ty³
;

502 
ušt64_t
 
£q
;

503 
ngtı2_cid
 
cid
;

504 
ušt8_t
 
¡©–ess_»£t_tok’
[
NGTCP2_STATELESS_RESET_TOKENLEN
];

505 } 
	tngtı2_Ãw_cÚÃùiÚ_id
;

508 
ušt8_t
 
ty³
;

509 
ušt64_t
 
¡»am_id
;

510 
ušt16_t
 
­p_”rÜ_code
;

511 } 
	tngtı2_¡İ_£ndšg
;

514 
ušt8_t
 
ty³
;

515 
ušt8_t
 
d©a
[8];

516 } 
	tngtı2_·th_ch®Ënge
;

519 
ušt8_t
 
ty³
;

520 
ušt8_t
 
d©a
[8];

521 } 
	tngtı2_·th_»¥Ú£
;

524 
ušt8_t
 
ty³
;

531 
ušt64_t
 
Üd”ed_off£t
;

532 
ušt64_t
 
off£t
;

536 
size_t
 
d©aút
;

538 
ngtı2_vec
 
d©a
[1];

539 } 
	tngtı2_üy±o
;

542 
ušt8_t
 
ty³
;

543 
size_t
 
tok’Ën
;

544 cÚ¡ 
ušt8_t
 *
tok’
;

545 } 
	tngtı2_Ãw_tok’
;

548 
ušt8_t
 
ty³
;

549 
ušt64_t
 
£q
;

550 } 
	tngtı2_»tœe_cÚÃùiÚ_id
;

553 
ušt8_t
 
ty³
;

554 
ngtı2_¡»am
 
¡»am
;

555 
ngtı2_ack
 
ack
;

556 
ngtı2_·ddšg
 
·ddšg
;

557 
ngtı2_»£t_¡»am
 
»£t_¡»am
;

558 
ngtı2_cÚÃùiÚ_şo£
 
cÚÃùiÚ_şo£
;

559 
ngtı2_max_d©a
 
max_d©a
;

560 
ngtı2_max_¡»am_d©a
 
max_¡»am_d©a
;

561 
ngtı2_max_¡»ams
 
max_¡»ams
;

562 
ngtı2_pšg
 
pšg
;

563 
ngtı2_d©a_blocked
 
d©a_blocked
;

564 
ngtı2_¡»am_d©a_blocked
 
¡»am_d©a_blocked
;

565 
ngtı2_¡»ams_blocked
 
¡»ams_blocked
;

566 
ngtı2_Ãw_cÚÃùiÚ_id
 
Ãw_cÚÃùiÚ_id
;

567 
ngtı2_¡İ_£ndšg
 
¡İ_£ndšg
;

568 
ngtı2_·th_ch®Ënge
 
·th_ch®Ënge
;

569 
ngtı2_·th_»¥Ú£
 
·th_»¥Ú£
;

570 
ngtı2_üy±o
 
üy±o
;

571 
ngtı2_Ãw_tok’
 
Ãw_tok’
;

572 
ngtı2_»tœe_cÚÃùiÚ_id
 
»tœe_cÚÃùiÚ_id
;

573 } 
	tngtı2_äame
;

576 
NGTCP2_TRANSPORT_PARAM_ORIGINAL_CONNECTION_ID
 = 0x0000,

577 
NGTCP2_TRANSPORT_PARAM_IDLE_TIMEOUT
 = 0x0001,

578 
NGTCP2_TRANSPORT_PARAM_STATELESS_RESET_TOKEN
 = 0x0002,

579 
NGTCP2_TRANSPORT_PARAM_MAX_PACKET_SIZE
 = 0x0003,

580 
NGTCP2_TRANSPORT_PARAM_INITIAL_MAX_DATA
 = 0x0004,

581 
NGTCP2_TRANSPORT_PARAM_INITIAL_MAX_STREAM_DATA_BIDI_LOCAL
 = 0x0005,

582 
NGTCP2_TRANSPORT_PARAM_INITIAL_MAX_STREAM_DATA_BIDI_REMOTE
 = 0x0006,

583 
NGTCP2_TRANSPORT_PARAM_INITIAL_MAX_STREAM_DATA_UNI
 = 0x0007,

584 
NGTCP2_TRANSPORT_PARAM_INITIAL_MAX_STREAMS_BIDI
 = 0x0008,

585 
NGTCP2_TRANSPORT_PARAM_INITIAL_MAX_STREAMS_UNI
 = 0x0009,

586 
NGTCP2_TRANSPORT_PARAM_ACK_DELAY_EXPONENT
 = 0x000a,

587 
NGTCP2_TRANSPORT_PARAM_MAX_ACK_DELAY
 = 0x000b,

588 
NGTCP2_TRANSPORT_PARAM_DISABLE_MIGRATION
 = 0x000c,

589 
NGTCP2_TRANSPORT_PARAM_PREFERRED_ADDRESS
 = 0x000d,

590 } 
	tngtı2_Œª¥Üt_·¿m_id
;

593 
NGTCP2_TRANSPORT_PARAMS_TYPE_CLIENT_HELLO
,

594 
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS


595 } 
	tngtı2_Œª¥Üt_·¿ms_ty³
;

603 
NGTCP2_RAND_CTX_NONE
,

608 
NGTCP2_RAND_CTX_PATH_CHALLENGE


609 } 
	tngtı2_¿nd_ùx
;

611 
	#NGTCP2_MAX_PKT_SIZE
 65527

	)

619 
	#NGTCP2_DEFAULT_ACK_DELAY_EXPONENT
 3

	)

628 
	#NGTCP2_DEFAULT_MAX_ACK_DELAY
 25

	)

636 
	#NGTCP2_TLSEXT_QUIC_TRANSPORT_PARAMETERS
 0xfç5u

	)

639 
NGTCP2_IP_VERSION_NONE
 = 0,

640 
NGTCP2_IP_VERSION_4
 = 4,

641 
NGTCP2_IP_VERSION_6
 = 6

642 } 
	tngtı2__v”siÚ
;

645 
ngtı2_cid
 
cid
;

647 
size_t
 
_add»s¦’
;

648 
ušt16_t
 
pÜt
;

653 
ušt8_t
 
_v”siÚ
;

654 
ušt8_t
 
_add»ss
[255];

655 
ušt8_t
 
¡©–ess_»£t_tok’
[
NGTCP2_STATELESS_RESET_TOKENLEN
];

656 } 
	tngtı2_´eã¼ed_addr
;

661 
ušt32_t
 
š™Ÿl_v”siÚ
;

662 } 
ch
;

664 
ušt32_t
 
ÃgÙŸ‹d_v”siÚ
;

665 
ušt32_t
 
suµÜ‹d_v”siÚs
[63];

666 
size_t
 
Ën
;

667 } 
“
;

668 } 
v
;

669 
ngtı2_´eã¼ed_addr
 
´eã¼ed_add»ss
;

670 
ngtı2_cid
 
Üigš®_cÚÃùiÚ_id
;

671 
ušt64_t
 
š™Ÿl_max_¡»am_d©a_bidi_loÿl
;

672 
ušt64_t
 
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
;

673 
ušt64_t
 
š™Ÿl_max_¡»am_d©a_uni
;

674 
ušt64_t
 
š™Ÿl_max_d©a
;

675 
ušt64_t
 
š™Ÿl_max_¡»ams_bidi
;

676 
ušt64_t
 
š™Ÿl_max_¡»ams_uni
;

677 
ušt64_t
 
idË_timeout
;

678 
ušt64_t
 
max_·ck‘_size
;

679 
ušt8_t
 
¡©–ess_»£t_tok’
[
NGTCP2_STATELESS_RESET_TOKENLEN
];

680 
ušt8_t
 
¡©–ess_»£t_tok’_´e£Á
;

681 
ušt64_t
 
ack_d–ay_expÚ’t
;

682 
ušt8_t
 
di§bË_mig¿tiÚ
;

683 
ušt8_t
 
Üigš®_cÚÃùiÚ_id_´e£Á
;

684 
ušt64_t
 
max_ack_d–ay
;

685 } 
	tngtı2_Œª¥Üt_·¿ms
;

689 (*
ngtı2_´štf
)(*
	tu£r_d©a
, cÚ¡ *
	tfÜm©
, ...);

692 
ngtı2_´eã¼ed_addr
 
´eã¼ed_add»ss
;

693 
ngtı2_t¡amp
 
š™Ÿl_ts
;

696 
ngtı2_´štf
 
log_´štf
;

697 
ušt64_t
 
max_¡»am_d©a_bidi_loÿl
;

698 
ušt64_t
 
max_¡»am_d©a_bidi_»mÙe
;

699 
ušt64_t
 
max_¡»am_d©a_uni
;

700 
ušt64_t
 
max_d©a
;

701 
ušt64_t
 
max_¡»ams_bidi
;

702 
ušt64_t
 
max_¡»ams_uni
;

703 
ušt64_t
 
idË_timeout
;

704 
ušt64_t
 
max_·ck‘_size
;

705 
ušt8_t
 
¡©–ess_»£t_tok’
[
NGTCP2_STATELESS_RESET_TOKENLEN
];

706 
ušt8_t
 
¡©–ess_»£t_tok’_´e£Á
;

707 
ušt64_t
 
ack_d–ay_expÚ’t
;

708 
ušt8_t
 
di§bË_mig¿tiÚ
;

709 
ušt64_t
 
max_ack_d–ay
;

710 } 
	tngtı2_£‰šgs
;

721 
ngtı2_du¿tiÚ
 
Ï‹¡_¹t
;

722 
ngtı2_du¿tiÚ
 
mš_¹t
;

723 
ngtı2_du¿tiÚ
 
max_ack_d–ay
;

724 
smoÙhed_¹t
;

725 
¹tv¬
;

726 
ngtı2_t¡amp
 
loss_time
;

727 
size_t
 
±o_couÁ
;

728 
size_t
 
üy±o_couÁ
;

730 
size_t
 
´obe_pkt_Ëá
;

731 
ngtı2_t¡amp
 
loss_d‘eùiÚ_tim”
;

735 
ngtı2_t¡amp
 
Ï¡_tx_pkt_ts
;

738 
ngtı2_t¡amp
 
Ï¡_hs_tx_pkt_ts
;

739 } 
	tngtı2_rcvry_¡©
;

748 
size_t
 
Ën
;

751 
ušt8_t
 *
addr
;

752 } 
	tngtı2_addr
;

762 
ngtı2_addr
 
loÿl
;

764 
ngtı2_addr
 
»mÙe
;

765 } 
	tngtı2_·th
;

774 
ngtı2_·th
 
·th
;

775 
ušt8_t
 
loÿl_addrbuf
[128];

776 
ušt8_t
 
»mÙe_addrbuf
[128];

777 } 
	tngtı2_·th_¡Üage
;

793 
NGTCP2_EXTERN
 
ssize_t


794 
ngtı2_’code_Œª¥Üt_·¿ms
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, ušt8_ˆ
ex‰y³
,

795 cÚ¡ 
ngtı2_Œª¥Üt_·¿ms
 *
·¿ms
);

817 
NGTCP2_EXTERN
 

818 
ngtı2_decode_Œª¥Üt_·¿ms
(
ngtı2_Œª¥Üt_·¿ms
 *
·¿ms
, 
ušt8_t
 
ex‰y³
,

819 cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
);

848 
NGTCP2_EXTERN
 
ssize_t
 
ngtı2_pkt_decode_hd_lÚg
(
ngtı2_pkt_hd
 *
de¡
,

849 cÚ¡ 
ušt8_t
 *
pkt
,

850 
size_t
 
pk’
);

869 
NGTCP2_EXTERN
 
ssize_t
 
ngtı2_pkt_decode_hd_shÜt
(
ngtı2_pkt_hd
 *
de¡
,

870 cÚ¡ 
ušt8_t
 *
pkt
,

871 
size_t
 
pk’
, size_ˆ
dcidËn
);

885 
NGTCP2_EXTERN
 
ssize_t
 
ngtı2_pkt_decode_äame
(
ngtı2_äame
 *
de¡
,

886 cÚ¡ 
ušt8_t
 *
·ylßd
,

887 
size_t
 
·ylßdËn
);

901 
NGTCP2_EXTERN
 
ssize_t
 
ngtı2_pkt_’code_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

902 
ngtı2_äame
 *
ä
);

928 
NGTCP2_EXTERN
 
ssize_t
 
ngtı2_pkt_wr™e_¡©–ess_»£t
(

929 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, ušt8_ˆ*
¡©–ess_»£t_tok’
,

930 
ušt8_t
 *
¿nd
, 
size_t
 
¿ndËn
);

947 
NGTCP2_EXTERN
 
ssize_t
 
ngtı2_pkt_wr™e_»Œy
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

948 cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

949 cÚ¡ 
ngtı2_cid
 *
odcid
,

950 cÚ¡ 
ušt8_t
 *
tok’
,

951 
size_t
 
tok’Ën
);

972 
NGTCP2_EXTERN
 
ssize_t
 
ngtı2_pkt_wr™e_v”siÚ_ÃgÙŸtiÚ
(

973 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, ušt8_ˆ
unu£d_¿ndom
,

974 cÚ¡ 
ngtı2_cid
 *
dcid
, cÚ¡‚gtı2_cid *
scid
, cÚ¡ 
ušt32_t
 *
sv
,

975 
size_t
 
nsv
);

983 
NGTCP2_EXTERN
 
ušt8_t
 
ngtı2_pkt_g‘_ty³_lÚg
(ušt8_ˆ
c
);

985 
ngtı2_cÚn
;

987 
ngtı2_cÚn
 
	tngtı2_cÚn
;

1011 (*
ngtı2_ş›Á_š™Ÿl
)(
	tngtı2_cÚn
 *
	tcÚn
, *
	tu£r_d©a
);

1032 (*
ngtı2_»cv_ş›Á_š™Ÿl
)(
	tngtı2_cÚn
 *
	tcÚn
,

1033 cÚ¡ 
	tngtı2_cid
 *
	tdcid
,

1034 *
	tu£r_d©a
);

1057 (*
ngtı2_»cv_üy±o_d©a
)(
	tngtı2_cÚn
 *
	tcÚn
, 
	tušt64_t
 
	toff£t
,

1058 cÚ¡ 
	tušt8_t
 *
	td©a
, 
	tsize_t
 
	td©®’
,

1059 *
	tu£r_d©a
);

1071 (*
ngtı2_hªdshake_com¶‘ed
)(
	tngtı2_cÚn
 *
	tcÚn
, *
	tu£r_d©a
);

1086 (*
ngtı2_»cv_v”siÚ_ÃgÙŸtiÚ
)(
	tngtı2_cÚn
 *
	tcÚn
,

1087 cÚ¡ 
	tngtı2_pkt_hd
 *
	thd
,

1088 cÚ¡ 
	tušt32_t
 *
	tsv
, 
	tsize_t
 
	tnsv
,

1089 *
	tu£r_d©a
);

1110 (*
ngtı2_»cv_»Œy
)(
	tngtı2_cÚn
 *
	tcÚn
, cÚ¡ 
	tngtı2_pkt_hd
 *
	thd
,

1111 cÚ¡ 
	tngtı2_pkt_»Œy
 *
	t»Œy
,

1112 *
	tu£r_d©a
);

1134 
ssize_t
 (*
	tngtı2_’üy±
)(
	tngtı2_cÚn
 *
	tcÚn
, 
	tušt8_t
 *
	tde¡
,

1135 
	tsize_t
 
	tde¡Ën
, cÚ¡ 
	tušt8_t
 *
	t¶aš‹xt
,

1136 
	tsize_t
 
	t¶aš‹x’
, cÚ¡ 
	tušt8_t
 *
	tkey
,

1137 
	tsize_t
 
	tkeyËn
, cÚ¡ 
	tušt8_t
 *
	tnÚû
,

1138 
	tsize_t
 
	tnÚûËn
, cÚ¡ 
	tušt8_t
 *
	tad
,

1139 
	tsize_t
 
	tadËn
, *
	tu£r_d©a
);

1163 
ssize_t
 (*
	tngtı2_deüy±
)(
	tngtı2_cÚn
 *
	tcÚn
, 
	tušt8_t
 *
	tde¡
,

1164 
	tsize_t
 
	tde¡Ën
, cÚ¡ 
	tušt8_t
 *
	tch”‹xt
,

1165 
	tsize_t
 
	tch”‹x’
, cÚ¡ 
	tušt8_t
 *
	tkey
,

1166 
	tsize_t
 
	tkeyËn
, cÚ¡ 
	tušt8_t
 *
	tnÚû
,

1167 
	tsize_t
 
	tnÚûËn
, cÚ¡ 
	tušt8_t
 *
	tad
,

1168 
	tsize_t
 
	tadËn
, *
	tu£r_d©a
);

1189 
ssize_t
 (*
	tngtı2_hp_mask
)(
	tngtı2_cÚn
 *
	tcÚn
, 
	tušt8_t
 *
	tde¡
,

1190 
	tsize_t
 
	tde¡Ën
, cÚ¡ 
	tušt8_t
 *
	tkey
,

1191 
	tsize_t
 
	tkeyËn
, cÚ¡ 
	tušt8_t
 *
	t§m¶e
,

1192 
	tsize_t
 
	t§m¶–’
, *
	tu£r_d©a
);

1209 (*
ngtı2_»cv_¡»am_d©a
)(
	tngtı2_cÚn
 *
	tcÚn
, 
	tušt64_t
 
	t¡»am_id
,

1210 
	tfš
, 
	tušt64_t
 
	toff£t
,

1211 cÚ¡ 
	tušt8_t
 *
	td©a
, 
	tsize_t
 
	td©®’
,

1212 *
	tu£r_d©a
, *
	t¡»am_u£r_d©a
);

1226 (*
ngtı2_¡»am_İ’
)(
	tngtı2_cÚn
 *
	tcÚn
, 
	tušt64_t
 
	t¡»am_id
,

1227 *
	tu£r_d©a
);

1241 (*
ngtı2_¡»am_şo£
)(
	tngtı2_cÚn
 *
	tcÚn
, 
	tušt64_t
 
	t¡»am_id
,

1242 
	tušt16_t
 
	t­p_”rÜ_code
, *
	tu£r_d©a
,

1243 *
	t¡»am_u£r_d©a
);

1263 (*
ngtı2_acked_¡»am_d©a_off£t
)(
	tngtı2_cÚn
 *
	tcÚn
,

1264 
	tušt64_t
 
	t¡»am_id
,

1265 
	tušt64_t
 
	toff£t
, 
	tsize_t
 
	td©®’
,

1266 *
	tu£r_d©a
,

1267 *
	t¡»am_u£r_d©a
);

1282 (*
ngtı2_acked_üy±o_off£t
)(
	tngtı2_cÚn
 *
	tcÚn
, 
	tušt64_t
 
	toff£t
,

1283 
	tsize_t
 
	td©®’
, *
	tu£r_d©a
);

1296 (*
ngtı2_»cv_¡©–ess_»£t
)(
	tngtı2_cÚn
 *
	tcÚn
,

1297 cÚ¡ 
	tngtı2_pkt_hd
 *
	thd
,

1298 cÚ¡ 
	tngtı2_pkt_¡©–ess_»£t
 *
	t¤
,

1299 *
	tu£r_d©a
);

1313 (*
ngtı2_ex‹nd_max_¡»ams
)(
	tngtı2_cÚn
 *
	tcÚn
,

1314 
	tušt64_t
 
	tmax_¡»ams
, *
	tu£r_d©a
);

1328 (*
ngtı2_¿nd
)(
	tngtı2_cÚn
 *
	tcÚn
, 
	tušt8_t
 *
	tde¡
, 
	tsize_t
 
	tde¡Ën
,

1329 
	tngtı2_¿nd_ùx
 
	tùx
, *
	tu£r_d©a
);

1347 (*
ngtı2_g‘_Ãw_cÚÃùiÚ_id
)(
	tngtı2_cÚn
 *
	tcÚn
, 
	tngtı2_cid
 *
	tcid
,

1348 
	tušt8_t
 *
	ttok’
, 
	tsize_t
 
	tcidËn
,

1349 *
	tu£r_d©a
);

1362 (*
ngtı2_»move_cÚÃùiÚ_id
)(
	tngtı2_cÚn
 *
	tcÚn
,

1363 cÚ¡ 
	tngtı2_cid
 *
	tcid
,

1364 *
	tu£r_d©a
);

1380 (*
ngtı2_upd©e_key
)(
	tngtı2_cÚn
 *
	tcÚn
, *
	tu£r_d©a
);

1397 (*
ngtı2_·th_v®id©iÚ
)(
	tngtı2_cÚn
 *
	tcÚn
,

1398 cÚ¡ 
	tngtı2_·th
 *
	t·th
,

1399 
	tngtı2_·th_v®id©iÚ_»suÉ
 
	t»s
,

1400 *
	tu£r_d©a
);

1403 
ngtı2_ş›Á_š™Ÿl
 
ş›Á_š™Ÿl
;

1404 
ngtı2_»cv_ş›Á_š™Ÿl
 
»cv_ş›Á_š™Ÿl
;

1405 
ngtı2_»cv_üy±o_d©a
 
»cv_üy±o_d©a
;

1406 
ngtı2_hªdshake_com¶‘ed
 
hªdshake_com¶‘ed
;

1407 
ngtı2_»cv_v”siÚ_ÃgÙŸtiÚ
 
»cv_v”siÚ_ÃgÙŸtiÚ
;

1412 
ngtı2_’üy±
 
š_’üy±
;

1417 
ngtı2_deüy±
 
š_deüy±
;

1422 
ngtı2_’üy±
 
’üy±
;

1427 
ngtı2_deüy±
 
deüy±
;

1432 
ngtı2_hp_mask
 
š_hp_mask
;

1437 
ngtı2_hp_mask
 
hp_mask
;

1438 
ngtı2_»cv_¡»am_d©a
 
»cv_¡»am_d©a
;

1439 
ngtı2_acked_üy±o_off£t
 
acked_üy±o_off£t
;

1440 
ngtı2_acked_¡»am_d©a_off£t
 
acked_¡»am_d©a_off£t
;

1441 
ngtı2_¡»am_İ’
 
¡»am_İ’
;

1442 
ngtı2_¡»am_şo£
 
¡»am_şo£
;

1443 
ngtı2_»cv_¡©–ess_»£t
 
»cv_¡©–ess_»£t
;

1444 
ngtı2_»cv_»Œy
 
»cv_»Œy
;

1445 
ngtı2_ex‹nd_max_¡»ams
 
ex‹nd_max_¡»ams_bidi
;

1446 
ngtı2_ex‹nd_max_¡»ams
 
ex‹nd_max_¡»ams_uni
;

1447 
ngtı2_¿nd
 
¿nd
;

1448 
ngtı2_g‘_Ãw_cÚÃùiÚ_id
 
g‘_Ãw_cÚÃùiÚ_id
;

1449 
ngtı2_»move_cÚÃùiÚ_id
 
»move_cÚÃùiÚ_id
;

1450 
ngtı2_upd©e_key
 
upd©e_key
;

1451 
ngtı2_·th_v®id©iÚ
 
·th_v®id©iÚ
;

1452 } 
	tngtı2_cÚn_ÿÎbacks
;

1466 
NGTCP2_EXTERN
 
ngtı2_acû±
(
ngtı2_pkt_hd
 *
de¡
, cÚ¡ 
ušt8_t
 *
pkt
,

1467 
size_t
 
pk’
);

1487 
NGTCP2_EXTERN
 

1488 
ngtı2_cÚn_ş›Á_Ãw
(
ngtı2_cÚn
 **
pcÚn
, cÚ¡ 
ngtı2_cid
 *
dcid
,

1489 cÚ¡ 
ngtı2_cid
 *
scid
, cÚ¡ 
ngtı2_·th
 *
·th
,

1490 
ušt32_t
 
v”siÚ
, cÚ¡ 
ngtı2_cÚn_ÿÎbacks
 *
ÿÎbacks
,

1491 cÚ¡ 
ngtı2_£‰šgs
 *
£‰šgs
, *
u£r_d©a
);

1511 
NGTCP2_EXTERN
 

1512 
ngtı2_cÚn_£rv”_Ãw
(
ngtı2_cÚn
 **
pcÚn
, cÚ¡ 
ngtı2_cid
 *
dcid
,

1513 cÚ¡ 
ngtı2_cid
 *
scid
, cÚ¡ 
ngtı2_·th
 *
·th
,

1514 
ušt32_t
 
v”siÚ
, cÚ¡ 
ngtı2_cÚn_ÿÎbacks
 *
ÿÎbacks
,

1515 cÚ¡ 
ngtı2_£‰šgs
 *
£‰šgs
, *
u£r_d©a
);

1523 
NGTCP2_EXTERN
 
ngtı2_cÚn_d–
(
ngtı2_cÚn
 *
cÚn
);

1547 
NGTCP2_EXTERN
 
ngtı2_cÚn_»ad_hªdshake
(
ngtı2_cÚn
 *
cÚn
,

1548 cÚ¡ 
ušt8_t
 *
pkt
, 
size_t
 
pk’
,

1549 
ngtı2_t¡amp
 
ts
);

1585 
NGTCP2_EXTERN
 
ssize_t
 
ngtı2_cÚn_wr™e_hªdshake
(
ngtı2_cÚn
 *
cÚn
,

1586 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

1587 
ngtı2_t¡amp
 
ts
);

1616 
NGTCP2_EXTERN
 
ssize_t
 
ngtı2_cÚn_ş›Á_wr™e_hªdshake
(

1617 
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, 
ssize_t
 *
pd©®’
,

1618 
ušt64_t
 
¡»am_id
, 
ušt8_t
 
fš
, cÚ¡ 
ngtı2_vec
 *
d©av
, 
size_t
 
d©avút
,

1619 
ngtı2_t¡amp
 
ts
);

1640 
NGTCP2_EXTERN
 
ngtı2_cÚn_»ad_pkt
(
ngtı2_cÚn
 *
cÚn
,

1641 cÚ¡ 
ngtı2_·th
 *
·th
,

1642 cÚ¡ 
ušt8_t
 *
pkt
, 
size_t
 
pk’
,

1643 
ngtı2_t¡amp
 
ts
);

1688 
NGTCP2_EXTERN
 
ssize_t
 
ngtı2_cÚn_wr™e_pkt
(
ngtı2_cÚn
 *
cÚn
,

1689 
ngtı2_·th
 *
·th
, 
ušt8_t
 *
de¡
,

1690 
size_t
 
de¡Ën
, 
ngtı2_t¡amp
 
ts
);

1698 
NGTCP2_EXTERN
 
ngtı2_cÚn_hªdshake_com¶‘ed
(
ngtı2_cÚn
 *
cÚn
);

1706 
NGTCP2_EXTERN
 
ngtı2_cÚn_g‘_hªdshake_com¶‘ed
(
ngtı2_cÚn
 *
cÚn
);

1727 
NGTCP2_EXTERN
 
ngtı2_cÚn_š¡®l_š™Ÿl_tx_keys
(

1728 
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, cÚ¡ ušt8_ˆ*
iv
,

1729 
size_t
 
ivËn
, cÚ¡ 
ušt8_t
 *
hp
, size_ˆ
h¶’
);

1750 
NGTCP2_EXTERN
 
ngtı2_cÚn_š¡®l_š™Ÿl_rx_keys
(

1751 
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, cÚ¡ ušt8_ˆ*
iv
,

1752 
size_t
 
ivËn
, cÚ¡ 
ušt8_t
 *
hp
, size_ˆ
h¶’
);

1777 
NGTCP2_EXTERN
 
ngtı2_cÚn_š¡®l_hªdshake_tx_keys
(

1778 
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, cÚ¡ ušt8_ˆ*
iv
,

1779 
size_t
 
ivËn
, cÚ¡ 
ušt8_t
 *
hp
, size_ˆ
h¶’
);

1804 
NGTCP2_EXTERN
 
ngtı2_cÚn_š¡®l_hªdshake_rx_keys
(

1805 
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, cÚ¡ ušt8_ˆ*
iv
,

1806 
size_t
 
ivËn
, cÚ¡ 
ušt8_t
 *
hp
, size_ˆ
h¶’
);

1816 
NGTCP2_EXTERN
 
ngtı2_cÚn_£t_«ad_ov”h—d
(
ngtı2_cÚn
 *
cÚn
,

1817 
size_t
 
«ad_ov”h—d
);

1840 
NGTCP2_EXTERN
 

1841 
ngtı2_cÚn_š¡®l_—¾y_keys
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
key
,

1842 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
iv
, size_ˆ
ivËn
,

1843 cÚ¡ 
ušt8_t
 *
hp
, 
size_t
 
h¶’
);

1868 
NGTCP2_EXTERN
 
ngtı2_cÚn_š¡®l_tx_keys
(
ngtı2_cÚn
 *
cÚn
,

1869 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

1870 cÚ¡ 
ušt8_t
 *
iv
, 
size_t
 
ivËn
,

1871 cÚ¡ 
ušt8_t
 *
hp
, 
size_t
 
h¶’
);

1896 
NGTCP2_EXTERN
 
ngtı2_cÚn_š¡®l_rx_keys
(
ngtı2_cÚn
 *
cÚn
,

1897 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

1898 cÚ¡ 
ušt8_t
 *
iv
, 
size_t
 
ivËn
,

1899 cÚ¡ 
ušt8_t
 *
hp
, 
size_t
 
h¶’
);

1916 
NGTCP2_EXTERN
 
ngtı2_cÚn_upd©e_tx_key
(
ngtı2_cÚn
 *
cÚn
,

1917 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

1918 cÚ¡ 
ušt8_t
 *
iv
, 
size_t
 
ivËn
);

1935 
NGTCP2_EXTERN
 
ngtı2_cÚn_upd©e_rx_key
(
ngtı2_cÚn
 *
cÚn
,

1936 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

1937 cÚ¡ 
ušt8_t
 *
iv
, 
size_t
 
ivËn
);

1959 
NGTCP2_EXTERN
 
ngtı2_cÚn_š™Ÿ‹_key_upd©e
(
ngtı2_cÚn
 *
cÚn
);

1971 
NGTCP2_EXTERN
 
ngtı2_t¡amp


1972 
ngtı2_cÚn_loss_d‘eùiÚ_expœy
(
ngtı2_cÚn
 *
cÚn
);

1983 
NGTCP2_EXTERN
 
ngtı2_t¡amp
 
ngtı2_cÚn_ack_d–ay_expœy
(
ngtı2_cÚn
 *
cÚn
);

2007 
NGTCP2_EXTERN
 

2008 
ngtı2_cÚn_£t_»mÙe_Œª¥Üt_·¿ms
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 
ex‰y³
,

2009 cÚ¡ 
ngtı2_Œª¥Üt_·¿ms
 *
·¿ms
);

2035 
NGTCP2_EXTERN
 
ngtı2_cÚn_£t_—¾y_»mÙe_Œª¥Üt_·¿ms
(

2036 
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_Œª¥Üt_·¿ms
 *
·¿ms
);

2054 
NGTCP2_EXTERN
 
ngtı2_cÚn_g‘_loÿl_Œª¥Üt_·¿ms
(

2055 
ngtı2_cÚn
 *
cÚn
, 
ngtı2_Œª¥Üt_·¿ms
 *
·¿ms
, 
ušt8_t
 
ex‰y³
);

2072 
NGTCP2_EXTERN
 
ngtı2_cÚn_İ’_bidi_¡»am
(
ngtı2_cÚn
 *
cÚn
,

2073 
ušt64_t
 *
p¡»am_id
,

2074 *
¡»am_u£r_d©a
);

2091 
NGTCP2_EXTERN
 
ngtı2_cÚn_İ’_uni_¡»am
(
ngtı2_cÚn
 *
cÚn
,

2092 
ušt64_t
 *
p¡»am_id
,

2093 *
¡»am_u£r_d©a
);

2117 
NGTCP2_EXTERN
 
ngtı2_cÚn_shutdown_¡»am
(
ngtı2_cÚn
 *
cÚn
,

2118 
ušt64_t
 
¡»am_id
,

2119 
ušt16_t
 
­p_”rÜ_code
);

2141 
NGTCP2_EXTERN
 
ngtı2_cÚn_shutdown_¡»am_wr™e
(
ngtı2_cÚn
 *
cÚn
,

2142 
ušt64_t
 
¡»am_id
,

2143 
ušt16_t
 
­p_”rÜ_code
);

2164 
NGTCP2_EXTERN
 
ngtı2_cÚn_shutdown_¡»am_»ad
(
ngtı2_cÚn
 *
cÚn
,

2165 
ušt64_t
 
¡»am_id
,

2166 
ušt16_t
 
­p_”rÜ_code
);

2175 
NGTCP2_EXTERN
 
ssize_t
 
ngtı2_cÚn_wr™e_¡»am
(

2176 
ngtı2_cÚn
 *
cÚn
, 
ngtı2_·th
 *
·th
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

2177 
ssize_t
 *
pd©®’
, 
ušt64_t
 
¡»am_id
, 
ušt8_t
 
fš
, cÚ¡ ušt8_ˆ*
d©a
,

2178 
size_t
 
d©®’
, 
ngtı2_t¡amp
 
ts
);

2234 
NGTCP2_EXTERN
 
ssize_t
 
ngtı2_cÚn_wr™ev_¡»am
(

2235 
ngtı2_cÚn
 *
cÚn
, 
ngtı2_·th
 *
·th
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

2236 
ssize_t
 *
pd©®’
, 
ušt64_t
 
¡»am_id
, 
ušt8_t
 
fš
, cÚ¡ 
ngtı2_vec
 *
d©av
,

2237 
size_t
 
d©avút
, 
ngtı2_t¡amp
 
ts
);

2270 
NGTCP2_EXTERN
 
ssize_t
 
ngtı2_cÚn_wr™e_cÚÃùiÚ_şo£
(

2271 
ngtı2_cÚn
 *
cÚn
, 
ngtı2_·th
 *
·th
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

2272 
ušt16_t
 
”rÜ_code
, 
ngtı2_t¡amp
 
ts
);

2305 
NGTCP2_EXTERN
 
ssize_t
 
ngtı2_cÚn_wr™e_­¶iÿtiÚ_şo£
(

2306 
ngtı2_cÚn
 *
cÚn
, 
ngtı2_·th
 *
·th
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

2307 
ušt16_t
 
­p_”rÜ_code
, 
ngtı2_t¡amp
 
ts
);

2315 
NGTCP2_EXTERN
 
ngtı2_cÚn_is_š_şosšg_³riod
(
ngtı2_cÚn
 *
cÚn
);

2323 
NGTCP2_EXTERN
 
ngtı2_cÚn_is_š_d¿ššg_³riod
(
ngtı2_cÚn
 *
cÚn
);

2337 
NGTCP2_EXTERN
 
ngtı2_cÚn_ex‹nd_max_¡»am_off£t
(
ngtı2_cÚn
 *
cÚn
,

2338 
ušt64_t
 
¡»am_id
,

2339 
size_t
 
d©®’
);

2347 
NGTCP2_EXTERN
 
ngtı2_cÚn_ex‹nd_max_off£t
(
ngtı2_cÚn
 *
cÚn
,

2348 
size_t
 
d©®’
);

2357 
NGTCP2_EXTERN
 
size_t
 
ngtı2_cÚn_g‘_by‹s_š_æight
(
ngtı2_cÚn
 *
cÚn
);

2366 
NGTCP2_EXTERN
 cÚ¡ 
ngtı2_cid
 *
ngtı2_cÚn_g‘_dcid
(
ngtı2_cÚn
 *
cÚn
);

2375 
NGTCP2_EXTERN
 
size_t
 
ngtı2_cÚn_g‘_num_scid
(
ngtı2_cÚn
 *
cÚn
);

2386 
NGTCP2_EXTERN
 
size_t
 
ngtı2_cÚn_g‘_scid
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_cid
 *
de¡
);

2393 
NGTCP2_EXTERN
 
ušt32_t
 
ngtı2_cÚn_g‘_ÃgÙŸ‹d_v”siÚ
(
ngtı2_cÚn
 *
cÚn
);

2401 
NGTCP2_EXTERN
 
ngtı2_cÚn_—¾y_d©a_»jeùed
(
ngtı2_cÚn
 *
cÚn
);

2409 
NGTCP2_EXTERN
 
ngtı2_cÚn_g‘_rcvry_¡©
(
ngtı2_cÚn
 *
cÚn
,

2410 
ngtı2_rcvry_¡©
 *
rcs
);

2418 *
iov_ba£
;

2419 
size_t
 
iov_Ën
;

2420 } 
	tngtı2_iovec
;

2442 
NGTCP2_EXTERN
 
ngtı2_cÚn_Ú_loss_d‘eùiÚ_tim”
(
ngtı2_cÚn
 *
cÚn
,

2443 
ngtı2_t¡amp
 
ts
);

2456 
NGTCP2_EXTERN
 
ngtı2_cÚn_subm™_üy±o_d©a
(
ngtı2_cÚn
 *
cÚn
,

2457 cÚ¡ 
ušt8_t
 *
d©a
,

2458 cÚ¡ 
size_t
 
d©®’
);

2473 
NGTCP2_EXTERN
 
ngtı2_cÚn_£t_»Œy_ocid
(
ngtı2_cÚn
 *
cÚn
,

2474 cÚ¡ 
ngtı2_cid
 *
ocid
);

2482 
NGTCP2_EXTERN
 
ngtı2_cÚn_£t_loÿl_addr
(
ngtı2_cÚn
 *
cÚn
,

2483 cÚ¡ 
ngtı2_addr
 *
addr
);

2491 
NGTCP2_EXTERN
 
ngtı2_cÚn_£t_»mÙe_addr
(
ngtı2_cÚn
 *
cÚn
,

2492 cÚ¡ 
ngtı2_addr
 *
addr
);

2500 
NGTCP2_EXTERN
 cÚ¡ 
ngtı2_addr
 *
ngtı2_cÚn_g‘_»mÙe_addr
(
ngtı2_cÚn
 *
cÚn
);

2519 
NGTCP2_EXTERN
 
ngtı2_cÚn_š™Ÿ‹_mig¿tiÚ
(
ngtı2_cÚn
 *
cÚn
,

2520 cÚ¡ 
ngtı2_·th
 *
·th
,

2521 
ngtı2_t¡amp
 
ts
);

2528 
NGTCP2_EXTERN
 cÚ¡ *
ngtı2_¡»¼Ü
(
lib”r
);

2535 
NGTCP2_EXTERN
 
ngtı2_”r_is_çl
(
lib”r
);

2543 
NGTCP2_EXTERN
 
ušt16_t
 
ngtı2_”r_šãr_quic_Œª¥Üt_”rÜ_code
(
lib”r
);

2551 
NGTCP2_EXTERN
 
ngtı2_addr
 *
ngtı2_addr_š™
Ògtı2_add¸*
addr
,

2552 cÚ¡ *
add»ss
, 
size_t
 
Ën
);

2560 
NGTCP2_EXTERN
 
ngtı2_·th_¡Üage_š™
(
ngtı2_·th_¡Üage
 *
ps
,

2561 cÚ¡ *
loÿl_addr
,

2562 
size_t
 
loÿl_add¾’
,

2563 cÚ¡ *
»mÙe_addr
,

2564 
size_t
 
»mÙe_add¾’
);

2572 
NGTCP2_EXTERN
 
ngtı2_·th_¡Üage_z”o
(
ngtı2_·th_¡Üage
 *
ps
);

2574 #ifdeà
__ılu¥lus


	@lib/includes/ngtcp2/version.h

25 #iâdeà
VERSION_H


26 
	#VERSION_H


	)

33 
	#NGTCP2_VERSION
 "0.1.0-DEV"

	)

43 
	#NGTCP2_VERSION_NUM
 0x000100

	)

	@lib/ngtcp2_acktr.c

25 
	~"ngtı2_ackŒ.h
"

27 
	~<as£¹.h
>

29 
	~"ngtı2_maüo.h
"

31 
	$ngtı2_ackŒ_’Œy_Ãw
(
ngtı2_ackŒ_’Œy
 **
’t
, 
ušt64_t
 
pkt_num
,

32 
ngtı2_t¡amp
 
t¡amp
, 
ngtı2_mem
 *
mem
) {

33 *
’t
 = 
	`ngtı2_mem_m®loc
(
mem
, (
ngtı2_ackŒ_’Œy
));

34 ià(*
’t
 =ğ
NULL
) {

35  
NGTCP2_ERR_NOMEM
;

38 (*
’t
)->
pkt_num
 =…kt_num;

39 (*
’t
)->
Ën
 = 1;

40 (*
’t
)->
t¡amp
 =stamp;

43 
	}
}

45 
	$ngtı2_ackŒ_’Œy_d–
(
ngtı2_ackŒ_’Œy
 *
’t
, 
ngtı2_mem
 *
mem
) {

46 
	`ngtı2_mem_ä“
(
mem
, 
’t
);

47 
	}
}

49 
	$g»©”
(cÚ¡ 
ngtı2_k¦_key
 *
lhs
, cÚ¡‚gtı2_k¦_key *
rhs
) {

50  
lhs
->
i
 > 
rhs
->i;

51 
	}
}

53 
	$ngtı2_ackŒ_š™
(
ngtı2_ackŒ
 *
ackŒ
, 
ngtı2_log
 *
log
, 
ngtı2_mem
 *
mem
) {

54 
rv
;

55 
ngtı2_k¦_key
 
šf_key
 = {-1};

57 
rv
 = 
	`ngtı2_ršgbuf_š™
(&
ackŒ
->
acks
, 128, (
ngtı2_ackŒ_ack_’Œy
),

58 
mem
);

59 ià(
rv
 != 0) {

60  
rv
;

63 
rv
 = 
	`ngtı2_k¦_š™
(&
ackŒ
->
’ts
, 
g»©”
, &
šf_key
, 
mem
);

64 ià(
rv
 != 0) {

65 
	`ngtı2_ršgbuf_ä“
(&
ackŒ
->
acks
);

66  
rv
;

69 
ackŒ
->
log
 =†og;

70 
ackŒ
->
mem
 = mem;

71 
ackŒ
->
æags
 = 
NGTCP2_ACKTR_FLAG_NONE
;

72 
ackŒ
->
fœ¡_uÇcked_ts
 = 
UINT64_MAX
;

73 
ackŒ
->
rx_Åkt
 = 0;

76 
	}
}

78 
	$ngtı2_ackŒ_ä“
(
ngtı2_ackŒ
 *
ackŒ
) {

79 
ngtı2_k¦_™
 
™
;

81 ià(
ackŒ
 =ğ
NULL
) {

85 
™
 = 
	`ngtı2_k¦_begš
(&
ackŒ
->
’ts
); !
	`ngtı2_k¦_™_’d
(&it);

86 
	`ngtı2_k¦_™_Ãxt
(&
™
)) {

87 
	`ngtı2_ackŒ_’Œy_d–
(
	`ngtı2_k¦_™_g‘
(&
™
), 
ackŒ
->
mem
);

89 
	`ngtı2_k¦_ä“
(&
ackŒ
->
’ts
);

91 
	`ngtı2_ršgbuf_ä“
(&
ackŒ
->
acks
);

92 
	}
}

94 
	$ngtı2_ackŒ_add
(
ngtı2_ackŒ
 *
ackŒ
, 
ušt64_t
 
pkt_num
, 
aùive_ack
,

95 
ngtı2_t¡amp
 
ts
) {

96 
ngtı2_k¦_™
 
™
;

97 
ngtı2_ackŒ_’Œy
 *
’t
, *
´ev_’t
, *
d–’t
;

98 
rv
;

99 
added
 = 0;

101 ià(
	`ngtı2_k¦_Ën
(&
ackŒ
->
’ts
)) {

102 
™
 = 
	`ngtı2_k¦_low”_bound
(&
ackŒ
->
’ts
, (cÚ¡ 
ngtı2_k¦_key
 *)&
pkt_num
);

103 ià(
	`ngtı2_k¦_™_’d
(&
™
)) {

104 
	`ngtı2_k¦_™_´ev
(&
™
);

105 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

107 
	`as£¹
(
’t
->
pkt_num
 >ğpkt_num +ƒÁ->
Ën
);

109 ià(
’t
->
pkt_num
 =ğpkt_num +ƒÁ->
Ën
) {

110 ++
’t
->
Ën
;

111 
added
 = 1;

114 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

116 
	`as£¹
(
’t
->
pkt_num
 !=…kt_num);

118 ià(
	`ngtı2_k¦_™_begš
(&
™
)) {

119 ià(
’t
->
pkt_num
 + 1 ==…kt_num) {

120 
	`ngtı2_k¦_upd©e_key
(&
ackŒ
->
’ts
,

121 (cÚ¡ 
ngtı2_k¦_key
 *)&
’t
->
pkt_num
,

122 (cÚ¡ 
ngtı2_k¦_key
 *)&
pkt_num
);

123 
’t
->
pkt_num
 =…kt_num;

124 
’t
->
t¡amp
 = 
ts
;

125 ++
’t
->
Ën
;

126 
added
 = 1;

129 
	`ngtı2_k¦_™_´ev
(&
™
);

130 
´ev_’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

132 
	`as£¹
(
´ev_’t
->
pkt_num
 >ğpkt_num +…»v_’t->
Ën
);

134 ià(
’t
->
pkt_num
 + 1 ==…kt_num) {

135 ià(
´ev_’t
->
pkt_num
 =ğpkt_num +…»v_’t->
Ën
) {

136 
´ev_’t
->
Ën
 +ğ
’t
->len + 1;

137 
rv
 = 
	`ngtı2_k¦_»move
(&
ackŒ
->
’ts
, 
NULL
,

138 (cÚ¡ 
ngtı2_k¦_key
 *)&
’t
->
pkt_num
);

139 ià(
rv
 != 0) {

140  
rv
;

142 
	`ngtı2_ackŒ_’Œy_d–
(
’t
, 
ackŒ
->
mem
);

143 
added
 = 1;

145 
	`ngtı2_k¦_upd©e_key
(&
ackŒ
->
’ts
,

146 (cÚ¡ 
ngtı2_k¦_key
 *)&
’t
->
pkt_num
,

147 (cÚ¡ 
ngtı2_k¦_key
 *)&
pkt_num
);

148 
’t
->
pkt_num
 =…kt_num;

149 
’t
->
t¡amp
 = 
ts
;

150 ++
’t
->
Ën
;

151 
added
 = 1;

153 } ià(
´ev_’t
->
pkt_num
 =ğpkt_num +…»v_’t->
Ën
) {

154 ++
´ev_’t
->
Ën
;

155 
added
 = 1;

161 ià(!
added
) {

162 
rv
 = 
	`ngtı2_ackŒ_’Œy_Ãw
(&
’t
, 
pkt_num
, 
ts
, 
ackŒ
->
mem
);

163 ià(
rv
 != 0) {

164  
rv
;

166 
rv
 = 
	`ngtı2_k¦_š£¹
(&
ackŒ
->
’ts
, 
NULL
,

167 (cÚ¡ 
ngtı2_k¦_key
 *)&
’t
->
pkt_num
,ƒnt);

168 ià(
rv
 != 0) {

169 
	`ngtı2_ackŒ_’Œy_d–
(
’t
, 
ackŒ
->
mem
);

170  
rv
;

174 ià(
aùive_ack
) {

175 
ackŒ
->
æags
 |ğ
NGTCP2_ACKTR_FLAG_ACTIVE_ACK
;

176 ià(
ackŒ
->
fœ¡_uÇcked_ts
 =ğ
UINT64_MAX
) {

177 
ackŒ
->
fœ¡_uÇcked_ts
 = 
ts
;

181 ià(
	`ngtı2_k¦_Ën
(&
ackŒ
->
’ts
è> 
NGTCP2_ACKTR_MAX_ENT
) {

182 
™
 = 
	`ngtı2_k¦_’d
(&
ackŒ
->
’ts
);

183 
	`ngtı2_k¦_™_´ev
(&
™
);

184 
d–’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

185 
rv
 = 
	`ngtı2_k¦_»move
(&
ackŒ
->
’ts
, 
NULL
,

186 (cÚ¡ 
ngtı2_k¦_key
 *)&
d–’t
->
pkt_num
);

187 ià(
rv
 != 0) {

188  
rv
;

190 
	`ngtı2_ackŒ_’Œy_d–
(
d–’t
, 
ackŒ
->
mem
);

194 
	}
}

196 
	$ngtı2_ackŒ_fÜg‘
(
ngtı2_ackŒ
 *
ackŒ
, 
ngtı2_ackŒ_’Œy
 *
’t
) {

197 
ngtı2_k¦_™
 
™
;

198 
rv
;

200 
™
 = 
	`ngtı2_k¦_low”_bound
(&
ackŒ
->
’ts
,

201 (cÚ¡ 
ngtı2_k¦_key
 *)&
’t
->
pkt_num
);

202 
	`as£¹
(
	`ngtı2_k¦_™_key
(&
™
).
i
 =ğ(
št64_t
)
’t
->
pkt_num
);

204 ; !
	`ngtı2_k¦_™_’d
(&
™
);) {

205 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

206 
rv
 = 
	`ngtı2_k¦_»move
(&
ackŒ
->
’ts
, &
™
,

207 (cÚ¡ 
ngtı2_k¦_key
 *)&
’t
->
pkt_num
);

208 ià(
rv
 != 0) {

209  
rv
;

211 
	`ngtı2_ackŒ_’Œy_d–
(
’t
, 
ackŒ
->
mem
);

215 
	}
}

217 
ngtı2_k¦_™
 
	$ngtı2_ackŒ_g‘
(
ngtı2_ackŒ
 *
ackŒ
) {

218  
	`ngtı2_k¦_begš
(&
ackŒ
->
’ts
);

219 
	}
}

221 
ngtı2_ackŒ_ack_’Œy
 *
	$ngtı2_ackŒ_add_ack
(
ngtı2_ackŒ
 *
ackŒ
,

222 
ušt64_t
 
pkt_num
,

223 
ušt64_t
 
Ïrge¡_ack
) {

224 
ngtı2_ackŒ_ack_’Œy
 *
’t
 = 
	`ngtı2_ršgbuf_push_äÚt
(&
ackŒ
->
acks
);

226 
’t
->
Ïrge¡_ack
 =†argest_ack;

227 
’t
->
pkt_num
 =…kt_num;

229  
’t
;

230 
	}
}

242 
	$ackŒ_»move
(
ngtı2_ackŒ
 *
ackŒ
, 
ngtı2_k¦_™
 *
™
,

243 
ngtı2_ackŒ_’Œy
 *
’t
) {

244 
rv
;

246 
rv
 = 
	`ngtı2_k¦_»move
(&
ackŒ
->
’ts
, 
™
,

247 (cÚ¡ 
ngtı2_k¦_key
 *)&
’t
->
pkt_num
);

248 ià(
rv
 != 0) {

249  
rv
;

252 
	`ngtı2_ackŒ_’Œy_d–
(
’t
, 
ackŒ
->
mem
);

255 
	}
}

257 
	$ackŒ_Ú_ack
(
ngtı2_ackŒ
 *
ackŒ
, 
ngtı2_ršgbuf
 *
rb
,

258 
size_t
 
ack_’t_off£t
) {

259 
ngtı2_ackŒ_ack_’Œy
 *
ack_’t
;

260 
ngtı2_ackŒ_’Œy
 *
’t
;

261 
ngtı2_k¦_™
 
™
;

262 
rv
;

264 
	`as£¹
(
	`ngtı2_ršgbuf_Ën
(
rb
));

266 
ack_’t
 = 
	`ngtı2_ršgbuf_g‘
(
rb
, 
ack_’t_off£t
);

269 
™
 = 
	`ngtı2_k¦_low”_bound
(&
ackŒ
->
’ts
,

270 (cÚ¡ 
ngtı2_k¦_key
 *)&
ack_’t
->
Ïrge¡_ack
);

271 ; !
	`ngtı2_k¦_™_’d
(&
™
);) {

272 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

273 
rv
 = 
	`ackŒ_»move
(
ackŒ
, &
™
, 
’t
);

274 ià(
rv
 != 0) {

275  
rv
;

279 ià(
	`ngtı2_k¦_Ën
(&
ackŒ
->
’ts
)) {

280 
	`as£¹
(
	`ngtı2_k¦_™_’d
(&
™
));

282 
	`ngtı2_k¦_™_´ev
(&
™
);

283 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

284 ià(
’t
->
pkt_num
 > 
ack_’t
->
Ïrge¡_ack
 &&

285 
ack_’t
->
Ïrge¡_ack
 >ğ
’t
->
pkt_num
 - (’t->
Ën
 - 1)) {

286 
’t
->
Ën
 =ƒÁ->
pkt_num
 - 
ack_’t
->
Ïrge¡_ack
;

290 
	`ngtı2_ršgbuf_»size
(
rb
, 
ack_’t_off£t
);

293 
	}
}

295 
	$ngtı2_ackŒ_»cv_ack
(
ngtı2_ackŒ
 *
ackŒ
, cÚ¡ 
ngtı2_ack
 *
ä
) {

296 
ngtı2_ackŒ_ack_’Œy
 *
’t
;

297 
ušt64_t
 
Ïrge¡_ack
 = 
ä
->Ïrge¡_ack, 
mš_ack
;

298 
size_t
 
i
, 
j
;

299 
ngtı2_ršgbuf
 *
rb
 = &
ackŒ
->
acks
;

300 
size_t
 
Çcks
 = 
	`ngtı2_ršgbuf_Ën
(
rb
);

301 
rv
;

304 
j
 = 0; j < 
Çcks
; ++j) {

305 
’t
 = 
	`ngtı2_ršgbuf_g‘
(
rb
, 
j
);

306 ià(
Ïrge¡_ack
 >ğ
’t
->
pkt_num
) {

310 ià(
j
 =ğ
Çcks
) {

314 
mš_ack
 = 
Ïrge¡_ack
 - 
ä
->
fœ¡_ack_blkËn
;

316 ià(
mš_ack
 <ğ
’t
->
pkt_num
 &&ƒÁ->pkt_num <ğ
Ïrge¡_ack
) {

317 
rv
 = 
	`ackŒ_Ú_ack
(
ackŒ
, 
rb
, 
j
);

318 ià(
rv
 != 0) {

319  
rv
;

324 
i
 = 0; i < 
ä
->
num_blks
 && 
j
 < 
Çcks
; ++i) {

325 
Ïrge¡_ack
 = 
mš_ack
 - 
ä
->
blks
[
i
].
g­
 - 2;

326 
mš_ack
 = 
Ïrge¡_ack
 - 
ä
->
blks
[
i
].
blkËn
;

329 ià(
’t
->
pkt_num
 > 
Ïrge¡_ack
) {

330 ++
j
;

331 ià(
j
 =ğ
Çcks
) {

334 
’t
 = 
	`ngtı2_ršgbuf_g‘
(
rb
, 
j
);

337 ià(
’t
->
pkt_num
 < 
mš_ack
) {

340  
	`ackŒ_Ú_ack
(
ackŒ
, 
rb
, 
j
);

345 
	}
}

347 
	$ngtı2_ackŒ_comm™_ack
(
ngtı2_ackŒ
 *
ackŒ
) {

348 
ackŒ
->
æags
 &ğ(
ušt16_t
è~(
NGTCP2_ACKTR_FLAG_ACTIVE_ACK
 |

349 
NGTCP2_ACKTR_FLAG_IMMEDIATE_ACK
);

350 
ackŒ
->
fœ¡_uÇcked_ts
 = 
UINT64_MAX
;

351 
ackŒ
->
rx_Åkt
 = 0;

352 
	}
}

354 
	$ngtı2_ackŒ_»quœe_aùive_ack
(
ngtı2_ackŒ
 *
ackŒ
, 
ušt64_t
 
max_ack_d–ay
,

355 
ngtı2_t¡amp
 
ts
) {

356  (
ackŒ
->
æags
 & 
NGTCP2_ACKTR_FLAG_ACTIVE_ACK
) &&

357 
ackŒ
->
fœ¡_uÇcked_ts
 <ğ
ts
 - 
max_ack_d–ay
;

358 
	}
}

360 
	$ngtı2_ackŒ_immedŸ‹_ack
(
ngtı2_ackŒ
 *
ackŒ
) {

361 
ackŒ
->
æags
 |ğ
NGTCP2_ACKTR_FLAG_IMMEDIATE_ACK
;

362 
	}
}

	@lib/ngtcp2_acktr.h

25 #iâdeà
NGTCP2_ACKTR_H


26 
	#NGTCP2_ACKTR_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

34 
	~"ngtı2_mem.h
"

35 
	~"ngtı2_ršgbuf.h
"

36 
	~"ngtı2_k¦.h
"

40 
	#NGTCP2_ACKTR_MAX_ENT
 1024

	)

44 
	#NGTCP2_NUM_IMMEDIATE_ACK_PKT
 2

	)

46 
	gngtı2_ackŒ_’Œy
;

47 
ngtı2_ackŒ_’Œy
 
	tngtı2_ackŒ_’Œy
;

49 
	gngtı2_log
;

50 
ngtı2_log
 
	tngtı2_log
;

55 
	sngtı2_ackŒ_’Œy
 {

58 
ušt64_t
 
	mpkt_num
;

62 
size_t
 
	mËn
;

65 
ngtı2_t¡amp
 
	mt¡amp
;

79 
ngtı2_ackŒ_’Œy_Ãw
(
ngtı2_ackŒ_’Œy
 **
’t
, 
ušt64_t
 
pkt_num
,

80 
ngtı2_t¡amp
 
t¡amp
, 
ngtı2_mem
 *
mem
);

86 
ngtı2_ackŒ_’Œy_d–
(
ngtı2_ackŒ_’Œy
 *
’t
, 
ngtı2_mem
 *
mem
);

90 
ušt64_t
 
	mÏrge¡_ack
;

92 
ušt64_t
 
	mpkt_num
;

93 } 
	tngtı2_ackŒ_ack_’Œy
;

96 
	mNGTCP2_ACKTR_FLAG_NONE
 = 0x00,

99 
	mNGTCP2_ACKTR_FLAG_IMMEDIATE_ACK
 = 0x01,

102 
	mNGTCP2_ACKTR_FLAG_ACTIVE_ACK
 = 0x02,

106 
	mNGTCP2_ACKTR_FLAG_PENDING_FINISHED_ACK
 = 0x40,

110 
	mNGTCP2_ACKTR_FLAG_ACK_FINISHED_ACK
 = 0x80,

111 } 
	tngtı2_ackŒ_æag
;

117 
ngtı2_ršgbuf
 
	macks
;

120 
ngtı2_k¦
 
	m’ts
;

121 
ngtı2_log
 *
	mlog
;

122 
ngtı2_mem
 *
	mmem
;

124 
ušt16_t
 
	mæags
;

127 
ngtı2_t¡amp
 
	mfœ¡_uÇcked_ts
;

129 
size_t
 
	mrx_Åkt
;

130 } 
	tngtı2_ackŒ
;

141 
ngtı2_ackŒ_š™
(
ngtı2_ackŒ
 *
ackŒ
, 
ngtı2_log
 *
log
, 
ngtı2_mem
 *
mem
);

147 
ngtı2_ackŒ_ä“
(
ngtı2_ackŒ
 *
ackŒ
);

161 
ngtı2_ackŒ_add
(
ngtı2_ackŒ
 *
ackŒ
, 
ušt64_t
 
pkt_num
, 
aùive_ack
,

162 
ngtı2_t¡amp
 
ts
);

175 
ngtı2_ackŒ_fÜg‘
(
ngtı2_ackŒ
 *
ackŒ
, 
ngtı2_ackŒ_’Œy
 *
’t
);

182 
ngtı2_k¦_™
 
ngtı2_ackŒ_g‘
(
ngtı2_ackŒ
 *
ackŒ
);

190 
ngtı2_ackŒ_ack_’Œy
 *
ngtı2_ackŒ_add_ack
(
ngtı2_ackŒ
 *
ackŒ
,

191 
ušt64_t
 
pkt_num
,

192 
ušt64_t
 
Ïrge¡_ack
);

208 
ngtı2_ackŒ_»cv_ack
(
ngtı2_ackŒ
 *
ackŒ
, cÚ¡ 
ngtı2_ack
 *
ä
);

213 
ngtı2_ackŒ_comm™_ack
(
ngtı2_ackŒ
 *
ackŒ
);

219 
ngtı2_ackŒ_»quœe_aùive_ack
(
ngtı2_ackŒ
 *
ackŒ
, 
ušt64_t
 
max_ack_d–ay
,

220 
ngtı2_t¡amp
 
ts
);

226 
ngtı2_ackŒ_immedŸ‹_ack
(
ngtı2_ackŒ
 *
ackŒ
);

	@lib/ngtcp2_addr.c

25 
	~"ngtı2_addr.h
"

27 
	~<¡ršg.h
>

29 
ngtı2_addr
 *
	$ngtı2_addr_š™
(
ngtı2_addr
 *
de¡
, cÚ¡ *
addr
, 
size_t
 
Ën
) {

30 
de¡
->
Ën
 =†en;

31 
de¡
->
addr
 = (
ušt8_t
 *)addr;

32  
de¡
;

33 
	}
}

35 
	$ngtı2_addr_cİy
(
ngtı2_addr
 *
de¡
, cÚ¡‚gtı2_add¸*
¤c
) {

36 
de¡
->
Ën
 = 
¤c
->len;

37 ià(
¤c
->
Ën
) {

38 
	`memıy
(
de¡
->
addr
, 
¤c
->addr, src->
Ën
);

40 
	}
}

42 
	$ngtı2_addr_cİy_by‹
(
ngtı2_addr
 *
de¡
, cÚ¡ *
addr
,

43 
size_t
 
add¾’
) {

44 
de¡
->
Ën
 = 
add¾’
;

45 ià(
add¾’
) {

46 
	`memıy
(
de¡
->
addr
,‡ddr, 
add¾’
);

48 
	}
}

50 
	$ngtı2_addr_eq
(cÚ¡ 
ngtı2_addr
 *
a
, cÚ¡‚gtı2_add¸*
b
) {

51  
a
->
Ën
 =ğ
b
->ËÀ&& 
	`memcmp
×->
addr
, b->addr,‡->len) == 0;

52 
	}
}

54 
	$ngtı2_addr_em±y
(cÚ¡ 
ngtı2_addr
 *
addr
è{ ‡ddr->
Ën
 =ğ0; 
	}
}

	@lib/ngtcp2_addr.h

25 #iâdeà
NGTCP2_ADDR_H


26 
	#NGTCP2_ADDR_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

39 
ngtı2_addr_cİy
(
ngtı2_addr
 *
de¡
, cÚ¡‚gtı2_add¸*
¤c
);

47 
ngtı2_addr_cİy_by‹
(
ngtı2_addr
 *
de¡
, cÚ¡ *
addr
, 
size_t
 
add¾’
);

52 
ngtı2_addr_eq
(cÚ¡ 
ngtı2_addr
 *
a
, cÚ¡‚gtı2_add¸*
b
);

58 
ngtı2_addr_em±y
(cÚ¡ 
ngtı2_addr
 *
addr
);

	@lib/ngtcp2_buf.c

25 
	~"ngtı2_buf.h
"

27 
	$ngtı2_buf_š™
(
ngtı2_buf
 *
buf
, 
ušt8_t
 *
begš
, 
size_t
 
Ën
) {

28 
buf
->
begš
 = buf->
pos
 = buf->
Ï¡
 = begin;

29 
buf
->
’d
 = 
begš
 + 
Ën
;

30 
	}
}

32 
size_t
 
	$ngtı2_buf_Ëá
(
ngtı2_buf
 *
buf
) {

33  (
size_t
)(
buf
->
’d
 - buf->
Ï¡
);

34 
	}
}

36 
size_t
 
	$ngtı2_buf_Ën
(
ngtı2_buf
 *
buf
) {

37  (
size_t
)(
buf
->
Ï¡
 - buf->
pos
);

38 
	}
}

40 
size_t
 
	$ngtı2_buf_ÿp
(
ngtı2_buf
 *
buf
) {

41  (
size_t
)(
buf
->
’d
 - buf->
begš
);

42 
	}
}

	@lib/ngtcp2_buf.h

25 #iâdeà
NGTCP2_BUF_H


26 
	#NGTCP2_BUF_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

36 
ušt8_t
 *
	mbegš
;

38 
ušt8_t
 *
	m’d
;

42 
ušt8_t
 *
	mpos
;

46 
ušt8_t
 *
	mÏ¡
;

47 } 
	tngtı2_buf
;

52 
ngtı2_buf_š™
(
ngtı2_buf
 *
buf
, 
ušt8_t
 *
begš
, 
size_t
 
Ën
);

59 
size_t
 
ngtı2_buf_Ëá
(
ngtı2_buf
 *
buf
);

65 
size_t
 
ngtı2_buf_Ën
(
ngtı2_buf
 *
buf
);

71 
size_t
 
ngtı2_buf_ÿp
(
ngtı2_buf
 *
buf
);

	@lib/ngtcp2_cc.c

25 
	~"ngtı2_cc.h
"

27 
	~<as£¹.h
>

29 
	~"ngtı2_log.h
"

30 
	~"ngtı2_maüo.h
"

32 
ngtı2_cc_pkt
 *
	$ngtı2_cc_pkt_š™
(
ngtı2_cc_pkt
 *
pkt
, 
ušt64_t
 
pkt_num
,

33 
size_t
 
pk’
, 
ngtı2_t¡amp
 
ts_£Á
) {

34 
pkt
->
pkt_num
 =…kt_num;

35 
pkt
->
pk’
 =…ktlen;

36 
pkt
->
ts_£Á
 =s_sent;

38  
pkt
;

39 
	}
}

41 
	$ngtı2_deçuÉ_cc_š™
(
ngtı2_deçuÉ_cc
 *
cc
, 
ngtı2_cc_¡©
 *
ccs
,

42 
ngtı2_log
 *
log
) {

43 
cc
->
log
 =†og;

44 
cc
->
ccs
 = ccs;

45 
	}
}

47 
	$ngtı2_deçuÉ_cc_ä“
(
ngtı2_deçuÉ_cc
 *
cc
è{ ()cc; 
	}
}

49 
	$deçuÉ_cc_š_rcvry
(
ngtı2_deçuÉ_cc
 *
cc
, 
ngtı2_t¡amp
 
£Á_time
) {

50  
£Á_time
 <ğ
cc
->
ccs
->
»cov”y_¡¬t_time
;

51 
	}
}

53 
	$ngtı2_deçuÉ_cc_Ú_pkt_acked
(
ngtı2_deçuÉ_cc
 *
cc
,

54 cÚ¡ 
ngtı2_cc_pkt
 *
pkt
) {

55 
ngtı2_cc_¡©
 *
ccs
 = 
cc
->ccs;

57 ià(
	`deçuÉ_cc_š_rcvry
(
cc
, 
pkt
->
ts_£Á
)) {

61 ià(
ccs
->
cwnd
 < ccs->
s¡h»sh
) {

62 
ccs
->
cwnd
 +ğ
pkt
->
pk’
;

63 
	`ngtı2_log_šfo
(
cc
->
log
, 
NGTCP2_LOG_EVENT_RCV
,

64 "·ck‘ %" 
PRIu64
 "‡cked, slow start cwnd=%lu",

65 
pkt
->
pkt_num
, 
ccs
->
cwnd
);

69 
ccs
->
cwnd
 +ğ
NGTCP2_MAX_DGRAM_SIZE
 * 
pkt
->
pk’
 / ccs->cwnd;

70 
	}
}

72 
	$ngtı2_deçuÉ_cc_cÚge¡iÚ_ev’t
(
ngtı2_deçuÉ_cc
 *
cc
,

73 
ngtı2_t¡amp
 
ts_£Á
,

74 
ngtı2_rcvry_¡©
 *
rcs
,

75 
ngtı2_t¡amp
 
ts
) {

76 
ngtı2_cc_¡©
 *
ccs
 = 
cc
->ccs;

78 ià(!
	`deçuÉ_cc_š_rcvry
(
cc
, 
ts_£Á
)) {

81 
ccs
->
»cov”y_¡¬t_time
 = 
ts
;

82 
ccs
->
cwnd
 = (
ušt64_t
)(()ccs->cwnd * 
NGTCP2_LOSS_REDUCTION_FACTOR
);

83 
ccs
->
cwnd
 = 
	`ngtı2_max
(ccs->cwnd, 
NGTCP2_MIN_CWND
);

84 
ccs
->
s¡h»sh
 = ccs->
cwnd
;

86 ià(
rcs
->
±o_couÁ
 > 
NGTCP2_PERSISTENT_CONGESTION_THRESHOLD
) {

87 
ccs
->
cwnd
 = 
NGTCP2_MIN_CWND
;

90 
	`ngtı2_log_šfo
(
cc
->
log
, 
NGTCP2_LOG_EVENT_RCV
,

91 "»duû cwnd beÿu£ oà·ck‘†os cwnd=%lu", 
ccs
->
cwnd
);

92 
	}
}

	@lib/ngtcp2_cc.h

25 #iâdeà
NGTCP2_CC_H


26 
	#NGTCP2_CC_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

34 
	#NGTCP2_MAX_DGRAM_SIZE
 1200

	)

35 
	#NGTCP2_MIN_CWND
 (2 * 
NGTCP2_MAX_DGRAM_SIZE
)

	)

36 
	#NGTCP2_LOSS_REDUCTION_FACTOR
 0.5

	)

37 
	#NGTCP2_PERSISTENT_CONGESTION_THRESHOLD
 2

	)

39 
	gngtı2_log
;

40 
ngtı2_log
 
	tngtı2_log
;

43 
ušt64_t
 
	mcwnd
;

44 
ušt64_t
 
	ms¡h»sh
;

45 
ušt64_t
 
	m»cov”y_¡¬t_time
;

46 
ušt64_t
 
	mby‹s_š_æight
;

47 } 
	tngtı2_cc_¡©
;

53 
ušt64_t
 
	mpkt_num
;

55 
size_t
 
	mpk’
;

57 
ngtı2_t¡amp
 
	mts_£Á
;

58 } 
	tngtı2_cc_pkt
;

60 
ngtı2_cc_pkt
 *
ngtı2_cc_pkt_š™
Ògtı2_cc_pkˆ*
pkt
, 
ušt64_t
 
pkt_num
,

61 
size_t
 
pk’
, 
ngtı2_t¡amp
 
ts_£Á
);

64 
	sngtı2_deçuÉ_cc
 {

65 
ngtı2_log
 *
	mlog
;

66 
ngtı2_cc_¡©
 *
	mccs
;

69 
ngtı2_deçuÉ_cc
 
	tngtı2_deçuÉ_cc
;

71 
ngtı2_deçuÉ_cc_š™
(
ngtı2_deçuÉ_cc
 *
cc
, 
ngtı2_cc_¡©
 *
ccs
,

72 
ngtı2_log
 *
log
);

74 
ngtı2_deçuÉ_cc_ä“
(
ngtı2_deçuÉ_cc
 *
cc
);

76 
ngtı2_deçuÉ_cc_Ú_pkt_acked
(
ngtı2_deçuÉ_cc
 *
cc
,

77 cÚ¡ 
ngtı2_cc_pkt
 *
pkt
);

79 
ngtı2_deçuÉ_cc_cÚge¡iÚ_ev’t
(
ngtı2_deçuÉ_cc
 *
cc
,

80 
ngtı2_t¡amp
 
ts_£Á
,

81 
ngtı2_rcvry_¡©
 *
rcs
,

82 
ngtı2_t¡amp
 
ts
);

	@lib/ngtcp2_cid.c

25 
	~"ngtı2_cid.h
"

27 
	~<as£¹.h
>

28 
	~<¡ršg.h
>

30 
	~"ngtı2_·th.h
"

31 
	~"ngtı2_¡r.h
"

33 
	$ngtı2_cid_z”o
(
ngtı2_cid
 *
cid
è{ cid->
d©®’
 = 0; 
	}
}

35 
	$ngtı2_cid_š™
(
ngtı2_cid
 *
cid
, cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
) {

36 
	`as£¹
(
d©®’
 <ğ
NGTCP2_MAX_CIDLEN
);

38 
cid
->
d©®’
 = datalen;

39 ià(
d©®’
) {

40 
	`ngtı2_ıymem
(
cid
->
d©a
, d©a, 
d©®’
);

42 
	}
}

44 
	$ngtı2_cid_eq
(cÚ¡ 
ngtı2_cid
 *
cid
, cÚ¡‚gtı2_cid *
Ùh”
) {

45  
cid
->
d©®’
 =ğ
Ùh”
->datalen &&

46 0 =ğ
	`memcmp
(
cid
->
d©a
, 
Ùh”
->d©a, cid->
d©®’
);

47 
	}
}

49 
	$ngtı2_cid_Ëss
(cÚ¡ 
ngtı2_cid
 *
lhs
, cÚ¡‚gtı2_cid *
rhs
) {

50 
s
 = 
lhs
->
d©®’
 < 
rhs
->datalen;

51 
size_t
 
n
 = 
s
 ? 
lhs
->
d©®’
 : 
rhs
->datalen;

52 
c
 = 
	`memcmp
(
lhs
->
d©a
, 
rhs
->d©a, 
n
);

54  
c
 < 0 || (ø=ğ0 && 
s
);

55 
	}
}

57 
	$ngtı2_cid_em±y
(cÚ¡ 
ngtı2_cid
 *
cid
è{  cid->
d©®’
 =ğ0; 
	}
}

59 
	$ngtı2_scid_š™
(
ngtı2_scid
 *
scid
, 
ušt64_t
 
£q
, cÚ¡ 
ngtı2_cid
 *
cid
,

60 cÚ¡ 
ušt8_t
 *
tok’
) {

61 
scid
->
³
.
šdex
 = 
NGTCP2_PQ_BAD_INDEX
;

62 
scid
->
£q
 = seq;

63 
scid
->
cid
 = *cid;

64 
scid
->
ts_»tœed
 = 
UINT64_MAX
;

65 
scid
->
æags
 = 
NGTCP2_SCID_FLAG_NONE
;

66 ià(
tok’
) {

67 
	`memıy
(
scid
->
tok’
,ok’, 
NGTCP2_STATELESS_RESET_TOKENLEN
);

69 
	`mem£t
(
scid
->
tok’
, 0, 
NGTCP2_STATELESS_RESET_TOKENLEN
);

71 
	}
}

73 
	$ngtı2_scid_cİy
(
ngtı2_scid
 *
de¡
, cÚ¡‚gtı2_scid *
¤c
) {

74 
	`ngtı2_scid_š™
(
de¡
, 
¤c
->
£q
, &¤c->
cid
, src->
tok’
);

75 
de¡
->
ts_»tœed
 = 
¤c
->ts_retired;

76 
de¡
->
æags
 = 
¤c
->flags;

77 
	}
}

79 
	$ngtı2_dcid_š™
(
ngtı2_dcid
 *
dcid
, 
ušt64_t
 
£q
, cÚ¡ 
ngtı2_cid
 *
cid
,

80 cÚ¡ 
ušt8_t
 *
tok’
) {

81 
dcid
->
£q
 = seq;

82 
dcid
->
cid
 = *cid;

83 ià(
tok’
) {

84 
	`memıy
(
dcid
->
tok’
,ok’, 
NGTCP2_STATELESS_RESET_TOKENLEN
);

86 
	`mem£t
(
dcid
->
tok’
, 0, 
NGTCP2_STATELESS_RESET_TOKENLEN
);

88 
	`ngtı2_addr_š™
(&
dcid
->
·th
.
loÿl
, dcid->
loÿl_addrbuf
, 0);

89 
	`ngtı2_addr_š™
(&
dcid
->
·th
.
»mÙe
, dcid->
»mÙe_addrbuf
, 0);

90 
	}
}

92 
	$ngtı2_dcid_cİy
(
ngtı2_dcid
 *
de¡
, cÚ¡‚gtı2_dcid *
¤c
) {

93 
	`ngtı2_dcid_š™
(
de¡
, 
¤c
->
£q
, &¤c->
cid
, src->
tok’
);

94 
	`ngtı2_·th_cİy
(&
de¡
->
·th
, &
¤c
->path);

95 
	}
}

97 
	$ngtı2_dcid_v”ify_uniqu’ess
(
ngtı2_dcid
 *
dcid
, 
ušt64_t
 
£q
,

98 cÚ¡ 
ngtı2_cid
 *
cid
, cÚ¡ 
ušt8_t
 *
tok’
) {

100 ià(
dcid
->
£q
 == seq) {

101  
	`ngtı2_cid_eq
(&
dcid
->
cid
, cid) &&

102 
	`memcmp
(
dcid
->
tok’
,oken,

103 
NGTCP2_STATELESS_RESET_TOKENLEN
) == 0

105 : 
NGTCP2_ERR_PROTO
;

108  !
	`ngtı2_cid_eq
(&
dcid
->
cid
, cidè? 0 : 
NGTCP2_ERR_PROTO
;

109 
	}
}

	@lib/ngtcp2_cid.h

25 #iâdeà
NGTCP2_CID_H


26 
	#NGTCP2_CID_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

34 
	~"ngtı2_pq.h
"

35 
	~"ngtı2_·th.h
"

38 
	mNGTCP2_SCID_FLAG_NONE
,

39 
	mNGTCP2_SCID_FLAG_USED
 = 0x01,

40 
	mNGTCP2_SCID_FLAG_RETIRED
 = 0x02,

41 } 
	tngtı2_scid_æag
;

44 
ngtı2_pq_’Œy
 
	m³
;

46 
ušt64_t
 
	m£q
;

48 
ngtı2_cid
 
	mcid
;

51 
ngtı2_t¡amp
 
	mts_»tœed
;

53 
ušt8_t
 
	mæags
;

57 
ušt8_t
 
	mtok’
[
NGTCP2_STATELESS_RESET_TOKENLEN
];

58 } 
	tngtı2_scid
;

62 
ušt64_t
 
	m£q
;

64 
ngtı2_cid
 
	mcid
;

67 
ngtı2_·th
 
	m·th
;

71 
ušt8_t
 
	mtok’
[
NGTCP2_STATELESS_RESET_TOKENLEN
];

72 
ušt8_t
 
	mloÿl_addrbuf
[128];

73 
ušt8_t
 
	m»mÙe_addrbuf
[128];

74 } 
	tngtı2_dcid
;

77 
ngtı2_cid_z”o
(
ngtı2_cid
 *
cid
);

83 
ngtı2_cid_eq
(cÚ¡ 
ngtı2_cid
 *
cid
, cÚ¡‚gtı2_cid *
Ùh”
);

89 
ngtı2_cid_Ëss
(cÚ¡ 
ngtı2_cid
 *
lhs
, cÚ¡‚gtı2_cid *
rhs
);

95 
ngtı2_cid_em±y
(cÚ¡ 
ngtı2_cid
 *
cid
);

102 
ngtı2_scid_š™
(
ngtı2_scid
 *
scid
, 
ušt64_t
 
£q
, cÚ¡ 
ngtı2_cid
 *
cid
,

103 cÚ¡ 
ušt8_t
 *
tok’
);

108 
ngtı2_scid_cİy
(
ngtı2_scid
 *
de¡
, cÚ¡‚gtı2_scid *
¤c
);

115 
ngtı2_dcid_š™
(
ngtı2_dcid
 *
dcid
, 
ušt64_t
 
£q
, cÚ¡ 
ngtı2_cid
 *
cid
,

116 cÚ¡ 
ušt8_t
 *
tok’
);

121 
ngtı2_dcid_cİy
(
ngtı2_dcid
 *
de¡
, cÚ¡‚gtı2_dcid *
¤c
);

127 
ngtı2_dcid_v”ify_uniqu’ess
(
ngtı2_dcid
 *
dcid
, 
ušt64_t
 
£q
,

128 cÚ¡ 
ngtı2_cid
 *
cid
, cÚ¡ 
ušt8_t
 *
tok’
);

	@lib/ngtcp2_conn.c

25 
	~"ngtı2_cÚn.h
"

27 
	~<¡ršg.h
>

28 
	~<as£¹.h
>

29 
	~<m©h.h
>

31 
	~"ngtı2_µe.h
"

32 
	~"ngtı2_maüo.h
"

33 
	~"ngtı2_log.h
"

34 
	~"ngtı2_cid.h
"

35 
	~"ngtı2_cÚv.h
"

36 
	~"ngtı2_vec.h
"

37 
	~"ngtı2_addr.h
"

38 
	~"ngtı2_·th.h
"

44 
	$cÚn_loÿl_¡»am
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
¡»am_id
) {

45  (
ušt8_t
)(
¡»am_id
 & 1è=ğ
cÚn
->
£rv”
;

46 
	}
}

52 
	$bidi_¡»am
(
ušt64_t
 
¡»am_id
è{  (¡»am_id & 0x2è=ğ0; 
	}
}

54 
	$cÚn_ÿÎ_»cv_ş›Á_š™Ÿl
(
ngtı2_cÚn
 *
cÚn
,

55 cÚ¡ 
ngtı2_cid
 *
dcid
) {

56 
rv
;

58 
	`as£¹
(
cÚn
->
ÿÎbacks
.
»cv_ş›Á_š™Ÿl
);

60 
rv
 = 
cÚn
->
ÿÎbacks
.
	`»cv_ş›Á_š™Ÿl
(cÚn, 
dcid
, cÚn->
u£r_d©a
);

61 ià(
rv
 != 0) {

62  
NGTCP2_ERR_CALLBACK_FAILURE
;

66 
	}
}

68 
	$cÚn_ÿÎ_hªdshake_com¶‘ed
(
ngtı2_cÚn
 *
cÚn
) {

69 
rv
;

71 ià(!
cÚn
->
ÿÎbacks
.
hªdshake_com¶‘ed
) {

75 
rv
 = 
cÚn
->
ÿÎbacks
.
	`hªdshake_com¶‘ed
(cÚn, cÚn->
u£r_d©a
);

76 ià(
rv
 != 0) {

77  
NGTCP2_ERR_CALLBACK_FAILURE
;

81 
	}
}

83 
	$cÚn_ÿÎ_»cv_¡»am_d©a
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
,

84 
fš
, 
ušt64_t
 
off£t
,

85 cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
) {

86 
rv
;

88 ià(!
cÚn
->
ÿÎbacks
.
»cv_¡»am_d©a
) {

92 
rv
 = 
cÚn
->
ÿÎbacks
.
	`»cv_¡»am_d©a
(cÚn, 
¡rm
->
¡»am_id
, 
fš
, 
off£t
,

93 
d©a
, 
d©®’
, 
cÚn
->
u£r_d©a
,

94 
¡rm
->
¡»am_u£r_d©a
);

95 ià(
rv
 != 0) {

96  
NGTCP2_ERR_CALLBACK_FAILURE
;

100 
	}
}

102 
	$cÚn_ÿÎ_»cv_üy±o_d©a
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
off£t
,

103 cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
) {

104 
rv
;

106 
rv
 = 
cÚn
->
ÿÎbacks
.
	`»cv_üy±o_d©a
(cÚn, 
off£t
, 
d©a
, 
d©®’
,

107 
cÚn
->
u£r_d©a
);

108 
rv
) {

110 
NGTCP2_ERR_CRYPTO
:

111 
NGTCP2_ERR_PROTO
:

112 
NGTCP2_ERR_INTERNAL
:

113 
NGTCP2_ERR_CALLBACK_FAILURE
:

114  
rv
;

116  
NGTCP2_ERR_CALLBACK_FAILURE
;

118 
	}
}

120 
	$cÚn_ÿÎ_¡»am_İ’
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
) {

121 
rv
;

123 ià(!
cÚn
->
ÿÎbacks
.
¡»am_İ’
) {

127 
rv
 = 
cÚn
->
ÿÎbacks
.
	`¡»am_İ’
(cÚn, 
¡rm
->
¡»am_id
, cÚn->
u£r_d©a
);

128 ià(
rv
 != 0) {

129  
NGTCP2_ERR_CALLBACK_FAILURE
;

133 
	}
}

135 
	$cÚn_ÿÎ_¡»am_şo£
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
,

136 
ušt16_t
 
­p_”rÜ_code
) {

137 
rv
;

139 ià(!
cÚn
->
ÿÎbacks
.
¡»am_şo£
) {

143 
rv
 = 
cÚn
->
ÿÎbacks
.
	`¡»am_şo£
(cÚn, 
¡rm
->
¡»am_id
, 
­p_”rÜ_code
,

144 
cÚn
->
u£r_d©a
, 
¡rm
->
¡»am_u£r_d©a
);

145 ià(
rv
 != 0) {

146  
NGTCP2_ERR_CALLBACK_FAILURE
;

150 
	}
}

152 
	$cÚn_ÿÎ_ex‹nd_max_¡»ams_bidi
(
ngtı2_cÚn
 *
cÚn
,

153 
ušt64_t
 
max_¡»ams
) {

154 
rv
;

156 ià(!
cÚn
->
ÿÎbacks
.
ex‹nd_max_¡»ams_bidi
) {

160 
rv
 = 
cÚn
->
ÿÎbacks
.
	`ex‹nd_max_¡»ams_bidi
(cÚn, 
max_¡»ams
,

161 
cÚn
->
u£r_d©a
);

162 ià(
rv
 != 0) {

163  
NGTCP2_ERR_CALLBACK_FAILURE
;

167 
	}
}

169 
	$cÚn_ÿÎ_ex‹nd_max_¡»ams_uni
(
ngtı2_cÚn
 *
cÚn
,

170 
ušt64_t
 
max_¡»ams
) {

171 
rv
;

173 ià(!
cÚn
->
ÿÎbacks
.
ex‹nd_max_¡»ams_uni
) {

177 
rv
 = 
cÚn
->
ÿÎbacks
.
	`ex‹nd_max_¡»ams_uni
(cÚn, 
max_¡»ams
,

178 
cÚn
->
u£r_d©a
);

179 ià(
rv
 != 0) {

180  
NGTCP2_ERR_CALLBACK_FAILURE
;

184 
	}
}

186 
	$cÚn_ÿÎ_g‘_Ãw_cÚÃùiÚ_id
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_cid
 *
cid
,

187 
ušt8_t
 *
tok’
, 
size_t
 
cidËn
) {

188 
rv
;

190 
	`as£¹
(
cÚn
->
ÿÎbacks
.
g‘_Ãw_cÚÃùiÚ_id
);

192 
rv
 = 
cÚn
->
ÿÎbacks
.
	`g‘_Ãw_cÚÃùiÚ_id
(cÚn, 
cid
, 
tok’
, 
cidËn
,

193 
cÚn
->
u£r_d©a
);

194 ià(
rv
 != 0) {

195  
NGTCP2_ERR_CALLBACK_FAILURE
;

199 
	}
}

201 
	$cÚn_ÿÎ_»move_cÚÃùiÚ_id
(
ngtı2_cÚn
 *
cÚn
,

202 cÚ¡ 
ngtı2_cid
 *
cid
) {

203 
rv
;

205 ià(!
cÚn
->
ÿÎbacks
.
»move_cÚÃùiÚ_id
) {

209 
rv
 = 
cÚn
->
ÿÎbacks
.
	`»move_cÚÃùiÚ_id
(cÚn, 
cid
, cÚn->
u£r_d©a
);

210 ià(
rv
 != 0) {

211  
NGTCP2_ERR_CALLBACK_FAILURE
;

215 
	}
}

217 
	$cÚn_ÿÎ_·th_v®id©iÚ
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_·th
 *
·th
,

218 
ngtı2_·th_v®id©iÚ_»suÉ
 
»s
) {

219 
rv
;

221 ià(!
cÚn
->
ÿÎbacks
.
·th_v®id©iÚ
) {

225 
rv
 = 
cÚn
->
ÿÎbacks
.
	`·th_v®id©iÚ
(cÚn, 
·th
, 
»s
, cÚn->
u£r_d©a
);

226 ià(
rv
 != 0) {

227  
NGTCP2_ERR_CALLBACK_FAILURE
;

231 
	}
}

233 
	$üy±o_off£t_Ëss
(cÚ¡ 
ngtı2_pq_’Œy
 *
lhs
,

234 cÚ¡ 
ngtı2_pq_’Œy
 *
rhs
) {

235 
ngtı2_üy±o_äame_chaš
 *
läc
 =

236 
	`ngtı2_¡ruù_of
(
lhs
, 
ngtı2_üy±o_äame_chaš
, 
³
);

237 
ngtı2_üy±o_äame_chaš
 *
räc
 =

238 
	`ngtı2_¡ruù_of
(
rhs
, 
ngtı2_üy±o_äame_chaš
, 
³
);

240  
läc
->
ä
.
off£t
 < 
räc
->fr.offset;

241 
	}
}

243 
	$pkŠs_š™
(
ngtı2_pkŠs
 *
pkŠs
, 
ngtı2_deçuÉ_cc
 *
cc
,

244 
ngtı2_log
 *
log
, 
ngtı2_mem
 *
mem
) {

245 
rv
;

247 
rv
 = 
	`ngtı2_g­Œ_š™
(&
pkŠs
->
²g­
, 
mem
);

248 ià(
rv
 != 0) {

249  
rv
;

252 
pkŠs
->
Ï¡_tx_pkt_num
 = (
ušt64_t
)-1;

253 
pkŠs
->
max_rx_pkt_num
 = (
ušt64_t
)-1;

255 
rv
 = 
	`ngtı2_ackŒ_š™
(&
pkŠs
->
ackŒ
, 
log
, 
mem
);

256 ià(
rv
 != 0) {

257 
	`ngtı2_g­Œ_ä“
(&
pkŠs
->
²g­
);

258  
rv
;

261 
	`ngtı2_¹b_š™
(&
pkŠs
->
¹b
, 
cc
, 
log
, 
mem
);

262 
	`ngtı2_pq_š™
(&
pkŠs
->
üy±oäq
, 
üy±o_off£t_Ëss
, 
mem
);

265 
	}
}

267 
	$cyşe_Ëss
(cÚ¡ 
ngtı2_pq_’Œy
 *
lhs
, cÚ¡‚gtı2_pq_’Œy *
rhs
) {

268 
ngtı2_¡rm
 *
ls
 = 
	`ngtı2_¡ruù_of
(
lhs
,‚gtı2_¡rm, 
³
);

269 
ngtı2_¡rm
 *
rs
 = 
	`ngtı2_¡ruù_of
(
rhs
,‚gtı2_¡rm, 
³
);

271 ià(
ls
->
cyşe
 < 
rs
->cycle) {

272  
rs
->
cyşe
 - 
ls
->cycle <= 1;

275  
ls
->
cyşe
 - 
rs
->cycle > 1;

276 
	}
}

278 
	$pkŠs_ä“
(
ngtı2_pkŠs
 *
pkŠs
, 
ngtı2_mem
 *
mem
) {

279 
ngtı2_üy±o_äame_chaš
 *
äc
;

281 
	`ngtı2_äame_chaš_li¡_d–
(
pkŠs
->
äq
, 
mem
);

283 
	`ngtı2_vec_d–
(
pkŠs
->
rx_hp
, 
mem
);

284 
	`ngtı2_vec_d–
(
pkŠs
->
tx_hp
, 
mem
);

286 
	`ngtı2_üy±o_km_d–
(
pkŠs
->
rx_ckm
, 
mem
);

287 
	`ngtı2_üy±o_km_d–
(
pkŠs
->
tx_ckm
, 
mem
);

289 ; !
	`ngtı2_pq_em±y
(&
pkŠs
->
üy±oäq
);) {

290 
äc
 = 
	`ngtı2_¡ruù_of
(
	`ngtı2_pq_tİ
(&
pkŠs
->
üy±oäq
),

291 
ngtı2_üy±o_äame_chaš
, 
³
);

292 
	`ngtı2_pq_pİ
(&
pkŠs
->
üy±oäq
);

293 
	`ngtı2_üy±o_äame_chaš_d–
(
äc
, 
mem
);

296 
	`ngtı2_pq_ä“
(&
pkŠs
->
üy±oäq
);

297 
	`ngtı2_¹b_ä“
(&
pkŠs
->
¹b
);

298 
	`ngtı2_ackŒ_ä“
(&
pkŠs
->
ackŒ
);

299 
	`ngtı2_g­Œ_ä“
(&
pkŠs
->
²g­
);

300 
	}
}

307 
ngtı2_cid
 
	gšf_cid
 = {

308 
NGTCP2_MAX_CIDLEN
,

331 
	$cid_Ëss
(cÚ¡ 
ngtı2_k¦_key
 *
lhs
, cÚ¡‚gtı2_k¦_key *
rhs
) {

332  
	`ngtı2_cid_Ëss
(
lhs
->
±r
, 
rhs
->ptr);

333 
	}
}

335 
	$ts_»tœed_Ëss
(cÚ¡ 
ngtı2_pq_’Œy
 *
lhs
,

336 cÚ¡ 
ngtı2_pq_’Œy
 *
rhs
) {

337 cÚ¡ 
ngtı2_scid
 *
a
 = 
	`ngtı2_¡ruù_of
(
lhs
,‚gtı2_scid, 
³
);

338 cÚ¡ 
ngtı2_scid
 *
b
 = 
	`ngtı2_¡ruù_of
(
rhs
,‚gtı2_scid, 
³
);

340  
a
->
ts_»tœed
 < 
b
->ts_retired;

341 
	}
}

343 
	$rcvry_¡©_»£t
(
ngtı2_rcvry_¡©
 *
rcs
) {

344 
	`mem£t
(
rcs
, 0, (*rcs));

345 
rcs
->
mš_¹t
 = 
UINT64_MAX
;

346 
	}
}

348 
	$cc_¡©_»£t
(
ngtı2_cc_¡©
 *
ccs
) {

349 
	`mem£t
(
ccs
, 0, (*ccs));

350 
ccs
->
cwnd
 = 
	`ngtı2_mš
(10 * 
NGTCP2_MAX_DGRAM_SIZE
,

351 
	`ngtı2_max
(2 * 
NGTCP2_MAX_DGRAM_SIZE
, 14600));

352 
ccs
->
s¡h»sh
 = 
UINT64_MAX
;

353 
	}
}

355 
	$cÚn_Ãw
(
ngtı2_cÚn
 **
pcÚn
, cÚ¡ 
ngtı2_cid
 *
dcid
,

356 cÚ¡ 
ngtı2_cid
 *
scid
, cÚ¡ 
ngtı2_·th
 *
·th
,

357 
ušt32_t
 
v”siÚ
, cÚ¡ 
ngtı2_cÚn_ÿÎbacks
 *
ÿÎbacks
,

358 cÚ¡ 
ngtı2_£‰šgs
 *
£‰šgs
, *
u£r_d©a
,

359 
£rv”
) {

360 
rv
;

361 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

362 
ngtı2_scid
 *
scid’t
;

363 
ngtı2_k¦_key
 
key
;

365 *
pcÚn
 = 
	`ngtı2_mem_ÿÎoc
(
mem
, 1, (
ngtı2_cÚn
));

366 ià(*
pcÚn
 =ğ
NULL
) {

367 
rv
 = 
NGTCP2_ERR_NOMEM
;

368 
ç_cÚn
;

371 
rv
 = 
	`ngtı2_ršgbuf_š™
(&(*
pcÚn
)->
bound_dcids
,

372 
NGTCP2_MAX_BOUND_DCID_POOL_SIZE
, (
ngtı2_dcid
),

373 
mem
);

374 ià(
rv
 != 0) {

375 
ç_bound_dcids_š™
;

378 
rv
 = 
	`ngtı2_ršgbuf_š™
(&(*
pcÚn
)->
dcids
, 
NGTCP2_MAX_DCID_POOL_SIZE
,

379 (
ngtı2_scid
), 
mem
);

380 ià(
rv
 != 0) {

381 
ç_dcids_š™
;

384 
rv
 = 
	`ngtı2_k¦_š™
(&(*
pcÚn
)->
scids
, 
cid_Ëss
,

385 
	`ngtı2_k¦_key_±r
(&
key
, &
šf_cid
), 
mem
);

386 ià(
rv
 != 0) {

387 
ç_scids_š™
;

390 
	`ngtı2_pq_š™
(&(*
pcÚn
)->
u£d_scids
, 
ts_»tœed_Ëss
, 
mem
);

392 
rv
 = 
	`ngtı2_¡rm_š™
(&(*
pcÚn
)->
üy±o
, 0, 
NGTCP2_STRM_FLAG_NONE
, 0, 0, 
NULL
,

393 
mem
);

394 ià(
rv
 != 0) {

395 
ç_üy±o_š™
;

398 
rv
 = 
	`ngtı2_m­_š™
(&(*
pcÚn
)->
¡rms
, 
mem
);

399 ià(
rv
 != 0) {

400 
ç_¡rms_š™
;

403 
	`ngtı2_pq_š™
(&(*
pcÚn
)->
tx_¡rmq
, 
cyşe_Ëss
, 
mem
);

405 
rv
 = 
	`ngtı2_idŒ_š™
(&(*
pcÚn
)->
»mÙe_bidi_idŒ
, !
£rv”
, 
mem
);

406 ià(
rv
 != 0) {

407 
ç_»mÙe_bidi_idŒ_š™
;

410 
rv
 = 
	`ngtı2_idŒ_š™
(&(*
pcÚn
)->
»mÙe_uni_idŒ
, !
£rv”
, 
mem
);

411 ià(
rv
 != 0) {

412 
ç_»mÙe_uni_idŒ_š™
;

415 
rv
 = 
	`ngtı2_ršgbuf_š™
(&(*
pcÚn
)->
rx_·th_ch®Ënge
, 4,

416 (
ngtı2_·th_ch®Ënge_’Œy
), 
mem
);

417 ià(
rv
 != 0) {

418 
ç_rx_·th_ch®Ënge_š™
;

421 
	`ngtı2_log_š™
(&(*
pcÚn
)->
log
, 
scid
, 
£‰šgs
->
log_´štf
,

422 
£‰šgs
->
š™Ÿl_ts
, 
u£r_d©a
);

424 
	`ngtı2_deçuÉ_cc_š™
(&(*
pcÚn
)->
cc
, &(*pcÚn)->
ccs
, &(*pcÚn)->
log
);

426 
rv
 = 
	`pkŠs_š™
(&(*
pcÚn
)->
š_pkŠs
, &(*pcÚn)->
cc
, &(*pcÚn)->
log
, 
mem
);

427 ià(
rv
 != 0) {

428 
ç_š_pkŠs_š™
;

431 
rv
 = 
	`pkŠs_š™
(&(*
pcÚn
)->
hs_pkŠs
, &(*pcÚn)->
cc
, &(*pcÚn)->
log
, 
mem
);

432 ià(
rv
 != 0) {

433 
ç_hs_pkŠs_š™
;

436 
rv
 = 
	`pkŠs_š™
(&(*
pcÚn
)->
pkŠs
, &(*pcÚn)->
cc
, &(*pcÚn)->
log
, 
mem
);

437 ià(
rv
 != 0) {

438 
ç_pkŠs_š™
;

441 
scid’t
 = 
	`ngtı2_mem_m®loc
(
mem
, (*scident));

442 ià(
scid’t
 =ğ
NULL
) {

443 
rv
 = 
NGTCP2_ERR_NOMEM
;

444 
ç_scid’t
;

447 
	`ngtı2_scid_š™
(
scid’t
, 0, 
scid
,

448 
£‰šgs
->
¡©–ess_»£t_tok’_´e£Á


449 ? 
£‰šgs
->
¡©–ess_»£t_tok’


450 : 
NULL
);

452 
rv
 = 
	`ngtı2_k¦_š£¹
(&(*
pcÚn
)->
scids
, 
NULL
,

453 
	`ngtı2_k¦_key_±r
(&
key
, &
scid’t
->
cid
), scident);

454 ià(
rv
 != 0) {

455 
ç_scids_š£¹
;

458 
	`ngtı2_dcid_š™
(&(*
pcÚn
)->
dcid
, 0, dcid, 
NULL
);

459 
	`ngtı2_·th_cİy
(&(*
pcÚn
)->
dcid
.
·th
,…ath);

461 (*
pcÚn
)->
oscid
 = *
scid
;

462 (*
pcÚn
)->
ÿÎbacks
 = *callbacks;

463 (*
pcÚn
)->
v”siÚ
 = version;

464 (*
pcÚn
)->
mem
 = mem;

465 (*
pcÚn
)->
u£r_d©a
 = user_data;

466 (*
pcÚn
)->
loÿl_£‰šgs
 = *
£‰šgs
;

467 (*
pcÚn
)->
un£Á_max_rx_off£t
 = (*pcÚn)->
max_rx_off£t
 = 
£‰šgs
->
max_d©a
;

469 
	`rcvry_¡©_»£t
(&(*
pcÚn
)->
rcs
);

470 
	`cc_¡©_»£t
(&(*
pcÚn
)->
ccs
);

474 
ç_scids_š£¹
:

475 
	`ngtı2_mem_ä“
(
mem
, 
scid’t
);

476 
ç_scid’t
:

477 
	`pkŠs_ä“
(&(*
pcÚn
)->
pkŠs
, 
mem
);

478 
ç_pkŠs_š™
:

479 
	`pkŠs_ä“
(&(*
pcÚn
)->
hs_pkŠs
, 
mem
);

480 
ç_hs_pkŠs_š™
:

481 
	`pkŠs_ä“
(&(*
pcÚn
)->
š_pkŠs
, 
mem
);

482 
ç_š_pkŠs_š™
:

483 
	`ngtı2_deçuÉ_cc_ä“
(&(*
pcÚn
)->
cc
);

484 
	`ngtı2_ršgbuf_ä“
(&(*
pcÚn
)->
rx_·th_ch®Ënge
);

485 
ç_rx_·th_ch®Ënge_š™
:

486 
	`ngtı2_idŒ_ä“
(&(*
pcÚn
)->
»mÙe_uni_idŒ
);

487 
ç_»mÙe_uni_idŒ_š™
:

488 
	`ngtı2_idŒ_ä“
(&(*
pcÚn
)->
»mÙe_bidi_idŒ
);

489 
ç_»mÙe_bidi_idŒ_š™
:

490 
	`ngtı2_m­_ä“
(&(*
pcÚn
)->
¡rms
);

491 
ç_¡rms_š™
:

492 
	`ngtı2_¡rm_ä“
(&(*
pcÚn
)->
üy±o
);

493 
ç_üy±o_š™
:

494 
	`ngtı2_k¦_ä“
(&(*
pcÚn
)->
scids
);

495 
ç_scids_š™
:

496 
	`ngtı2_ršgbuf_ä“
(&(*
pcÚn
)->
dcids
);

497 
ç_dcids_š™
:

498 
	`ngtı2_ršgbuf_ä“
(&(*
pcÚn
)->
bound_dcids
);

499 
ç_bound_dcids_š™
:

500 
	`ngtı2_mem_ä“
(
mem
, *
pcÚn
);

501 
ç_cÚn
:

502  
rv
;

503 
	}
}

505 
	$ngtı2_cÚn_ş›Á_Ãw
(
ngtı2_cÚn
 **
pcÚn
, cÚ¡ 
ngtı2_cid
 *
dcid
,

506 cÚ¡ 
ngtı2_cid
 *
scid
, cÚ¡ 
ngtı2_·th
 *
·th
,

507 
ušt32_t
 
v”siÚ
,

508 cÚ¡ 
ngtı2_cÚn_ÿÎbacks
 *
ÿÎbacks
,

509 cÚ¡ 
ngtı2_£‰šgs
 *
£‰šgs
, *
u£r_d©a
) {

510 
rv
;

511 
rv
 = 
	`cÚn_Ãw
(
pcÚn
, 
dcid
, 
scid
, 
·th
, 
v”siÚ
, 
ÿÎbacks
, 
£‰šgs
,

512 
u£r_d©a
, 0);

513 ià(
rv
 != 0) {

514  
rv
;

516 (*
pcÚn
)->
rcid
 = *
dcid
;

517 (*
pcÚn
)->
un£Á_max_»mÙe_¡»am_id_bidi
 =

518 (*
pcÚn
)->
max_»mÙe_¡»am_id_bidi
 =

519 
	`ngtı2_Áh_£rv”_bidi_id
(
£‰šgs
->
max_¡»ams_bidi
);

521 (*
pcÚn
)->
un£Á_max_»mÙe_¡»am_id_uni
 =

522 (*
pcÚn
)->
max_»mÙe_¡»am_id_uni
 =

523 
	`ngtı2_Áh_£rv”_uni_id
(
£‰šgs
->
max_¡»ams_uni
);

525 (*
pcÚn
)->
¡©e
 = 
NGTCP2_CS_CLIENT_INITIAL
;

526 (*
pcÚn
)->
Ãxt_loÿl_¡»am_id_bidi
 = 0;

527 (*
pcÚn
)->
Ãxt_loÿl_¡»am_id_uni
 = 2;

529 
	}
}

531 
	$ngtı2_cÚn_£rv”_Ãw
(
ngtı2_cÚn
 **
pcÚn
, cÚ¡ 
ngtı2_cid
 *
dcid
,

532 cÚ¡ 
ngtı2_cid
 *
scid
, cÚ¡ 
ngtı2_·th
 *
·th
,

533 
ušt32_t
 
v”siÚ
,

534 cÚ¡ 
ngtı2_cÚn_ÿÎbacks
 *
ÿÎbacks
,

535 cÚ¡ 
ngtı2_£‰šgs
 *
£‰šgs
, *
u£r_d©a
) {

536 
rv
;

537 
rv
 = 
	`cÚn_Ãw
(
pcÚn
, 
dcid
, 
scid
, 
·th
, 
v”siÚ
, 
ÿÎbacks
, 
£‰šgs
,

538 
u£r_d©a
, 1);

539 ià(
rv
 != 0) {

540  
rv
;

542 (*
pcÚn
)->
£rv”
 = 1;

543 (*
pcÚn
)->
un£Á_max_»mÙe_¡»am_id_bidi
 =

544 (*
pcÚn
)->
max_»mÙe_¡»am_id_bidi
 =

545 
	`ngtı2_Áh_ş›Á_bidi_id
(
£‰šgs
->
max_¡»ams_bidi
);

547 (*
pcÚn
)->
un£Á_max_»mÙe_¡»am_id_uni
 =

548 (*
pcÚn
)->
max_»mÙe_¡»am_id_uni
 =

549 
	`ngtı2_Áh_ş›Á_uni_id
(
£‰šgs
->
max_¡»ams_uni
);

551 (*
pcÚn
)->
¡©e
 = 
NGTCP2_CS_SERVER_INITIAL
;

552 (*
pcÚn
)->
Ãxt_loÿl_¡»am_id_bidi
 = 1;

553 (*
pcÚn
)->
Ãxt_loÿl_¡»am_id_uni
 = 3;

555 
	}
}

562 
size_t
 
	$cÚn_fc_üed™s
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
) {

563  
	`ngtı2_mš
(
¡rm
->
max_tx_off£t
 - sŒm->
tx_off£t
,

564 
cÚn
->
max_tx_off£t
 - cÚn->
tx_off£t
);

565 
	}
}

572 
size_t
 
	$cÚn_’fÜû_æow_cÚŒŞ
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
,

573 
size_t
 
Ën
) {

574 
size_t
 
fc_üed™s
 = 
	`cÚn_fc_üed™s
(
cÚn
, 
¡rm
);

575  
	`ngtı2_mš
(
Ën
, 
fc_üed™s
);

576 
	}
}

578 
	$d–‘e_bufãd_pkts
(
ngtı2_pkt_chaš
 *
pc
, 
ngtı2_mem
 *
mem
) {

579 
ngtı2_pkt_chaš
 *
Ãxt
;

581 ; 
pc
;) {

582 
Ãxt
 = 
pc
->next;

583 
	`ngtı2_pkt_chaš_d–
(
pc
, 
mem
);

584 
pc
 = 
Ãxt
;

586 
	}
}

588 
	$d–‘e_¡rms_—ch
(
ngtı2_m­_’Œy
 *
’t
, *
±r
) {

589 
ngtı2_mem
 *
mem
 = 
±r
;

590 
ngtı2_¡rm
 *
s
 = 
	`ngtı2_¡ruù_of
(
’t
,‚gtı2_¡rm, 
me
);

592 
	`ngtı2_¡rm_ä“
(
s
);

593 
	`ngtı2_mem_ä“
(
mem
, 
s
);

596 
	}
}

598 
	$d–‘e_scid
(
ngtı2_k¦
 *
scids
, 
ngtı2_mem
 *
mem
) {

599 
ngtı2_k¦_™
 
™
;

601 
™
 = 
	`ngtı2_k¦_begš
(
scids
); !
	`ngtı2_k¦_™_’d
(&it);

602 
	`ngtı2_k¦_™_Ãxt
(&
™
)) {

603 
	`ngtı2_mem_ä“
(
mem
, 
	`ngtı2_k¦_™_g‘
(&
™
));

605 
	}
}

607 
	$ngtı2_cÚn_d–
(
ngtı2_cÚn
 *
cÚn
) {

608 ià(
cÚn
 =ğ
NULL
) {

612 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, cÚn->
tok’
.
begš
);

613 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, cÚn->
deüy±_buf
.
ba£
);

615 
	`d–‘e_bufãd_pkts
(
cÚn
->
bufãd_rx_µkts
, cÚn->
mem
);

616 
	`d–‘e_bufãd_pkts
(
cÚn
->
bufãd_rx_hs_pkts
, cÚn->
mem
);

618 
	`ngtı2_üy±o_km_d–
(
cÚn
->
Ãw_rx_ckm
, cÚn->
mem
);

619 
	`ngtı2_üy±o_km_d–
(
cÚn
->
Ãw_tx_ckm
, cÚn->
mem
);

620 
	`ngtı2_üy±o_km_d–
(
cÚn
->
Şd_rx_ckm
, cÚn->
mem
);

621 
	`ngtı2_vec_d–
(
cÚn
->
—¾y_hp
, cÚn->
mem
);

622 
	`ngtı2_üy±o_km_d–
(
cÚn
->
—¾y_ckm
, cÚn->
mem
);

624 
	`pkŠs_ä“
(&
cÚn
->
pkŠs
, cÚn->
mem
);

625 
	`pkŠs_ä“
(&
cÚn
->
hs_pkŠs
, cÚn->
mem
);

626 
	`pkŠs_ä“
(&
cÚn
->
š_pkŠs
, cÚn->
mem
);

628 
	`ngtı2_deçuÉ_cc_ä“
(&
cÚn
->
cc
);

630 
	`ngtı2_ršgbuf_ä“
(&
cÚn
->
rx_·th_ch®Ënge
);

632 
	`ngtı2_pv_d–
(
cÚn
->
pv
);

634 
	`ngtı2_idŒ_ä“
(&
cÚn
->
»mÙe_uni_idŒ
);

635 
	`ngtı2_idŒ_ä“
(&
cÚn
->
»mÙe_bidi_idŒ
);

636 
	`ngtı2_pq_ä“
(&
cÚn
->
tx_¡rmq
);

637 
	`ngtı2_m­_—ch_ä“
(&
cÚn
->
¡rms
, 
d–‘e_¡rms_—ch
, cÚn->
mem
);

638 
	`ngtı2_m­_ä“
(&
cÚn
->
¡rms
);

640 
	`ngtı2_¡rm_ä“
(&
cÚn
->
üy±o
);

642 
	`ngtı2_pq_ä“
(&
cÚn
->
u£d_scids
);

643 
	`d–‘e_scid
(&
cÚn
->
scids
, cÚn->
mem
);

644 
	`ngtı2_k¦_ä“
(&
cÚn
->
scids
);

645 
	`ngtı2_ršgbuf_ä“
(&
cÚn
->
dcids
);

646 
	`ngtı2_ršgbuf_ä“
(&
cÚn
->
bound_dcids
);

648 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, conn);

649 
	}
}

663 
	$cÚn_’su»_ack_blks
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_äame
 **
pä
,

664 
size_t
 *
²um_blks_max
, size_ˆ
n
) {

665 
ngtı2_äame
 *
ä
;

667 ià(
n
 <ğ*
²um_blks_max
) {

671 *
²um_blks_max
 *= 2;

672 
ä
 = 
	`ngtı2_mem_»®loc
(
cÚn
->
mem
, *
pä
,

673 (
ngtı2_ack
) +

674 (
ngtı2_ack_blk
è* (*
²um_blks_max
 - 1));

675 ià(
ä
 =ğ
NULL
) {

676  
NGTCP2_ERR_NOMEM
;

679 *
pä
 = 
ä
;

682 
	}
}

688 
ngtı2_du¿tiÚ
 
	$cÚn_compu‹_ack_d–ay
(
ngtı2_cÚn
 *
cÚn
) {

689 
ngtı2_du¿tiÚ
 
š™Ÿl_d–ay
 =

690 (
ngtı2_du¿tiÚ
)
cÚn
->
loÿl_£‰šgs
.
max_ack_d–ay
 *

691 (
NGTCP2_DURATION_TICK
 / 
NGTCP2_MILLISECONDS
);

693 ià(
cÚn
->
rcs
.
smoÙhed_¹t
 < 1e-9) {

694  
š™Ÿl_d–ay
;

697  
	`ngtı2_mš
(
š™Ÿl_d–ay
,

698 (
ngtı2_du¿tiÚ
)(
cÚn
->
rcs
.
smoÙhed_¹t
 / 4));

699 
	}
}

721 
	$cÚn_ü—‹_ack_äame
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_äame
 **
pä
,

722 
ngtı2_ackŒ
 *
ackŒ
, 
ngtı2_t¡amp
 
ts
,

723 
ušt64_t
 
ack_d–ay
,

724 
ušt64_t
 
ack_d–ay_expÚ’t
) {

725 
ušt64_t
 
Ï¡_pkt_num
;

726 
ngtı2_ack_blk
 *
blk
;

727 
ngtı2_k¦_™
 
™
;

728 
ngtı2_ackŒ_’Œy
 *
½kt
;

729 
ngtı2_äame
 *
ä
;

730 
ngtı2_ack
 *
ack
;

733 
size_t
 
num_blks_max
 = 8;

734 
size_t
 
blk_idx
;

735 
rv
;

737 ià(
ackŒ
->
æags
 & 
NGTCP2_ACKTR_FLAG_IMMEDIATE_ACK
) {

738 
ack_d–ay
 = 0;

741 ià(!
	`ngtı2_ackŒ_»quœe_aùive_ack
(
ackŒ
, 
ack_d–ay
, 
ts
)) {

745 
™
 = 
	`ngtı2_ackŒ_g‘
(
ackŒ
);

746 ià(
	`ngtı2_k¦_™_’d
(&
™
)) {

747 
	`ngtı2_ackŒ_comm™_ack
(
ackŒ
);

751 
ä
 = 
	`ngtı2_mem_m®loc
(
cÚn
->
mem
, (
ngtı2_ack
) +

752 (
ngtı2_ack_blk
è* 
num_blks_max
);

753 ià(
ä
 =ğ
NULL
) {

754  
NGTCP2_ERR_NOMEM
;

757 
ack
 = &
ä
->ack;

759 
½kt
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

760 
Ï¡_pkt_num
 = 
½kt
->
pkt_num
 - (½kt->
Ën
 - 1);

761 
ack
->
ty³
 = 
NGTCP2_FRAME_ACK
;

762 
ack
->
Ïrge¡_ack
 = 
½kt
->
pkt_num
;

763 
ack
->
fœ¡_ack_blkËn
 = 
½kt
->
Ën
 - 1;

764 
ack
->
ack_d–ay_unsÿËd
 = 
ts
 - 
½kt
->
t¡amp
;

765 
ack
->
ack_d–ay
 =‡ck->
ack_d–ay_unsÿËd
 /

766 (
NGTCP2_DURATION_TICK
 / 
NGTCP2_MICROSECONDS
) /

767 (1UL << 
ack_d–ay_expÚ’t
);

768 
ack
->
num_blks
 = 0;

770 
	`ngtı2_k¦_™_Ãxt
(&
™
);

772 ; !
	`ngtı2_k¦_™_’d
(&
™
); 
	`ngtı2_k¦_™_Ãxt
(&it)) {

773 
½kt
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

775 
blk_idx
 = 
ack
->
num_blks
++;

776 
rv
 = 
	`cÚn_’su»_ack_blks
(
cÚn
, &
ä
, &
num_blks_max
, 
ack
->
num_blks
);

777 ià(
rv
 != 0) {

778 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, 
ä
);

779  
rv
;

781 
ack
 = &
ä
->ack;

782 
blk
 = &
ack
->
blks
[
blk_idx
];

783 
blk
->
g­
 = 
Ï¡_pkt_num
 - 
½kt
->
pkt_num
 - 2;

784 
blk
->
blkËn
 = 
½kt
->
Ën
 - 1;

786 
Ï¡_pkt_num
 = 
½kt
->
pkt_num
 - (½kt->
Ën
 - 1);

788 ià(
ack
->
num_blks
 =ğ
NGTCP2_MAX_ACK_BLKS
) {

795 ià(!
	`ngtı2_k¦_™_’d
(&
™
)) {

796 
rv
 = 
	`ngtı2_ackŒ_fÜg‘
(
ackŒ
, 
	`ngtı2_k¦_™_g‘
(&
™
));

797 ià(
rv
 != 0) {

798  
rv
;

802 *
pä
 = 
ä
;

805 
	}
}

818 
	$cÚn_µe_wr™e_äame_hd_log
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_µe
 *
µe
,

819 *
hd_logged
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

820 
ngtı2_äame
 *
ä
) {

821 
rv
;

823 
rv
 = 
	`ngtı2_µe_’code_äame
(
µe
, 
ä
);

824 ià(
rv
 != 0) {

825 
	`as£¹
(
NGTCP2_ERR_NOBUF
 =ğ
rv
);

826  
rv
;

829 ià(
hd_logged
 && !*hd_logged) {

830 *
hd_logged
 = 1;

831 
	`ngtı2_log_tx_pkt_hd
(&
cÚn
->
log
, 
hd
);

834 
	`ngtı2_log_tx_ä
(&
cÚn
->
log
, 
hd
, 
ä
);

837 
	}
}

848 
	$cÚn_µe_wr™e_äame
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_µe
 *
µe
,

849 cÚ¡ 
ngtı2_pkt_hd
 *
hd
, 
ngtı2_äame
 *
ä
) {

850  
	`cÚn_µe_wr™e_äame_hd_log
(
cÚn
, 
µe
, 
NULL
, 
hd
, 
ä
);

851 
	}
}

862 
	$cÚn_Ú_pkt_£Á
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¹b
 *
¹b
,

863 
ngtı2_¹b_’Œy
 *
’t
) {

864 
rv
;

868 
rv
 = 
	`ngtı2_¹b_add
(
¹b
, 
’t
);

869 ià(
rv
 != 0) {

870  
rv
;

873 ià(
’t
->
æags
 & 
NGTCP2_RTB_FLAG_CRYPTO_PKT
) {

874 
	`as£¹
(
	`ngtı2_pkt_hªdshake_pkt
(&
’t
->
hd
));

875 
cÚn
->
rcs
.
Ï¡_hs_tx_pkt_ts
 = 
’t
->
ts
;

877 
cÚn
->
rcs
.
Ï¡_tx_pkt_ts
 = 
’t
->
ts
;

879 
	`ngtı2_cÚn_£t_loss_d‘eùiÚ_tim”
(
cÚn
);

882 
	}
}

890 
size_t
 
	$¹b_£Ëù_pkt_numËn
(
ngtı2_¹b
 *
¹b
, 
ušt64_t
 
pkt_num
) {

891 
ušt64_t
 
n
 = (ušt64_t)((
št64_t
)
pkt_num
 - 
¹b
->
Ïrge¡_acked_tx_pkt_num
);

892 ià(
UINT64_MAX
 / 2 <ğ
pkt_num
) {

896 
n
 =‚ * 2 + 1;

898 ià(
n
 > 0xffffffu) {

901 ià(
n
 > 0xffffu) {

904 ià(
n
 > 0xffu) {

908 
	}
}

914 
ušt64_t
 
	$cÚn_cwnd_Ëá
(
ngtı2_cÚn
 *
cÚn
) {

915 
ušt64_t
 
by‹s_š_æight
 = 
	`ngtı2_cÚn_g‘_by‹s_š_æight
(
cÚn
);

919 ià(
by‹s_š_æight
 >ğ
cÚn
->
ccs
.
cwnd
) {

922  
cÚn
->
ccs
.
cwnd
 - 
by‹s_š_æight
;

923 
	}
}

930 
size_t
 
	$cÚn_»Œy_—¾y_·ylßdËn
(
ngtı2_cÚn
 *
cÚn
) {

931 
ngtı2_¡»am_äame_chaš
 *
säc
;

932 
ngtı2_¡rm
 *
¡rm
;

934 ; !
	`ngtı2_pq_em±y
(&
cÚn
->
tx_¡rmq
);) {

935 
¡rm
 = 
	`ngtı2_cÚn_tx_¡rmq_tİ
(
cÚn
);

936 ià(
	`ngtı2_¡rm_¡»amäq_em±y
(
¡rm
)) {

937 
	`ngtı2_cÚn_tx_¡rmq_pİ
(
cÚn
);

941 
säc
 = 
	`ngtı2_¡rm_¡»amäq_tİ
(
¡rm
);

942  
	`ngtı2_vec_Ën
(
säc
->
ä
.
d©a
, säc->ä.
d©aút
) +

943 
NGTCP2_STREAM_OVERHEAD
;

947 
	}
}

953 
ngtı2_üy±o_äame_chaš
 *
	$cÚn_üy±oäq_tİ
(
ngtı2_cÚn
 *
cÚn
,

954 
ngtı2_pkŠs
 *
pkŠs
) {

955 ()
cÚn
;

956 
	`as£¹
(!
	`ngtı2_pq_em±y
(&
pkŠs
->
üy±oäq
));

957  
	`ngtı2_¡ruù_of
(
	`ngtı2_pq_tİ
(&
pkŠs
->
üy±oäq
),

958 
ngtı2_üy±o_äame_chaš
, 
³
);

959 
	}
}

961 
	$cÚn_üy±oäq_pİ
(
ngtı2_cÚn
 *
cÚn
,

962 
ngtı2_üy±o_äame_chaš
 **
päc
,

963 
ngtı2_pkŠs
 *
pkŠs
, 
size_t
 
Ëá
) {

964 
ngtı2_üy±o
 *
ä
, *
nä
;

965 
ngtı2_üy±o_äame_chaš
 *
äc
, *
näc
;

966 
rv
;

967 
ssize_t
 
n¥l™
;

968 
size_t
 
nm”ged
;

969 
size_t
 
d©®’
;

971 ià(
	`ngtı2_pq_em±y
(&
pkŠs
->
üy±oäq
)) {

972 *
päc
 = 
NULL
;

976 
äc
 = 
	`ngtı2_¡ruù_of
(
	`ngtı2_pq_tİ
(&
pkŠs
->
üy±oäq
),

977 
ngtı2_üy±o_äame_chaš
, 
³
);

978 
	`ngtı2_pq_pİ
(&
pkŠs
->
üy±oäq
);

979 
äc
->
³
.
šdex
 = 
NGTCP2_PQ_BAD_INDEX
;

981 
ä
 = &
äc
->fr;

983 
d©®’
 = 
	`ngtı2_vec_Ën
(
ä
->
d©a
, fr->
d©aút
);

984 ià(
d©®’
 > 
Ëá
) {

985 ià(!
	`ngtı2_pq_em±y
(&
pkŠs
->
üy±oäq
)) {

986 
näc
 = 
	`ngtı2_¡ruù_of
(
	`ngtı2_pq_tİ
(&
pkŠs
->
üy±oäq
),

987 
ngtı2_üy±o_äame_chaš
, 
³
);

988 
nä
 = &
näc
->
ä
;

990 ià(
ä
->
off£t
 + 
d©®’
 =ğ
nä
->offset) {

991 
n¥l™
 =

992 
	`ngtı2_vec_¥l™
(
ä
->
d©a
, &ä->
d©aút
, 
nä
->data, &nfr->datacnt,

993 
Ëá
, 
NGTCP2_MAX_CRYPTO_DATACNT
);

994 
	`as£¹
(
n¥l™
);

996 ià(
n¥l™
 > 0) {

997 
	`ngtı2_pq_pİ
(&
pkŠs
->
üy±oäq
);

998 
nä
->
Üd”ed_off£t
 -ğ(
size_t
)
n¥l™
;

999 
nä
->
off£t
 -ğ(
size_t
)
n¥l™
;

1001 
rv
 = 
	`ngtı2_pq_push
(&
pkŠs
->
üy±oäq
, &
näc
->
³
);

1002 ià(
rv
 != 0) {

1003 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

1004 
	`ngtı2_üy±o_äame_chaš_d–
(
näc
, 
cÚn
->
mem
);

1005 
	`ngtı2_üy±o_äame_chaš_d–
(
äc
, 
cÚn
->
mem
);

1006  
rv
;

1009 *
päc
 = 
äc
;

1016 
rv
 = 
	`ngtı2_üy±o_äame_chaš_Ãw
(&
näc
, 
cÚn
->
mem
);

1017 ià(
rv
 != 0) {

1018 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

1019 
	`ngtı2_üy±o_äame_chaš_d–
(
äc
, 
cÚn
->
mem
);

1020  
rv
;

1023 
nä
 = &
näc
->
ä
;

1024 
nä
->
ty³
 = 
NGTCP2_FRAME_CRYPTO
;

1025 
nä
->
Üd”ed_off£t
 = 
ä
->
off£t
 + 
Ëá
;

1026 
nä
->
off£t
 = 
ä
->off£ˆ+ 
Ëá
;

1027 
nä
->
d©aút
 = 0;

1029 
	`ngtı2_vec_¥l™
(
ä
->
d©a
, &ä->
d©aút
, 
nä
->d©a, &nä->d©aút, 
Ëá
,

1030 
NGTCP2_MAX_CRYPTO_DATACNT
);

1032 
rv
 = 
	`ngtı2_pq_push
(&
pkŠs
->
üy±oäq
, &
näc
->
³
);

1033 ià(
rv
 != 0) {

1034 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

1035 
	`ngtı2_üy±o_äame_chaš_d–
(
näc
, 
cÚn
->
mem
);

1036 
	`ngtı2_üy±o_äame_chaš_d–
(
äc
, 
cÚn
->
mem
);

1037  
rv
;

1040 *
päc
 = 
äc
;

1045 ià(
ä
->
d©aút
 =ğ
NGTCP2_MAX_CRYPTO_DATACNT
) {

1046 *
päc
 = 
äc
;

1050 
Ëá
 -ğ
d©®’
;

1052 ; 
Ëá
 && 
ä
->
d©aút
 < 
NGTCP2_MAX_CRYPTO_DATACNT
 &&

1053 !
	`ngtı2_pq_em±y
(&
pkŠs
->
üy±oäq
);) {

1054 
näc
 = 
	`ngtı2_¡ruù_of
(
	`ngtı2_pq_tİ
(&
pkŠs
->
üy±oäq
),

1055 
ngtı2_üy±o_äame_chaš
, 
³
);

1056 
nä
 = &
näc
->
ä
;

1058 ià(
nä
->
off£t
 !ğ
ä
->off£ˆ+ 
d©®’
) {

1059 
	`as£¹
(
ä
->
off£t
 + 
d©®’
 < 
nä
->offset);

1063 
nm”ged
 = 
	`ngtı2_vec_m”ge
(
ä
->
d©a
, &ä->
d©aút
, 
nä
->data, &nfr->datacnt,

1064 
Ëá
, 
NGTCP2_MAX_CRYPTO_DATACNT
);

1065 ià(
nm”ged
 == 0) {

1069 
	`ngtı2_pq_pİ
(&
pkŠs
->
üy±oäq
);

1071 
d©®’
 +ğ
nm”ged
;

1072 
nä
->
Üd”ed_off£t
 +ğ
nm”ged
;

1073 
nä
->
off£t
 +ğ
nm”ged
;

1074 
Ëá
 -ğ
nm”ged
;

1076 ià(
nä
->
d©aút
 == 0) {

1077 
	`ngtı2_üy±o_äame_chaš_d–
(
näc
, 
cÚn
->
mem
);

1081 
rv
 = 
	`ngtı2_pq_push
(&
pkŠs
->
üy±oäq
, &
näc
->
³
);

1082 ià(
rv
 != 0) {

1083 
	`ngtı2_üy±o_äame_chaš_d–
(
näc
, 
cÚn
->
mem
);

1084 
	`ngtı2_üy±o_äame_chaš_d–
(
äc
, 
cÚn
->
mem
);

1085  
rv
;

1089 *
päc
 = 
äc
;

1091 
	}
}

1105 
	$cÚn_v”ify_dcid
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
) {

1106 
ngtı2_k¦_key
 
key
;

1107 
ngtı2_k¦_™
 
™
;

1108 
ngtı2_scid
 *
scid
;

1109 
rv
;

1111 
™
 =

1112 
	`ngtı2_k¦_low”_bound
(&
cÚn
->
scids
, 
	`ngtı2_k¦_key_±r
(&
key
, &
hd
->
dcid
));

1113 ià(
	`ngtı2_k¦_™_’d
(&
™
)) {

1114  
NGTCP2_ERR_INVALID_ARGUMENT
;

1117 
scid
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

1118 ià(!
	`ngtı2_cid_eq
(&
scid
->
cid
, &
hd
->
dcid
)) {

1119  
NGTCP2_ERR_INVALID_ARGUMENT
;

1122 ià(!(
scid
->
æags
 & 
NGTCP2_SCID_FLAG_USED
)) {

1123 
scid
->
æags
 |ğ
NGTCP2_SCID_FLAG_USED
;

1125 ià(
scid
->
³
.
šdex
 =ğ
NGTCP2_PQ_BAD_INDEX
) {

1126 
rv
 = 
	`ngtı2_pq_push
(&
cÚn
->
u£d_scids
, &
scid
->
³
);

1127 ià(
rv
 != 0) {

1128  
rv
;

1134 
	}
}

1142 
	$cÚn_should_·d_pkt
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 
ty³
, 
size_t
 
Ëá
,

1143 
size_t
 
—¾y_d©®’
) {

1144 
size_t
 
mš_·ylßdËn
;

1146 ià(
cÚn
->
£rv”
 || cÚn->
hs_pkŠs
.
tx_ckm
) {

1150 
ty³
) {

1151 
NGTCP2_PKT_INITIAL
:

1152 ià(!
cÚn
->
—¾y_ckm
 || 
—¾y_d©®’
 == 0) {

1155 
mš_·ylßdËn
 = 
	`ngtı2_mš
(
—¾y_d©®’
, 128);

1157  
Ëá
 <

1159 
NGTCP2_MIN_LONG_HEADERLEN
 + 
cÚn
->
dcid
.
cid
.
d©®’
 +

1160 
cÚn
->
oscid
.
d©®’
 + 1 +

1161 
mš_·ylßdËn
 + 
NGTCP2_MAX_AEAD_OVERHEAD
;

1162 
NGTCP2_PKT_0RTT_PROTECTED
:

1163  
cÚn
->
¡©e
 =ğ
NGTCP2_CS_CLIENT_INITIAL
;

1167 
	}
}

1182 
ssize_t
 
	$cÚn_wr™e_hªdshake_pkt
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
,

1183 
size_t
 
de¡Ën
, 
ušt8_t
 
ty³
,

1184 
size_t
 
—¾y_d©®’
,

1185 
ngtı2_t¡amp
 
ts
) {

1186 
rv
;

1187 
ngtı2_µe
 
µe
;

1188 
ngtı2_pkt_hd
 
hd
;

1189 
ngtı2_äame_chaš
 *
äq
 = 
NULL
, **
päc
 = &frq;

1190 
ngtı2_¡»am_äame_chaš
 *
nsäc
;

1191 
ngtı2_üy±o_äame_chaš
 *
ncäc
;

1192 
ngtı2_äame
 *
ackä
 = 
NULL
, 
lä
;

1193 
ngtı2_¡rm
 *
¡rm
;

1194 
ssize_t
 
¥k’
;

1195 
ngtı2_üy±o_ùx
 
ùx
;

1196 
ngtı2_¹b_’Œy
 *
¹b’t
;

1197 
ngtı2_pkŠs
 *
pkŠs
;

1198 
size_t
 
Ëá
;

1199 
ušt8_t
 
æags
 = 
NGTCP2_RTB_FLAG_NONE
;

1200 
pkt_em±y
 = 1;

1201 
·dded
 = 0;

1202 
hd_logged
 = 0;

1204 
ty³
) {

1205 
NGTCP2_PKT_INITIAL
:

1206 ià(!
cÚn
->
š_pkŠs
.
tx_ckm
) {

1209 
pkŠs
 = &
cÚn
->
š_pkŠs
;

1210 
ùx
.
ckm
 = 
pkŠs
->
tx_ckm
;

1211 
ùx
.
hp
 = 
pkŠs
->
tx_hp
;

1212 
ùx
.
«ad_ov”h—d
 = 
NGTCP2_INITIAL_AEAD_OVERHEAD
;

1213 
ùx
.
’üy±
 = 
cÚn
->
ÿÎbacks
.
š_’üy±
;

1214 
ùx
.
hp_mask
 = 
cÚn
->
ÿÎbacks
.
š_hp_mask
;

1216 
NGTCP2_PKT_HANDSHAKE
:

1217 ià(!
cÚn
->
hs_pkŠs
.
tx_ckm
) {

1220 
pkŠs
 = &
cÚn
->
hs_pkŠs
;

1221 
ùx
.
ckm
 = 
pkŠs
->
tx_ckm
;

1222 
ùx
.
hp
 = 
pkŠs
->
tx_hp
;

1223 
ùx
.
«ad_ov”h—d
 = 
cÚn
->aead_overhead;

1224 
ùx
.
’üy±
 = 
cÚn
->
ÿÎbacks
.encrypt;

1225 
ùx
.
hp_mask
 = 
cÚn
->
ÿÎbacks
.hp_mask;

1226 
ùx
.
u£r_d©a
 = 
cÚn
;

1228 
NGTCP2_PKT_0RTT_PROTECTED
:

1229 ià(!
cÚn
->
—¾y_ckm
 || 
	`ngtı2_pq_em±y
(&cÚn->
tx_¡rmq
)) {

1232 
pkŠs
 = &
cÚn
->pktns;

1233 
ùx
.
ckm
 = 
cÚn
->
—¾y_ckm
;

1234 
ùx
.
hp
 = 
cÚn
->
—¾y_hp
;

1235 
ùx
.
«ad_ov”h—d
 = 
cÚn
->aead_overhead;

1236 
ùx
.
’üy±
 = 
cÚn
->
ÿÎbacks
.encrypt;

1237 
ùx
.
hp_mask
 = 
cÚn
->
ÿÎbacks
.hp_mask;

1238 
ùx
.
u£r_d©a
 = 
cÚn
;

1241 
	`as£¹
(0);

1244 
	`ngtı2_pkt_hd_š™
(

1245 &
hd
, 
NGTCP2_PKT_FLAG_LONG_FORM
, 
ty³
, &
cÚn
->
dcid
.
cid
, &cÚn->
oscid
,

1246 
pkŠs
->
Ï¡_tx_pkt_num
 + 1,

1247 
	`¹b_£Ëù_pkt_numËn
(&
pkŠs
->
¹b
,…kŠs->
Ï¡_tx_pkt_num
 + 1),

1248 
cÚn
->
v”siÚ
, 0);

1250 ià(
ty³
 =ğ
NGTCP2_PKT_INITIAL
 && 
	`ngtı2_buf_Ën
(&
cÚn
->
tok’
)) {

1251 
hd
.
tok’
 = 
cÚn
->tok’.
pos
;

1252 
hd
.
tok’Ën
 = 
	`ngtı2_buf_Ën
(&
cÚn
->
tok’
);

1255 
ùx
.
u£r_d©a
 = 
cÚn
;

1257 ià(
	`ngtı2_pq_em±y
(&
pkŠs
->
üy±oäq
è&& 
ty³
 !ğ
NGTCP2_PKT_0RTT_PROTECTED
) {

1261 
	`ngtı2_µe_š™
(&
µe
, 
de¡
, 
de¡Ën
, &
ùx
);

1263 
rv
 = 
	`ngtı2_µe_’code_hd
(&
µe
, &
hd
);

1264 ià(
rv
 != 0) {

1265 
	`as£¹
(
NGTCP2_ERR_NOBUF
 =ğ
rv
);

1269 ià(!
	`ngtı2_µe_’su»_hp_§m¶e
(&
µe
)) {

1274 
	`as£¹
(
pkŠs
->
äq
 =ğ
NULL
);

1276 ià(
ty³
 !ğ
NGTCP2_PKT_0RTT_PROTECTED
) {

1277 ; !
	`ngtı2_pq_em±y
(&
pkŠs
->
üy±oäq
);) {

1278 
Ëá
 = 
	`ngtı2_µe_Ëá
(&
µe
);

1279 
Ëá
 = 
	`ngtı2_pkt_üy±o_max_d©®’
(

1280 
	`cÚn_üy±oäq_tİ
(
cÚn
, 
pkŠs
)->
ä
.
off£t
, 
Ëá
,†eft);

1282 ià(
Ëá
 =ğ(
size_t
)-1) {

1286 
rv
 = 
	`cÚn_üy±oäq_pİ
(
cÚn
, &
ncäc
, 
pkŠs
, 
Ëá
);

1287 ià(
rv
 != 0) {

1288 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

1289  
rv
;

1292 ià(
ncäc
 =ğ
NULL
) {

1296 
rv
 = 
	`cÚn_µe_wr™e_äame_hd_log
(
cÚn
, &
µe
, &
hd_logged
, &
hd
,

1297 &
ncäc
->
äc
.
ä
);

1298 ià(
rv
 != 0) {

1299 
	`as£¹
(0);

1302 *
päc
 = &
ncäc
->
äc
;

1303 
päc
 = &(*päc)->
Ãxt
;

1305 
pkt_em±y
 = 0;

1306 
æags
 |ğ
NGTCP2_RTB_FLAG_ACK_ELICITING
 | 
NGTCP2_RTB_FLAG_CRYPTO_PKT
;

1308 } ià(!
cÚn
->
pkŠs
.
tx_ckm
) {

1309 ; !
	`ngtı2_pq_em±y
(&
cÚn
->
tx_¡rmq
);) {

1310 
¡rm
 = 
	`ngtı2_cÚn_tx_¡rmq_tİ
(
cÚn
);

1311 ià(
	`ngtı2_¡rm_¡»amäq_em±y
(
¡rm
)) {

1312 
	`ngtı2_cÚn_tx_¡rmq_pİ
(
cÚn
);

1316 
Ëá
 = 
	`ngtı2_µe_Ëá
(&
µe
);

1320 
Ëá
 = 
	`ngtı2_pkt_¡»am_max_d©®’
(

1321 
¡rm
->
¡»am_id
, 
	`ngtı2_¡rm_¡»amäq_tİ
(¡rm)->
ä
.
off£t
, 
Ëá
,

1322 
Ëá
);

1324 ià(
Ëá
 =ğ(
size_t
)-1) {

1328 
rv
 = 
	`ngtı2_¡rm_¡»amäq_pİ
(
¡rm
, &
nsäc
, 
Ëá
);

1329 ià(
rv
 != 0) {

1330  
rv
;

1332 ià(
	`ngtı2_¡rm_¡»amäq_em±y
(
¡rm
)) {

1333 
	`ngtı2_cÚn_tx_¡rmq_pİ
(
cÚn
);

1336 ià(
nsäc
 =ğ
NULL
) {

1340 
rv
 = 
	`cÚn_µe_wr™e_äame_hd_log
(
cÚn
, &
µe
, &
hd_logged
, &
hd
,

1341 &
nsäc
->
äc
.
ä
);

1342 ià(
rv
 != 0) {

1343 
	`as£¹
(0);

1346 *
päc
 = &
nsäc
->
äc
;

1347 
päc
 = &(*päc)->
Ãxt
;

1349 
pkt_em±y
 = 0;

1350 
æags
 |ğ
NGTCP2_RTB_FLAG_ACK_ELICITING
;

1356 ià(
pkt_em±y
) {

1360 ià(
ty³
 !ğ
NGTCP2_PKT_0RTT_PROTECTED
) {

1361 
rv
 = 
	`cÚn_ü—‹_ack_äame
(
cÚn
, &
ackä
, &
pkŠs
->
ackŒ
, 
ts
,

1363 
NGTCP2_DEFAULT_ACK_DELAY_EXPONENT
);

1364 ià(
rv
 != 0) {

1365  
rv
;

1368 ià(
ackä
) {

1369 
rv
 = 
	`cÚn_µe_wr™e_äame
(
cÚn
, &
µe
, &
hd
, 
ackä
);

1370 ià(
rv
 != 0) {

1371 
	`as£¹
(
NGTCP2_ERR_NOBUF
 =ğ
rv
);

1373 
	`ngtı2_ackŒ_comm™_ack
(&
pkŠs
->
ackŒ
);

1374 
	`ngtı2_ackŒ_add_ack
(&
pkŠs
->
ackŒ
, 
hd
.
pkt_num
, 
ackä
->
ack
.
Ïrge¡_ack
);

1375 
pkt_em±y
 = 0;

1377 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, 
ackä
);

1378 
ackä
 = 
NULL
;

1384 ià(
	`cÚn_should_·d_pkt
(
cÚn
, 
ty³
, 
	`ngtı2_µe_Ëá
(&
µe
), 
—¾y_d©®’
)) {

1385 
lä
.
ty³
 = 
NGTCP2_FRAME_PADDING
;

1386 
lä
.
·ddšg
.
Ën
 = 
	`ngtı2_µe_·ddšg
(&
µe
);

1387 ià(
lä
.
·ddšg
.
Ën
 > 0) {

1388 
	`ngtı2_log_tx_ä
(&
cÚn
->
log
, &
hd
, &
lä
);

1390 
·dded
 = 1;

1392 
lä
.
ty³
 = 
NGTCP2_FRAME_PADDING
;

1393 
lä
.
·ddšg
.
Ën
 = 
	`ngtı2_µe_·ddšg_hp_§m¶e
(&
µe
);

1394 ià(
lä
.
·ddšg
.
Ën
) {

1395 
	`ngtı2_log_tx_ä
(&
cÚn
->
log
, &
hd
, &
lä
);

1399 
¥k’
 = 
	`ngtı2_µe_fš®
(&
µe
, 
NULL
);

1400 ià(
¥k’
 < 0) {

1401 
	`as£¹
(
	`ngtı2_”r_is_çl
(()
¥k’
));

1402  
¥k’
;

1405 ià(*
päc
 !ğ
äq
 || 
·dded
) {

1406 
rv
 = 
	`ngtı2_¹b_’Œy_Ãw
(&
¹b’t
, &
hd
, 
äq
, 
ts
, (
size_t
)
¥k’
, 
æags
,

1407 
cÚn
->
mem
);

1408 ià(
rv
 != 0) {

1409 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

1410 
	`ngtı2_äame_chaš_li¡_d–
(
äq
, 
cÚn
->
mem
);

1411  
rv
;

1414 
rv
 = 
	`cÚn_Ú_pkt_£Á
(
cÚn
, &
pkŠs
->
¹b
, 
¹b’t
);

1415 ià(
rv
 != 0) {

1416 
	`ngtı2_¹b_’Œy_d–
(
¹b’t
, 
cÚn
->
mem
);

1417  
rv
;

1421 ++
pkŠs
->
Ï¡_tx_pkt_num
;

1423  
¥k’
;

1424 
	}
}

1442 
ssize_t
 
	$cÚn_wr™e_hªdshake_ack_pkt
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
,

1443 
size_t
 
de¡Ën
, 
ušt8_t
 
ty³
,

1444 
»quœe_·ddšg
,

1445 
ngtı2_t¡amp
 
ts
) {

1446 
rv
;

1447 
ngtı2_µe
 
µe
;

1448 
ngtı2_pkt_hd
 
hd
;

1449 
ngtı2_äame
 *
ackä
, 
lä
;

1450 
ngtı2_üy±o_ùx
 
ùx
;

1451 
ngtı2_pkŠs
 *
pkŠs
;

1452 
ngtı2_¹b_’Œy
 *
¹b’t
;

1453 
ssize_t
 
¥k’
;

1454 
fÜû_š™Ÿl
;

1456 
ty³
) {

1457 
NGTCP2_PKT_INITIAL
:

1458 
pkŠs
 = &
cÚn
->
š_pkŠs
;

1459 
ùx
.
«ad_ov”h—d
 = 
NGTCP2_INITIAL_AEAD_OVERHEAD
;

1460 
ùx
.
’üy±
 = 
cÚn
->
ÿÎbacks
.
š_’üy±
;

1461 
ùx
.
hp_mask
 = 
cÚn
->
ÿÎbacks
.
š_hp_mask
;

1463 
NGTCP2_PKT_HANDSHAKE
:

1464 
pkŠs
 = &
cÚn
->
hs_pkŠs
;

1465 
ùx
.
«ad_ov”h—d
 = 
cÚn
->aead_overhead;

1466 
ùx
.
’üy±
 = 
cÚn
->
ÿÎbacks
.encrypt;

1467 
ùx
.
hp_mask
 = 
cÚn
->
ÿÎbacks
.hp_mask;

1470 
	`as£¹
(0);

1473 ià(!
pkŠs
->
tx_ckm
) {

1477 
fÜû_š™Ÿl
 = 
ty³
 =ğ
NGTCP2_PKT_INITIAL
 && 
»quœe_·ddšg
 &&

1478 (
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_FORCE_SEND_INITIAL
);

1480 
ackä
 = 
NULL
;

1481 
rv
 = 
	`cÚn_ü—‹_ack_äame
(
cÚn
, &
ackä
, &
pkŠs
->
ackŒ
, 
ts
,

1482 
NGTCP2_HS_ACK_DELAY
,

1483 
NGTCP2_DEFAULT_ACK_DELAY_EXPONENT
);

1484 ià(
rv
 != 0) {

1485  
rv
;

1487 ià(!
ackä
 && !
fÜû_š™Ÿl
) {

1491 
	`ngtı2_pkt_hd_š™
(

1492 &
hd
, 
NGTCP2_PKT_FLAG_LONG_FORM
, 
ty³
, &
cÚn
->
dcid
.
cid
, &cÚn->
oscid
,

1493 
pkŠs
->
Ï¡_tx_pkt_num
 + 1,

1494 
	`¹b_£Ëù_pkt_numËn
(&
pkŠs
->
¹b
,…kŠs->
Ï¡_tx_pkt_num
 + 1),

1495 
cÚn
->
v”siÚ
, 0);

1497 
ùx
.
ckm
 = 
pkŠs
->
tx_ckm
;

1498 
ùx
.
hp
 = 
pkŠs
->
tx_hp
;

1499 
ùx
.
u£r_d©a
 = 
cÚn
;

1501 
	`ngtı2_µe_š™
(&
µe
, 
de¡
, 
de¡Ën
, &
ùx
);

1503 
rv
 = 
	`ngtı2_µe_’code_hd
(&
µe
, &
hd
);

1504 ià(
rv
 != 0) {

1505 
	`as£¹
(
NGTCP2_ERR_NOBUF
 =ğ
rv
);

1506 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, 
ackä
);

1510 ià(!
	`ngtı2_µe_’su»_hp_§m¶e
(&
µe
)) {

1511 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, 
ackä
);

1515 
	`ngtı2_log_tx_pkt_hd
(&
cÚn
->
log
, &
hd
);

1517 ià(
ackä
) {

1518 
rv
 = 
	`cÚn_µe_wr™e_äame
(
cÚn
, &
µe
, &
hd
, 
ackä
);

1519 ià(
rv
 != 0) {

1520 
	`as£¹
(
NGTCP2_ERR_NOBUF
 =ğ
rv
);

1522 
	`ngtı2_ackŒ_comm™_ack
(&
pkŠs
->
ackŒ
);

1523 
	`ngtı2_ackŒ_add_ack
(&
pkŠs
->
ackŒ
, 
hd
.
pkt_num
, 
ackä
->
ack
.
Ïrge¡_ack
);

1525 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, 
ackä
);

1526 
ackä
 = 
NULL
;

1529 ià(
»quœe_·ddšg
) {

1530 
lä
.
ty³
 = 
NGTCP2_FRAME_PADDING
;

1531 
lä
.
·ddšg
.
Ën
 = 
	`ngtı2_µe_·ddšg
(&
µe
);

1532 ià(
lä
.
·ddšg
.
Ën
 > 0) {

1533 
	`ngtı2_log_tx_ä
(&
cÚn
->
log
, &
hd
, &
lä
);

1536 
¥k’
 = 
	`ngtı2_µe_fš®
(&
µe
, 
NULL
);

1537 ià(
¥k’
 < 0) {

1538  
¥k’
;

1541 
rv
 = 
	`ngtı2_¹b_’Œy_Ãw
(&
¹b’t
, &
hd
, 
NULL
, 
ts
, (
size_t
)
¥k’
,

1542 
NGTCP2_RTB_FLAG_NONE
, 
cÚn
->
mem
);

1543 ià(
rv
 != 0) {

1544 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

1545  
rv
;

1548 
rv
 = 
	`cÚn_Ú_pkt_£Á
(
cÚn
, &
pkŠs
->
¹b
, 
¹b’t
);

1549 ià(
rv
 != 0) {

1550 
	`ngtı2_¹b_’Œy_d–
(
¹b’t
, 
cÚn
->
mem
);

1551  
rv
;

1554 
	`as£¹
(
ty³
 =ğ
NGTCP2_PKT_INITIAL
);

1555 
cÚn
->
æags
 &ğ(
ušt16_t
)~
NGTCP2_CONN_FLAG_FORCE_SEND_INITIAL
;

1557 
lä
.
ty³
 = 
NGTCP2_FRAME_PADDING
;

1558 
lä
.
·ddšg
.
Ën
 = 
	`ngtı2_µe_·ddšg_hp_§m¶e
(&
µe
);

1559 ià(
lä
.
·ddšg
.
Ën
) {

1560 
	`ngtı2_log_tx_ä
(&
cÚn
->
log
, &
hd
, &
lä
);

1563 
¥k’
 = 
	`ngtı2_µe_fš®
(&
µe
, 
NULL
);

1564 ià(
¥k’
 < 0) {

1565  
¥k’
;

1569 ++
pkŠs
->
Ï¡_tx_pkt_num
;

1571  
¥k’
;

1572 
	}
}

1579 
ssize_t
 
	$cÚn_wr™e_hªdshake_ack_pkts
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
,

1580 
size_t
 
de¡Ën
, 
ngtı2_t¡amp
 
ts
) {

1581 
ssize_t
 
»s
 = 0, 
nwr™e
;

1582 
»quœe_·ddšg
 = !
cÚn
->
hs_pkŠs
.
tx_ckm
;

1584 ià(
»quœe_·ddšg
) {

1587 
de¡Ën
 = 
	`ngtı2_mš
(de¡Ën, 
	`cÚn_cwnd_Ëá
(
cÚn
));

1590 
nwr™e
 = 
	`cÚn_wr™e_hªdshake_ack_pkt
(
cÚn
, 
de¡
, 
de¡Ën
, 
NGTCP2_PKT_INITIAL
,

1591 
»quœe_·ddšg
, 
ts
);

1592 ià(
nwr™e
 < 0) {

1593 
	`as£¹
(
nwr™e
 !ğ
NGTCP2_ERR_NOBUF
);

1594  
nwr™e
;

1597 
»s
 +ğ
nwr™e
;

1598 
de¡
 +ğ
nwr™e
;

1599 
de¡Ën
 -ğ(
size_t
)
nwr™e
;

1601 
nwr™e
 = 
	`cÚn_wr™e_hªdshake_ack_pkt
(

1602 
cÚn
, 
de¡
, 
de¡Ën
, 
NGTCP2_PKT_HANDSHAKE
, 0 , 
ts
);

1603 ià(
nwr™e
 < 0) {

1604 
	`as£¹
(
nwr™e
 !ğ
NGTCP2_ERR_NOBUF
);

1605  
nwr™e
;

1608  
»s
 + 
nwr™e
;

1609 
	}
}

1615 
ssize_t
 
	$cÚn_»Œªsm™_»Œy_—¾y
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
,

1616 
size_t
 
de¡Ën
, 
ngtı2_t¡amp
 
ts
) {

1617  
	`cÚn_wr™e_hªdshake_pkt
(
cÚn
, 
de¡
, 
de¡Ën
,

1618 
NGTCP2_PKT_0RTT_PROTECTED
, 0, 
ts
);

1619 
	}
}

1633 
ssize_t
 
	$cÚn_wr™e_ş›Á_š™Ÿl
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
,

1634 
size_t
 
de¡Ën
, size_ˆ
—¾y_d©®’
,

1635 
ngtı2_t¡amp
 
ts
) {

1636 
rv
;

1638 
rv
 = 
cÚn
->
ÿÎbacks
.
	`ş›Á_š™Ÿl
(cÚn, cÚn->
u£r_d©a
);

1639 ià(
rv
 != 0) {

1640  
NGTCP2_ERR_CALLBACK_FAILURE
;

1643  
	`cÚn_wr™e_hªdshake_pkt
(
cÚn
, 
de¡
, 
de¡Ën
, 
NGTCP2_PKT_INITIAL
,

1644 
—¾y_d©®’
, 
ts
);

1645 
	}
}

1659 
ssize_t
 
	$cÚn_wr™e_hªdshake_pkts
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
,

1660 
size_t
 
de¡Ën
, size_ˆ
—¾y_d©®’
,

1661 
ngtı2_t¡amp
 
ts
) {

1662 
ssize_t
 
nwr™e
;

1663 
ssize_t
 
»s
 = 0;

1665 
nwr™e
 = 
	`cÚn_wr™e_hªdshake_pkt
(
cÚn
, 
de¡
, 
de¡Ën
, 
NGTCP2_PKT_INITIAL
,

1666 
—¾y_d©®’
, 
ts
);

1667 ià(
nwr™e
 < 0) {

1668 
	`as£¹
(
nwr™e
 !ğ
NGTCP2_ERR_NOBUF
);

1669  
nwr™e
;

1672 
»s
 +ğ
nwr™e
;

1673 
de¡
 +ğ
nwr™e
;

1674 
de¡Ën
 -ğ(
size_t
)
nwr™e
;

1676 
nwr™e
 = 
	`cÚn_wr™e_hªdshake_pkt
(
cÚn
, 
de¡
, 
de¡Ën
, 
NGTCP2_PKT_HANDSHAKE
,

1677 0, 
ts
);

1678 ià(
nwr™e
 < 0) {

1679 
	`as£¹
(
nwr™e
 !ğ
NGTCP2_ERR_NOBUF
);

1680  
nwr™e
;

1683 
»s
 +ğ
nwr™e
;

1684 
de¡
 +ğ
nwr™e
;

1685 
de¡Ën
 -ğ(
size_t
)
nwr™e
;

1687  
»s
;

1688 
	}
}

1690 
ssize_t
 
cÚn_wr™e_´Ùeùed_ack_pkt
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
,

1691 
size_t
 
de¡Ën
, 
ngtı2_t¡amp
 
ts
);

1693 
ssize_t
 
	$cÚn_wr™e_£rv”_hªdshake
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
,

1694 
size_t
 
de¡Ën
, 
ngtı2_t¡amp
 
ts
) {

1695 
ssize_t
 
nwr™e
;

1696 
ssize_t
 
»s
 = 0;

1698 
nwr™e
 = 
	`cÚn_wr™e_hªdshake_pkts
(
cÚn
, 
de¡
, 
de¡Ën
, 0, 
ts
);

1699 ià(
nwr™e
 < 0) {

1700 
	`as£¹
(
nwr™e
 !ğ
NGTCP2_ERR_NOBUF
);

1701  
nwr™e
;

1704 
»s
 +ğ
nwr™e
;

1705 
de¡
 +ğ
nwr™e
;

1706 
de¡Ën
 -ğ(
size_t
)
nwr™e
;

1709 ià(
cÚn
->
pkŠs
.
tx_ckm
) {

1710 
nwr™e
 = 
	`cÚn_wr™e_´Ùeùed_ack_pkt
(
cÚn
, 
de¡
, 
de¡Ën
, 
ts
);

1711 ià(
nwr™e
 < 0) {

1712 
	`as£¹
(
nwr™e
 !ğ
NGTCP2_ERR_NOBUF
);

1713  
nwr™e
;

1716 
»s
 +ğ
nwr™e
;

1717 
de¡
 +ğ
nwr™e
;

1718 
de¡Ën
 -ğ(
size_t
)
nwr™e
;

1721  
»s
;

1722 
	}
}

1728 
ušt64_t
 
	$cÚn_š™Ÿl_¡»am_rx_off£t
(
ngtı2_cÚn
 *
cÚn
,

1729 
ušt64_t
 
¡»am_id
) {

1730 
loÿl_¡»am
 = 
	`cÚn_loÿl_¡»am
(
cÚn
, 
¡»am_id
);

1732 ià(
	`bidi_¡»am
(
¡»am_id
)) {

1733 ià(
loÿl_¡»am
) {

1734  
cÚn
->
loÿl_£‰šgs
.
max_¡»am_d©a_bidi_loÿl
;

1736  
cÚn
->
loÿl_£‰šgs
.
max_¡»am_d©a_bidi_»mÙe
;

1739 ià(
loÿl_¡»am
) {

1742  
cÚn
->
loÿl_£‰šgs
.
max_¡»am_d©a_uni
;

1743 
	}
}

1749 
	$cÚn_should_£nd_max_¡»am_d©a
(
ngtı2_cÚn
 *
cÚn
,

1750 
ngtı2_¡rm
 *
¡rm
) {

1752  
	`cÚn_š™Ÿl_¡»am_rx_off£t
(
cÚn
, 
¡rm
->
¡»am_id
) / 2 <

1753 (
¡rm
->
un£Á_max_rx_off£t
 - sŒm->
max_rx_off£t
) ||

1754 2 * 
cÚn
->
rx_bw
 * cÚn->
rcs
.
smoÙhed_¹t
 >=

1755 
¡rm
->
max_rx_off£t
 - sŒm->
Ï¡_rx_off£t
;

1756 
	}
}

1762 
	$cÚn_should_£nd_max_d©a
(
ngtı2_cÚn
 *
cÚn
) {

1763  
cÚn
->
loÿl_£‰šgs
.
max_d©a
 / 2 <

1764 
cÚn
->
un£Á_max_rx_off£t
 - cÚn->
max_rx_off£t
 ||

1765 2 * 
cÚn
->
rx_bw
 * cÚn->
rcs
.
smoÙhed_¹t
 >=

1766 
cÚn
->
max_rx_off£t
 - cÚn->
rx_off£t
;

1767 
	}
}

1774 
size_t
 
	$cÚn_»quœed_num_Ãw_cÚÃùiÚ_id
(
ngtı2_cÚn
 *
cÚn
) {

1775 
size_t
 
n
 = 
	`ngtı2_k¦_Ën
(&
cÚn
->
scids
è- 
	`ngtı2_pq_size
(&cÚn->
u£d_scids
);

1777  
n
 < 
NGTCP2_MIN_SCID_POOL_SIZE
 ? NGTCP2_MIN_SCID_POOL_SIZE -‚ : 0;

1778 
	}
}

1792 
	$cÚn_’queue_Ãw_cÚÃùiÚ_id
(
ngtı2_cÚn
 *
cÚn
) {

1793 
size_t
 
i
, 
Ãed
 = 
	`cÚn_»quœed_num_Ãw_cÚÃùiÚ_id
(
cÚn
);

1794 
size_t
 
cidËn
 = 
cÚn
->
oscid
.
d©®’
;

1795 
ngtı2_cid
 
cid
;

1796 
ušt64_t
 
£q
;

1797 
rv
;

1798 
ušt8_t
 
tok’
[
NGTCP2_STATELESS_RESET_TOKENLEN
];

1799 
ngtı2_äame_chaš
 *
näc
;

1800 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->pktns;

1801 
ngtı2_scid
 *
scid
;

1802 
ngtı2_k¦_key
 
key
;

1803 
ngtı2_k¦_™
 
™
;

1805 
i
 = 0; i < 
Ãed
; ++i) {

1806 
rv
 = 
	`cÚn_ÿÎ_g‘_Ãw_cÚÃùiÚ_id
(
cÚn
, &
cid
, 
tok’
, 
cidËn
);

1807 ià(
rv
 != 0) {

1808  
rv
;

1811 ià(
cid
.
d©®’
 !ğ
cidËn
 || 
	`ngtı2_cid_eq
(&
šf_cid
, &cid)) {

1812  
NGTCP2_ERR_CALLBACK_FAILURE
;

1816 
™
 = 
	`ngtı2_k¦_low”_bound
(&
cÚn
->
scids
, 
	`ngtı2_k¦_key_±r
(&
key
, &
cid
));

1817 ià(!
	`ngtı2_k¦_™_’d
(&
™
) &&

1818 
	`ngtı2_cid_eq
(
	`ngtı2_k¦_™_key
(&
™
).
±r
, &
cid
)) {

1819  
NGTCP2_ERR_CALLBACK_FAILURE
;

1822 
£q
 = ++
cÚn
->
tx_Ï¡_cid_£q
;

1824 
scid
 = 
	`ngtı2_mem_m®loc
(
cÚn
->
mem
, (*scid));

1825 ià(
scid
 =ğ
NULL
) {

1826  
NGTCP2_ERR_NOMEM
;

1829 
	`ngtı2_scid_š™
(
scid
, 
£q
, &
cid
, 
tok’
);

1831 
rv
 = 
	`ngtı2_k¦_š£¹
(&
cÚn
->
scids
, 
NULL
,

1832 
	`ngtı2_k¦_key_±r
(&
key
, &
scid
->
cid
), scid);

1833 ià(
rv
 != 0) {

1834 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, 
scid
);

1835  
rv
;

1838 
rv
 = 
	`ngtı2_äame_chaš_Ãw
(&
näc
, 
cÚn
->
mem
);

1839 ià(
rv
 != 0) {

1840  
rv
;

1843 
näc
->
ä
.
ty³
 = 
NGTCP2_FRAME_NEW_CONNECTION_ID
;

1844 
näc
->
ä
.
Ãw_cÚÃùiÚ_id
.
£q
 = seq;

1845 
näc
->
ä
.
Ãw_cÚÃùiÚ_id
.
cid
 = cid;

1846 
	`memıy
(
näc
->
ä
.
Ãw_cÚÃùiÚ_id
.
¡©–ess_»£t_tok’
, 
tok’
,

1847 (
tok’
));

1848 
näc
->
Ãxt
 = 
pkŠs
->
äq
;

1849 
pkŠs
->
äq
 = 
näc
;

1853 
	}
}

1869 
	$cÚn_»move_»tœed_cÚÃùiÚ_id
(
ngtı2_cÚn
 *
cÚn
,

1870 
ngtı2_t¡amp
 
ts
) {

1871 
ngtı2_du¿tiÚ
 
d
;

1872 
ngtı2_scid
 *
scid
;

1873 
ngtı2_k¦_key
 
key
;

1874 
rv
;

1876 ià(
cÚn
->
rcs
.
smoÙhed_¹t
 < 1e-9) {

1877 
d
 = 
NGTCP2_DEFAULT_INITIAL_RTT
 * 2;

1879 
d
 = (
ngtı2_du¿tiÚ
)(
cÚn
->
rcs
.
smoÙhed_¹t
 * 2);

1882 ; !
	`ngtı2_pq_em±y
(&
cÚn
->
u£d_scids
);) {

1883 
scid
 = 
	`ngtı2_¡ruù_of
(
	`ngtı2_pq_tİ
(&
cÚn
->
u£d_scids
), 
ngtı2_scid
, 
³
);

1885 ià(
scid
->
ts_»tœed
 =ğ
UINT64_MAX
 || 
d
 >ğ
ts
 - scid->ts_retired) {

1889 
	`as£¹
(
scid
->
æags
 & 
NGTCP2_SCID_FLAG_RETIRED
);

1891 
rv
 = 
	`cÚn_ÿÎ_»move_cÚÃùiÚ_id
(
cÚn
, &
scid
->
cid
);

1892 ià(
rv
 != 0) {

1893  
rv
;

1896 
rv
 = 
	`ngtı2_k¦_»move
(&
cÚn
->
scids
, 
NULL
,

1897 
	`ngtı2_k¦_key_±r
(&
key
, &
scid
->
cid
));

1898 ià(
rv
 != 0) {

1899  
rv
;

1901 
	`ngtı2_pq_pİ
(&
cÚn
->
u£d_scids
);

1902 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, 
scid
);

1906 
	}
}

1931 
ssize_t
 
	$cÚn_wr™e_pkt
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

1932 
ssize_t
 *
pd©®’
, 
ngtı2_¡rm
 *
d©a_¡rm
,

1933 
ušt8_t
 
fš
, cÚ¡ 
ngtı2_vec
 *
d©av
,

1934 
size_t
 
d©avút
, 
ngtı2_t¡amp
 
ts
) {

1935 
rv
;

1936 
ngtı2_µe
 
µe
;

1937 
ngtı2_pkt_hd
 
hd
;

1938 
ngtı2_äame
 *
ackä
 = 
NULL
, 
lä
;

1939 
ssize_t
 
nwr™e
;

1940 
ngtı2_üy±o_ùx
 
ùx
;

1941 
ngtı2_äame_chaš
 **
päc
, *
näc
, *
äc
;

1942 
ngtı2_¡»am_äame_chaš
 *
nsäc
;

1943 
ngtı2_üy±o_äame_chaš
 *
ncäc
;

1944 
ngtı2_¹b_’Œy
 *
’t
;

1945 
ngtı2_¡rm
 *
¡rm
;

1946 
pkt_em±y
 = 1;

1947 
size_t
 
nd©®’
 = 0;

1948 
£nd_¡»am
 = 0;

1949 
¡»am_blocked
 = 0;

1950 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->pktns;

1951 
size_t
 
Ëá
;

1952 
ušt64_t
 
wr™‹n_¡»am_id
 = 
UINT64_MAX
;

1953 
size_t
 
d©®’
 = 
	`ngtı2_vec_Ën
(
d©av
, 
d©avút
);

1954 
ušt8_t
 
¹b_’Œy_æags
 = 
NGTCP2_RTB_FLAG_NONE
;

1955 
hd_logged
 = 0;

1956 
ngtı2_·th_ch®Ënge_’Œy
 *
pûÁ
;

1958 ià(
d©a_¡rm
) {

1959 
nd©®’
 = 
	`cÚn_’fÜû_æow_cÚŒŞ
(
cÚn
, 
d©a_¡rm
, 
d©®’
);

1961 ià(
nd©®’
 || 
d©®’
 == 0) {

1962 
£nd_¡»am
 = 1;

1964 
¡»am_blocked
 = 1;

1968 ià(
cÚn
->
oscid
.
d©®’
) {

1969 
rv
 = 
	`cÚn_’queue_Ãw_cÚÃùiÚ_id
(
cÚn
);

1970 ià(
rv
 != 0) {

1971  
rv
;

1976 ià((
pkŠs
->
äq
 || 
£nd_¡»am
 ||

1977 
	`ngtı2_ršgbuf_Ën
(&
cÚn
->
rx_·th_ch®Ënge
) ||

1978 
	`cÚn_should_£nd_max_d©a
(
cÚn
)) &&

1979 
cÚn
->
un£Á_max_rx_off£t
 > cÚn->
max_rx_off£t
) {

1980 
rv
 = 
	`ngtı2_äame_chaš_Ãw
(&
näc
, 
cÚn
->
mem
);

1981 ià(
rv
 != 0) {

1982  
rv
;

1984 
näc
->
ä
.
ty³
 = 
NGTCP2_FRAME_MAX_DATA
;

1985 
näc
->
ä
.
max_d©a
.max_d©¨ğ
cÚn
->
un£Á_max_rx_off£t
;

1986 
näc
->
Ãxt
 = 
pkŠs
->
äq
;

1987 
pkŠs
->
äq
 = 
näc
;

1989 
cÚn
->
max_rx_off£t
 = cÚn->
un£Á_max_rx_off£t
;

1992 
	`ngtı2_pkt_hd_š™
(

1993 &
hd
,

1994 (
pkŠs
->
tx_ckm
->
æags
 & 
NGTCP2_CRYPTO_KM_FLAG_KEY_PHASE_ONE
)

1995 ? 
NGTCP2_PKT_FLAG_KEY_PHASE


1996 : 
NGTCP2_PKT_FLAG_NONE
,

1997 
NGTCP2_PKT_SHORT
, &
cÚn
->
dcid
.
cid
, 
NULL
, 
pkŠs
->
Ï¡_tx_pkt_num
 + 1,

1998 
	`¹b_£Ëù_pkt_numËn
(&
pkŠs
->
¹b
,…kŠs->
Ï¡_tx_pkt_num
 + 1),

1999 
cÚn
->
v”siÚ
, 0);

2001 
ùx
.
ckm
 = 
pkŠs
->
tx_ckm
;

2002 
ùx
.
hp
 = 
pkŠs
->
tx_hp
;

2003 
ùx
.
«ad_ov”h—d
 = 
cÚn
->aead_overhead;

2004 
ùx
.
’üy±
 = 
cÚn
->
ÿÎbacks
.encrypt;

2005 
ùx
.
hp_mask
 = 
cÚn
->
ÿÎbacks
.hp_mask;

2006 
ùx
.
u£r_d©a
 = 
cÚn
;

2008 
	`ngtı2_µe_š™
(&
µe
, 
de¡
, 
de¡Ën
, &
ùx
);

2010 
rv
 = 
	`ngtı2_µe_’code_hd
(&
µe
, &
hd
);

2011 ià(
rv
 != 0) {

2012 
	`as£¹
(
NGTCP2_ERR_NOBUF
 =ğ
rv
);

2016 ià(!
	`ngtı2_µe_’su»_hp_§m¶e
(&
µe
)) {

2020 ; 
	`ngtı2_ršgbuf_Ën
(&
cÚn
->
rx_·th_ch®Ënge
);) {

2021 
pûÁ
 = 
	`ngtı2_ršgbuf_g‘
(&
cÚn
->
rx_·th_ch®Ënge
, 0);

2025 ià(!
	`ngtı2_·th_eq
(&
cÚn
->
dcid
.
·th
, &
pûÁ
->path)) {

2029 
lä
.
ty³
 = 
NGTCP2_FRAME_PATH_RESPONSE
;

2030 
	`memıy
(
lä
.
·th_»¥Ú£
.
d©a
, 
pûÁ
->data, (lfr.path_response.data));

2032 
rv
 = 
	`cÚn_µe_wr™e_äame_hd_log
(
cÚn
, &
µe
, &
hd_logged
, &
hd
, &
lä
);

2033 ià(
rv
 != 0) {

2034 
	`as£¹
(
NGTCP2_ERR_NOBUF
 =ğ
rv
);

2038 
	`ngtı2_ršgbuf_pİ_äÚt
(&
cÚn
->
rx_·th_ch®Ënge
);

2040 
pkt_em±y
 = 0;

2041 
¹b_’Œy_æags
 |ğ
NGTCP2_RTB_FLAG_ACK_ELICITING
;

2045 
päc
 = &
pkŠs
->
äq
; *pfrc;) {

2046 (*
päc
)->
ä
.
ty³
) {

2047 
NGTCP2_FRAME_STOP_SENDING
:

2048 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, (*
päc
)->
ä
.
¡İ_£ndšg
.
¡»am_id
);

2049 ià(
¡rm
 =ğ
NULL
 || (¡rm->
æags
 & 
NGTCP2_STRM_FLAG_SHUT_RD
)) {

2050 
äc
 = *
päc
;

2051 *
päc
 = (*päc)->
Ãxt
;

2052 
	`ngtı2_äame_chaš_d–
(
äc
, 
cÚn
->
mem
);

2056 
NGTCP2_FRAME_STREAM
:

2057 
	`as£¹
(0);

2059 
NGTCP2_FRAME_MAX_STREAMS_BIDI
:

2060 ià((*
päc
)->
ä
.
max_¡»ams
.max_streams <

2061 (
cÚn
->
max_»mÙe_¡»am_id_bidi
 >> 2)) {

2062 
äc
 = *
päc
;

2063 *
päc
 = (*päc)->
Ãxt
;

2064 
	`ngtı2_äame_chaš_d–
(
äc
, 
cÚn
->
mem
);

2068 
NGTCP2_FRAME_MAX_STREAMS_UNI
:

2069 ià((*
päc
)->
ä
.
max_¡»ams
.max_streams <

2070 (
cÚn
->
max_»mÙe_¡»am_id_uni
 >> 2)) {

2071 
äc
 = *
päc
;

2072 *
päc
 = (*päc)->
Ãxt
;

2073 
	`ngtı2_äame_chaš_d–
(
äc
, 
cÚn
->
mem
);

2077 
NGTCP2_FRAME_MAX_STREAM_DATA
:

2078 
¡rm
 =

2079 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, (*
päc
)->
ä
.
max_¡»am_d©a
.
¡»am_id
);

2080 ià(
¡rm
 =ğ
NULL
 || (¡rm->
æags
 & 
NGTCP2_STRM_FLAG_SHUT_RD
) ||

2081 (*
päc
)->
ä
.
max_¡»am_d©a
.max_¡»am_d©¨< 
¡rm
->
max_rx_off£t
) {

2082 
äc
 = *
päc
;

2083 *
päc
 = (*päc)->
Ãxt
;

2084 
	`ngtı2_äame_chaš_d–
(
äc
, 
cÚn
->
mem
);

2088 
NGTCP2_FRAME_MAX_DATA
:

2089 ià((*
päc
)->
ä
.
max_d©a
.max_d©¨< 
cÚn
->
max_rx_off£t
) {

2090 
äc
 = *
päc
;

2091 *
päc
 = (*päc)->
Ãxt
;

2092 
	`ngtı2_äame_chaš_d–
(
äc
, 
cÚn
->
mem
);

2096 
NGTCP2_FRAME_CRYPTO
:

2097 
	`as£¹
(0);

2101 
rv
 = 
	`cÚn_µe_wr™e_äame_hd_log
(
cÚn
, &
µe
, &
hd_logged
, &
hd
, &(*
päc
)->
ä
);

2102 ià(
rv
 != 0) {

2103 
	`as£¹
(
NGTCP2_ERR_NOBUF
 =ğ
rv
);

2107 
pkt_em±y
 = 0;

2108 
¹b_’Œy_æags
 |ğ
NGTCP2_RTB_FLAG_ACK_ELICITING
;

2109 
päc
 = &(*päc)->
Ãxt
;

2112 ià(
rv
 !ğ
NGTCP2_ERR_NOBUF
) {

2113 ; !
	`ngtı2_pq_em±y
(&
pkŠs
->
üy±oäq
);) {

2114 
Ëá
 = 
	`ngtı2_µe_Ëá
(&
µe
);

2116 
Ëá
 = 
	`ngtı2_pkt_üy±o_max_d©®’
(

2117 
	`cÚn_üy±oäq_tİ
(
cÚn
, 
pkŠs
)->
ä
.
off£t
, 
Ëá
,†eft);

2119 ià(
Ëá
 =ğ(
size_t
)-1) {

2123 
rv
 = 
	`cÚn_üy±oäq_pİ
(
cÚn
, &
ncäc
, 
pkŠs
, 
Ëá
);

2124 ià(
rv
 != 0) {

2125 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

2126  
rv
;

2129 ià(
ncäc
 =ğ
NULL
) {

2133 
rv
 = 
	`cÚn_µe_wr™e_äame_hd_log
(
cÚn
, &
µe
, &
hd_logged
, &
hd
,

2134 &
ncäc
->
äc
.
ä
);

2135 ià(
rv
 != 0) {

2136 
	`as£¹
(0);

2139 *
päc
 = &
ncäc
->
äc
;

2140 
päc
 = &(*päc)->
Ãxt
;

2142 
pkt_em±y
 = 0;

2143 
¹b_’Œy_æags
 |ğ
NGTCP2_RTB_FLAG_ACK_ELICITING
;

2149 ià(
rv
 !ğ
NGTCP2_ERR_NOBUF
 && *
päc
 =ğ
NULL
 &&

2150 
cÚn
->
un£Á_max_»mÙe_¡»am_id_bidi
 >

2151 
cÚn
->
max_»mÙe_¡»am_id_bidi
) {

2152 
rv
 = 
	`ngtı2_äame_chaš_Ãw
(&
näc
, 
cÚn
->
mem
);

2153 ià(
rv
 != 0) {

2154 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

2155  
rv
;

2157 
näc
->
ä
.
ty³
 = 
NGTCP2_FRAME_MAX_STREAMS_BIDI
;

2158 
näc
->
ä
.
max_¡»ams
.max_streams =

2159 
cÚn
->
un£Á_max_»mÙe_¡»am_id_bidi
 >> 2;

2160 *
päc
 = 
näc
;

2162 
cÚn
->
max_»mÙe_¡»am_id_bidi
 = cÚn->
un£Á_max_»mÙe_¡»am_id_bidi
;

2164 
rv
 = 
	`cÚn_µe_wr™e_äame_hd_log
(
cÚn
, &
µe
, &
hd_logged
, &
hd
, &(*
päc
)->
ä
);

2165 ià(
rv
 != 0) {

2166 
	`as£¹
(
NGTCP2_ERR_NOBUF
 =ğ
rv
);

2168 
pkt_em±y
 = 0;

2169 
¹b_’Œy_æags
 |ğ
NGTCP2_RTB_FLAG_ACK_ELICITING
;

2170 
päc
 = &(*päc)->
Ãxt
;

2174 ià(
rv
 !ğ
NGTCP2_ERR_NOBUF
 && *
päc
 =ğ
NULL
) {

2175 ià(
cÚn
->
un£Á_max_»mÙe_¡»am_id_uni
 >

2176 
cÚn
->
max_»mÙe_¡»am_id_uni
) {

2177 
rv
 = 
	`ngtı2_äame_chaš_Ãw
(&
näc
, 
cÚn
->
mem
);

2178 ià(
rv
 != 0) {

2179 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

2180  
rv
;

2182 
näc
->
ä
.
ty³
 = 
NGTCP2_FRAME_MAX_STREAMS_UNI
;

2183 
näc
->
ä
.
max_¡»ams
.max_streams =

2184 
cÚn
->
un£Á_max_»mÙe_¡»am_id_uni
 >> 2;

2185 *
päc
 = 
näc
;

2187 
cÚn
->
max_»mÙe_¡»am_id_uni
 = cÚn->
un£Á_max_»mÙe_¡»am_id_uni
;

2189 
rv
 = 
	`cÚn_µe_wr™e_äame_hd_log
(
cÚn
, &
µe
, &
hd_logged
, &
hd
,

2190 &(*
päc
)->
ä
);

2191 ià(
rv
 != 0) {

2192 
	`as£¹
(
NGTCP2_ERR_NOBUF
 =ğ
rv
);

2194 
pkt_em±y
 = 0;

2195 
¹b_’Œy_æags
 |ğ
NGTCP2_RTB_FLAG_ACK_ELICITING
;

2196 
päc
 = &(*päc)->
Ãxt
;

2201 ià(
rv
 !ğ
NGTCP2_ERR_NOBUF
) {

2202 ; !
	`ngtı2_pq_em±y
(&
cÚn
->
tx_¡rmq
);) {

2203 
¡rm
 = 
	`ngtı2_cÚn_tx_¡rmq_tİ
(
cÚn
);

2205 ià(!(
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_SHUT_RD
) &&

2206 
¡rm
->
max_rx_off£t
 < sŒm->
un£Á_max_rx_off£t
) {

2207 
rv
 = 
	`ngtı2_äame_chaš_Ãw
(&
näc
, 
cÚn
->
mem
);

2208 ià(
rv
 != 0) {

2209 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

2210  
rv
;

2212 
näc
->
ä
.
ty³
 = 
NGTCP2_FRAME_MAX_STREAM_DATA
;

2213 
näc
->
ä
.
max_¡»am_d©a
.
¡»am_id
 = 
¡rm
->stream_id;

2214 
näc
->
ä
.
max_¡»am_d©a
.max_¡»am_d©¨ğ
¡rm
->
un£Á_max_rx_off£t
;

2215 
	`ngtı2_li¡_š£¹
(
näc
, 
päc
);

2217 
rv
 =

2218 
	`cÚn_µe_wr™e_äame_hd_log
(
cÚn
, &
µe
, &
hd_logged
, &
hd
, &
näc
->
ä
);

2219 ià(
rv
 != 0) {

2220 
	`as£¹
(
NGTCP2_ERR_NOBUF
 =ğ
rv
);

2221 
tx_¡rmq_fšish
;

2224 
pkt_em±y
 = 0;

2225 
¹b_’Œy_æags
 |ğ
NGTCP2_RTB_FLAG_ACK_ELICITING
;

2226 
päc
 = &(*päc)->
Ãxt
;

2227 
¡rm
->
max_rx_off£t
 = sŒm->
un£Á_max_rx_off£t
;

2231 ià(
	`ngtı2_¡rm_¡»amäq_em±y
(
¡rm
)) {

2232 
	`ngtı2_cÚn_tx_¡rmq_pİ
(
cÚn
);

2233 ià(
wr™‹n_¡»am_id
 =ğ
UINT64_MAX
) {

2236 
tx_¡rmq_fšish
;

2239 
Ëá
 = 
	`ngtı2_µe_Ëá
(&
µe
);

2241 
Ëá
 = 
	`ngtı2_pkt_¡»am_max_d©®’
(

2242 
¡rm
->
¡»am_id
, 
	`ngtı2_¡rm_¡»amäq_tİ
(¡rm)->
ä
.
off£t
, 
Ëá
,

2243 
Ëá
);

2245 ià(
Ëá
 =ğ(
size_t
)-1) {

2246 ià(
wr™‹n_¡»am_id
 !ğ
UINT64_MAX
) {

2247 
	`ngtı2_cÚn_tx_¡rmq_pİ
(
cÚn
);

2248 ++
¡rm
->
cyşe
;

2249 
rv
 = 
	`ngtı2_cÚn_tx_¡rmq_push
(
cÚn
, 
¡rm
);

2250 ià(
rv
 != 0) {

2251 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

2252  
rv
;

2255 
tx_¡rmq_fšish
;

2258 
rv
 = 
	`ngtı2_¡rm_¡»amäq_pİ
(
¡rm
, &
nsäc
, 
Ëá
);

2259 ià(
rv
 != 0) {

2260 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

2261  
rv
;

2264 ià(
nsäc
 =ğ
NULL
) {

2265 
tx_¡rmq_fšish
;

2268 
rv
 = 
	`cÚn_µe_wr™e_äame_hd_log
(
cÚn
, &
µe
, &
hd_logged
, &
hd
,

2269 &
nsäc
->
äc
.
ä
);

2270 ià(
rv
 != 0) {

2271 
	`as£¹
(0);

2274 *
päc
 = &
nsäc
->
äc
;

2275 
päc
 = &(*päc)->
Ãxt
;

2277 
wr™‹n_¡»am_id
 = 
¡rm
->
¡»am_id
;

2279 
pkt_em±y
 = 0;

2280 
¹b_’Œy_æags
 |ğ
NGTCP2_RTB_FLAG_ACK_ELICITING
;

2285 
tx_¡rmq_fšish
:

2287 
Ëá
 = 
	`ngtı2_µe_Ëá
(&
µe
);

2289 ià(
rv
 !ğ
NGTCP2_ERR_NOBUF
 && 
£nd_¡»am
 &&

2290 (
wr™‹n_¡»am_id
 =ğ
UINT64_MAX
 ||

2291 
wr™‹n_¡»am_id
 =ğ
d©a_¡rm
->
¡»am_id
) &&

2292 *
päc
 =ğ
NULL
 &&

2293 (
nd©®’
 = 
	`ngtı2_pkt_¡»am_max_d©®’
(
d©a_¡rm
->
¡»am_id
,

2294 
d©a_¡rm
->
tx_off£t
, 
nd©®’
,

2295 
Ëá
)è!ğ(
size_t
)-1 &&

2296 (
nd©®’
 || 
d©®’
 == 0)) {

2297 
fš
 = fš && 
nd©®’
 =ğ
d©®’
;

2299 
rv
 = 
	`ngtı2_¡»am_äame_chaš_Ãw
(&
nsäc
, 
cÚn
->
mem
);

2300 ià(
rv
 != 0) {

2301 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

2302  
rv
;

2305 
nsäc
->
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2306 
nsäc
->
ä
.
æags
 = 0;

2307 
nsäc
->
ä
.
fš
 = fin;

2308 
nsäc
->
ä
.
¡»am_id
 = 
d©a_¡rm
->stream_id;

2309 
nsäc
->
ä
.
off£t
 = 
d©a_¡rm
->
tx_off£t
;

2310 
nsäc
->
ä
.
d©aút
 = 
	`ngtı2_vec_cİy
(

2311 
nsäc
->
ä
.
d©a
, 
NGTCP2_MAX_STREAM_DATACNT
, 
d©av
, 
d©avút
, 
nd©®’
);

2313 
rv
 = 
	`cÚn_µe_wr™e_äame_hd_log
(
cÚn
, &
µe
, &
hd_logged
, &
hd
,

2314 &
nsäc
->
äc
.
ä
);

2315 ià(
rv
 != 0) {

2316 
	`as£¹
(0);

2319 *
päc
 = &
nsäc
->
äc
;

2320 
päc
 = &(*päc)->
Ãxt
;

2322 
pkt_em±y
 = 0;

2323 
¹b_’Œy_æags
 |ğ
NGTCP2_RTB_FLAG_ACK_ELICITING
;

2325 
£nd_¡»am
 = 0;

2330 ià(!
pkt_em±y
) {

2331 
rv
 = 
	`cÚn_ü—‹_ack_äame
(
cÚn
, &
ackä
, &
pkŠs
->
ackŒ
, 
ts
,

2332 
	`cÚn_compu‹_ack_d–ay
(
cÚn
),

2333 
cÚn
->
loÿl_£‰šgs
.
ack_d–ay_expÚ’t
);

2334 ià(
rv
 != 0) {

2335 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

2336  
rv
;

2339 ià(
ackä
) {

2340 
rv
 = 
	`cÚn_µe_wr™e_äame
(
cÚn
, &
µe
, &
hd
, 
ackä
);

2341 ià(
rv
 != 0) {

2342 
	`as£¹
(
NGTCP2_ERR_NOBUF
 =ğ
rv
);

2344 
	`ngtı2_ackŒ_comm™_ack
(&
pkŠs
->
ackŒ
);

2345 
	`ngtı2_ackŒ_add_ack
(&
pkŠs
->
ackŒ
, 
hd
.
pkt_num
, 
ackä
->
ack
.
Ïrge¡_ack
);

2346 
pkt_em±y
 = 0;

2348 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, 
ackä
);

2349 
ackä
 = 
NULL
;

2353 ià(
pkt_em±y
) {

2354 
	`as£¹
(
rv
 =ğ0 || 
NGTCP2_ERR_NOBUF
 ==„v);

2355 ià(
rv
 =ğ0 && 
¡»am_blocked
) {

2356  
NGTCP2_ERR_STREAM_DATA_BLOCKED
;

2364 
lä
.
ty³
 = 
NGTCP2_FRAME_PADDING
;

2365 
lä
.
·ddšg
.
Ën
 = 
	`ngtı2_µe_·ddšg_hp_§m¶e
(&
µe
);

2366 ià(
lä
.
·ddšg
.
Ën
) {

2367 
	`ngtı2_log_tx_ä
(&
cÚn
->
log
, &
hd
, &
lä
);

2370 
nwr™e
 = 
	`ngtı2_µe_fš®
(&
µe
, 
NULL
);

2371 ià(
nwr™e
 < 0) {

2372 
	`as£¹
(
	`ngtı2_”r_is_çl
(()
nwr™e
));

2373  
nwr™e
;

2376 ià(*
päc
 !ğ
pkŠs
->
äq
) {

2377 
rv
 = 
	`ngtı2_¹b_’Œy_Ãw
(&
’t
, &
hd
, 
NULL
, 
ts
, (
size_t
)
nwr™e
,

2378 
¹b_’Œy_æags
, 
cÚn
->
mem
);

2379 ià(
rv
 != 0) {

2380 
	`as£¹
(
	`ngtı2_”r_is_çl
(()
nwr™e
));

2381  
rv
;

2384 
’t
->
äc
 = 
pkŠs
->
äq
;

2385 
pkŠs
->
äq
 = *
päc
;

2386 *
päc
 = 
NULL
;

2388 
rv
 = 
	`cÚn_Ú_pkt_£Á
(
cÚn
, &
pkŠs
->
¹b
, 
’t
);

2389 ià(
rv
 != 0) {

2390 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

2391 
	`ngtı2_¹b_’Œy_d–
(
’t
, 
cÚn
->
mem
);

2392  
rv
;

2395 ià(
£nd_¡»am
) {

2396 
d©a_¡rm
->
tx_off£t
 +ğ
nd©®’
;

2397 
cÚn
->
tx_off£t
 +ğ
nd©®’
;

2399 ià(
fš
) {

2400 
	`ngtı2_¡rm_shutdown
(
d©a_¡rm
, 
NGTCP2_STRM_FLAG_SHUT_WR
);

2405 ià(
pd©®’
 && 
£nd_¡»am
) {

2406 *
pd©®’
 = (
ssize_t
)
nd©®’
;

2409 ++
pkŠs
->
Ï¡_tx_pkt_num
;

2411  
nwr™e
;

2412 
	}
}

2429 
ssize_t
 
	$cÚn_wr™e_sšgË_äame_pkt
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
,

2430 
size_t
 
de¡Ën
, 
ušt8_t
 
ty³
,

2431 cÚ¡ 
ngtı2_cid
 *
dcid
,

2432 
ngtı2_äame
 *
ä
) {

2433 
rv
;

2434 
ngtı2_µe
 
µe
;

2435 
ngtı2_pkt_hd
 
hd
;

2436 
ngtı2_äame
 
lä
;

2437 
ssize_t
 
nwr™e
;

2438 
ngtı2_üy±o_ùx
 
ùx
;

2439 
ngtı2_pkŠs
 *
pkŠs
;

2440 
ušt8_t
 
æags
;

2442 
ty³
) {

2443 
NGTCP2_PKT_INITIAL
:

2444 
pkŠs
 = &
cÚn
->
š_pkŠs
;

2445 
ùx
.
«ad_ov”h—d
 = 
NGTCP2_INITIAL_AEAD_OVERHEAD
;

2446 
ùx
.
’üy±
 = 
cÚn
->
ÿÎbacks
.
š_’üy±
;

2447 
ùx
.
hp_mask
 = 
cÚn
->
ÿÎbacks
.
š_hp_mask
;

2448 
æags
 = 
NGTCP2_PKT_FLAG_LONG_FORM
;

2450 
NGTCP2_PKT_HANDSHAKE
:

2451 
pkŠs
 = &
cÚn
->
hs_pkŠs
;

2452 
ùx
.
«ad_ov”h—d
 = 
cÚn
->aead_overhead;

2453 
ùx
.
’üy±
 = 
cÚn
->
ÿÎbacks
.encrypt;

2454 
ùx
.
hp_mask
 = 
cÚn
->
ÿÎbacks
.hp_mask;

2455 
æags
 = 
NGTCP2_PKT_FLAG_LONG_FORM
;

2457 
NGTCP2_PKT_SHORT
:

2459 
pkŠs
 = &
cÚn
->pktns;

2460 
ùx
.
«ad_ov”h—d
 = 
cÚn
->aead_overhead;

2461 
ùx
.
’üy±
 = 
cÚn
->
ÿÎbacks
.encrypt;

2462 
ùx
.
hp_mask
 = 
cÚn
->
ÿÎbacks
.hp_mask;

2463 
æags
 = (
pkŠs
->
tx_ckm
->æag & 
NGTCP2_CRYPTO_KM_FLAG_KEY_PHASE_ONE
)

2464 ? 
NGTCP2_PKT_FLAG_KEY_PHASE


2465 : 
NGTCP2_PKT_FLAG_NONE
;

2469 
	`as£¹
(0);

2472 
ùx
.
ckm
 = 
pkŠs
->
tx_ckm
;

2473 
ùx
.
hp
 = 
pkŠs
->
tx_hp
;

2474 
ùx
.
u£r_d©a
 = 
cÚn
;

2476 
	`ngtı2_pkt_hd_š™
(

2477 &
hd
, 
æags
, 
ty³
, 
dcid
, &
cÚn
->
oscid
, 
pkŠs
->
Ï¡_tx_pkt_num
 + 1,

2478 
	`¹b_£Ëù_pkt_numËn
(&
pkŠs
->
¹b
,…kŠs->
Ï¡_tx_pkt_num
 + 1),

2479 
cÚn
->
v”siÚ
, 0);

2481 
	`ngtı2_µe_š™
(&
µe
, 
de¡
, 
de¡Ën
, &
ùx
);

2483 
rv
 = 
	`ngtı2_µe_’code_hd
(&
µe
, &
hd
);

2484 ià(
rv
 != 0) {

2485 
	`as£¹
(
NGTCP2_ERR_NOBUF
 =ğ
rv
);

2489 ià(!
	`ngtı2_µe_’su»_hp_§m¶e
(&
µe
)) {

2493 
	`ngtı2_log_tx_pkt_hd
(&
cÚn
->
log
, &
hd
);

2495 
rv
 = 
	`cÚn_µe_wr™e_äame
(
cÚn
, &
µe
, &
hd
, 
ä
);

2496 ià(
rv
 != 0) {

2497 
	`as£¹
(
NGTCP2_ERR_NOBUF
 =ğ
rv
);

2501 
lä
.
ty³
 = 
NGTCP2_FRAME_PADDING
;

2502 
lä
.
·ddšg
.
Ën
 = 
	`ngtı2_µe_·ddšg_hp_§m¶e
(&
µe
);

2503 ià(
lä
.
·ddšg
.
Ën
) {

2504 
	`ngtı2_log_tx_ä
(&
cÚn
->
log
, &
hd
, &
lä
);

2507 
nwr™e
 = 
	`ngtı2_µe_fš®
(&
µe
, 
NULL
);

2508 ià(
nwr™e
 < 0) {

2509  
nwr™e
;

2513 ià(
ä
->
ty³
 =ğ
NGTCP2_FRAME_ACK
) {

2514 
	`ngtı2_ackŒ_comm™_ack
(&
pkŠs
->
ackŒ
);

2515 
	`ngtı2_ackŒ_add_ack
(&
pkŠs
->
ackŒ
, 
hd
.
pkt_num
, 
ä
->
ack
.
Ïrge¡_ack
);

2518 ++
pkŠs
->
Ï¡_tx_pkt_num
;

2520  
nwr™e
;

2521 
	}
}

2536 
ssize_t
 
	$cÚn_wr™e_´Ùeùed_ack_pkt
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
,

2537 
size_t
 
de¡Ën
, 
ngtı2_t¡amp
 
ts
) {

2538 
rv
;

2539 
ssize_t
 
¥k’
;

2540 
ngtı2_äame
 *
ackä
;

2541 
ngtı2_ackŒ
 *
ackŒ
 = &
cÚn
->
pkŠs
.acktr;

2543 
ackä
 = 
NULL
;

2544 
rv
 = 
	`cÚn_ü—‹_ack_äame
(
cÚn
, &
ackä
, 
ackŒ
, 
ts
,

2545 
	`cÚn_compu‹_ack_d–ay
(
cÚn
),

2546 
cÚn
->
loÿl_£‰šgs
.
ack_d–ay_expÚ’t
);

2547 ià(
rv
 != 0) {

2548  
rv
;

2551 ià(!
ackä
) {

2555 
¥k’
 = 
	`cÚn_wr™e_sšgË_äame_pkt
(
cÚn
, 
de¡
, 
de¡Ën
, 
NGTCP2_PKT_SHORT
,

2556 &
cÚn
->
dcid
.
cid
, 
ackä
);

2557 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, 
ackä
);

2558 ià(
¥k’
 < 0) {

2559  
¥k’
;

2562  
¥k’
;

2563 
	}
}

2569 
	$cÚn_´oûss_—¾y_¹b
(
ngtı2_cÚn
 *
cÚn
) {

2570 
ngtı2_¹b_’Œy
 *
’t
;

2571 
ngtı2_¹b
 *
¹b
 = &
cÚn
->
pkŠs
.rtb;

2572 
ngtı2_k¦_™
 
™
;

2574 
™
 = 
	`ngtı2_¹b_h—d
(
¹b
); !
	`ngtı2_k¦_™_’d
(&it);

2575 
	`ngtı2_k¦_™_Ãxt
(&
™
)) {

2576 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

2578 ià((
’t
->
hd
.
æags
 & 
NGTCP2_PKT_FLAG_LONG_FORM
) == 0 ||

2579 
’t
->
hd
.
ty³
 !ğ
NGTCP2_PKT_0RTT_PROTECTED
) {

2583 
’t
->
hd
.
dcid
 = 
cÚn
->dcid.
cid
;

2586 
’t
->
hd
.
æags
 &ğ(
ušt8_t
)~
NGTCP2_PKT_FLAG_LONG_FORM
;

2587 
’t
->
hd
.
ty³
 = 
NGTCP2_PKT_SHORT
;

2589 
	}
}

2606 
ssize_t
 
	$cÚn_wr™e_´obe_pšg
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
,

2607 
size_t
 
de¡Ën
, 
ngtı2_t¡amp
 
ts
) {

2608 
ngtı2_µe
 
µe
;

2609 
ngtı2_pkt_hd
 
hd
;

2610 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->pktns;

2611 
ngtı2_üy±o_ùx
 
ùx
;

2612 
ngtı2_äame_chaš
 *
äc
 = 
NULL
;

2613 
ngtı2_¹b_’Œy
 *
’t
;

2614 
ngtı2_äame
 *
ackä
 = 
NULL
, 
lä
;

2615 
rv
;

2616 
ssize_t
 
nwr™e
;

2618 
	`as£¹
(
pkŠs
->
tx_ckm
);

2620 
ùx
.
«ad_ov”h—d
 = 
cÚn
->aead_overhead;

2621 
ùx
.
’üy±
 = 
cÚn
->
ÿÎbacks
.encrypt;

2622 
ùx
.
hp_mask
 = 
cÚn
->
ÿÎbacks
.hp_mask;

2623 
ùx
.
ckm
 = 
pkŠs
->
tx_ckm
;

2624 
ùx
.
hp
 = 
pkŠs
->
tx_hp
;

2625 
ùx
.
u£r_d©a
 = 
cÚn
;

2627 
	`ngtı2_pkt_hd_š™
(

2628 &
hd
,

2629 (
pkŠs
->
tx_ckm
->
æags
 & 
NGTCP2_CRYPTO_KM_FLAG_KEY_PHASE_ONE
)

2630 ? 
NGTCP2_PKT_FLAG_KEY_PHASE


2631 : 
NGTCP2_PKT_FLAG_NONE
,

2632 
NGTCP2_PKT_SHORT
, &
cÚn
->
dcid
.
cid
, 
NULL
, 
pkŠs
->
Ï¡_tx_pkt_num
 + 1,

2633 
	`¹b_£Ëù_pkt_numËn
(&
pkŠs
->
¹b
,…kŠs->
Ï¡_tx_pkt_num
 + 1),

2634 
cÚn
->
v”siÚ
, 0);

2636 
	`ngtı2_µe_š™
(&
µe
, 
de¡
, 
de¡Ën
, &
ùx
);

2638 
rv
 = 
	`ngtı2_µe_’code_hd
(&
µe
, &
hd
);

2639 ià(
rv
 != 0) {

2640 
	`as£¹
(
NGTCP2_ERR_NOBUF
 =ğ
rv
);

2644 ià(!
	`ngtı2_µe_’su»_hp_§m¶e
(&
µe
)) {

2648 
	`ngtı2_log_tx_pkt_hd
(&
cÚn
->
log
, &
hd
);

2650 
rv
 = 
	`ngtı2_äame_chaš_Ãw
(&
äc
, 
cÚn
->
mem
);

2651 ià(
rv
 != 0) {

2652  
rv
;

2655 
äc
->
ä
.
ty³
 = 
NGTCP2_FRAME_PING
;

2657 
rv
 = 
	`cÚn_µe_wr™e_äame
(
cÚn
, &
µe
, &
hd
, &
äc
->
ä
);

2658 ià(
rv
 != 0) {

2659 
	`as£¹
(
NGTCP2_ERR_NOBUF
 =ğ
rv
);

2660 
rv
 = 0;

2661 
ç
;

2664 
rv
 = 
	`cÚn_ü—‹_ack_äame
(
cÚn
, &
ackä
, &
pkŠs
->
ackŒ
, 
ts
,

2665 
	`cÚn_compu‹_ack_d–ay
(
cÚn
),

2666 
cÚn
->
loÿl_£‰šgs
.
ack_d–ay_expÚ’t
);

2667 ià(
rv
 != 0) {

2668 
ç
;

2671 ià(
ackä
) {

2672 
rv
 = 
	`cÚn_µe_wr™e_äame
(
cÚn
, &
µe
, &
hd
, 
ackä
);

2673 ià(
rv
 != 0) {

2674 
	`as£¹
(
NGTCP2_ERR_NOBUF
 =ğ
rv
);

2676 
	`ngtı2_ackŒ_comm™_ack
(&
pkŠs
->
ackŒ
);

2677 
	`ngtı2_ackŒ_add_ack
(&
pkŠs
->
ackŒ
, 
hd
.
pkt_num
, 
ackä
->
ack
.
Ïrge¡_ack
);

2679 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, 
ackä
);

2680 
ackä
 = 
NULL
;

2683 
lä
.
ty³
 = 
NGTCP2_FRAME_PADDING
;

2684 
lä
.
·ddšg
.
Ën
 = 
	`ngtı2_µe_·ddšg_hp_§m¶e
(&
µe
);

2685 ià(
lä
.
·ddšg
.
Ën
) {

2686 
	`ngtı2_log_tx_ä
(&
cÚn
->
log
, &
hd
, &
lä
);

2689 
nwr™e
 = 
	`ngtı2_µe_fš®
(&
µe
, 
NULL
);

2690 ià(
nwr™e
 < 0) {

2691 
rv
 = ()
nwr™e
;

2692 
ç
;

2695 
rv
 = 
	`ngtı2_¹b_’Œy_Ãw
(

2696 &
’t
, &
hd
, 
äc
, 
ts
, (
size_t
)
nwr™e
,

2697 
NGTCP2_RTB_FLAG_PROBE
 | 
NGTCP2_RTB_FLAG_ACK_ELICITING
, 
cÚn
->
mem
);

2698 ià(
rv
 != 0) {

2699 
ç
;

2702 
rv
 = 
	`cÚn_Ú_pkt_£Á
(
cÚn
, &
pkŠs
->
¹b
, 
’t
);

2703 ià(
rv
 != 0) {

2704 
	`ngtı2_¹b_’Œy_d–
(
’t
, 
cÚn
->
mem
);

2705  
rv
;

2708 ++
pkŠs
->
Ï¡_tx_pkt_num
;

2710  
nwr™e
;

2712 
ç
:

2713 
	`ngtı2_äame_chaš_d–
(
äc
, 
cÚn
->
mem
);

2715  
rv
;

2716 
	}
}

2740 
ssize_t
 
	$cÚn_wr™e_´obe_pkt
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
,

2741 
size_t
 
de¡Ën
, 
ssize_t
 *
pd©®’
,

2742 
ngtı2_¡rm
 *
¡rm
, 
ušt8_t
 
fš
,

2743 cÚ¡ 
ngtı2_vec
 *
d©av
, 
size_t
 
d©avút
,

2744 
ngtı2_t¡amp
 
ts
) {

2745 
ssize_t
 
nwr™e
;

2747 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_CON
,

2748 "Œªsm™…robpkˆËá=%zu", 
cÚn
->
rcs
.
´obe_pkt_Ëá
);

2751 
nwr™e
 = 
	`cÚn_wr™e_pkt
(
cÚn
, 
de¡
, 
de¡Ën
, 
pd©®’
, 
¡rm
, 
fš
, 
d©av
,

2752 
d©avút
, 
ts
);

2753 ià(
nwr™e
 =ğ0 ||‚wr™=ğ
NGTCP2_ERR_STREAM_DATA_BLOCKED
) {

2754 
nwr™e
 = 
	`cÚn_wr™e_´obe_pšg
(
cÚn
, 
de¡
, 
de¡Ën
, 
ts
);

2756 ià(
nwr™e
 <= 0) {

2757  
nwr™e
;

2760 --
cÚn
->
rcs
.
´obe_pkt_Ëá
;

2762 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_CON
, "probe…kt size=%zd",

2763 
nwr™e
);

2765  
nwr™e
;

2766 
	}
}

2773 
	$cÚn_hªdshake_»mÇÁs_Ëá
(
ngtı2_cÚn
 *
cÚn
) {

2774  !(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_HANDSHAKE_COMPLETED
) ||

2775 
	`ngtı2_¹b_num_ack_–ic™šg
(&
cÚn
->
š_pkŠs
.
¹b
) ||

2776 
	`ngtı2_¹b_num_ack_–ic™šg
(&
cÚn
->
hs_pkŠs
.
¹b
) ||

2777 !
	`ngtı2_pq_em±y
(&
cÚn
->
š_pkŠs
.
üy±oäq
) ||

2778 !
	`ngtı2_pq_em±y
(&
cÚn
->
hs_pkŠs
.
üy±oäq
);

2779 
	}
}

2790 
	$cÚn_»tœe_dcid
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_dcid
 *
dcid
) {

2791 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->pktns;

2792 
ngtı2_äame_chaš
 *
näc
;

2793 
rv
;

2795 
rv
 = 
	`ngtı2_äame_chaš_Ãw
(&
näc
, 
cÚn
->
mem
);

2796 ià(
rv
 != 0) {

2797  
rv
;

2800 
näc
->
ä
.
ty³
 = 
NGTCP2_FRAME_RETIRE_CONNECTION_ID
;

2801 
näc
->
ä
.
»tœe_cÚÃùiÚ_id
.
£q
 = 
dcid
->seq;

2802 
näc
->
Ãxt
 = 
pkŠs
->
äq
;

2803 
pkŠs
->
äq
 = 
näc
;

2806 
	}
}

2819 
	$cÚn_¡İ_pv
(
ngtı2_cÚn
 *
cÚn
) {

2820 
rv
 = 0;

2821 
ngtı2_pv
 *
pv
 = 
cÚn
->pv;

2823 ià(
pv
 =ğ
NULL
) {

2827 ià(
pv
->
æags
 & 
NGTCP2_PV_FLAG_RETIRE_DCID_ON_FINISH
) {

2828 
rv
 = 
	`cÚn_»tœe_dcid
(
cÚn
, &
pv
->
dcid
);

2831 
	`ngtı2_pv_d–
(
pv
);

2832 
cÚn
->
pv
 = 
NULL
;

2834  
rv
;

2835 
	}
}

2849 
ssize_t
 
	$cÚn_wr™e_·th_ch®Ënge
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_·th
 *
·th
,

2850 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

2851 
ngtı2_t¡amp
 
ts
) {

2852 
rv
;

2853 
ngtı2_t¡amp
 
expœy
;

2854 
ngtı2_pv
 *
pv
 = 
cÚn
->pv;

2855 
ngtı2_äame
 
lä
;

2857 
	`ngtı2_pv_’su»_¡¬t
(
pv
, 
ts
);

2859 ià(
	`ngtı2_pv_v®id©iÚ_timed_out
(
pv
, 
ts
)) {

2860 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PTV
,

2864 
pv
->
æags
 |ğ
NGTCP2_PV_FLAG_RETIRE_DCID_ON_FINISH
;

2866 ià(!(
pv
->
æags
 & 
NGTCP2_PV_FLAG_DONT_CARE
)) {

2867 
rv
 = 
	`cÚn_ÿÎ_·th_v®id©iÚ
(
cÚn
, &
pv
->
dcid
.
·th
,

2868 
NGTCP2_PATH_VALIDATION_RESULT_FAILURE
);

2869 ià(
rv
 != 0) {

2870  
rv
;

2874  
	`cÚn_¡İ_pv
(
cÚn
);

2877 
	`ngtı2_pv_hªdË_’Œy_expœy
(
pv
, 
ts
);

2879 ià(
	`ngtı2_pv_fuÎ
(
pv
)) {

2883 ià(
·th
) {

2884 
	`ngtı2_·th_cİy
(
·th
, &
pv
->
dcid
.path);

2887 
	`as£¹
(
cÚn
->
ÿÎbacks
.
¿nd
);

2888 
rv
 = 
cÚn
->
ÿÎbacks
.
	`¿nd
(cÚn, 
lä
.
·th_ch®Ënge
.
d©a
,

2889 (
lä
.
·th_ch®Ënge
.
d©a
),

2890 
NGTCP2_RAND_CTX_PATH_CHALLENGE
, 
cÚn
->
u£r_d©a
);

2891 ià(
rv
 != 0) {

2892  
NGTCP2_ERR_CALLBACK_FAILURE
;

2895 
lä
.
ty³
 = 
NGTCP2_FRAME_PATH_CHALLENGE
;

2899 
expœy
 = 
ts
 + 
NGTCP2_DEFAULT_INITIAL_RTT
 * (1uÎ << 
pv
->
loss_couÁ
);

2901 
	`ngtı2_pv_add_’Œy
(
pv
, 
lä
.
·th_ch®Ënge
.
d©a
, 
expœy
);

2903  
	`cÚn_wr™e_sšgË_äame_pkt
(
cÚn
, 
de¡
, 
de¡Ën
, 
NGTCP2_PKT_SHORT
,

2904 &
pv
->
dcid
.
cid
, &
lä
);

2905 
	}
}

2920 
	$cÚn_bšd_dcid
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_dcid
 **
pdcid
,

2921 cÚ¡ 
ngtı2_·th
 *
·th
) {

2922 
ngtı2_pv
 *
pv
 = 
cÚn
->pv;

2923 
ngtı2_dcid
 *
dcid
, *
ndcid
;

2924 
size_t
 
i
, 
Ën
;

2925 
rv
;

2927 
	`as£¹
(!
	`ngtı2_·th_eq
(&
cÚn
->
dcid
.
·th
,…ath));

2928 
	`as£¹
(!
pv
 || !
	`ngtı2_·th_eq
(&pv->
dcid
.
·th
,…ath));

2930 
Ën
 = 
	`ngtı2_ršgbuf_Ën
(&
cÚn
->
bound_dcids
);

2931 
i
 = 0; i < 
Ën
; ++i) {

2932 
dcid
 = 
	`ngtı2_ršgbuf_g‘
(&
cÚn
->
bound_dcids
, 
i
);

2934 ià(
	`ngtı2_·th_eq
(&
dcid
->
·th
,…ath)) {

2935 *
pdcid
 = 
dcid
;

2940 ià(
	`ngtı2_ršgbuf_Ën
(&
cÚn
->
dcids
) == 0) {

2941  
NGTCP2_ERR_INVALID_STATE
;

2944 
dcid
 = 
	`ngtı2_ršgbuf_g‘
(&
cÚn
->
dcids
, 0);

2946 ià(
	`ngtı2_ršgbuf_fuÎ
(&
cÚn
->
bound_dcids
)) {

2947 
rv
 = 
	`cÚn_»tœe_dcid
(
cÚn
, 
	`ngtı2_ršgbuf_g‘
(&cÚn->
bound_dcids
, 0));

2948 ià(
rv
 != 0) {

2949  
rv
;

2953 
ndcid
 = 
	`ngtı2_ršgbuf_push_back
(&
cÚn
->
bound_dcids
);

2955 
	`ngtı2_dcid_cİy
(
ndcid
, 
dcid
);

2956 
	`ngtı2_·th_cİy
(&
ndcid
->
·th
,…ath);

2958 
	`ngtı2_ršgbuf_pİ_äÚt
(&
cÚn
->
dcids
);

2960 *
pdcid
 = 
ndcid
;

2963 
	}
}

2977 
ssize_t
 
	$cÚn_wr™e_·th_»¥Ú£
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_·th
 *
·th
,

2978 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
) {

2979 
rv
;

2980 
ngtı2_·th_ch®Ënge_’Œy
 *
pûÁ
 = 
NULL
;

2981 
ngtı2_dcid
 *
dcid
 = 
NULL
;

2982 
ngtı2_äame
 
lä
;

2983 
ssize_t
 
nwr™e
;

2985 ; 
	`ngtı2_ršgbuf_Ën
(&
cÚn
->
rx_·th_ch®Ënge
);) {

2986 
pûÁ
 = 
	`ngtı2_ršgbuf_g‘
(&
cÚn
->
rx_·th_ch®Ënge
, 0);

2988 ià(
	`ngtı2_·th_eq
(&
cÚn
->
dcid
.
·th
, &
pûÁ
->path)) {

2989 ià(!
cÚn
->
pv
 || !(cÚn->pv->
æags
 & 
NGTCP2_PV_FLAG_BLOCKING
)) {

2992 
dcid
 = &
cÚn
->dcid;

2996 ià(
cÚn
->
pv
 && 
	`ngtı2_·th_eq
(&cÚn->pv->
dcid
.
·th
, &
pûÁ
->path)) {

2997 
dcid
 = &
cÚn
->
pv
->dcid;

3001 ià(!
cÚn
->
£rv”
) {

3004 
	`ngtı2_ršgbuf_pİ_äÚt
(&
cÚn
->
rx_·th_ch®Ënge
);

3005 
pûÁ
 = 
NULL
;

3012 ià(
pûÁ
 =ğ
NULL
) {

3016 
lä
.
ty³
 = 
NGTCP2_FRAME_PATH_RESPONSE
;

3017 
	`memıy
(
lä
.
·th_»¥Ú£
.
d©a
, 
pûÁ
->data, (lfr.path_response.data));

3019 ià(
dcid
 =ğ
NULL
) {

3021 
	`as£¹
(
cÚn
->
£rv”
);

3023 
rv
 = 
	`cÚn_bšd_dcid
(
cÚn
, &
dcid
, &
pûÁ
->
·th
);

3024 ià(
rv
 != 0) {

3025 ià(
	`ngtı2_”r_is_çl
(
rv
)) {

3026  
rv
;

3032 ià(
·th
) {

3033 
	`ngtı2_·th_cİy
(
·th
, &
pûÁ
->path);

3036 
nwr™e
 = 
	`cÚn_wr™e_sšgË_äame_pkt
(
cÚn
, 
de¡
, 
de¡Ën
, 
NGTCP2_PKT_SHORT
,

3037 &
dcid
->
cid
, &
lä
);

3038 ià(
nwr™e
 <= 0) {

3039  
nwr™e
;

3042 
	`ngtı2_ršgbuf_pİ_äÚt
(&
cÚn
->
rx_·th_ch®Ënge
);

3044  
nwr™e
;

3045 
	}
}

3047 
ssize_t
 
	$ngtı2_cÚn_wr™e_pkt
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_·th
 *
·th
,

3048 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
, 
ngtı2_t¡amp
 
ts
) {

3049 
ssize_t
 
nwr™e
;

3050 
ušt64_t
 
cwnd
;

3051 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->pktns;

3052 
size_t
 
ÜigËn
 = 
de¡Ën
;

3053 
rv
;

3055 
cÚn
->
log
.
Ï¡_ts
 = 
ts
;

3057 ià(
pkŠs
->
Ï¡_tx_pkt_num
 =ğ
NGTCP2_MAX_PKT_NUM
) {

3058  
NGTCP2_ERR_PKT_NUM_EXHAUSTED
;

3061 
cÚn
->
¡©e
) {

3062 
NGTCP2_CS_CLIENT_INITIAL
:

3063 
NGTCP2_CS_CLIENT_WAIT_HANDSHAKE
:

3064 
NGTCP2_CS_CLIENT_TLS_HANDSHAKE_FAILED
:

3065 
NGTCP2_CS_SERVER_INITIAL
:

3066 
NGTCP2_CS_SERVER_WAIT_HANDSHAKE
:

3067 
NGTCP2_CS_SERVER_TLS_HANDSHAKE_FAILED
:

3068  
NGTCP2_ERR_INVALID_STATE
;

3069 
NGTCP2_CS_POST_HANDSHAKE
:

3070 
rv
 = 
	`cÚn_»move_»tœed_cÚÃùiÚ_id
(
cÚn
, 
ts
);

3071 ià(
rv
 != 0) {

3072  
rv
;

3075 
nwr™e
 = 
	`cÚn_wr™e_·th_»¥Ú£
(
cÚn
, 
·th
, 
de¡
, 
de¡Ën
);

3076 ià(
nwr™e
) {

3077  
nwr™e
;

3080 ià(
cÚn
->
pv
) {

3081 
nwr™e
 = 
	`cÚn_wr™e_·th_ch®Ënge
(
cÚn
, 
·th
, 
de¡
, 
de¡Ën
, 
ts
);

3082 ià(
nwr™e
 || (
cÚn
->
pv
 && (cÚn->pv->
æags
 & 
NGTCP2_PV_FLAG_BLOCKING
))) {

3083  
nwr™e
;

3087 
cwnd
 = 
	`cÚn_cwnd_Ëá
(
cÚn
);

3088 
de¡Ën
 = 
	`ngtı2_mš
(de¡Ën, 
cwnd
);

3090 ià(
·th
) {

3091 
	`ngtı2_·th_cİy
(
·th
, &
cÚn
->
dcid
.path);

3094 ià(
	`cÚn_hªdshake_»mÇÁs_Ëá
(
cÚn
)) {

3095 
nwr™e
 = 
	`cÚn_wr™e_hªdshake_pkts
(
cÚn
, 
de¡
, 
de¡Ën
, 0, 
ts
);

3096 ià(
nwr™e
) {

3097  
nwr™e
;

3100 
nwr™e
 = 
	`cÚn_wr™e_hªdshake_ack_pkts
(
cÚn
, 
de¡
, 
ÜigËn
, 
ts
);

3101 ià(
nwr™e
) {

3102  
nwr™e
;

3105 ià(
cÚn
->
rcs
.
´obe_pkt_Ëá
) {

3106  
	`cÚn_wr™e_´obe_pkt
(
cÚn
, 
de¡
, 
ÜigËn
, 
NULL
, NULL, 0, NULL, 0,

3107 
ts
);

3110 
nwr™e
 = 
	`cÚn_wr™e_pkt
(
cÚn
, 
de¡
, 
de¡Ën
, 
NULL
, NULL, 0, NULL, 0, 
ts
);

3111 ià(
nwr™e
 < 0) {

3112 
	`as£¹
(
nwr™e
 !ğ
NGTCP2_ERR_NOBUF
);

3113  
nwr™e
;

3115 ià(
nwr™e
) {

3116  
nwr™e
;

3118  
	`cÚn_wr™e_´Ùeùed_ack_pkt
(
cÚn
, 
de¡
, 
ÜigËn
, 
ts
);

3119 
NGTCP2_CS_CLOSING
:

3120  
NGTCP2_ERR_CLOSING
;

3121 
NGTCP2_CS_DRAINING
:

3122  
NGTCP2_ERR_DRAINING
;

3126 
	}
}

3144 
	$cÚn_Ú_v”siÚ_ÃgÙŸtiÚ
(
ngtı2_cÚn
 *
cÚn
,

3145 cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

3146 cÚ¡ 
ušt8_t
 *
·ylßd
,

3147 
size_t
 
·ylßdËn
) {

3148 
ušt32_t
 
sv
[16];

3149 
ušt32_t
 *
p
;

3150 
rv
 = 0;

3151 
size_t
 
nsv
;

3153 ià(
·ylßdËn
 % (
ušt32_t
)) {

3154  
NGTCP2_ERR_INVALID_ARGUMENT
;

3157 ià(
·ylßdËn
 > (
sv
)) {

3158 
p
 = 
	`ngtı2_mem_m®loc
(
cÚn
->
mem
, 
·ylßdËn
);

3159 ià(
p
 =ğ
NULL
) {

3160  
NGTCP2_ERR_NOMEM
;

3163 
p
 = 
sv
;

3168 
cÚn
->
¡©e
 = 
NGTCP2_CS_DRAINING
;

3170 
nsv
 = 
	`ngtı2_pkt_decode_v”siÚ_ÃgÙŸtiÚ
(
p
, 
·ylßd
, 
·ylßdËn
);

3172 
	`ngtı2_log_rx_vn
(&
cÚn
->
log
, 
hd
, 
sv
, 
nsv
);

3174 ià(
cÚn
->
ÿÎbacks
.
»cv_v”siÚ_ÃgÙŸtiÚ
) {

3175 
rv
 = 
cÚn
->
ÿÎbacks
.
	`»cv_v”siÚ_ÃgÙŸtiÚ
(cÚn, 
hd
, 
sv
, 
nsv
,

3176 
cÚn
->
u£r_d©a
);

3179 ià(
p
 !ğ
sv
) {

3180 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, 
p
);

3183 ià(
rv
 != 0) {

3184  
NGTCP2_ERR_CALLBACK_FAILURE
;

3188 
	}
}

3200 
	$cÚn_»sched_äames
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_pkŠs
 *
pkŠs
,

3201 
ngtı2_äame_chaš
 **
päc
) {

3202 
ngtı2_äame_chaš
 **
fœ¡
 = 
päc
;

3203 
ngtı2_¡»am_äame_chaš
 *
säc
;

3204 
ngtı2_¡»am
 *
sä
;

3205 
ngtı2_üy±o_äame_chaš
 *
cäc
;

3206 
ngtı2_¡rm
 *
¡rm
;

3207 
rv
;

3209 ià(*
päc
 =ğ
NULL
) {

3213 ; *
päc
;) {

3214 (*
päc
)->
ä
.
ty³
) {

3215 
NGTCP2_FRAME_STREAM
:

3216 
säc
 = (
ngtı2_¡»am_äame_chaš
 *)*
päc
;

3218 *
päc
 = 
säc
->
Ãxt
;

3219 
säc
->
Ãxt
 = 
NULL
;

3220 
sä
 = &
säc
->
ä
;

3222 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
sä
->
¡»am_id
);

3223 ià(!
¡rm
) {

3224 
	`ngtı2_¡»am_äame_chaš_d–
(
säc
, 
cÚn
->
mem
);

3227 
rv
 = 
	`ngtı2_¡rm_¡»amäq_push
(
¡rm
, 
säc
);

3228 ià(
rv
 != 0) {

3229 
	`ngtı2_¡»am_äame_chaš_d–
(
säc
, 
cÚn
->
mem
);

3230  
rv
;

3232 ià(!
	`ngtı2_¡rm_is_tx_queued
(
¡rm
)) {

3233 
rv
 = 
	`ngtı2_cÚn_tx_¡rmq_push
(
cÚn
, 
¡rm
);

3234 ià(
rv
 != 0) {

3235  
rv
;

3239 
NGTCP2_FRAME_CRYPTO
:

3240 
cäc
 = (
ngtı2_üy±o_äame_chaš
 *)*
päc
;

3242 *
päc
 = 
cäc
->
Ãxt
;

3243 
cäc
->
Ãxt
 = 
NULL
;

3245 
rv
 = 
	`ngtı2_pq_push
(&
pkŠs
->
üy±oäq
, &
cäc
->
³
);

3246 ià(
rv
 != 0) {

3247 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

3248 
	`ngtı2_üy±o_äame_chaš_d–
(
cäc
, 
cÚn
->
mem
);

3249  
rv
;

3253 
päc
 = &(*päc)->
Ãxt
;

3257 *
päc
 = 
pkŠs
->
äq
;

3258 
pkŠs
->
äq
 = *
fœ¡
;

3261 
	}
}

3281 
	$cÚn_Ú_»Œy
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

3282 
size_t
 
odc
, cÚ¡ 
ušt8_t
 *
·ylßd
,

3283 
size_t
 
·ylßdËn
) {

3284 
rv
;

3285 
ngtı2_pkt_»Œy
 
»Œy
;

3286 
ušt8_t
 *
p
;

3287 
ngtı2_¹b
 *
¹b
 = &
cÚn
->
pkŠs
.rtb;

3288 
ngtı2_¹b
 *
š_¹b
 = &
cÚn
->
š_pkŠs
.
¹b
;

3289 
ušt8_t
 
cidbuf
[(
»Œy
.
odcid
.
d©a
) * 2 + 1];

3290 
ngtı2_äame_chaš
 *
äc
 = 
NULL
;

3292 ià(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_RECV_RETRY
) {

3296 
rv
 = 
	`ngtı2_pkt_decode_»Œy
(&
»Œy
, 
odc
, 
·ylßd
, 
·ylßdËn
);

3297 ià(
rv
 != 0) {

3298  
rv
;

3301 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
, "odcid=0x%s",

3302 (cÚ¡ *)
	`ngtı2_’code_hex
(
cidbuf
, 
»Œy
.
odcid
.
d©a
,

3303 
»Œy
.
odcid
.
d©®’
));

3305 ià(!
	`ngtı2_cid_eq
(&
cÚn
->
dcid
.
cid
, &
»Œy
.
odcid
è||„‘ry.
tok’Ën
 == 0) {

3306  
NGTCP2_ERR_PROTO
;

3311 
cÚn
->
dcid
.
cid
 = 
hd
->
scid
;

3313 
cÚn
->
æags
 |ğ
NGTCP2_CONN_FLAG_RECV_RETRY
;

3315 
	`as£¹
(
cÚn
->
ÿÎbacks
.
»cv_»Œy
);

3317 
rv
 = 
cÚn
->
ÿÎbacks
.
	`»cv_»Œy
(cÚn, 
hd
, &
»Œy
, cÚn->
u£r_d©a
);

3318 ià(
rv
 != 0) {

3319  
NGTCP2_ERR_CALLBACK_FAILURE
;

3322 
cÚn
->
¡©e
 = 
NGTCP2_CS_CLIENT_INITIAL
;

3326 
rv
 = 
	`ngtı2_¹b_»move_®l
(
¹b
, &
äc
);

3327 ià(
rv
 != 0) {

3328 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

3329 
	`ngtı2_äame_chaš_li¡_d–
(
äc
, 
cÚn
->
mem
);

3330  
rv
;

3333 
rv
 = 
	`cÚn_»sched_äames
(
cÚn
, &cÚn->
pkŠs
, &
äc
);

3334 ià(
rv
 != 0) {

3335 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

3336 
	`ngtı2_äame_chaš_li¡_d–
(
äc
, 
cÚn
->
mem
);

3337  
rv
;

3340 
äc
 = 
NULL
;

3341 
rv
 = 
	`ngtı2_¹b_»move_®l
(
š_¹b
, &
äc
);

3342 ià(
rv
 != 0) {

3343 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

3344 
	`ngtı2_äame_chaš_li¡_d–
(
äc
, 
cÚn
->
mem
);

3345  
rv
;

3348 
rv
 = 
	`cÚn_»sched_äames
(
cÚn
, &cÚn->
š_pkŠs
, &
äc
);

3349 ià(
rv
 != 0) {

3350 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

3351 
	`ngtı2_äame_chaš_li¡_d–
(
äc
, 
cÚn
->
mem
);

3352  
rv
;

3355 
	`as£¹
(
cÚn
->
tok’
.
begš
 =ğ
NULL
);

3357 
p
 = 
	`ngtı2_mem_m®loc
(
cÚn
->
mem
, 
»Œy
.
tok’Ën
);

3358 ià(
p
 =ğ
NULL
) {

3359  
NGTCP2_ERR_NOMEM
;

3361 
	`ngtı2_buf_š™
(&
cÚn
->
tok’
, 
p
, 
»Œy
.
tok’Ën
);

3363 
	`ngtı2_ıymem
(
cÚn
->
tok’
.
begš
, 
»Œy
.tok’,„‘ry.
tok’Ën
);

3364 
cÚn
->
tok’
.
pos
 = cÚn->tok’.
begš
;

3365 
cÚn
->
tok’
.
Ï¡
 = cÚn->tok’.
pos
 + 
»Œy
.
tok’Ën
;

3368 
	}
}

3370 
	$ngtı2_cÚn_d‘eù_lo¡_pkt
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_pkŠs
 *
pkŠs
,

3371 
ngtı2_rcvry_¡©
 *
rcs
, 
ngtı2_t¡amp
 
ts
) {

3372 
ngtı2_äame_chaš
 *
äc
 = 
NULL
;

3373 
rv
;

3375 
rv
 = 
	`ngtı2_¹b_d‘eù_lo¡_pkt
(&
pkŠs
->
¹b
, &
äc
, 
rcs
, 
ts
);

3376 ià(
rv
 != 0) {

3378 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

3379 
	`ngtı2_äame_chaš_li¡_d–
(
äc
, 
cÚn
->
mem
);

3380  
rv
;

3383 
rv
 = 
	`cÚn_»sched_äames
(
cÚn
, 
pkŠs
, &
äc
);

3384 ià(
rv
 != 0) {

3385 
	`ngtı2_äame_chaš_li¡_d–
(
äc
, 
cÚn
->
mem
);

3386  
rv
;

3390 
	}
}

3405 
	$cÚn_»cv_ack
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_pkŠs
 *
pkŠs
, 
ngtı2_ack
 *
ä
,

3406 
ngtı2_t¡amp
 
ts
) {

3407 
rv
;

3408 
ngtı2_äame_chaš
 *
äc
 = 
NULL
;

3410 
rv
 = 
	`ngtı2_pkt_v®id©e_ack
(
ä
);

3411 ià(
rv
 != 0) {

3412  
rv
;

3415 
rv
 = 
	`ngtı2_ackŒ_»cv_ack
(&
pkŠs
->
ackŒ
, 
ä
);

3416 ià(
rv
 != 0) {

3417  
rv
;

3420 
rv
 = 
	`ngtı2_¹b_»cv_ack
(&
pkŠs
->
¹b
, 
ä
, 
cÚn
, 
ts
);

3421 ià(
rv
 != 0) {

3423 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

3424 
	`ngtı2_äame_chaš_li¡_d–
(
äc
, 
cÚn
->
mem
);

3425  
rv
;

3428 
rv
 = 
	`ngtı2_cÚn_d‘eù_lo¡_pkt
(
cÚn
, 
pkŠs
, &cÚn->
rcs
, 
ts
);

3429 ià(
rv
 != 0) {

3430  
rv
;

3433 
	`ngtı2_cÚn_£t_loss_d‘eùiÚ_tim”
(
cÚn
);

3436 
	}
}

3442 
	$assign_»cved_ack_d–ay_unsÿËd
(
ngtı2_ack
 *
ä
,

3443 
ušt64_t
 
ack_d–ay_expÚ’t
) {

3444 
ä
->
ack_d–ay_unsÿËd
 = fr->
ack_d–ay
 * (1UL << 
ack_d–ay_expÚ’t
) *

3445 (
NGTCP2_DURATION_TICK
 / 
NGTCP2_MICROSECONDS
);

3446 
	}
}

3463 
	$cÚn_»cv_max_¡»am_d©a
(
ngtı2_cÚn
 *
cÚn
,

3464 cÚ¡ 
ngtı2_max_¡»am_d©a
 *
ä
) {

3465 
ngtı2_¡rm
 *
¡rm
;

3466 
ngtı2_idŒ
 *
idŒ
;

3467 
loÿl_¡»am
 = 
	`cÚn_loÿl_¡»am
(
cÚn
, 
ä
->
¡»am_id
);

3468 
bidi
 = 
	`bidi_¡»am
(
ä
->
¡»am_id
);

3469 
rv
;

3471 ià(
bidi
) {

3472 ià(
loÿl_¡»am
) {

3473 ià(
cÚn
->
Ãxt_loÿl_¡»am_id_bidi
 <ğ
ä
->
¡»am_id
) {

3474  
NGTCP2_ERR_STREAM_STATE
;

3476 } ià(
cÚn
->
max_»mÙe_¡»am_id_bidi
 < 
ä
->
¡»am_id
) {

3477  
NGTCP2_ERR_STREAM_LIMIT
;

3480 
idŒ
 = &
cÚn
->
»mÙe_bidi_idŒ
;

3482 ià(!
loÿl_¡»am
) {

3483  
NGTCP2_ERR_PROTO
;

3485 ià(
cÚn
->
Ãxt_loÿl_¡»am_id_uni
 <ğ
ä
->
¡»am_id
) {

3486  
NGTCP2_ERR_PROTO
;

3489 
idŒ
 = &
cÚn
->
»mÙe_uni_idŒ
;

3492 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
ä
->
¡»am_id
);

3493 ià(
¡rm
 =ğ
NULL
) {

3494 ià(
loÿl_¡»am
) {

3499 
rv
 = 
	`ngtı2_idŒ_İ’
(
idŒ
, 
ä
->
¡»am_id
);

3500 ià(
rv
 != 0) {

3501 ià(
	`ngtı2_”r_is_çl
(
rv
)) {

3502  
rv
;

3504 
	`as£¹
(
rv
 =ğ
NGTCP2_ERR_STREAM_IN_USE
);

3509 
¡rm
 = 
	`ngtı2_mem_m®loc
(
cÚn
->
mem
, (
ngtı2_¡rm
));

3510 ià(
¡rm
 =ğ
NULL
) {

3511  
NGTCP2_ERR_NOMEM
;

3513 
rv
 = 
	`ngtı2_cÚn_š™_¡»am
(
cÚn
, 
¡rm
, 
ä
->
¡»am_id
, 
NULL
);

3514 ià(
rv
 != 0) {

3515 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, 
¡rm
);

3516  
rv
;

3520 
¡rm
->
max_tx_off£t
 = 
	`ngtı2_max
(¡rm->max_tx_off£t, 
ä
->
max_¡»am_d©a
);

3523 
	}
}

3528 
	$cÚn_»cv_max_d©a
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_max_d©a
 *
ä
) {

3529 
cÚn
->
max_tx_off£t
 = 
	`ngtı2_max
(cÚn->max_tx_off£t, 
ä
->
max_d©a
);

3530 
	}
}

3542 
	$cÚn_bufãr_pkt
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_pkt_chaš
 **
µc
,

3543 cÚ¡ 
ušt8_t
 *
pkt
, 
size_t
 
pk’
,

3544 
ngtı2_t¡amp
 
ts
) {

3545 
rv
;

3546 
ngtı2_pkt_chaš
 *
pc
;

3547 
size_t
 
i
;

3548 
i
 = 0; *
µc
 && i < 
NGTCP2_MAX_NUM_BUFFED_RX_PKTS
;

3549 
µc
 = &(*µc)->
Ãxt
, ++
i
)

3552 ià(
i
 =ğ
NGTCP2_MAX_NUM_BUFFED_RX_PKTS
) {

3556 
rv
 = 
	`ngtı2_pkt_chaš_Ãw
(&
pc
, 
pkt
, 
pk’
, 
ts
, 
cÚn
->
mem
);

3557 ià(
rv
 != 0) {

3558  
rv
;

3561 *
µc
 = 
pc
;

3564 
	}
}

3584 
	$cÚn_bufãr_´Ùeùed_pkt
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
pkt
,

3585 
size_t
 
pk’
, 
ngtı2_t¡amp
 
ts
) {

3586  
	`cÚn_bufãr_pkt
(
cÚn
, &cÚn->
bufãd_rx_µkts
, 
pkt
, 
pk’
, 
ts
);

3587 
	}
}

3600 
	$cÚn_bufãr_hªdshake_pkt
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
pkt
,

3601 
size_t
 
pk’
, 
ngtı2_t¡amp
 
ts
) {

3602  
	`cÚn_bufãr_pkt
(
cÚn
, &cÚn->
bufãd_rx_hs_pkts
, 
pkt
, 
pk’
, 
ts
);

3603 
	}
}

3615 
	$cÚn_’su»_deüy±_bufãr
(
ngtı2_cÚn
 *
cÚn
, 
size_t
 
n
) {

3616 
ušt8_t
 *
nbuf
;

3617 
size_t
 
Ën
;

3619 ià(
cÚn
->
deüy±_buf
.
Ën
 >ğ
n
) {

3623 
Ën
 = 
cÚn
->
deüy±_buf
.len == 0 ? 2048 : conn->decrypt_buf.len * 2;

3624 ; 
Ën
 < 
n
;†en *= 2)

3626 
nbuf
 = 
	`ngtı2_mem_»®loc
(
cÚn
->
mem
, cÚn->
deüy±_buf
.
ba£
, 
Ën
);

3627 ià(
nbuf
 =ğ
NULL
) {

3628  
NGTCP2_ERR_NOMEM
;

3630 
cÚn
->
deüy±_buf
.
ba£
 = 
nbuf
;

3631 
cÚn
->
deüy±_buf
.
Ën
 =†en;

3634 
	}
}

3653 
ssize_t
 
	$cÚn_deüy±_pkt
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
,

3654 
size_t
 
de¡Ën
, cÚ¡ 
ušt8_t
 *
·ylßd
,

3655 
size_t
 
·ylßdËn
, cÚ¡ 
ušt8_t
 *
ad
,

3656 
size_t
 
adËn
, 
ušt64_t
 
pkt_num
,

3657 
ngtı2_üy±o_km
 *
ckm
, 
ngtı2_deüy±
 
deüy±
) {

3659 
ušt8_t
 
nÚû
[64];

3660 
ssize_t
 
nwr™e
;

3662 
	`as£¹
((
nÚû
è>ğ
ckm
->
iv
.
Ën
);

3664 
	`ngtı2_üy±o_ü—‹_nÚû
(
nÚû
, 
ckm
->
iv
.
ba£
, ckm->iv.
Ën
, 
pkt_num
);

3666 
nwr™e
 =

3667 
	`deüy±
(
cÚn
, 
de¡
, 
de¡Ën
, 
·ylßd
, 
·ylßdËn
, 
ckm
->
key
.
ba£
,

3668 
ckm
->
key
.
Ën
, 
nÚû
, ckm->
iv
.Ën, 
ad
, 
adËn
, 
cÚn
->
u£r_d©a
);

3670 ià(
nwr™e
 < 0) {

3671 ià(
nwr™e
 =ğ
NGTCP2_ERR_TLS_DECRYPT
) {

3672  
nwr™e
;

3674  
NGTCP2_ERR_CALLBACK_FAILURE
;

3677  
nwr™e
;

3678 
	}
}

3695 
ssize_t
 
	$cÚn_deüy±_hp
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_pkt_hd
 *
hd
,

3696 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

3697 cÚ¡ 
ušt8_t
 *
pkt
, 
size_t
 
pk’
,

3698 
size_t
 
pkt_num_off£t
, 
ngtı2_üy±o_km
 *
ckm
,

3699 cÚ¡ 
ngtı2_vec
 *
hp
, 
ngtı2_hp_mask
 
hp_mask
,

3700 
size_t
 
«ad_ov”h—d
) {

3701 
ssize_t
 
nwr™e
;

3702 
size_t
 
§m¶e_off£t
;

3703 
ušt8_t
 *
p
 = 
de¡
;

3704 
ušt8_t
 
mask
[
NGTCP2_HP_SAMPLELEN
];

3705 
size_t
 
i
;

3707 
	`as£¹
(
hp_mask
);

3708 
	`as£¹
(
ckm
);

3709 
	`as£¹
(
«ad_ov”h—d
 >ğ
NGTCP2_HP_SAMPLELEN
);

3710 
	`as£¹
(
de¡Ën
 >ğ
pkt_num_off£t
 + 4);

3712 ià(
pkt_num_off£t
 + 
NGTCP2_HP_SAMPLELEN
 > 
pk’
) {

3713  
NGTCP2_ERR_PROTO
;

3716 
p
 = 
	`ngtı2_ıymem
Õ, 
pkt
, 
pkt_num_off£t
);

3718 
§m¶e_off£t
 = 
pkt_num_off£t
 + 4;

3720 
nwr™e
 = 
	`hp_mask
(
cÚn
, 
mask
, (mask), 
hp
->
ba£
, hp->
Ën
,

3721 
pkt
 + 
§m¶e_off£t
, 
NGTCP2_HP_SAMPLELEN
, 
cÚn
->
u£r_d©a
);

3722 ià(
nwr™e
 < 
NGTCP2_HP_MASKLEN
) {

3723  
NGTCP2_ERR_CALLBACK_FAILURE
;

3726 ià(
hd
->
æags
 & 
NGTCP2_PKT_FLAG_LONG_FORM
) {

3727 
de¡
[0] = (
ušt8_t
)(de¡[0] ^ (
mask
[0] & 0x0f));

3729 
de¡
[0] = (
ušt8_t
)(de¡[0] ^ (
mask
[0] & 0x1f));

3730 ià(
de¡
[0] & 
NGTCP2_SHORT_KEY_PHASE_BIT
) {

3731 
hd
->
æags
 |ğ
NGTCP2_PKT_FLAG_KEY_PHASE
;

3735 
hd
->
pkt_numËn
 = (
size_t
)((
de¡
[0] & 
NGTCP2_PKT_NUMLEN_MASK
) + 1);

3737 
i
 = 0; i < 
hd
->
pkt_numËn
; ++i) {

3738 *
p
++ = *(
pkt
 + 
pkt_num_off£t
 + 
i
è^ 
mask
[i + 1];

3741 
hd
->
pkt_num
 = 
	`ngtı2_g‘_pkt_num
(
p
 - hd->
pkt_numËn
, hd->pkt_numlen);

3743  
p
 - 
de¡
;

3744 
	}
}

3758 
	$cÚn_em™_³ndšg_üy±o_d©a
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
,

3759 
ušt64_t
 
rx_off£t
) {

3760 
size_t
 
d©®’
;

3761 cÚ¡ 
ušt8_t
 *
d©a
;

3762 
rv
;

3763 
ušt64_t
 
off£t
;

3766 
d©®’
 = 
	`ngtı2_rob_d©a_©
(&
¡rm
->
rob
, &
d©a
, 
rx_off£t
);

3767 ià(
d©®’
 == 0) {

3768 
	`as£¹
(
rx_off£t
 =ğ
	`ngtı2_¡rm_rx_off£t
(
¡rm
));

3772 
off£t
 = 
rx_off£t
;

3773 
rx_off£t
 +ğ
d©®’
;

3775 
rv
 = 
	`cÚn_ÿÎ_»cv_üy±o_d©a
(
cÚn
, 
off£t
, 
d©a
, 
d©®’
);

3776 ià(
rv
 != 0) {

3777  
rv
;

3780 
rv
 = 
	`ngtı2_rob_pİ
(&
¡rm
->
rob
, 
rx_off£t
 - 
d©®’
, datalen);

3781 ià(
rv
 != 0) {

3782  
rv
;

3785 
	}
}

3791 
	$cÚn_»cv_cÚÃùiÚ_şo£
(
ngtı2_cÚn
 *
cÚn
) {

3792 
cÚn
->
¡©e
 = 
NGTCP2_CS_DRAINING
;

3793 
	}
}

3795 
	$cÚn_»cv_·th_ch®Ënge
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_·th
 *
·th
,

3796 
ngtı2_·th_ch®Ënge
 *
ä
) {

3797 
ngtı2_·th_ch®Ënge_’Œy
 *
’t
;

3799 
’t
 = 
	`ngtı2_ršgbuf_push_äÚt
(&
cÚn
->
rx_·th_ch®Ënge
);

3800 
	`ngtı2_·th_ch®Ënge_’Œy_š™
(
’t
, 
·th
, 
ä
->
d©a
);

3801 
	}
}

3806 
ngtı2_du¿tiÚ
 
	$rcvry_¡©_compu‹_±o
(cÚ¡ 
ngtı2_rcvry_¡©
 *
rcs
) {

3807 
ušt64_t
 
timeout
 = (ušt64_t)(
rcs
->
smoÙhed_¹t
 + 4 *„cs->
¹tv¬
 +

3808 ()
rcs
->
max_ack_d–ay
);

3809 
timeout
 = 
	`ngtı2_max
Ñimeout, 
NGTCP2_GRANULARITY
);

3810 
timeout
 *ğ1uÎ << 
rcs
->
±o_couÁ
;

3812  
timeout
;

3813 
	}
}

3815 
	$cÚn_»cv_·th_»¥Ú£
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_·th
 *
·th
,

3816 
ngtı2_·th_»¥Ú£
 *
ä
) {

3817 
rv
;

3818 
ngtı2_pv
 *
pv
 = 
cÚn
->pv, *
Åv
 = 
NULL
;

3819 
ngtı2_du¿tiÚ
 
timeout
;

3821 ià(!
pv
) {

3825 
rv
 = 
	`ngtı2_pv_v®id©e
(
pv
, 
·th
, 
ä
->
d©a
);

3826 ià(
rv
 != 0) {

3830 ià(
pv
->
æags
 & 
NGTCP2_PV_FLAG_VERIFY_OLD_PATH_ON_SUCCESS
) {

3831 
timeout
 = 
	`rcvry_¡©_compu‹_±o
(&
cÚn
->
rcs
);

3832 
timeout
 = 
	`ngtı2_max
Ñimeout, 6 * 
NGTCP2_DEFAULT_INITIAL_RTT
);

3834 
rv
 = 
	`ngtı2_pv_Ãw
(&
Åv
, &
cÚn
->
dcid
, 
timeout
,

3835 
NGTCP2_PV_FLAG_DONT_CARE
 |

3836 
NGTCP2_PV_FLAG_RETIRE_DCID_ON_FINISH
,

3837 &
cÚn
->
log
, cÚn->
mem
);

3838 ià(
rv
 != 0) {

3839  
rv
;

3845 ià(!(
pv
->
æags
 & 
NGTCP2_PV_FLAG_DONT_CARE
)) {

3846 
	`ngtı2_dcid_cİy
(&
cÚn
->
dcid
, &
pv
->dcid);

3848 
rv
 = 
	`cÚn_ÿÎ_·th_v®id©iÚ
(
cÚn
, &
pv
->
dcid
.
·th
,

3849 
NGTCP2_PATH_VALIDATION_RESULT_SUCCESS
);

3850 ià(
rv
 != 0) {

3851 
ç
;

3855 
rv
 = 
	`cÚn_¡İ_pv
(
cÚn
);

3856 ià(
rv
 != 0) {

3857 
ç
;

3860 
cÚn
->
pv
 = 
Åv
;

3864 
ç
:

3865 
	`ngtı2_pv_d–
(
Åv
);

3867  
rv
;

3868 
	}
}

3873 
	$cÚn_upd©e_rx_bw
(
ngtı2_cÚn
 *
cÚn
, 
size_t
 
d©®’
,

3874 
ngtı2_t¡amp
 
ts
) {

3876 ià(
ts
 - 
cÚn
->
fœ¡_rx_bw_ts
 > 
NGTCP2_SECONDS
) {

3877 
cÚn
->
fœ¡_rx_bw_ts
 = 
ts
;

3878 
cÚn
->
rx_bw_d©®’
 = 
d©®’
;

3879 
cÚn
->
rx_bw
 = 0.;

3883 
cÚn
->
rx_bw_d©®’
 +ğ
d©®’
;

3885 ià(
ts
 - 
cÚn
->
fœ¡_rx_bw_ts
 >ğ25 * 
NGTCP2_MILLISECONDS
) {

3886 
cÚn
->
rx_bw
 =

3887 ()
cÚn
->
rx_bw_d©®’
 / ()(
ts
 - cÚn->
fœ¡_rx_bw_ts
);

3889 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_CON
, "rx_bw=%.02fBs",

3890 
cÚn
->
rx_bw
 * 
NGTCP2_DURATION_TICK
);

3892 
	}
}

3898 
size_t
 
	$pkt_num_b™s
(
size_t
 
pkt_numËn
) {

3899 
pkt_numËn
) {

3909 
	`as£¹
(0);

3911 
	}
}

3917 
	$pkŠs_pkt_num_is_du¶iÿ‹
(
ngtı2_pkŠs
 *
pkŠs
, 
ušt64_t
 
pkt_num
) {

3918  
	`ngtı2_g­Œ_is_pushed
(&
pkŠs
->
²g­
, 
pkt_num
, 1);

3919 
	}
}

3925 
	$pkŠs_comm™_»cv_pkt_num
(
ngtı2_pkŠs
 *
pkŠs
, 
ušt64_t
 
pkt_num
) {

3926 
rv
;

3927 
ngtı2_p¦_™
 
™
;

3928 
ngtı2_¿nge
 
key
;

3930 ià(
pkŠs
->
max_rx_pkt_num
 + 1 !ğ
pkt_num
) {

3931 
	`ngtı2_ackŒ_immedŸ‹_ack
(&
pkŠs
->
ackŒ
);

3933 ià(
pkŠs
->
max_rx_pkt_num
 =ğ(
ušt64_t
)-1 ||

3934 
pkŠs
->
max_rx_pkt_num
 < 
pkt_num
) {

3935 
pkŠs
->
max_rx_pkt_num
 = 
pkt_num
;

3938 
rv
 = 
	`ngtı2_g­Œ_push
(&
pkŠs
->
²g­
, 
pkt_num
, 1);

3939 ià(
rv
 != 0) {

3940  
rv
;

3943 ià(
	`ngtı2_p¦_Ën
(&
pkŠs
->
²g­
.
g­
) > 256) {

3944 
™
 = 
	`ngtı2_p¦_begš
(&
pkŠs
->
²g­
.
g­
);

3945 
key
 = 
	`ngtı2_p¦_™_¿nge
(&
™
);

3946  
	`ngtı2_p¦_»move
(&
pkŠs
->
²g­
.
g­
, 
NULL
, &
key
);

3950 
	}
}

3955 
	$cÚn_disÿrd_š™Ÿl_key
(
ngtı2_cÚn
 *
cÚn
) {

3956 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->
š_pkŠs
;

3958 ià(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_INITIAL_KEY_DISCARDED
) {

3962 
cÚn
->
æags
 |ğ
NGTCP2_CONN_FLAG_INITIAL_KEY_DISCARDED
;

3964 
	`ngtı2_üy±o_km_d–
(
pkŠs
->
tx_ckm
, 
cÚn
->
mem
);

3965 
	`ngtı2_üy±o_km_d–
(
pkŠs
->
rx_ckm
, 
cÚn
->
mem
);

3967 
pkŠs
->
tx_ckm
 = 
NULL
;

3968 
pkŠs
->
rx_ckm
 = 
NULL
;

3970 
	`ngtı2_¹b_ş—r
(&
pkŠs
->
¹b
);

3971 
	`ngtı2_ackŒ_comm™_ack
(&
pkŠs
->
ackŒ
);

3972 
	}
}

3974 
cÚn_»cv_üy±o
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
rx_off£t_ba£
,

3975 
ušt64_t
 
max_rx_off£t
, cÚ¡ 
ngtı2_üy±o
 *
ä
);

3977 
ssize_t
 
cÚn_»cv_pkt
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_·th
 *
·th
,

3978 cÚ¡ 
ušt8_t
 *
pkt
, 
size_t
 
pk’
,

3979 
ngtı2_t¡amp
 
ts
);

4011 
ssize_t
 
	$cÚn_»cv_hªdshake_pkt
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
pkt
,

4012 
size_t
 
pk’
, 
ngtı2_t¡amp
 
ts
) {

4013 
ssize_t
 
Ä—d
;

4014 
ngtı2_pkt_hd
 
hd
;

4015 
ngtı2_max_äame
 
mä
;

4016 
ngtı2_äame
 *
ä
 = &
mä
.fr;

4017 
rv
;

4018 
»quœe_ack
 = 0;

4019 
size_t
 
hdpk’
;

4020 cÚ¡ 
ušt8_t
 *
·ylßd
;

4021 
size_t
 
·ylßdËn
;

4022 
ssize_t
 
nwr™e
;

4023 
ušt8_t
 
¶aš_hdpkt
[1500];

4024 
ngtı2_üy±o_km
 *
ckm
;

4025 cÚ¡ 
ngtı2_vec
 *
hp
;

4026 
ngtı2_hp_mask
 
hp_mask
;

4027 
ngtı2_deüy±
 
deüy±
;

4028 
size_t
 
«ad_ov”h—d
;

4029 
ngtı2_pkŠs
 *
pkŠs
;

4030 
ngtı2_¡rm
 *
üy±o
 = &
cÚn
->crypto;

4031 
ušt64_t
 
max_üy±o_rx_off£t
;

4032 
size_t
 
odc
;

4034 ià(
pk’
 == 0) {

4038 ià(!(
pkt
[0] & 
NGTCP2_HEADER_FORM_BIT
)) {

4039 ià(
cÚn
->
¡©e
 =ğ
NGTCP2_CS_SERVER_INITIAL
) {

4042  (
ssize_t
)
pk’
;

4045 ià(
cÚn
->
pkŠs
.
rx_ckm
) {

4046 
Ä—d
 = 
	`cÚn_»cv_pkt
(
cÚn
, &cÚn->
dcid
.
·th
, 
pkt
, 
pk’
, 
ts
);

4047 ià(
Ä—d
 < 0) {

4048  
Ä—d
;

4051  (
ssize_t
)
pk’
;

4054 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_CON
,

4055 "bufãršg ShÜˆ·ck‘†’=%zu", 
pk’
);

4057 
rv
 = 
	`cÚn_bufãr_´Ùeùed_pkt
(
cÚn
, 
pkt
, 
pk’
, 
ts
);

4058 ià(
rv
 != 0) {

4059 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

4060  
rv
;

4062  (
ssize_t
)
pk’
;

4065 
Ä—d
 = 
	`ngtı2_pkt_decode_hd_lÚg
(&
hd
, 
pkt
, 
pk’
);

4066 ià(
Ä—d
 < 0) {

4067  
NGTCP2_ERR_DISCARD_PKT
;

4070 
hd
.
ty³
) {

4071 
NGTCP2_PKT_VERSION_NEGOTIATION
:

4072 
hdpk’
 = (
size_t
)
Ä—d
;

4074 
	`ngtı2_log_rx_pkt_hd
(&
cÚn
->
log
, &
hd
);

4076 ià(
cÚn
->
£rv”
) {

4077  
NGTCP2_ERR_DISCARD_PKT
;

4082 ià(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_CONN_ID_NEGOTIATED
) {

4083  
NGTCP2_ERR_DISCARD_PKT
;

4087 
rv
 = 
	`cÚn_v”ify_dcid
(
cÚn
, &
hd
);

4088 ià(
rv
 != 0) {

4089 ià(
	`ngtı2_”r_is_çl
(
rv
)) {

4090  
rv
;

4092 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

4094  
NGTCP2_ERR_DISCARD_PKT
;

4097 ià(!
	`ngtı2_cid_eq
(&
cÚn
->
dcid
.
cid
, &
hd
.
scid
)) {

4099 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

4101  
NGTCP2_ERR_DISCARD_PKT
;

4103 
rv
 = 
	`cÚn_Ú_v”siÚ_ÃgÙŸtiÚ
(
cÚn
, &
hd
, 
pkt
 + 
hdpk’
,

4104 
pk’
 - 
hdpk’
);

4105 ià(
rv
 != 0) {

4106 ià(
	`ngtı2_”r_is_çl
(
rv
)) {

4107  
rv
;

4109  
NGTCP2_ERR_DISCARD_PKT
;

4111  
NGTCP2_ERR_RECV_VERSION_NEGOTIATION
;

4112 
NGTCP2_PKT_RETRY
:

4113 
hdpk’
 = (
size_t
)
Ä—d
;

4115 
	`ngtı2_log_rx_pkt_hd
(&
cÚn
->
log
, &
hd
);

4117 ià(
cÚn
->
£rv”
) {

4118  
NGTCP2_ERR_DISCARD_PKT
;

4123 ià(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_CONN_ID_NEGOTIATED
) {

4124  
NGTCP2_ERR_DISCARD_PKT
;

4127 
odc
 = 
pkt
[0] & 0x0f;

4128 ià(
odc
) {

4129 
odc
 += 3;

4131 
rv
 = 
	`cÚn_Ú_»Œy
(
cÚn
, &
hd
, 
odc
, 
pkt
 + 
hdpk’
, 
pk’
 - hdpktlen);

4132 ià(
rv
 != 0) {

4133 ià(
	`ngtı2_”r_is_çl
(
rv
)) {

4134  
rv
;

4136  
NGTCP2_ERR_DISCARD_PKT
;

4138  (
ssize_t
)
pk’
;

4141 ià(
pk’
 < (
size_t
)
Ä—d
 + 
hd
.
Ën
) {

4142  
NGTCP2_ERR_DISCARD_PKT
;

4145 
pk’
 = (
size_t
)
Ä—d
 + 
hd
.
Ën
;

4147 ià(
cÚn
->
v”siÚ
 !ğ
hd
.version) {

4148  
NGTCP2_ERR_DISCARD_PKT
;

4153 ià((
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_CONN_ID_NEGOTIATED
) &&

4154 !
	`ngtı2_cid_eq
(&
cÚn
->
dcid
.
cid
, &
hd
.
scid
)) {

4155 
	`ngtı2_log_rx_pkt_hd
(&
cÚn
->
log
, &
hd
);

4156 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

4158  
NGTCP2_ERR_DISCARD_PKT
;

4161 
hd
.
ty³
) {

4162 
NGTCP2_PKT_0RTT_PROTECTED
:

4163 ià(!
cÚn
->
£rv”
) {

4164  
NGTCP2_ERR_DISCARD_PKT
;

4166 ià(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_CONN_ID_NEGOTIATED
) {

4167 ià(
cÚn
->
—¾y_ckm
) {

4168 
ssize_t
 
Ä—d2
;

4170 
Ä—d2
 = 
	`cÚn_»cv_pkt
(
cÚn
, &cÚn->
dcid
.
·th
, 
pkt
, 
pk’
, 
ts
);

4171 ià(
Ä—d2
 < 0) {

4172  
Ä—d2
;

4177  (
ssize_t
)
pk’
;

4181 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_CON
,

4182 "bufãršg 0-RTT PrÙeùed…ack‘†’=%zu", 
pk’
);

4184 
rv
 = 
	`cÚn_bufãr_´Ùeùed_pkt
(
cÚn
, 
pkt
, 
pk’
, 
ts
);

4185 ià(
rv
 != 0) {

4186 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

4187  
rv
;

4189  (
ssize_t
)
pk’
;

4190 
NGTCP2_PKT_INITIAL
:

4191 ià(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_INITIAL_KEY_DISCARDED
) {

4192 
	`ngtı2_log_šfo
(

4193 &
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

4195  (
ssize_t
)
pk’
;

4198 ià(
cÚn
->
£rv”
) {

4199 ià((
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_CONN_ID_NEGOTIATED
) == 0) {

4200 
rv
 = 
	`cÚn_ÿÎ_»cv_ş›Á_š™Ÿl
(
cÚn
, &
hd
.
dcid
);

4201 ià(
rv
 != 0) {

4202  
rv
;

4205 } ià(
hd
.
tok’Ën
 != 0) {

4206 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

4208  
NGTCP2_ERR_DISCARD_PKT
;

4211 
pkŠs
 = &
cÚn
->
š_pkŠs
;

4212 
hp_mask
 = 
cÚn
->
ÿÎbacks
.
š_hp_mask
;

4213 
deüy±
 = 
cÚn
->
ÿÎbacks
.
š_deüy±
;

4214 
«ad_ov”h—d
 = 
NGTCP2_INITIAL_AEAD_OVERHEAD
;

4215 
max_üy±o_rx_off£t
 = 
cÚn
->
hs_pkŠs
.
üy±o_rx_off£t_ba£
;

4218 
NGTCP2_PKT_HANDSHAKE
:

4219 ià(!
cÚn
->
hs_pkŠs
.
rx_ckm
) {

4220 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_CON
,

4221 "bufãršg Hªdshak·ck‘†’=%zu", 
pk’
);

4223 
rv
 = 
	`cÚn_bufãr_hªdshake_pkt
(
cÚn
, 
pkt
, 
pk’
, 
ts
);

4224 ià(
rv
 != 0) {

4225 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

4226  
rv
;

4228  (
ssize_t
)
pk’
;

4231 
pkŠs
 = &
cÚn
->
hs_pkŠs
;

4232 
hp_mask
 = 
cÚn
->
ÿÎbacks
.hp_mask;

4233 
deüy±
 = 
cÚn
->
ÿÎbacks
.decrypt;

4234 
«ad_ov”h—d
 = 
cÚn
->aead_overhead;

4235 
max_üy±o_rx_off£t
 = 
cÚn
->
pkŠs
.
üy±o_rx_off£t_ba£
;

4240 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

4242  (
ssize_t
)
pk’
;

4245 
ckm
 = 
pkŠs
->
rx_ckm
;

4246 
hp
 = 
pkŠs
->
rx_hp
;

4248 
	`as£¹
(
ckm
);

4249 
	`as£¹
(
hp_mask
);

4250 
	`as£¹
(
deüy±
);

4252 
nwr™e
 =

4253 
	`cÚn_deüy±_hp
(
cÚn
, &
hd
, 
¶aš_hdpkt
, ÕÏš_hdpkt), 
pkt
, 
pk’
,

4254 (
size_t
)
Ä—d
, 
ckm
, 
hp
, 
hp_mask
, 
«ad_ov”h—d
);

4255 ià(
nwr™e
 < 0) {

4256 ià(
	`ngtı2_”r_is_çl
(()
nwr™e
)) {

4257  
nwr™e
;

4259 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

4261  
NGTCP2_ERR_DISCARD_PKT
;

4264 
hdpk’
 = (
size_t
)
nwr™e
;

4265 
·ylßd
 = 
pkt
 + 
hdpk’
;

4266 
·ylßdËn
 = 
hd
.
Ën
 - hd.
pkt_numËn
;

4268 
hd
.
pkt_num
 = 
	`ngtı2_pkt_adju¡_pkt_num
(
pkŠs
->
max_rx_pkt_num
, hd.pkt_num,

4269 
	`pkt_num_b™s
(
hd
.
pkt_numËn
));

4271 
	`ngtı2_log_rx_pkt_hd
(&
cÚn
->
log
, &
hd
);

4273 
rv
 = 
	`ngtı2_pkt_v”ify_»£rved_b™s
(
¶aš_hdpkt
[0]);

4274 ià(
rv
 != 0) {

4275 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

4277  
rv
;

4280 ià(
	`pkŠs_pkt_num_is_du¶iÿ‹
(
pkŠs
, 
hd
.
pkt_num
)) {

4281 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

4283  
NGTCP2_ERR_DISCARD_PKT
;

4286 
rv
 = 
	`cÚn_’su»_deüy±_bufãr
(
cÚn
, 
·ylßdËn
);

4287 ià(
rv
 != 0) {

4288  
rv
;

4291 
nwr™e
 = 
	`cÚn_deüy±_pkt
(
cÚn
, cÚn->
deüy±_buf
.
ba£
, 
·ylßdËn
, 
·ylßd
,

4292 
·ylßdËn
, 
¶aš_hdpkt
, 
hdpk’
, 
hd
.
pkt_num
, 
ckm
,

4293 
deüy±
);

4294 ià(
nwr™e
 < 0) {

4295 ià(
	`ngtı2_”r_is_çl
(()
nwr™e
)) {

4296  
nwr™e
;

4298 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

4300  
NGTCP2_ERR_DISCARD_PKT
;

4303 
·ylßd
 = 
cÚn
->
deüy±_buf
.
ba£
;

4304 
·ylßdËn
 = (
size_t
)
nwr™e
;

4306 
hd
.
ty³
) {

4307 
NGTCP2_PKT_INITIAL
:

4308 ià(!
cÚn
->
£rv”
 || ((cÚn->
æags
 & 
NGTCP2_CONN_FLAG_CONN_ID_NEGOTIATED
) &&

4309 !
	`ngtı2_cid_eq
(&
cÚn
->
rcid
, &
hd
.
dcid
))) {

4310 
rv
 = 
	`cÚn_v”ify_dcid
(
cÚn
, &
hd
);

4311 ià(
rv
 != 0) {

4312 ià(
	`ngtı2_”r_is_çl
(
rv
)) {

4313  
rv
;

4315 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

4317  
NGTCP2_ERR_DISCARD_PKT
;

4321 
NGTCP2_PKT_HANDSHAKE
:

4322 
rv
 = 
	`cÚn_v”ify_dcid
(
cÚn
, &
hd
);

4323 ià(
rv
 != 0) {

4324 ià(
	`ngtı2_”r_is_çl
(
rv
)) {

4325  
rv
;

4327 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

4329  
NGTCP2_ERR_DISCARD_PKT
;

4333 
	`as£¹
(0);

4336 ià(
·ylßdËn
 == 0) {

4338  
NGTCP2_ERR_DISCARD_PKT
;

4341 ià(
hd
.
ty³
 =ğ
NGTCP2_PKT_INITIAL
 &&

4342 !(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_CONN_ID_NEGOTIATED
)) {

4343 
cÚn
->
æags
 |ğ
NGTCP2_CONN_FLAG_CONN_ID_NEGOTIATED
;

4344 ià(
cÚn
->
£rv”
) {

4345 
cÚn
->
rcid
 = 
hd
.
dcid
;

4347 
cÚn
->
dcid
.
cid
 = 
hd
.
scid
;

4351 ; 
·ylßdËn
;) {

4352 
Ä—d
 = 
	`ngtı2_pkt_decode_äame
(
ä
, 
·ylßd
, 
·ylßdËn
);

4353 ià(
Ä—d
 < 0) {

4354  ()
Ä—d
;

4357 
·ylßd
 +ğ
Ä—d
;

4358 
·ylßdËn
 -ğ(
size_t
)
Ä—d
;

4360 ià(
ä
->
ty³
 =ğ
NGTCP2_FRAME_ACK
) {

4361 
	`assign_»cved_ack_d–ay_unsÿËd
(&
ä
->
ack
,

4362 
NGTCP2_DEFAULT_ACK_DELAY_EXPONENT
);

4365 
	`ngtı2_log_rx_ä
(&
cÚn
->
log
, &
hd
, 
ä
);

4367 
ä
->
ty³
) {

4368 
NGTCP2_FRAME_ACK
:

4369 
NGTCP2_FRAME_ACK_ECN
:

4370 
rv
 = 
	`cÚn_»cv_ack
(
cÚn
, 
pkŠs
, &
ä
->
ack
, 
ts
);

4371 ià(
rv
 != 0) {

4372  
rv
;

4375 
NGTCP2_FRAME_PADDING
:

4377 
NGTCP2_FRAME_CRYPTO
:

4378 
rv
 = 
	`cÚn_»cv_üy±o
(
cÚn
, 
pkŠs
->
üy±o_rx_off£t_ba£
,

4379 
max_üy±o_rx_off£t
, &
ä
->
üy±o
);

4380 ià(
rv
 != 0) {

4381  
rv
;

4383 
»quœe_ack
 = 1;

4385 
NGTCP2_FRAME_CONNECTION_CLOSE
:

4386 
	`cÚn_»cv_cÚÃùiÚ_şo£
(
cÚn
);

4388 
NGTCP2_FRAME_CONNECTION_CLOSE_APP
:

4389 ià(
ä
->
ty³
 !ğ
NGTCP2_PKT_HANDSHAKE
) {

4390  
NGTCP2_ERR_PROTO
;

4392 
	`cÚn_»cv_cÚÃùiÚ_şo£
(
cÚn
);

4395  
NGTCP2_ERR_PROTO
;

4399 ià(
cÚn
->
£rv”
) {

4400 
hd
.
ty³
) {

4401 
NGTCP2_PKT_INITIAL
:

4402 ià(
	`ngtı2_rob_fœ¡_g­_off£t
(&
üy±o
->
rob
) == 0) {

4403  
NGTCP2_ERR_PROTO
;

4406 
NGTCP2_PKT_HANDSHAKE
:

4407 ià(
cÚn
->
£rv”
 && 
hd
.
ty³
 =ğ
NGTCP2_PKT_HANDSHAKE
) {

4410 
cÚn
->
æags
 |ğ
NGTCP2_CONN_FLAG_SADDR_VERIFIED
;

4416 
rv
 = 
	`pkŠs_comm™_»cv_pkt_num
(
pkŠs
, 
hd
.
pkt_num
);

4417 ià(
rv
 != 0) {

4418  
rv
;

4421 ià(
»quœe_ack
 && ++
pkŠs
->
ackŒ
.
rx_Åkt
 >ğ
NGTCP2_NUM_IMMEDIATE_ACK_PKT
) {

4422 
	`ngtı2_ackŒ_immedŸ‹_ack
(&
pkŠs
->
ackŒ
);

4425 
rv
 = 
	`ngtı2_cÚn_sched_ack
(
cÚn
, &
pkŠs
->
ackŒ
, 
hd
.
pkt_num
, 
»quœe_ack
, 
ts
);

4426 ià(
rv
 != 0) {

4427  
rv
;

4430  
cÚn
->
¡©e
 =ğ
NGTCP2_CS_DRAINING
 ? 
NGTCP2_ERR_DRAINING


4431 : (
ssize_t
)
pk’
;

4432 
	}
}

4443 
	$cÚn_»cv_hªdshake_ıkt
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
pkt
,

4444 
size_t
 
pk’
, 
ngtı2_t¡amp
 
ts
) {

4445 
ssize_t
 
Ä—d
;

4446 
size_t
 
ÜigËn
 = 
pk’
;

4448 
pk’
) {

4449 
Ä—d
 = 
	`cÚn_»cv_hªdshake_pkt
(
cÚn
, 
pkt
, 
pk’
, 
ts
);

4450 ià(
Ä—d
 < 0) {

4451 ià(
	`ngtı2_”r_is_çl
(()
Ä—d
)) {

4452  ()
Ä—d
;

4454 ià(
Ä—d
 =ğ
NGTCP2_ERR_DISCARD_PKT
) {

4457 ià(
Ä—d
 !ğ
NGTCP2_ERR_CRYPTO
 && (
pkt
[0] & 
NGTCP2_HEADER_FORM_BIT
) &&

4458 
	`ngtı2_pkt_g‘_ty³_lÚg
(
pkt
[0]è=ğ
NGTCP2_PKT_INITIAL
) {

4461  ()
Ä—d
;

4464 
	`as£¹
(
pk’
 >ğ(
size_t
)
Ä—d
);

4465 
pkt
 +ğ
Ä—d
;

4466 
pk’
 -ğ(
size_t
)
Ä—d
;

4468 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

4469 "»ad…ack‘ %zd†eá %zu", 
Ä—d
, 
pk’
);

4472 
cÚn
->
hs_»cved
 +ğ
ÜigËn
;

4475 
	}
}

4477 
	$ngtı2_cÚn_š™_¡»am
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
,

4478 
ušt64_t
 
¡»am_id
, *
¡»am_u£r_d©a
) {

4479 
rv
;

4480 
ušt64_t
 
max_rx_off£t
;

4481 
ušt64_t
 
max_tx_off£t
;

4482 
loÿl_¡»am
 = 
	`cÚn_loÿl_¡»am
(
cÚn
, 
¡»am_id
);

4484 ià(
	`bidi_¡»am
(
¡»am_id
)) {

4485 ià(
loÿl_¡»am
) {

4486 
max_rx_off£t
 = 
cÚn
->
loÿl_£‰šgs
.
max_¡»am_d©a_bidi_loÿl
;

4487 
max_tx_off£t
 = 
cÚn
->
»mÙe_£‰šgs
.
max_¡»am_d©a_bidi_»mÙe
;

4489 
max_rx_off£t
 = 
cÚn
->
loÿl_£‰šgs
.
max_¡»am_d©a_bidi_»mÙe
;

4490 
max_tx_off£t
 = 
cÚn
->
»mÙe_£‰šgs
.
max_¡»am_d©a_bidi_loÿl
;

4492 } ià(
loÿl_¡»am
) {

4493 
max_rx_off£t
 = 0;

4494 
max_tx_off£t
 = 
cÚn
->
»mÙe_£‰šgs
.
max_¡»am_d©a_uni
;

4496 
max_rx_off£t
 = 
cÚn
->
loÿl_£‰šgs
.
max_¡»am_d©a_uni
;

4497 
max_tx_off£t
 = 0;

4500 
rv
 = 
	`ngtı2_¡rm_š™
(
¡rm
, 
¡»am_id
, 
NGTCP2_STRM_FLAG_NONE
, 
max_rx_off£t
,

4501 
max_tx_off£t
, 
¡»am_u£r_d©a
, 
cÚn
->
mem
);

4502 ià(
rv
 != 0) {

4503  
rv
;

4506 
rv
 = 
	`ngtı2_m­_š£¹
(&
cÚn
->
¡rms
, &
¡rm
->
me
);

4507 ià(
rv
 != 0) {

4508 
	`as£¹
(
rv
 !ğ
NGTCP2_ERR_INVALID_ARGUMENT
);

4509 
ç
;

4512 ià(!
	`cÚn_loÿl_¡»am
(
cÚn
, 
¡»am_id
)) {

4513 
rv
 = 
	`cÚn_ÿÎ_¡»am_İ’
(
cÚn
, 
¡rm
);

4514 ià(
rv
 != 0) {

4515 
ç
;

4521 
ç
:

4522 
	`ngtı2_¡rm_ä“
(
¡rm
);

4523  
rv
;

4524 
	}
}

4542 
	$cÚn_em™_³ndšg_¡»am_d©a
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
,

4543 
ušt64_t
 
rx_off£t
) {

4544 
size_t
 
d©®’
;

4545 cÚ¡ 
ušt8_t
 *
d©a
;

4546 
rv
;

4547 
ušt64_t
 
off£t
;

4550 
d©®’
 = 
	`ngtı2_rob_d©a_©
(&
¡rm
->
rob
, &
d©a
, 
rx_off£t
);

4551 ià(
d©®’
 == 0) {

4552 
	`as£¹
(
rx_off£t
 =ğ
	`ngtı2_¡rm_rx_off£t
(
¡rm
));

4556 
off£t
 = 
rx_off£t
;

4557 
rx_off£t
 +ğ
d©®’
;

4559 
rv
 = 
	`cÚn_ÿÎ_»cv_¡»am_d©a
(
cÚn
, 
¡rm
,

4560 (
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_SHUT_RD
) &&

4561 
rx_off£t
 =ğ
¡rm
->
Ï¡_rx_off£t
,

4562 
off£t
, 
d©a
, 
d©®’
);

4563 ià(
rv
 != 0) {

4564  
rv
;

4567 
rv
 = 
	`ngtı2_rob_pİ
(&
¡rm
->
rob
, 
rx_off£t
 - 
d©®’
, datalen);

4568 ià(
rv
 != 0) {

4569  
rv
;

4572 
	}
}

4593 
	$cÚn_»cv_üy±o
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
rx_off£t_ba£
,

4594 
ušt64_t
 
max_rx_off£t
, cÚ¡ 
ngtı2_üy±o
 *
ä
) {

4595 
ngtı2_¡rm
 *
üy±o
 = &
cÚn
->crypto;

4596 
ušt64_t
 
ä_’d_off£t
;

4597 
ušt64_t
 
rx_off£t
;

4598 
rv
;

4600 ià(
ä
->
d©aút
 == 0) {

4604 
ä_’d_off£t
 = 
rx_off£t_ba£
 + 
ä
->
off£t
 + fr->
d©a
[0].
Ën
;

4606 ià(
max_rx_off£t
 && max_rx_off£ˆ< 
ä_’d_off£t
) {

4607  
NGTCP2_ERR_PROTO
;

4610 ià(
üy±o
->
max_rx_off£t
 && cry±o->max_rx_off£ˆ< 
ä_’d_off£t
) {

4611  
NGTCP2_ERR_PROTO
;

4614 
rx_off£t
 = 
	`ngtı2_¡rm_rx_off£t
(
üy±o
);

4616 ià(
ä_’d_off£t
 <ğ
rx_off£t
) {

4620 
üy±o
->
Ï¡_rx_off£t
 = 
	`ngtı2_max
(üy±o->Ï¡_rx_off£t, 
ä_’d_off£t
);

4627 ià(
rx_off£t_ba£
 + 
ä
->
off£t
 <ğ
rx_off£t
) {

4628 
size_t
 
ncut
 = 
rx_off£t
 - 
ä
->
off£t
 - 
rx_off£t_ba£
;

4629 cÚ¡ 
ušt8_t
 *
d©a
 = 
ä
->d©a[0].
ba£
 + 
ncut
;

4630 
size_t
 
d©®’
 = 
ä
->
d©a
[0].
Ën
 - 
ncut
;

4631 
ušt64_t
 
off£t
 = 
rx_off£t
;

4633 
rx_off£t
 +ğ
d©®’
;

4634 
rv
 = 
	`ngtı2_rob_»move_´efix
(&
üy±o
->
rob
, 
rx_off£t
);

4635 ià(
rv
 != 0) {

4636  
rv
;

4639 
rv
 = 
	`cÚn_ÿÎ_»cv_üy±o_d©a
(
cÚn
, 
off£t
, 
d©a
, 
d©®’
);

4640 ià(
rv
 != 0) {

4641  
rv
;

4644 
rv
 = 
	`cÚn_em™_³ndšg_üy±o_d©a
(
cÚn
, 
üy±o
, 
rx_off£t
);

4645 ià(
rv
 != 0) {

4646  
rv
;

4649 
rv
 = 
	`ngtı2_¡rm_»cv_»Üd”šg
(
üy±o
, 
ä
->
d©a
[0].
ba£
, fr->d©a[0].
Ën
,

4650 
rx_off£t_ba£
 + 
ä
->
off£t
);

4651 ià(
rv
 != 0) {

4652  
rv
;

4657 
	}
}

4663 
	$cÚn_max_d©a_viŞ©ed
(
ngtı2_cÚn
 *
cÚn
, 
size_t
 
d©®’
) {

4664  
cÚn
->
max_rx_off£t
 - cÚn->
rx_off£t
 < 
d©®’
;

4665 
	}
}

4692 
	$cÚn_»cv_¡»am
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_¡»am
 *
ä
) {

4693 
rv
;

4694 
ngtı2_¡rm
 *
¡rm
;

4695 
ngtı2_idŒ
 *
idŒ
;

4696 
ušt64_t
 
rx_off£t
, 
ä_’d_off£t
;

4697 
loÿl_¡»am
;

4698 
bidi
;

4699 
size_t
 
d©®’
 = 
	`ngtı2_vec_Ën
(
ä
->
d©a
, fr->
d©aút
);

4701 
loÿl_¡»am
 = 
	`cÚn_loÿl_¡»am
(
cÚn
, 
ä
->
¡»am_id
);

4702 
bidi
 = 
	`bidi_¡»am
(
ä
->
¡»am_id
);

4704 ià(
bidi
) {

4705 ià(
loÿl_¡»am
) {

4706 ià(
cÚn
->
Ãxt_loÿl_¡»am_id_bidi
 <ğ
ä
->
¡»am_id
) {

4707  
NGTCP2_ERR_STREAM_STATE
;

4709 } ià(
cÚn
->
max_»mÙe_¡»am_id_bidi
 < 
ä
->
¡»am_id
) {

4710  
NGTCP2_ERR_STREAM_LIMIT
;

4713 
idŒ
 = &
cÚn
->
»mÙe_bidi_idŒ
;

4715 ià(
loÿl_¡»am
) {

4716  
NGTCP2_ERR_PROTO
;

4718 ià(
cÚn
->
max_»mÙe_¡»am_id_uni
 < 
ä
->
¡»am_id
) {

4719  
NGTCP2_ERR_STREAM_LIMIT
;

4722 
idŒ
 = &
cÚn
->
»mÙe_uni_idŒ
;

4725 ià(
NGTCP2_MAX_VARINT
 - 
d©®’
 < 
ä
->
off£t
) {

4726  
NGTCP2_ERR_PROTO
;

4729 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
ä
->
¡»am_id
);

4730 ià(
¡rm
 =ğ
NULL
) {

4731 ià(
loÿl_¡»am
) {

4737 
rv
 = 
	`ngtı2_idŒ_İ’
(
idŒ
, 
ä
->
¡»am_id
);

4738 ià(
rv
 != 0) {

4739 ià(
	`ngtı2_”r_is_çl
(
rv
)) {

4740  
rv
;

4742 
	`as£¹
(
rv
 =ğ
NGTCP2_ERR_STREAM_IN_USE
);

4748 
¡rm
 = 
	`ngtı2_mem_m®loc
(
cÚn
->
mem
, (
ngtı2_¡rm
));

4749 ià(
¡rm
 =ğ
NULL
) {

4750  
NGTCP2_ERR_NOMEM
;

4753 
rv
 = 
	`ngtı2_cÚn_š™_¡»am
(
cÚn
, 
¡rm
, 
ä
->
¡»am_id
, 
NULL
);

4754 ià(
rv
 != 0) {

4755 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, 
¡rm
);

4756  
rv
;

4758 ià(!
bidi
) {

4759 
	`ngtı2_¡rm_shutdown
(
¡rm
, 
NGTCP2_STRM_FLAG_SHUT_WR
);

4763 
ä_’d_off£t
 = 
ä
->
off£t
 + 
d©®’
;

4765 ià(
¡rm
->
max_rx_off£t
 < 
ä_’d_off£t
) {

4766  
NGTCP2_ERR_FLOW_CONTROL
;

4769 ià(
¡rm
->
Ï¡_rx_off£t
 < 
ä_’d_off£t
) {

4770 
size_t
 
Ën
 = 
ä_’d_off£t
 - 
¡rm
->
Ï¡_rx_off£t
;

4772 ià(
	`cÚn_max_d©a_viŞ©ed
(
cÚn
, 
Ën
)) {

4773  
NGTCP2_ERR_FLOW_CONTROL
;

4776 
cÚn
->
rx_off£t
 +ğ
Ën
;

4779 
rx_off£t
 = 
	`ngtı2_¡rm_rx_off£t
(
¡rm
);

4781 ià(
ä
->
fš
) {

4782 ià(
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_SHUT_RD
) {

4783 ià(
¡rm
->
Ï¡_rx_off£t
 !ğ
ä_’d_off£t
) {

4784  
NGTCP2_ERR_FINAL_OFFSET
;

4787 ià(
¡rm
->
æags
 &

4788 (
NGTCP2_STRM_FLAG_STOP_SENDING
 | 
NGTCP2_STRM_FLAG_RECV_RST
)) {

4791 } ià(
¡rm
->
Ï¡_rx_off£t
 > 
ä_’d_off£t
) {

4792  
NGTCP2_ERR_FINAL_OFFSET
;

4794 
¡rm
->
Ï¡_rx_off£t
 = 
ä_’d_off£t
;

4796 
	`ngtı2_¡rm_shutdown
(
¡rm
, 
NGTCP2_STRM_FLAG_SHUT_RD
);

4798 ià(
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_STOP_SENDING
) {

4799  
	`ngtı2_cÚn_şo£_¡»am_if_shut_rdwr
(
cÚn
, 
¡rm
,

4800 
¡rm
->
­p_”rÜ_code
);

4803 ià(
ä_’d_off£t
 =ğ
rx_off£t
) {

4804 
rv
 = 
	`cÚn_ÿÎ_»cv_¡»am_d©a
(
cÚn
, 
¡rm
, 1, 
rx_off£t
, 
NULL
, 0);

4805 ià(
rv
 != 0) {

4806  
rv
;

4808  
	`ngtı2_cÚn_şo£_¡»am_if_shut_rdwr
(
cÚn
, 
¡rm
,

4809 
NGTCP2_NO_ERROR
);

4813 ià((
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_SHUT_RD
) &&

4814 
¡rm
->
Ï¡_rx_off£t
 < 
ä_’d_off£t
) {

4815  
NGTCP2_ERR_FINAL_OFFSET
;

4818 
¡rm
->
Ï¡_rx_off£t
 = 
	`ngtı2_max
(¡rm->Ï¡_rx_off£t, 
ä_’d_off£t
);

4820 ià(
ä_’d_off£t
 <ğ
rx_off£t
) {

4824 ià(
¡rm
->
æags
 &

4825 (
NGTCP2_STRM_FLAG_STOP_SENDING
 | 
NGTCP2_STRM_FLAG_RECV_RST
)) {

4830 ià(
ä
->
off£t
 <ğ
rx_off£t
) {

4831 
size_t
 
ncut
 = 
rx_off£t
 - 
ä
->
off£t
;

4832 
ušt64_t
 
off£t
 = 
rx_off£t
;

4833 cÚ¡ 
ušt8_t
 *
d©a
;

4834 
fš
;

4836 ià(
ä
->
d©aút
) {

4837 
d©a
 = 
ä
->d©a[0].
ba£
 + 
ncut
;

4838 
d©®’
 -ğ
ncut
;

4840 
rx_off£t
 +ğ
d©®’
;

4841 
rv
 = 
	`ngtı2_rob_»move_´efix
(&
¡rm
->
rob
, 
rx_off£t
);

4842 ià(
rv
 != 0) {

4843  
rv
;

4846 
d©a
 = 
NULL
;

4847 
d©®’
 = 0;

4850 
fš
 = (
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_SHUT_RD
) &&

4851 
rx_off£t
 =ğ
¡rm
->
Ï¡_rx_off£t
;

4853 ià(
fš
 || 
d©®’
) {

4854 
rv
 = 
	`cÚn_ÿÎ_»cv_¡»am_d©a
(
cÚn
, 
¡rm
, 
fš
, 
off£t
, 
d©a
, 
d©®’
);

4855 ià(
rv
 != 0) {

4856  
rv
;

4859 
rv
 = 
	`cÚn_em™_³ndšg_¡»am_d©a
(
cÚn
, 
¡rm
, 
rx_off£t
);

4860 ià(
rv
 != 0) {

4861  
rv
;

4864 } ià(
ä
->
d©aút
) {

4865 
rv
 = 
	`ngtı2_¡rm_»cv_»Üd”šg
(
¡rm
, 
ä
->
d©a
[0].
ba£
, fr->d©a[0].
Ën
,

4866 
ä
->
off£t
);

4867 ià(
rv
 != 0) {

4868  
rv
;

4871  
	`ngtı2_cÚn_şo£_¡»am_if_shut_rdwr
(
cÚn
, 
¡rm
, 
NGTCP2_NO_ERROR
);

4872 
	}
}

4884 
	$cÚn_»£t_¡»am
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
,

4885 
ušt16_t
 
­p_”rÜ_code
) {

4886 
rv
;

4887 
ngtı2_äame_chaš
 *
äc
;

4888 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->pktns;

4890 
rv
 = 
	`ngtı2_äame_chaš_Ãw
(&
äc
, 
cÚn
->
mem
);

4891 ià(
rv
 != 0) {

4892  
rv
;

4895 
äc
->
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

4896 
äc
->
ä
.
»£t_¡»am
.
¡»am_id
 = 
¡rm
->stream_id;

4897 
äc
->
ä
.
»£t_¡»am
.
­p_”rÜ_code
 =‡pp_error_code;

4898 
äc
->
ä
.
»£t_¡»am
.
fš®_off£t
 = 
¡rm
->
tx_off£t
;

4901 
äc
->
Ãxt
 = 
pkŠs
->
äq
;

4902 
pkŠs
->
äq
 = 
äc
;

4905 
	}
}

4917 
	$cÚn_¡İ_£ndšg
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
,

4918 
ušt16_t
 
­p_”rÜ_code
) {

4919 
rv
;

4920 
ngtı2_äame_chaš
 *
äc
;

4921 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->pktns;

4923 
rv
 = 
	`ngtı2_äame_chaš_Ãw
(&
äc
, 
cÚn
->
mem
);

4924 ià(
rv
 != 0) {

4925  
rv
;

4928 
äc
->
ä
.
ty³
 = 
NGTCP2_FRAME_STOP_SENDING
;

4929 
äc
->
ä
.
¡İ_£ndšg
.
¡»am_id
 = 
¡rm
->stream_id;

4930 
äc
->
ä
.
¡İ_£ndšg
.
­p_”rÜ_code
 =‡pp_error_code;

4933 
äc
->
Ãxt
 = 
pkŠs
->
äq
;

4934 
pkŠs
->
äq
 = 
äc
;

4937 
	}
}

4944 
	$hªdË_»mÙe_¡»am_id_ex‹nsiÚ
(
ušt64_t
 *
pun£Á_max_»mÙe_¡»am_id
) {

4945 ià(*
pun£Á_max_»mÙe_¡»am_id
 <ğ
NGTCP2_MAX_VARINT
 - 4) {

4946 *
pun£Á_max_»mÙe_¡»am_id
 += 4;

4948 
	}
}

4975 
	$cÚn_»cv_»£t_¡»am
(
ngtı2_cÚn
 *
cÚn
,

4976 cÚ¡ 
ngtı2_»£t_¡»am
 *
ä
) {

4977 
ngtı2_¡rm
 *
¡rm
;

4978 
loÿl_¡»am
 = 
	`cÚn_loÿl_¡»am
(
cÚn
, 
ä
->
¡»am_id
);

4979 
bidi
 = 
	`bidi_¡»am
(
ä
->
¡»am_id
);

4980 
ušt64_t
 
d©®’
;

4981 
ngtı2_idŒ
 *
idŒ
;

4982 
rv
;

4985 ià(
bidi
) {

4986 ià(
loÿl_¡»am
) {

4987 ià(
cÚn
->
Ãxt_loÿl_¡»am_id_bidi
 <ğ
ä
->
¡»am_id
) {

4988  
NGTCP2_ERR_STREAM_STATE
;

4990 } ià(
ä
->
¡»am_id
 > 
cÚn
->
max_»mÙe_¡»am_id_bidi
) {

4991  
NGTCP2_ERR_STREAM_LIMIT
;

4994 
idŒ
 = &
cÚn
->
»mÙe_bidi_idŒ
;

4996 ià(
loÿl_¡»am
) {

4997  
NGTCP2_ERR_PROTO
;

4999 ià(
ä
->
¡»am_id
 > 
cÚn
->
max_»mÙe_¡»am_id_uni
) {

5000  
NGTCP2_ERR_STREAM_LIMIT
;

5003 
idŒ
 = &
cÚn
->
»mÙe_uni_idŒ
;

5006 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
ä
->
¡»am_id
);

5007 ià(
¡rm
 =ğ
NULL
) {

5008 ià(
loÿl_¡»am
) {

5012 ià(
	`cÚn_š™Ÿl_¡»am_rx_off£t
(
cÚn
, 
ä
->
¡»am_id
è< fr->
fš®_off£t
 ||

5013 
	`cÚn_max_d©a_viŞ©ed
(
cÚn
, 
ä
->
fš®_off£t
)) {

5014  
NGTCP2_ERR_FLOW_CONTROL
;

5016 
rv
 = 
	`ngtı2_idŒ_İ’
(
idŒ
, 
ä
->
¡»am_id
);

5017 ià(
rv
 != 0) {

5018 ià(
	`ngtı2_”r_is_çl
(
rv
)) {

5019  
rv
;

5021 
	`as£¹
(
rv
 =ğ
NGTCP2_ERR_STREAM_IN_USE
);

5026 
cÚn
->
rx_off£t
 +ğ
ä
->
fš®_off£t
;

5031 ià(
bidi
) {

5032 
	`hªdË_»mÙe_¡»am_id_ex‹nsiÚ
(

5033 &
cÚn
->
un£Á_max_»mÙe_¡»am_id_bidi
);

5035 
	`hªdË_»mÙe_¡»am_id_ex‹nsiÚ
(&
cÚn
->
un£Á_max_»mÙe_¡»am_id_uni
);

5041 ià((
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_SHUT_RD
)) {

5042 ià(
¡rm
->
Ï¡_rx_off£t
 !ğ
ä
->
fš®_off£t
) {

5043  
NGTCP2_ERR_FINAL_OFFSET
;

5045 } ià(
¡rm
->
Ï¡_rx_off£t
 > 
ä
->
fš®_off£t
) {

5046  
NGTCP2_ERR_FINAL_OFFSET
;

5049 
d©®’
 = 
ä
->
fš®_off£t
 - 
¡rm
->
Ï¡_rx_off£t
;

5051 ià(
¡rm
->
max_rx_off£t
 < 
ä
->
fš®_off£t
 ||

5052 
	`cÚn_max_d©a_viŞ©ed
(
cÚn
, 
d©®’
)) {

5053  
NGTCP2_ERR_FLOW_CONTROL
;

5056 
cÚn
->
rx_off£t
 +ğ
d©®’
;

5058 
¡rm
->
Ï¡_rx_off£t
 = 
ä
->
fš®_off£t
;

5059 
¡rm
->
æags
 |ğ
NGTCP2_STRM_FLAG_SHUT_RD
 | 
NGTCP2_STRM_FLAG_RECV_RST
;

5061  
	`ngtı2_cÚn_şo£_¡»am_if_shut_rdwr
(
cÚn
, 
¡rm
, 
ä
->
­p_”rÜ_code
);

5062 
	}
}

5084 
	$cÚn_»cv_¡İ_£ndšg
(
ngtı2_cÚn
 *
cÚn
,

5085 cÚ¡ 
ngtı2_¡İ_£ndšg
 *
ä
) {

5086 
rv
;

5087 
ngtı2_¡rm
 *
¡rm
;

5088 
ngtı2_idŒ
 *
idŒ
;

5089 
loÿl_¡»am
 = 
	`cÚn_loÿl_¡»am
(
cÚn
, 
ä
->
¡»am_id
);

5090 
bidi
 = 
	`bidi_¡»am
(
ä
->
¡»am_id
);

5092 ià(
bidi
) {

5093 ià(
loÿl_¡»am
) {

5094 ià(
cÚn
->
Ãxt_loÿl_¡»am_id_bidi
 <ğ
ä
->
¡»am_id
) {

5095  
NGTCP2_ERR_STREAM_STATE
;

5097 } ià(
ä
->
¡»am_id
 > 
cÚn
->
max_»mÙe_¡»am_id_bidi
) {

5098  
NGTCP2_ERR_STREAM_LIMIT
;

5101 
idŒ
 = &
cÚn
->
»mÙe_bidi_idŒ
;

5103 ià(!
loÿl_¡»am
) {

5104  
NGTCP2_ERR_PROTO
;

5106 ià(
cÚn
->
Ãxt_loÿl_¡»am_id_uni
 <ğ
ä
->
¡»am_id
) {

5107  
NGTCP2_ERR_STREAM_STATE
;

5110 
idŒ
 = &
cÚn
->
»mÙe_uni_idŒ
;

5113 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
ä
->
¡»am_id
);

5114 ià(
¡rm
 =ğ
NULL
) {

5115 ià(
loÿl_¡»am
) {

5118 
rv
 = 
	`ngtı2_idŒ_İ’
(
idŒ
, 
ä
->
¡»am_id
);

5119 ià(
rv
 != 0) {

5120 ià(
	`ngtı2_”r_is_çl
(
rv
)) {

5121  
rv
;

5123 
	`as£¹
(
rv
 =ğ
NGTCP2_ERR_STREAM_IN_USE
);

5129 
¡rm
 = 
	`ngtı2_mem_m®loc
(
cÚn
->
mem
, (
ngtı2_¡rm
));

5130 ià(
¡rm
 =ğ
NULL
) {

5131  
NGTCP2_ERR_NOMEM
;

5133 
rv
 = 
	`ngtı2_cÚn_š™_¡»am
(
cÚn
, 
¡rm
, 
ä
->
¡»am_id
, 
NULL
);

5134 ià(
rv
 != 0) {

5135 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, 
¡rm
);

5136  
rv
;

5140 
rv
 = 
	`cÚn_»£t_¡»am
(
cÚn
, 
¡rm
, 
ä
->
­p_”rÜ_code
);

5141 ià(
rv
 != 0) {

5142  
rv
;

5145 
¡rm
->
æags
 |ğ
NGTCP2_STRM_FLAG_SHUT_WR
 | 
NGTCP2_STRM_FLAG_SENT_RST
;

5147 
	`ngtı2_¡rm_¡»amäq_ş—r
(
¡rm
);

5149  
	`ngtı2_cÚn_şo£_¡»am_if_shut_rdwr
(
cÚn
, 
¡rm
, 
ä
->
­p_”rÜ_code
);

5150 
	}
}

5169 
	$cÚn_Ú_¡©–ess_»£t
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

5170 cÚ¡ 
ušt8_t
 *
·ylßd
, 
size_t
 
·ylßdËn
) {

5171 
rv
 = 1;

5172 
ngtı2_pkt_¡©–ess_»£t
 
¤
;

5173 
size_t
 
i
, 
Ën
;

5174 
ngtı2_dcid
 *
dcid
;

5176 
rv
 = 
	`ngtı2_pkt_decode_¡©–ess_»£t
(&
¤
, 
·ylßd
, 
·ylßdËn
);

5177 ià(
rv
 != 0) {

5178  
rv
;

5181 ià(
	`ngtı2_v”ify_¡©–ess_»Œy_tok’
(
cÚn
->
dcid
.
tok’
,

5182 
¤
.
¡©–ess_»£t_tok’
) != 0) {

5183 
Ën
 = 
	`ngtı2_ršgbuf_Ën
(&
cÚn
->
bound_dcids
);

5184 
i
 = 0; i < 
Ën
; ++i) {

5185 
dcid
 = 
	`ngtı2_ršgbuf_g‘
(&
cÚn
->
bound_dcids
, 
i
);

5186 ià(
	`ngtı2_v”ify_¡©–ess_»Œy_tok’
(
dcid
->
tok’
,

5187 
¤
.
¡©–ess_»£t_tok’
) == 0) {

5192 ià(
i
 =ğ
Ën
) {

5193 
Ën
 = 
	`ngtı2_ršgbuf_Ën
(&
cÚn
->
dcids
);

5194 
i
 = 0; i < 
Ën
; ++i) {

5195 
dcid
 = 
	`ngtı2_ršgbuf_g‘
(&
cÚn
->
dcids
, 
i
);

5196 ià(
	`ngtı2_v”ify_¡©–ess_»Œy_tok’
(

5197 
dcid
->
tok’
, 
¤
.
¡©–ess_»£t_tok’
) == 0) {

5202 ià(
i
 =ğ
Ën
) {

5203  
NGTCP2_ERR_INVALID_ARGUMENT
;

5208 
cÚn
->
¡©e
 = 
NGTCP2_CS_DRAINING
;

5210 
	`ngtı2_log_rx_¤
(&
cÚn
->
log
, 
hd
, &
¤
);

5212 ià(!
cÚn
->
ÿÎbacks
.
»cv_¡©–ess_»£t
) {

5216 
rv
 = 
cÚn
->
ÿÎbacks
.
	`»cv_¡©–ess_»£t
(cÚn, 
hd
, &
¤
, cÚn->
u£r_d©a
);

5217 ià(
rv
 != 0) {

5218  
NGTCP2_ERR_CALLBACK_FAILURE
;

5222 
	}
}

5247 
	$cÚn_»cv_d–ayed_hªdshake_pkt
(
ngtı2_cÚn
 *
cÚn
,

5248 cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

5249 cÚ¡ 
ušt8_t
 *
·ylßd
,

5250 
size_t
 
·ylßdËn
,

5251 
ngtı2_t¡amp
 
ts
) {

5252 
ssize_t
 
Ä—d
;

5253 
ngtı2_max_äame
 
mä
;

5254 
ngtı2_äame
 *
ä
 = &
mä
.fr;

5255 
rv
;

5256 
»quœe_ack
 = 0;

5257 
ngtı2_pkŠs
 *
pkŠs
;

5259 
hd
->
ty³
) {

5260 
NGTCP2_PKT_HANDSHAKE
:

5261 
pkŠs
 = &
cÚn
->
hs_pkŠs
;

5264 
	`as£¹
(0);

5267 ià(
·ylßdËn
 == 0) {

5269  
NGTCP2_ERR_DISCARD_PKT
;

5272 ; 
·ylßdËn
;) {

5273 
Ä—d
 = 
	`ngtı2_pkt_decode_äame
(
ä
, 
·ylßd
, 
·ylßdËn
);

5274 ià(
Ä—d
 < 0) {

5275  ()
Ä—d
;

5278 
·ylßd
 +ğ
Ä—d
;

5279 
·ylßdËn
 -ğ(
size_t
)
Ä—d
;

5281 ià(
ä
->
ty³
 =ğ
NGTCP2_FRAME_ACK
) {

5282 
	`assign_»cved_ack_d–ay_unsÿËd
(&
ä
->
ack
,

5283 
NGTCP2_DEFAULT_ACK_DELAY_EXPONENT
);

5286 
	`ngtı2_log_rx_ä
(&
cÚn
->
log
, 
hd
, 
ä
);

5288 
ä
->
ty³
) {

5289 
NGTCP2_FRAME_ACK
:

5290 
NGTCP2_FRAME_ACK_ECN
:

5291 
rv
 = 
	`cÚn_»cv_ack
(
cÚn
, 
pkŠs
, &
ä
->
ack
, 
ts
);

5292 ià(
rv
 != 0) {

5293  
rv
;

5296 
NGTCP2_FRAME_PADDING
:

5298 
NGTCP2_FRAME_CONNECTION_CLOSE
:

5299 
NGTCP2_FRAME_CONNECTION_CLOSE_APP
:

5300 ià(
hd
->
ty³
 !ğ
NGTCP2_PKT_HANDSHAKE
) {

5303 
	`cÚn_»cv_cÚÃùiÚ_şo£
(
cÚn
);

5305 
NGTCP2_FRAME_CRYPTO
:

5306 
»quœe_ack
 = 1;

5309  
NGTCP2_ERR_PROTO
;

5313 
rv
 = 
	`pkŠs_comm™_»cv_pkt_num
(
pkŠs
, 
hd
->
pkt_num
);

5314 ià(
rv
 != 0) {

5315  
rv
;

5318 ià(
»quœe_ack
 && ++
pkŠs
->
ackŒ
.
rx_Åkt
 >ğ
NGTCP2_NUM_IMMEDIATE_ACK_PKT
) {

5319 
	`ngtı2_ackŒ_immedŸ‹_ack
(&
pkŠs
->
ackŒ
);

5322  
	`ngtı2_cÚn_sched_ack
(
cÚn
, &
pkŠs
->
ackŒ
, 
hd
->
pkt_num
, 
»quœe_ack
,

5323 
ts
);

5324 
	}
}

5336 
	$cÚn_»cv_max_¡»ams
(
ngtı2_cÚn
 *
cÚn
,

5337 cÚ¡ 
ngtı2_max_¡»ams
 *
ä
) {

5338 
ušt64_t
 
n
;

5339 ià(
ä
->
ty³
 =ğ
NGTCP2_FRAME_MAX_STREAMS_BIDI
) {

5340 ià(
cÚn
->
£rv”
) {

5341 
n
 = 
	`ngtı2_Áh_£rv”_bidi_id
(
ä
->
max_¡»ams
);

5342 
n
 = 
	`ngtı2_mš
Ò, 
NGTCP2_MAX_SERVER_ID_BIDI
);

5344 
n
 = 
	`ngtı2_Áh_ş›Á_bidi_id
(
ä
->
max_¡»ams
);

5345 
n
 = 
	`ngtı2_mš
Ò, 
NGTCP2_MAX_CLIENT_ID_BIDI
);

5347 ià(
n
 > 
cÚn
->
max_loÿl_¡»am_id_bidi
) {

5348 
cÚn
->
max_loÿl_¡»am_id_bidi
 = 
n
;

5349  
	`cÚn_ÿÎ_ex‹nd_max_¡»ams_bidi
(
cÚn
, 
n
);

5354 ià(
cÚn
->
£rv”
) {

5355 
n
 = 
	`ngtı2_Áh_£rv”_uni_id
(
ä
->
max_¡»ams
);

5356 
n
 = 
	`ngtı2_mš
Ò, 
NGTCP2_MAX_SERVER_ID_UNI
);

5358 
n
 = 
	`ngtı2_Áh_ş›Á_uni_id
(
ä
->
max_¡»ams
);

5359 
n
 = 
	`ngtı2_mš
Ò, 
NGTCP2_MAX_CLIENT_ID_UNI
);

5361 ià(
n
 > 
cÚn
->
max_loÿl_¡»am_id_uni
) {

5362 
cÚn
->
max_loÿl_¡»am_id_uni
 = 
n
;

5363  
	`cÚn_ÿÎ_ex‹nd_max_¡»ams_uni
(
cÚn
, 
n
);

5366 
	}
}

5379 
	$cÚn_»cv_Ãw_cÚÃùiÚ_id
(
ngtı2_cÚn
 *
cÚn
,

5380 cÚ¡ 
ngtı2_Ãw_cÚÃùiÚ_id
 *
ä
) {

5381 
size_t
 
i
, 
Ën
;

5382 
ngtı2_dcid
 *
dcid
;

5383 
ngtı2_pv
 *
pv
 = 
cÚn
->pv;

5384 
rv
;

5386 ià(
cÚn
->
dcid
.
cid
.
d©®’
 == 0) {

5387  
NGTCP2_ERR_PROTO
;

5390 
rv
 = 
	`ngtı2_dcid_v”ify_uniqu’ess
(&
cÚn
->
dcid
, 
ä
->
£q
, &ä->
cid
,

5391 
ä
->
¡©–ess_»£t_tok’
);

5392 ià(
rv
 != 0) {

5393  
rv
;

5396 ià(
pv
) {

5397 
rv
 = 
	`ngtı2_dcid_v”ify_uniqu’ess
(&
pv
->
dcid
, 
ä
->
£q
, &ä->
cid
,

5398 
ä
->
¡©–ess_»£t_tok’
);

5399 ià(
rv
 != 0) {

5400  
rv
;

5404 
Ën
 = 
	`ngtı2_ršgbuf_Ën
(&
cÚn
->
bound_dcids
);

5406 
i
 = 0; i < 
Ën
; ++i) {

5407 
dcid
 = 
	`ngtı2_ršgbuf_g‘
(&
cÚn
->
bound_dcids
, 
i
);

5408 
rv
 = 
	`ngtı2_dcid_v”ify_uniqu’ess
(
dcid
, 
ä
->
£q
, &ä->
cid
,

5409 
ä
->
¡©–ess_»£t_tok’
);

5410 ià(
rv
 != 0) {

5411  
NGTCP2_ERR_PROTO
;

5415 
Ën
 = 
	`ngtı2_ršgbuf_Ën
(&
cÚn
->
dcids
);

5417 
i
 = 0; i < 
Ën
; ++i) {

5418 
dcid
 = 
	`ngtı2_ršgbuf_g‘
(&
cÚn
->
dcids
, 
i
);

5419 
rv
 = 
	`ngtı2_dcid_v”ify_uniqu’ess
(
dcid
, 
ä
->
£q
, &ä->
cid
,

5420 
ä
->
¡©–ess_»£t_tok’
);

5421 ià(
rv
 != 0) {

5422  
NGTCP2_ERR_PROTO
;

5426 ià(
Ën
 >ğ
NGTCP2_MAX_DCID_POOL_SIZE
) {

5427 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_CON
, "too many connection ID");

5431 
dcid
 = 
	`ngtı2_ršgbuf_push_back
(&
cÚn
->
dcids
);

5432 
	`ngtı2_dcid_š™
(
dcid
, 
ä
->
£q
, &ä->
cid
, fr->
¡©–ess_»£t_tok’
);

5435 
	}
}

5449 
	$cÚn_»cv_»tœe_cÚÃùiÚ_id
(
ngtı2_cÚn
 *
cÚn
,

5450 cÚ¡ 
ngtı2_»tœe_cÚÃùiÚ_id
 *
ä
,

5451 
ngtı2_t¡amp
 
ts
) {

5452 
ngtı2_k¦_™
 
™
;

5453 
ngtı2_scid
 *
scid
;

5455 ià(
cÚn
->
oscid
.
d©®’
 == 0) {

5456  
NGTCP2_ERR_PROTO
;

5459 
™
 = 
	`ngtı2_k¦_begš
(&
cÚn
->
scids
); !
	`ngtı2_k¦_™_’d
(&it);

5460 
	`ngtı2_k¦_™_Ãxt
(&
™
)) {

5461 
scid
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

5462 ià(
scid
->
£q
 =ğ
ä
->seq) {

5463 
scid
->
æags
 |ğ
NGTCP2_SCID_FLAG_RETIRED
;

5465 ià(
scid
->
³
.
šdex
 !ğ
NGTCP2_PQ_BAD_INDEX
) {

5466 
	`ngtı2_pq_»move
(&
cÚn
->
u£d_scids
, &
scid
->
³
);

5467 
scid
->
³
.
šdex
 = 
NGTCP2_PQ_BAD_INDEX
;

5470 
scid
->
ts_»tœed
 = 
ts
;

5472  
	`ngtı2_pq_push
(&
cÚn
->
u£d_scids
, &
scid
->
³
);

5477 
	}
}

5483 
	$cÚn_key_pha£_chªged
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
) {

5484 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->pktns;

5486  !(
pkŠs
->
rx_ckm
->
æags
 & 
NGTCP2_CRYPTO_KM_FLAG_KEY_PHASE_ONE
) ^

5487 !(
hd
->
æags
 & 
NGTCP2_PKT_FLAG_KEY_PHASE
);

5488 
	}
}

5493 
	$cÚn_´•¬e_key_upd©e
(
ngtı2_cÚn
 *
cÚn
) {

5494 
rv
;

5496 ià(
cÚn
->
Ãw_rx_ckm
 || cÚn->
Ãw_tx_ckm
) {

5497 
	`as£¹
(
cÚn
->
Ãw_rx_ckm
);

5498 
	`as£¹
(
cÚn
->
Ãw_tx_ckm
);

5502 
	`as£¹
(
cÚn
->
ÿÎbacks
.
upd©e_key
);

5507 
rv
 = 
cÚn
->
ÿÎbacks
.
	`upd©e_key
(cÚn, cÚn->
u£r_d©a
);

5508 ià(
rv
 != 0) {

5509  
NGTCP2_ERR_CALLBACK_FAILURE
;

5512 
	`as£¹
(
cÚn
->
Ãw_rx_ckm
);

5513 
	`as£¹
(
cÚn
->
Ãw_tx_ckm
);

5516 
	}
}

5522 
	$cÚn_comm™_key_upd©e
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
pkt_num
) {

5523 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->pktns;

5525 
	`as£¹
(
cÚn
->
Ãw_rx_ckm
);

5526 
	`as£¹
(
cÚn
->
Ãw_tx_ckm
);

5528 
	`ngtı2_üy±o_km_d–
(
cÚn
->
Şd_rx_ckm
, cÚn->
mem
);

5529 
cÚn
->
Şd_rx_ckm
 = 
pkŠs
->
rx_ckm
;

5531 
pkŠs
->
rx_ckm
 = 
cÚn
->
Ãw_rx_ckm
;

5532 
cÚn
->
Ãw_rx_ckm
 = 
NULL
;

5533 
pkŠs
->
rx_ckm
->
pkt_num
 =…kt_num;

5535 
	`ngtı2_üy±o_km_d–
(
pkŠs
->
tx_ckm
, 
cÚn
->
mem
);

5536 
pkŠs
->
tx_ckm
 = 
cÚn
->
Ãw_tx_ckm
;

5537 
cÚn
->
Ãw_tx_ckm
 = 
NULL
;

5538 
pkŠs
->
tx_ckm
->
pkt_num
 =…kŠs->
Ï¡_tx_pkt_num
 + 1;

5539 
	}
}

5545 
	$cÚn_·th_v®id©iÚ_š_´og»ss
(
ngtı2_cÚn
 *
cÚn
,

5546 cÚ¡ 
ngtı2_·th
 *
·th
) {

5547 
ngtı2_pv
 *
pv
 = 
cÚn
->pv;

5549  
pv
 && !Õv->
æags
 & 
NGTCP2_PV_FLAG_DONT_CARE
) &&

5550 
	`ngtı2_·th_eq
(&
pv
->
dcid
.
·th
,…ath);

5551 
	}
}

5556 
	$cÚn_»£t_cÚge¡iÚ_¡©e
(
ngtı2_cÚn
 *
cÚn
) {

5557 
ušt64_t
 
by‹s_š_æight
;

5559 
cÚn
->
rx_bw
 = 0.;

5560 
cÚn
->
rx_bw_d©®’
 = 0;

5561 
cÚn
->
fœ¡_rx_bw_ts
 = 0;

5562 
cÚn
->
´obe_pkt_Ëá
 = 0;

5563 
	`rcvry_¡©_»£t
(&
cÚn
->
rcs
);

5566 
by‹s_š_æight
 = 
cÚn
->
ccs
.bytes_in_flight;

5567 
	`cc_¡©_»£t
(&
cÚn
->
ccs
);

5568 
cÚn
->
ccs
.
by‹s_š_æight
 = bytes_in_flight;

5569 
	}
}

5584 
	$cÚn_»cv_nÚ_´obšg_pkt_Ú_Ãw_·th
(
ngtı2_cÚn
 *
cÚn
,

5585 cÚ¡ 
ngtı2_·th
 *
·th
) {

5587 
ngtı2_dcid
 *
dcid
, *
Ï¡_dcid
;

5588 
ngtı2_ršgbuf
 *
rb
;

5589 
ngtı2_pv
 *
pv
;

5590 
size_t
 
i
, 
Ën
;

5591 
rv
;

5593 
	`as£¹
(
cÚn
->
£rv”
);

5595 
Ën
 = 
	`ngtı2_ršgbuf_Ën
(&
cÚn
->
bound_dcids
);

5597 
i
 = 0; i < 
Ën
; ++i) {

5598 
dcid
 = 
	`ngtı2_ršgbuf_g‘
(&
cÚn
->
bound_dcids
, 
i
);

5599 ià(
	`ngtı2_·th_eq
(&
dcid
->
·th
,…ath)) {

5600 
rb
 = &
cÚn
->
bound_dcids
;

5605 ià(
i
 =ğ
Ën
) {

5606 ià(
	`ngtı2_ršgbuf_Ën
(&
cÚn
->
dcids
) == 0) {

5607  
NGTCP2_ERR_INVALID_STATE
;

5610 
dcid
 = 
	`ngtı2_ršgbuf_g‘
(&
cÚn
->
dcids
, 0);

5611 
rb
 = &
cÚn
->
dcids
;

5614 ià(
cÚn
->
pv
) {

5615 
	`ngtı2_log_šfo
(

5616 &
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PTV
,

5618 
rv
 = 
	`cÚn_¡İ_pv
(
cÚn
);

5619 ià(
rv
 != 0) {

5620  
rv
;

5624 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_CON
,

5627 
	`cÚn_»£t_cÚge¡iÚ_¡©e
(
cÚn
);

5629 
rv
 = 
	`ngtı2_pv_Ãw
(&
pv
, 
dcid
, 6 * 
NGTCP2_DEFAULT_INITIAL_RTT
,

5630 
NGTCP2_PV_FLAG_BLOCKING
 |

5631 
NGTCP2_PV_FLAG_VERIFY_OLD_PATH_ON_SUCCESS
,

5632 &
cÚn
->
log
, cÚn->
mem
);

5633 ià(
rv
 != 0) {

5634  
rv
;

5637 
cÚn
->
pv
 =…v;

5638 
	`ngtı2_·th_cİy
(&
pv
->
dcid
.
·th
,…ath);

5640 ià(
rb
 =ğ&
cÚn
->
dcids
) {

5641 
	`ngtı2_ršgbuf_pİ_äÚt
(&
cÚn
->
dcids
);

5645 
	`as£¹
(
rb
 =ğ&
cÚn
->
bound_dcids
);

5647 ià(
i
 == 0) {

5648 
	`ngtı2_ršgbuf_pİ_äÚt
(&
cÚn
->
bound_dcids
);

5649 } ià(
i
 =ğ
Ën
 - 1) {

5650 
	`ngtı2_ršgbuf_pİ_back
(&
cÚn
->
bound_dcids
);

5652 
	`as£¹
(
i
 < 
Ën
);

5654 
Ï¡_dcid
 = 
	`ngtı2_ršgbuf_g‘
(&
cÚn
->
bound_dcids
, 
Ën
 - 1);

5655 
	`ngtı2_dcid_cİy
(
dcid
, 
Ï¡_dcid
);

5656 
	`ngtı2_ršgbuf_pİ_back
(&
cÚn
->
bound_dcids
);

5660 
	}
}

5695 
ssize_t
 
	$cÚn_»cv_pkt
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_·th
 *
·th
,

5696 cÚ¡ 
ušt8_t
 *
pkt
, 
size_t
 
pk’
,

5697 
ngtı2_t¡amp
 
ts
) {

5698 
ngtı2_pkt_hd
 
hd
;

5699 
rv
 = 0;

5700 
size_t
 
hdpk’
;

5701 cÚ¡ 
ušt8_t
 *
·ylßd
;

5702 
size_t
 
·ylßdËn
;

5703 
ssize_t
 
Ä—d
, 
nwr™e
;

5704 
ngtı2_max_äame
 
mä
;

5705 
ngtı2_äame
 *
ä
 = &
mä
.fr;

5706 
»quœe_ack
 = 0;

5707 
ngtı2_üy±o_km
 *
ckm
;

5708 cÚ¡ 
ngtı2_vec
 *
hp
;

5709 
ušt8_t
 
¶aš_hdpkt
[1500];

5710 
ngtı2_hp_mask
 
hp_mask
;

5711 
ngtı2_deüy±
 
deüy±
;

5712 
size_t
 
«ad_ov”h—d
;

5713 
ngtı2_pkŠs
 *
pkŠs
;

5714 
ušt64_t
 
max_üy±o_rx_off£t
 = 0;

5715 
nÚ_´obšg_pkt
 = 0;

5716 
key_pha£_b™_chªged
 = 0;

5717 
fÜû_deüy±_çu»
 = 0;

5719 ià(
pkt
[0] & 
NGTCP2_HEADER_FORM_BIT
) {

5720 
Ä—d
 = 
	`ngtı2_pkt_decode_hd_lÚg
(&
hd
, 
pkt
, 
pk’
);

5721 ià(
Ä—d
 < 0) {

5722 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

5724  
NGTCP2_ERR_DISCARD_PKT
;

5727 ià(
pk’
 < (
size_t
)
Ä—d
 + 
hd
.
Ën
) {

5728  
NGTCP2_ERR_DISCARD_PKT
;

5731 
pk’
 = (
size_t
)
Ä—d
 + 
hd
.
Ën
;

5733 ià(
cÚn
->
v”siÚ
 !ğ
hd
.version) {

5734  
NGTCP2_ERR_DISCARD_PKT
;

5739 ià(!
	`ngtı2_cid_eq
(&
cÚn
->
dcid
.
cid
, &
hd
.
scid
)) {

5740 
	`ngtı2_log_rx_pkt_hd
(&
cÚn
->
log
, &
hd
);

5741 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

5743  
NGTCP2_ERR_DISCARD_PKT
;

5746 
hd
.
ty³
) {

5747 
NGTCP2_PKT_INITIAL
:

5748 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

5750  (
ssize_t
)
pk’
;

5751 
NGTCP2_PKT_HANDSHAKE
:

5752 
pkŠs
 = &
cÚn
->
hs_pkŠs
;

5753 
ckm
 = 
pkŠs
->
rx_ckm
;

5754 
hp
 = 
pkŠs
->
rx_hp
;

5755 
hp_mask
 = 
cÚn
->
ÿÎbacks
.hp_mask;

5756 
deüy±
 = 
cÚn
->
ÿÎbacks
.decrypt;

5757 
«ad_ov”h—d
 = 
cÚn
->aead_overhead;

5758 
max_üy±o_rx_off£t
 = 
cÚn
->
pkŠs
.
üy±o_rx_off£t_ba£
;

5760 
NGTCP2_PKT_0RTT_PROTECTED
:

5761 ià(!
cÚn
->
£rv”
) {

5762  
NGTCP2_ERR_DISCARD_PKT
;

5765 
pkŠs
 = &
cÚn
->pktns;

5766 ià(!
cÚn
->
—¾y_ckm
) {

5767  
NGTCP2_ERR_DISCARD_PKT
;

5769 
ckm
 = 
cÚn
->
—¾y_ckm
;

5770 
hp
 = 
cÚn
->
—¾y_hp
;

5771 
hp_mask
 = 
cÚn
->
ÿÎbacks
.hp_mask;

5772 
deüy±
 = 
cÚn
->
ÿÎbacks
.decrypt;

5773 
«ad_ov”h—d
 = 
cÚn
->aead_overhead;

5776 
	`ngtı2_log_rx_pkt_hd
(&
cÚn
->
log
, &
hd
);

5777 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

5778 "·ck‘y³ 0x%02x wa ignÜed", 
hd
.
ty³
);

5779  (
ssize_t
)
pk’
;

5782 
Ä—d
 = 
	`ngtı2_pkt_decode_hd_shÜt
(&
hd
, 
pkt
, 
pk’
, 
cÚn
->
oscid
.
d©®’
);

5783 ià(
Ä—d
 < 0) {

5784 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

5786  
NGTCP2_ERR_DISCARD_PKT
;

5789 
pkŠs
 = &
cÚn
->pktns;

5790 
ckm
 = 
pkŠs
->
rx_ckm
;

5791 
hp
 = 
pkŠs
->
rx_hp
;

5792 
hp_mask
 = 
cÚn
->
ÿÎbacks
.hp_mask;

5793 
deüy±
 = 
cÚn
->
ÿÎbacks
.decrypt;

5794 
«ad_ov”h—d
 = 
cÚn
->aead_overhead;

5797 
nwr™e
 =

5798 
	`cÚn_deüy±_hp
(
cÚn
, &
hd
, 
¶aš_hdpkt
, ÕÏš_hdpkt), 
pkt
, 
pk’
,

5799 (
size_t
)
Ä—d
, 
ckm
, 
hp
, 
hp_mask
, 
«ad_ov”h—d
);

5800 ià(
nwr™e
 < 0) {

5801 ià(
	`ngtı2_”r_is_çl
(()
nwr™e
)) {

5802  
nwr™e
;

5804 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

5806  
NGTCP2_ERR_DISCARD_PKT
;

5809 
hdpk’
 = (
size_t
)
nwr™e
;

5810 
·ylßd
 = 
pkt
 + 
hdpk’
;

5811 
·ylßdËn
 = 
pk’
 - 
hdpk’
;

5813 
hd
.
pkt_num
 = 
	`ngtı2_pkt_adju¡_pkt_num
(
pkŠs
->
max_rx_pkt_num
, hd.pkt_num,

5814 
	`pkt_num_b™s
(
hd
.
pkt_numËn
));

5816 
	`ngtı2_log_rx_pkt_hd
(&
cÚn
->
log
, &
hd
);

5818 
rv
 = 
	`ngtı2_pkt_v”ify_»£rved_b™s
(
¶aš_hdpkt
[0]);

5819 ià(
rv
 != 0) {

5820 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

5822  
NGTCP2_ERR_DISCARD_PKT
;

5825 ià(
	`pkŠs_pkt_num_is_du¶iÿ‹
(
pkŠs
, 
hd
.
pkt_num
)) {

5826 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

5828  
NGTCP2_ERR_DISCARD_PKT
;

5831 ià(
hd
.
ty³
 =ğ
NGTCP2_PKT_SHORT
) {

5832 
key_pha£_b™_chªged
 = 
	`cÚn_key_pha£_chªged
(
cÚn
, &
hd
);

5835 
rv
 = 
	`cÚn_’su»_deüy±_bufãr
(
cÚn
, 
·ylßdËn
);

5836 ià(
rv
 != 0) {

5837  
rv
;

5840 ià(
key_pha£_b™_chªged
) {

5841 
	`as£¹
(
hd
.
ty³
 =ğ
NGTCP2_PKT_SHORT
);

5843 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
, "unexpected KEY_PHASE");

5845 ià(
ckm
->
pkt_num
 > 
hd
.pkt_num) {

5846 ià(
cÚn
->
Şd_rx_ckm
) {

5847 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

5849 
ckm
 = 
cÚn
->
Şd_rx_ckm
;

5851 
fÜû_deüy±_çu»
 = 1;

5853 } ià(
pkŠs
->
max_rx_pkt_num
 =ğ(
ušt64_t
)-1 ||

5854 
pkŠs
->
max_rx_pkt_num
 < 
hd
.
pkt_num
) {

5855 
	`as£¹
(
ckm
->
pkt_num
 < 
hd
.pkt_num);

5856 ià(!
cÚn
->
Ãw_rx_ckm
) {

5857 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
, "preparing‚ew key");

5858 
rv
 = 
	`cÚn_´•¬e_key_upd©e
(
cÚn
);

5859 ià(
rv
 != 0) {

5860  
rv
;

5863 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

5865 
ckm
 = 
cÚn
->
Ãw_rx_ckm
;

5867 
fÜû_deüy±_çu»
 = 1;

5871 
nwr™e
 = 
	`cÚn_deüy±_pkt
(
cÚn
, cÚn->
deüy±_buf
.
ba£
, 
·ylßdËn
, 
·ylßd
,

5872 
·ylßdËn
, 
¶aš_hdpkt
, 
hdpk’
, 
hd
.
pkt_num
, 
ckm
,

5873 
deüy±
);

5875 ià(
fÜû_deüy±_çu»
) {

5876 
nwr™e
 = 
NGTCP2_ERR_TLS_DECRYPT
;

5879 ià(
nwr™e
 < 0) {

5880 ià(
	`ngtı2_”r_is_çl
(()
nwr™e
)) {

5881  
nwr™e
;

5884 
	`as£¹
(
NGTCP2_ERR_TLS_DECRYPT
 =ğ
nwr™e
);

5886 ià(
hd
.
æags
 & 
NGTCP2_PKT_FLAG_LONG_FORM
) {

5887 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

5889  
NGTCP2_ERR_DISCARD_PKT
;

5892 
rv
 = 
	`cÚn_Ú_¡©–ess_»£t
(
cÚn
, &
hd
, 
pkt
, 
pk’
);

5893 ià(
rv
 == 0) {

5894  (
ssize_t
)
pk’
;

5897 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

5899  
NGTCP2_ERR_DISCARD_PKT
;

5902 
·ylßd
 = 
cÚn
->
deüy±_buf
.
ba£
;

5903 
·ylßdËn
 = (
size_t
)
nwr™e
;

5905 ià(
·ylßdËn
 == 0) {

5907  
NGTCP2_ERR_DISCARD_PKT
;

5910 ià(
hd
.
æags
 & 
NGTCP2_PKT_FLAG_LONG_FORM
) {

5911 
hd
.
ty³
) {

5912 
NGTCP2_PKT_HANDSHAKE
:

5913 
rv
 = 
	`cÚn_v”ify_dcid
(
cÚn
, &
hd
);

5914 ià(
rv
 != 0) {

5915 ià(
	`ngtı2_”r_is_çl
(
rv
)) {

5916  
rv
;

5918 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

5920  
NGTCP2_ERR_DISCARD_PKT
;

5924 
rv
 = 
	`cÚn_»cv_d–ayed_hªdshake_pkt
(
cÚn
, &
hd
, 
·ylßd
, 
·ylßdËn
, 
ts
);

5925 ià(
rv
 < 0) {

5926 ià(
	`ngtı2_”r_is_çl
(
rv
)) {

5927  
rv
;

5929  (
ssize_t
)
rv
;

5931  (
ssize_t
)
pk’
;

5932 
NGTCP2_PKT_0RTT_PROTECTED
:

5933 ià(!
	`ngtı2_cid_eq
(&
cÚn
->
rcid
, &
hd
.
dcid
)) {

5934 
rv
 = 
	`cÚn_v”ify_dcid
(
cÚn
, &
hd
);

5935 ià(
rv
 != 0) {

5936 ià(
	`ngtı2_”r_is_çl
(
rv
)) {

5937  
rv
;

5939 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

5941  
NGTCP2_ERR_DISCARD_PKT
;

5947 
rv
 = 
	`cÚn_v”ify_dcid
(
cÚn
, &
hd
);

5948 ià(
rv
 != 0) {

5949 ià(
	`ngtı2_”r_is_çl
(
rv
)) {

5950  
rv
;

5952 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

5954  
NGTCP2_ERR_DISCARD_PKT
;

5956 
cÚn
->
æags
 |ğ
NGTCP2_CONN_FLAG_RECV_PROTECTED_PKT
;

5959 ; 
·ylßdËn
;) {

5960 
Ä—d
 = 
	`ngtı2_pkt_decode_äame
(
ä
, 
·ylßd
, 
·ylßdËn
);

5961 ià(
Ä—d
 < 0) {

5962  ()
Ä—d
;

5965 
·ylßd
 +ğ
Ä—d
;

5966 
·ylßdËn
 -ğ(
size_t
)
Ä—d
;

5968 ià(
ä
->
ty³
 =ğ
NGTCP2_FRAME_ACK
) {

5969 ià((
hd
.
æags
 & 
NGTCP2_PKT_FLAG_LONG_FORM
) &&

5970 
hd
.
ty³
 =ğ
NGTCP2_PKT_0RTT_PROTECTED
) {

5971  
NGTCP2_ERR_PROTO
;

5973 
	`assign_»cved_ack_d–ay_unsÿËd
(

5974 &
ä
->
ack
, 
cÚn
->
»mÙe_£‰šgs
.
ack_d–ay_expÚ’t
);

5977 
	`ngtı2_log_rx_ä
(&
cÚn
->
log
, &
hd
, 
ä
);

5979 ià(
hd
.
ty³
 =ğ
NGTCP2_PKT_0RTT_PROTECTED
) {

5980 
ä
->
ty³
) {

5981 
NGTCP2_FRAME_PADDING
:

5982 
NGTCP2_FRAME_STREAM
:

5985  
NGTCP2_ERR_PROTO
;

5989 
ä
->
ty³
) {

5990 
NGTCP2_FRAME_ACK
:

5991 
NGTCP2_FRAME_ACK_ECN
:

5992 
NGTCP2_FRAME_PADDING
:

5993 
NGTCP2_FRAME_CONNECTION_CLOSE
:

5994 
NGTCP2_FRAME_CONNECTION_CLOSE_APP
:

5997 
»quœe_ack
 = 1;

6000 
ä
->
ty³
) {

6001 
NGTCP2_FRAME_ACK
:

6002 
NGTCP2_FRAME_ACK_ECN
:

6003 
rv
 = 
	`cÚn_»cv_ack
(
cÚn
, 
pkŠs
, &
ä
->
ack
, 
ts
);

6004 ià(
rv
 != 0) {

6005  
rv
;

6007 
nÚ_´obšg_pkt
 = 1;

6009 
NGTCP2_FRAME_STREAM
:

6010 
rv
 = 
	`cÚn_»cv_¡»am
(
cÚn
, &
ä
->
¡»am
);

6011 ià(
rv
 != 0) {

6012  
rv
;

6014 
nÚ_´obšg_pkt
 = 1;

6015 
	`cÚn_upd©e_rx_bw
(

6016 
cÚn
, 
	`ngtı2_vec_Ën
(
ä
->
¡»am
.
d©a
, fr->¡»am.
d©aút
), 
ts
);

6018 
NGTCP2_FRAME_CRYPTO
:

6019 
rv
 = 
	`cÚn_»cv_üy±o
(
cÚn
, 
pkŠs
->
üy±o_rx_off£t_ba£
,

6020 
max_üy±o_rx_off£t
, &
ä
->
üy±o
);

6021 ià(
rv
 != 0) {

6022  
rv
;

6024 
nÚ_´obšg_pkt
 = 1;

6026 
NGTCP2_FRAME_RESET_STREAM
:

6027 
rv
 = 
	`cÚn_»cv_»£t_¡»am
(
cÚn
, &
ä
->
»£t_¡»am
);

6028 ià(
rv
 != 0) {

6029  
rv
;

6031 
nÚ_´obšg_pkt
 = 1;

6033 
NGTCP2_FRAME_STOP_SENDING
:

6034 
rv
 = 
	`cÚn_»cv_¡İ_£ndšg
(
cÚn
, &
ä
->
¡İ_£ndšg
);

6035 ià(
rv
 != 0) {

6036  
rv
;

6038 
nÚ_´obšg_pkt
 = 1;

6040 
NGTCP2_FRAME_MAX_STREAM_DATA
:

6041 
rv
 = 
	`cÚn_»cv_max_¡»am_d©a
(
cÚn
, &
ä
->
max_¡»am_d©a
);

6042 ià(
rv
 != 0) {

6043  
rv
;

6045 
nÚ_´obšg_pkt
 = 1;

6047 
NGTCP2_FRAME_MAX_DATA
:

6048 
	`cÚn_»cv_max_d©a
(
cÚn
, &
ä
->
max_d©a
);

6049 
nÚ_´obšg_pkt
 = 1;

6051 
NGTCP2_FRAME_MAX_STREAMS_BIDI
:

6052 
NGTCP2_FRAME_MAX_STREAMS_UNI
:

6053 
rv
 = 
	`cÚn_»cv_max_¡»ams
(
cÚn
, &
ä
->
max_¡»ams
);

6054 ià(
rv
 != 0) {

6055  
rv
;

6057 
nÚ_´obšg_pkt
 = 1;

6059 
NGTCP2_FRAME_CONNECTION_CLOSE
:

6060 
NGTCP2_FRAME_CONNECTION_CLOSE_APP
:

6061 
	`cÚn_»cv_cÚÃùiÚ_şo£
(
cÚn
);

6063 
NGTCP2_FRAME_PING
:

6064 
nÚ_´obšg_pkt
 = 1;

6066 
NGTCP2_FRAME_PATH_CHALLENGE
:

6067 
	`cÚn_»cv_·th_ch®Ënge
(
cÚn
, 
·th
, &
ä
->
·th_ch®Ënge
);

6069 
NGTCP2_FRAME_PATH_RESPONSE
:

6070 
rv
 = 
	`cÚn_»cv_·th_»¥Ú£
(
cÚn
, 
·th
, &
ä
->
·th_»¥Ú£
);

6071 ià(
rv
 != 0) {

6072  
rv
;

6075 
NGTCP2_FRAME_NEW_CONNECTION_ID
:

6076 
rv
 = 
	`cÚn_»cv_Ãw_cÚÃùiÚ_id
(
cÚn
, &
ä
->
Ãw_cÚÃùiÚ_id
);

6077 ià(
rv
 != 0) {

6078  
rv
;

6081 
NGTCP2_FRAME_RETIRE_CONNECTION_ID
:

6082 
rv
 = 
	`cÚn_»cv_»tœe_cÚÃùiÚ_id
(
cÚn
, &
ä
->
»tœe_cÚÃùiÚ_id
, 
ts
);

6083 ià(
rv
 != 0) {

6084  
rv
;

6086 
nÚ_´obšg_pkt
 = 1;

6088 
NGTCP2_FRAME_DATA_BLOCKED
:

6089 
NGTCP2_FRAME_STREAMS_BLOCKED_BIDI
:

6090 
NGTCP2_FRAME_STREAMS_BLOCKED_UNI
:

6091 
NGTCP2_FRAME_NEW_TOKEN
:

6093 
nÚ_´obšg_pkt
 = 1;

6098 ià(
cÚn
->
£rv”
 && 
hd
.
ty³
 =ğ
NGTCP2_PKT_SHORT
 && 
nÚ_´obšg_pkt
 &&

6099 (
pkŠs
->
max_rx_pkt_num
 =ğ(
ušt64_t
)-1 ||

6100 
pkŠs
->
max_rx_pkt_num
 < 
hd
.
pkt_num
) &&

6101 !
	`ngtı2_·th_eq
(&
cÚn
->
dcid
.
·th
,…ath) &&

6102 !
	`cÚn_·th_v®id©iÚ_š_´og»ss
(
cÚn
, 
·th
)) {

6103 
rv
 = 
	`cÚn_»cv_nÚ_´obšg_pkt_Ú_Ãw_·th
(
cÚn
, 
·th
);

6104 ià(
rv
 != 0) {

6105 ià(
	`ngtı2_”r_is_çl
(
rv
)) {

6106  
rv
;

6110 
	`as£¹
(
NGTCP2_ERR_INVALID_STATE
 =ğ
rv
);

6114 ià(
hd
.
ty³
 =ğ
NGTCP2_PKT_SHORT
) {

6115 ià(
ckm
 =ğ
cÚn
->
Ãw_rx_ckm
) {

6116 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_CON
, "commit‚ew key");

6117 
	`cÚn_comm™_key_upd©e
(
cÚn
, 
hd
.
pkt_num
);

6119 ià(
ckm
 =ğ
pkŠs
->
rx_ckm
 &&

6120 (
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_WAIT_FOR_REMOTE_KEY_UPDATE
)) {

6121 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_CON
,

6123 
cÚn
->
æags
 &ğ(
ušt16_t
)~
NGTCP2_CONN_FLAG_WAIT_FOR_REMOTE_KEY_UPDATE
;

6125 ià(
ckm
->
pkt_num
 > 
hd
.pkt_num) {

6126 
ckm
->
pkt_num
 = 
hd
.pkt_num;

6131 
rv
 = 
	`pkŠs_comm™_»cv_pkt_num
(
pkŠs
, 
hd
.
pkt_num
);

6132 ià(
rv
 != 0) {

6133  
rv
;

6136 ià(
»quœe_ack
 && ++
pkŠs
->
ackŒ
.
rx_Åkt
 >ğ
NGTCP2_NUM_IMMEDIATE_ACK_PKT
) {

6137 
	`ngtı2_ackŒ_immedŸ‹_ack
(&
pkŠs
->
ackŒ
);

6140 
rv
 = 
	`ngtı2_cÚn_sched_ack
(
cÚn
, &
pkŠs
->
ackŒ
, 
hd
.
pkt_num
, 
»quœe_ack
, 
ts
);

6141 ià(
rv
 != 0) {

6142  
rv
;

6145  (
ssize_t
)
pk’
;

6146 
	}
}

6155 
	$cÚn_´oûss_bufã»d_´Ùeùed_pkt
(
ngtı2_cÚn
 *
cÚn
,

6156 
ngtı2_t¡amp
 
ts
) {

6157 
ssize_t
 
Ä—d
;

6158 
ngtı2_pkt_chaš
 **
µc
, *
Ãxt
;

6160 
µc
 = &
cÚn
->
bufãd_rx_µkts
; *ppc;) {

6161 
Ãxt
 = (*
µc
)->next;

6164 
Ä—d
 =

6165 
	`cÚn_»cv_pkt
(
cÚn
, &cÚn->
dcid
.
·th
, (*
µc
)->
pkt
, (*µc)->
pk’
, 
ts
);

6166 
	`ngtı2_pkt_chaš_d–
(*
µc
, 
cÚn
->
mem
);

6167 *
µc
 = 
Ãxt
;

6168 ià(
Ä—d
 < 0) {

6169 ià(
Ä—d
 =ğ
NGTCP2_ERR_DISCARD_PKT
) {

6172  ()
Ä—d
;

6177 
	}
}

6186 
	$cÚn_´oûss_bufã»d_hªdshake_pkt
(
ngtı2_cÚn
 *
cÚn
,

6187 
ngtı2_t¡amp
 
ts
) {

6188 
ssize_t
 
Ä—d
;

6189 
ngtı2_pkt_chaš
 **
µc
, *
Ãxt
;

6191 
µc
 = &
cÚn
->
bufãd_rx_hs_pkts
; *ppc;) {

6192 
Ãxt
 = (*
µc
)->next;

6193 
Ä—d
 = 
	`cÚn_»cv_hªdshake_pkt
(
cÚn
, (*
µc
)->
pkt
, (*µc)->
pk’
, 
ts
);

6194 
	`ngtı2_pkt_chaš_d–
(*
µc
, 
cÚn
->
mem
);

6195 *
µc
 = 
Ãxt
;

6196 ià(
Ä—d
 < 0) {

6197 ià(
Ä—d
 =ğ
NGTCP2_ERR_DISCARD_PKT
) {

6200  ()
Ä—d
;

6205 
	}
}

6217 
	$cÚn_hªdshake_com¶‘ed
(
ngtı2_cÚn
 *
cÚn
) {

6218 
rv
;

6220 
cÚn
->
æags
 |ğ
NGTCP2_CONN_FLAG_HANDSHAKE_COMPLETED_HANDLED
;

6222 
rv
 = 
	`cÚn_ÿÎ_hªdshake_com¶‘ed
(
cÚn
);

6223 ià(
rv
 != 0) {

6224  
rv
;

6227 ià(
cÚn
->
max_loÿl_¡»am_id_bidi
 > 0) {

6228 
rv
 = 
	`cÚn_ÿÎ_ex‹nd_max_¡»ams_bidi
(
cÚn
,

6229 
cÚn
->
max_loÿl_¡»am_id_bidi
 >> 2);

6230 ià(
rv
 != 0) {

6231  
rv
;

6234 ià(
cÚn
->
max_loÿl_¡»am_id_uni
 > 0) {

6235 
rv
 = 
	`cÚn_ÿÎ_ex‹nd_max_¡»ams_uni
(
cÚn
,

6236 
cÚn
->
max_loÿl_¡»am_id_uni
 >> 2);

6237 ià(
rv
 != 0) {

6238  
rv
;

6243 
	}
}

6254 
	$cÚn_»cv_ıkt
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_·th
 *
·th
,

6255 cÚ¡ 
ušt8_t
 *
pkt
, 
size_t
 
pk’
, 
ngtı2_t¡amp
 
ts
) {

6256 
ssize_t
 
Ä—d
;

6258 
pk’
) {

6259 
Ä—d
 = 
	`cÚn_»cv_pkt
(
cÚn
, 
·th
, 
pkt
, 
pk’
, 
ts
);

6260 ià(
Ä—d
 < 0) {

6261 ià(
	`ngtı2_”r_is_çl
(()
Ä—d
)) {

6262  ()
Ä—d
;

6264 ià(
Ä—d
 =ğ
NGTCP2_ERR_DISCARD_PKT
) {

6267  ()
Ä—d
;

6270 
	`as£¹
(
pk’
 >ğ(
size_t
)
Ä—d
);

6271 
pkt
 +ğ
Ä—d
;

6272 
pk’
 -ğ(
size_t
)
Ä—d
;

6274 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_PKT
,

6275 "»ad…ack‘ %zd†eá %zu", 
Ä—d
, 
pk’
);

6279 
	}
}

6281 
	$ngtı2_cÚn_»ad_pkt
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_·th
 *
·th
,

6282 cÚ¡ 
ušt8_t
 *
pkt
, 
size_t
 
pk’
, 
ngtı2_t¡amp
 
ts
) {

6283 
rv
 = 0;

6285 
cÚn
->
log
.
Ï¡_ts
 = 
ts
;

6287 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_CON
, "recv…acket†en=%zu",

6288 
pk’
);

6290 ià(
pk’
 == 0) {

6291  
NGTCP2_ERR_INVALID_ARGUMENT
;

6295 ià(!
cÚn
->
£rv”
 && !
	`ngtı2_·th_eq
(&cÚn->
dcid
.
·th
,…ath) &&

6296 (!
cÚn
->
pv
 || !
	`ngtı2_·th_eq
(&cÚn->pv->
dcid
.
·th
,…ath))) {

6300 
cÚn
->
¡©e
) {

6301 
NGTCP2_CS_CLIENT_INITIAL
:

6302 
NGTCP2_CS_CLIENT_WAIT_HANDSHAKE
:

6303 
NGTCP2_CS_CLIENT_TLS_HANDSHAKE_FAILED
:

6304 
NGTCP2_CS_SERVER_INITIAL
:

6305 
NGTCP2_CS_SERVER_WAIT_HANDSHAKE
:

6306 
NGTCP2_CS_SERVER_TLS_HANDSHAKE_FAILED
:

6307  
NGTCP2_ERR_INVALID_STATE
;

6308 
NGTCP2_CS_CLOSING
:

6309  
NGTCP2_ERR_CLOSING
;

6310 
NGTCP2_CS_DRAINING
:

6311  
NGTCP2_ERR_DRAINING
;

6312 
NGTCP2_CS_POST_HANDSHAKE
:

6313 
rv
 = 
	`cÚn_»cv_ıkt
(
cÚn
, 
·th
, 
pkt
, 
pk’
, 
ts
);

6314 ià(
rv
 != 0) {

6317 ià(
cÚn
->
¡©e
 =ğ
NGTCP2_CS_DRAINING
) {

6318  
NGTCP2_ERR_DRAINING
;

6323  
rv
;

6324 
	}
}

6330 
	$cÚn_check_pkt_num_exhau¡ed
(
ngtı2_cÚn
 *
cÚn
) {

6331  
cÚn
->
š_pkŠs
.
Ï¡_tx_pkt_num
 =ğ
NGTCP2_MAX_PKT_NUM
 ||

6332 
cÚn
->
hs_pkŠs
.
Ï¡_tx_pkt_num
 =ğ
NGTCP2_MAX_PKT_NUM
 ||

6333 
cÚn
->
pkŠs
.
Ï¡_tx_pkt_num
 =ğ
NGTCP2_MAX_PKT_NUM
;

6334 
	}
}

6340 
size_t
 
	$cÚn_£rv”_hs_tx_Ëá
(
ngtı2_cÚn
 *
cÚn
) {

6341 ià(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_SADDR_VERIFIED
) {

6342  
SIZE_MAX
;

6347  
cÚn
->
hs_»cved
 * 3 - cÚn->
hs_£Á
;

6348 
	}
}

6350 
	$ngtı2_cÚn_»ad_hªdshake
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
pkt
,

6351 
size_t
 
pk’
, 
ngtı2_t¡amp
 
ts
) {

6352 
rv
;

6353 
ngtı2_pkŠs
 *
hs_pkŠs
 = &
cÚn
->hs_pktns;

6355 
cÚn
->
log
.
Ï¡_ts
 = 
ts
;

6357 ià(
pk’
 > 0) {

6358 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_CON
, "recv…acket†en=%zu",

6359 
pk’
);

6362 
cÚn
->
¡©e
) {

6363 
NGTCP2_CS_CLIENT_INITIAL
:

6366 
NGTCP2_CS_CLIENT_WAIT_HANDSHAKE
:

6367 
rv
 = 
	`cÚn_»cv_hªdshake_ıkt
(
cÚn
, 
pkt
, 
pk’
, 
ts
);

6368 ià(
rv
 < 0) {

6369  
rv
;

6372 ià(
cÚn
->
¡©e
 =ğ
NGTCP2_CS_CLIENT_INITIAL
) {

6377 ià(
hs_pkŠs
->
rx_ckm
) {

6378 
rv
 = 
	`cÚn_´oûss_bufã»d_hªdshake_pkt
(
cÚn
, 
ts
);

6379 ià(
rv
 != 0) {

6380  
rv
;

6385 
NGTCP2_CS_SERVER_INITIAL
:

6386 
rv
 = 
	`cÚn_»cv_hªdshake_ıkt
(
cÚn
, 
pkt
, 
pk’
, 
ts
);

6387 ià(
rv
 < 0) {

6388  
rv
;

6391 ià(
	`ngtı2_rob_fœ¡_g­_off£t
(&
cÚn
->
üy±o
.
rob
) == 0) {

6397 ià(
cÚn
->
—¾y_ckm
) {

6398 
rv
 = 
	`cÚn_´oûss_bufã»d_´Ùeùed_pkt
(
cÚn
, 
ts
);

6399 ià(
rv
 != 0) {

6400  
rv
;

6403 
	`d–‘e_bufãd_pkts
(
cÚn
->
bufãd_rx_µkts
, cÚn->
mem
);

6404 
cÚn
->
bufãd_rx_µkts
 = 
NULL
;

6408 
NGTCP2_CS_SERVER_WAIT_HANDSHAKE
:

6409 
rv
 = 
	`cÚn_»cv_hªdshake_ıkt
(
cÚn
, 
pkt
, 
pk’
, 
ts
);

6410 ià(
rv
 < 0) {

6411  
rv
;

6414 ià(
hs_pkŠs
->
rx_ckm
) {

6415 
rv
 = 
	`cÚn_´oûss_bufã»d_hªdshake_pkt
(
cÚn
, 
ts
);

6416 ià(
rv
 != 0) {

6417  
rv
;

6421 ià(
cÚn
->
hs_pkŠs
.
max_rx_pkt_num
 !ğ(
ušt64_t
)-1) {

6422 
	`cÚn_disÿrd_š™Ÿl_key
(
cÚn
);

6425 ià(!(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_HANDSHAKE_COMPLETED
)) {

6429 ià(!(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_TRANSPORT_PARAM_RECVED
)) {

6430  
NGTCP2_ERR_REQUIRED_TRANSPORT_PARAM
;

6433 
rv
 = 
	`cÚn_hªdshake_com¶‘ed
(
cÚn
);

6434 ià(
rv
 != 0) {

6435  
rv
;

6437 
cÚn
->
¡©e
 = 
NGTCP2_CS_POST_HANDSHAKE
;

6439 
rv
 = 
	`cÚn_´oûss_bufã»d_´Ùeùed_pkt
(
cÚn
, 
ts
);

6440 ià(
rv
 != 0) {

6441  
rv
;

6444 
cÚn
->
hs_pkŠs
.
ackŒ
.
æags
 |ğ
NGTCP2_ACKTR_FLAG_PENDING_FINISHED_ACK
;

6447 
NGTCP2_CS_CLOSING
:

6448  
NGTCP2_ERR_CLOSING
;

6449 
NGTCP2_CS_DRAINING
:

6450  
NGTCP2_ERR_DRAINING
;

6454 
	}
}

6479 
ssize_t
 
	$cÚn_wr™e_hªdshake
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
,

6480 
size_t
 
de¡Ën
, size_ˆ
—¾y_d©®’
,

6481 
ngtı2_t¡amp
 
ts
) {

6482 
rv
;

6483 
ssize_t
 
»s
 = 0, 
nwr™e
 = 0, 
—¾y_¥k’
 = 0;

6484 
ušt64_t
 
cwnd
;

6485 
size_t
 
ÜigËn
 = 
de¡Ën
;

6486 
size_t
 
£rv”_hs_tx_Ëá
;

6487 
ngtı2_rcvry_¡©
 *
rcs
 = &
cÚn
->rcs;

6488 
size_t
 
³ndšg_—¾y_d©®’
;

6490 
cÚn
->
log
.
Ï¡_ts
 = 
ts
;

6492 ià(
	`cÚn_check_pkt_num_exhau¡ed
(
cÚn
)) {

6493  
NGTCP2_ERR_PKT_NUM_EXHAUSTED
;

6496 
cwnd
 = 
	`cÚn_cwnd_Ëá
(
cÚn
);

6497 
de¡Ën
 = 
	`ngtı2_mš
(de¡Ën, 
cwnd
);

6499 
cÚn
->
¡©e
) {

6500 
NGTCP2_CS_CLIENT_INITIAL
:

6501 
³ndšg_—¾y_d©®’
 = 
	`cÚn_»Œy_—¾y_·ylßdËn
(
cÚn
);

6502 ià(
³ndšg_—¾y_d©®’
) {

6503 
—¾y_d©®’
 = 
³ndšg_—¾y_d©®’
;

6506 ià(!(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_RECV_RETRY
)) {

6507 
nwr™e
 =

6508 
	`cÚn_wr™e_ş›Á_š™Ÿl
(
cÚn
, 
de¡
, 
de¡Ën
, 
—¾y_d©®’
, 
ts
);

6509 ià(
nwr™e
 <= 0) {

6510  
nwr™e
;

6513 
nwr™e
 = 
	`cÚn_wr™e_hªdshake_pkt
(
cÚn
, 
de¡
, 
de¡Ën
, 
NGTCP2_PKT_INITIAL
,

6514 
—¾y_d©®’
, 
ts
);

6515 ià(
nwr™e
 < 0) {

6516  
nwr™e
;

6520 ià(
³ndšg_—¾y_d©®’
) {

6521 
—¾y_¥k’
 = 
	`cÚn_»Œªsm™_»Œy_—¾y
(
cÚn
, 
de¡
 + 
nwr™e
,

6522 
de¡Ën
 - (
size_t
)
nwr™e
, 
ts
);

6524 ià(
—¾y_¥k’
 < 0) {

6525 
	`as£¹
(
	`ngtı2_”r_is_çl
(()
—¾y_¥k’
));

6526  
—¾y_¥k’
;

6530 
cÚn
->
¡©e
 = 
NGTCP2_CS_CLIENT_WAIT_HANDSHAKE
;

6532  
nwr™e
 + 
—¾y_¥k’
;

6533 
NGTCP2_CS_CLIENT_WAIT_HANDSHAKE
:

6534 ià(!(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_HANDSHAKE_COMPLETED_HANDLED
)) {

6535 
³ndšg_—¾y_d©®’
 = 
	`cÚn_»Œy_—¾y_·ylßdËn
(
cÚn
);

6536 ià(
³ndšg_—¾y_d©®’
) {

6537 
—¾y_d©®’
 = 
³ndšg_—¾y_d©®’
;

6541 
nwr™e
 = 
	`cÚn_wr™e_hªdshake_pkts
(
cÚn
, 
de¡
, 
de¡Ën
, 
—¾y_d©®’
, 
ts
);

6542 ià(
nwr™e
 < 0) {

6543  
nwr™e
;

6546 ià(
cÚn
->
hs_pkŠs
.
Ï¡_tx_pkt_num
 !ğ(
ušt64_t
)-1) {

6547 
	`cÚn_disÿrd_š™Ÿl_key
(
cÚn
);

6550 
»s
 +ğ
nwr™e
;

6551 
de¡
 +ğ
nwr™e
;

6552 
de¡Ën
 -ğ(
size_t
)
nwr™e
;

6554 ià(!(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_HANDSHAKE_COMPLETED
)) {

6555 
nwr™e
 = 
	`cÚn_»Œªsm™_»Œy_—¾y
(
cÚn
, 
de¡
, 
de¡Ën
, 
ts
);

6556 ià(
nwr™e
 < 0) {

6557  
nwr™e
;

6560 
»s
 +ğ
nwr™e
;

6562 ià(
»s
 == 0) {

6566 
nwr™e
 = 
	`cÚn_wr™e_hªdshake_ack_pkts
(
cÚn
, 
de¡
, 
de¡Ën
, 
ts
);

6567 ià(
nwr™e
 < 0) {

6568  
nwr™e
;

6570 
»s
 = 
nwr™e
;

6572 ià(
»s
) {

6573 
cÚn
->
æags
 &ğ(
ušt16_t
)~
NGTCP2_CONN_FLAG_FORCE_SEND_INITIAL
;

6575  
»s
;

6578 ià(!(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_TRANSPORT_PARAM_RECVED
)) {

6579  
NGTCP2_ERR_REQUIRED_TRANSPORT_PARAM
;

6582 
rv
 = 
	`cÚn_hªdshake_com¶‘ed
(
cÚn
);

6583 ià(
rv
 != 0) {

6584  (
ssize_t
)
rv
;

6587 
cÚn
->
¡©e
 = 
NGTCP2_CS_POST_HANDSHAKE
;

6589 ià(
cÚn
->
»mÙe_£‰šgs
.
¡©–ess_»£t_tok’_´e£Á
) {

6590 
	`memıy
(
cÚn
->
dcid
.
tok’
, cÚn->
»mÙe_£‰šgs
.
¡©–ess_»£t_tok’
,

6591 (
cÚn
->
dcid
.
tok’
));

6594 
	`cÚn_´oûss_—¾y_¹b
(
cÚn
);

6596 
rv
 = 
	`cÚn_´oûss_bufã»d_´Ùeùed_pkt
(
cÚn
, 
ts
);

6597 ià(
rv
 != 0) {

6598  (
ssize_t
)
rv
;

6601  
»s
;

6602 
NGTCP2_CS_SERVER_INITIAL
:

6603 
nwr™e
 = 
	`cÚn_wr™e_£rv”_hªdshake
(
cÚn
, 
de¡
, 
de¡Ën
, 
ts
);

6604 ià(
nwr™e
 < 0) {

6605  
nwr™e
;

6608 ià(
nwr™e
) {

6609 
cÚn
->
¡©e
 = 
NGTCP2_CS_SERVER_WAIT_HANDSHAKE
;

6610 
cÚn
->
hs_£Á
 +ğ(
size_t
)
nwr™e
;

6613  
nwr™e
;

6614 
NGTCP2_CS_SERVER_WAIT_HANDSHAKE
:

6615 ià(!(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_HANDSHAKE_COMPLETED
)) {

6616 
£rv”_hs_tx_Ëá
 = 
	`cÚn_£rv”_hs_tx_Ëá
(
cÚn
);

6617 ià(
£rv”_hs_tx_Ëá
 == 0) {

6618 ià(
rcs
->
loss_d‘eùiÚ_tim”
) {

6619 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_RCV
,

6621 
rcs
->
loss_d‘eùiÚ_tim”
 = 0;

6626 
de¡Ën
 = 
	`ngtı2_mš
(de¡Ën, 
£rv”_hs_tx_Ëá
);

6627 
nwr™e
 = 
	`cÚn_wr™e_£rv”_hªdshake
(
cÚn
, 
de¡
, 
de¡Ën
, 
ts
);

6628 ià(
nwr™e
 < 0) {

6629  
nwr™e
;

6634 
»s
 +ğ
nwr™e
;

6635 
de¡
 +ğ
nwr™e
;

6636 
de¡Ën
 -ğ(
size_t
)
nwr™e
;

6638 
nwr™e
 = 
	`cÚn_wr™e_hªdshake_ack_pkts
(

6639 
cÚn
, 
de¡
,

6640 
»s
 =ğ0 ? 
	`ngtı2_mš
(
ÜigËn
, 
£rv”_hs_tx_Ëá
è: 
de¡Ën
, 
ts
);

6641 ià(
nwr™e
 < 0) {

6642  
nwr™e
;

6645 
»s
 +ğ
nwr™e
;

6646 
cÚn
->
hs_£Á
 +ğ(
size_t
)
»s
;

6647  
»s
;

6650 
nwr™e
 = 
	`cÚn_wr™e_hªdshake_ack_pkts
(
cÚn
, 
de¡
, 
ÜigËn
, 
ts
);

6651 ià(
nwr™e
 < 0) {

6652  
nwr™e
;

6655 
»s
 +ğ
nwr™e
;

6657 ià(!(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_TRANSPORT_PARAM_RECVED
)) {

6658  
NGTCP2_ERR_REQUIRED_TRANSPORT_PARAM
;

6661 
rv
 = 
	`cÚn_hªdshake_com¶‘ed
(
cÚn
);

6662 ià(
rv
 != 0) {

6663  (
ssize_t
)
rv
;

6665 
cÚn
->
¡©e
 = 
NGTCP2_CS_POST_HANDSHAKE
;

6667 
rv
 = 
	`cÚn_´oûss_bufã»d_´Ùeùed_pkt
(
cÚn
, 
ts
);

6668 ià(
rv
 != 0) {

6669  (
ssize_t
)
rv
;

6672 
cÚn
->
hs_pkŠs
.
ackŒ
.
æags
 |ğ
NGTCP2_ACKTR_FLAG_PENDING_FINISHED_ACK
;

6674  
»s
;

6675 
NGTCP2_CS_CLOSING
:

6676  
NGTCP2_ERR_CLOSING
;

6677 
NGTCP2_CS_DRAINING
:

6678  
NGTCP2_ERR_DRAINING
;

6682 
	}
}

6684 
ssize_t
 
	$ngtı2_cÚn_wr™e_hªdshake
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
,

6685 
size_t
 
de¡Ën
, 
ngtı2_t¡amp
 
ts
) {

6686  
	`cÚn_wr™e_hªdshake
(
cÚn
, 
de¡
, 
de¡Ën
, 0, 
ts
);

6687 
	}
}

6705 
ssize_t
 
	$cÚn_wr™e_¡»am_—¾y
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
,

6706 
size_t
 
de¡Ën
, 
ssize_t
 *
pd©®’
,

6707 
ngtı2_¡rm
 *
¡rm
, 
ušt8_t
 
fš
,

6708 cÚ¡ 
ngtı2_vec
 *
d©av
, 
size_t
 
d©avút
,

6709 
»quœe_·ddšg
, 
ngtı2_t¡amp
 
ts
) {

6710 
ngtı2_üy±o_ùx
 
ùx
;

6711 
ngtı2_µe
 
µe
;

6712 
ngtı2_¹b_’Œy
 *
’t
;

6713 
ngtı2_¡»am_äame_chaš
 *
äc
;

6714 
ngtı2_äame
 
loÿlä
;

6715 
ngtı2_pkt_hd
 
hd
;

6716 
rv
;

6717 
size_t
 
nd©®’
, 
Ëá
;

6718 
ssize_t
 
nwr™e
;

6719 
ušt8_t
 
pkt_æags
;

6720 
ušt8_t
 
pkt_ty³
;

6721 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->pktns;

6722 
size_t
 
d©®’
 = 
	`ngtı2_vec_Ën
(
d©av
, 
d©avút
);

6724 
	`as£¹
(!
cÚn
->
£rv”
);

6725 
	`as£¹
(
cÚn
->
—¾y_ckm
);

6727 
pkt_æags
 = 
NGTCP2_PKT_FLAG_LONG_FORM
;

6728 
pkt_ty³
 = 
NGTCP2_PKT_0RTT_PROTECTED
;

6729 
ùx
.
ckm
 = 
cÚn
->
—¾y_ckm
;

6730 
ùx
.
hp
 = 
cÚn
->
—¾y_hp
;

6732 
	`ngtı2_pkt_hd_š™
(

6733 &
hd
, 
pkt_æags
, 
pkt_ty³
, &
cÚn
->
dcid
.
cid
, &cÚn->
oscid
,

6734 
pkŠs
->
Ï¡_tx_pkt_num
 + 1,

6735 
	`¹b_£Ëù_pkt_numËn
(&
pkŠs
->
¹b
,…kŠs->
Ï¡_tx_pkt_num
 + 1),

6736 
cÚn
->
v”siÚ
, 0);

6738 
ùx
.
«ad_ov”h—d
 = 
cÚn
->aead_overhead;

6739 
ùx
.
’üy±
 = 
cÚn
->
ÿÎbacks
.encrypt;

6740 
ùx
.
hp_mask
 = 
cÚn
->
ÿÎbacks
.hp_mask;

6741 
ùx
.
u£r_d©a
 = 
cÚn
;

6743 
	`ngtı2_µe_š™
(&
µe
, 
de¡
, 
de¡Ën
, &
ùx
);

6745 
rv
 = 
	`ngtı2_µe_’code_hd
(&
µe
, &
hd
);

6746 ià(
rv
 != 0) {

6747 
	`as£¹
(
NGTCP2_ERR_NOBUF
 =ğ
rv
);

6751 ià(!
	`ngtı2_µe_’su»_hp_§m¶e
(&
µe
)) {

6755 
	`ngtı2_log_tx_pkt_hd
(&
cÚn
->
log
, &
hd
);

6757 
nd©®’
 = 
	`cÚn_’fÜû_æow_cÚŒŞ
(
cÚn
, 
¡rm
, 
d©®’
);

6758 ià(
d©®’
 > 0 && 
nd©®’
 == 0) {

6759  
NGTCP2_ERR_STREAM_DATA_BLOCKED
;

6762 
Ëá
 = 
	`ngtı2_µe_Ëá
(&
µe
);

6763 
nd©®’
 = 
	`ngtı2_pkt_¡»am_max_d©®’
(
¡rm
->
¡»am_id
, sŒm->
tx_off£t
,

6764 
nd©®’
, 
Ëá
);

6765 ià(
nd©®’
 =ğ(
size_t
)-1 || (nd©®’ =ğ0 && 
d©®’
)) {

6769 
fš
 = fš && 
nd©®’
 =ğ
d©®’
;

6771 
rv
 = 
	`ngtı2_¡»am_äame_chaš_Ãw
(&
äc
, 
cÚn
->
mem
);

6772 ià(
rv
 != 0) {

6773 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

6774  
rv
;

6777 
äc
->
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

6778 
äc
->
ä
.
æags
 = 0;

6779 
äc
->
ä
.
fš
 = fin;

6780 
äc
->
ä
.
¡»am_id
 = 
¡rm
->stream_id;

6781 
äc
->
ä
.
off£t
 = 
¡rm
->
tx_off£t
;

6782 
äc
->
ä
.
d©aút
 = 
	`ngtı2_vec_cİy
(äc->ä.
d©a
, 
NGTCP2_MAX_STREAM_DATACNT
,

6783 
d©av
, 
d©avút
, 
nd©®’
);

6785 
rv
 = 
	`cÚn_µe_wr™e_äame
(
cÚn
, &
µe
, &
hd
, &
äc
->äc.
ä
);

6786 ià(
rv
 != 0) {

6787 
	`as£¹
(0);

6790 ià(
»quœe_·ddšg
 && 
	`ngtı2_µe_Ëá
(&
µe
)) {

6791 
loÿlä
.
ty³
 = 
NGTCP2_FRAME_PADDING
;

6792 
loÿlä
.
·ddšg
.
Ën
 = 
	`ngtı2_µe_·ddšg
(&
µe
);

6794 
	`ngtı2_log_tx_ä
(&
cÚn
->
log
, &
hd
, &
loÿlä
);

6796 
loÿlä
.
ty³
 = 
NGTCP2_FRAME_PADDING
;

6797 
loÿlä
.
·ddšg
.
Ën
 = 
	`ngtı2_µe_·ddšg_hp_§m¶e
(&
µe
);

6798 ià(
loÿlä
.
·ddšg
.
Ën
) {

6799 
	`ngtı2_log_tx_ä
(&
cÚn
->
log
, &
hd
, &
loÿlä
);

6803 
nwr™e
 = 
	`ngtı2_µe_fš®
(&
µe
, 
NULL
);

6804 ià(
nwr™e
 < 0) {

6805 
	`as£¹
(
	`ngtı2_”r_is_çl
(()
nwr™e
));

6806 
	`ngtı2_¡»am_äame_chaš_d–
(
äc
, 
cÚn
->
mem
);

6807  
nwr™e
;

6810 
rv
 = 
	`ngtı2_¹b_’Œy_Ãw
(&
’t
, &
hd
, &
äc
->äc, 
ts
, (
size_t
)
nwr™e
,

6811 
NGTCP2_RTB_FLAG_ACK_ELICITING
, 
cÚn
->
mem
);

6812 ià(
rv
 != 0) {

6813 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

6814 
	`ngtı2_¡»am_äame_chaš_d–
(
äc
, 
cÚn
->
mem
);

6815  
rv
;

6818 
rv
 = 
	`cÚn_Ú_pkt_£Á
(
cÚn
, &
pkŠs
->
¹b
, 
’t
);

6819 ià(
rv
 != 0) {

6820 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

6821 
	`ngtı2_¹b_’Œy_d–
(
’t
, 
cÚn
->
mem
);

6822  
rv
;

6825 
¡rm
->
tx_off£t
 +ğ
nd©®’
;

6826 
cÚn
->
tx_off£t
 +ğ
nd©®’
;

6828 ++
pkŠs
->
Ï¡_tx_pkt_num
;

6830 ià(
pd©®’
) {

6831 *
pd©®’
 = (
ssize_t
)
nd©®’
;

6834 ià(
fš
) {

6835 
	`ngtı2_¡rm_shutdown
(
¡rm
, 
NGTCP2_STRM_FLAG_SHUT_WR
);

6838  
nwr™e
;

6839 
	}
}

6841 
ssize_t
 
	$ngtı2_cÚn_ş›Á_wr™e_hªdshake
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
,

6842 
size_t
 
de¡Ën
, 
ssize_t
 *
pd©®’
,

6843 
ušt64_t
 
¡»am_id
, 
ušt8_t
 
fš
,

6844 cÚ¡ 
ngtı2_vec
 *
d©av
,

6845 
size_t
 
d©avút
, 
ngtı2_t¡amp
 
ts
) {

6846 
ngtı2_¡rm
 *
¡rm
 = 
NULL
;

6847 
£nd_¡»am
 = 0;

6848 
ssize_t
 
¥k’
, 
—¾y_¥k’
;

6849 
ušt64_t
 
cwnd
;

6850 
»quœe_·ddšg
;

6851 
was_ş›Á_š™Ÿl
;

6852 
size_t
 
d©®’
 = 
	`ngtı2_vec_Ën
(
d©av
, 
d©avút
);

6853 
size_t
 
—¾y_d©®’
 = 0;

6855 ià(
pd©®’
) {

6856 *
pd©®’
 = -1;

6859 ià(
cÚn
->
£rv”
) {

6860  
NGTCP2_ERR_INVALID_STATE
;

6865 ià(
¡»am_id
 !ğ(
ušt64_t
)-1 &&

6866 !(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_EARLY_DATA_REJECTED
)) {

6867 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
);

6868 ià(
¡rm
 =ğ
NULL
) {

6869  
NGTCP2_ERR_STREAM_NOT_FOUND
;

6872 ià(
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_SHUT_WR
) {

6873  
NGTCP2_ERR_STREAM_SHUT_WR
;

6876 
£nd_¡»am
 = 
	`cÚn_»Œy_—¾y_·ylßdËn
(
cÚn
) == 0 &&

6878 (
d©®’
 == 0 ||

6879 (
d©®’
 > 0 && (
¡rm
->
max_tx_off£t
 - sŒm->
tx_off£t
) &&

6880 (
cÚn
->
max_tx_off£t
 - cÚn->
tx_off£t
)));

6881 ià(
£nd_¡»am
) {

6882 
—¾y_d©®’
 =

6883 
	`ngtı2_mš
(
d©®’
, 
¡rm
->
max_tx_off£t
 - sŒm->
tx_off£t
);

6884 
—¾y_d©®’
 =

6885 
	`ngtı2_mš
(
—¾y_d©®’
, 
cÚn
->
max_tx_off£t
 - cÚn->
tx_off£t
) +

6886 
NGTCP2_STREAM_OVERHEAD
;

6890 
was_ş›Á_š™Ÿl
 = 
cÚn
->
¡©e
 =ğ
NGTCP2_CS_CLIENT_INITIAL
;

6891 
¥k’
 = 
	`cÚn_wr™e_hªdshake
(
cÚn
, 
de¡
, 
de¡Ën
, 
—¾y_d©®’
, 
ts
);

6893 ià(
¥k’
 < 0) {

6894  
¥k’
;

6897 ià(
cÚn
->
pkŠs
.
tx_ckm
 || !cÚn->
—¾y_ckm
 || !
£nd_¡»am
) {

6898  
¥k’
;

6905 
»quœe_·ddšg
 = 
¥k’
 && 
was_ş›Á_š™Ÿl
;

6907 
cwnd
 = 
	`cÚn_cwnd_Ëá
(
cÚn
);

6909 
de¡
 +ğ
¥k’
;

6910 
de¡Ën
 -ğ(
size_t
)
¥k’
;

6911 
de¡Ën
 = 
	`ngtı2_mš
(de¡Ën, 
cwnd
);

6913 
—¾y_¥k’
 =

6914 
	`cÚn_wr™e_¡»am_—¾y
(
cÚn
, 
de¡
, 
de¡Ën
, 
pd©®’
, 
¡rm
, 
fš
, 
d©av
,

6915 
d©avút
, 
»quœe_·ddšg
, 
ts
);

6917 ià(
—¾y_¥k’
 < 0) {

6918 ià(
—¾y_¥k’
 =ğ
NGTCP2_ERR_STREAM_DATA_BLOCKED
) {

6919  
¥k’
;

6921  
—¾y_¥k’
;

6924  
¥k’
 + 
—¾y_¥k’
;

6925 
	}
}

6927 
	$ngtı2_cÚn_hªdshake_com¶‘ed
(
ngtı2_cÚn
 *
cÚn
) {

6928 
cÚn
->
æags
 |ğ
NGTCP2_CONN_FLAG_HANDSHAKE_COMPLETED
;

6929 
	}
}

6931 
	$ngtı2_cÚn_g‘_hªdshake_com¶‘ed
(
ngtı2_cÚn
 *
cÚn
) {

6932  (
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_HANDSHAKE_COMPLETED
) &&

6933 (
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_HANDSHAKE_COMPLETED_HANDLED
);

6934 
	}
}

6936 
	$ngtı2_cÚn_sched_ack
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_ackŒ
 *
ackŒ
,

6937 
ušt64_t
 
pkt_num
, 
aùive_ack
, 
ngtı2_t¡amp
 
ts
) {

6938 
rv
;

6939 ()
cÚn
;

6941 
rv
 = 
	`ngtı2_ackŒ_add
(
ackŒ
, 
pkt_num
, 
aùive_ack
, 
ts
);

6942 ià(
rv
 != 0) {

6943 
	`as£¹
(
rv
 !ğ
NGTCP2_ERR_INVALID_ARGUMENT
);

6944  
rv
;

6948 
	}
}

6950 
	$ngtı2_acû±
(
ngtı2_pkt_hd
 *
de¡
, cÚ¡ 
ušt8_t
 *
pkt
, 
size_t
 
pk’
) {

6951 
ssize_t
 
Ä—d
;

6952 
ngtı2_pkt_hd
 
hd
, *
p
;

6954 ià(
de¡
) {

6955 
p
 = 
de¡
;

6957 
p
 = &
hd
;

6960 ià(
pk’
 =ğ0 || (
pkt
[0] & 
NGTCP2_HEADER_FORM_BIT
) == 0) {

6964 
Ä—d
 = 
	`ngtı2_pkt_decode_hd_lÚg
(
p
, 
pkt
, 
pk’
);

6965 ià(
Ä—d
 < 0) {

6969 
p
->
ty³
) {

6970 
NGTCP2_PKT_INITIAL
:

6971 ià(
pk’
 < 
NGTCP2_MIN_INITIAL_PKTLEN
) {

6975 
NGTCP2_PKT_0RTT_PROTECTED
:

6983 
p
->
v”siÚ
) {

6984 
NGTCP2_PROTO_VER_D17
:

6991 
	}
}

6993 
	$ngtı2_cÚn_£t_«ad_ov”h—d
(
ngtı2_cÚn
 *
cÚn
, 
size_t
 
«ad_ov”h—d
) {

6994 
cÚn
->
«ad_ov”h—d
 =‡ead_overhead;

6995 
	}
}

6997 
	$ngtı2_cÚn_š¡®l_š™Ÿl_tx_keys
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
key
,

6998 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
iv
,

6999 
size_t
 
ivËn
, cÚ¡ 
ušt8_t
 *
²
,

7000 
size_t
 
²Ën
) {

7001 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->
š_pkŠs
;

7002 
rv
;

7004 ià(
pkŠs
->
tx_hp
) {

7005 
	`ngtı2_vec_d–
(
pkŠs
->
tx_hp
, 
cÚn
->
mem
);

7006 
pkŠs
->
tx_hp
 = 
NULL
;

7008 ià(
pkŠs
->
tx_ckm
) {

7009 
	`ngtı2_üy±o_km_d–
(
pkŠs
->
tx_ckm
, 
cÚn
->
mem
);

7010 
pkŠs
->
tx_ckm
 = 
NULL
;

7013 
rv
 = 
	`ngtı2_üy±o_km_Ãw
(&
pkŠs
->
tx_ckm
, 
key
, 
keyËn
, 
iv
, 
ivËn
, 
cÚn
->
mem
);

7014 ià(
rv
 != 0) {

7015  
rv
;

7018  
	`ngtı2_vec_Ãw
(&
pkŠs
->
tx_hp
, 
²
, 
²Ën
, 
cÚn
->
mem
);

7019 
	}
}

7021 
	$ngtı2_cÚn_š¡®l_š™Ÿl_rx_keys
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
key
,

7022 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
iv
,

7023 
size_t
 
ivËn
, cÚ¡ 
ušt8_t
 *
²
,

7024 
size_t
 
²Ën
) {

7025 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->
š_pkŠs
;

7026 
rv
;

7028 ià(
pkŠs
->
rx_hp
) {

7029 
	`ngtı2_vec_d–
(
pkŠs
->
rx_hp
, 
cÚn
->
mem
);

7030 
pkŠs
->
rx_hp
 = 
NULL
;

7032 ià(
pkŠs
->
rx_ckm
) {

7033 
	`ngtı2_üy±o_km_d–
(
pkŠs
->
rx_ckm
, 
cÚn
->
mem
);

7034 
pkŠs
->
rx_ckm
 = 
NULL
;

7037 
rv
 = 
	`ngtı2_üy±o_km_Ãw
(&
pkŠs
->
rx_ckm
, 
key
, 
keyËn
, 
iv
, 
ivËn
, 
cÚn
->
mem
);

7038 ià(
rv
 != 0) {

7039  
rv
;

7042  
	`ngtı2_vec_Ãw
(&
pkŠs
->
rx_hp
, 
²
, 
²Ën
, 
cÚn
->
mem
);

7043 
	}
}

7045 
	$ngtı2_cÚn_š¡®l_hªdshake_tx_keys
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
key
,

7046 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
iv
,

7047 
size_t
 
ivËn
, cÚ¡ 
ušt8_t
 *
²
,

7048 
size_t
 
²Ën
) {

7049 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->
hs_pkŠs
;

7050 
rv
;

7052 ià(
pkŠs
->
tx_hp
 ||…kŠs->
tx_ckm
) {

7053  
NGTCP2_ERR_INVALID_STATE
;

7056 
rv
 = 
	`ngtı2_üy±o_km_Ãw
(&
pkŠs
->
tx_ckm
, 
key
, 
keyËn
, 
iv
, 
ivËn
, 
cÚn
->
mem
);

7057 ià(
rv
 != 0) {

7058  
rv
;

7061  
	`ngtı2_vec_Ãw
(&
pkŠs
->
tx_hp
, 
²
, 
²Ën
, 
cÚn
->
mem
);

7062 
	}
}

7064 
	$ngtı2_cÚn_š¡®l_hªdshake_rx_keys
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
key
,

7065 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
iv
,

7066 
size_t
 
ivËn
, cÚ¡ 
ušt8_t
 *
²
,

7067 
size_t
 
²Ën
) {

7068 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->
hs_pkŠs
;

7069 
rv
;

7071 ià(
pkŠs
->
rx_hp
 ||…kŠs->
rx_ckm
) {

7072  
NGTCP2_ERR_INVALID_STATE
;

7075 
cÚn
->
hs_pkŠs
.
üy±o_rx_off£t_ba£
 = cÚn->
üy±o
.
Ï¡_rx_off£t
;

7077 
rv
 = 
	`ngtı2_üy±o_km_Ãw
(&
pkŠs
->
rx_ckm
, 
key
, 
keyËn
, 
iv
, 
ivËn
, 
cÚn
->
mem
);

7078 ià(
rv
 != 0) {

7079  
rv
;

7082  
	`ngtı2_vec_Ãw
(&
pkŠs
->
rx_hp
, 
²
, 
²Ën
, 
cÚn
->
mem
);

7083 
	}
}

7085 
	$ngtı2_cÚn_š¡®l_—¾y_keys
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
key
,

7086 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
iv
,

7087 
size_t
 
ivËn
, cÚ¡ 
ušt8_t
 *
²
,

7088 
size_t
 
²Ën
) {

7089 
rv
;

7091 ià(
cÚn
->
—¾y_hp
 || cÚn->
—¾y_ckm
) {

7092  
NGTCP2_ERR_INVALID_STATE
;

7095 
rv
 =

7096 
	`ngtı2_üy±o_km_Ãw
(&
cÚn
->
—¾y_ckm
, 
key
, 
keyËn
, 
iv
, 
ivËn
, cÚn->
mem
);

7097 ià(
rv
 != 0) {

7098  
rv
;

7101  
	`ngtı2_vec_Ãw
(&
cÚn
->
—¾y_hp
, 
²
, 
²Ën
, cÚn->
mem
);

7102 
	}
}

7104 
	$ngtı2_cÚn_š¡®l_tx_keys
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
key
,

7105 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
iv
, size_ˆ
ivËn
,

7106 cÚ¡ 
ušt8_t
 *
²
, 
size_t
 
²Ën
) {

7107 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->pktns;

7108 
rv
;

7110 ià(
pkŠs
->
tx_hp
 ||…kŠs->
tx_ckm
) {

7111  
NGTCP2_ERR_INVALID_STATE
;

7114 
rv
 = 
	`ngtı2_üy±o_km_Ãw
(&
pkŠs
->
tx_ckm
, 
key
, 
keyËn
, 
iv
, 
ivËn
, 
cÚn
->
mem
);

7115 ià(
rv
 != 0) {

7116  
rv
;

7119  
	`ngtı2_vec_Ãw
(&
pkŠs
->
tx_hp
, 
²
, 
²Ën
, 
cÚn
->
mem
);

7120 
	}
}

7122 
	$ngtı2_cÚn_š¡®l_rx_keys
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
key
,

7123 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
iv
, size_ˆ
ivËn
,

7124 cÚ¡ 
ušt8_t
 *
²
, 
size_t
 
²Ën
) {

7125 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->pktns;

7126 
rv
;

7128 ià(
pkŠs
->
rx_hp
 ||…kŠs->
rx_ckm
) {

7129  
NGTCP2_ERR_INVALID_STATE
;

7133 ià(
cÚn
->
pkŠs
.
üy±o_rx_off£t_ba£
 == 0) {

7134 
cÚn
->
pkŠs
.
üy±o_rx_off£t_ba£
 = cÚn->
üy±o
.
Ï¡_rx_off£t
;

7137 
rv
 = 
	`ngtı2_üy±o_km_Ãw
(&
pkŠs
->
rx_ckm
, 
key
, 
keyËn
, 
iv
, 
ivËn
, 
cÚn
->
mem
);

7138 ià(
rv
 != 0) {

7139  
rv
;

7142  
	`ngtı2_vec_Ãw
(&
pkŠs
->
rx_hp
, 
²
, 
²Ën
, 
cÚn
->
mem
);

7143 
	}
}

7145 
	$ngtı2_cÚn_upd©e_tx_key
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
key
,

7146 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
iv
, size_ˆ
ivËn
) {

7147 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->pktns;

7148 
rv
;

7150 ià((
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_WAIT_FOR_REMOTE_KEY_UPDATE
) ||

7151 
cÚn
->
Ãw_tx_ckm
) {

7152  
NGTCP2_ERR_INVALID_STATE
;

7155 
rv
 = 
	`ngtı2_üy±o_km_Ãw
(&
cÚn
->
Ãw_tx_ckm
, 
key
, 
keyËn
, 
iv
, 
ivËn
,

7156 
cÚn
->
mem
);

7157 ià(
rv
 != 0) {

7158  
rv
;

7161 ià(!(
pkŠs
->
tx_ckm
->
æags
 & 
NGTCP2_CRYPTO_KM_FLAG_KEY_PHASE_ONE
)) {

7162 
cÚn
->
Ãw_tx_ckm
->
æags
 |ğ
NGTCP2_CRYPTO_KM_FLAG_KEY_PHASE_ONE
;

7166 
	}
}

7168 
	$ngtı2_cÚn_upd©e_rx_key
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
key
,

7169 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
iv
, size_ˆ
ivËn
) {

7170 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->pktns;

7171 
rv
;

7173 ià((
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_WAIT_FOR_REMOTE_KEY_UPDATE
) ||

7174 
cÚn
->
Ãw_rx_ckm
) {

7175  
NGTCP2_ERR_INVALID_STATE
;

7178 
rv
 = 
	`ngtı2_üy±o_km_Ãw
(&
cÚn
->
Ãw_rx_ckm
, 
key
, 
keyËn
, 
iv
, 
ivËn
,

7179 
cÚn
->
mem
);

7180 ià(
rv
 != 0) {

7181  
rv
;

7184 ià(!(
pkŠs
->
rx_ckm
->
æags
 & 
NGTCP2_CRYPTO_KM_FLAG_KEY_PHASE_ONE
)) {

7185 
cÚn
->
Ãw_rx_ckm
->
æags
 |ğ
NGTCP2_CRYPTO_KM_FLAG_KEY_PHASE_ONE
;

7189 
	}
}

7191 
	$ngtı2_cÚn_š™Ÿ‹_key_upd©e
(
ngtı2_cÚn
 *
cÚn
) {

7192 ià((
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_WAIT_FOR_REMOTE_KEY_UPDATE
) ||

7193 !
cÚn
->
Ãw_tx_ckm
 || !cÚn->
Ãw_rx_ckm
) {

7194  
NGTCP2_ERR_INVALID_STATE
;

7197 
	`cÚn_comm™_key_upd©e
(
cÚn
, 
NGTCP2_MAX_PKT_NUM
);

7199 
cÚn
->
æags
 |ğ
NGTCP2_CONN_FLAG_WAIT_FOR_REMOTE_KEY_UPDATE
;

7202 
	}
}

7204 
ngtı2_t¡amp
 
	$ngtı2_cÚn_loss_d‘eùiÚ_expœy
(
ngtı2_cÚn
 *
cÚn
) {

7205 ià(
cÚn
->
pv
) {

7206  
	`ngtı2_pv_Ãxt_expœy
(
cÚn
->
pv
);

7208 ià(
cÚn
->
rcs
.
loss_d‘eùiÚ_tim”
) {

7209  
cÚn
->
rcs
.
loss_d‘eùiÚ_tim”
;

7211  
UINT64_MAX
;

7212 
	}
}

7214 
ngtı2_t¡amp
 
	$ngtı2_cÚn_ack_d–ay_expœy
(
ngtı2_cÚn
 *
cÚn
) {

7215 
ngtı2_ackŒ
 *
š_ackŒ
 = &
cÚn
->
š_pkŠs
.
ackŒ
;

7216 
ngtı2_ackŒ
 *
hs_ackŒ
 = &
cÚn
->
hs_pkŠs
.
ackŒ
;

7217 
ngtı2_ackŒ
 *
ackŒ
 = &
cÚn
->
pkŠs
.acktr;

7218 
ngtı2_t¡amp
 
ts
 = 
UINT64_MAX
, 
t
;

7220 ià(
cÚn
->
pv
) {

7221  
ts
;

7224 ià(
š_ackŒ
->
fœ¡_uÇcked_ts
 !ğ
UINT64_MAX
) {

7225 
t
 = 
š_ackŒ
->
fœ¡_uÇcked_ts
 + 
NGTCP2_HS_ACK_DELAY
;

7226 
ts
 = 
	`ngtı2_mš
Ñs, 
t
);

7228 ià(
hs_ackŒ
->
fœ¡_uÇcked_ts
 !ğ
UINT64_MAX
) {

7229 
t
 = 
hs_ackŒ
->
fœ¡_uÇcked_ts
 + 
NGTCP2_HS_ACK_DELAY
;

7230 
ts
 = 
	`ngtı2_mš
Ñs, 
t
);

7232 ià(
ackŒ
->
fœ¡_uÇcked_ts
 !ğ
UINT64_MAX
) {

7233 
t
 = 
ackŒ
->
fœ¡_uÇcked_ts
 + 
	`cÚn_compu‹_ack_d–ay
(
cÚn
);

7234 
ts
 = 
	`ngtı2_mš
Ñs, 
t
);

7236  
ts
;

7237 
	}
}

7244 
	$£‰šgs_cİy_äom_Œª¥Üt_·¿ms
(
ngtı2_£‰šgs
 *
de¡
,

7245 cÚ¡ 
ngtı2_Œª¥Üt_·¿ms
 *
¤c
) {

7246 
de¡
->
max_¡»am_d©a_bidi_loÿl
 = 
¤c
->
š™Ÿl_max_¡»am_d©a_bidi_loÿl
;

7247 
de¡
->
max_¡»am_d©a_bidi_»mÙe
 = 
¤c
->
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
;

7248 
de¡
->
max_¡»am_d©a_uni
 = 
¤c
->
š™Ÿl_max_¡»am_d©a_uni
;

7249 
de¡
->
max_d©a
 = 
¤c
->
š™Ÿl_max_d©a
;

7250 
de¡
->
max_¡»ams_bidi
 = 
¤c
->
š™Ÿl_max_¡»ams_bidi
;

7251 
de¡
->
max_¡»ams_uni
 = 
¤c
->
š™Ÿl_max_¡»ams_uni
;

7252 
de¡
->
idË_timeout
 = 
¤c
->idle_timeout;

7253 
de¡
->
max_·ck‘_size
 = 
¤c
->max_packet_size;

7254 
de¡
->
¡©–ess_»£t_tok’_´e£Á
 = 
¤c
->stateless_reset_token_present;

7255 ià(
¤c
->
¡©–ess_»£t_tok’_´e£Á
) {

7256 
	`memıy
(
de¡
->
¡©–ess_»£t_tok’
, 
¤c
->stateless_reset_token,

7257 (
de¡
->
¡©–ess_»£t_tok’
));

7259 
	`mem£t
(
de¡
->
¡©–ess_»£t_tok’
, 0, (dest->stateless_reset_token));

7261 
de¡
->
ack_d–ay_expÚ’t
 = 
¤c
->ack_delay_exponent;

7262 
de¡
->
di§bË_mig¿tiÚ
 = 
¤c
->disable_migration;

7263 
de¡
->
max_ack_d–ay
 = 
¤c
->max_ack_delay;

7264 
de¡
->
´eã¼ed_add»ss
 = 
¤c
->preferred_address;

7265 
	}
}

7271 
	$Œª¥Üt_·¿ms_cİy_äom_£‰šgs
(
ngtı2_Œª¥Üt_·¿ms
 *
de¡
,

7272 cÚ¡ 
ngtı2_£‰šgs
 *
¤c
) {

7273 
de¡
->
š™Ÿl_max_¡»am_d©a_bidi_loÿl
 = 
¤c
->
max_¡»am_d©a_bidi_loÿl
;

7274 
de¡
->
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
 = 
¤c
->
max_¡»am_d©a_bidi_»mÙe
;

7275 
de¡
->
š™Ÿl_max_¡»am_d©a_uni
 = 
¤c
->
max_¡»am_d©a_uni
;

7276 
de¡
->
š™Ÿl_max_d©a
 = 
¤c
->
max_d©a
;

7277 
de¡
->
š™Ÿl_max_¡»ams_bidi
 = 
¤c
->
max_¡»ams_bidi
;

7278 
de¡
->
š™Ÿl_max_¡»ams_uni
 = 
¤c
->
max_¡»ams_uni
;

7279 
de¡
->
idË_timeout
 = 
¤c
->idle_timeout;

7280 
de¡
->
max_·ck‘_size
 = 
¤c
->max_packet_size;

7281 
de¡
->
¡©–ess_»£t_tok’_´e£Á
 = 
¤c
->stateless_reset_token_present;

7282 ià(
¤c
->
¡©–ess_»£t_tok’_´e£Á
) {

7283 
	`memıy
(
de¡
->
¡©–ess_»£t_tok’
, 
¤c
->stateless_reset_token,

7284 (
de¡
->
¡©–ess_»£t_tok’
));

7286 
	`mem£t
(
de¡
->
¡©–ess_»£t_tok’
, 0, (dest->stateless_reset_token));

7288 
de¡
->
ack_d–ay_expÚ’t
 = 
¤c
->ack_delay_exponent;

7289 
de¡
->
di§bË_mig¿tiÚ
 = 
¤c
->disable_migration;

7290 
de¡
->
max_ack_d–ay
 = 
¤c
->max_ack_delay;

7291 
de¡
->
´eã¼ed_add»ss
 = 
¤c
->preferred_address;

7292 
	}
}

7305 
	$cÚn_ş›Á_v®id©e_Œª¥Üt_·¿ms
(
ngtı2_cÚn
 *
cÚn
,

7306 cÚ¡ 
ngtı2_Œª¥Üt_·¿ms
 *
·¿ms
) {

7307 
size_t
 
i
;

7309 ià(
·¿ms
->
v
.
“
.
ÃgÙŸ‹d_v”siÚ
 !ğ
cÚn
->
v”siÚ
) {

7310  
NGTCP2_ERR_VERSION_NEGOTIATION
;

7313 
i
 = 0; i < 
·¿ms
->
v
.
“
.
Ën
; ++i) {

7314 ià(
·¿ms
->
v
.
“
.
suµÜ‹d_v”siÚs
[
i
] =ğ
cÚn
->
v”siÚ
) {

7319 ià(
i
 =ğ
·¿ms
->
v
.
“
.
Ën
) {

7320  
NGTCP2_ERR_VERSION_NEGOTIATION
;

7323 ià(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_RECV_RETRY
) {

7324 ià(!
·¿ms
->
Üigš®_cÚÃùiÚ_id_´e£Á
) {

7325  
NGTCP2_ERR_TRANSPORT_PARAM
;

7327 ià(!
	`ngtı2_cid_eq
(&
cÚn
->
rcid
, &
·¿ms
->
Üigš®_cÚÃùiÚ_id
)) {

7328  
NGTCP2_ERR_TRANSPORT_PARAM
;

7333 
	}
}

7335 
	$cÚn_sync_¡»am_id_lim™
(
ngtı2_cÚn
 *
cÚn
) {

7336 ià(
cÚn
->
£rv”
) {

7337 
cÚn
->
max_loÿl_¡»am_id_bidi
 =

7338 
	`ngtı2_Áh_£rv”_bidi_id
(
cÚn
->
»mÙe_£‰šgs
.
max_¡»ams_bidi
);

7339 
cÚn
->
max_loÿl_¡»am_id_bidi
 =

7340 
	`ngtı2_mš
(
cÚn
->
max_loÿl_¡»am_id_bidi
, 
NGTCP2_MAX_SERVER_ID_BIDI
);

7342 
cÚn
->
max_loÿl_¡»am_id_uni
 =

7343 
	`ngtı2_Áh_£rv”_uni_id
(
cÚn
->
»mÙe_£‰šgs
.
max_¡»ams_uni
);

7344 
cÚn
->
max_loÿl_¡»am_id_uni
 =

7345 
	`ngtı2_mš
(
cÚn
->
max_loÿl_¡»am_id_uni
, 
NGTCP2_MAX_SERVER_ID_UNI
);

7347 
cÚn
->
max_loÿl_¡»am_id_bidi
 =

7348 
	`ngtı2_Áh_ş›Á_bidi_id
(
cÚn
->
»mÙe_£‰šgs
.
max_¡»ams_bidi
);

7349 
cÚn
->
max_loÿl_¡»am_id_bidi
 =

7350 
	`ngtı2_mš
(
cÚn
->
max_loÿl_¡»am_id_bidi
, 
NGTCP2_MAX_CLIENT_ID_BIDI
);

7352 
cÚn
->
max_loÿl_¡»am_id_uni
 =

7353 
	`ngtı2_Áh_ş›Á_uni_id
(
cÚn
->
»mÙe_£‰šgs
.
max_¡»ams_uni
);

7354 
cÚn
->
max_loÿl_¡»am_id_uni
 =

7355 
	`ngtı2_mš
(
cÚn
->
max_loÿl_¡»am_id_uni
, 
NGTCP2_MAX_CLIENT_ID_UNI
);

7357 
	}
}

7359 
	$ngtı2_cÚn_£t_»mÙe_Œª¥Üt_·¿ms
(

7360 
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 
ex‰y³
, cÚ¡ 
ngtı2_Œª¥Üt_·¿ms
 *
·¿ms
) {

7361 
rv
;

7363 
ex‰y³
) {

7364 
NGTCP2_TRANSPORT_PARAMS_TYPE_CLIENT_HELLO
:

7365 ià(!
cÚn
->
£rv”
) {

7366  
NGTCP2_ERR_INVALID_ARGUMENT
;

7371 
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
:

7372 ià(
cÚn
->
£rv”
) {

7373  
NGTCP2_ERR_INVALID_ARGUMENT
;

7375 
rv
 = 
	`cÚn_ş›Á_v®id©e_Œª¥Üt_·¿ms
(
cÚn
, 
·¿ms
);

7376 ià(
rv
 != 0) {

7377  
rv
;

7381  
NGTCP2_ERR_INVALID_ARGUMENT
;

7384 
	`ngtı2_log_»mÙe_
(&
cÚn
->
log
, 
ex‰y³
, 
·¿ms
);

7386 
	`£‰šgs_cİy_äom_Œª¥Üt_·¿ms
(&
cÚn
->
»mÙe_£‰šgs
, 
·¿ms
);

7387 
	`cÚn_sync_¡»am_id_lim™
(
cÚn
);

7389 
cÚn
->
max_tx_off£t
 = cÚn->
»mÙe_£‰šgs
.
max_d©a
;

7391 
cÚn
->
æags
 |ğ
NGTCP2_CONN_FLAG_TRANSPORT_PARAM_RECVED
;

7394 
	}
}

7396 
	$ngtı2_cÚn_£t_—¾y_»mÙe_Œª¥Üt_·¿ms
(

7397 
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_Œª¥Üt_·¿ms
 *
·¿ms
) {

7398 ià(
cÚn
->
£rv”
) {

7399  
NGTCP2_ERR_INVALID_STATE
;

7402 
	`£‰šgs_cİy_äom_Œª¥Üt_·¿ms
(&
cÚn
->
»mÙe_£‰šgs
, 
·¿ms
);

7403 
	`cÚn_sync_¡»am_id_lim™
(
cÚn
);

7405 
cÚn
->
max_tx_off£t
 = cÚn->
»mÙe_£‰šgs
.
max_d©a
;

7408 
	}
}

7410 
	$ngtı2_cÚn_g‘_loÿl_Œª¥Üt_·¿ms
(
ngtı2_cÚn
 *
cÚn
,

7411 
ngtı2_Œª¥Üt_·¿ms
 *
·¿ms
,

7412 
ušt8_t
 
ex‰y³
) {

7413 
ex‰y³
) {

7414 
NGTCP2_TRANSPORT_PARAMS_TYPE_CLIENT_HELLO
:

7415 ià(
cÚn
->
£rv”
) {

7416  
NGTCP2_ERR_INVALID_ARGUMENT
;

7419 
·¿ms
->
v
.
ch
.
š™Ÿl_v”siÚ
 = 
cÚn
->
v”siÚ
;

7421 
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
:

7422 ià(!
cÚn
->
£rv”
) {

7423  
NGTCP2_ERR_INVALID_ARGUMENT
;

7426 
·¿ms
->
v
.
“
.
ÃgÙŸ‹d_v”siÚ
 = 
cÚn
->
v”siÚ
;

7427 
·¿ms
->
v
.
“
.
Ën
 = 1;

7428 
·¿ms
->
v
.
“
.
suµÜ‹d_v”siÚs
[0] = 
cÚn
->
v”siÚ
;

7431  
NGTCP2_ERR_INVALID_ARGUMENT
;

7433 
	`Œª¥Üt_·¿ms_cİy_äom_£‰šgs
(
·¿ms
, &
cÚn
->
loÿl_£‰šgs
);

7434 ià(
cÚn
->
£rv”
 && (cÚn->
æags
 & 
NGTCP2_CONN_FLAG_OCID_PRESENT
)) {

7435 
	`ngtı2_cid_š™
(&
·¿ms
->
Üigš®_cÚÃùiÚ_id
, 
cÚn
->
ocid
.
d©a
,

7436 
cÚn
->
ocid
.
d©®’
);

7437 
·¿ms
->
Üigš®_cÚÃùiÚ_id_´e£Á
 = 1;

7439 
·¿ms
->
Üigš®_cÚÃùiÚ_id_´e£Á
 = 0;

7443 
	}
}

7445 
	$ngtı2_cÚn_İ’_bidi_¡»am
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 *
p¡»am_id
,

7446 *
¡»am_u£r_d©a
) {

7447 
rv
;

7448 
ngtı2_¡rm
 *
¡rm
;

7450 ià(
cÚn
->
Ãxt_loÿl_¡»am_id_bidi
 > cÚn->
max_loÿl_¡»am_id_bidi
) {

7451  
NGTCP2_ERR_STREAM_ID_BLOCKED
;

7454 
¡rm
 = 
	`ngtı2_mem_m®loc
(
cÚn
->
mem
, (
ngtı2_¡rm
));

7455 ià(
¡rm
 =ğ
NULL
) {

7456  
NGTCP2_ERR_NOMEM
;

7459 
rv
 = 
	`ngtı2_cÚn_š™_¡»am
(
cÚn
, 
¡rm
, cÚn->
Ãxt_loÿl_¡»am_id_bidi
,

7460 
¡»am_u£r_d©a
);

7461 ià(
rv
 != 0) {

7462 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, 
¡rm
);

7463  
rv
;

7466 *
p¡»am_id
 = 
cÚn
->
Ãxt_loÿl_¡»am_id_bidi
;

7467 
cÚn
->
Ãxt_loÿl_¡»am_id_bidi
 += 4;

7470 
	}
}

7472 
	$ngtı2_cÚn_İ’_uni_¡»am
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 *
p¡»am_id
,

7473 *
¡»am_u£r_d©a
) {

7474 
rv
;

7475 
ngtı2_¡rm
 *
¡rm
;

7477 ià(
cÚn
->
Ãxt_loÿl_¡»am_id_uni
 > cÚn->
max_loÿl_¡»am_id_uni
) {

7478  
NGTCP2_ERR_STREAM_ID_BLOCKED
;

7481 
¡rm
 = 
	`ngtı2_mem_m®loc
(
cÚn
->
mem
, (
ngtı2_¡rm
));

7482 ià(
¡rm
 =ğ
NULL
) {

7483  
NGTCP2_ERR_NOMEM
;

7486 
rv
 = 
	`ngtı2_cÚn_š™_¡»am
(
cÚn
, 
¡rm
, cÚn->
Ãxt_loÿl_¡»am_id_uni
,

7487 
¡»am_u£r_d©a
);

7488 ià(
rv
 != 0) {

7489 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, 
¡rm
);

7490  
rv
;

7492 
	`ngtı2_¡rm_shutdown
(
¡rm
, 
NGTCP2_STRM_FLAG_SHUT_RD
);

7494 *
p¡»am_id
 = 
cÚn
->
Ãxt_loÿl_¡»am_id_uni
;

7495 
cÚn
->
Ãxt_loÿl_¡»am_id_uni
 += 4;

7498 
	}
}

7500 
ngtı2_¡rm
 *
	$ngtı2_cÚn_fšd_¡»am
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
¡»am_id
) {

7501 
ngtı2_m­_’Œy
 *
me
;

7503 
me
 = 
	`ngtı2_m­_fšd
(&
cÚn
->
¡rms
, 
¡»am_id
);

7504 ià(
me
 =ğ
NULL
) {

7505  
NULL
;

7508  
	`ngtı2_¡ruù_of
(
me
, 
ngtı2_¡rm
, me);

7509 
	}
}

7511 
ssize_t
 
	$ngtı2_cÚn_wr™e_¡»am
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_·th
 *
·th
,

7512 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

7513 
ssize_t
 *
pd©®’
, 
ušt64_t
 
¡»am_id
,

7514 
ušt8_t
 
fš
, cÚ¡ ušt8_ˆ*
d©a
,

7515 
size_t
 
d©®’
, 
ngtı2_t¡amp
 
ts
) {

7516 
ngtı2_vec
 
d©av
;

7518 
d©av
.
Ën
 = 
d©®’
;

7519 
d©av
.
ba£
 = (
ušt8_t
 *)
d©a
;

7521  
	`ngtı2_cÚn_wr™ev_¡»am
(
cÚn
, 
·th
, 
de¡
, 
de¡Ën
, 
pd©®’
,

7522 
¡»am_id
, 
fš
, &
d©av
, 1, 
ts
);

7523 
	}
}

7525 
ssize_t
 
	$ngtı2_cÚn_wr™ev_¡»am
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_·th
 *
·th
,

7526 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

7527 
ssize_t
 *
pd©®’
, 
ušt64_t
 
¡»am_id
,

7528 
ušt8_t
 
fš
, cÚ¡ 
ngtı2_vec
 *
d©av
,

7529 
size_t
 
d©avút
, 
ngtı2_t¡amp
 
ts
) {

7530 
ngtı2_¡rm
 *
¡rm
;

7531 
ssize_t
 
nwr™e
;

7532 
ušt64_t
 
cwnd
;

7533 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->pktns;

7534 
size_t
 
ÜigËn
 = 
de¡Ën
;

7535 
size_t
 
£rv”_hs_tx_Ëá
;

7536 
ngtı2_rcvry_¡©
 *
rcs
 = &
cÚn
->rcs;

7537 
rv
;

7539 
cÚn
->
log
.
Ï¡_ts
 = 
ts
;

7541 ià(
pd©®’
) {

7542 *
pd©®’
 = -1;

7545 
cÚn
->
¡©e
) {

7546 
NGTCP2_CS_CLOSING
:

7547  
NGTCP2_ERR_CLOSING
;

7548 
NGTCP2_CS_DRAINING
:

7549  
NGTCP2_ERR_DRAINING
;

7552 ià(
	`cÚn_check_pkt_num_exhau¡ed
(
cÚn
)) {

7553  
NGTCP2_ERR_PKT_NUM_EXHAUSTED
;

7556 
rv
 = 
	`cÚn_»move_»tœed_cÚÃùiÚ_id
(
cÚn
, 
ts
);

7557 ià(
rv
 != 0) {

7558  
rv
;

7561 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
);

7562 ià(
¡rm
 =ğ
NULL
) {

7563  
NGTCP2_ERR_STREAM_NOT_FOUND
;

7566 ià(
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_SHUT_WR
) {

7567  
NGTCP2_ERR_STREAM_SHUT_WR
;

7570 
nwr™e
 = 
	`cÚn_wr™e_·th_»¥Ú£
(
cÚn
, 
·th
, 
de¡
, 
de¡Ën
);

7571 ià(
nwr™e
) {

7572  
nwr™e
;

7575 ià(
cÚn
->
pv
) {

7576 
nwr™e
 = 
	`cÚn_wr™e_·th_ch®Ënge
(
cÚn
, 
·th
, 
de¡
, 
de¡Ën
, 
ts
);

7577 ià(
nwr™e
 || (
cÚn
->
pv
 && (cÚn->pv->
æags
 & 
NGTCP2_PV_FLAG_BLOCKING
))) {

7578  
nwr™e
;

7582 
cwnd
 = 
	`cÚn_cwnd_Ëá
(
cÚn
);

7583 
de¡Ën
 = 
	`ngtı2_mš
(de¡Ën, 
cwnd
);

7585 ià(
cÚn
->
£rv”
) {

7586 
£rv”_hs_tx_Ëá
 = 
	`cÚn_£rv”_hs_tx_Ëá
(
cÚn
);

7587 ià(
£rv”_hs_tx_Ëá
 == 0) {

7588 ià(
rcs
->
loss_d‘eùiÚ_tim”
) {

7589 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_RCV
,

7591 
rcs
->
loss_d‘eùiÚ_tim”
 = 0;

7595 
de¡Ën
 = 
	`ngtı2_mš
(de¡Ën, 
£rv”_hs_tx_Ëá
);

7598 ià(
·th
) {

7599 
	`ngtı2_·th_cİy
(
·th
, &
cÚn
->
dcid
.path);

7602 ià(
	`cÚn_hªdshake_»mÇÁs_Ëá
(
cÚn
)) {

7603 
nwr™e
 = 
	`cÚn_wr™e_hªdshake_pkts
(
cÚn
, 
de¡
, 
de¡Ën
, 0, 
ts
);

7604 ià(
nwr™e
) {

7605  
nwr™e
;

7608 
nwr™e
 = 
	`cÚn_wr™e_hªdshake_ack_pkts
(
cÚn
, 
de¡
, 
ÜigËn
, 
ts
);

7609 ià(
nwr™e
) {

7610  
nwr™e
;

7613 ià(
pkŠs
->
tx_ckm
) {

7614 ià(
cÚn
->
rcs
.
´obe_pkt_Ëá
) {

7615  
	`cÚn_wr™e_´obe_pkt
(
cÚn
, 
de¡
, 
ÜigËn
, 
pd©®’
, 
¡rm
, 
fš
,

7616 
d©av
, 
d©avút
, 
ts
);

7619 
nwr™e
 = 
	`cÚn_wr™e_pkt
(
cÚn
, 
de¡
, 
de¡Ën
, 
pd©®’
, 
¡rm
, 
fš
, 
d©av
,

7620 
d©avút
, 
ts
);

7621 ià(
nwr™e
 < 0) {

7622 
	`as£¹
(
nwr™e
 !ğ
NGTCP2_ERR_NOBUF
);

7623  
nwr™e
;

7625 ià(
nwr™e
 == 0) {

7626  
	`cÚn_wr™e_´Ùeùed_ack_pkt
(
cÚn
, 
de¡
, 
ÜigËn
, 
ts
);

7628  
nwr™e
;

7632 ià(
cÚn
->
£rv”
 || !cÚn->
—¾y_ckm
) {

7633  
NGTCP2_ERR_NOKEY
;

7636 ià(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_EARLY_DATA_REJECTED
) {

7637  
NGTCP2_ERR_EARLY_DATA_REJECTED
;

7640 
nwr™e
 = 
	`cÚn_»Œªsm™_»Œy_—¾y
(
cÚn
, 
de¡
, 
de¡Ën
, 
ts
);

7641 ià(
nwr™e
) {

7642  
nwr™e
;

7645  
	`cÚn_wr™e_¡»am_—¾y
(
cÚn
, 
de¡
, 
de¡Ën
, 
pd©®’
, 
¡rm
, 
fš
,

7646 
d©av
, 
d©avút
, 0, 
ts
);

7647 
	}
}

7649 
ssize_t
 
	$ngtı2_cÚn_wr™e_cÚÃùiÚ_şo£
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_·th
 *
·th
,

7650 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

7651 
ušt16_t
 
”rÜ_code
,

7652 
ngtı2_t¡amp
 
ts
) {

7653 
ssize_t
 
nwr™e
;

7654 
ngtı2_äame
 
ä
;

7655 
ušt8_t
 
pkt_ty³
;

7657 
cÚn
->
log
.
Ï¡_ts
 = 
ts
;

7659 ià(
	`cÚn_check_pkt_num_exhau¡ed
(
cÚn
)) {

7660  
NGTCP2_ERR_PKT_NUM_EXHAUSTED
;

7663 
cÚn
->
¡©e
) {

7664 
NGTCP2_CS_CLOSING
:

7665 
NGTCP2_CS_DRAINING
:

7666  
NGTCP2_ERR_INVALID_STATE
;

7669 ià(
·th
) {

7670 
	`ngtı2_·th_cİy
(
·th
, &
cÚn
->
dcid
.path);

7673 
ä
.
ty³
 = 
NGTCP2_FRAME_CONNECTION_CLOSE
;

7674 
ä
.
cÚÃùiÚ_şo£
.
”rÜ_code
 =ƒrror_code;

7675 
ä
.
cÚÃùiÚ_şo£
.
äame_ty³
 = 0;

7676 
ä
.
cÚÃùiÚ_şo£
.
»asÚËn
 = 0;

7677 
ä
.
cÚÃùiÚ_şo£
.
»asÚ
 = 
NULL
;

7679 ià(
cÚn
->
¡©e
 =ğ
NGTCP2_CS_POST_HANDSHAKE
) {

7680 
pkt_ty³
 = 
NGTCP2_PKT_SHORT
;

7681 } ià(
cÚn
->
hs_pkŠs
.
tx_ckm
) {

7682 
pkt_ty³
 = 
NGTCP2_PKT_HANDSHAKE
;

7684 
	`as£¹
(
cÚn
->
š_pkŠs
.
tx_ckm
);

7685 
pkt_ty³
 = 
NGTCP2_PKT_INITIAL
;

7688 
nwr™e
 = 
	`cÚn_wr™e_sšgË_äame_pkt
(
cÚn
, 
de¡
, 
de¡Ën
, 
pkt_ty³
,

7689 &
cÚn
->
dcid
.
cid
, &
ä
);

7691 ià(
nwr™e
 > 0) {

7692 
cÚn
->
¡©e
 = 
NGTCP2_CS_CLOSING
;

7695  
nwr™e
;

7696 
	}
}

7698 
ssize_t
 
	$ngtı2_cÚn_wr™e_­¶iÿtiÚ_şo£
(
ngtı2_cÚn
 *
cÚn
,

7699 
ngtı2_·th
 *
·th
, 
ušt8_t
 *
de¡
,

7700 
size_t
 
de¡Ën
,

7701 
ušt16_t
 
­p_”rÜ_code
,

7702 
ngtı2_t¡amp
 
ts
) {

7703 
ssize_t
 
nwr™e
;

7704 
ngtı2_äame
 
ä
;

7706 
cÚn
->
log
.
Ï¡_ts
 = 
ts
;

7708 ià(
	`cÚn_check_pkt_num_exhau¡ed
(
cÚn
)) {

7709  
NGTCP2_ERR_PKT_NUM_EXHAUSTED
;

7712 
cÚn
->
¡©e
) {

7713 
NGTCP2_CS_POST_HANDSHAKE
:

7716  
NGTCP2_ERR_INVALID_STATE
;

7719 ià(
·th
) {

7720 
	`ngtı2_·th_cİy
(
·th
, &
cÚn
->
dcid
.path);

7723 
ä
.
ty³
 = 
NGTCP2_FRAME_CONNECTION_CLOSE_APP
;

7724 
ä
.
cÚÃùiÚ_şo£
.
”rÜ_code
 = 
­p_”rÜ_code
;

7725 
ä
.
cÚÃùiÚ_şo£
.
äame_ty³
 = 0;

7726 
ä
.
cÚÃùiÚ_şo£
.
»asÚËn
 = 0;

7727 
ä
.
cÚÃùiÚ_şo£
.
»asÚ
 = 
NULL
;

7729 
nwr™e
 = 
	`cÚn_wr™e_sšgË_äame_pkt
(
cÚn
, 
de¡
, 
de¡Ën
, 
NGTCP2_PKT_SHORT
,

7730 &
cÚn
->
dcid
.
cid
, &
ä
);

7732 ià(
nwr™e
 > 0) {

7733 
cÚn
->
¡©e
 = 
NGTCP2_CS_CLOSING
;

7736  
nwr™e
;

7737 
	}
}

7739 
	$ngtı2_cÚn_is_š_şosšg_³riod
(
ngtı2_cÚn
 *
cÚn
) {

7740  
cÚn
->
¡©e
 =ğ
NGTCP2_CS_CLOSING
;

7741 
	}
}

7743 
	$ngtı2_cÚn_is_š_d¿ššg_³riod
(
ngtı2_cÚn
 *
cÚn
) {

7744  
cÚn
->
¡©e
 =ğ
NGTCP2_CS_DRAINING
;

7745 
	}
}

7747 
	$ngtı2_cÚn_şo£_¡»am
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
,

7748 
ušt16_t
 
­p_”rÜ_code
) {

7749 
rv
;

7751 ià(!
¡rm
->
­p_”rÜ_code
) {

7752 
­p_”rÜ_code
 = 
¡rm
->app_error_code;

7755 
rv
 = 
	`ngtı2_m­_»move
(&
cÚn
->
¡rms
, 
¡rm
->
me
.
key
);

7756 ià(
rv
 != 0) {

7757 
	`as£¹
(
rv
 !ğ
NGTCP2_ERR_INVALID_ARGUMENT
);

7758  
rv
;

7761 
rv
 = 
	`cÚn_ÿÎ_¡»am_şo£
(
cÚn
, 
¡rm
, 
­p_”rÜ_code
);

7762 ià(
rv
 != 0) {

7763  
rv
;

7766 ià(!
	`cÚn_loÿl_¡»am
(
cÚn
, 
¡rm
->
¡»am_id
)) {

7767 ià(
	`bidi_¡»am
(
¡rm
->
¡»am_id
)) {

7768 
	`hªdË_»mÙe_¡»am_id_ex‹nsiÚ
(

7769 &
cÚn
->
un£Á_max_»mÙe_¡»am_id_bidi
);

7771 
	`hªdË_»mÙe_¡»am_id_ex‹nsiÚ
(&
cÚn
->
un£Á_max_»mÙe_¡»am_id_uni
);

7775 ià(
	`ngtı2_¡rm_is_tx_queued
(
¡rm
)) {

7776 
	`ngtı2_pq_»move
(&
cÚn
->
tx_¡rmq
, &
¡rm
->
³
);

7779 
	`ngtı2_¡rm_ä“
(
¡rm
);

7780 
	`ngtı2_mem_ä“
(
cÚn
->
mem
, 
¡rm
);

7783 
	}
}

7785 
	$ngtı2_cÚn_şo£_¡»am_if_shut_rdwr
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
,

7786 
ušt16_t
 
­p_”rÜ_code
) {

7787 ià((
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_SHUT_RDWR
) ==

7788 
NGTCP2_STRM_FLAG_SHUT_RDWR
 &&

7789 ((
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_RECV_RST
) ||

7790 
	`ngtı2_rob_fœ¡_g­_off£t
(&
¡rm
->
rob
è=ğ¡rm->
Ï¡_rx_off£t
) &&

7791 (((
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_SENT_RST
) &&

7792 (
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_RST_ACKED
)) ||

7793 (!(
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_SENT_RST
) &&

7794 
	`ngtı2_g­Œ_fœ¡_g­_off£t
(&
¡rm
->
acked_tx_off£t
) ==

7795 
¡rm
->
tx_off£t
))) {

7796  
	`ngtı2_cÚn_şo£_¡»am
(
cÚn
, 
¡rm
, 
­p_”rÜ_code
);

7799 
	}
}

7811 
	$cÚn_shutdown_¡»am_wr™e
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
,

7812 
ušt16_t
 
­p_”rÜ_code
) {

7813 ià(
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_SENT_RST
) {

7819 
¡rm
->
æags
 |ğ
NGTCP2_STRM_FLAG_SHUT_WR
 | 
NGTCP2_STRM_FLAG_SENT_RST
;

7820 
¡rm
->
­p_”rÜ_code
 =‡pp_error_code;

7822 
	`ngtı2_¡rm_¡»amäq_ş—r
(
¡rm
);

7824  
	`cÚn_»£t_¡»am
(
cÚn
, 
¡rm
, 
­p_”rÜ_code
);

7825 
	}
}

7837 
	$cÚn_shutdown_¡»am_»ad
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
,

7838 
ušt16_t
 
­p_”rÜ_code
) {

7839 ià(
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_STOP_SENDING
) {

7843 
¡rm
->
æags
 |ğ
NGTCP2_STRM_FLAG_STOP_SENDING
;

7844 
¡rm
->
­p_”rÜ_code
 =‡pp_error_code;

7846  
	`cÚn_¡İ_£ndšg
(
cÚn
, 
¡rm
, 
­p_”rÜ_code
);

7847 
	}
}

7849 
	$ngtı2_cÚn_shutdown_¡»am
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
¡»am_id
,

7850 
ušt16_t
 
­p_”rÜ_code
) {

7851 
rv
;

7852 
ngtı2_¡rm
 *
¡rm
;

7854 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
);

7855 ià(
¡rm
 =ğ
NULL
) {

7856  
NGTCP2_ERR_STREAM_NOT_FOUND
;

7859 
rv
 = 
	`cÚn_shutdown_¡»am_»ad
(
cÚn
, 
¡rm
, 
­p_”rÜ_code
);

7860 ià(
rv
 != 0) {

7861  
rv
;

7864 
rv
 = 
	`cÚn_shutdown_¡»am_wr™e
(
cÚn
, 
¡rm
, 
­p_”rÜ_code
);

7865 ià(
rv
 != 0) {

7866  
rv
;

7870 
	}
}

7872 
	$ngtı2_cÚn_shutdown_¡»am_wr™e
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
¡»am_id
,

7873 
ušt16_t
 
­p_”rÜ_code
) {

7874 
ngtı2_¡rm
 *
¡rm
;

7876 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
);

7877 ià(
¡rm
 =ğ
NULL
) {

7878  
NGTCP2_ERR_STREAM_NOT_FOUND
;

7881  
	`cÚn_shutdown_¡»am_wr™e
(
cÚn
, 
¡rm
, 
­p_”rÜ_code
);

7882 
	}
}

7884 
	$ngtı2_cÚn_shutdown_¡»am_»ad
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
¡»am_id
,

7885 
ušt16_t
 
­p_”rÜ_code
) {

7886 
ngtı2_¡rm
 *
¡rm
;

7888 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
);

7889 ià(
¡rm
 =ğ
NULL
) {

7890  
NGTCP2_ERR_STREAM_NOT_FOUND
;

7893  
	`cÚn_shutdown_¡»am_»ad
(
cÚn
, 
¡rm
, 
­p_”rÜ_code
);

7894 
	}
}

7906 
	$cÚn_ex‹nd_max_¡»am_off£t
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
,

7907 
size_t
 
d©®’
) {

7908 
ngtı2_¡rm
 *
tİ
;

7910 ià(
¡rm
->
un£Á_max_rx_off£t
 <ğ
NGTCP2_MAX_VARINT
 - 
d©®’
) {

7911 
¡rm
->
un£Á_max_rx_off£t
 +ğ
d©®’
;

7914 ià(!(
¡rm
->
æags
 &

7915 (
NGTCP2_STRM_FLAG_SHUT_RD
 | 
NGTCP2_STRM_FLAG_STOP_SENDING
)) &&

7916 !
	`ngtı2_¡rm_is_tx_queued
(
¡rm
) &&

7917 
	`cÚn_should_£nd_max_¡»am_d©a
(
cÚn
, 
¡rm
)) {

7918 ià(!
	`ngtı2_pq_em±y
(&
cÚn
->
tx_¡rmq
)) {

7919 
tİ
 = 
	`ngtı2_cÚn_tx_¡rmq_tİ
(
cÚn
);

7920 
¡rm
->
cyşe
 = 
tİ
->cycle;

7922  
	`ngtı2_cÚn_tx_¡rmq_push
(
cÚn
, 
¡rm
);

7926 
	}
}

7928 
	$ngtı2_cÚn_ex‹nd_max_¡»am_off£t
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
¡»am_id
,

7929 
size_t
 
d©®’
) {

7930 
ngtı2_¡rm
 *
¡rm
;

7932 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
);

7933 ià(
¡rm
 =ğ
NULL
) {

7934  
NGTCP2_ERR_STREAM_NOT_FOUND
;

7937  
	`cÚn_ex‹nd_max_¡»am_off£t
(
cÚn
, 
¡rm
, 
d©®’
);

7938 
	}
}

7940 
	$ngtı2_cÚn_ex‹nd_max_off£t
(
ngtı2_cÚn
 *
cÚn
, 
size_t
 
d©®’
) {

7941 ià(
NGTCP2_MAX_VARINT
 < (
ušt64_t
)
d©®’
 ||

7942 
cÚn
->
un£Á_max_rx_off£t
 > 
NGTCP2_MAX_VARINT
 - 
d©®’
) {

7943 
cÚn
->
un£Á_max_rx_off£t
 = 
NGTCP2_MAX_VARINT
;

7947 
cÚn
->
un£Á_max_rx_off£t
 +ğ
d©®’
;

7948 
	}
}

7950 
size_t
 
	$ngtı2_cÚn_g‘_by‹s_š_æight
(
ngtı2_cÚn
 *
cÚn
) {

7951  
cÚn
->
ccs
.
by‹s_š_æight
;

7952 
	}
}

7954 cÚ¡ 
ngtı2_cid
 *
	$ngtı2_cÚn_g‘_dcid
(
ngtı2_cÚn
 *
cÚn
) {

7955  &
cÚn
->
dcid
.
cid
;

7956 
	}
}

7958 
ušt32_t
 
	$ngtı2_cÚn_g‘_ÃgÙŸ‹d_v”siÚ
(
ngtı2_cÚn
 *
cÚn
) {

7959  
cÚn
->
v”siÚ
;

7960 
	}
}

7962 
	$ngtı2_cÚn_—¾y_d©a_»jeùed
(
ngtı2_cÚn
 *
cÚn
) {

7963 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->pktns;

7964 
ngtı2_¹b
 *
¹b
 = &
cÚn
->
pkŠs
.rtb;

7965 
ngtı2_äame_chaš
 *
äc
 = 
NULL
;

7966 
rv
;

7968 
cÚn
->
æags
 |ğ
NGTCP2_CONN_FLAG_EARLY_DATA_REJECTED
;

7970 
rv
 = 
	`ngtı2_¹b_»move_®l
(
¹b
, &
äc
);

7971 ià(
rv
 != 0) {

7972 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

7973 
	`ngtı2_äame_chaš_li¡_d–
(
äc
, 
cÚn
->
mem
);

7974  
rv
;

7977 
rv
 = 
	`cÚn_»sched_äames
(
cÚn
, 
pkŠs
, &
äc
);

7978 ià(
rv
 != 0) {

7979 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

7980 
	`ngtı2_äame_chaš_li¡_d–
(
äc
, 
cÚn
->
mem
);

7981  
rv
;

7984  
rv
;

7985 
	}
}

7987 
	$ngtı2_cÚn_upd©e_¹t
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
¹t
,

7988 
ušt64_t
 
ack_d–ay
) {

7989 
ngtı2_rcvry_¡©
 *
rcs
 = &
cÚn
->rcs;

7991 
rcs
->
mš_¹t
 = 
	`ngtı2_mš
Ôcs->mš_¹t, 
¹t
);

7992 
ack_d–ay
 = 
	`ngtı2_mš
×ck_d–ay, 
cÚn
->
»mÙe_£‰šgs
.
max_ack_d–ay
);

7993 ià(
¹t
 - 
rcs
->
mš_¹t
 > 
ack_d–ay
) {

7994 
¹t
 -ğ
ack_d–ay
;

7997 
rcs
->
Ï‹¡_¹t
 = 
¹t
;

7999 ià(
rcs
->
smoÙhed_¹t
 < 1e-9) {

8000 
rcs
->
smoÙhed_¹t
 = ()
¹t
;

8001 
rcs
->
¹tv¬
 = ()
¹t
 / 2;

8003 
§m¶e
 = 
	`çbs
(
rcs
->
smoÙhed_¹t
 - ()
¹t
);

8004 
rcs
->
¹tv¬
 =„cs->¹tv¬ * 3 / 4 + 
§m¶e
 / 4;

8005 
rcs
->
smoÙhed_¹t
 =„cs->smoÙhed_¹ˆ* 7 / 8 + ()
¹t
 / 8;

8008 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_RCV
,

8009 "Ï‹¡_¹t=%" 
PRIu64
 " min_rtt=%" PRIu64

8010 " smoÙhed_¹t=%.3à¹tv¬=%.3àmax_ack_d–ay=%" 
PRIu64
,

8011 
rcs
->
Ï‹¡_¹t
 / 
NGTCP2_MILLISECONDS
,

8012 
rcs
->
mš_¹t
 / 
NGTCP2_MILLISECONDS
,

8013 
rcs
->
smoÙhed_¹t
 / 
NGTCP2_MILLISECONDS
,

8014 
rcs
->
¹tv¬
 / 
NGTCP2_MILLISECONDS
,

8015 
rcs
->
max_ack_d–ay
 / 
NGTCP2_MILLISECONDS
);

8016 
	}
}

8018 
	$ngtı2_cÚn_g‘_rcvry_¡©
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_rcvry_¡©
 *
rcs
) {

8019 *
rcs
 = 
cÚn
->rcs;

8020 
	}
}

8022 
	$ngtı2_cÚn_£t_loss_d‘eùiÚ_tim”
(
ngtı2_cÚn
 *
cÚn
) {

8023 
ngtı2_rcvry_¡©
 *
rcs
 = &
cÚn
->rcs;

8024 
ušt64_t
 
timeout
;

8025 
ngtı2_k¦_™
 
™
;

8026 
ngtı2_pkŠs
 *
š_pkŠs
 = &
cÚn
->in_pktns;

8027 
ngtı2_pkŠs
 *
hs_pkŠs
 = &
cÚn
->hs_pktns;

8028 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->pktns;

8030 ià(
	`ngtı2_¹b_num_ack_–ic™šg
(&
š_pkŠs
->
¹b
) ||

8031 
	`ngtı2_¹b_num_ack_–ic™šg
(&
hs_pkŠs
->
¹b
) ||

8032 (!
cÚn
->
£rv”
 && !cÚn->
hs_pkŠs
.
tx_ckm
)) {

8033 ià(
rcs
->
smoÙhed_¹t
 < 1e-09) {

8034 
timeout
 = 2 * 
NGTCP2_DEFAULT_INITIAL_RTT
;

8036 
timeout
 = (
ušt64_t
)(2 * 
rcs
->
smoÙhed_¹t
);

8039 
timeout
 = 
	`ngtı2_max
Ñimeout, 
NGTCP2_GRANULARITY
);

8040 
timeout
 *ğ1uÎ << 
rcs
->
üy±o_couÁ
;

8042 
rcs
->
loss_d‘eùiÚ_tim”
 =„cs->
Ï¡_hs_tx_pkt_ts
 + 
timeout
;

8044 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_RCV
,

8045 "loss_d‘eùiÚ_tim”=%" 
PRIu64


8046 "†a¡_hs_tx_pkt_ts=%" 
PRIu64
 "imeout=%" PRIu64,

8047 
rcs
->
loss_d‘eùiÚ_tim”
,„cs->
Ï¡_hs_tx_pkt_ts
,

8048 
timeout
 / 
NGTCP2_MILLISECONDS
);

8052 
™
 = 
	`ngtı2_¹b_h—d
(&
pkŠs
->
¹b
);

8053 ià(
	`ngtı2_k¦_™_’d
(&
™
) ||

8054 !(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_HANDSHAKE_COMPLETED
)) {

8055 ià(
rcs
->
loss_d‘eùiÚ_tim”
) {

8056 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_RCV
,

8058 
rcs
->
loss_d‘eùiÚ_tim”
 = 0;

8063 ià(
rcs
->
loss_time
) {

8064 
rcs
->
loss_d‘eùiÚ_tim”
 =„cs->
loss_time
;

8068 
rcs
->
loss_d‘eùiÚ_tim”
 =„cs->
Ï¡_tx_pkt_ts
 + 
	`rcvry_¡©_compu‹_±o
(rcs);

8069 
	}
}

8081 
	$cÚn_hªdshake_pkt_lo¡
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_pkŠs
 *
pkŠs
) {

8082 
ngtı2_äame_chaš
 *
äc
 = 
NULL
;

8083 
rv
;

8085 
rv
 = 
	`ngtı2_¹b_»move_®l
(&
pkŠs
->
¹b
, &
äc
);

8086 ià(
rv
 != 0) {

8087 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

8088 
	`ngtı2_äame_chaš_li¡_d–
(
äc
, 
cÚn
->
mem
);

8089  
rv
;

8092 
rv
 = 
	`cÚn_»sched_äames
(
cÚn
, 
pkŠs
, &
äc
);

8093 ià(
rv
 != 0) {

8094 
	`ngtı2_äame_chaš_li¡_d–
(
äc
, 
cÚn
->
mem
);

8095  
rv
;

8099 
	}
}

8101 
	$ngtı2_cÚn_Ú_loss_d‘eùiÚ_tim”
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_t¡amp
 
ts
) {

8102 
ngtı2_rcvry_¡©
 *
rcs
 = &
cÚn
->rcs;

8103 
rv
;

8104 
ngtı2_pkŠs
 *
š_pkŠs
 = &
cÚn
->in_pktns;

8105 
ngtı2_pkŠs
 *
hs_pkŠs
 = &
cÚn
->hs_pktns;

8106 
ngtı2_pkŠs
 *
pkŠs
 = &
cÚn
->pktns;

8108 
cÚn
->
log
.
Ï¡_ts
 = 
ts
;

8110 ià(!
rcs
->
loss_d‘eùiÚ_tim”
) {

8114 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_RCV
,

8117 ià(
	`ngtı2_¹b_num_ack_–ic™šg
(&
š_pkŠs
->
¹b
) ||

8118 
	`ngtı2_¹b_num_ack_–ic™šg
(&
hs_pkŠs
->
¹b
)) {

8119 
rv
 = 
	`cÚn_hªdshake_pkt_lo¡
(
cÚn
, 
š_pkŠs
);

8120 ià(
rv
 != 0) {

8121  
rv
;

8123 
rv
 = 
	`cÚn_hªdshake_pkt_lo¡
(
cÚn
, 
hs_pkŠs
);

8124 ià(
rv
 != 0) {

8125  
rv
;

8127 ià(!
cÚn
->
£rv”
 && !cÚn->
hs_pkŠs
.
tx_ckm
) {

8128 
cÚn
->
æags
 |ğ
NGTCP2_CONN_FLAG_FORCE_SEND_INITIAL
;

8130 ++
rcs
->
üy±o_couÁ
;

8131 } ià(!
cÚn
->
£rv”
 && !cÚn->
hs_pkŠs
.
tx_ckm
) {

8132 
cÚn
->
æags
 |ğ
NGTCP2_CONN_FLAG_FORCE_SEND_INITIAL
;

8133 ++
rcs
->
üy±o_couÁ
;

8134 } ià(
rcs
->
loss_time
) {

8135 
rv
 = 
	`ngtı2_cÚn_d‘eù_lo¡_pkt
(
cÚn
, 
pkŠs
, 
rcs
, 
ts
);

8136 ià(
rv
 != 0) {

8137  
rv
;

8140 
rcs
->
´obe_pkt_Ëá
 = 2;

8141 ++
rcs
->
±o_couÁ
;

8144 
	`ngtı2_log_šfo
(&
cÚn
->
log
, 
NGTCP2_LOG_EVENT_RCV
,

8145 "üy±o_couÁ=%zu…to_couÁ=%zu", 
rcs
->
üy±o_couÁ
,

8146 
rcs
->
±o_couÁ
);

8148 
	`ngtı2_cÚn_£t_loss_d‘eùiÚ_tim”
(
cÚn
);

8151 
	}
}

8153 
	$ngtı2_cÚn_subm™_üy±o_d©a
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ušt8_t
 *
d©a
,

8154 cÚ¡ 
size_t
 
d©®’
) {

8155 
ngtı2_pkŠs
 *
pkŠs
;

8156 
ngtı2_üy±o_äame_chaš
 *
äc
;

8157 
ngtı2_üy±o
 *
ä
;

8158 
rv
;

8160 ià(
d©®’
 == 0) {

8164 ià(
cÚn
->
pkŠs
.
tx_ckm
) {

8165 
pkŠs
 = &
cÚn
->pktns;

8166 } ià(
cÚn
->
hs_pkŠs
.
tx_ckm
) {

8167 
pkŠs
 = &
cÚn
->
hs_pkŠs
;

8169 
	`as£¹
(
cÚn
->
š_pkŠs
.
tx_ckm
);

8170 
pkŠs
 = &
cÚn
->
š_pkŠs
;

8173 
rv
 = 
	`ngtı2_üy±o_äame_chaš_Ãw
(&
äc
, 
cÚn
->
mem
);

8174 ià(
rv
 != 0) {

8175  
rv
;

8178 
ä
 = &
äc
->fr;

8180 
ä
->
ty³
 = 
NGTCP2_FRAME_CRYPTO
;

8181 
ä
->
Üd”ed_off£t
 = 
cÚn
->
üy±o
.
tx_off£t
;

8182 
ä
->
off£t
 = 
pkŠs
->
üy±o_tx_off£t
;

8183 
ä
->
d©aút
 = 1;

8184 
ä
->
d©a
[0].
Ën
 = 
d©®’
;

8185 
ä
->
d©a
[0].
ba£
 = (
ušt8_t
 *)data;

8187 
rv
 = 
	`ngtı2_pq_push
(&
pkŠs
->
üy±oäq
, &
äc
->
³
);

8188 ià(
rv
 != 0) {

8189 
	`ngtı2_üy±o_äame_chaš_d–
(
äc
, 
cÚn
->
mem
);

8190  
rv
;

8193 
cÚn
->
üy±o
.
tx_off£t
 +ğ
d©®’
;

8194 
pkŠs
->
üy±o_tx_off£t
 +ğ
d©®’
;

8197 
	}
}

8199 
	$ngtı2_cÚn_£t_»Œy_ocid
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_cid
 *
ocid
) {

8200 ià(!
cÚn
->
£rv”
) {

8201  
NGTCP2_ERR_INVALID_STATE
;

8204 
cÚn
->
æags
 |ğ
NGTCP2_CONN_FLAG_OCID_PRESENT
;

8205 
cÚn
->
ocid
 = *ocid;

8208 
	}
}

8210 
ngtı2_¡rm
 *
	$ngtı2_cÚn_tx_¡rmq_tİ
(
ngtı2_cÚn
 *
cÚn
) {

8211 
	`as£¹
(!
	`ngtı2_pq_em±y
(&
cÚn
->
tx_¡rmq
));

8212  
	`ngtı2_¡ruù_of
(
	`ngtı2_pq_tİ
(&
cÚn
->
tx_¡rmq
), 
ngtı2_¡rm
, 
³
);

8213 
	}
}

8215 
	$ngtı2_cÚn_tx_¡rmq_pİ
(
ngtı2_cÚn
 *
cÚn
) {

8216 
ngtı2_¡rm
 *
¡rm
 = 
	`ngtı2_cÚn_tx_¡rmq_tİ
(
cÚn
);

8217 
	`as£¹
(
¡rm
);

8218 
	`ngtı2_pq_pİ
(&
cÚn
->
tx_¡rmq
);

8219 
¡rm
->
³
.
šdex
 = 
NGTCP2_PQ_BAD_INDEX
;

8220 
	}
}

8222 
	$ngtı2_cÚn_tx_¡rmq_push
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
) {

8223  
	`ngtı2_pq_push
(&
cÚn
->
tx_¡rmq
, &
¡rm
->
³
);

8224 
	}
}

8226 
size_t
 
	$ngtı2_cÚn_g‘_num_scid
(
ngtı2_cÚn
 *
cÚn
) {

8227  
	`ngtı2_k¦_Ën
(&
cÚn
->
scids
);

8228 
	}
}

8230 
size_t
 
	$ngtı2_cÚn_g‘_scid
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_cid
 *
de¡
) {

8231 
ngtı2_k¦_™
 
™
;

8232 
ngtı2_scid
 *
scid
;

8234 
™
 = 
	`ngtı2_k¦_begš
(&
cÚn
->
scids
); !
	`ngtı2_k¦_™_’d
(&it);

8235 
	`ngtı2_k¦_™_Ãxt
(&
™
)) {

8236 
scid
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

8237 *
de¡
++ = 
scid
->
cid
;

8240  
	`ngtı2_k¦_Ën
(&
cÚn
->
scids
);

8241 
	}
}

8243 
	$ngtı2_cÚn_£t_loÿl_addr
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_addr
 *
addr
) {

8244 
ngtı2_addr
 *
de¡
 = &
cÚn
->
dcid
.
·th
.
loÿl
;

8246 
	`as£¹
(
addr
->
Ën
 <ğ(
cÚn
->
dcid
.
loÿl_addrbuf
));

8247 
	`ngtı2_addr_cİy
(
de¡
, 
addr
);

8248 
	}
}

8250 
	$ngtı2_cÚn_£t_»mÙe_addr
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_addr
 *
addr
) {

8251 
ngtı2_addr
 *
de¡
 = &
cÚn
->
dcid
.
·th
.
»mÙe
;

8253 
	`as£¹
(
addr
->
Ën
 <ğ(
cÚn
->
dcid
.
»mÙe_addrbuf
));

8254 
	`ngtı2_addr_cİy
(
de¡
, 
addr
);

8255 
	}
}

8257 cÚ¡ 
ngtı2_addr
 *
	$ngtı2_cÚn_g‘_»mÙe_addr
(
ngtı2_cÚn
 *
cÚn
) {

8258  &
cÚn
->
dcid
.
·th
.
»mÙe
;

8259 
	}
}

8261 
	$ngtı2_cÚn_š™Ÿ‹_mig¿tiÚ
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_·th
 *
·th
,

8262 
ngtı2_t¡amp
 
ts
) {

8263 
rv
;

8264 
ngtı2_dcid
 *
dcid
;

8265 
ngtı2_pv
 *
pv
;

8267 
cÚn
->
log
.
Ï¡_ts
 = 
ts
;

8269 ià(
cÚn
->
£rv”
 || 
	`ngtı2_ršgbuf_Ën
(&cÚn->
dcids
) == 0) {

8270  
NGTCP2_ERR_INVALID_STATE
;

8273 ià(
	`ngtı2_·th_eq
(&
cÚn
->
dcid
.
·th
,…ath)) {

8274  
NGTCP2_ERR_INVALID_ARGUMENT
;

8277 
dcid
 = 
	`ngtı2_ršgbuf_g‘
(&
cÚn
->
dcids
, 0);

8279 
rv
 = 
	`cÚn_¡İ_pv
(
cÚn
);

8280 ià(
rv
 != 0) {

8281  
rv
;

8284 
rv
 = 
	`ngtı2_pv_Ãw
(&
pv
, 
dcid
, 6 * 
NGTCP2_DEFAULT_INITIAL_RTT
,

8285 
NGTCP2_PV_FLAG_BLOCKING
, &
cÚn
->
log
, cÚn->
mem
);

8286 ià(
rv
 != 0) {

8287  
rv
;

8290 
cÚn
->
pv
 =…v;

8292 
	`ngtı2_·th_cİy
(&
pv
->
dcid
.
·th
,…ath);

8294 
	`cÚn_»£t_cÚge¡iÚ_¡©e
(
cÚn
);

8296 
	`ngtı2_ršgbuf_pİ_äÚt
(&
cÚn
->
dcids
);

8299 
	}
}

8301 
	$ngtı2_·th_ch®Ënge_’Œy_š™
(
ngtı2_·th_ch®Ënge_’Œy
 *
pûÁ
,

8302 cÚ¡ 
ngtı2_·th
 *
·th
,

8303 cÚ¡ 
ušt8_t
 *
d©a
) {

8304 
pûÁ
->
·th
.
loÿl
.
addr
 =…ûÁ->
loÿl_addrbuf
;

8305 
pûÁ
->
·th
.
»mÙe
.
addr
 =…ûÁ->
»mÙe_addrbuf
;

8307 
	`ngtı2_·th_cİy
(&
pûÁ
->
·th
,…ath);

8309 
	`memıy
(
pûÁ
->
d©a
, data, (pcent->data));

8310 
	}
}

	@lib/ngtcp2_conn.h

25 #iâdeà
NGTCP2_CONN_H


26 
	#NGTCP2_CONN_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

34 
	~"ngtı2_mem.h
"

35 
	~"ngtı2_üy±o.h
"

36 
	~"ngtı2_ackŒ.h
"

37 
	~"ngtı2_¹b.h
"

38 
	~"ngtı2_¡rm.h
"

39 
	~"ngtı2_mem.h
"

40 
	~"ngtı2_idŒ.h
"

41 
	~"ngtı2_¡r.h
"

42 
	~"ngtı2_pkt.h
"

43 
	~"ngtı2_log.h
"

44 
	~"ngtı2_pq.h
"

45 
	~"ngtı2_cc.h
"

46 
	~"ngtı2_pv.h
"

47 
	~"ngtı2_cid.h
"

51 
	mNGTCP2_CS_CLIENT_INITIAL
,

52 
	mNGTCP2_CS_CLIENT_WAIT_HANDSHAKE
,

53 
	mNGTCP2_CS_CLIENT_TLS_HANDSHAKE_FAILED
,

55 
	mNGTCP2_CS_SERVER_INITIAL
,

56 
	mNGTCP2_CS_SERVER_WAIT_HANDSHAKE
,

57 
	mNGTCP2_CS_SERVER_TLS_HANDSHAKE_FAILED
,

59 
	mNGTCP2_CS_POST_HANDSHAKE
,

60 
	mNGTCP2_CS_CLOSING
,

61 
	mNGTCP2_CS_DRAINING
,

62 } 
	tngtı2_cÚn_¡©e
;

66 
	#NGTCP2_MAX_NUM_BUFFED_RX_PKTS
 16

	)

70 
	#NGTCP2_STRM0_MAX_STREAM_DATA
 65535

	)

74 
	#NGTCP2_PACKET_THRESHOLD
 3

	)

78 
	#NGTCP2_GRANULARITY
 
NGTCP2_MILLISECONDS


	)

80 
	#NGTCP2_DEFAULT_INITIAL_RTT
 (100 * 
NGTCP2_MILLISECONDS
)

	)

85 
	#NGTCP2_MAX_RX_INITIAL_CRYPTO_DATA
 65536

	)

89 
	#NGTCP2_MAX_RX_HANDSHAKE_CRYPTO_DATA
 65536

	)

93 
	#NGTCP2_MAX_RETRIES
 3

	)

97 
	#NGTCP2_HS_ACK_DELAY
 
NGTCP2_MILLISECONDS


	)

99 
	#NGTCP2_MAX_SERVER_ID_BIDI
 0x3fffffffffffff00ULL

	)

100 
	#NGTCP2_MAX_SERVER_ID_UNI
 0x3fffffffffffff10ULL

	)

101 
	#NGTCP2_MAX_CLIENT_ID_BIDI
 0x3fffffffffffff01ULL

	)

102 
	#NGTCP2_MAX_CLIENT_ID_UNI
 0x3fffffffffffff11ULL

	)

108 
	#NGTCP2_MAX_BOUND_DCID_POOL_SIZE
 4

	)

112 
	#NGTCP2_MAX_DCID_POOL_SIZE
 16

	)

116 
	#NGTCP2_MIN_SCID_POOL_SIZE
 8

	)

120 
	#NGTCP2_MIN_DCID_CHANGE_DURATION
 (3ULL * 
NGTCP2_SECONDS
)

	)

127 
ngtı2_äame
 
	mä
;

129 
ngtı2_ack
 
	mack
;

131 
ngtı2_ack_blk
 
	mblks
[
NGTCP2_MAX_ACK_BLKS
 - 1];

132 } 
	mackä
;

133 } 
	tngtı2_max_äame
;

136 
ngtı2_·th
 
	m·th
;

137 
ušt8_t
 
	md©a
[8];

138 
ušt8_t
 
	mloÿl_addrbuf
[128];

139 
ušt8_t
 
	m»mÙe_addrbuf
[128];

140 } 
	tngtı2_·th_ch®Ënge_’Œy
;

142 
ngtı2_·th_ch®Ënge_’Œy_š™
(
ngtı2_·th_ch®Ënge_’Œy
 *
pûÁ
,

143 cÚ¡ 
ngtı2_·th
 *
·th
,

144 cÚ¡ 
ušt8_t
 *
d©a
);

147 
	mNGTCP2_CONN_FLAG_NONE
 = 0x00,

150 
	mNGTCP2_CONN_FLAG_HANDSHAKE_COMPLETED
 = 0x01,

153 
	mNGTCP2_CONN_FLAG_CONN_ID_NEGOTIATED
 = 0x02,

156 
	mNGTCP2_CONN_FLAG_TRANSPORT_PARAM_RECVED
 = 0x04,

162 
	mNGTCP2_CONN_FLAG_RECV_PROTECTED_PKT
 = 0x08,

165 
	mNGTCP2_CONN_FLAG_RECV_RETRY
 = 0x10,

168 
	mNGTCP2_CONN_FLAG_EARLY_DATA_REJECTED
 = 0x20,

171 
	mNGTCP2_CONN_FLAG_SADDR_VERIFIED
 = 0x40,

174 
	mNGTCP2_CONN_FLAG_OCID_PRESENT
 = 0x80,

177 
	mNGTCP2_CONN_FLAG_HANDSHAKE_COMPLETED_HANDLED
 = 0x0100,

180 
	mNGTCP2_CONN_FLAG_FORCE_SEND_INITIAL
 = 0x0200,

183 
	mNGTCP2_CONN_FLAG_INITIAL_KEY_DISCARDED
 = 0x0400,

187 
	mNGTCP2_CONN_FLAG_WAIT_FOR_REMOTE_KEY_UPDATE
 = 0x0800,

188 } 
	tngtı2_cÚn_æag
;

191 
ngtı2_buf
 
	mbuf
;

195 
ušt8_t
 
	mpkt_ty³
;

196 } 
	tngtı2_üy±o_d©a
;

201 
ngtı2_g­Œ
 
	m²g­
;

204 
ušt64_t
 
	mÏ¡_tx_pkt_num
;

205 
ušt64_t
 
	mmax_rx_pkt_num
;

208 
ušt64_t
 
	müy±o_tx_off£t
;

212 
ušt64_t
 
	müy±o_rx_off£t_ba£
;

213 
ngtı2_ackŒ
 
	mackŒ
;

214 
ngtı2_¹b
 
	m¹b
;

215 
ngtı2_pq
 
	müy±oäq
;

218 
ngtı2_üy±o_km
 *
	mtx_ckm
;

221 
ngtı2_üy±o_km
 *
	mrx_ckm
;

222 
ngtı2_vec
 *
	mtx_hp
;

223 
ngtı2_vec
 *
	mrx_hp
;

224 
ngtı2_äame_chaš
 *
	mäq
;

225 } 
	tngtı2_pkŠs
;

227 
	sngtı2_cÚn
 {

228 
	m¡©e
;

229 
ngtı2_cÚn_ÿÎbacks
 
	mÿÎbacks
;

235 
ngtı2_cid
 
	mrcid
;

239 
ngtı2_cid
 
	mocid
;

242 
ngtı2_cid
 
	moscid
;

244 
ngtı2_dcid
 
	mdcid
;

247 
ngtı2_ršgbuf
 
	mbound_dcids
;

250 
ngtı2_ršgbuf
 
	mdcids
;

253 
ngtı2_k¦
 
	mscids
;

254 
ngtı2_pq
 
	mu£d_scids
;

255 
ngtı2_pkŠs
 
	mš_pkŠs
;

256 
ngtı2_pkŠs
 
	mhs_pkŠs
;

257 
ngtı2_pkŠs
 
	mpkŠs
;

258 
ngtı2_¡rm
 
	müy±o
;

259 
ngtı2_m­
 
	m¡rms
;

261 
ngtı2_pq
 
	mtx_¡rmq
;

262 
ngtı2_idŒ
 
	m»mÙe_bidi_idŒ
;

263 
ngtı2_idŒ
 
	m»mÙe_uni_idŒ
;

264 
ngtı2_rcvry_¡©
 
	mrcs
;

265 
ngtı2_cc_¡©
 
	mccs
;

266 
ngtı2_pv
 *
	mpv
;

267 
ngtı2_ršgbuf
 
	mrx_·th_ch®Ënge
;

268 
ngtı2_log
 
	mlog
;

269 
ngtı2_deçuÉ_cc
 
	mcc
;

271 
ngtı2_buf
 
	mtok’
;

276 
ušt64_t
 
	mun£Á_max_»mÙe_¡»am_id_bidi
;

280 
ušt64_t
 
	mmax_»mÙe_¡»am_id_bidi
;

283 
ušt64_t
 
	mmax_loÿl_¡»am_id_bidi
;

286 
ušt64_t
 
	mÃxt_loÿl_¡»am_id_bidi
;

289 
ušt64_t
 
	mun£Á_max_»mÙe_¡»am_id_uni
;

292 
ušt64_t
 
	mmax_»mÙe_¡»am_id_uni
;

295 
ušt64_t
 
	mmax_loÿl_¡»am_id_uni
;

298 
ušt64_t
 
	mÃxt_loÿl_¡»am_id_uni
;

302 
ušt64_t
 
	mun£Á_max_rx_off£t
;

305 
ušt64_t
 
	mmax_rx_off£t
;

308 
ušt64_t
 
	mrx_off£t
;

311 
ušt64_t
 
	mtx_off£t
;

314 
ušt64_t
 
	mmax_tx_off£t
;

316 
ušt64_t
 
	mtx_Ï¡_cid_£q
;

319 
ngtı2_t¡amp
 
	mfœ¡_rx_bw_ts
;

322 
ušt64_t
 
	mrx_bw_d©®’
;

324 
	mrx_bw
;

325 
size_t
 
	m´obe_pkt_Ëá
;

329 
size_t
 
	mhs_»cved
;

333 
size_t
 
	mhs_£Á
;

335 
size_t
 
	mÄ‘ry
;

336 
ngtı2_mem
 *
	mmem
;

337 *
	mu£r_d©a
;

338 
ušt32_t
 
	mv”siÚ
;

340 
ušt16_t
 
	mæags
;

341 
	m£rv”
;

342 
ngtı2_üy±o_km
 *
	m—¾y_ckm
;

343 
ngtı2_vec
 *
	m—¾y_hp
;

345 
ngtı2_üy±o_km
 *
	mŞd_rx_ckm
;

347 
ngtı2_üy±o_km
 *
	mÃw_tx_ckm
;

350 
ngtı2_üy±o_km
 *
	mÃw_rx_ckm
;

351 
size_t
 
	m«ad_ov”h—d
;

354 
ngtı2_pkt_chaš
 *
	mbufãd_rx_hs_pkts
;

358 
ngtı2_pkt_chaš
 *
	mbufãd_rx_µkts
;

359 
ngtı2_£‰šgs
 
	mloÿl_£‰šgs
;

360 
ngtı2_£‰šgs
 
	m»mÙe_£‰šgs
;

362 
ngtı2_¬¿y
 
	mdeüy±_buf
;

377 
ngtı2_cÚn_sched_ack
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_ackŒ
 *
ackŒ
,

378 
ušt64_t
 
pkt_num
, 
aùive_ack
, 
ngtı2_t¡amp
 
ts
);

384 
ngtı2_¡rm
 *
ngtı2_cÚn_fšd_¡»am
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
¡»am_id
);

399 
ngtı2_cÚn_š™_¡»am
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
,

400 
ušt64_t
 
¡»am_id
, *
¡»am_u£r_d©a
);

413 
ngtı2_cÚn_şo£_¡»am
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
,

414 
ušt16_t
 
­p_”rÜ_code
);

430 
ngtı2_cÚn_şo£_¡»am_if_shut_rdwr
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
,

431 
ušt16_t
 
­p_”rÜ_code
);

440 
ngtı2_cÚn_upd©e_¹t
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
¹t
,

441 
ušt64_t
 
ack_d–ay
);

443 
ngtı2_cÚn_£t_loss_d‘eùiÚ_tim”
(
ngtı2_cÚn
 *
cÚn
);

454 
ngtı2_cÚn_d‘eù_lo¡_pkt
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_pkŠs
 *
pkŠs
,

455 
ngtı2_rcvry_¡©
 *
rcs
, 
ngtı2_t¡amp
 
ts
);

461 
ngtı2_¡rm
 *
ngtı2_cÚn_tx_¡rmq_tİ
(
ngtı2_cÚn
 *
cÚn
);

467 
ngtı2_cÚn_tx_¡rmq_pİ
(
ngtı2_cÚn
 *
cÚn
);

478 
ngtı2_cÚn_tx_¡rmq_push
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_¡rm
 *
¡rm
);

	@lib/ngtcp2_conv.c

25 
	~"ngtı2_cÚv.h
"

27 
	~<¡ršg.h
>

28 
	~<as£¹.h
>

30 
	~"ngtı2_¡r.h
"

32 
ušt64_t
 
	$ngtı2_g‘_ušt64
(cÚ¡ 
ušt8_t
 *
p
) {

33 
ušt64_t
 
n
;

34 
	`memıy
(&
n
, 
p
, 8);

35  
	`bsw­64
(
n
);

36 
	}
}

38 
ušt64_t
 
	$ngtı2_g‘_ušt48
(cÚ¡ 
ušt8_t
 *
p
) {

39 
ušt64_t
 
n
 = 0;

40 
	`memıy
(((
ušt8_t
 *)&
n
è+ 2, 
p
, 6);

41  
	`bsw­64
(
n
);

42 
	}
}

44 
ušt32_t
 
	$ngtı2_g‘_ušt32
(cÚ¡ 
ušt8_t
 *
p
) {

45 
ušt32_t
 
n
;

46 
	`memıy
(&
n
, 
p
, 4);

47  
	`Áohl
(
n
);

48 
	}
}

50 
ušt32_t
 
	$ngtı2_g‘_ušt24
(cÚ¡ 
ušt8_t
 *
p
) {

51 
ušt32_t
 
n
 = 0;

52 
	`memıy
(((
ušt8_t
 *)&
n
è+ 1, 
p
, 3);

53  
	`Áohl
(
n
);

54 
	}
}

56 
ušt16_t
 
	$ngtı2_g‘_ušt16
(cÚ¡ 
ušt8_t
 *
p
) {

57 
ušt16_t
 
n
;

58 
	`memıy
(&
n
, 
p
, 2);

59  
	`Áohs
(
n
);

60 
	}
}

62 
ušt64_t
 
	$ngtı2_g‘_v¬št
(
size_t
 *
¶’
, cÚ¡ 
ušt8_t
 *
p
) {

64 
b
[8];

65 
ušt16_t
 
n16
;

66 
ušt32_t
 
n32
;

67 
ušt64_t
 
n64
;

68 } 
n
;

70 *
¶’
 = 1u << (*
p
 >> 6);

72 *
¶’
) {

74  *
p
;

76 
	`memıy
(&
n
, 
p
, 2);

77 
n
.
b
[0] &= 0x3f;

78  
	`Áohs
(
n
.
n16
);

80 
	`memıy
(&
n
, 
p
, 4);

81 
n
.
b
[0] &= 0x3f;

82  
	`Áohl
(
n
.
n32
);

84 
	`memıy
(&
n
, 
p
, 8);

85 
n
.
b
[0] &= 0x3f;

86  
	`bsw­64
(
n
.
n64
);

89 
	`as£¹
(0);

90 
	}
}

92 
ušt64_t
 
	$ngtı2_g‘_pkt_num
(cÚ¡ 
ušt8_t
 *
p
, 
size_t
 
pkt_numËn
) {

93 
pkt_numËn
) {

95  *
p
;

97  
	`ngtı2_g‘_ušt16
(
p
);

99  
	`ngtı2_g‘_ušt24
(
p
);

101  
	`ngtı2_g‘_ušt32
(
p
);

103 
	`as£¹
(0);

105 
	}
}

107 
ušt8_t
 *
	$ngtı2_put_ušt64be
(
ušt8_t
 *
p
, 
ušt64_t
 
n
) {

108 
n
 = 
	`bsw­64
(n);

109  
	`ngtı2_ıymem
(
p
, (cÚ¡ 
ušt8_t
 *)&
n
, (n));

110 
	}
}

112 
ušt8_t
 *
	$ngtı2_put_ušt48be
(
ušt8_t
 *
p
, 
ušt64_t
 
n
) {

113 
n
 = 
	`bsw­64
(n);

114  
	`ngtı2_ıymem
(
p
, ((cÚ¡ 
ušt8_t
 *)&
n
) + 2, 6);

115 
	}
}

117 
ušt8_t
 *
	$ngtı2_put_ušt32be
(
ušt8_t
 *
p
, 
ušt32_t
 
n
) {

118 
n
 = 
	`htÚl
(n);

119  
	`ngtı2_ıymem
(
p
, (cÚ¡ 
ušt8_t
 *)&
n
, (n));

120 
	}
}

122 
ušt8_t
 *
	$ngtı2_put_ušt24be
(
ušt8_t
 *
p
, 
ušt32_t
 
n
) {

123 
n
 = 
	`htÚl
(n);

124  
	`ngtı2_ıymem
(
p
, ((cÚ¡ 
ušt8_t
 *)&
n
) + 1, 3);

125 
	}
}

127 
ušt8_t
 *
	$ngtı2_put_ušt16be
(
ušt8_t
 *
p
, 
ušt16_t
 
n
) {

128 
n
 = 
	`htÚs
(n);

129  
	`ngtı2_ıymem
(
p
, (cÚ¡ 
ušt8_t
 *)&
n
, (n));

130 
	}
}

132 
ušt8_t
 *
	$ngtı2_put_v¬št
(
ušt8_t
 *
p
, 
ušt64_t
 
n
) {

133 
ušt8_t
 *
rv
;

134 ià(
n
 < 64) {

135 *
p
++ = (
ušt8_t
)
n
;

136  
p
;

138 ià(
n
 < 16384) {

139 
rv
 = 
	`ngtı2_put_ušt16be
(
p
, (
ušt16_t
)
n
);

140 *
p
 |= 0x40;

141  
rv
;

143 ià(
n
 < 1073741824) {

144 
rv
 = 
	`ngtı2_put_ušt32be
(
p
, (
ušt32_t
)
n
);

145 *
p
 |= 0x80;

146  
rv
;

148 
	`as£¹
(
n
 < 4611686018427387904ULL);

149 
rv
 = 
	`ngtı2_put_ušt64be
(
p
, 
n
);

150 *
p
 |= 0xc0;

151  
rv
;

152 
	}
}

154 
ušt8_t
 *
	$ngtı2_put_v¬št14
(
ušt8_t
 *
p
, 
ušt16_t
 
n
) {

155 
ušt8_t
 *
rv
;

157 
	`as£¹
(
n
 < 16384);

159 
rv
 = 
	`ngtı2_put_ušt16be
(
p
, 
n
);

160 *
p
 |= 0x40;

162  
rv
;

163 
	}
}

165 
ušt8_t
 *
	$ngtı2_put_pkt_num
(
ušt8_t
 *
p
, 
ušt64_t
 
pkt_num
, 
size_t
 
Ën
) {

166 
Ën
) {

168 *
p
++ = (
ušt8_t
)
pkt_num
;

169  
p
;

171 
	`ngtı2_put_ušt16be
(
p
, (
ušt16_t
)
pkt_num
);

172  
p
 + 2;

174 
	`ngtı2_put_ušt24be
(
p
, (
ušt32_t
)
pkt_num
);

175  
p
 + 3;

177 
	`ngtı2_put_ušt32be
(
p
, (
ušt32_t
)
pkt_num
);

178  
p
 + 4;

180 
	`as£¹
(0);

182 
	}
}

184 
size_t
 
	$ngtı2_g‘_v¬št_Ën
(cÚ¡ 
ušt8_t
 *
p
è{  1u << (*°>> 6); 
	}
}

186 
size_t
 
	$ngtı2_put_v¬št_Ën
(
ušt64_t
 
n
) {

187 ià(
n
 < 64) {

190 ià(
n
 < 16384) {

193 ià(
n
 < 1073741824) {

196 
	`as£¹
(
n
 < 4611686018427387904ULL);

198 
	}
}

200 
ušt64_t
 
	$ngtı2_Áh_£rv”_bidi_id
(
ušt64_t
 
n
) {

201 ià(
n
 == 0) {

204  ((
n
 - 1) << 2) | 0x01;

205 
	}
}

207 
ušt64_t
 
	$ngtı2_Áh_ş›Á_bidi_id
(
ušt64_t
 
n
) {

208 ià(
n
 == 0) {

211  (
n
 - 1) << 2;

212 
	}
}

214 
ušt64_t
 
	$ngtı2_Áh_£rv”_uni_id
(
ušt64_t
 
n
) {

215 ià(
n
 == 0) {

219  ((
n
 - 1) << 2) | 0x03;

220 
	}
}

222 
ušt64_t
 
	$ngtı2_Áh_ş›Á_uni_id
(
ušt64_t
 
n
) {

223 ià(
n
 == 0) {

227  ((
n
 - 1) << 2) | 0x02;

228 
	}
}

	@lib/ngtcp2_conv.h

25 #iâdeà
NGTCP2_CONV_H


26 
	#NGTCP2_CONV_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 #ifdeà
HAVE_ARPA_INET_H


33 
	~<¬·/š‘.h
>

36 
	~<ngtı2/ngtı2.h
>

38 #ifdeà
WORDS_BIGENDIAN


39 
	#bsw­64
(
N
è(N)

	)

41 
	#bsw­64
(
N
) \

42 ((
ušt64_t
)(
	`Áohl
((
ušt32_t
)(
N
))è<< 32 |‚tohl((ušt32_t)((Nè>> 32)))

	)

50 
ušt64_t
 
ngtı2_g‘_ušt64
(cÚ¡ 
ušt8_t
 *
p
);

57 
ušt64_t
 
ngtı2_g‘_ušt48
(cÚ¡ 
ušt8_t
 *
p
);

64 
ušt32_t
 
ngtı2_g‘_ušt32
(cÚ¡ 
ušt8_t
 *
p
);

71 
ušt32_t
 
ngtı2_g‘_ušt24
(cÚ¡ 
ušt8_t
 *
p
);

78 
ušt16_t
 
ngtı2_g‘_ušt16
(cÚ¡ 
ušt8_t
 *
p
);

85 
ušt64_t
 
ngtı2_g‘_v¬št
(
size_t
 *
¶’
, cÚ¡ 
ušt8_t
 *
p
);

91 
ušt64_t
 
ngtı2_g‘_pkt_num
(cÚ¡ 
ušt8_t
 *
p
, 
size_t
 
pkt_numËn
);

98 
ušt8_t
 *
ngtı2_put_ušt64be
(ušt8_ˆ*
p
, 
ušt64_t
 
n
);

105 
ušt8_t
 *
ngtı2_put_ušt48be
(ušt8_ˆ*
p
, 
ušt64_t
 
n
);

112 
ušt8_t
 *
ngtı2_put_ušt32be
(ušt8_ˆ*
p
, 
ušt32_t
 
n
);

119 
ušt8_t
 *
ngtı2_put_ušt24be
(ušt8_ˆ*
p
, 
ušt32_t
 
n
);

126 
ušt8_t
 *
ngtı2_put_ušt16be
(ušt8_ˆ*
p
, 
ušt16_t
 
n
);

132 
ušt8_t
 *
ngtı2_put_v¬št
(ušt8_ˆ*
p
, 
ušt64_t
 
n
);

140 
ušt8_t
 *
ngtı2_put_v¬št14
(ušt8_ˆ*
p
, 
ušt16_t
 
n
);

146 
ušt8_t
 *
ngtı2_put_pkt_num
(ušt8_ˆ*
p
, 
ušt64_t
 
pkt_num
, 
size_t
 
Ën
);

152 
size_t
 
ngtı2_g‘_v¬št_Ën
(cÚ¡ 
ušt8_t
 *
p
);

158 
size_t
 
ngtı2_put_v¬št_Ën
(
ušt64_t
 
n
);

164 
ušt64_t
 
ngtı2_Áh_£rv”_bidi_id
(ušt64_ˆ
n
);

170 
ušt64_t
 
ngtı2_Áh_ş›Á_bidi_id
(ušt64_ˆ
n
);

176 
ušt64_t
 
ngtı2_Áh_£rv”_uni_id
(ušt64_ˆ
n
);

182 
ušt64_t
 
ngtı2_Áh_ş›Á_uni_id
(ušt64_ˆ
n
);

	@lib/ngtcp2_crypto.c

25 
	~"ngtı2_üy±o.h
"

27 
	~<¡ršg.h
>

28 
	~<as£¹.h
>

30 
	~"ngtı2_¡r.h
"

31 
	~"ngtı2_cÚv.h
"

33 
	$ngtı2_üy±o_km_Ãw
(
ngtı2_üy±o_km
 **
pckm
, cÚ¡ 
ušt8_t
 *
key
,

34 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
iv
, size_ˆ
ivËn
,

35 
ngtı2_mem
 *
mem
) {

36 
size_t
 
Ën
;

37 
ušt8_t
 *
p
;

39 
Ën
 = (
ngtı2_üy±o_km
è+ 
keyËn
 + 
ivËn
;

41 *
pckm
 = 
	`ngtı2_mem_m®loc
(
mem
, 
Ën
);

42 ià(*
pckm
 =ğ
NULL
) {

43  
NGTCP2_ERR_NOMEM
;

46 
p
 = (
ušt8_t
 *)(*
pckm
è+ (
ngtı2_üy±o_km
);

47 (*
pckm
)->
key
.
ba£
 = 
p
;

48 (*
pckm
)->
key
.
Ën
 = 
keyËn
;

49 
p
 = 
	`ngtı2_ıymem
Õ, 
key
, 
keyËn
);

50 (*
pckm
)->
iv
.
ba£
 = 
p
;

51 (*
pckm
)->
iv
.
Ën
 = 
ivËn
;

52  
	`ngtı2_ıymem
(
p
, 
iv
, 
ivËn
);

53 (*
pckm
)->
pkt_num
 = 0;

54 (*
pckm
)->
æags
 = 
NGTCP2_CRYPTO_KM_FLAG_NONE
;

57 
	}
}

59 
	$ngtı2_üy±o_km_d–
(
ngtı2_üy±o_km
 *
ckm
, 
ngtı2_mem
 *
mem
) {

60 ià(
ckm
 =ğ
NULL
) {

64 
	`ngtı2_mem_ä“
(
mem
, 
ckm
);

65 
	}
}

67 
	$ngtı2_üy±o_ü—‹_nÚû
(
ušt8_t
 *
de¡
, cÚ¡ ušt8_ˆ*
iv
, 
size_t
 
ivËn
,

68 
ušt64_t
 
pkt_num
) {

69 
size_t
 
i
;

71 
	`memıy
(
de¡
, 
iv
, 
ivËn
);

72 
pkt_num
 = 
	`bsw­64
(pkt_num);

74 
i
 = 0; i < 8; ++i) {

75 
de¡
[
ivËn
 - 8 + 
i
] ^ğ((
ušt8_t
 *)&
pkt_num
)[i];

77 
	}
}

79 
ssize_t
 
	$ngtı2_’code_Œª¥Üt_·¿ms
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

80 
ušt8_t
 
ex‰y³
,

81 cÚ¡ 
ngtı2_Œª¥Üt_·¿ms
 *
·¿ms
) {

82 
ušt8_t
 *
p
;

83 
size_t
 
Ën
 = 2 ;

84 
size_t
 
i
;

85 
size_t
 
vËn
;

87 
size_t
 
´eã¼ed_add¾’
 = 0;

89 
ex‰y³
) {

90 
NGTCP2_TRANSPORT_PARAMS_TYPE_CLIENT_HELLO
:

91 
vËn
 = (
ušt32_t
);

93 
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
:

94 
vËn
 = (
ušt32_t
è+ 1 + 
·¿ms
->
v
.
“
.
Ën
 * (uint32_t);

95 ià(
·¿ms
->
¡©–ess_»£t_tok’_´e£Á
) {

96 
Ën
 += 20;

98 ià(
·¿ms
->
´eã¼ed_add»ss
.
_v”siÚ
 !ğ
NGTCP2_IP_VERSION_NONE
) {

99 
	`as£¹
(
·¿ms
->
´eã¼ed_add»ss
.
_add»s¦’
 >= 4);

100 
	`as£¹
(
·¿ms
->
´eã¼ed_add»ss
.
_add»s¦’
 < 256);

101 
	`as£¹
(
·¿ms
->
´eã¼ed_add»ss
.
cid
.
d©®’
 == 0 ||

102 
·¿ms
->
´eã¼ed_add»ss
.
cid
.
d©®’
 >ğ
NGTCP2_MIN_CIDLEN
);

103 
	`as£¹
(
·¿ms
->
´eã¼ed_add»ss
.
cid
.
d©®’
 <ğ
NGTCP2_MAX_CIDLEN
);

104 
´eã¼ed_add¾’
 =

106 
·¿ms
->
´eã¼ed_add»ss
.
_add»s¦’
 +

108 
·¿ms
->
´eã¼ed_add»ss
.
cid
.
d©®’
 +

109 
NGTCP2_STATELESS_RESET_TOKENLEN
;

110 
Ën
 +ğ4 + 
´eã¼ed_add¾’
;

112 ià(
·¿ms
->
Üigš®_cÚÃùiÚ_id_´e£Á
) {

113 
Ën
 +ğ4 + 
·¿ms
->
Üigš®_cÚÃùiÚ_id
.
d©®’
;

117  
NGTCP2_ERR_INVALID_ARGUMENT
;

120 
Ën
 +ğ
vËn
;

122 ià(
·¿ms
->
š™Ÿl_max_¡»am_d©a_bidi_loÿl
) {

123 
Ën
 +=

124 4 + 
	`ngtı2_put_v¬št_Ën
(
·¿ms
->
š™Ÿl_max_¡»am_d©a_bidi_loÿl
);

126 ià(
·¿ms
->
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
) {

127 
Ën
 +=

128 4 + 
	`ngtı2_put_v¬št_Ën
(
·¿ms
->
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
);

130 ià(
·¿ms
->
š™Ÿl_max_¡»am_d©a_uni
) {

131 
Ën
 +ğ4 + 
	`ngtı2_put_v¬št_Ën
(
·¿ms
->
š™Ÿl_max_¡»am_d©a_uni
);

133 ià(
·¿ms
->
š™Ÿl_max_d©a
) {

134 
Ën
 +ğ4 + 
	`ngtı2_put_v¬št_Ën
(
·¿ms
->
š™Ÿl_max_d©a
);

136 ià(
·¿ms
->
š™Ÿl_max_¡»ams_bidi
) {

137 
Ën
 +ğ4 + 
	`ngtı2_put_v¬št_Ën
(
·¿ms
->
š™Ÿl_max_¡»ams_bidi
);

139 ià(
·¿ms
->
š™Ÿl_max_¡»ams_uni
) {

140 
Ën
 +ğ4 + 
	`ngtı2_put_v¬št_Ën
(
·¿ms
->
š™Ÿl_max_¡»ams_uni
);

142 ià(
·¿ms
->
max_·ck‘_size
 !ğ
NGTCP2_MAX_PKT_SIZE
) {

143 
Ën
 +ğ4 + 
	`ngtı2_put_v¬št_Ën
(
·¿ms
->
max_·ck‘_size
);

145 ià(
·¿ms
->
ack_d–ay_expÚ’t
 !ğ
NGTCP2_DEFAULT_ACK_DELAY_EXPONENT
) {

146 
Ën
 +ğ4 + 
	`ngtı2_put_v¬št_Ën
(
·¿ms
->
ack_d–ay_expÚ’t
);

148 ià(
·¿ms
->
di§bË_mig¿tiÚ
) {

149 
Ën
 += 4;

151 ià(
·¿ms
->
max_ack_d–ay
 !ğ
NGTCP2_DEFAULT_MAX_ACK_DELAY
) {

152 
Ën
 +ğ4 + 
	`ngtı2_put_v¬št_Ën
(
·¿ms
->
max_ack_d–ay
);

154 ià(
·¿ms
->
idË_timeout
) {

155 
Ën
 +ğ4 + 
	`ngtı2_put_v¬št_Ën
(
·¿ms
->
idË_timeout
);

158 ià(
de¡Ën
 < 
Ën
) {

159  
NGTCP2_ERR_NOBUF
;

162 
p
 = 
de¡
;

164 
ex‰y³
) {

165 
NGTCP2_TRANSPORT_PARAMS_TYPE_CLIENT_HELLO
:

166 
p
 = 
	`ngtı2_put_ušt32be
Õ, 
·¿ms
->
v
.
ch
.
š™Ÿl_v”siÚ
);

168 
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
:

169 
p
 = 
	`ngtı2_put_ušt32be
Õ, 
·¿ms
->
v
.
“
.
ÃgÙŸ‹d_v”siÚ
);

170 *
p
++ = (
ušt8_t
)(
·¿ms
->
v
.
“
.
Ën
 * (
ušt32_t
));

171 
i
 = 0; i < 
·¿ms
->
v
.
“
.
Ën
; ++i) {

172 
p
 = 
	`ngtı2_put_ušt32be
Õ, 
·¿ms
->
v
.
“
.
suµÜ‹d_v”siÚs
[
i
]);

177 
p
 = 
	`ngtı2_put_ušt16be
Õ, (
ušt16_t
)(
Ën
 - 
vËn
 - (uint16_t)));

179 ià(
ex‰y³
 =ğ
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
) {

180 ià(
·¿ms
->
¡©–ess_»£t_tok’_´e£Á
) {

181 
p
 = 
	`ngtı2_put_ušt16be
Õ, 
NGTCP2_TRANSPORT_PARAM_STATELESS_RESET_TOKEN
);

182 
p
 = 
	`ngtı2_put_ušt16be
Õ, (
·¿ms
->
¡©–ess_»£t_tok’
));

183 
p
 = 
	`ngtı2_ıymem
Õ, 
·¿ms
->
¡©–ess_»£t_tok’
,

184 (
·¿ms
->
¡©–ess_»£t_tok’
));

186 ià(
·¿ms
->
´eã¼ed_add»ss
.
_v”siÚ
 !ğ
NGTCP2_IP_VERSION_NONE
) {

187 
p
 = 
	`ngtı2_put_ušt16be
Õ, 
NGTCP2_TRANSPORT_PARAM_PREFERRED_ADDRESS
);

188 
p
 = 
	`ngtı2_put_ušt16be
Õ, (
ušt16_t
)
´eã¼ed_add¾’
);

189 *
p
++ = 
·¿ms
->
´eã¼ed_add»ss
.
_v”siÚ
;

190 *
p
++ = (
ušt8_t
)
·¿ms
->
´eã¼ed_add»ss
.
_add»s¦’
;

191 
p
 = 
	`ngtı2_ıymem
Õ, 
·¿ms
->
´eã¼ed_add»ss
.
_add»ss
,

192 
·¿ms
->
´eã¼ed_add»ss
.
_add»s¦’
);

193 
p
 = 
	`ngtı2_put_ušt16be
Õ, 
·¿ms
->
´eã¼ed_add»ss
.
pÜt
);

194 *
p
++ = (
ušt8_t
)
·¿ms
->
´eã¼ed_add»ss
.
cid
.
d©®’
;

195 ià(
·¿ms
->
´eã¼ed_add»ss
.
cid
.
d©®’
) {

196 
p
 = 
	`ngtı2_ıymem
Õ, 
·¿ms
->
´eã¼ed_add»ss
.
cid
.
d©a
,

197 
·¿ms
->
´eã¼ed_add»ss
.
cid
.
d©®’
);

199 
p
 = 
	`ngtı2_ıymem
(

200 
p
, 
·¿ms
->
´eã¼ed_add»ss
.
¡©–ess_»£t_tok’
,

201 (
·¿ms
->
´eã¼ed_add»ss
.
¡©–ess_»£t_tok’
));

203 ià(
·¿ms
->
Üigš®_cÚÃùiÚ_id_´e£Á
) {

204 
p
 = 
	`ngtı2_put_ušt16be
Õ, 
NGTCP2_TRANSPORT_PARAM_ORIGINAL_CONNECTION_ID
);

205 
p
 = 
	`ngtı2_put_ušt16be
(p,

206 (
ušt16_t
)
·¿ms
->
Üigš®_cÚÃùiÚ_id
.
d©®’
);

207 
p
 = 
	`ngtı2_ıymem
Õ, 
·¿ms
->
Üigš®_cÚÃùiÚ_id
.
d©a
,

208 
·¿ms
->
Üigš®_cÚÃùiÚ_id
.
d©®’
);

212 ià(
·¿ms
->
š™Ÿl_max_¡»am_d©a_bidi_loÿl
) {

213 
p
 = 
	`ngtı2_put_ušt16be
(

214 
p
, 
NGTCP2_TRANSPORT_PARAM_INITIAL_MAX_STREAM_DATA_BIDI_LOCAL
);

215 
p
 = 
	`ngtı2_put_ušt16be
Õ, (
ušt16_t
)
	`ngtı2_put_v¬št_Ën
(

216 
·¿ms
->
š™Ÿl_max_¡»am_d©a_bidi_loÿl
));

217 
p
 = 
	`ngtı2_put_v¬št
Õ, 
·¿ms
->
š™Ÿl_max_¡»am_d©a_bidi_loÿl
);

220 ià(
·¿ms
->
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
) {

221 
p
 = 
	`ngtı2_put_ušt16be
(

222 
p
, 
NGTCP2_TRANSPORT_PARAM_INITIAL_MAX_STREAM_DATA_BIDI_REMOTE
);

223 
p
 = 
	`ngtı2_put_ušt16be
(p,

224 (
ušt16_t
)
	`ngtı2_put_v¬št_Ën
(

225 
·¿ms
->
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
));

226 
p
 = 
	`ngtı2_put_v¬št
Õ, 
·¿ms
->
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
);

229 ià(
·¿ms
->
š™Ÿl_max_¡»am_d©a_uni
) {

230 
p
 = 
	`ngtı2_put_ušt16be
(p,

231 
NGTCP2_TRANSPORT_PARAM_INITIAL_MAX_STREAM_DATA_UNI
);

232 
p
 = 
	`ngtı2_put_ušt16be
Õ, (
ušt16_t
)
	`ngtı2_put_v¬št_Ën
(

233 
·¿ms
->
š™Ÿl_max_¡»am_d©a_uni
));

234 
p
 = 
	`ngtı2_put_v¬št
Õ, 
·¿ms
->
š™Ÿl_max_¡»am_d©a_uni
);

237 ià(
·¿ms
->
š™Ÿl_max_d©a
) {

238 
p
 = 
	`ngtı2_put_ušt16be
Õ, 
NGTCP2_TRANSPORT_PARAM_INITIAL_MAX_DATA
);

239 
p
 = 
	`ngtı2_put_ušt16be
(

240 
p
, (
ušt16_t
)
	`ngtı2_put_v¬št_Ën
(
·¿ms
->
š™Ÿl_max_d©a
));

241 
p
 = 
	`ngtı2_put_v¬št
Õ, 
·¿ms
->
š™Ÿl_max_d©a
);

244 ià(
·¿ms
->
š™Ÿl_max_¡»ams_bidi
) {

245 
p
 = 
	`ngtı2_put_ušt16be
Õ, 
NGTCP2_TRANSPORT_PARAM_INITIAL_MAX_STREAMS_BIDI
);

246 
p
 = 
	`ngtı2_put_ušt16be
(

247 
p
, (
ušt16_t
)
	`ngtı2_put_v¬št_Ën
(
·¿ms
->
š™Ÿl_max_¡»ams_bidi
));

248 
p
 = 
	`ngtı2_put_v¬št
Õ, 
·¿ms
->
š™Ÿl_max_¡»ams_bidi
);

251 ià(
·¿ms
->
š™Ÿl_max_¡»ams_uni
) {

252 
p
 = 
	`ngtı2_put_ušt16be
Õ, 
NGTCP2_TRANSPORT_PARAM_INITIAL_MAX_STREAMS_UNI
);

253 
p
 = 
	`ngtı2_put_ušt16be
(

254 
p
, (
ušt16_t
)
	`ngtı2_put_v¬št_Ën
(
·¿ms
->
š™Ÿl_max_¡»ams_uni
));

255 
p
 = 
	`ngtı2_put_v¬št
Õ, 
·¿ms
->
š™Ÿl_max_¡»ams_uni
);

258 ià(
·¿ms
->
max_·ck‘_size
 !ğ
NGTCP2_MAX_PKT_SIZE
) {

259 
p
 = 
	`ngtı2_put_ušt16be
Õ, 
NGTCP2_TRANSPORT_PARAM_MAX_PACKET_SIZE
);

260 
p
 = 
	`ngtı2_put_ušt16be
(

261 
p
, (
ušt16_t
)
	`ngtı2_put_v¬št_Ën
(
·¿ms
->
max_·ck‘_size
));

262 
p
 = 
	`ngtı2_put_v¬št
Õ, 
·¿ms
->
max_·ck‘_size
);

265 ià(
·¿ms
->
ack_d–ay_expÚ’t
 !ğ
NGTCP2_DEFAULT_ACK_DELAY_EXPONENT
) {

266 
p
 = 
	`ngtı2_put_ušt16be
Õ, 
NGTCP2_TRANSPORT_PARAM_ACK_DELAY_EXPONENT
);

267 
p
 = 
	`ngtı2_put_ušt16be
(

268 
p
, (
ušt16_t
)
	`ngtı2_put_v¬št_Ën
(
·¿ms
->
ack_d–ay_expÚ’t
));

269 
p
 = 
	`ngtı2_put_v¬št
Õ, 
·¿ms
->
ack_d–ay_expÚ’t
);

272 ià(
·¿ms
->
di§bË_mig¿tiÚ
) {

273 
p
 = 
	`ngtı2_put_ušt16be
Õ, 
NGTCP2_TRANSPORT_PARAM_DISABLE_MIGRATION
);

274 
p
 = 
	`ngtı2_put_ušt16be
(p, 0);

277 ià(
·¿ms
->
max_ack_d–ay
 !ğ
NGTCP2_DEFAULT_MAX_ACK_DELAY
) {

278 
p
 = 
	`ngtı2_put_ušt16be
Õ, 
NGTCP2_TRANSPORT_PARAM_MAX_ACK_DELAY
);

279 
p
 = 
	`ngtı2_put_ušt16be
(

280 
p
, (
ušt16_t
)
	`ngtı2_put_v¬št_Ën
(
·¿ms
->
max_ack_d–ay
));

281 
p
 = 
	`ngtı2_put_v¬št
Õ, 
·¿ms
->
max_ack_d–ay
);

284 ià(
·¿ms
->
idË_timeout
) {

285 
p
 = 
	`ngtı2_put_ušt16be
Õ, 
NGTCP2_TRANSPORT_PARAM_IDLE_TIMEOUT
);

286 
p
 = 
	`ngtı2_put_ušt16be
(

287 
p
, (
ušt16_t
)
	`ngtı2_put_v¬št_Ën
(
·¿ms
->
idË_timeout
));

288 
p
 = 
	`ngtı2_put_v¬št
Õ, 
·¿ms
->
idË_timeout
);

291 
	`as£¹
((
size_t
)(
p
 - 
de¡
è=ğ
Ën
);

293  (
ssize_t
)
Ën
;

294 
	}
}

296 
ssize_t
 
	$decode_v¬št
(
ušt64_t
 *
pde¡
, cÚ¡ 
ušt8_t
 *
p
,

297 cÚ¡ 
ušt8_t
 *
’d
) {

298 
ušt16_t
 
Ën
 = 
	`ngtı2_g‘_ušt16
(
p
);

299 
size_t
 
n
;

301 
p
 +ğ(
ušt16_t
);

303 
Ën
) {

313 ià((
size_t
)(
’d
 - 
p
è< 
Ën
) {

317 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

318 ià(
n
 !ğ
Ën
) {

322 *
pde¡
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

324  (
ssize_t
)((
ušt16_t
è+ 
Ën
);

325 
	}
}

327 
	$ngtı2_decode_Œª¥Üt_·¿ms
(
ngtı2_Œª¥Üt_·¿ms
 *
·¿ms
,

328 
ušt8_t
 
ex‰y³
, cÚ¡ ušt8_ˆ*
d©a
,

329 
size_t
 
d©®’
) {

330 
ušt32_t
 
æags
 = 0;

331 cÚ¡ 
ušt8_t
 *
p
, *
’d
;

332 
size_t
 
suµÜ‹d_v”siÚ¦’
;

333 
size_t
 
i
;

334 
ušt16_t
 
·¿m_ty³
;

335 
size_t
 
v®u–’
;

336 
size_t
 
vËn
;

337 
size_t
 
Ën
;

338 
ssize_t
 
Ä—d
;

340 
p
 = 
d©a
;

341 
’d
 = 
d©a
 + 
d©®’
;

343 
ex‰y³
) {

344 
NGTCP2_TRANSPORT_PARAMS_TYPE_CLIENT_HELLO
:

345 ià((
size_t
)(
’d
 - 
p
è< (
ušt32_t
)) {

346  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

348 
·¿ms
->
v
.
ch
.
š™Ÿl_v”siÚ
 = 
	`ngtı2_g‘_ušt32
(
p
);

349 
p
 +ğ(
ušt32_t
);

350 
vËn
 = (
ušt32_t
);

352 
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
:

353 ià((
size_t
)(
’d
 - 
p
è< (
ušt32_t
) + 1) {

354  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

356 
·¿ms
->
v
.
“
.
ÃgÙŸ‹d_v”siÚ
 = 
	`ngtı2_g‘_ušt32
(
p
);

357 
p
 +ğ(
ušt32_t
);

358 
suµÜ‹d_v”siÚ¦’
 = *
p
++;

359 ià((
size_t
)(
’d
 - 
p
è< 
suµÜ‹d_v”siÚ¦’
 ||

360 
suµÜ‹d_v”siÚ¦’
 % (
ušt32_t
)) {

361  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

363 
·¿ms
->
v
.
“
.
Ën
 = 
suµÜ‹d_v”siÚ¦’
 / (
ušt32_t
);

364 
i
 = 0; i < 
suµÜ‹d_v”siÚ¦’
;

365 
i
 +ğ(
ušt32_t
), 
p
 += (uint32_t)) {

366 
·¿ms
->
v
.
“
.
suµÜ‹d_v”siÚs
[
i
 / (
ušt32_t
)] =

367 
	`ngtı2_g‘_ušt32
(
p
);

369 
vËn
 = (
ušt32_t
è+ 1 + 
suµÜ‹d_v”siÚ¦’
;

372  
NGTCP2_ERR_INVALID_ARGUMENT
;

375 ià((
size_t
)(
’d
 - 
p
è< (
ušt16_t
)) {

376  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

379 ià(
vËn
 + (
ušt16_t
è+ 
	`ngtı2_g‘_ušt16
(
p
è!ğ
d©®’
) {

380  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

382 
p
 +ğ(
ušt16_t
);

385 
·¿ms
->
š™Ÿl_max_¡»ams_bidi
 = 0;

386 
·¿ms
->
š™Ÿl_max_¡»ams_uni
 = 0;

387 
·¿ms
->
š™Ÿl_max_¡»am_d©a_bidi_loÿl
 = 0;

388 
·¿ms
->
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
 = 0;

389 
·¿ms
->
š™Ÿl_max_¡»am_d©a_uni
 = 0;

390 
·¿ms
->
max_·ck‘_size
 = 
NGTCP2_MAX_PKT_SIZE
;

391 
·¿ms
->
ack_d–ay_expÚ’t
 = 
NGTCP2_DEFAULT_ACK_DELAY_EXPONENT
;

392 
·¿ms
->
¡©–ess_»£t_tok’_´e£Á
 = 0;

393 
·¿ms
->
´eã¼ed_add»ss
.
_v”siÚ
 = 
NGTCP2_IP_VERSION_NONE
;

394 
·¿ms
->
di§bË_mig¿tiÚ
 = 0;

395 
·¿ms
->
max_ack_d–ay
 = 
NGTCP2_DEFAULT_MAX_ACK_DELAY
;

396 
·¿ms
->
idË_timeout
 = 0;

397 
·¿ms
->
Üigš®_cÚÃùiÚ_id_´e£Á
 = 0;

399 ; (
size_t
)(
’d
 - 
p
è>ğ(
ušt16_t
) * 2;) {

400 
·¿m_ty³
 = 
	`ngtı2_g‘_ušt16
(
p
);

401 
p
 +ğ(
ušt16_t
);

402 
·¿m_ty³
) {

403 
NGTCP2_TRANSPORT_PARAM_INITIAL_MAX_STREAM_DATA_BIDI_LOCAL
:

404 
æags
 |ğ1u << 
·¿m_ty³
;

405 
Ä—d
 =

406 
	`decode_v¬št
(&
·¿ms
->
š™Ÿl_max_¡»am_d©a_bidi_loÿl
, 
p
, 
’d
);

407 ià(
Ä—d
 < 0) {

408  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

410 
p
 +ğ
Ä—d
;

412 
NGTCP2_TRANSPORT_PARAM_INITIAL_MAX_STREAM_DATA_BIDI_REMOTE
:

413 
æags
 |ğ1u << 
·¿m_ty³
;

414 
Ä—d
 =

415 
	`decode_v¬št
(&
·¿ms
->
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
, 
p
, 
’d
);

416 ià(
Ä—d
 < 0) {

417  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

419 
p
 +ğ
Ä—d
;

421 
NGTCP2_TRANSPORT_PARAM_INITIAL_MAX_STREAM_DATA_UNI
:

422 
æags
 |ğ1u << 
·¿m_ty³
;

423 
Ä—d
 = 
	`decode_v¬št
(&
·¿ms
->
š™Ÿl_max_¡»am_d©a_uni
, 
p
, 
’d
);

424 ià(
Ä—d
 < 0) {

425  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

427 
p
 +ğ
Ä—d
;

429 
NGTCP2_TRANSPORT_PARAM_INITIAL_MAX_DATA
:

430 
æags
 |ğ1u << 
·¿m_ty³
;

431 
Ä—d
 = 
	`decode_v¬št
(&
·¿ms
->
š™Ÿl_max_d©a
, 
p
, 
’d
);

432 ià(
Ä—d
 < 0) {

433  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

435 
p
 +ğ
Ä—d
;

437 
NGTCP2_TRANSPORT_PARAM_INITIAL_MAX_STREAMS_BIDI
:

438 
æags
 |ğ1u << 
·¿m_ty³
;

439 
Ä—d
 = 
	`decode_v¬št
(&
·¿ms
->
š™Ÿl_max_¡»ams_bidi
, 
p
, 
’d
);

440 ià(
Ä—d
 < 0) {

441  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

443 
p
 +ğ
Ä—d
;

445 
NGTCP2_TRANSPORT_PARAM_INITIAL_MAX_STREAMS_UNI
:

446 
æags
 |ğ1u << 
·¿m_ty³
;

447 
Ä—d
 = 
	`decode_v¬št
(&
·¿ms
->
š™Ÿl_max_¡»ams_uni
, 
p
, 
’d
);

448 ià(
Ä—d
 < 0) {

449  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

451 
p
 +ğ
Ä—d
;

453 
NGTCP2_TRANSPORT_PARAM_IDLE_TIMEOUT
:

454 
æags
 |ğ1u << 
·¿m_ty³
;

455 
Ä—d
 = 
	`decode_v¬št
(&
·¿ms
->
idË_timeout
, 
p
, 
’d
);

456 ià(
Ä—d
 < 0) {

457  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

459 
p
 +ğ
Ä—d
;

461 
NGTCP2_TRANSPORT_PARAM_MAX_PACKET_SIZE
:

462 
æags
 |ğ1u << 
·¿m_ty³
;

463 
Ä—d
 = 
	`decode_v¬št
(&
·¿ms
->
max_·ck‘_size
, 
p
, 
’d
);

464 ià(
Ä—d
 < 0) {

465  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

467 
p
 +ğ
Ä—d
;

469 
NGTCP2_TRANSPORT_PARAM_STATELESS_RESET_TOKEN
:

470 ià(
ex‰y³
 !ğ
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
) {

471  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

473 
æags
 |ğ1u << 
NGTCP2_TRANSPORT_PARAM_STATELESS_RESET_TOKEN
;

474 ià(
	`ngtı2_g‘_ušt16
(
p
è!ğ(
·¿ms
->
¡©–ess_»£t_tok’
)) {

475  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

477 
p
 +ğ(
ušt16_t
);

478 ià((
size_t
)(
’d
 - 
p
è< (
·¿ms
->
¡©–ess_»£t_tok’
)) {

479  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

482 
	`memıy
(
·¿ms
->
¡©–ess_»£t_tok’
, 
p
,

483 (
·¿ms
->
¡©–ess_»£t_tok’
));

484 
·¿ms
->
¡©–ess_»£t_tok’_´e£Á
 = 1;

486 
p
 +ğ(
·¿ms
->
¡©–ess_»£t_tok’
);

488 
NGTCP2_TRANSPORT_PARAM_ACK_DELAY_EXPONENT
:

489 
æags
 |ğ1u << 
·¿m_ty³
;

490 
Ä—d
 = 
	`decode_v¬št
(&
·¿ms
->
ack_d–ay_expÚ’t
, 
p
, 
’d
);

491 ià(
Ä—d
 < 0 || 
·¿ms
->
ack_d–ay_expÚ’t
 > 20) {

492  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

494 
p
 +ğ
Ä—d
;

496 
NGTCP2_TRANSPORT_PARAM_PREFERRED_ADDRESS
:

497 ià(
ex‰y³
 !ğ
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
) {

498  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

500 
æags
 |ğ1u << 
NGTCP2_TRANSPORT_PARAM_PREFERRED_ADDRESS
;

501 
v®u–’
 = 
	`ngtı2_g‘_ušt16
(
p
);

502 
p
 +ğ(
ušt16_t
);

503 ià((
size_t
)(
’d
 - 
p
è< 
v®u–’
) {

504  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

506 
Ën
 = 1 + 1 +

509 + 1 + 
NGTCP2_STATELESS_RESET_TOKENLEN
;

510 ià(
v®u–’
 < 
Ën
) {

511  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

515 
·¿ms
->
´eã¼ed_add»ss
.
_v”siÚ
 = *
p
++;

516 
·¿ms
->
´eã¼ed_add»ss
.
_v”siÚ
) {

517 
NGTCP2_IP_VERSION_4
:

518 
NGTCP2_IP_VERSION_6
:

521  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

525 
·¿ms
->
´eã¼ed_add»ss
.
_add»s¦’
 = *
p
++;

526 
Ën
 +ğ
·¿ms
->
´eã¼ed_add»ss
.
_add»s¦’
;

527 ià(
v®u–’
 < 
Ën
) {

528  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

530 
	`memıy
(
·¿ms
->
´eã¼ed_add»ss
.
_add»ss
, 
p
,

531 
·¿ms
->
´eã¼ed_add»ss
.
_add»s¦’
);

532 
p
 +ğ
·¿ms
->
´eã¼ed_add»ss
.
_add»s¦’
;

535 
·¿ms
->
´eã¼ed_add»ss
.
pÜt
 = 
	`ngtı2_g‘_ušt16
(
p
);

536 
p
 +ğ(
ušt16_t
);

539 
·¿ms
->
´eã¼ed_add»ss
.
cid
.
d©®’
 = *
p
++;

540 
Ën
 +ğ
·¿ms
->
´eã¼ed_add»ss
.
cid
.
d©®’
;

541 ià(
v®u–’
 !ğ
Ën
 ||

542 
·¿ms
->
´eã¼ed_add»ss
.
cid
.
d©®’
 > 
NGTCP2_MAX_CIDLEN
 ||

543 (
·¿ms
->
´eã¼ed_add»ss
.
cid
.
d©®’
 != 0 &&

544 
·¿ms
->
´eã¼ed_add»ss
.
cid
.
d©®’
 < 
NGTCP2_MIN_CIDLEN
)) {

545  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

547 ià(
·¿ms
->
´eã¼ed_add»ss
.
cid
.
d©®’
) {

548 
	`memıy
(
·¿ms
->
´eã¼ed_add»ss
.
cid
.
d©a
, 
p
,

549 
·¿ms
->
´eã¼ed_add»ss
.
cid
.
d©®’
);

550 
p
 +ğ
·¿ms
->
´eã¼ed_add»ss
.
cid
.
d©®’
;

554 
	`memıy
(
·¿ms
->
´eã¼ed_add»ss
.
¡©–ess_»£t_tok’
, 
p
,

555 (
·¿ms
->
´eã¼ed_add»ss
.
¡©–ess_»£t_tok’
));

556 
p
 +ğ(
·¿ms
->
´eã¼ed_add»ss
.
¡©–ess_»£t_tok’
);

558 
NGTCP2_TRANSPORT_PARAM_DISABLE_MIGRATION
:

559 
æags
 |ğ1u << 
NGTCP2_TRANSPORT_PARAM_DISABLE_MIGRATION
;

560 ià(
	`ngtı2_g‘_ušt16
(
p
) != 0) {

561  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

563 
p
 +ğ(
ušt16_t
);

564 
·¿ms
->
di§bË_mig¿tiÚ
 = 1;

566 
NGTCP2_TRANSPORT_PARAM_ORIGINAL_CONNECTION_ID
:

567 ià(
ex‰y³
 !ğ
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
) {

568  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

570 
æags
 |ğ1u << 
NGTCP2_TRANSPORT_PARAM_ORIGINAL_CONNECTION_ID
;

571 
Ën
 = 
	`ngtı2_g‘_ušt16
(
p
);

572 
p
 +ğ(
ušt16_t
);

573 ià((
size_t
)(
’d
 - 
p
è< 
Ën
) {

574  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

576 
	`ngtı2_cid_š™
(&
·¿ms
->
Üigš®_cÚÃùiÚ_id
, 
p
, 
Ën
);

577 
·¿ms
->
Üigš®_cÚÃùiÚ_id_´e£Á
 = 1;

578 
p
 +ğ
Ën
;

580 
NGTCP2_TRANSPORT_PARAM_MAX_ACK_DELAY
:

581 
æags
 |ğ1u << 
·¿m_ty³
;

582 
Ä—d
 = 
	`decode_v¬št
(&
·¿ms
->
max_ack_d–ay
, 
p
, 
’d
);

583 ià(
Ä—d
 < 0) {

584  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

586 
p
 +ğ
Ä—d
;

590 
v®u–’
 = 
	`ngtı2_g‘_ušt16
(
p
);

591 
p
 +ğ(
ušt16_t
);

592 ià((
size_t
)(
’d
 - 
p
è< 
v®u–’
) {

593  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

595 
p
 +ğ
v®u–’
;

600 ià(
’d
 - 
p
 != 0) {

601  
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
;

605 
	}
}

	@lib/ngtcp2_crypto.h

25 #iâdeà
NGTCP2_CRYPTO_H


26 
	#NGTCP2_CRYPTO_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

34 
	~"ngtı2_mem.h
"

39 
	#NGTCP2_INITIAL_AEAD_OVERHEAD
 16

	)

42 
	#NGTCP2_MAX_AEAD_OVERHEAD
 16

	)

46 
	#NGTCP2_HP_SAMPLELEN
 16

	)

49 
	mNGTCP2_CRYPTO_KM_FLAG_NONE
,

52 
	mNGTCP2_CRYPTO_KM_FLAG_KEY_PHASE_ONE
 = 0x01,

53 } 
	tngtı2_üy±o_km_æag
;

56 
ngtı2_vec
 
	mkey
;

57 
ngtı2_vec
 
	miv
;

62 
ušt64_t
 
	mpkt_num
;

65 
ušt8_t
 
	mæags
;

66 } 
	tngtı2_üy±o_km
;

68 
ngtı2_üy±o_km_Ãw
(
ngtı2_üy±o_km
 **
pckm
, cÚ¡ 
ušt8_t
 *
key
,

69 
size_t
 
keyËn
, cÚ¡ 
ušt8_t
 *
iv
, size_ˆ
ivËn
,

70 
ngtı2_mem
 *
mem
);

72 
ngtı2_üy±o_km_d–
(
ngtı2_üy±o_km
 *
ckm
, 
ngtı2_mem
 *
mem
);

75 cÚ¡ 
ngtı2_üy±o_km
 *
	mckm
;

76 cÚ¡ 
ngtı2_vec
 *
	mhp
;

77 
size_t
 
	m«ad_ov”h—d
;

78 
ngtı2_’üy±
 
	m’üy±
;

79 
ngtı2_deüy±
 
	mdeüy±
;

80 
ngtı2_hp_mask
 
	mhp_mask
;

81 *
	mu£r_d©a
;

82 } 
	tngtı2_üy±o_ùx
;

84 
ngtı2_üy±o_ü—‹_nÚû
(
ušt8_t
 *
de¡
, cÚ¡ ušt8_ˆ*
iv
, 
size_t
 
ivËn
,

85 
ušt64_t
 
pkt_num
);

	@lib/ngtcp2_err.c

25 
	~"ngtı2_”r.h
"

27 cÚ¡ *
	$ngtı2_¡»¼Ü
(
lib”r
) {

28 
lib”r
) {

31 
NGTCP2_ERR_INVALID_ARGUMENT
:

33 
NGTCP2_ERR_UNKNOWN_PKT_TYPE
:

35 
NGTCP2_ERR_NOBUF
:

37 
NGTCP2_ERR_PROTO
:

39 
NGTCP2_ERR_INVALID_STATE
:

41 
NGTCP2_ERR_ACK_FRAME
:

43 
NGTCP2_ERR_STREAM_ID_BLOCKED
:

45 
NGTCP2_ERR_STREAM_IN_USE
:

47 
NGTCP2_ERR_STREAM_DATA_BLOCKED
:

49 
NGTCP2_ERR_FLOW_CONTROL
:

51 
NGTCP2_ERR_STREAM_LIMIT
:

53 
NGTCP2_ERR_FINAL_OFFSET
:

55 
NGTCP2_ERR_CRYPTO
:

57 
NGTCP2_ERR_PKT_NUM_EXHAUSTED
:

59 
NGTCP2_ERR_NOMEM
:

61 
NGTCP2_ERR_REQUIRED_TRANSPORT_PARAM
:

63 
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
:

65 
NGTCP2_ERR_FRAME_ENCODING
:

67 
NGTCP2_ERR_TLS_DECRYPT
:

69 
NGTCP2_ERR_STREAM_SHUT_WR
:

71 
NGTCP2_ERR_STREAM_NOT_FOUND
:

73 
NGTCP2_ERR_VERSION_NEGOTIATION
:

75 
NGTCP2_ERR_STREAM_STATE
:

77 
NGTCP2_ERR_NOKEY
:

79 
NGTCP2_ERR_EARLY_DATA_REJECTED
:

81 
NGTCP2_ERR_RECV_VERSION_NEGOTIATION
:

83 
NGTCP2_ERR_CLOSING
:

85 
NGTCP2_ERR_DRAINING
:

87 
NGTCP2_ERR_TRANSPORT_PARAM
:

89 
NGTCP2_ERR_DISCARD_PKT
:

91 
NGTCP2_ERR_CALLBACK_FAILURE
:

93 
NGTCP2_ERR_INTERNAL
:

98 
	}
}

100 
	$ngtı2_”r_is_çl
(
lib”r
è{ †ib”¸< 
NGTCP2_ERR_FATAL
; 
	}
}

102 
ušt16_t
 
	$ngtı2_”r_šãr_quic_Œª¥Üt_”rÜ_code
(
lib”r
) {

103 
lib”r
) {

105  
NGTCP2_NO_ERROR
;

106 
NGTCP2_ERR_ACK_FRAME
:

107 
NGTCP2_ERR_FRAME_ENCODING
:

108  
NGTCP2_FRAME_ENCODING_ERROR
;

109 
NGTCP2_ERR_FLOW_CONTROL
:

110  
NGTCP2_FLOW_CONTROL_ERROR
;

111 
NGTCP2_ERR_STREAM_LIMIT
:

112  
NGTCP2_STREAM_LIMIT_ERROR
;

113 
NGTCP2_ERR_FINAL_OFFSET
:

114  
NGTCP2_FINAL_OFFSET_ERROR
;

115 
NGTCP2_ERR_REQUIRED_TRANSPORT_PARAM
:

116  
NGTCP2_TRANSPORT_PARAMETER_ERROR
;

117 
NGTCP2_ERR_INVALID_ARGUMENT
:

118  
NGTCP2_INTERNAL_ERROR
;

119 
NGTCP2_ERR_STREAM_STATE
:

120  
NGTCP2_STREAM_STATE_ERROR
;

121 
NGTCP2_ERR_VERSION_NEGOTIATION
:

122  
NGTCP2_VERSION_NEGOTIATION_ERROR
;

124  
NGTCP2_PROTOCOL_VIOLATION
;

126 
	}
}

	@lib/ngtcp2_err.h

25 #iâdeà
NGTCP2_ERR_H


26 
	#NGTCP2_ERR_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

	@lib/ngtcp2_gaptr.c

25 
	~"ngtı2_g­Œ.h
"

27 
	~<¡ršg.h
>

28 
	~<as£¹.h
>

30 
	~"ngtı2_maüo.h
"

32 
	$ngtı2_g­Œ_š™
(
ngtı2_g­Œ
 *
g­Œ
, 
ngtı2_mem
 *
mem
) {

33 
rv
;

34 
ngtı2_¿nge
 
key
 = {0, 
UINT64_MAX
};

35 
rv
 = 
	`ngtı2_p¦_š™
(&
g­Œ
->
g­
, 
mem
);

36 ià(
rv
 != 0) {

37  
rv
;

40 
rv
 = 
	`ngtı2_p¦_š£¹
(&
g­Œ
->
g­
, 
NULL
, &
key
, NULL);

41 ià(
rv
 != 0) {

42 
	`ngtı2_p¦_ä“
(&
g­Œ
->
g­
);

43  
rv
;

46 
g­Œ
->
mem
 = mem;

49 
	}
}

51 
	$ngtı2_g­Œ_ä“
(
ngtı2_g­Œ
 *
g­Œ
) {

52 ià(
g­Œ
 =ğ
NULL
) {

56 
	`ngtı2_p¦_ä“
(&
g­Œ
->
g­
);

57 
	}
}

59 
	$ngtı2_g­Œ_push
(
ngtı2_g­Œ
 *
g­Œ
, 
ušt64_t
 
off£t
, 
size_t
 
d©®’
) {

60 
rv
;

61 
ngtı2_¿nge
 
k
, 
m
, 
l
, 
r
, 
q
 = {
off£t
, off£ˆ+ 
d©®’
};

62 
ngtı2_p¦_™
 
™
;

64 
™
 = 
	`ngtı2_p¦_low”_bound
(&
g­Œ
->
g­
, &
q
);

66 ; !
	`ngtı2_p¦_™_’d
(&
™
);) {

67 
k
 = 
	`ngtı2_p¦_™_¿nge
(&
™
);

68 
m
 = 
	`ngtı2_¿nge_š‹r£ù
(&
q
, &
k
);

69 ià(!
	`ngtı2_¿nge_Ën
(&
m
)) {

73 ià(
	`ngtı2_¿nge_eq
(&
k
, &
m
)) {

74 
rv
 = 
	`ngtı2_p¦_»move
(&
g­Œ
->
g­
, &
™
, &
k
);

75 ià(
rv
 != 0) {

76  
rv
;

80 
	`ngtı2_¿nge_cut
(&
l
, &
r
, &
k
, &
m
);

81 ià(
	`ngtı2_¿nge_Ën
(&
l
)) {

82 
	`ngtı2_p¦_upd©e_¿nge
(&
g­Œ
->
g­
, &
k
, &
l
);

84 ià(
	`ngtı2_¿nge_Ën
(&
r
)) {

85 
rv
 = 
	`ngtı2_p¦_š£¹
(&
g­Œ
->
g­
, &
™
, &
r
, 
NULL
);

86 ià(
rv
 != 0) {

87  
rv
;

90 } ià(
	`ngtı2_¿nge_Ën
(&
r
)) {

91 
	`ngtı2_p¦_upd©e_¿nge
(&
g­Œ
->
g­
, &
k
, &
r
);

93 
	`ngtı2_p¦_™_Ãxt
(&
™
);

96 
	}
}

98 
ušt64_t
 
	$ngtı2_g­Œ_fœ¡_g­_off£t
(
ngtı2_g­Œ
 *
g­Œ
) {

99 
ngtı2_p¦_™
 
™
 = 
	`ngtı2_p¦_begš
(&
g­Œ
->
g­
);

100 
ngtı2_¿nge
 
r
 = 
	`ngtı2_p¦_™_¿nge
(&
™
);

101  
r
.
begš
;

102 
	}
}

104 
	$ngtı2_g­Œ_is_pushed
(
ngtı2_g­Œ
 *
g­Œ
, 
ušt64_t
 
off£t
,

105 
size_t
 
d©®’
) {

106 
ngtı2_¿nge
 
q
 = {
off£t
, off£ˆ+ 
d©®’
};

107 
ngtı2_p¦_™
 
™
 = 
	`ngtı2_p¦_low”_bound
(&
g­Œ
->
g­
, &
q
);

108 
ngtı2_¿nge
 
k
 = 
	`ngtı2_p¦_™_¿nge
(&
™
);

109 
ngtı2_¿nge
 
m
 = 
	`ngtı2_¿nge_š‹r£ù
(&
q
, &
k
);

110  
	`ngtı2_¿nge_Ën
(&
m
) == 0;

111 
	}
}

	@lib/ngtcp2_gaptr.h

25 #iâdeà
NGTCP2_GAPTR_H


26 
	#NGTCP2_GAPTR_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

34 
	~"ngtı2_mem.h
"

35 
	~"ngtı2_¿nge.h
"

36 
	~"ngtı2_p¦.h
"

44 
ngtı2_p¦
 
	mg­
;

46 
ngtı2_mem
 *
	mmem
;

47 } 
	tngtı2_g­Œ
;

58 
ngtı2_g­Œ_š™
(
ngtı2_g­Œ
 *
g­Œ
, 
ngtı2_mem
 *
mem
);

63 
ngtı2_g­Œ_ä“
(
ngtı2_g­Œ
 *
g­Œ
);

75 
ngtı2_g­Œ_push
(
ngtı2_g­Œ
 *
g­Œ
, 
ušt64_t
 
off£t
, 
size_t
 
d©®’
);

81 
ušt64_t
 
ngtı2_g­Œ_fœ¡_g­_off£t
(
ngtı2_g­Œ
 *
g­Œ
);

87 
ngtı2_g­Œ_is_pushed
(
ngtı2_g­Œ
 *
g­Œ
, 
ušt64_t
 
off£t
,

88 
size_t
 
d©®’
);

	@lib/ngtcp2_idtr.c

25 
	~"ngtı2_idŒ.h
"

27 
	~<as£¹.h
>

29 
	$ngtı2_idŒ_š™
(
ngtı2_idŒ
 *
idŒ
, 
£rv”
, 
ngtı2_mem
 *
mem
) {

30 
rv
;

32 
rv
 = 
	`ngtı2_g­Œ_š™
(&
idŒ
->
g­
, 
mem
);

33 ià(
rv
 != 0) {

34  
rv
;

37 
idŒ
->
£rv”
 = server;

38 
idŒ
->
mem
 = mem;

41 
	}
}

43 
	$ngtı2_idŒ_ä“
(
ngtı2_idŒ
 *
idŒ
) {

44 ià(
idŒ
 =ğ
NULL
) {

48 
	`ngtı2_g­Œ_ä“
(&
idŒ
->
g­
);

49 
	}
}

55 
ušt64_t
 
	$id_äom_¡»am_id
(
ušt64_t
 
¡»am_id
è{  sŒ—m_id >> 2; 
	}
}

57 
	$ngtı2_idŒ_İ’
(
ngtı2_idŒ
 *
idŒ
, 
ušt64_t
 
¡»am_id
) {

58 
ušt64_t
 
q
;

60 
	`as£¹
((
idŒ
->
£rv”
 && (
¡»am_id
 % 2)) ||

61 (!
idŒ
->
£rv”
 && (
¡»am_id
 % 2)) == 0);

63 
q
 = 
	`id_äom_¡»am_id
(
¡»am_id
);

65 ià(
	`ngtı2_g­Œ_is_pushed
(&
idŒ
->
g­
, 
q
, 1)) {

66  
NGTCP2_ERR_STREAM_IN_USE
;

69  
	`ngtı2_g­Œ_push
(&
idŒ
->
g­
, 
q
, 1);

70 
	}
}

72 
	$ngtı2_idŒ_is_İ’
(
ngtı2_idŒ
 *
idŒ
, 
ušt64_t
 
¡»am_id
) {

73 
ušt64_t
 
q
;

75 
	`as£¹
((
idŒ
->
£rv”
 && (
¡»am_id
 % 2)) ||

76 (!
idŒ
->
£rv”
 && (
¡»am_id
 % 2)) == 0);

78 
q
 = 
	`id_äom_¡»am_id
(
¡»am_id
);

80  
	`ngtı2_g­Œ_is_pushed
(&
idŒ
->
g­
, 
q
, 1);

81 
	}
}

83 
ušt64_t
 
	$ngtı2_idŒ_fœ¡_g­
(
ngtı2_idŒ
 *
idŒ
) {

84  
	`ngtı2_g­Œ_fœ¡_g­_off£t
(&
idŒ
->
g­
);

85 
	}
}

	@lib/ngtcp2_idtr.h

25 #iâdeà
NGTCP2_IDTR_H


26 
	#NGTCP2_IDTR_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

34 
	~"ngtı2_mem.h
"

35 
	~"ngtı2_g­Œ.h
"

43 
ngtı2_g­Œ
 
	mg­
;

46 
	m£rv”
;

48 
ngtı2_mem
 *
	mmem
;

49 } 
	tngtı2_idŒ
;

64 
ngtı2_idŒ_š™
(
ngtı2_idŒ
 *
idŒ
, 
£rv”
, 
ngtı2_mem
 *
mem
);

69 
ngtı2_idŒ_ä“
(
ngtı2_idŒ
 *
idŒ
);

82 
ngtı2_idŒ_İ’
(
ngtı2_idŒ
 *
idŒ
, 
ušt64_t
 
¡»am_id
);

89 
ngtı2_idŒ_is_İ’
(
ngtı2_idŒ
 *
idŒ
, 
ušt64_t
 
¡»am_id
);

96 
ušt64_t
 
ngtı2_idŒ_fœ¡_g­
(
ngtı2_idŒ
 *
idŒ
);

	@lib/ngtcp2_ksl.c

25 
	~"ngtı2_k¦.h
"

27 
	~<¡dlib.h
>

28 
	~<¡ršg.h
>

29 
	~<as£¹.h
>

30 
	~<¡dio.h
>

32 
	~"ngtı2_maüo.h
"

33 
	~"ngtı2_mem.h
"

35 
	$ngtı2_k¦_š™
(
ngtı2_k¦
 *
k¦
, 
ngtı2_k¦_com·r
 
com·r
,

36 cÚ¡ 
ngtı2_k¦_key
 *
šf_key
, 
ngtı2_mem
 *
mem
) {

37 
ngtı2_k¦_blk
 *
h—d
;

39 
k¦
->
h—d
 = 
	`ngtı2_mem_m®loc
(
mem
, (
ngtı2_k¦_blk
));

40 ià(!
k¦
->
h—d
) {

41  
NGTCP2_ERR_NOMEM
;

43 
k¦
->
äÚt
 = k¦->
back
 = k¦->
h—d
;

44 
k¦
->
com·r
 = compar;

45 
k¦
->
šf_key
 = *inf_key;

46 
k¦
->
n
 = 0;

47 
k¦
->
mem
 = mem;

49 
h—d
 = 
k¦
->head;

51 
h—d
->
Ãxt
 = h—d->
´ev
 = 
NULL
;

52 
h—d
->
n
 = 1;

53 
h—d
->
Ëaf
 = 1;

54 
h—d
->
nodes
[0].
key
 = 
k¦
->
šf_key
;

55 
h—d
->
nodes
[0].
d©a
 = 
NULL
;

58 
	}
}

63 
	$ä“_blk
(
ngtı2_k¦_blk
 *
blk
, 
ngtı2_mem
 *
mem
) {

64 
size_t
 
i
;

66 ià(!
blk
->
Ëaf
) {

67 
i
 = 0; i < 
blk
->
n
; ++i) {

68 
	`ä“_blk
(
blk
->
nodes
[
i
].blk, 
mem
);

72 
	`ngtı2_mem_ä“
(
mem
, 
blk
);

73 
	}
}

75 
	$ngtı2_k¦_ä“
(
ngtı2_k¦
 *
k¦
) {

76 ià(!
k¦
) {

80 
	`ä“_blk
(
k¦
->
h—d
, k¦->
mem
);

81 
	}
}

91 
ngtı2_k¦_blk
 *
	$k¦_¥l™_blk
(
ngtı2_k¦
 *
k¦
, 
ngtı2_k¦_blk
 *
blk
) {

92 
ngtı2_k¦_blk
 *
rblk
;

94 
rblk
 = 
	`ngtı2_mem_m®loc
(
k¦
->
mem
, (
ngtı2_k¦_blk
));

95 ià(
rblk
 =ğ
NULL
) {

96  
NULL
;

99 
rblk
->
Ãxt
 = 
blk
->next;

100 
blk
->
Ãxt
 = 
rblk
;

101 ià(
rblk
->
Ãxt
) {

102 
rblk
->
Ãxt
->
´ev
 =„blk;

103 } ià(
k¦
->
back
 =ğ
blk
) {

104 
k¦
->
back
 = 
rblk
;

106 
rblk
->
´ev
 = 
blk
;

107 
rblk
->
Ëaf
 = 
blk
->leaf;

109 
rblk
->
n
 = 
blk
->n / 2;

111 
	`memıy
(
rblk
->
nodes
, &
blk
->nodes[blk->
n
 -„blk->n],

112 (
ngtı2_k¦_node
è* 
rblk
->
n
);

114 
blk
->
n
 -ğ
rblk
->n;

116 
	`as£¹
(
blk
->
n
 >ğ
NGTCP2_KSL_MIN_NBLK
);

117 
	`as£¹
(
rblk
->
n
 >ğ
NGTCP2_KSL_MIN_NBLK
);

119  
rblk
;

120 
	}
}

133 
	$k¦_¥l™_node
(
ngtı2_k¦
 *
k¦
, 
ngtı2_k¦_blk
 *
blk
, 
size_t
 
i
) {

134 
ngtı2_k¦_blk
 *
lblk
 = 
blk
->
nodes
[
i
].blk, *
rblk
;

136 
rblk
 = 
	`k¦_¥l™_blk
(
k¦
, 
lblk
);

137 ià(
rblk
 =ğ
NULL
) {

138  
NGTCP2_ERR_NOMEM
;

141 
	`memmove
(&
blk
->
nodes
[
i
 + 2], &blk->nodes[i + 1],

142 (
ngtı2_k¦_node
è* (
blk
->
n
 - (
i
 + 1)));

144 
blk
->
nodes
[
i
 + 1].blk = 
rblk
;

146 ++
blk
->
n
;

148 
blk
->
nodes
[
i
].
key
 = 
lblk
->nodes[lblk->
n
 - 1].key;

149 
blk
->
nodes
[
i
 + 1].
key
 = 
rblk
->nodes[rblk->
n
 - 1].key;

152 
	}
}

164 
	$k¦_¥l™_h—d
(
ngtı2_k¦
 *
k¦
) {

165 
ngtı2_k¦_blk
 *
rblk
 = 
NULL
, *
lblk
, *
nh—d
 = NULL;

167 
rblk
 = 
	`k¦_¥l™_blk
(
k¦
, k¦->
h—d
);

168 ià(
rblk
 =ğ
NULL
) {

169  
NGTCP2_ERR_NOMEM
;

172 
lblk
 = 
k¦
->
h—d
;

174 
nh—d
 = 
	`ngtı2_mem_m®loc
(
k¦
->
mem
, (
ngtı2_k¦_blk
));

175 ià(
nh—d
 =ğ
NULL
) {

176 
	`ngtı2_mem_ä“
(
k¦
->
mem
, 
rblk
);

177  
NGTCP2_ERR_NOMEM
;

179 
nh—d
->
Ãxt
 =‚h—d->
´ev
 = 
NULL
;

180 
nh—d
->
n
 = 2;

181 
nh—d
->
Ëaf
 = 0;

183 
nh—d
->
nodes
[0].
key
 = 
lblk
->nodes[lblk->
n
 - 1].key;

184 
nh—d
->
nodes
[0].
blk
 = 
lblk
;

185 
nh—d
->
nodes
[1].
key
 = 
rblk
->nodes[rblk->
n
 - 1].key;

186 
nh—d
->
nodes
[1].
blk
 = 
rblk
;

188 
k¦
->
h—d
 = 
nh—d
;

191 
	}
}

199 
	$š£¹_node
(
ngtı2_k¦_blk
 *
blk
, 
size_t
 
i
,

200 cÚ¡ 
ngtı2_k¦_key
 *
key
, *
d©a
) {

201 
ngtı2_k¦_node
 *
node
;

203 
	`as£¹
(
blk
->
n
 < 
NGTCP2_KSL_MAX_NBLK
);

205 
	`memmove
(&
blk
->
nodes
[
i
 + 1], &blk->nodes[i],

206 (
ngtı2_k¦_node
è* (
blk
->
n
 - 
i
));

208 
node
 = &
blk
->
nodes
[
i
];

209 
node
->
key
 = *key;

210 
node
->
d©a
 = data;

212 ++
blk
->
n
;

213 
	}
}

215 
	$ngtı2_k¦_š£¹
(
ngtı2_k¦
 *
k¦
, 
ngtı2_k¦_™
 *
™
,

216 cÚ¡ 
ngtı2_k¦_key
 *
key
, *
d©a
) {

217 
ngtı2_k¦_blk
 *
blk
 = 
k¦
->
h—d
;

218 
ngtı2_k¦_node
 *
node
;

219 
size_t
 
i
;

220 
rv
;

222 ià(
blk
->
n
 =ğ
NGTCP2_KSL_MAX_NBLK
) {

223 
rv
 = 
	`k¦_¥l™_h—d
(
k¦
);

224 ià(
rv
 != 0) {

225  
rv
;

227 
blk
 = 
k¦
->
h—d
;

231 
i
 = 0, 
node
 = &
blk
->
nodes
[i]; 
k¦
->
	`com·r
(&node->
key
, key);

232 ++
i
, ++
node
)

235 ià(
blk
->
Ëaf
) {

236 
	`š£¹_node
(
blk
, 
i
, 
key
, 
d©a
);

237 ++
k¦
->
n
;

238 ià(
™
) {

239 
	`ngtı2_k¦_™_š™
(
™
, 
blk
, 
i
, 
k¦
->
com·r
, &k¦->
šf_key
);

244 ià(
node
->
blk
->
n
 =ğ
NGTCP2_KSL_MAX_NBLK
) {

245 
rv
 = 
	`k¦_¥l™_node
(
k¦
, 
blk
, 
i
);

246 ià(
rv
 != 0) {

247  
rv
;

249 ià(
k¦
->
	`com·r
(&
node
->
key
, key)) {

250 
node
 = &
blk
->
nodes
[
i
 + 1];

254 
blk
 = 
node
->blk;

256 
	}
}

261 
	$»move_node
(
ngtı2_k¦_blk
 *
blk
, 
size_t
 
i
) {

262 
	`memmove
(&
blk
->
nodes
[
i
], &blk->nodes[i + 1],

263 (
ngtı2_k¦_node
è* (
blk
->
n
 - (
i
 + 1)));

265 --
blk
->
n
;

266 
	}
}

278 
ngtı2_k¦_blk
 *
	$k¦_m”ge_node
(
ngtı2_k¦
 *
k¦
, 
ngtı2_k¦_blk
 *
blk
,

279 
size_t
 
i
) {

280 
ngtı2_k¦_blk
 *
lblk
, *
rblk
;

282 
	`as£¹
(
i
 + 1 < 
blk
->
n
);

284 
lblk
 = 
blk
->
nodes
[
i
].blk;

285 
rblk
 = 
blk
->
nodes
[
i
 + 1].blk;

287 
	`as£¹
(
lblk
->
n
 + 
rblk
->À< 
NGTCP2_KSL_MAX_NBLK
);

289 
	`memıy
(&
lblk
->
nodes
[lblk->
n
], &
rblk
->nodes[0],

290 (
ngtı2_k¦_node
è* 
rblk
->
n
);

292 
lblk
->
n
 +ğ
rblk
->n;

293 
lblk
->
Ãxt
 = 
rblk
->next;

294 ià(
lblk
->
Ãxt
) {

295 
lblk
->
Ãxt
->
´ev
 =†blk;

296 } ià(
k¦
->
back
 =ğ
rblk
) {

297 
k¦
->
back
 = 
lblk
;

300 
	`ngtı2_mem_ä“
(
k¦
->
mem
, 
rblk
);

302 ià(
k¦
->
h—d
 =ğ
blk
 && blk->
n
 == 2) {

303 
	`ngtı2_mem_ä“
(
k¦
->
mem
, k¦->
h—d
);

304 
k¦
->
h—d
 = 
lblk
;

306 
	`»move_node
(
blk
, 
i
 + 1);

307 
blk
->
nodes
[
i
].
key
 = 
lblk
->nodes[lblk->
n
 - 1].key;

310  
lblk
;

311 
	}
}

329 
	$k¦_»loÿ‹_node
(
ngtı2_k¦
 *
k¦
, 
ngtı2_k¦_blk
 **
pblk
,

330 
size_t
 *
pi
) {

331 
ngtı2_k¦_blk
 *
blk
 = *
pblk
;

332 
size_t
 
i
 = *
pi
;

333 
ngtı2_k¦_node
 *
node
 = &
blk
->
nodes
[
i
];

334 
ngtı2_k¦_node
 *
ºode
 = &
blk
->
nodes
[
i
 + 1];

335 
size_t
 
j
;

336 
rv
;

338 
	`as£¹
(
i
 + 1 < 
blk
->
n
);

340 ià(
node
->
blk
->
n
 =ğ
NGTCP2_KSL_MIN_NBLK
 &&

341 
node
->
blk
->
n
 + 
ºode
->blk->À< 
NGTCP2_KSL_MAX_NBLK
) {

342 
j
 = 
node
->
blk
->
n
 - 1;

343 
blk
 = 
	`k¦_m”ge_node
(
k¦
, blk, 
i
);

344 ià(
blk
 !ğ
k¦
->
h—d
) {

347 *
pblk
 = 
blk
;

348 
i
 = 
j
;

349 ià(
blk
->
Ëaf
) {

350 *
pi
 = 
i
;

353 
node
 = &
blk
->
nodes
[
i
];

354 
ºode
 = &
blk
->
nodes
[
i
 + 1];

356 ià(
node
->
blk
->
n
 =ğ
NGTCP2_KSL_MIN_NBLK
 &&

357 
node
->
blk
->
n
 + 
ºode
->blk->À< 
NGTCP2_KSL_MAX_NBLK
) {

358 
j
 = 
node
->
blk
->
n
 - 1;

359 
blk
 = 
	`k¦_m”ge_node
(
k¦
, blk, 
i
);

360 
	`as£¹
(
blk
 !ğ
k¦
->
h—d
);

361 *
pi
 = 
j
;

366 ià(
node
->
blk
->
n
 < 
ºode
->blk->n) {

367 
node
->
blk
->
nodes
[node->blk->
n
] = 
ºode
->blk->nodes[0];

368 
	`memmove
(&
ºode
->
blk
->
nodes
[0], &rnode->blk->nodes[1],

369 (
ngtı2_k¦_node
è* (
ºode
->
blk
->
n
 - 1));

370 --
ºode
->
blk
->
n
;

371 ++
node
->
blk
->
n
;

372 
node
->
key
 =‚ode->
blk
->
nodes
[node->blk->
n
 - 1].key;

373 *
pi
 = 
i
;

377 ià(
ºode
->
blk
->
n
 =ğ
NGTCP2_KSL_MAX_NBLK
) {

378 
rv
 = 
	`k¦_¥l™_node
(
k¦
, 
blk
, 
i
 + 1);

379 ià(
rv
 != 0) {

380  
rv
;

384 
	`memmove
(&
ºode
->
blk
->
nodes
[1], &rnode->blk->nodes[0],

385 (
ngtı2_k¦_node
è* 
ºode
->
blk
->
n
);

387 
ºode
->
blk
->
nodes
[0] = 
node
->blk->nodes[node->blk->
n
 - 1];

388 ++
ºode
->
blk
->
n
;

390 --
node
->
blk
->
n
;

392 
node
->
key
 =‚ode->
blk
->
nodes
[node->blk->
n
 - 1].key;

394 *
pi
 = 
i
 + 1;

396 
	}
}

402 
	$shiá_Ëá
(
ngtı2_k¦_blk
 *
blk
, 
size_t
 
i
) {

403 
ngtı2_k¦_node
 *
Êode
, *
ºode
;

405 
	`as£¹
(
i
 > 0);

407 
Êode
 = &
blk
->
nodes
[
i
 - 1];

408 
ºode
 = &
blk
->
nodes
[
i
];

410 
	`as£¹
(
Êode
->
blk
->
n
 < 
NGTCP2_KSL_MAX_NBLK
);

411 
	`as£¹
(
ºode
->
blk
->
n
 > 
NGTCP2_KSL_MIN_NBLK
);

413 
Êode
->
blk
->
nodes
[Êode->blk->
n
] = 
ºode
->blk->nodes[0];

414 
Êode
->
key
 =†node->
blk
->
nodes
[Êode->blk->
n
].key;

415 ++
Êode
->
blk
->
n
;

417 --
ºode
->
blk
->
n
;

418 
	`memmove
(&
ºode
->
blk
->
nodes
[0], &rnode->blk->nodes[1],

419 (
ngtı2_k¦_node
è* 
ºode
->
blk
->
n
);

420 
	}
}

426 
	$shiá_right
(
ngtı2_k¦_blk
 *
blk
, 
size_t
 
i
) {

427 
ngtı2_k¦_node
 *
Êode
, *
ºode
;

429 
	`as£¹
(
i
 < 
blk
->
n
 - 1);

431 
Êode
 = &
blk
->
nodes
[
i
];

432 
ºode
 = &
blk
->
nodes
[
i
 + 1];

434 
	`as£¹
(
Êode
->
blk
->
n
 > 
NGTCP2_KSL_MIN_NBLK
);

435 
	`as£¹
(
ºode
->
blk
->
n
 < 
NGTCP2_KSL_MAX_NBLK
);

437 
	`memmove
(&
ºode
->
blk
->
nodes
[1], &rnode->blk->nodes[0],

438 (
ngtı2_k¦_node
è* 
ºode
->
blk
->
n
);

439 ++
ºode
->
blk
->
n
;

440 
ºode
->
blk
->
nodes
[0] = 
Êode
->blk->nodes[Êode->blk->
n
 - 1];

442 --
Êode
->
blk
->
n
;

443 
Êode
->
key
 =†node->
blk
->
nodes
[Êode->blk->
n
 - 1].key;

444 
	}
}

450 
	$key_equ®
(
ngtı2_k¦_com·r
 
com·r
, cÚ¡ 
ngtı2_k¦_key
 *
lhs
,

451 cÚ¡ 
ngtı2_k¦_key
 *
rhs
) {

452  !
	`com·r
(
lhs
, 
rhs
) && !compar(rhs,†hs);

453 
	}
}

455 
	$ngtı2_k¦_»move
(
ngtı2_k¦
 *
k¦
, 
ngtı2_k¦_™
 *
™
,

456 cÚ¡ 
ngtı2_k¦_key
 *
key
) {

457 
ngtı2_k¦_blk
 *
blk
 = 
k¦
->
h—d
, *
lblk
, *
rblk
;

458 
ngtı2_k¦_node
 *
node
;

459 
size_t
 
i
, 
j
;

460 
rv
;

462 ià(!
blk
->
Ëaf
 && blk->
n
 =ğ
NGTCP2_KSL_MAX_NBLK
) {

463 
rv
 = 
	`k¦_¥l™_h—d
(
k¦
);

464 ià(
rv
 != 0) {

465  
rv
;

467 
blk
 = 
k¦
->
h—d
;

471 
i
 = 0, 
node
 = &
blk
->
nodes
[i]; 
k¦
->
	`com·r
(&node->
key
, key);

472 ++
i
, ++
node
)

475 ià(
blk
->
Ëaf
) {

476 
	`as£¹
(
i
 < 
blk
->
n
);

477 
	`»move_node
(
blk
, 
i
);

478 --
k¦
->
n
;

479 ià(
™
) {

480 ià(
blk
->
n
 =ğ
i
) {

481 
	`ngtı2_k¦_™_š™
(
™
, 
blk
->
Ãxt
, 0, 
k¦
->
com·r
, &k¦->
šf_key
);

483 
	`ngtı2_k¦_™_š™
(
™
, 
blk
, 
i
, 
k¦
->
com·r
, &k¦->
šf_key
);

489 ià(
node
->
blk
->
n
 =ğ
NGTCP2_KSL_MAX_NBLK
) {

490 
rv
 = 
	`k¦_¥l™_node
(
k¦
, 
blk
, 
i
);

491 ià(
rv
 != 0) {

492  
rv
;

494 ià(
k¦
->
	`com·r
(&
node
->
key
, key)) {

495 ++
i
;

496 
node
 = &
blk
->
nodes
[
i
];

500 ià(
	`key_equ®
(
k¦
->
com·r
, &
node
->
key
, key)) {

501 
rv
 = 
	`k¦_»loÿ‹_node
(
k¦
, &
blk
, &
i
);

502 ià(
rv
 != 0) {

503  
rv
;

505 ià(!
blk
->
Ëaf
) {

506 
node
 = &
blk
->
nodes
[
i
];

507 
blk
 = 
node
->blk;

509 } ià(
node
->
blk
->
n
 =ğ
NGTCP2_KSL_MIN_NBLK
) {

510 
j
 = 
i
 == 0 ? 0 : i - 1;

512 
lblk
 = 
blk
->
nodes
[
j
].blk;

513 
rblk
 = 
blk
->
nodes
[
j
 + 1].blk;

515 ià(
lblk
->
n
 + 
rblk
->À< 
NGTCP2_KSL_MAX_NBLK
) {

516 
blk
 = 
	`k¦_m”ge_node
(
k¦
, blk, 
j
);

518 ià(
i
 =ğ
j
) {

519 
	`shiá_Ëá
(
blk
, 
j
 + 1);

521 
	`shiá_right
(
blk
, 
j
);

523 
blk
 = 
node
->blk;

526 
blk
 = 
node
->blk;

529 
	}
}

531 
ngtı2_k¦_™
 
	$ngtı2_k¦_low”_bound
(
ngtı2_k¦
 *
k¦
,

532 cÚ¡ 
ngtı2_k¦_key
 *
key
) {

533 
ngtı2_k¦_blk
 *
blk
 = 
k¦
->
h—d
;

534 
ngtı2_k¦_node
 *
node
;

535 
size_t
 
i
;

538 
i
 = 0, 
node
 = &
blk
->
nodes
[i]; 
k¦
->
	`com·r
(&node->
key
, key);

539 ++
i
, 
node
 = &
blk
->
nodes
[i])

542 ià(
blk
->
Ëaf
) {

543 
ngtı2_k¦_™
 
™
;

544 
	`ngtı2_k¦_™_š™
(&
™
, 
blk
, 
i
, 
k¦
->
com·r
, &k¦->
šf_key
);

545  
™
;

548 
blk
 = 
node
->blk;

550 
	}
}

552 
	$ngtı2_k¦_upd©e_key
(
ngtı2_k¦
 *
k¦
, cÚ¡ 
ngtı2_k¦_key
 *
Şd_key
,

553 cÚ¡ 
ngtı2_k¦_key
 *
Ãw_key
) {

554 
ngtı2_k¦_blk
 *
blk
 = 
k¦
->
h—d
;

555 
ngtı2_k¦_node
 *
node
;

556 
size_t
 
i
;

559 
i
 = 0, 
node
 = &
blk
->
nodes
[i]; 
k¦
->
	`com·r
(&node->
key
, 
Şd_key
);

560 ++
i
, 
node
 = &
blk
->
nodes
[i])

563 ià(
blk
->
Ëaf
) {

564 
	`as£¹
(
	`key_equ®
(
k¦
->
com·r
, &
node
->
key
, 
Şd_key
));

565 
node
->
key
 = *
Ãw_key
;

569 ià(
	`key_equ®
(
k¦
->
com·r
, &
node
->
key
, 
Şd_key
)) {

570 
node
->
key
 = *
Ãw_key
;

573 
blk
 = 
node
->blk;

575 
	}
}

577 
	$k¦_´št
(
ngtı2_k¦
 *
k¦
, cÚ¡ 
ngtı2_k¦_blk
 *
blk
,

578 
size_t
 
Ëv–
) {

579 
size_t
 
i
;

581 
	`årštf
(
¡d”r
, "LV=%zu‚=%zu\n", 
Ëv–
, 
blk
->
n
);

583 ià(
blk
->
Ëaf
) {

584 
i
 = 0; i < 
blk
->
n
; ++i) {

585 
	`årštf
(
¡d”r
, " %" 
PRId64
, 
blk
->
nodes
[
i
].
key
.i);

587 
	`årštf
(
¡d”r
, "\n");

591 
i
 = 0; i < 
blk
->
n
; ++i) {

592 
	`k¦_´št
(
k¦
, 
blk
->
nodes
[
i
].blk, 
Ëv–
 + 1);

594 
	}
}

596 
size_t
 
	$ngtı2_k¦_Ën
(
ngtı2_k¦
 *
k¦
è{  k¦->
n
; 
	}
}

598 
	$ngtı2_k¦_ş—r
(
ngtı2_k¦
 *
k¦
) {

599 
size_t
 
i
;

600 
ngtı2_k¦_blk
 *
h—d
;

602 ià(!
k¦
->
h—d
->
Ëaf
) {

603 
i
 = 0; i < 
k¦
->
h—d
->
n
; ++i) {

604 
	`ä“_blk
(
k¦
->
h—d
->
nodes
[
i
].
blk
, k¦->
mem
);

608 
k¦
->
äÚt
 = k¦->
back
 = k¦->
h—d
;

609 
k¦
->
n
 = 0;

611 
h—d
 = 
k¦
->head;

613 
h—d
->
Ãxt
 = h—d->
´ev
 = 
NULL
;

614 
h—d
->
n
 = 1;

615 
h—d
->
Ëaf
 = 1;

616 
h—d
->
nodes
[0].
key
 = 
k¦
->
šf_key
;

617 
h—d
->
nodes
[0].
d©a
 = 
NULL
;

618 
	}
}

620 
	$ngtı2_k¦_´št
(
ngtı2_k¦
 *
k¦
è{ 
	`k¦_´št
(k¦, k¦->
h—d
, 0); 
	}
}

622 
ngtı2_k¦_™
 
	$ngtı2_k¦_begš
(cÚ¡ 
ngtı2_k¦
 *
k¦
) {

623 
ngtı2_k¦_™
 
™
;

624 
	`ngtı2_k¦_™_š™
(&
™
, 
k¦
->
äÚt
, 0, k¦->
com·r
, &k¦->
šf_key
);

625  
™
;

626 
	}
}

628 
ngtı2_k¦_™
 
	$ngtı2_k¦_’d
(cÚ¡ 
ngtı2_k¦
 *
k¦
) {

629 
ngtı2_k¦_™
 
™
;

630 
	`ngtı2_k¦_™_š™
(&
™
, 
k¦
->
back
, k¦->back->
n
 - 1, k¦->
com·r
,

631 &
k¦
->
šf_key
);

632  
™
;

633 
	}
}

635 
	$ngtı2_k¦_™_š™
(
ngtı2_k¦_™
 *
™
, cÚ¡ 
ngtı2_k¦_blk
 *
blk
, 
size_t
 
i
,

636 
ngtı2_k¦_com·r
 
com·r
,

637 cÚ¡ 
ngtı2_k¦_key
 *
šf_key
) {

638 
™
->
blk
 = blk;

639 
™
->
i
 = i;

640 
™
->
com·r
 = compar;

641 
™
->
šf_key
 = *inf_key;

642 
	}
}

644 *
	$ngtı2_k¦_™_g‘
(cÚ¡ 
ngtı2_k¦_™
 *
™
) {

645  
™
->
blk
->
nodes
[™->
i
].
d©a
;

646 
	}
}

648 
	$ngtı2_k¦_™_Ãxt
(
ngtı2_k¦_™
 *
™
) {

649 ià(++
™
->
i
 =ğ™->
blk
->
n
) {

650 
™
->
blk
 = it->blk->
Ãxt
;

651 
™
->
i
 = 0;

653 
	}
}

655 
	$ngtı2_k¦_™_´ev
(
ngtı2_k¦_™
 *
™
) {

656 
	`as£¹
(!
	`ngtı2_k¦_™_begš
(
™
));

658 ià(
™
->
i
 == 0) {

659 
™
->
blk
 = it->blk->
´ev
;

660 
™
->
i
 = it->
blk
->
n
 - 1;

662 --
™
->
i
;

664 
	}
}

666 
	$ngtı2_k¦_™_’d
(cÚ¡ 
ngtı2_k¦_™
 *
™
) {

667  
	`key_equ®
(
™
->
com·r
, &™->
blk
->
nodes
[™->
i
].
key
, &™->
šf_key
);

668 
	}
}

670 
	$ngtı2_k¦_™_begš
(cÚ¡ 
ngtı2_k¦_™
 *
™
) {

671  
™
->
i
 =ğ0 && it->
blk
->
´ev
 =ğ
NULL
;

672 
	}
}

674 
ngtı2_k¦_key
 
	$ngtı2_k¦_™_key
(cÚ¡ 
ngtı2_k¦_™
 *
™
) {

675  
™
->
blk
->
nodes
[™->
i
].
key
;

676 
	}
}

678 
ngtı2_k¦_key
 *
	$ngtı2_k¦_key_i
(
ngtı2_k¦_key
 *
key
, 
št64_t
 
i
) {

679 
key
->
i
 = i;

680  
key
;

681 
	}
}

683 
ngtı2_k¦_key
 *
	$ngtı2_k¦_key_±r
(
ngtı2_k¦_key
 *
key
, cÚ¡ *
±r
) {

684 
key
->
±r
 =…tr;

685  
key
;

686 
	}
}

	@lib/ngtcp2_ksl.h

25 #iâdeà
NGTCP2_KSL_H


26 
	#NGTCP2_KSL_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<¡dlib.h
>

34 
	~<ngtı2/ngtı2.h
>

40 
	#NGTCP2_KSL_DEGR
 8

	)

43 
	#NGTCP2_KSL_MAX_NBLK
 (2 * 
NGTCP2_KSL_DEGR
 - 1)

	)

46 
	#NGTCP2_KSL_MIN_NBLK
 (
NGTCP2_KSL_DEGR
 - 1)

	)

52 
št64_t
 
	mi
;

53 cÚ¡ *
	m±r
;

54 } 
	tngtı2_k¦_key
;

56 
	gngtı2_k¦_node
;

57 
ngtı2_k¦_node
 
	tngtı2_k¦_node
;

59 
	gngtı2_k¦_blk
;

60 
ngtı2_k¦_blk
 
	tngtı2_k¦_blk
;

69 
	sngtı2_k¦_node
 {

70 
ngtı2_k¦_key
 
	mkey
;

72 
ngtı2_k¦_blk
 *
	mblk
;

73 *
	md©a
;

80 
	sngtı2_k¦_blk
 {

82 
ngtı2_k¦_blk
 *
	mÃxt
;

84 
ngtı2_k¦_blk
 *
	m´ev
;

86 
size_t
 
	mn
;

88 
	mËaf
;

89 
ngtı2_k¦_node
 
	mnodes
[
NGTCP2_KSL_MAX_NBLK
];

96 (*
	tngtı2_k¦_com·r
)(cÚ¡ 
	tngtı2_k¦_key
 *
	tlhs
,

97 cÚ¡ 
	tngtı2_k¦_key
 *
	trhs
);

99 
ngtı2_k¦_™
;

100 
ngtı2_k¦_™
 
	tngtı2_k¦_™
;

105 
	sngtı2_k¦_™
 {

106 cÚ¡ 
ngtı2_k¦_blk
 *
blk
;

107 
size_t
 
i
;

108 
ngtı2_k¦_com·r
 
com·r
;

109 
ngtı2_k¦_key
 
šf_key
;

112 
ngtı2_k¦
;

113 
ngtı2_k¦
 
	tngtı2_k¦
;

118 
	sngtı2_k¦
 {

120 
ngtı2_k¦_blk
 *
h—d
;

122 
ngtı2_k¦_blk
 *
äÚt
;

124 
ngtı2_k¦_blk
 *
back
;

125 
ngtı2_k¦_com·r
 
com·r
;

126 
ngtı2_k¦_key
 
šf_key
;

127 
size_t
 
n
;

128 
ngtı2_mem
 *
mem
;

141 
	`ngtı2_k¦_š™
(
ngtı2_k¦
 *
k¦
, 
ngtı2_k¦_com·r
 
com·r
,

142 cÚ¡ 
ngtı2_k¦_key
 *
šf_key
, 
ngtı2_mem
 *
mem
);

149 
	`ngtı2_k¦_ä“
(
ngtı2_k¦
 *
k¦
);

164 
	`ngtı2_k¦_š£¹
(
ngtı2_k¦
 *
k¦
, 
ngtı2_k¦_™
 *
™
,

165 cÚ¡ 
ngtı2_k¦_key
 *
key
, *
d©a
);

181 
	`ngtı2_k¦_»move
(
ngtı2_k¦
 *
k¦
, 
ngtı2_k¦_™
 *
™
,

182 cÚ¡ 
ngtı2_k¦_key
 *
key
);

191 
ngtı2_k¦_™
 
	`ngtı2_k¦_low”_bound
(
ngtı2_k¦
 *
k¦
,

192 cÚ¡ 
ngtı2_k¦_key
 *
key
);

199 
	`ngtı2_k¦_upd©e_key
(
ngtı2_k¦
 *
k¦
, cÚ¡ 
ngtı2_k¦_key
 *
Şd_key
,

200 cÚ¡ 
ngtı2_k¦_key
 *
Ãw_key
);

207 
ngtı2_k¦_™
 
	`ngtı2_k¦_begš
(cÚ¡ 
ngtı2_k¦
 *
k¦
);

215 
ngtı2_k¦_™
 
	`ngtı2_k¦_’d
(cÚ¡ 
ngtı2_k¦
 *
k¦
);

220 
size_t
 
	`ngtı2_k¦_Ën
(
ngtı2_k¦
 *
k¦
);

225 
	`ngtı2_k¦_ş—r
(
ngtı2_k¦
 *
k¦
);

231 
	`ngtı2_k¦_´št
(
ngtı2_k¦
 *
k¦
);

236 
	`ngtı2_k¦_™_š™
(
ngtı2_k¦_™
 *
™
, cÚ¡ 
ngtı2_k¦_blk
 *
blk
, 
size_t
 
i
,

237 
ngtı2_k¦_com·r
 
com·r
,

238 cÚ¡ 
ngtı2_k¦_key
 *
šf_key
);

245 *
	`ngtı2_k¦_™_g‘
(cÚ¡ 
ngtı2_k¦_™
 *
™
);

252 
	`ngtı2_k¦_™_Ãxt
(
ngtı2_k¦_™
 *
™
);

259 
	`ngtı2_k¦_™_´ev
(
ngtı2_k¦_™
 *
™
);

265 
	`ngtı2_k¦_™_’d
(cÚ¡ 
ngtı2_k¦_™
 *
™
);

272 
	`ngtı2_k¦_™_begš
(cÚ¡ 
ngtı2_k¦_™
 *
™
);

279 
ngtı2_k¦_key
 
	`ngtı2_k¦_™_key
(cÚ¡ 
ngtı2_k¦_™
 *
™
);

285 
ngtı2_k¦_key
 *
	`ngtı2_k¦_key_i
Ògtı2_k¦_key *
key
, 
št64_t
 
i
);

291 
ngtı2_k¦_key
 *
	`ngtı2_k¦_key_±r
Ògtı2_k¦_key *
key
, cÚ¡ *
±r
);

	@lib/ngtcp2_log.c

25 
	~"ngtı2_log.h
"

27 
	~<¡dio.h
>

28 
	~<uni¡d.h
>

29 
	~<as£¹.h
>

30 
	~<”ºo.h
>

32 
	~"ngtı2_¡r.h
"

33 
	~"ngtı2_vec.h
"

35 
	$ngtı2_log_š™
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_cid
 *
scid
,

36 
ngtı2_´štf
 
log_´štf
, 
ngtı2_t¡amp
 
ts
,

37 *
u£r_d©a
) {

38 ià(
scid
) {

39 
	`ngtı2_’code_hex
(
log
->
scid
, scid->
d©a
, scid->
d©®’
);

41 
log
->
scid
[0] = '\0';

43 
log
->
log_´štf
 =†og_printf;

44 
log
->
ts
 =†og->
Ï¡_ts
 =s;

45 
log
->
u£r_d©a
 = user_data;

46 
	}
}

90 
	#NGTCP2_LOG_BUFLEN
 4096

	)

93 
	#NGTCP2_LOG_HD
 "I%08" 
PRIu64
 " 0x% %s"

	)

94 
	#NGTCP2_LOG_PKT
 
NGTCP2_LOG_HD
 " % %" 
PRIu64
 " %s(0x%02x)"

	)

95 
	#NGTCP2_LOG_TP
 
NGTCP2_LOG_HD
 "„emÙŒª¥Üt_·¿m‘”s"

	)

97 
	#NGTCP2_LOG_FRM_HD_FIELDS
(
DIR
) \

98 
	`time¡amp_ÿ¡
(
log
->
Ï¡_ts
 -†og->
ts
), (cÚ¡ *îog->
scid
, "frm", \

99 (
DIR
), 
hd
->
pkt_num
, 
	`¡½k‰y³
(hd), hd->
ty³


	)

101 
	#NGTCP2_LOG_PKT_HD_FIELDS
(
DIR
) \

102 
	`time¡amp_ÿ¡
(
log
->
Ï¡_ts
 -†og->
ts
), (cÚ¡ *îog->
scid
, "pkt", \

103 (
DIR
), 
hd
->
pkt_num
, 
	`¡½k‰y³
(hd), hd->
ty³


	)

105 
	#NGTCP2_LOG_TP_HD_FIELDS
 \

106 
	`time¡amp_ÿ¡
(
log
->
Ï¡_ts
 -†og->
ts
), (cÚ¡ *îog->
scid
, "üy"

	)

108 cÚ¡ *
	$¡»¼Ücode
(
ušt16_t
 
”rÜ_code
) {

109 
”rÜ_code
) {

110 
NGTCP2_NO_ERROR
:

112 
NGTCP2_INTERNAL_ERROR
:

114 
NGTCP2_SERVER_BUSY
:

116 
NGTCP2_FLOW_CONTROL_ERROR
:

118 
NGTCP2_STREAM_LIMIT_ERROR
:

120 
NGTCP2_STREAM_STATE_ERROR
:

122 
NGTCP2_FINAL_OFFSET_ERROR
:

124 
NGTCP2_FRAME_ENCODING_ERROR
:

126 
NGTCP2_TRANSPORT_PARAMETER_ERROR
:

128 
NGTCP2_VERSION_NEGOTIATION_ERROR
:

130 
NGTCP2_PROTOCOL_VIOLATION
:

132 
NGTCP2_INVALID_MIGRATION
:

135 ià(0x100u <ğ
”rÜ_code
 &&ƒrror_code <= 0x1ffu) {

140 
	}
}

142 cÚ¡ *
	$¡¿µ”rÜcode
(
ušt16_t
 
­p_”rÜ_code
) {

143 ()
­p_”rÜ_code
;

145 
	}
}

147 cÚ¡ *
	$¡½k‰y³_lÚg
(
ušt8_t
 
ty³
) {

148 
ty³
) {

149 
NGTCP2_PKT_VERSION_NEGOTIATION
:

151 
NGTCP2_PKT_INITIAL
:

153 
NGTCP2_PKT_RETRY
:

155 
NGTCP2_PKT_HANDSHAKE
:

157 
NGTCP2_PKT_0RTT_PROTECTED
:

162 
	}
}

164 cÚ¡ *
	$¡½k‰y³
(cÚ¡ 
ngtı2_pkt_hd
 *
hd
) {

165 ià(
hd
->
æags
 & 
NGTCP2_PKT_FLAG_LONG_FORM
) {

166  
	`¡½k‰y³_lÚg
(
hd
->
ty³
);

169 
	}
}

171 cÚ¡ *
	$¡»v’t
(
ngtı2_log_ev’t
 
ev
) {

172 
ev
) {

173 
NGTCP2_LOG_EVENT_CON
:

175 
NGTCP2_LOG_EVENT_PKT
:

177 
NGTCP2_LOG_EVENT_FRM
:

179 
NGTCP2_LOG_EVENT_RCV
:

181 
NGTCP2_LOG_EVENT_CRY
:

183 
NGTCP2_LOG_EVENT_PTV
:

185 
NGTCP2_LOG_EVENT_NONE
:

189 
	}
}

191 
ušt64_t
 
	$time¡amp_ÿ¡
(
ušt64_t
 
ns
è{ ‚ / 
NGTCP2_MILLISECONDS
; 
	}
}

193 
	$log_ä_¡»am
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

194 cÚ¡ 
ngtı2_¡»am
 *
ä
, cÚ¡ *
dœ
) {

195 
log
->
	`log_´štf
(

196 
log
->
u£r_d©a
,

197 (
NGTCP2_LOG_PKT
 " STREAM(0x%02xèid=0x%" 
PRIx64
 " fš=%d off£t=%" 
PRIu64


198 "†’=%" 
PRIu64
 " uni=%d\n"),

199 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
 | fr->
æags
, fr->
¡»am_id
,

200 
ä
->
fš
, fr->
off£t
, 
	`ngtı2_vec_Ën
(ä->
d©a
, fr->
d©aút
),

201 (
ä
->
¡»am_id
 & 0x2) != 0);

202 
	}
}

204 
	$log_ä_ack
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

205 cÚ¡ 
ngtı2_ack
 *
ä
, cÚ¡ *
dœ
) {

206 
ušt64_t
 
Ïrge¡_ack
, 
mš_ack
;

207 
size_t
 
i
;

209 
log
->
	`log_´štf
Öog->
u£r_d©a
,

210 (
NGTCP2_LOG_PKT
 " ACK(0x%02xèÏrge¡_ack=%" 
PRIu64


211 "‡ck_d–ay=%" 
PRIu64
 "(%" PRIu64

213 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
, fr->
Ïrge¡_ack
,

214 
ä
->
ack_d–ay_unsÿËd
 / 
NGTCP2_MILLISECONDS
, fr->
ack_d–ay
,

215 
ä
->
num_blks
);

217 
Ïrge¡_ack
 = 
ä
->largest_ack;

218 
mš_ack
 = 
ä
->
Ïrge¡_ack
 - fr->
fœ¡_ack_blkËn
;

220 
log
->
	`log_´štf
Öog->
u£r_d©a
,

221 (
NGTCP2_LOG_PKT
 " ACK(0x%02xèblock=[%" 
PRIu64
 "..%" PRIu64

222 "] block_couÁ=%" 
PRIu64
 "\n"),

223 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
, 
Ïrge¡_ack
, 
mš_ack
,

224 
ä
->
fœ¡_ack_blkËn
);

226 
i
 = 0; i < 
ä
->
num_blks
; ++i) {

227 cÚ¡ 
ngtı2_ack_blk
 *
blk
 = &
ä
->
blks
[
i
];

228 
Ïrge¡_ack
 = 
mš_ack
 - 
blk
->
g­
 - 2;

229 
mš_ack
 = 
Ïrge¡_ack
 - 
blk
->
blkËn
;

230 
log
->
	`log_´štf
Öog->
u£r_d©a
,

231 (
NGTCP2_LOG_PKT
 " ACK(0x%02xèblock=[%" 
PRIu64
 "..%" PRIu64

232 "] g­=%" 
PRIu64
 " block_count=%" PRIu64

234 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
, 
Ïrge¡_ack
,

235 
mš_ack
, 
blk
->
g­
, blk->
blkËn
);

237 
	}
}

239 
	$log_ä_·ddšg
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

240 cÚ¡ 
ngtı2_·ddšg
 *
ä
, cÚ¡ *
dœ
) {

241 
log
->
	`log_´štf
Öog->
u£r_d©a
,

242 (
NGTCP2_LOG_PKT
 " PADDING(0x%02xèËn=%" 
PRIu64
 "\n"),

243 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
, fr->
Ën
);

244 
	}
}

246 
	$log_ä_»£t_¡»am
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

247 cÚ¡ 
ngtı2_»£t_¡»am
 *
ä
,

248 cÚ¡ *
dœ
) {

249 
log
->
	`log_´štf
Öog->
u£r_d©a
,

250 (
NGTCP2_LOG_PKT


251 " RESET_STREAM(0x%02xèid=0x%" 
PRIu64


252 "‡µ_”rÜ_code=%s(0x%04xèfš®_off£t=%" 
PRIu64
 "\n"),

253 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
, fr->
¡»am_id
,

254 
	`¡¿µ”rÜcode
(
ä
->
­p_”rÜ_code
), fr->app_error_code,

255 
ä
->
fš®_off£t
);

256 
	}
}

258 
	$log_ä_cÚÃùiÚ_şo£
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

259 cÚ¡ 
ngtı2_cÚÃùiÚ_şo£
 *
ä
,

260 cÚ¡ *
dœ
) {

261 
log
->
	`log_´štf
Öog->
u£r_d©a
,

262 (
NGTCP2_LOG_PKT


264 "äame_ty³=%u„—sÚ_Ën=%" 
PRIu64
 "\n"),

265 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
,

266 
ä
->
ty³
 =ğ
NGTCP2_FRAME_CONNECTION_CLOSE


267 ? 
	`¡»¼Ücode
(
ä
->
”rÜ_code
)

268 : 
	`¡¿µ”rÜcode
(
ä
->
”rÜ_code
),

269 
ä
->
”rÜ_code
, fr->
äame_ty³
, fr->
»asÚËn
);

270 
	}
}

272 
	$log_ä_max_d©a
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

273 cÚ¡ 
ngtı2_max_d©a
 *
ä
, cÚ¡ *
dœ
) {

274 
log
->
	`log_´štf
Öog->
u£r_d©a
,

275 (
NGTCP2_LOG_PKT
 " MAX_DATA(0x%02xèmax_d©a=%" 
PRIu64
 "\n"),

276 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
, fr->
max_d©a
);

277 
	}
}

279 
	$log_ä_max_¡»am_d©a
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

280 cÚ¡ 
ngtı2_max_¡»am_d©a
 *
ä
,

281 cÚ¡ *
dœ
) {

282 
log
->
	`log_´štf
Öog->
u£r_d©a
,

283 (
NGTCP2_LOG_PKT
 " MAX_STREAM_DATA(0x%02xèid=0x%" 
PRIx64


284 " max_¡»am_d©a=%" 
PRIu64
 "\n"),

285 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
, fr->
¡»am_id
,

286 
ä
->
max_¡»am_d©a
);

287 
	}
}

289 
	$log_ä_max_¡»ams
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

290 cÚ¡ 
ngtı2_max_¡»ams
 *
ä
, cÚ¡ *
dœ
) {

291 
log
->
	`log_´štf
(

292 
log
->
u£r_d©a
,

293 (
NGTCP2_LOG_PKT
 " MAX_STREAMS(0x%02xèmax_¡»ams=%" 
PRIu64
 "\n"),

294 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
, fr->
max_¡»ams
);

295 
	}
}

297 
	$log_ä_pšg
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

298 cÚ¡ 
ngtı2_pšg
 *
ä
, cÚ¡ *
dœ
) {

299 
log
->
	`log_´štf
Öog->
u£r_d©a
, (
NGTCP2_LOG_PKT
 " PING(0x%02x)\n"),

300 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
);

301 
	}
}

303 
	$log_ä_d©a_blocked
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

304 cÚ¡ 
ngtı2_d©a_blocked
 *
ä
,

305 cÚ¡ *
dœ
) {

306 
log
->
	`log_´štf
Öog->
u£r_d©a
,

307 (
NGTCP2_LOG_PKT
 " DATA_BLOCKED(0x%02xèoff£t=%" 
PRIu64
 "\n"),

308 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
, fr->
off£t
);

309 
	}
}

311 
	$log_ä_¡»am_d©a_blocked
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

312 cÚ¡ 
ngtı2_¡»am_d©a_blocked
 *
ä
,

313 cÚ¡ *
dœ
) {

314 
log
->
	`log_´štf
Öog->
u£r_d©a
,

315 (
NGTCP2_LOG_PKT
 " STREAM_DATA_BLOCKED(0x%02xèid=%" 
PRIu64


316 " off£t=%" 
PRIu64
 "\n"),

317 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
¡»am_id
, fr->
off£t
);

318 
	}
}

320 
	$log_ä_¡»ams_blocked
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

321 cÚ¡ 
ngtı2_¡»ams_blocked
 *
ä
,

322 cÚ¡ *
dœ
) {

323 
log
->
	`log_´štf
Öog->
u£r_d©a
,

324 (
NGTCP2_LOG_PKT
 " STREAMS_BLOCKED(0x%02xèid=0x%" 
PRIx64


325 " sŒ—m_lim™=%" 
PRIu64
 "\n"),

326 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
, fr->
¡»am_lim™
);

327 
	}
}

329 
	$log_ä_Ãw_cÚÃùiÚ_id
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

330 cÚ¡ 
ngtı2_Ãw_cÚÃùiÚ_id
 *
ä
,

331 cÚ¡ *
dœ
) {

332 
ušt8_t
 
buf
[(
ä
->
¡©–ess_»£t_tok’
) * 2 + 1];

333 
ušt8_t
 
cid
[(
ä
->cid.
d©a
) * 2 + 1];

335 
log
->
	`log_´štf
(

336 
log
->
u£r_d©a
,

337 (
NGTCP2_LOG_PKT
 " NEW_CONNECTION_ID(0x%02xè£q=%" 
PRIu64
 " cid=0x%s "

339 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
, fr->
£q
,

340 (cÚ¡ *)
	`ngtı2_’code_hex
(
cid
, 
ä
->cid.
d©a
, fr->cid.
d©®’
),

341 (cÚ¡ *)
	`ngtı2_’code_hex
(
buf
, 
ä
->
¡©–ess_»£t_tok’
,

342 (
ä
->
¡©–ess_»£t_tok’
)));

343 
	}
}

345 
	$log_ä_¡İ_£ndšg
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

346 cÚ¡ 
ngtı2_¡İ_£ndšg
 *
ä
,

347 cÚ¡ *
dœ
) {

348 
log
->
	`log_´štf
Öog->
u£r_d©a
,

349 (
NGTCP2_LOG_PKT
 " STOP_SENDING(0x%02xèid=0x%" 
PRIx64


351 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
, fr->
¡»am_id
,

352 
	`¡¿µ”rÜcode
(
ä
->
­p_”rÜ_code
), fr->app_error_code);

353 
	}
}

355 
	$log_ä_·th_ch®Ënge
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

356 cÚ¡ 
ngtı2_·th_ch®Ënge
 *
ä
,

357 cÚ¡ *
dœ
) {

358 
ušt8_t
 
buf
[(
ä
->
d©a
) * 2 + 1];

360 
log
->
	`log_´štf
(

361 
log
->
u£r_d©a
, (
NGTCP2_LOG_PKT
 " PATH_CHALLENGE(0x%02x) data=0x%s\n"),

362 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
,

363 (cÚ¡ *)
	`ngtı2_’code_hex
(
buf
, 
ä
->
d©a
, (fr->data)));

364 
	}
}

366 
	$log_ä_·th_»¥Ú£
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

367 cÚ¡ 
ngtı2_·th_»¥Ú£
 *
ä
,

368 cÚ¡ *
dœ
) {

369 
ušt8_t
 
buf
[(
ä
->
d©a
) * 2 + 1];

371 
log
->
	`log_´štf
(

372 
log
->
u£r_d©a
, (
NGTCP2_LOG_PKT
 " PATH_RESPONSE(0x%02x) data=0x%s\n"),

373 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
,

374 (cÚ¡ *)
	`ngtı2_’code_hex
(
buf
, 
ä
->
d©a
, (fr->data)));

375 
	}
}

377 
	$log_ä_üy±o
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

378 cÚ¡ 
ngtı2_üy±o
 *
ä
, cÚ¡ *
dœ
) {

379 
size_t
 
d©®’
 = 0;

380 
size_t
 
i
;

382 
i
 = 0; i < 
ä
->
d©aút
; ++i) {

383 
d©®’
 +ğ
ä
->
d©a
[
i
].
Ën
;

386 
log
->
	`log_´štf
(

387 
log
->
u£r_d©a
,

388 (
NGTCP2_LOG_PKT
 " CRYPTO(0x%02xèoff£t=%" 
PRIu64
 "†en=%" PRIu64 "\n"),

389 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
, fr->
off£t
, 
d©®’
);

390 
	}
}

392 
	$log_ä_Ãw_tok’
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

393 cÚ¡ 
ngtı2_Ãw_tok’
 *
ä
, cÚ¡ *
dœ
) {

396 
ušt8_t
 
buf
[128 + 1 + 1];

397 
ušt8_t
 *
p
;

399 ià(
ä
->
tok’Ën
 > 64) {

400 
p
 = 
	`ngtı2_’code_hex
(
buf
, 
ä
->
tok’
, 64);

401 
p
[128] = '*';

402 
p
[129] = '\0';

404 
p
 = 
	`ngtı2_’code_hex
(
buf
, 
ä
->
tok’
, fr->
tok’Ën
);

406 
log
->
	`log_´štf
(

407 
log
->
u£r_d©a
,

408 (
NGTCP2_LOG_PKT
 " NEW_TOKEN(0x%02x)oken=0x%soken_len=%zu\n"),

409 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
, (cÚ¡ *)
p
, fr->
tok’Ën
);

410 
	}
}

412 
	$log_ä_»tœe_cÚÃùiÚ_id
(
ngtı2_log
 *
log
,

413 cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

414 cÚ¡ 
ngtı2_»tœe_cÚÃùiÚ_id
 *
ä
,

415 cÚ¡ *
dœ
) {

416 
log
->
	`log_´štf
(

417 
log
->
u£r_d©a
,

418 (
NGTCP2_LOG_PKT
 " RETIRE_CONNECTION_ID(0x%02xè£q=%" 
PRIu64
 "\n"),

419 
	`NGTCP2_LOG_FRM_HD_FIELDS
(
dœ
), 
ä
->
ty³
, fr->
£q
);

420 
	}
}

422 
	$log_ä
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

423 cÚ¡ 
ngtı2_äame
 *
ä
, cÚ¡ *
dœ
) {

424 
ä
->
ty³
) {

425 
NGTCP2_FRAME_STREAM
:

426 
	`log_ä_¡»am
(
log
, 
hd
, &
ä
->
¡»am
, 
dœ
);

428 
NGTCP2_FRAME_ACK
:

429 
NGTCP2_FRAME_ACK_ECN
:

430 
	`log_ä_ack
(
log
, 
hd
, &
ä
->
ack
, 
dœ
);

432 
NGTCP2_FRAME_PADDING
:

433 
	`log_ä_·ddšg
(
log
, 
hd
, &
ä
->
·ddšg
, 
dœ
);

435 
NGTCP2_FRAME_RESET_STREAM
:

436 
	`log_ä_»£t_¡»am
(
log
, 
hd
, &
ä
->
»£t_¡»am
, 
dœ
);

438 
NGTCP2_FRAME_CONNECTION_CLOSE
:

439 
NGTCP2_FRAME_CONNECTION_CLOSE_APP
:

440 
	`log_ä_cÚÃùiÚ_şo£
(
log
, 
hd
, &
ä
->
cÚÃùiÚ_şo£
, 
dœ
);

442 
NGTCP2_FRAME_MAX_DATA
:

443 
	`log_ä_max_d©a
(
log
, 
hd
, &
ä
->
max_d©a
, 
dœ
);

445 
NGTCP2_FRAME_MAX_STREAM_DATA
:

446 
	`log_ä_max_¡»am_d©a
(
log
, 
hd
, &
ä
->
max_¡»am_d©a
, 
dœ
);

448 
NGTCP2_FRAME_MAX_STREAMS_BIDI
:

449 
NGTCP2_FRAME_MAX_STREAMS_UNI
:

450 
	`log_ä_max_¡»ams
(
log
, 
hd
, &
ä
->
max_¡»ams
, 
dœ
);

452 
NGTCP2_FRAME_PING
:

453 
	`log_ä_pšg
(
log
, 
hd
, &
ä
->
pšg
, 
dœ
);

455 
NGTCP2_FRAME_DATA_BLOCKED
:

456 
	`log_ä_d©a_blocked
(
log
, 
hd
, &
ä
->
d©a_blocked
, 
dœ
);

458 
NGTCP2_FRAME_STREAM_DATA_BLOCKED
:

459 
	`log_ä_¡»am_d©a_blocked
(
log
, 
hd
, &
ä
->
¡»am_d©a_blocked
, 
dœ
);

461 
NGTCP2_FRAME_STREAMS_BLOCKED_BIDI
:

462 
NGTCP2_FRAME_STREAMS_BLOCKED_UNI
:

463 
	`log_ä_¡»ams_blocked
(
log
, 
hd
, &
ä
->
¡»ams_blocked
, 
dœ
);

465 
NGTCP2_FRAME_NEW_CONNECTION_ID
:

466 
	`log_ä_Ãw_cÚÃùiÚ_id
(
log
, 
hd
, &
ä
->
Ãw_cÚÃùiÚ_id
, 
dœ
);

468 
NGTCP2_FRAME_STOP_SENDING
:

469 
	`log_ä_¡İ_£ndšg
(
log
, 
hd
, &
ä
->
¡İ_£ndšg
, 
dœ
);

471 
NGTCP2_FRAME_PATH_CHALLENGE
:

472 
	`log_ä_·th_ch®Ënge
(
log
, 
hd
, &
ä
->
·th_ch®Ënge
, 
dœ
);

474 
NGTCP2_FRAME_PATH_RESPONSE
:

475 
	`log_ä_·th_»¥Ú£
(
log
, 
hd
, &
ä
->
·th_»¥Ú£
, 
dœ
);

477 
NGTCP2_FRAME_CRYPTO
:

478 
	`log_ä_üy±o
(
log
, 
hd
, &
ä
->
üy±o
, 
dœ
);

480 
NGTCP2_FRAME_NEW_TOKEN
:

481 
	`log_ä_Ãw_tok’
(
log
, 
hd
, &
ä
->
Ãw_tok’
, 
dœ
);

483 
NGTCP2_FRAME_RETIRE_CONNECTION_ID
:

484 
	`log_ä_»tœe_cÚÃùiÚ_id
(
log
, 
hd
, &
ä
->
»tœe_cÚÃùiÚ_id
, 
dœ
);

487 
	`as£¹
(0);

489 
	}
}

491 
	$ngtı2_log_rx_ä
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

492 cÚ¡ 
ngtı2_äame
 *
ä
) {

493 ià(!
log
->
log_´štf
) {

497 
	`log_ä
(
log
, 
hd
, 
ä
, "rx");

498 
	}
}

500 
	$ngtı2_log_tx_ä
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

501 cÚ¡ 
ngtı2_äame
 *
ä
) {

502 ià(!
log
->
log_´štf
) {

506 
	`log_ä
(
log
, 
hd
, 
ä
, "tx");

507 
	}
}

509 
	$ngtı2_log_rx_vn
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

510 cÚ¡ 
ušt32_t
 *
sv
, 
size_t
 
nsv
) {

511 
size_t
 
i
;

513 ià(!
log
->
log_´štf
) {

517 
i
 = 0; i < 
nsv
; ++i) {

518 
log
->
	`log_´štf
Öog->
u£r_d©a
, (
NGTCP2_LOG_PKT
 " v=0x%08x\n"),

519 
	`NGTCP2_LOG_PKT_HD_FIELDS
("rx"), 
sv
[
i
]);

521 
	}
}

523 
	$ngtı2_log_rx_¤
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

524 cÚ¡ 
ngtı2_pkt_¡©–ess_»£t
 *
¤
) {

525 
ušt8_t
 
buf
[(
¤
->
¡©–ess_»£t_tok’
) * 2 + 1];

527 ià(!
log
->
log_´štf
) {

531 
log
->
	`log_´štf
(

532 
log
->
u£r_d©a
, (
NGTCP2_LOG_PKT
 "oken=0x%s„andlen=%zu\n"),

533 
	`NGTCP2_LOG_PKT_HD_FIELDS
("rx"),

534 (cÚ¡ *)
	`ngtı2_’code_hex
(
buf
, 
¤
->
¡©–ess_»£t_tok’
,

535 (
¤
->
¡©–ess_»£t_tok’
)),

536 
¤
->
¿ndËn
);

537 
	}
}

539 
	$ngtı2_log_»mÙe_
(
ngtı2_log
 *
log
, 
ušt8_t
 
ex‰y³
,

540 cÚ¡ 
ngtı2_Œª¥Üt_·¿ms
 *
·¿ms
) {

541 
size_t
 
i
;

542 
ušt8_t
 
buf
[(
·¿ms
->
´eã¼ed_add»ss
.
_add»ss
) * 2 + 1];

544 ià(!
log
->
log_´štf
) {

548 
ex‰y³
) {

549 
NGTCP2_TRANSPORT_PARAMS_TYPE_CLIENT_HELLO
:

550 
log
->
	`log_´štf
Öog->
u£r_d©a
, (
NGTCP2_LOG_TP
 " initial_version=0x%08x\n"),

551 
NGTCP2_LOG_TP_HD_FIELDS
, 
·¿ms
->
v
.
ch
.
š™Ÿl_v”siÚ
);

553 
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
:

554 
log
->
	`log_´štf
Öog->
u£r_d©a
,

555 (
NGTCP2_LOG_TP
 "‚egotiated_version=0x%08x\n"),

556 
NGTCP2_LOG_TP_HD_FIELDS
, 
·¿ms
->
v
.
“
.
ÃgÙŸ‹d_v”siÚ
);

557 
i
 = 0; i < 
·¿ms
->
v
.
“
.
Ën
; ++i) {

558 
log
->
	`log_´štf
(

559 
log
->
u£r_d©a
, (
NGTCP2_LOG_TP
 " supported_version[%zu]=0x%08x\n"),

560 
NGTCP2_LOG_TP_HD_FIELDS
, 
i
, 
·¿ms
->
v
.
“
.
suµÜ‹d_v”siÚs
[i]);

563 ià(
·¿ms
->
¡©–ess_»£t_tok’_´e£Á
) {

564 
log
->
	`log_´štf
Öog->
u£r_d©a
,

565 (
NGTCP2_LOG_TP
 " stateless_reset_token=0x%s\n"),

566 
NGTCP2_LOG_TP_HD_FIELDS
,

567 (cÚ¡ *)
	`ngtı2_’code_hex
(

568 
buf
, 
·¿ms
->
¡©–ess_»£t_tok’
,

569 (
·¿ms
->
¡©–ess_»£t_tok’
)));

572 ià(
·¿ms
->
´eã¼ed_add»ss
.
_v”siÚ
 !ğ
NGTCP2_IP_VERSION_NONE
) {

573 
log
->
	`log_´štf
(

574 
log
->
u£r_d©a
, (
NGTCP2_LOG_TP
 "…referred_address.ip_version=%u\n"),

575 
NGTCP2_LOG_TP_HD_FIELDS
, 
·¿ms
->
´eã¼ed_add»ss
.
_v”siÚ
);

576 
log
->
	`log_´štf
Öog->
u£r_d©a
,

577 (
NGTCP2_LOG_TP
 "…referred_address.ip_address=0x%s\n"),

578 
NGTCP2_LOG_TP_HD_FIELDS
,

579 (cÚ¡ *)
	`ngtı2_’code_hex
(

580 
buf
, 
·¿ms
->
´eã¼ed_add»ss
.
_add»ss
,

581 
·¿ms
->
´eã¼ed_add»ss
.
_add»s¦’
));

582 
log
->
	`log_´štf
Öog->
u£r_d©a
,

583 (
NGTCP2_LOG_TP
 "…referred_address.port=%u\n"),

584 
NGTCP2_LOG_TP_HD_FIELDS
, 
·¿ms
->
´eã¼ed_add»ss
.
pÜt
);

585 
log
->
	`log_´štf
Öog->
u£r_d©a
,

586 (
NGTCP2_LOG_TP
 "…referred_address.cid=0x%s\n"),

587 
NGTCP2_LOG_TP_HD_FIELDS
,

588 (cÚ¡ *)
	`ngtı2_’code_hex
(

589 
buf
, 
·¿ms
->
´eã¼ed_add»ss
.
cid
.
d©a
,

590 
·¿ms
->
´eã¼ed_add»ss
.
cid
.
d©®’
));

591 
log
->
	`log_´štf
(

592 
log
->
u£r_d©a
,

593 (
NGTCP2_LOG_TP
 "…referred_address.stateless_reset_token=0x%s\n"),

594 
NGTCP2_LOG_TP_HD_FIELDS
,

595 (cÚ¡ *)
	`ngtı2_’code_hex
(

596 
buf
, 
·¿ms
->
´eã¼ed_add»ss
.
¡©–ess_»£t_tok’
,

597 (
·¿ms
->
´eã¼ed_add»ss
.
¡©–ess_»£t_tok’
)));

600 ià(
·¿ms
->
Üigš®_cÚÃùiÚ_id_´e£Á
) {

601 
log
->
	`log_´štf
Öog->
u£r_d©a
,

602 (
NGTCP2_LOG_TP
 " original_connection_id=0x%s\n"),

603 
NGTCP2_LOG_TP_HD_FIELDS
,

604 (cÚ¡ *)
	`ngtı2_’code_hex
(

605 
buf
, 
·¿ms
->
Üigš®_cÚÃùiÚ_id
.
d©a
,

606 
·¿ms
->
Üigš®_cÚÃùiÚ_id
.
d©®’
));

612 
log
->
	`log_´štf
Öog->
u£r_d©a
,

613 (
NGTCP2_LOG_TP
 " initial_max_stream_data_bidi_local=%u\n"),

614 
NGTCP2_LOG_TP_HD_FIELDS
,

615 
·¿ms
->
š™Ÿl_max_¡»am_d©a_bidi_loÿl
);

616 
log
->
	`log_´štf
Öog->
u£r_d©a
,

617 (
NGTCP2_LOG_TP
 " initial_max_stream_data_bidi_remote=%u\n"),

618 
NGTCP2_LOG_TP_HD_FIELDS
,

619 
·¿ms
->
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
);

620 
log
->
	`log_´štf
Öog->
u£r_d©a
,

621 (
NGTCP2_LOG_TP
 " initial_max_stream_data_uni=%u\n"),

622 
NGTCP2_LOG_TP_HD_FIELDS
, 
·¿ms
->
š™Ÿl_max_¡»am_d©a_uni
);

623 
log
->
	`log_´štf
Öog->
u£r_d©a
, (
NGTCP2_LOG_TP
 " initial_max_data=%u\n"),

624 
NGTCP2_LOG_TP_HD_FIELDS
, 
·¿ms
->
š™Ÿl_max_d©a
);

625 
log
->
	`log_´štf
Öog->
u£r_d©a
,

626 (
NGTCP2_LOG_TP
 " initial_max_bidi_streams=%u\n"),

627 
NGTCP2_LOG_TP_HD_FIELDS
, 
·¿ms
->
š™Ÿl_max_¡»ams_bidi
);

628 
log
->
	`log_´štf
Öog->
u£r_d©a
,

629 (
NGTCP2_LOG_TP
 " initial_max_uni_streams=%u\n"),

630 
NGTCP2_LOG_TP_HD_FIELDS
, 
·¿ms
->
š™Ÿl_max_¡»ams_uni
);

631 
log
->
	`log_´štf
Öog->
u£r_d©a
, (
NGTCP2_LOG_TP
 " idle_timeout=%u\n"),

632 
NGTCP2_LOG_TP_HD_FIELDS
, 
·¿ms
->
idË_timeout
);

633 
log
->
	`log_´štf
Öog->
u£r_d©a
, (
NGTCP2_LOG_TP
 " max_packet_size=%u\n"),

634 
NGTCP2_LOG_TP_HD_FIELDS
, 
·¿ms
->
max_·ck‘_size
);

635 
log
->
	`log_´štf
Öog->
u£r_d©a
, (
NGTCP2_LOG_TP
 "‡ck_delay_exponent=%u\n"),

636 
NGTCP2_LOG_TP_HD_FIELDS
, 
·¿ms
->
ack_d–ay_expÚ’t
);

637 
log
->
	`log_´štf
Öog->
u£r_d©a
, (
NGTCP2_LOG_TP
 " max_ack_delay=%u\n"),

638 
NGTCP2_LOG_TP_HD_FIELDS
, 
·¿ms
->
max_ack_d–ay
);

639 
	}
}

641 
	$ngtı2_log_pkt_lo¡
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

642 
ngtı2_t¡amp
 
£Á_ts
) {

643 ià(!
log
->
log_´štf
) {

647 
	`ngtı2_log_šfo
(
log
, 
NGTCP2_LOG_EVENT_RCV
,

648 "·ck‘†o¡y³=%s(0x%02xè%" 
PRIu64
 " sent_ts=%" PRIu64,

649 (
hd
->
æags
 & 
NGTCP2_PKT_FLAG_LONG_FORM
)

650 ? 
	`¡½k‰y³_lÚg
(
hd
->
ty³
)

652 
hd
->
ty³
, hd->
pkt_num
, 
£Á_ts
);

653 
	}
}

655 
	$log_pkt_hd
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

656 cÚ¡ *
dœ
) {

657 
ušt8_t
 
dcid
[(
hd
->dcid.
d©a
) * 2 + 1];

658 
ušt8_t
 
scid
[(
hd
->scid.
d©a
) * 2 + 1];

660 ià(!
log
->
log_´štf
) {

664 
	`ngtı2_log_šfo
(

665 
log
, 
NGTCP2_LOG_EVENT_PKT
,

666 "% pkn=%" 
PRIu64
 " dcid=0x%s scid=0x%sype=%s(0x%02x)†en=%zu k=%d",

667 
dœ
, 
hd
->
pkt_num
,

668 (cÚ¡ *)
	`ngtı2_’code_hex
(
dcid
, 
hd
->dcid.
d©a
, hd->dcid.
d©®’
),

669 (cÚ¡ *)
	`ngtı2_’code_hex
(
scid
, 
hd
->scid.
d©a
, hd->scid.
d©®’
),

670 (
hd
->
æags
 & 
NGTCP2_PKT_FLAG_LONG_FORM
è? 
	`¡½k‰y³_lÚg
(hd->
ty³
)

672 
hd
->
ty³
, hd->
Ën
, (hd->
æags
 & 
NGTCP2_PKT_FLAG_KEY_PHASE
) != 0);

673 
	}
}

675 
	$ngtı2_log_rx_pkt_hd
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
) {

676 
	`log_pkt_hd
(
log
, 
hd
, "rx");

677 
	}
}

679 
	$ngtı2_log_tx_pkt_hd
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
) {

680 
	`log_pkt_hd
(
log
, 
hd
, "tx");

681 
	}
}

683 
	$ngtı2_log_šfo
(
ngtı2_log
 *
log
, 
ngtı2_log_ev’t
 
ev
, cÚ¡ *
fmt
,

685 
va_li¡
 
­
;

686 
n
;

687 
buf
[
NGTCP2_LOG_BUFLEN
];

689 ià(!
log
->
log_´štf
) {

693 
	`va_¡¬t
(
­
, 
fmt
);

694 
n
 = 
	`v¢´štf
(
buf
, (buf), 
fmt
, 
­
);

695 
	`va_’d
(
­
);

697 ià(
n
 < 0 || (
size_t
ê >ğ(
buf
)) {

701 
log
->
	`log_´štf
Öog->
u£r_d©a
, (
NGTCP2_LOG_HD
 " %s\n"),

702 
	`time¡amp_ÿ¡
(
log
->
Ï¡_ts
 -†og->
ts
),†og->
scid
,

703 
	`¡»v’t
(
ev
), 
buf
);

704 
	}
}

706 
	$ngtı2_log_tx_ÿnûl
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
) {

707 
	`ngtı2_log_šfo
(
log
, 
NGTCP2_LOG_EVENT_PKT
,

708 "ÿnûÈtx…kˆ%" 
PRIu64
 "y³=%s(0x%02x)", 
hd
->
pkt_num
,

709 
	`¡½k‰y³
(
hd
), hd->
ty³
);

710 
	}
}

	@lib/ngtcp2_log.h

25 #iâdeà
NGTCP2_LOG_H


26 
	#NGTCP2_LOG_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

35 
	mNGTCP2_LOG_EVENT_NONE
,

37 
	mNGTCP2_LOG_EVENT_CON
,

39 
	mNGTCP2_LOG_EVENT_PKT
,

41 
	mNGTCP2_LOG_EVENT_FRM
,

43 
	mNGTCP2_LOG_EVENT_RCV
,

45 
	mNGTCP2_LOG_EVENT_CRY
,

47 
	mNGTCP2_LOG_EVENT_PTV
,

48 } 
	tngtı2_log_ev’t
;

50 
	sngtı2_log
 {

53 
ngtı2_´štf
 
	mlog_´štf
;

55 
ngtı2_t¡amp
 
	mts
;

58 
ngtı2_t¡amp
 
	mÏ¡_ts
;

61 *
	mu£r_d©a
;

63 
ušt8_t
 
	mscid
[
NGTCP2_MAX_CIDLEN
 * 2 + 1];

66 
ngtı2_log
 
	tngtı2_log
;

68 
ngtı2_log_š™
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_cid
 *
scid
,

69 
ngtı2_´štf
 
log_´štf
, 
ngtı2_t¡amp
 
ts
,

70 *
u£r_d©a
);

72 
ngtı2_log_rx_ä
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

73 cÚ¡ 
ngtı2_äame
 *
ä
);

74 
ngtı2_log_tx_ä
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

75 cÚ¡ 
ngtı2_äame
 *
ä
);

77 
ngtı2_log_šfo
(
ngtı2_log
 *
log
, 
ngtı2_log_ev’t
 
ev
, cÚ¡ *
fmt
,

80 
ngtı2_log_rx_vn
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

81 cÚ¡ 
ušt32_t
 *
sv
, 
size_t
 
nsv
);

83 
ngtı2_log_rx_¤
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

84 cÚ¡ 
ngtı2_pkt_¡©–ess_»£t
 *
¤
);

86 
ngtı2_log_»mÙe_
(
ngtı2_log
 *
log
, 
ušt8_t
 
ex‰y³
,

87 cÚ¡ 
ngtı2_Œª¥Üt_·¿ms
 *
·¿ms
);

89 
ngtı2_log_pkt_lo¡
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

90 
ngtı2_t¡amp
 
£Á_ts
);

92 
ngtı2_log_rx_pkt_hd
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
);

94 
ngtı2_log_tx_pkt_hd
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
);

96 
ngtı2_log_tx_ÿnûl
(
ngtı2_log
 *
log
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
);

	@lib/ngtcp2_macro.h

25 #iâdeà
NGTCP2_MACRO_H


26 
	#NGTCP2_MACRO_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<¡ddef.h
>

34 
	~<ngtı2/ngtı2.h
>

36 
	#ngtı2_mš
(
A
, 
B
è((Aè< (Bè? (Aè: (B))

	)

37 
	#ngtı2_max
(
A
, 
B
è((Aè> (Bè? (Aè: (B))

	)

39 
	#ngtı2_¡ruù_of
(
±r
, 
ty³
, 
memb”
) \

40 ((
ty³
 *)(*)((*)(
±r
)-
	`off£tof
Ñy³, 
memb”
)))

	)

47 
	#ngtı2_li¡_š£¹
(
T
, 
PD
) \

49 (
T
)->
Ãxt
 = *(
PD
); \

50 *(
PD
èğ(
T
); \

51 } 0)

	)

57 
	#ngtı2_li¡_»move
(
PT
) \

59 *(
PT
èğ(*(PT))->
Ãxt
; \

60 } 0)

	)

	@lib/ngtcp2_map.c

26 
	~"ngtı2_m­.h
"

28 
	~<¡ršg.h
>

30 
	~"ngtı2_cÚv.h
"

32 
	#INITIAL_TABLE_LENGTH
 256

	)

34 
	$ngtı2_m­_š™
(
ngtı2_m­
 *
m­
, 
ngtı2_mem
 *
mem
) {

35 
m­
->
mem
 = mem;

36 
m­
->
bËËn
 = 
INITIAL_TABLE_LENGTH
;

37 
m­
->
bË
 =

38 
	`ngtı2_mem_ÿÎoc
(
mem
, 
m­
->
bËËn
, (
ngtı2_m­_’Œy
 *));

39 ià(
m­
->
bË
 =ğ
NULL
) {

40  
NGTCP2_ERR_NOMEM
;

43 
m­
->
size
 = 0;

46 
	}
}

48 
	$ngtı2_m­_ä“
(
ngtı2_m­
 *
m­
è{ 
	`ngtı2_mem_ä“
(m­->
mem
, m­->
bË
); 
	}
}

50 
	$ngtı2_m­_—ch_ä“
(
ngtı2_m­
 *
m­
,

51 (*
func
)(
ngtı2_m­_’Œy
 *
’Œy
, *
±r
),

52 *
±r
) {

53 
ušt32_t
 
i
;

54 
i
 = 0; i < 
m­
->
bËËn
; ++i) {

55 
ngtı2_m­_’Œy
 *
’Œy
;

56 
’Œy
 = 
m­
->
bË
[
i
];ƒntry;) {

57 
ngtı2_m­_’Œy
 *
Ãxt
 = 
’Œy
->next;

58 
	`func
(
’Œy
, 
±r
);

59 
’Œy
 = 
Ãxt
;

61 
m­
->
bË
[
i
] = 
NULL
;

63 
	}
}

65 
	$ngtı2_m­_—ch
(
ngtı2_m­
 *
m­
,

66 (*
func
)(
ngtı2_m­_’Œy
 *
’Œy
, *
±r
),

67 *
±r
) {

68 
rv
;

69 
ušt32_t
 
i
;

70 
i
 = 0; i < 
m­
->
bËËn
; ++i) {

71 
ngtı2_m­_’Œy
 *
’Œy
, *
Ãxt
;

72 
’Œy
 = 
m­
->
bË
[
i
];ƒntry;) {

73 
Ãxt
 = 
’Œy
->next;

74 
rv
 = 
	`func
(
’Œy
, 
±r
);

75 ià(
rv
 != 0) {

76  
rv
;

78 
’Œy
 = 
Ãxt
;

82 
	}
}

84 
	$ngtı2_m­_’Œy_š™
(
ngtı2_m­_’Œy
 *
’Œy
, 
key_ty³
 
key
) {

85 
’Œy
->
key
 = key;

86 
’Œy
->
Ãxt
 = 
NULL
;

87 
	}
}

90 
ušt32_t
 
	$hash
(
key_ty³
 
key
, 
ušt32_t
 
mod
) {

91 
ušt8_t
 *
p
, *
’d
;

92 
ušt32_t
 
h
 = 0x811C9DC5u;

94 
key
 = 
	`bsw­64
(key);

95 
p
 = (
ušt8_t
 *)&
key
;

96 
’d
 = 
p
 + (
key_ty³
);

98 ; 
p
 !ğ
’d
; ++p) {

99 
h
 ^ğ*
p
;

100 
h
 *= 0x01000193u;

103  
h
 & (
mod
 - 1);

104 
	}
}

106 
	$š£¹
(
ngtı2_m­_’Œy
 **
bË
, 
ušt32_t
 
bËËn
,

107 
ngtı2_m­_’Œy
 *
’Œy
) {

108 
ušt32_t
 
h
 = 
	`hash
(
’Œy
->
key
, 
bËËn
);

109 ià(
bË
[
h
] =ğ
NULL
) {

110 
bË
[
h
] = 
’Œy
;

112 
ngtı2_m­_’Œy
 *
p
;

114 
p
 = 
bË
[
h
];…;… =…->
Ãxt
) {

115 ià(
p
->
key
 =ğ
’Œy
->key) {

116  
NGTCP2_ERR_INVALID_ARGUMENT
;

119 
’Œy
->
Ãxt
 = 
bË
[
h
];

120 
bË
[
h
] = 
’Œy
;

123 
	}
}

126 
	$»size
(
ngtı2_m­
 *
m­
, 
ušt32_t
 
Ãw_bËËn
) {

127 
ušt32_t
 
i
;

128 
ngtı2_m­_’Œy
 **
Ãw_bË
;

130 
Ãw_bË
 =

131 
	`ngtı2_mem_ÿÎoc
(
m­
->
mem
, 
Ãw_bËËn
, (
ngtı2_m­_’Œy
 *));

132 ià(
Ãw_bË
 =ğ
NULL
) {

133  
NGTCP2_ERR_NOMEM
;

136 
i
 = 0; i < 
m­
->
bËËn
; ++i) {

137 
ngtı2_m­_’Œy
 *
’Œy
;

138 
’Œy
 = 
m­
->
bË
[
i
];ƒntry;) {

139 
ngtı2_m­_’Œy
 *
Ãxt
 = 
’Œy
->next;

140 
’Œy
->
Ãxt
 = 
NULL
;

142 
	`š£¹
(
Ãw_bË
, 
Ãw_bËËn
, 
’Œy
);

143 
’Œy
 = 
Ãxt
;

146 
	`ngtı2_mem_ä“
(
m­
->
mem
, m­->
bË
);

147 
m­
->
bËËn
 = 
Ãw_bËËn
;

148 
m­
->
bË
 = 
Ãw_bË
;

151 
	}
}

153 
	$ngtı2_m­_š£¹
(
ngtı2_m­
 *
m­
, 
ngtı2_m­_’Œy
 *
Ãw_’Œy
) {

154 
rv
;

156 ià((
m­
->
size
 + 1è* 4 > m­->
bËËn
 * 3) {

157 
rv
 = 
	`»size
(
m­
, m­->
bËËn
 * 2);

158 ià(
rv
 != 0) {

159  
rv
;

162 
rv
 = 
	`š£¹
(
m­
->
bË
, m­->
bËËn
, 
Ãw_’Œy
);

163 ià(
rv
 != 0) {

164  
rv
;

166 ++
m­
->
size
;

168 
	}
}

170 
ngtı2_m­_’Œy
 *
	$ngtı2_m­_fšd
(
ngtı2_m­
 *
m­
, 
key_ty³
 
key
) {

171 
ušt32_t
 
h
;

172 
ngtı2_m­_’Œy
 *
’Œy
;

173 
h
 = 
	`hash
(
key
, 
m­
->
bËËn
);

174 
’Œy
 = 
m­
->
bË
[
h
];ƒÁry;ƒÁry =ƒÁry->
Ãxt
) {

175 ià(
’Œy
->
key
 == key) {

176  
’Œy
;

179  
NULL
;

180 
	}
}

182 
	$ngtı2_m­_»move
(
ngtı2_m­
 *
m­
, 
key_ty³
 
key
) {

183 
ušt32_t
 
h
;

184 
ngtı2_m­_’Œy
 **
d¡
;

186 
h
 = 
	`hash
(
key
, 
m­
->
bËËn
);

188 
d¡
 = &
m­
->
bË
[
h
]; *d¡; d¡ = &(*d¡)->
Ãxt
) {

189 ià((*
d¡
)->
key
 != key) {

193 *
d¡
 = (*d¡)->
Ãxt
;

194 --
m­
->
size
;

197  
NGTCP2_ERR_INVALID_ARGUMENT
;

198 
	}
}

200 
	$ngtı2_m­_ş—r
(
ngtı2_m­
 *
m­
) {

201 
ušt32_t
 
i
;

203 
i
 = 0; i < 
m­
->
bËËn
; ++i) {

204 
m­
->
bË
[
i
] = 
NULL
;

207 
m­
->
size
 = 0;

208 
	}
}

210 
size_t
 
	$ngtı2_m­_size
(
ngtı2_m­
 *
m­
è{  m­->
size
; 
	}
}

	@lib/ngtcp2_map.h

26 #iâdeà
NGTCP2_MAP_H


27 
	#NGTCP2_MAP_H


	)

29 #ifdeà
HAVE_CONFIG_H


30 
	~<cÚfig.h
>

33 
	~<ngtı2/ngtı2.h
>

35 
	~"ngtı2_mem.h
"

39 
ušt64_t
 
	tkey_ty³
;

41 
	sngtı2_m­_’Œy
 {

42 
ngtı2_m­_’Œy
 *
	mÃxt
;

43 
key_ty³
 
	mkey
;

44 } 
	tngtı2_m­_’Œy
;

47 
ngtı2_m­_’Œy
 **
	mbË
;

48 
ngtı2_mem
 *
	mmem
;

49 
size_t
 
	msize
;

50 
ušt32_t
 
	mbËËn
;

51 } 
	tngtı2_m­
;

62 
ngtı2_m­_š™
(
ngtı2_m­
 *
m­
, 
ngtı2_mem
 *
mem
);

69 
ngtı2_m­_ä“
(
ngtı2_m­
 *
m­
);

77 
ngtı2_m­_—ch_ä“
(
ngtı2_m­
 *
m­
,

78 (*
func
)(
ngtı2_m­_’Œy
 *
’Œy
, *
±r
),

79 *
±r
);

85 
	`ngtı2_m­_’Œy_š™
(
ngtı2_m­_’Œy
 *
’Œy
, 
key_ty³
 
key
);

98 
	`ngtı2_m­_š£¹
(
ngtı2_m­
 *
m­
, 
ngtı2_m­_’Œy
 *
’Œy
);

104 
ngtı2_m­_’Œy
 *
	`ngtı2_m­_fšd
(
ngtı2_m­
 *
m­
, 
key_ty³
 
key
);

116 
	`ngtı2_m­_»move
(
ngtı2_m­
 *
m­
, 
key_ty³
 
key
);

121 
	`ngtı2_m­_ş—r
(
ngtı2_m­
 *
m­
);

126 
size_t
 
	`ngtı2_m­_size
(
ngtı2_m­
 *
m­
);

142 
	`ngtı2_m­_—ch
(
ngtı2_m­
 *
m­
,

143 (*
func
)(
ngtı2_m­_’Œy
 *
’Œy
, *
±r
), *ptr);

	@lib/ngtcp2_mem.c

26 
	~"ngtı2_mem.h
"

28 *
	$deçuÉ_m®loc
(
size_t
 
size
, *
mem_u£r_d©a
) {

29 ()
mem_u£r_d©a
;

31  
	`m®loc
(
size
);

32 
	}
}

34 
	$deçuÉ_ä“
(*
±r
, *
mem_u£r_d©a
) {

35 ()
mem_u£r_d©a
;

37 
	`ä“
(
±r
);

38 
	}
}

40 *
	$deçuÉ_ÿÎoc
(
size_t
 
nmemb
, size_ˆ
size
, *
mem_u£r_d©a
) {

41 ()
mem_u£r_d©a
;

43  
	`ÿÎoc
(
nmemb
, 
size
);

44 
	}
}

46 *
	$deçuÉ_»®loc
(*
±r
, 
size_t
 
size
, *
mem_u£r_d©a
) {

47 ()
mem_u£r_d©a
;

49  
	`»®loc
(
±r
, 
size
);

50 
	}
}

52 
ngtı2_mem
 
	gmem_deçuÉ
 = {
NULL
, 
deçuÉ_m®loc
, 
deçuÉ_ä“
,

53 
deçuÉ_ÿÎoc
, 
deçuÉ_»®loc
};

55 
ngtı2_mem
 *
	$ngtı2_mem_deçuÉ
(è{  &
mem_deçuÉ
; 
	}
}

57 *
	$ngtı2_mem_m®loc
(
ngtı2_mem
 *
mem
, 
size_t
 
size
) {

58  
mem
->
	`m®loc
(
size
, mem->
mem_u£r_d©a
);

59 
	}
}

61 
	$ngtı2_mem_ä“
(
ngtı2_mem
 *
mem
, *
±r
) {

62 
mem
->
	`ä“
(
±r
, mem->
mem_u£r_d©a
);

63 
	}
}

65 
	$ngtı2_mem_ä“2
(
ngtı2_ä“
 
ä“_func
, *
±r
, *
mem_u£r_d©a
) {

66 
	`ä“_func
(
±r
, 
mem_u£r_d©a
);

67 
	}
}

69 *
	$ngtı2_mem_ÿÎoc
(
ngtı2_mem
 *
mem
, 
size_t
 
nmemb
, size_ˆ
size
) {

70  
mem
->
	`ÿÎoc
(
nmemb
, 
size
, mem->
mem_u£r_d©a
);

71 
	}
}

73 *
	$ngtı2_mem_»®loc
(
ngtı2_mem
 *
mem
, *
±r
, 
size_t
 
size
) {

74  
mem
->
	`»®loc
(
±r
, 
size
, mem->
mem_u£r_d©a
);

75 
	}
}

	@lib/ngtcp2_mem.h

26 #iâdeà
NGTCP2_MEM_H


27 
	#NGTCP2_MEM_H


	)

29 #ifdeà
HAVE_CONFIG_H


30 
	~<cÚfig.h
>

33 
	~<ngtı2/ngtı2.h
>

36 
ngtı2_mem
 *
ngtı2_mem_deçuÉ
();

40 *
ngtı2_mem_m®loc
(
ngtı2_mem
 *
mem
, 
size_t
 
size
);

41 
ngtı2_mem_ä“
(
ngtı2_mem
 *
mem
, *
±r
);

42 
ngtı2_mem_ä“2
(
ngtı2_ä“
 
ä“_func
, *
±r
, *
mem_u£r_d©a
);

43 *
ngtı2_mem_ÿÎoc
(
ngtı2_mem
 *
mem
, 
size_t
 
nmemb
, size_ˆ
size
);

44 *
ngtı2_mem_»®loc
(
ngtı2_mem
 *
mem
, *
±r
, 
size_t
 
size
);

	@lib/ngtcp2_path.c

25 
	~"ngtı2_·th.h
"

27 
	~<¡ršg.h
>

29 
	~"ngtı2_addr.h
"

31 
	$ngtı2_·th_š™
(
ngtı2_·th
 *
·th
, cÚ¡ 
ngtı2_addr
 *
loÿl
,

32 cÚ¡ 
ngtı2_addr
 *
»mÙe
) {

33 
·th
->
loÿl
 = *local;

34 
·th
->
»mÙe
 = *remote;

35 
	}
}

37 
	$ngtı2_·th_cİy
(
ngtı2_·th
 *
de¡
, cÚ¡‚gtı2_·th *
¤c
) {

38 
	`ngtı2_addr_cİy
(&
de¡
->
loÿl
, &
¤c
->local);

39 
	`ngtı2_addr_cİy
(&
de¡
->
»mÙe
, &
¤c
->remote);

40 
	}
}

42 
	$ngtı2_·th_eq
(cÚ¡ 
ngtı2_·th
 *
a
, cÚ¡‚gtı2_·th *
b
) {

43  
	`ngtı2_addr_eq
(&
a
->
loÿl
, &
b
->local) &&

44 
	`ngtı2_addr_eq
(&
a
->
»mÙe
, &
b
->remote);

45 
	}
}

47 
	$ngtı2_·th_¡Üage_š™
(
ngtı2_·th_¡Üage
 *
ps
, cÚ¡ *
loÿl_addr
,

48 
size_t
 
loÿl_add¾’
, cÚ¡ *
»mÙe_addr
,

49 
size_t
 
»mÙe_add¾’
) {

50 
	`ngtı2_addr_š™
(&
ps
->
·th
.
loÿl
,…s->
loÿl_addrbuf
, 0);

51 
	`ngtı2_addr_š™
(&
ps
->
·th
.
»mÙe
,…s->
»mÙe_addrbuf
, 0);

53 
	`ngtı2_addr_cİy_by‹
(&
ps
->
·th
.
loÿl
, 
loÿl_addr
, 
loÿl_add¾’
);

54 
	`ngtı2_addr_cİy_by‹
(&
ps
->
·th
.
»mÙe
, 
»mÙe_addr
, 
»mÙe_add¾’
);

55 
	}
}

57 
	$ngtı2_·th_¡Üage_z”o
(
ngtı2_·th_¡Üage
 *
ps
) {

58 
	`ngtı2_addr_š™
(&
ps
->
·th
.
loÿl
,…s->
loÿl_addrbuf
, 0);

59 
	`ngtı2_addr_š™
(&
ps
->
·th
.
»mÙe
,…s->
»mÙe_addrbuf
, 0);

60 
	}
}

	@lib/ngtcp2_path.h

25 #iâdeà
NGTCP2_PATH_H


26 
	#NGTCP2_PATH_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

39 
ngtı2_·th_š™
(
ngtı2_·th
 *
·th
, cÚ¡ 
ngtı2_addr
 *
loÿl
,

40 cÚ¡ 
ngtı2_addr
 *
»mÙe
);

47 
ngtı2_·th_cİy
(
ngtı2_·th
 *
de¡
, cÚ¡‚gtı2_·th *
¤c
);

54 
ngtı2_·th_eq
(cÚ¡ 
ngtı2_·th
 *
a
, cÚ¡‚gtı2_·th *
b
);

	@lib/ngtcp2_pkt.c

25 
	~"ngtı2_pkt.h
"

27 
	~<as£¹.h
>

28 
	~<¡ršg.h
>

30 
	~"ngtı2_cÚv.h
"

31 
	~"ngtı2_¡r.h
"

32 
	~"ngtı2_maüo.h
"

33 
	~"ngtı2_cid.h
"

34 
	~"ngtı2_mem.h
"

36 
	$ngtı2_pkt_chaš_Ãw
(
ngtı2_pkt_chaš
 **
µc
, cÚ¡ 
ušt8_t
 *
pkt
,

37 
size_t
 
pk’
, 
ngtı2_t¡amp
 
ts
, 
ngtı2_mem
 *
mem
) {

38 *
µc
 = 
	`ngtı2_mem_m®loc
(
mem
, (
ngtı2_pkt_chaš
è+ 
pk’
);

39 ià(*
µc
 =ğ
NULL
) {

40  
NGTCP2_ERR_NOMEM
;

43 (*
µc
)->
Ãxt
 = 
NULL
;

44 (*
µc
)->
pkt
 = (
ušt8_t
 *)(*µcè+ (
ngtı2_pkt_chaš
);

45 (*
µc
)->
pk’
 =…ktlen;

46 (*
µc
)->
ts
 =s;

48 
	`memıy
((*
µc
)->
pkt
,…kt, 
pk’
);

51 
	}
}

53 
	$ngtı2_pkt_chaš_d–
(
ngtı2_pkt_chaš
 *
pc
, 
ngtı2_mem
 *
mem
) {

54 
	`ngtı2_mem_ä“
(
mem
, 
pc
);

55 
	}
}

57 
	$ngtı2_pkt_hd_š™
(
ngtı2_pkt_hd
 *
hd
, 
ušt8_t
 
æags
, ušt8_ˆ
ty³
,

58 cÚ¡ 
ngtı2_cid
 *
dcid
, cÚ¡‚gtı2_cid *
scid
,

59 
ušt64_t
 
pkt_num
, 
size_t
 
pkt_numËn
, 
ušt32_t
 
v”siÚ
,

60 
size_t
 
Ën
) {

61 
hd
->
æags
 = flags;

62 
hd
->
ty³
 =ype;

63 ià(
dcid
) {

64 
hd
->
dcid
 = *dcid;

66 
	`ngtı2_cid_z”o
(&
hd
->
dcid
);

68 ià(
scid
) {

69 
hd
->
scid
 = *scid;

71 
	`ngtı2_cid_z”o
(&
hd
->
scid
);

73 
hd
->
pkt_num
 =…kt_num;

74 
hd
->
tok’
 = 
NULL
;

75 
hd
->
tok’Ën
 = 0;

76 
hd
->
pkt_numËn
 =…kt_numlen;

77 
hd
->
v”siÚ
 = version;

78 
hd
->
Ën
 =†en;

79 
	}
}

81 
	$has_mask
(
ušt8_t
 
b
, ušt8_ˆ
mask
è{  (b & maskè=ğmask; 
	}
}

83 
ssize_t
 
	$ngtı2_pkt_decode_hd_lÚg
(
ngtı2_pkt_hd
 *
de¡
, cÚ¡ 
ušt8_t
 *
pkt
,

84 
size_t
 
pk’
) {

85 
ušt8_t
 
ty³
;

86 
ušt32_t
 
v”siÚ
;

87 
size_t
 
dc
, 
sc
;

88 cÚ¡ 
ušt8_t
 *
p
;

89 
size_t
 
Ën
 = 0;

90 
size_t
 
n
;

91 
size_t
 
Áok’Ën
 = 0;

92 cÚ¡ 
ušt8_t
 *
tok’
 = 
NULL
;

93 
size_t
 
tok’Ën
 = 0;

95 ià(
pk’
 < 5) {

96  
NGTCP2_ERR_INVALID_ARGUMENT
;

99 ià(!(
pkt
[0] & 
NGTCP2_HEADER_FORM_BIT
)) {

100  
NGTCP2_ERR_INVALID_ARGUMENT
;

103 
v”siÚ
 = 
	`ngtı2_g‘_ušt32
(&
pkt
[1]);

105 ià(
v”siÚ
 == 0) {

106 
ty³
 = 
NGTCP2_PKT_VERSION_NEGOTIATION
;

109 
Ën
 = 5 + 1;

111 ià(!(
pkt
[0] & 
NGTCP2_FIXED_BIT_MASK
)) {

112  
NGTCP2_ERR_INVALID_ARGUMENT
;

115 
ty³
 = 
	`ngtı2_pkt_g‘_ty³_lÚg
(
pkt
[0]);

116 
ty³
) {

117 
NGTCP2_PKT_INITIAL
:

118 
Ën
 = 1 + 
NGTCP2_MIN_LONG_HEADERLEN
 -

121 
NGTCP2_PKT_RETRY
:

123 
Ën
 = 5 + 1;

125 
NGTCP2_PKT_HANDSHAKE
:

126 
NGTCP2_PKT_0RTT_PROTECTED
:

127 
Ën
 = 
NGTCP2_MIN_LONG_HEADERLEN
 - 1;

130  
NGTCP2_ERR_UNKNOWN_PKT_TYPE
;

134 ià(
pk’
 < 
Ën
) {

135  
NGTCP2_ERR_INVALID_ARGUMENT
;

138 
dc
 = 
pkt
[5] >> 4;

139 
sc
 = 
pkt
[5] & 0xf;

141 ià(
dc
) {

142 
dc
 += 3;

144 ià(
sc
) {

145 
sc
 += 3;

148 
Ën
 +ğ
dc
 + 
sc
;

150 ià(
pk’
 < 
Ën
) {

151  
NGTCP2_ERR_INVALID_ARGUMENT
;

154 
p
 = &
pkt
[6 + 
dc
 + 
sc
];

156 ià(
ty³
 =ğ
NGTCP2_PKT_INITIAL
) {

158 
Áok’Ën
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

159 
Ën
 +ğ
Áok’Ën
 - 1;

161 ià(
pk’
 < 
Ën
) {

162  
NGTCP2_ERR_INVALID_ARGUMENT
;

165 
tok’Ën
 = 
	`ngtı2_g‘_v¬št
(&
Áok’Ën
, 
p
);

166 
Ën
 +ğ
tok’Ën
;

168 ià(
pk’
 < 
Ën
) {

169  
NGTCP2_ERR_INVALID_ARGUMENT
;

172 
p
 +ğ
Áok’Ën
;

174 ià(
tok’Ën
) {

175 
tok’
 = 
p
;

178 
p
 +ğ
tok’Ën
;

181 
ty³
) {

182 
NGTCP2_PKT_VERSION_NEGOTIATION
:

183 
NGTCP2_PKT_RETRY
:

187 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

188 
Ën
 +ğ
n
 - 1;

190 ià(
pk’
 < 
Ën
) {

191  
NGTCP2_ERR_INVALID_ARGUMENT
;

195 
de¡
->
æags
 = 
NGTCP2_PKT_FLAG_LONG_FORM
;

196 
de¡
->
ty³
 =ype;

197 
de¡
->
v”siÚ
 = version;

198 
de¡
->
pkt_num
 = 0;

199 
de¡
->
pkt_numËn
 = 0;

201 
p
 = &
pkt
[6];

203 
	`ngtı2_cid_š™
(&
de¡
->
dcid
, 
p
, 
dc
);

204 
p
 +ğ
dc
;

205 
	`ngtı2_cid_š™
(&
de¡
->
scid
, 
p
, 
sc
);

206 
p
 +ğ
sc
;

208 
de¡
->
tok’
 = (
ušt8_t
 *)token;

209 
de¡
->
tok’Ën
 =okenlen;

210 
p
 +ğ
Áok’Ën
 + 
tok’Ën
;

212 
ty³
) {

213 
NGTCP2_PKT_VERSION_NEGOTIATION
:

214 
NGTCP2_PKT_RETRY
:

215 
de¡
->
Ën
 = 0;

218 
de¡
->
Ën
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

219 
p
 +ğ
n
;

222 
	`as£¹
((
size_t
)(
p
 - 
pkt
è=ğ
Ën
);

224  (
ssize_t
)
Ën
;

225 
	}
}

227 
ssize_t
 
	$ngtı2_pkt_decode_hd_shÜt
(
ngtı2_pkt_hd
 *
de¡
, cÚ¡ 
ušt8_t
 *
pkt
,

228 
size_t
 
pk’
, size_ˆ
dcidËn
) {

229 
size_t
 
Ën
 = 1 + 
dcidËn
;

230 cÚ¡ 
ušt8_t
 *
p
 = 
pkt
;

232 ià(
pk’
 < 
Ën
) {

233  
NGTCP2_ERR_INVALID_ARGUMENT
;

236 ià((
pkt
[0] & 
NGTCP2_HEADER_FORM_BIT
) ||

237 (
pkt
[0] & 
NGTCP2_FIXED_BIT_MASK
) == 0) {

238  
NGTCP2_ERR_INVALID_ARGUMENT
;

241 
p
 = &
pkt
[1];

243 
de¡
->
ty³
 = 
NGTCP2_PKT_SHORT
;

245 
	`ngtı2_cid_š™
(&
de¡
->
dcid
, 
p
, 
dcidËn
);

246 
p
 +ğ
dcidËn
;

250 
	`ngtı2_cid_z”o
(&
de¡
->
scid
);

252 
de¡
->
æags
 = 
NGTCP2_PKT_FLAG_NONE
;

253 
de¡
->
v”siÚ
 = 0;

254 
de¡
->
Ën
 = 0;

255 
de¡
->
pkt_num
 = 0;

256 
de¡
->
pkt_numËn
 = 0;

258 
	`as£¹
((
size_t
)(
p
 - 
pkt
è=ğ
Ën
);

260  (
ssize_t
)
Ën
;

261 
	}
}

263 
ssize_t
 
	$ngtı2_pkt_’code_hd_lÚg
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

264 cÚ¡ 
ngtı2_pkt_hd
 *
hd
) {

265 
ušt8_t
 *
p
;

266 
size_t
 
Ën
 = 
NGTCP2_MIN_LONG_HEADERLEN
 + 
hd
->
dcid
.
d©®’
 + hd->
scid
.datalen -

270 ià(
hd
->
ty³
 !ğ
NGTCP2_PKT_RETRY
) {

271 
Ën
 +ğ2 + 
hd
->
pkt_numËn
;

274 ià(
hd
->
ty³
 =ğ
NGTCP2_PKT_INITIAL
) {

275 
Ën
 +ğ
	`ngtı2_put_v¬št_Ën
(
hd
->
tok’Ën
) + hd->tokenlen;

278 ià(
ou’
 < 
Ën
) {

279  
NGTCP2_ERR_NOBUF
;

282 
p
 = 
out
;

284 *
p
++ = 
NGTCP2_HEADER_FORM_BIT
 | 
NGTCP2_FIXED_BIT_MASK
 |

285 (
ušt8_t
)(
hd
->
ty³
 << 4è| (ušt8_t)(hd->
pkt_numËn
 - 1);

286 
p
 = 
	`ngtı2_put_ušt32be
Õ, 
hd
->
v”siÚ
);

287 *
p
 = 0;

288 ià(
hd
->
dcid
.
d©®’
) {

289 
	`as£¹
(
hd
->
dcid
.
d©®’
 > 3);

290 *
p
 |ğ(
ušt8_t
)((
hd
->
dcid
.
d©®’
 - 3) << 4);

292 ià(
hd
->
scid
.
d©®’
) {

293 
	`as£¹
(
hd
->
scid
.
d©®’
 > 3);

294 *
p
 = (
ušt8_t
)(*°| ((
hd
->
scid
.
d©®’
 - 3) & 0xf));

296 ++
p
;

297 ià(
hd
->
dcid
.
d©®’
) {

298 
p
 = 
	`ngtı2_ıymem
Õ, 
hd
->
dcid
.
d©a
, hd->dcid.
d©®’
);

300 ià(
hd
->
scid
.
d©®’
) {

301 
p
 = 
	`ngtı2_ıymem
Õ, 
hd
->
scid
.
d©a
, hd->scid.
d©®’
);

304 ià(
hd
->
ty³
 =ğ
NGTCP2_PKT_INITIAL
) {

305 
p
 = 
	`ngtı2_put_v¬št
Õ, 
hd
->
tok’Ën
);

306 ià(
hd
->
tok’Ën
) {

307 
p
 = 
	`ngtı2_ıymem
Õ, 
hd
->
tok’
, hd->
tok’Ën
);

311 ià(
hd
->
ty³
 !ğ
NGTCP2_PKT_RETRY
) {

312 
p
 = 
	`ngtı2_put_v¬št14
Õ, (
ušt16_t
)
hd
->
Ën
);

313 
p
 = 
	`ngtı2_put_pkt_num
Õ, 
hd
->
pkt_num
, hd->
pkt_numËn
);

316 
	`as£¹
((
size_t
)(
p
 - 
out
è=ğ
Ën
);

318  (
ssize_t
)
Ën
;

319 
	}
}

321 
ssize_t
 
	$ngtı2_pkt_’code_hd_shÜt
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

322 cÚ¡ 
ngtı2_pkt_hd
 *
hd
) {

323 
ušt8_t
 *
p
;

324 
size_t
 
Ën
 = 1 + 
hd
->
dcid
.
d©®’
 + hd->
pkt_numËn
;

326 ià(
ou’
 < 
Ën
) {

327  
NGTCP2_ERR_NOBUF
;

330 
p
 = 
out
;

332 *
p
 = 
NGTCP2_FIXED_BIT_MASK
 | (
ušt8_t
)(
hd
->
pkt_numËn
 - 1);

333 ià(
hd
->
æags
 & 
NGTCP2_PKT_FLAG_KEY_PHASE
) {

334 *
p
 |ğ
NGTCP2_SHORT_KEY_PHASE_BIT
;

337 ++
p
;

339 ià(
hd
->
dcid
.
d©®’
) {

340 
p
 = 
	`ngtı2_ıymem
Õ, 
hd
->
dcid
.
d©a
, hd->dcid.
d©®’
);

343 
p
 = 
	`ngtı2_put_pkt_num
Õ, 
hd
->
pkt_num
, hd->
pkt_numËn
);

345 
	`as£¹
((
size_t
)(
p
 - 
out
è=ğ
Ën
);

347  (
ssize_t
)
Ën
;

348 
	}
}

350 
ssize_t
 
	$ngtı2_pkt_decode_äame
(
ngtı2_äame
 *
de¡
, cÚ¡ 
ušt8_t
 *
·ylßd
,

351 
size_t
 
·ylßdËn
) {

352 
ušt8_t
 
ty³
;

354 ià(
·ylßdËn
 == 0) {

358 
ty³
 = 
·ylßd
[0];

360 
ty³
) {

361 
NGTCP2_FRAME_PADDING
:

362  (
ssize_t
)
	`ngtı2_pkt_decode_·ddšg_äame
(&
de¡
->
·ddšg
, 
·ylßd
,

363 
·ylßdËn
);

364 
NGTCP2_FRAME_RESET_STREAM
:

365  
	`ngtı2_pkt_decode_»£t_¡»am_äame
(&
de¡
->
»£t_¡»am
, 
·ylßd
,

366 
·ylßdËn
);

367 
NGTCP2_FRAME_CONNECTION_CLOSE
:

368 
NGTCP2_FRAME_CONNECTION_CLOSE_APP
:

369  
	`ngtı2_pkt_decode_cÚÃùiÚ_şo£_äame
(&
de¡
->
cÚÃùiÚ_şo£
,

370 
·ylßd
, 
·ylßdËn
);

371 
NGTCP2_FRAME_MAX_DATA
:

372  
	`ngtı2_pkt_decode_max_d©a_äame
(&
de¡
->
max_d©a
, 
·ylßd
,

373 
·ylßdËn
);

374 
NGTCP2_FRAME_MAX_STREAM_DATA
:

375  
	`ngtı2_pkt_decode_max_¡»am_d©a_äame
(&
de¡
->
max_¡»am_d©a
,

376 
·ylßd
, 
·ylßdËn
);

377 
NGTCP2_FRAME_MAX_STREAMS_BIDI
:

378 
NGTCP2_FRAME_MAX_STREAMS_UNI
:

379  
	`ngtı2_pkt_decode_max_¡»ams_äame
(&
de¡
->
max_¡»ams
, 
·ylßd
,

380 
·ylßdËn
);

381 
NGTCP2_FRAME_PING
:

382  
	`ngtı2_pkt_decode_pšg_äame
(&
de¡
->
pšg
, 
·ylßd
, 
·ylßdËn
);

383 
NGTCP2_FRAME_DATA_BLOCKED
:

384  
	`ngtı2_pkt_decode_d©a_blocked_äame
(&
de¡
->
d©a_blocked
, 
·ylßd
,

385 
·ylßdËn
);

386 
NGTCP2_FRAME_STREAM_DATA_BLOCKED
:

387  
	`ngtı2_pkt_decode_¡»am_d©a_blocked_äame
(

388 &
de¡
->
¡»am_d©a_blocked
, 
·ylßd
, 
·ylßdËn
);

389 
NGTCP2_FRAME_STREAMS_BLOCKED_BIDI
:

390 
NGTCP2_FRAME_STREAMS_BLOCKED_UNI
:

391  
	`ngtı2_pkt_decode_¡»ams_blocked_äame
(&
de¡
->
¡»ams_blocked
,

392 
·ylßd
, 
·ylßdËn
);

393 
NGTCP2_FRAME_NEW_CONNECTION_ID
:

394  
	`ngtı2_pkt_decode_Ãw_cÚÃùiÚ_id_äame
(&
de¡
->
Ãw_cÚÃùiÚ_id
,

395 
·ylßd
, 
·ylßdËn
);

396 
NGTCP2_FRAME_STOP_SENDING
:

397  
	`ngtı2_pkt_decode_¡İ_£ndšg_äame
(&
de¡
->
¡İ_£ndšg
, 
·ylßd
,

398 
·ylßdËn
);

399 
NGTCP2_FRAME_ACK
:

400  
	`ngtı2_pkt_decode_ack_äame
(&
de¡
->
ack
, 
·ylßd
, 
·ylßdËn
);

401 
NGTCP2_FRAME_PATH_CHALLENGE
:

402  
	`ngtı2_pkt_decode_·th_ch®Ënge_äame
(&
de¡
->
·th_ch®Ënge
,

403 
·ylßd
, 
·ylßdËn
);

404 
NGTCP2_FRAME_PATH_RESPONSE
:

405  
	`ngtı2_pkt_decode_·th_»¥Ú£_äame
(&
de¡
->
·th_»¥Ú£
, 
·ylßd
,

406 
·ylßdËn
);

407 
NGTCP2_FRAME_CRYPTO
:

408  
	`ngtı2_pkt_decode_üy±o_äame
(&
de¡
->
üy±o
, 
·ylßd
, 
·ylßdËn
);

409 
NGTCP2_FRAME_NEW_TOKEN
:

410  
	`ngtı2_pkt_decode_Ãw_tok’_äame
(&
de¡
->
Ãw_tok’
, 
·ylßd
,

411 
·ylßdËn
);

412 
NGTCP2_FRAME_RETIRE_CONNECTION_ID
:

413  
	`ngtı2_pkt_decode_»tœe_cÚÃùiÚ_id_äame
(

414 &
de¡
->
»tœe_cÚÃùiÚ_id
, 
·ylßd
, 
·ylßdËn
);

416 ià(
	`has_mask
(
ty³
, 
NGTCP2_FRAME_STREAM
)) {

417  
	`ngtı2_pkt_decode_¡»am_äame
(&
de¡
->
¡»am
, 
·ylßd
, 
·ylßdËn
);

419  
NGTCP2_ERR_FRAME_ENCODING
;

421 
	}
}

423 
ssize_t
 
	$ngtı2_pkt_decode_¡»am_äame
(
ngtı2_¡»am
 *
de¡
,

424 cÚ¡ 
ušt8_t
 *
·ylßd
,

425 
size_t
 
·ylßdËn
) {

426 
ušt8_t
 
ty³
;

427 
size_t
 
Ën
 = 1 + 1;

428 cÚ¡ 
ušt8_t
 *
p
;

429 
size_t
 
d©®’
;

430 
size_t
 
nd©®’
 = 0;

431 
size_t
 
n
;

433 ià(
·ylßdËn
 < 
Ën
) {

434  
NGTCP2_ERR_FRAME_ENCODING
;

437 
ty³
 = 
·ylßd
[0];

439 
p
 = 
·ylßd
 + 1;

441 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

442 
Ën
 +ğ
n
 - 1;

444 ià(
·ylßdËn
 < 
Ën
) {

445  
NGTCP2_ERR_FRAME_ENCODING
;

448 
p
 +ğ
n
;

450 ià(
ty³
 & 
NGTCP2_STREAM_OFF_BIT
) {

451 ++
Ën
;

452 ià(
·ylßdËn
 < 
Ën
) {

453  
NGTCP2_ERR_FRAME_ENCODING
;

456 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

457 
Ën
 +ğ
n
 - 1;

459 ià(
·ylßdËn
 < 
Ën
) {

460  
NGTCP2_ERR_FRAME_ENCODING
;

463 
p
 +ğ
n
;

466 ià(
ty³
 & 
NGTCP2_STREAM_LEN_BIT
) {

467 ++
Ën
;

468 ià(
·ylßdËn
 < 
Ën
) {

469  
NGTCP2_ERR_FRAME_ENCODING
;

472 
nd©®’
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

473 
Ën
 +ğ
nd©®’
 - 1;

475 ià(
·ylßdËn
 < 
Ën
) {

476  
NGTCP2_ERR_FRAME_ENCODING
;

479 
d©®’
 = 
	`ngtı2_g‘_v¬št
(&
nd©®’
, 
p
);

480 
Ën
 +ğ
d©®’
;

482 ià(
·ylßdËn
 < 
Ën
) {

483  
NGTCP2_ERR_FRAME_ENCODING
;

486 
Ën
 = 
·ylßdËn
;

489 
p
 = 
·ylßd
 + 1;

491 
de¡
->
ty³
 = 
NGTCP2_FRAME_STREAM
;

492 
de¡
->
æags
 = (
ušt8_t
)(
ty³
 & ~
NGTCP2_FRAME_STREAM
);

493 
de¡
->
fš
 = (
ty³
 & 
NGTCP2_STREAM_FIN_BIT
) != 0;

494 
de¡
->
¡»am_id
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

495 
p
 +ğ
n
;

497 ià(
ty³
 & 
NGTCP2_STREAM_OFF_BIT
) {

498 
de¡
->
off£t
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

499 
p
 +ğ
n
;

501 
de¡
->
off£t
 = 0;

504 ià(
ty³
 & 
NGTCP2_STREAM_LEN_BIT
) {

505 
p
 +ğ
nd©®’
;

507 
d©®’
 = 
·ylßdËn
 - (
size_t
)(
p
 - 
·ylßd
);

510 ià(
d©®’
) {

511 
de¡
->
d©a
[0].
Ën
 = 
d©®’
;

512 
de¡
->
d©a
[0].
ba£
 = (
ušt8_t
 *)
p
;

513 
de¡
->
d©aút
 = 1;

514 
p
 +ğ
d©®’
;

516 
de¡
->
d©aút
 = 0;

519 
	`as£¹
((
size_t
)(
p
 - 
·ylßd
è=ğ
Ën
);

521  (
ssize_t
)
Ën
;

522 
	}
}

524 
ssize_t
 
	$ngtı2_pkt_decode_ack_äame
(
ngtı2_ack
 *
de¡
, cÚ¡ 
ušt8_t
 *
·ylßd
,

525 
size_t
 
·ylßdËn
) {

526 
size_t
 
num_blks
, 
max_num_blks
;

527 
size_t
 
Âum_blks
;

528 
size_t
 
Ën
 = 1 + 1 + 1 + 1 + 1;

529 cÚ¡ 
ušt8_t
 *
p
;

530 
size_t
 
i
, 
j
;

531 
ngtı2_ack_blk
 *
blk
;

532 
size_t
 
n
;

533 
ušt8_t
 
ty³
;

535 ià(
·ylßdËn
 < 
Ën
) {

536  
NGTCP2_ERR_FRAME_ENCODING
;

539 
ty³
 = 
·ylßd
[0];

541 
p
 = 
·ylßd
 + 1;

544 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

545 
Ën
 +ğ
n
 - 1;

547 ià(
·ylßdËn
 < 
Ën
) {

548  
NGTCP2_ERR_FRAME_ENCODING
;

551 
p
 +ğ
n
;

554 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

555 
Ën
 +ğ
n
 - 1;

557 ià(
·ylßdËn
 < 
Ën
) {

558  
NGTCP2_ERR_FRAME_ENCODING
;

561 
p
 +ğ
n
;

564 
Âum_blks
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

565 
Ën
 +ğ
Âum_blks
 - 1;

567 ià(
·ylßdËn
 < 
Ën
) {

568  
NGTCP2_ERR_FRAME_ENCODING
;

571 
num_blks
 = 
	`ngtı2_g‘_v¬št
(&
Âum_blks
, 
p
);

572 
Ën
 +ğ
num_blks
 * (1 + 1);

574 ià(
·ylßdËn
 < 
Ën
) {

575  
NGTCP2_ERR_FRAME_ENCODING
;

578 
p
 +ğ
Âum_blks
;

581 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

582 
Ën
 +ğ
n
 - 1;

584 ià(
·ylßdËn
 < 
Ën
) {

585  
NGTCP2_ERR_FRAME_ENCODING
;

588 
p
 +ğ
n
;

590 
i
 = 0; i < 
num_blks
; ++i) {

592 
j
 = 0; j < 2; ++j) {

593 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

594 
Ën
 +ğ
n
 - 1;

596 ià(
·ylßdËn
 < 
Ën
) {

597  
NGTCP2_ERR_FRAME_ENCODING
;

600 
p
 +ğ
n
;

604 ià(
ty³
 =ğ
NGTCP2_FRAME_ACK_ECN
) {

605 
Ën
 += 3;

606 ià(
·ylßdËn
 < 
Ën
) {

607  
NGTCP2_ERR_FRAME_ENCODING
;

610 
i
 = 0; i < 3; ++i) {

611 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

612 
Ën
 +ğ
n
 - 1;

614 ià(
·ylßdËn
 < 
Ën
) {

615  
NGTCP2_ERR_FRAME_ENCODING
;

618 
p
 +ğ
n
;

623 
max_num_blks
 = 
	`ngtı2_mš
(
NGTCP2_MAX_ACK_BLKS
, 
num_blks
);

625 
p
 = 
·ylßd
 + 1;

627 
de¡
->
ty³
 =ype;

628 
de¡
->
Ïrge¡_ack
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

629 
p
 +ğ
n
;

630 
de¡
->
ack_d–ay
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

632 
de¡
->
ack_d–ay_unsÿËd
 = 0;

633 
p
 +ğ
n
;

634 
de¡
->
num_blks
 = 
max_num_blks
;

635 
p
 +ğ
Âum_blks
;

636 
de¡
->
fœ¡_ack_blkËn
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

637 
p
 +ğ
n
;

639 
i
 = 0; i < 
max_num_blks
; ++i) {

640 
blk
 = &
de¡
->
blks
[
i
];

641 
blk
->
g­
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

642 
p
 +ğ
n
;

643 
blk
->
blkËn
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

644 
p
 +ğ
n
;

646 
i
 = 
max_num_blks
; i < 
num_blks
; ++i) {

647 
p
 +ğ
	`ngtı2_g‘_v¬št_Ën
(p);

648 
p
 +ğ
	`ngtı2_g‘_v¬št_Ën
(p);

651 ià(
ty³
 =ğ
NGTCP2_FRAME_ACK_ECN
) {

653 
i
 = 0; i < 3; ++i) {

654 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

655 
p
 +ğ
n
;

659 
	`as£¹
((
size_t
)(
p
 - 
·ylßd
è=ğ
Ën
);

661  (
ssize_t
)
Ën
;

662 
	}
}

664 
size_t
 
	$ngtı2_pkt_decode_·ddšg_äame
(
ngtı2_·ddšg
 *
de¡
,

665 cÚ¡ 
ušt8_t
 *
·ylßd
,

666 
size_t
 
·ylßdËn
) {

667 cÚ¡ 
ušt8_t
 *
p
, *
•
;

669 
	`as£¹
(
·ylßdËn
 > 0);

671 
p
 = 
·ylßd
 + 1;

672 
•
 = 
·ylßd
 + 
·ylßdËn
;

674 ; 
p
 !ğ
•
 && *°=ğ
NGTCP2_FRAME_PADDING
; ++p)

677 
de¡
->
ty³
 = 
NGTCP2_FRAME_PADDING
;

678 
de¡
->
Ën
 = (
size_t
)(
p
 - 
·ylßd
);

680  (
size_t
)(
p
 - 
·ylßd
);

681 
	}
}

683 
ssize_t
 
	$ngtı2_pkt_decode_»£t_¡»am_äame
(
ngtı2_»£t_¡»am
 *
de¡
,

684 cÚ¡ 
ušt8_t
 *
·ylßd
,

685 
size_t
 
·ylßdËn
) {

686 
size_t
 
Ën
 = 1 + 1 + 2 + 1;

687 cÚ¡ 
ušt8_t
 *
p
;

688 
size_t
 
n
;

690 ià(
·ylßdËn
 < 
Ën
) {

691  
NGTCP2_ERR_FRAME_ENCODING
;

694 
p
 = 
·ylßd
 + 1;

696 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

697 
Ën
 +ğ
n
 - 1;

698 ià(
·ylßdËn
 < 
Ën
) {

699  
NGTCP2_ERR_FRAME_ENCODING
;

701 
p
 +ğ
n
 + 2;

702 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

703 
Ën
 +ğ
n
 - 1;

704 ià(
·ylßdËn
 < 
Ën
) {

705  
NGTCP2_ERR_FRAME_ENCODING
;

708 
p
 = 
·ylßd
 + 1;

710 
de¡
->
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

711 
de¡
->
¡»am_id
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

712 
p
 +ğ
n
;

713 
de¡
->
­p_”rÜ_code
 = 
	`ngtı2_g‘_ušt16
(
p
);

714 
p
 += 2;

715 
de¡
->
fš®_off£t
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

716 
p
 +ğ
n
;

718 
	`as£¹
((
size_t
)(
p
 - 
·ylßd
è=ğ
Ën
);

720  (
ssize_t
)
Ën
;

721 
	}
}

723 
ssize_t
 
	$ngtı2_pkt_decode_cÚÃùiÚ_şo£_äame
(
ngtı2_cÚÃùiÚ_şo£
 *
de¡
,

724 cÚ¡ 
ušt8_t
 *
·ylßd
,

725 
size_t
 
·ylßdËn
) {

726 
size_t
 
Ën
 = 1 + 2 + 1;

727 cÚ¡ 
ušt8_t
 *
p
;

728 
size_t
 
»asÚËn
;

729 
size_t
 
Ä—sÚËn
;

730 
ušt64_t
 
äame_ty³
;

731 
size_t
 
n
;

732 
ušt8_t
 
ty³
;

734 ià(
·ylßdËn
 < 
Ën
) {

735  
NGTCP2_ERR_FRAME_ENCODING
;

738 
ty³
 = 
·ylßd
[0];

740 
p
 = 
·ylßd
 + 1 + 2;

742 ià(
ty³
 =ğ
NGTCP2_FRAME_CONNECTION_CLOSE
) {

743 ++
Ën
;

745 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

746 
Ën
 +ğ
n
 - 1;

747 ià(
·ylßdËn
 < 
Ën
) {

748  
NGTCP2_ERR_FRAME_ENCODING
;

751 
p
 +ğ
n
;

754 
Ä—sÚËn
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

755 
Ën
 +ğ
Ä—sÚËn
 - 1;

756 ià(
·ylßdËn
 < 
Ën
) {

757  
NGTCP2_ERR_FRAME_ENCODING
;

760 
»asÚËn
 = 
	`ngtı2_g‘_v¬št
(&
Ä—sÚËn
, 
p
);

761 
Ën
 +ğ
»asÚËn
;

763 ià(
·ylßdËn
 < 
Ën
) {

764  
NGTCP2_ERR_FRAME_ENCODING
;

767 
p
 = 
·ylßd
 + 1;

769 
de¡
->
ty³
 =ype;

770 
de¡
->
”rÜ_code
 = 
	`ngtı2_g‘_ušt16
(
p
);

771 
p
 += 2;

772 ià(
ty³
 =ğ
NGTCP2_FRAME_CONNECTION_CLOSE
) {

773 
äame_ty³
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

775 ià(
äame_ty³
 > 255) {

776 
de¡
->
äame_ty³
 = 0;

778 
de¡
->
äame_ty³
 = (
ušt8_t
)frame_type;

780 
p
 +ğ
n
;

782 
de¡
->
äame_ty³
 = 0;

784 
de¡
->
»asÚËn
 =„easonlen;

785 
p
 +ğ
Ä—sÚËn
;

786 ià(
»asÚËn
 == 0) {

787 
de¡
->
»asÚ
 = 
NULL
;

789 
de¡
->
»asÚ
 = (
ušt8_t
 *)
p
;

790 
p
 +ğ
»asÚËn
;

793 
	`as£¹
((
size_t
)(
p
 - 
·ylßd
è=ğ
Ën
);

795  (
ssize_t
)
Ën
;

796 
	}
}

798 
ssize_t
 
	$ngtı2_pkt_decode_max_d©a_äame
(
ngtı2_max_d©a
 *
de¡
,

799 cÚ¡ 
ušt8_t
 *
·ylßd
,

800 
size_t
 
·ylßdËn
) {

801 
size_t
 
Ën
 = 1 + 1;

802 cÚ¡ 
ušt8_t
 *
p
;

803 
size_t
 
n
;

805 ià(
·ylßdËn
 < 
Ën
) {

806  
NGTCP2_ERR_FRAME_ENCODING
;

809 
p
 = 
·ylßd
 + 1;

811 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

812 
Ën
 +ğ
n
 - 1;

814 ià(
·ylßdËn
 < 
Ën
) {

815  
NGTCP2_ERR_FRAME_ENCODING
;

818 
de¡
->
ty³
 = 
NGTCP2_FRAME_MAX_DATA
;

819 
de¡
->
max_d©a
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

820 
p
 +ğ
n
;

822 
	`as£¹
((
size_t
)(
p
 - 
·ylßd
è=ğ
Ën
);

824  (
ssize_t
)
Ën
;

825 
	}
}

827 
ssize_t
 
	$ngtı2_pkt_decode_max_¡»am_d©a_äame
(
ngtı2_max_¡»am_d©a
 *
de¡
,

828 cÚ¡ 
ušt8_t
 *
·ylßd
,

829 
size_t
 
·ylßdËn
) {

830 
size_t
 
Ën
 = 1 + 1 + 1;

831 cÚ¡ 
ušt8_t
 *
p
;

832 
size_t
 
n
;

834 ià(
·ylßdËn
 < 
Ën
) {

835  
NGTCP2_ERR_FRAME_ENCODING
;

838 
p
 = 
·ylßd
 + 1;

840 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

841 
Ën
 +ğ
n
 - 1;

843 ià(
·ylßdËn
 < 
Ën
) {

844  
NGTCP2_ERR_FRAME_ENCODING
;

847 
p
 +ğ
n
;

849 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

850 
Ën
 +ğ
n
 - 1;

852 ià(
·ylßdËn
 < 
Ën
) {

853  
NGTCP2_ERR_FRAME_ENCODING
;

856 
p
 = 
·ylßd
 + 1;

858 
de¡
->
ty³
 = 
NGTCP2_FRAME_MAX_STREAM_DATA
;

859 
de¡
->
¡»am_id
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

860 
p
 +ğ
n
;

861 
de¡
->
max_¡»am_d©a
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

862 
p
 +ğ
n
;

864 
	`as£¹
((
size_t
)(
p
 - 
·ylßd
è=ğ
Ën
);

866  (
ssize_t
)
Ën
;

867 
	}
}

869 
ssize_t
 
	$ngtı2_pkt_decode_max_¡»ams_äame
(
ngtı2_max_¡»ams
 *
de¡
,

870 cÚ¡ 
ušt8_t
 *
·ylßd
,

871 
size_t
 
·ylßdËn
) {

872 
size_t
 
Ën
 = 1 + 1;

873 cÚ¡ 
ušt8_t
 *
p
;

874 
size_t
 
n
;

876 ià(
·ylßdËn
 < 
Ën
) {

877  
NGTCP2_ERR_FRAME_ENCODING
;

880 
p
 = 
·ylßd
 + 1;

882 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

883 
Ën
 +ğ
n
 - 1;

885 ià(
·ylßdËn
 < 
Ën
) {

886  
NGTCP2_ERR_FRAME_ENCODING
;

889 
de¡
->
ty³
 = 
·ylßd
[0];

890 
de¡
->
max_¡»ams
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

891 
p
 +ğ
n
;

893 
	`as£¹
((
size_t
)(
p
 - 
·ylßd
è=ğ
Ën
);

895  (
ssize_t
)
Ën
;

896 
	}
}

898 
ssize_t
 
	$ngtı2_pkt_decode_pšg_äame
(
ngtı2_pšg
 *
de¡
, cÚ¡ 
ušt8_t
 *
·ylßd
,

899 
size_t
 
·ylßdËn
) {

900 ()
·ylßd
;

901 ()
·ylßdËn
;

903 
de¡
->
ty³
 = 
NGTCP2_FRAME_PING
;

905 
	}
}

907 
ssize_t
 
	$ngtı2_pkt_decode_d©a_blocked_äame
(
ngtı2_d©a_blocked
 *
de¡
,

908 cÚ¡ 
ušt8_t
 *
·ylßd
,

909 
size_t
 
·ylßdËn
) {

910 
size_t
 
Ën
 = 1 + 1;

911 cÚ¡ 
ušt8_t
 *
p
;

912 
size_t
 
n
;

914 ià(
·ylßdËn
 < 
Ën
) {

915  
NGTCP2_ERR_FRAME_ENCODING
;

918 
p
 = 
·ylßd
 + 1;

920 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

921 
Ën
 +ğ
n
 - 1;

923 ià(
·ylßdËn
 < 
Ën
) {

924  
NGTCP2_ERR_FRAME_ENCODING
;

927 
de¡
->
ty³
 = 
NGTCP2_FRAME_DATA_BLOCKED
;

928 
de¡
->
off£t
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

929 
p
 +ğ
n
;

931 
	`as£¹
((
size_t
)(
p
 - 
·ylßd
è=ğ
Ën
);

933  (
ssize_t
)
Ën
;

934 
	}
}

936 
ssize_t


937 
	$ngtı2_pkt_decode_¡»am_d©a_blocked_äame
(
ngtı2_¡»am_d©a_blocked
 *
de¡
,

938 cÚ¡ 
ušt8_t
 *
·ylßd
,

939 
size_t
 
·ylßdËn
) {

940 
size_t
 
Ën
 = 1 + 1 + 1;

941 cÚ¡ 
ušt8_t
 *
p
;

942 
size_t
 
n
;

944 ià(
·ylßdËn
 < 
Ën
) {

945  
NGTCP2_ERR_FRAME_ENCODING
;

948 
p
 = 
·ylßd
 + 1;

950 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

951 
Ën
 +ğ
n
 - 1;

953 ià(
·ylßdËn
 < 
Ën
) {

954  
NGTCP2_ERR_FRAME_ENCODING
;

957 
p
 +ğ
n
;

959 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

960 
Ën
 +ğ
n
 - 1;

962 ià(
·ylßdËn
 < 
Ën
) {

963  
NGTCP2_ERR_FRAME_ENCODING
;

966 
p
 = 
·ylßd
 + 1;

968 
de¡
->
ty³
 = 
NGTCP2_FRAME_STREAM_DATA_BLOCKED
;

969 
de¡
->
¡»am_id
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

970 
p
 +ğ
n
;

971 
de¡
->
off£t
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

972 
p
 +ğ
n
;

974 
	`as£¹
((
size_t
)(
p
 - 
·ylßd
è=ğ
Ën
);

976  (
ssize_t
)
Ën
;

977 
	}
}

979 
ssize_t
 
	$ngtı2_pkt_decode_¡»ams_blocked_äame
(
ngtı2_¡»ams_blocked
 *
de¡
,

980 cÚ¡ 
ušt8_t
 *
·ylßd
,

981 
size_t
 
·ylßdËn
) {

982 
size_t
 
Ën
 = 1 + 1;

983 cÚ¡ 
ušt8_t
 *
p
;

984 
size_t
 
n
;

986 ià(
·ylßdËn
 < 
Ën
) {

987  
NGTCP2_ERR_FRAME_ENCODING
;

990 
p
 = 
·ylßd
 + 1;

992 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

993 
Ën
 +ğ
n
 - 1;

995 ià(
·ylßdËn
 < 
Ën
) {

996  
NGTCP2_ERR_FRAME_ENCODING
;

999 
de¡
->
ty³
 = 
·ylßd
[0];

1000 
de¡
->
¡»am_lim™
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

1001 
p
 +ğ
n
;

1003 
	`as£¹
((
size_t
)(
p
 - 
·ylßd
è=ğ
Ën
);

1005  (
ssize_t
)
Ën
;

1006 
	}
}

1008 
ssize_t
 
	$ngtı2_pkt_decode_Ãw_cÚÃùiÚ_id_äame
(

1009 
ngtı2_Ãw_cÚÃùiÚ_id
 *
de¡
, cÚ¡ 
ušt8_t
 *
·ylßd
, 
size_t
 
·ylßdËn
) {

1010 
size_t
 
Ën
 = 1 + 1 + 1 + 16;

1011 cÚ¡ 
ušt8_t
 *
p
;

1012 
size_t
 
n
;

1013 
size_t
 
c
;

1015 ià(
·ylßdËn
 < 
Ën
) {

1016  
NGTCP2_ERR_FRAME_ENCODING
;

1019 
p
 = 
·ylßd
 + 1;

1021 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

1022 
Ën
 +ğ
n
 - 1;

1023 ià(
·ylßdËn
 < 
Ën
) {

1024  
NGTCP2_ERR_FRAME_ENCODING
;

1027 
p
 +ğ
n
;

1029 
c
 = *
p
;

1032 ià(
c
 < 
NGTCP2_MIN_CIDLEN
 || c > 
NGTCP2_MAX_CIDLEN
) {

1033  
NGTCP2_ERR_PROTO
;

1036 
Ën
 +ğ
c
;

1037 ià(
·ylßdËn
 < 
Ën
) {

1038  
NGTCP2_ERR_FRAME_ENCODING
;

1041 
p
 = 
·ylßd
 + 1;

1043 
de¡
->
ty³
 = 
NGTCP2_FRAME_NEW_CONNECTION_ID
;

1044 
de¡
->
£q
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

1045 
p
 +ğ
n
 + 1;

1046 
	`ngtı2_cid_š™
(&
de¡
->
cid
, 
p
, 
c
);

1047 
p
 +ğ
c
;

1048 
	`memıy
(
de¡
->
¡©–ess_»£t_tok’
, 
p
, 
NGTCP2_STATELESS_RESET_TOKENLEN
);

1049 
p
 +ğ
NGTCP2_STATELESS_RESET_TOKENLEN
;

1051 
	`as£¹
((
size_t
)(
p
 - 
·ylßd
è=ğ
Ën
);

1053  (
ssize_t
)
Ën
;

1054 
	}
}

1056 
ssize_t
 
	$ngtı2_pkt_decode_¡İ_£ndšg_äame
(
ngtı2_¡İ_£ndšg
 *
de¡
,

1057 cÚ¡ 
ušt8_t
 *
·ylßd
,

1058 
size_t
 
·ylßdËn
) {

1059 
size_t
 
Ën
 = 1 + 1 + 2;

1060 cÚ¡ 
ušt8_t
 *
p
;

1061 
size_t
 
n
;

1063 ià(
·ylßdËn
 < 
Ën
) {

1064  
NGTCP2_ERR_FRAME_ENCODING
;

1067 
p
 = 
·ylßd
 + 1;

1069 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

1070 
Ën
 +ğ
n
 - 1;

1072 ià(
·ylßdËn
 < 
Ën
) {

1073  
NGTCP2_ERR_FRAME_ENCODING
;

1076 
de¡
->
ty³
 = 
NGTCP2_FRAME_STOP_SENDING
;

1077 
de¡
->
¡»am_id
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

1078 
p
 +ğ
n
;

1079 
de¡
->
­p_”rÜ_code
 = 
	`ngtı2_g‘_ušt16
(
p
);

1080 
p
 += 2;

1082 
	`as£¹
((
size_t
)(
p
 - 
·ylßd
è=ğ
Ën
);

1084  (
ssize_t
)
Ën
;

1085 
	}
}

1087 
ssize_t
 
	$ngtı2_pkt_decode_·th_ch®Ënge_äame
(
ngtı2_·th_ch®Ënge
 *
de¡
,

1088 cÚ¡ 
ušt8_t
 *
·ylßd
,

1089 
size_t
 
·ylßdËn
) {

1090 
size_t
 
Ën
 = 1 + 8;

1091 cÚ¡ 
ušt8_t
 *
p
;

1093 ià(
·ylßdËn
 < 
Ën
) {

1094  
NGTCP2_ERR_FRAME_ENCODING
;

1097 
p
 = 
·ylßd
 + 1;

1099 
de¡
->
ty³
 = 
NGTCP2_FRAME_PATH_CHALLENGE
;

1100 
	`ngtı2_ıymem
(
de¡
->
d©a
, 
p
, (dest->data));

1101 
p
 +ğ(
de¡
->
d©a
);

1103 
	`as£¹
((
size_t
)(
p
 - 
·ylßd
è=ğ
Ën
);

1105  (
ssize_t
)
Ën
;

1106 
	}
}

1108 
ssize_t
 
	$ngtı2_pkt_decode_·th_»¥Ú£_äame
(
ngtı2_·th_»¥Ú£
 *
de¡
,

1109 cÚ¡ 
ušt8_t
 *
·ylßd
,

1110 
size_t
 
·ylßdËn
) {

1111 
size_t
 
Ën
 = 1 + 8;

1112 cÚ¡ 
ušt8_t
 *
p
;

1114 ià(
·ylßdËn
 < 
Ën
) {

1115  
NGTCP2_ERR_FRAME_ENCODING
;

1118 
p
 = 
·ylßd
 + 1;

1120 
de¡
->
ty³
 = 
NGTCP2_FRAME_PATH_RESPONSE
;

1121 
	`ngtı2_ıymem
(
de¡
->
d©a
, 
p
, (dest->data));

1122 
p
 +ğ(
de¡
->
d©a
);

1124 
	`as£¹
((
size_t
)(
p
 - 
·ylßd
è=ğ
Ën
);

1126  (
ssize_t
)
Ën
;

1127 
	}
}

1129 
ssize_t
 
	$ngtı2_pkt_decode_üy±o_äame
(
ngtı2_üy±o
 *
de¡
,

1130 cÚ¡ 
ušt8_t
 *
·ylßd
,

1131 
size_t
 
·ylßdËn
) {

1132 
size_t
 
Ën
 = 1 + 1 + 1;

1133 cÚ¡ 
ušt8_t
 *
p
;

1134 
size_t
 
d©®’
;

1135 
size_t
 
nd©®’
;

1136 
size_t
 
n
;

1138 ià(
·ylßdËn
 < 
Ën
) {

1139  
NGTCP2_ERR_FRAME_ENCODING
;

1142 
p
 = 
·ylßd
 + 1;

1144 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

1145 
Ën
 +ğ
n
 - 1;

1147 ià(
·ylßdËn
 < 
Ën
) {

1148  
NGTCP2_ERR_FRAME_ENCODING
;

1151 
p
 +ğ
n
;

1153 
nd©®’
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

1154 
Ën
 +ğ
nd©®’
 - 1;

1156 ià(
·ylßdËn
 < 
Ën
) {

1157  
NGTCP2_ERR_FRAME_ENCODING
;

1160 
d©®’
 = 
	`ngtı2_g‘_v¬št
(&
nd©®’
, 
p
);

1161 
Ën
 +ğ
d©®’
;

1163 ià(
·ylßdËn
 < 
Ën
) {

1164  
NGTCP2_ERR_FRAME_ENCODING
;

1167 
p
 = 
·ylßd
 + 1;

1169 
de¡
->
ty³
 = 
NGTCP2_FRAME_CRYPTO
;

1170 
de¡
->
off£t
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

1171 
p
 +ğ
n
;

1172 
de¡
->
d©a
[0].
Ën
 = 
d©®’
;

1173 
p
 +ğ
nd©®’
;

1174 ià(
de¡
->
d©a
[0].
Ën
) {

1175 
de¡
->
d©a
[0].
ba£
 = (
ušt8_t
 *)
p
;

1176 
p
 +ğ
de¡
->
d©a
[0].
Ën
;

1177 
de¡
->
d©aút
 = 1;

1179 
de¡
->
d©a
[0].
ba£
 = 
NULL
;

1180 
de¡
->
d©aút
 = 0;

1183 
	`as£¹
((
size_t
)(
p
 - 
·ylßd
è=ğ
Ën
);

1185  (
ssize_t
)
Ën
;

1186 
	}
}

1188 
ssize_t
 
	$ngtı2_pkt_decode_Ãw_tok’_äame
(
ngtı2_Ãw_tok’
 *
de¡
,

1189 cÚ¡ 
ušt8_t
 *
·ylßd
,

1190 
size_t
 
·ylßdËn
) {

1191 
size_t
 
Ën
 = 1 + 1;

1192 cÚ¡ 
ušt8_t
 *
p
;

1193 
size_t
 
n
;

1194 
size_t
 
d©®’
;

1196 ià(
·ylßdËn
 < 
Ën
) {

1197  
NGTCP2_ERR_FRAME_ENCODING
;

1200 
p
 = 
·ylßd
 + 1;

1202 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

1203 
Ën
 +ğ
n
 - 1;

1205 ià(
·ylßdËn
 < 
Ën
) {

1206  
NGTCP2_ERR_FRAME_ENCODING
;

1209 
d©®’
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

1210 
Ën
 +ğ
d©®’
;

1212 ià(
·ylßdËn
 < 
Ën
) {

1213  
NGTCP2_ERR_FRAME_ENCODING
;

1216 
de¡
->
ty³
 = 
NGTCP2_FRAME_NEW_TOKEN
;

1217 
de¡
->
tok’Ën
 = 
d©®’
;

1218 
p
 +ğ
n
;

1219 
de¡
->
tok’
 = 
p
;

1220 
p
 +ğ
de¡
->
tok’Ën
;

1222 
	`as£¹
((
size_t
)(
p
 - 
·ylßd
è=ğ
Ën
);

1224  (
ssize_t
)
Ën
;

1225 
	}
}

1227 
ssize_t


1228 
	$ngtı2_pkt_decode_»tœe_cÚÃùiÚ_id_äame
(
ngtı2_»tœe_cÚÃùiÚ_id
 *
de¡
,

1229 cÚ¡ 
ušt8_t
 *
·ylßd
,

1230 
size_t
 
·ylßdËn
) {

1231 
size_t
 
Ën
 = 1 + 1;

1232 cÚ¡ 
ušt8_t
 *
p
;

1233 
size_t
 
n
;

1235 ià(
·ylßdËn
 < 
Ën
) {

1236  
NGTCP2_ERR_FRAME_ENCODING
;

1239 
p
 = 
·ylßd
 + 1;

1241 
n
 = 
	`ngtı2_g‘_v¬št_Ën
(
p
);

1242 
Ën
 +ğ
n
 - 1;

1244 ià(
·ylßdËn
 < 
Ën
) {

1245  
NGTCP2_ERR_FRAME_ENCODING
;

1248 
de¡
->
ty³
 = 
NGTCP2_FRAME_RETIRE_CONNECTION_ID
;

1249 
de¡
->
£q
 = 
	`ngtı2_g‘_v¬št
(&
n
, 
p
);

1250 
p
 +ğ
n
;

1252 
	`as£¹
((
size_t
)(
p
 - 
·ylßd
è=ğ
Ën
);

1254  (
ssize_t
)
Ën
;

1255 
	}
}

1257 
ssize_t
 
	$ngtı2_pkt_’code_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
, 
ngtı2_äame
 *
ä
) {

1258 
ä
->
ty³
) {

1259 
NGTCP2_FRAME_STREAM
:

1260  
	`ngtı2_pkt_’code_¡»am_äame
(
out
, 
ou’
, &
ä
->
¡»am
);

1261 
NGTCP2_FRAME_ACK
:

1262  
	`ngtı2_pkt_’code_ack_äame
(
out
, 
ou’
, &
ä
->
ack
);

1263 
NGTCP2_FRAME_PADDING
:

1264  
	`ngtı2_pkt_’code_·ddšg_äame
(
out
, 
ou’
, &
ä
->
·ddšg
);

1265 
NGTCP2_FRAME_RESET_STREAM
:

1266  
	`ngtı2_pkt_’code_»£t_¡»am_äame
(
out
, 
ou’
, &
ä
->
»£t_¡»am
);

1267 
NGTCP2_FRAME_CONNECTION_CLOSE
:

1268 
NGTCP2_FRAME_CONNECTION_CLOSE_APP
:

1269  
	`ngtı2_pkt_’code_cÚÃùiÚ_şo£_äame
(
out
, 
ou’
,

1270 &
ä
->
cÚÃùiÚ_şo£
);

1271 
NGTCP2_FRAME_MAX_DATA
:

1272  
	`ngtı2_pkt_’code_max_d©a_äame
(
out
, 
ou’
, &
ä
->
max_d©a
);

1273 
NGTCP2_FRAME_MAX_STREAM_DATA
:

1274  
	`ngtı2_pkt_’code_max_¡»am_d©a_äame
(
out
, 
ou’
,

1275 &
ä
->
max_¡»am_d©a
);

1276 
NGTCP2_FRAME_MAX_STREAMS_BIDI
:

1277 
NGTCP2_FRAME_MAX_STREAMS_UNI
:

1278  
	`ngtı2_pkt_’code_max_¡»ams_äame
(
out
, 
ou’
, &
ä
->
max_¡»ams
);

1279 
NGTCP2_FRAME_PING
:

1280  
	`ngtı2_pkt_’code_pšg_äame
(
out
, 
ou’
, &
ä
->
pšg
);

1281 
NGTCP2_FRAME_DATA_BLOCKED
:

1282  
	`ngtı2_pkt_’code_d©a_blocked_äame
(
out
, 
ou’
, &
ä
->
d©a_blocked
);

1283 
NGTCP2_FRAME_STREAM_DATA_BLOCKED
:

1284  
	`ngtı2_pkt_’code_¡»am_d©a_blocked_äame
(

1285 
out
, 
ou’
, &
ä
->
¡»am_d©a_blocked
);

1286 
NGTCP2_FRAME_STREAMS_BLOCKED_BIDI
:

1287 
NGTCP2_FRAME_STREAMS_BLOCKED_UNI
:

1288  
	`ngtı2_pkt_’code_¡»ams_blocked_äame
(
out
, 
ou’
,

1289 &
ä
->
¡»ams_blocked
);

1290 
NGTCP2_FRAME_NEW_CONNECTION_ID
:

1291  
	`ngtı2_pkt_’code_Ãw_cÚÃùiÚ_id_äame
(
out
, 
ou’
,

1292 &
ä
->
Ãw_cÚÃùiÚ_id
);

1293 
NGTCP2_FRAME_STOP_SENDING
:

1294  
	`ngtı2_pkt_’code_¡İ_£ndšg_äame
(
out
, 
ou’
, &
ä
->
¡İ_£ndšg
);

1295 
NGTCP2_FRAME_PATH_CHALLENGE
:

1296  
	`ngtı2_pkt_’code_·th_ch®Ënge_äame
(
out
, 
ou’
,

1297 &
ä
->
·th_ch®Ënge
);

1298 
NGTCP2_FRAME_PATH_RESPONSE
:

1299  
	`ngtı2_pkt_’code_·th_»¥Ú£_äame
(
out
, 
ou’
,

1300 &
ä
->
·th_»¥Ú£
);

1301 
NGTCP2_FRAME_CRYPTO
:

1302  
	`ngtı2_pkt_’code_üy±o_äame
(
out
, 
ou’
, &
ä
->
üy±o
);

1303 
NGTCP2_FRAME_NEW_TOKEN
:

1304  
	`ngtı2_pkt_’code_Ãw_tok’_äame
(
out
, 
ou’
, &
ä
->
Ãw_tok’
);

1305 
NGTCP2_FRAME_RETIRE_CONNECTION_ID
:

1306  
	`ngtı2_pkt_’code_»tœe_cÚÃùiÚ_id_äame
(

1307 
out
, 
ou’
, &
ä
->
»tœe_cÚÃùiÚ_id
);

1309  
NGTCP2_ERR_INVALID_ARGUMENT
;

1311 
	}
}

1313 
ssize_t
 
	$ngtı2_pkt_’code_¡»am_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

1314 
ngtı2_¡»am
 *
ä
) {

1315 
size_t
 
Ën
 = 1;

1316 
ušt8_t
 
æags
 = 
NGTCP2_STREAM_LEN_BIT
;

1317 
ušt8_t
 *
p
;

1318 
size_t
 
i
;

1319 
size_t
 
d©®’
 = 0;

1321 ià(
ä
->
fš
) {

1322 
æags
 |ğ
NGTCP2_STREAM_FIN_BIT
;

1325 ià(
ä
->
off£t
) {

1326 
æags
 |ğ
NGTCP2_STREAM_OFF_BIT
;

1327 
Ën
 +ğ
	`ngtı2_put_v¬št_Ën
(
ä
->
off£t
);

1330 
Ën
 +ğ
	`ngtı2_put_v¬št_Ën
(
ä
->
¡»am_id
);

1332 
i
 = 0; i < 
ä
->
d©aút
; ++i) {

1333 
d©®’
 +ğ
ä
->
d©a
[
i
].
Ën
;

1336 
Ën
 +ğ
	`ngtı2_put_v¬št_Ën
(
d©®’
);

1337 
Ën
 +ğ
d©®’
;

1339 ià(
ou’
 < 
Ën
) {

1340  
NGTCP2_ERR_NOBUF
;

1343 
p
 = 
out
;

1345 *
p
++ = 
æags
 | 
NGTCP2_FRAME_STREAM
;

1347 
ä
->
æags
 = flags;

1349 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
¡»am_id
);

1351 ià(
ä
->
off£t
) {

1352 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
off£t
);

1355 
p
 = 
	`ngtı2_put_v¬št
Õ, 
d©®’
);

1357 
i
 = 0; i < 
ä
->
d©aút
; ++i) {

1358 
	`as£¹
(
ä
->
d©a
[
i
].
Ën
);

1359 
	`as£¹
(
ä
->
d©a
[
i
].
ba£
);

1360 
p
 = 
	`ngtı2_ıymem
Õ, 
ä
->
d©a
[
i
].
ba£
, fr->d©a[i].
Ën
);

1363 
	`as£¹
((
size_t
)(
p
 - 
out
è=ğ
Ën
);

1365  (
ssize_t
)
Ën
;

1366 
	}
}

1368 
ssize_t
 
	$ngtı2_pkt_’code_ack_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

1369 
ngtı2_ack
 *
ä
) {

1370 
size_t
 
Ën
 = 1 + 
	`ngtı2_put_v¬št_Ën
(
ä
->
Ïrge¡_ack
) +

1371 
	`ngtı2_put_v¬št_Ën
(
ä
->
ack_d–ay
) +

1372 
	`ngtı2_put_v¬št_Ën
(
ä
->
num_blks
) +

1373 
	`ngtı2_put_v¬št_Ën
(
ä
->
fœ¡_ack_blkËn
);

1374 
ušt8_t
 *
p
;

1375 
size_t
 
i
;

1376 cÚ¡ 
ngtı2_ack_blk
 *
blk
;

1378 
i
 = 0; i < 
ä
->
num_blks
; ++i) {

1379 
blk
 = &
ä
->
blks
[
i
];

1380 
Ën
 +ğ
	`ngtı2_put_v¬št_Ën
(
blk
->
g­
);

1381 
Ën
 +ğ
	`ngtı2_put_v¬št_Ën
(
blk
->
blkËn
);

1384 ià(
ou’
 < 
Ën
) {

1385  
NGTCP2_ERR_NOBUF
;

1388 
p
 = 
out
;

1390 *
p
++ = 
NGTCP2_FRAME_ACK
;

1391 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
Ïrge¡_ack
);

1392 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
ack_d–ay
);

1393 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
num_blks
);

1394 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
fœ¡_ack_blkËn
);

1396 
i
 = 0; i < 
ä
->
num_blks
; ++i) {

1397 
blk
 = &
ä
->
blks
[
i
];

1398 
p
 = 
	`ngtı2_put_v¬št
Õ, 
blk
->
g­
);

1399 
p
 = 
	`ngtı2_put_v¬št
Õ, 
blk
->
blkËn
);

1402 
	`as£¹
((
size_t
)(
p
 - 
out
è=ğ
Ën
);

1404  (
ssize_t
)
Ën
;

1405 
	}
}

1407 
ssize_t
 
	$ngtı2_pkt_’code_·ddšg_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

1408 cÚ¡ 
ngtı2_·ddšg
 *
ä
) {

1409 ià(
ou’
 < 
ä
->
Ën
) {

1410  
NGTCP2_ERR_NOBUF
;

1413 
	`mem£t
(
out
, 0, 
ä
->
Ën
);

1415  (
ssize_t
)
ä
->
Ën
;

1416 
	}
}

1418 
ssize_t
 
	$ngtı2_pkt_’code_»£t_¡»am_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

1419 cÚ¡ 
ngtı2_»£t_¡»am
 *
ä
) {

1420 
size_t
 
Ën
 = 1 + 
	`ngtı2_put_v¬št_Ën
(
ä
->
¡»am_id
) + 2 +

1421 
	`ngtı2_put_v¬št_Ën
(
ä
->
fš®_off£t
);

1422 
ušt8_t
 *
p
;

1424 ià(
ou’
 < 
Ën
) {

1425  
NGTCP2_ERR_NOBUF
;

1428 
p
 = 
out
;

1430 *
p
++ = 
NGTCP2_FRAME_RESET_STREAM
;

1431 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
¡»am_id
);

1432 
p
 = 
	`ngtı2_put_ušt16be
Õ, 
ä
->
­p_”rÜ_code
);

1433 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
fš®_off£t
);

1435 
	`as£¹
((
size_t
)(
p
 - 
out
è=ğ
Ën
);

1437  (
ssize_t
)
Ën
;

1438 
	}
}

1440 
ssize_t


1441 
	$ngtı2_pkt_’code_cÚÃùiÚ_şo£_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

1442 cÚ¡ 
ngtı2_cÚÃùiÚ_şo£
 *
ä
) {

1443 
size_t
 
Ën
 = 1 + 2 +

1444 (
ä
->
ty³
 =ğ
NGTCP2_FRAME_CONNECTION_CLOSE


1445 ? 
	`ngtı2_put_v¬št_Ën
(
ä
->
äame_ty³
)

1447 
	`ngtı2_put_v¬št_Ën
(
ä
->
»asÚËn
) + fr->reasonlen;

1448 
ušt8_t
 *
p
;

1450 ià(
ou’
 < 
Ën
) {

1451  
NGTCP2_ERR_NOBUF
;

1454 
p
 = 
out
;

1456 *
p
++ = 
ä
->
ty³
;

1457 
p
 = 
	`ngtı2_put_ušt16be
Õ, 
ä
->
”rÜ_code
);

1458 ià(
ä
->
ty³
 =ğ
NGTCP2_FRAME_CONNECTION_CLOSE
) {

1459 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
äame_ty³
);

1461 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
»asÚËn
);

1462 ià(
ä
->
»asÚËn
) {

1463 
p
 = 
	`ngtı2_ıymem
Õ, 
ä
->
»asÚ
, fr->
»asÚËn
);

1466 
	`as£¹
((
size_t
)(
p
 - 
out
è=ğ
Ën
);

1468  (
ssize_t
)
Ën
;

1469 
	}
}

1471 
ssize_t
 
	$ngtı2_pkt_’code_max_d©a_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

1472 cÚ¡ 
ngtı2_max_d©a
 *
ä
) {

1473 
size_t
 
Ën
 = 1 + 
	`ngtı2_put_v¬št_Ën
(
ä
->
max_d©a
);

1474 
ušt8_t
 *
p
;

1476 ià(
ou’
 < 
Ën
) {

1477  
NGTCP2_ERR_NOBUF
;

1480 
p
 = 
out
;

1482 *
p
++ = 
NGTCP2_FRAME_MAX_DATA
;

1483 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
max_d©a
);

1485 
	`as£¹
((
size_t
)(
p
 - 
out
è=ğ
Ën
);

1487  (
ssize_t
)
Ën
;

1488 
	}
}

1490 
ssize_t


1491 
	$ngtı2_pkt_’code_max_¡»am_d©a_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

1492 cÚ¡ 
ngtı2_max_¡»am_d©a
 *
ä
) {

1493 
size_t
 
Ën
 = 1 + 
	`ngtı2_put_v¬št_Ën
(
ä
->
¡»am_id
) +

1494 
	`ngtı2_put_v¬št_Ën
(
ä
->
max_¡»am_d©a
);

1495 
ušt8_t
 *
p
;

1497 ià(
ou’
 < 
Ën
) {

1498  
NGTCP2_ERR_NOBUF
;

1501 
p
 = 
out
;

1503 *
p
++ = 
NGTCP2_FRAME_MAX_STREAM_DATA
;

1504 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
¡»am_id
);

1505 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
max_¡»am_d©a
);

1507 
	`as£¹
((
size_t
)(
p
 - 
out
è=ğ
Ën
);

1509  (
ssize_t
)
Ën
;

1510 
	}
}

1512 
ssize_t
 
	$ngtı2_pkt_’code_max_¡»ams_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

1513 cÚ¡ 
ngtı2_max_¡»ams
 *
ä
) {

1514 
size_t
 
Ën
 = 1 + 
	`ngtı2_put_v¬št_Ën
(
ä
->
max_¡»ams
);

1515 
ušt8_t
 *
p
;

1517 ià(
ou’
 < 
Ën
) {

1518  
NGTCP2_ERR_NOBUF
;

1521 
p
 = 
out
;

1523 *
p
++ = 
ä
->
ty³
;

1524 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
max_¡»ams
);

1526 
	`as£¹
((
size_t
)(
p
 - 
out
è=ğ
Ën
);

1528  (
ssize_t
)
Ën
;

1529 
	}
}

1531 
ssize_t
 
	$ngtı2_pkt_’code_pšg_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

1532 cÚ¡ 
ngtı2_pšg
 *
ä
) {

1533 ()
ä
;

1535 ià(
ou’
 < 1) {

1536  
NGTCP2_ERR_NOBUF
;

1539 *
out
++ = 
NGTCP2_FRAME_PING
;

1542 
	}
}

1544 
ssize_t
 
	$ngtı2_pkt_’code_d©a_blocked_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

1545 cÚ¡ 
ngtı2_d©a_blocked
 *
ä
) {

1546 
size_t
 
Ën
 = 1 + 
	`ngtı2_put_v¬št_Ën
(
ä
->
off£t
);

1547 
ušt8_t
 *
p
;

1549 ià(
ou’
 < 
Ën
) {

1550  
NGTCP2_ERR_NOBUF
;

1553 
p
 = 
out
;

1555 *
p
++ = 
NGTCP2_FRAME_DATA_BLOCKED
;

1556 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
off£t
);

1558 
	`as£¹
((
size_t
)(
p
 - 
out
è=ğ
Ën
);

1560  (
ssize_t
)
Ën
;

1561 
	}
}

1563 
ssize_t
 
	$ngtı2_pkt_’code_¡»am_d©a_blocked_äame
(

1564 
ušt8_t
 *
out
, 
size_t
 
ou’
, cÚ¡ 
ngtı2_¡»am_d©a_blocked
 *
ä
) {

1565 
size_t
 
Ën
 = 1 + 
	`ngtı2_put_v¬št_Ën
(
ä
->
¡»am_id
) +

1566 
	`ngtı2_put_v¬št_Ën
(
ä
->
off£t
);

1567 
ušt8_t
 *
p
;

1569 ià(
ou’
 < 
Ën
) {

1570  
NGTCP2_ERR_NOBUF
;

1573 
p
 = 
out
;

1575 *
p
++ = 
NGTCP2_FRAME_STREAM_DATA_BLOCKED
;

1576 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
¡»am_id
);

1577 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
off£t
);

1579 
	`as£¹
((
size_t
)(
p
 - 
out
è=ğ
Ën
);

1581  (
ssize_t
)
Ën
;

1582 
	}
}

1584 
ssize_t


1585 
	$ngtı2_pkt_’code_¡»ams_blocked_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

1586 cÚ¡ 
ngtı2_¡»ams_blocked
 *
ä
) {

1587 
size_t
 
Ën
 = 1 + 
	`ngtı2_put_v¬št_Ën
(
ä
->
¡»am_lim™
);

1588 
ušt8_t
 *
p
;

1590 ià(
ou’
 < 
Ën
) {

1591  
NGTCP2_ERR_NOBUF
;

1594 
p
 = 
out
;

1596 *
p
++ = 
ä
->
ty³
;

1597 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
¡»am_lim™
);

1599 
	`as£¹
((
size_t
)(
p
 - 
out
è=ğ
Ën
);

1601  (
ssize_t
)
Ën
;

1602 
	}
}

1604 
ssize_t


1605 
	$ngtı2_pkt_’code_Ãw_cÚÃùiÚ_id_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

1606 cÚ¡ 
ngtı2_Ãw_cÚÃùiÚ_id
 *
ä
) {

1607 
size_t
 
Ën
 = 1 + 
	`ngtı2_put_v¬št_Ën
(
ä
->
£q
è+ 1 + fr->
cid
.
d©®’
 +

1608 
NGTCP2_STATELESS_RESET_TOKENLEN
;

1609 
ušt8_t
 *
p
;

1611 ià(
ou’
 < 
Ën
) {

1612  
NGTCP2_ERR_NOBUF
;

1615 
p
 = 
out
;

1617 *
p
++ = 
NGTCP2_FRAME_NEW_CONNECTION_ID
;

1618 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
£q
);

1619 *
p
++ = (
ušt8_t
)
ä
->
cid
.
d©®’
;

1620 
p
 = 
	`ngtı2_ıymem
Õ, 
ä
->
cid
.
d©a
, fr->cid.
d©®’
);

1621 
p
 = 
	`ngtı2_ıymem
Õ, 
ä
->
¡©–ess_»£t_tok’
,

1622 
NGTCP2_STATELESS_RESET_TOKENLEN
);

1624 
	`as£¹
((
size_t
)(
p
 - 
out
è=ğ
Ën
);

1626  (
ssize_t
)
Ën
;

1627 
	}
}

1629 
ssize_t
 
	$ngtı2_pkt_’code_¡İ_£ndšg_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

1630 cÚ¡ 
ngtı2_¡İ_£ndšg
 *
ä
) {

1631 
size_t
 
Ën
 = 1 + 
	`ngtı2_put_v¬št_Ën
(
ä
->
¡»am_id
) + 2;

1632 
ušt8_t
 *
p
;

1634 ià(
ou’
 < 
Ën
) {

1635  
NGTCP2_ERR_NOBUF
;

1638 
p
 = 
out
;

1640 *
p
++ = 
NGTCP2_FRAME_STOP_SENDING
;

1641 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
¡»am_id
);

1642 
p
 = 
	`ngtı2_put_ušt16be
Õ, 
ä
->
­p_”rÜ_code
);

1644 
	`as£¹
((
size_t
)(
p
 - 
out
è=ğ
Ën
);

1646  (
ssize_t
)
Ën
;

1647 
	}
}

1649 
ssize_t


1650 
	$ngtı2_pkt_’code_·th_ch®Ënge_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

1651 cÚ¡ 
ngtı2_·th_ch®Ënge
 *
ä
) {

1652 
size_t
 
Ën
 = 1 + 8;

1653 
ušt8_t
 *
p
;

1655 ià(
ou’
 < 
Ën
) {

1656  
NGTCP2_ERR_NOBUF
;

1659 
p
 = 
out
;

1661 *
p
++ = 
NGTCP2_FRAME_PATH_CHALLENGE
;

1662 
p
 = 
	`ngtı2_ıymem
Õ, 
ä
->
d©a
, (fr->data));

1664 
	`as£¹
((
size_t
)(
p
 - 
out
è=ğ
Ën
);

1666  (
ssize_t
)
Ën
;

1667 
	}
}

1669 
ssize_t
 
	$ngtı2_pkt_’code_·th_»¥Ú£_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

1670 cÚ¡ 
ngtı2_·th_»¥Ú£
 *
ä
) {

1671 
size_t
 
Ën
 = 1 + 8;

1672 
ušt8_t
 *
p
;

1674 ià(
ou’
 < 
Ën
) {

1675  
NGTCP2_ERR_NOBUF
;

1678 
p
 = 
out
;

1680 *
p
++ = 
NGTCP2_FRAME_PATH_RESPONSE
;

1681 
p
 = 
	`ngtı2_ıymem
Õ, 
ä
->
d©a
, (fr->data));

1683 
	`as£¹
((
size_t
)(
p
 - 
out
è=ğ
Ën
);

1685  (
ssize_t
)
Ën
;

1686 
	}
}

1688 
ssize_t
 
	$ngtı2_pkt_’code_üy±o_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

1689 cÚ¡ 
ngtı2_üy±o
 *
ä
) {

1690 
size_t
 
Ën
 = 1;

1691 
ušt8_t
 *
p
;

1692 
size_t
 
i
;

1693 
size_t
 
d©®’
 = 0;

1695 
Ën
 +ğ
	`ngtı2_put_v¬št_Ën
(
ä
->
off£t
);

1697 
i
 = 0; i < 
ä
->
d©aút
; ++i) {

1698 
d©®’
 +ğ
ä
->
d©a
[
i
].
Ën
;

1701 
Ën
 +ğ
	`ngtı2_put_v¬št_Ën
(
d©®’
);

1702 
Ën
 +ğ
d©®’
;

1704 ià(
ou’
 < 
Ën
) {

1705  
NGTCP2_ERR_NOBUF
;

1708 
p
 = 
out
;

1710 *
p
++ = 
NGTCP2_FRAME_CRYPTO
;

1712 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
off£t
);

1713 
p
 = 
	`ngtı2_put_v¬št
Õ, 
d©®’
);

1715 
i
 = 0; i < 
ä
->
d©aút
; ++i) {

1716 
	`as£¹
(
ä
->
d©a
[
i
].
ba£
);

1717 
p
 = 
	`ngtı2_ıymem
Õ, 
ä
->
d©a
[
i
].
ba£
, fr->d©a[i].
Ën
);

1720 
	`as£¹
((
size_t
)(
p
 - 
out
è=ğ
Ën
);

1722  (
ssize_t
)
Ën
;

1723 
	}
}

1725 
ssize_t
 
	$ngtı2_pkt_’code_Ãw_tok’_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

1726 cÚ¡ 
ngtı2_Ãw_tok’
 *
ä
) {

1727 
size_t
 
Ën
 = 1 + 
	`ngtı2_put_v¬št_Ën
(
ä
->
tok’Ën
) + fr->tokenlen;

1728 
ušt8_t
 *
p
;

1730 ià(
ou’
 < 
Ën
) {

1731  
NGTCP2_ERR_NOBUF
;

1734 
p
 = 
out
;

1736 *
p
++ = 
NGTCP2_FRAME_NEW_TOKEN
;

1738 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
tok’Ën
);

1739 ià(
ä
->
tok’Ën
) {

1740 
p
 = 
	`ngtı2_ıymem
Õ, 
ä
->
tok’
, fr->
tok’Ën
);

1743 
	`as£¹
((
size_t
)(
p
 - 
out
è=ğ
Ën
);

1745  (
ssize_t
)
Ën
;

1746 
	}
}

1748 
ssize_t
 
	$ngtı2_pkt_’code_»tœe_cÚÃùiÚ_id_äame
(

1749 
ušt8_t
 *
out
, 
size_t
 
ou’
, cÚ¡ 
ngtı2_»tœe_cÚÃùiÚ_id
 *
ä
) {

1750 
size_t
 
Ën
 = 1 + 
	`ngtı2_put_v¬št_Ën
(
ä
->
£q
);

1751 
ušt8_t
 *
p
;

1753 ià(
ou’
 < 
Ën
) {

1754  
NGTCP2_ERR_NOBUF
;

1757 
p
 = 
out
;

1759 *
p
++ = 
NGTCP2_FRAME_RETIRE_CONNECTION_ID
;

1761 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ä
->
£q
);

1763 
	`as£¹
((
size_t
)(
p
 - 
out
è=ğ
Ën
);

1765  (
ssize_t
)
Ën
;

1766 
	}
}

1768 
ssize_t
 
	$ngtı2_pkt_wr™e_v”siÚ_ÃgÙŸtiÚ
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

1769 
ušt8_t
 
unu£d_¿ndom
,

1770 cÚ¡ 
ngtı2_cid
 *
dcid
,

1771 cÚ¡ 
ngtı2_cid
 *
scid
,

1772 cÚ¡ 
ušt32_t
 *
sv
, 
size_t
 
nsv
) {

1773 
size_t
 
Ën
 = 1 + 4 + 1 + 
dcid
->
d©®’
 + 
scid
->d©®’ + 
nsv
 * 4;

1774 
ušt8_t
 *
p
;

1775 
size_t
 
i
;

1777 ià(
de¡Ën
 < 
Ën
) {

1778  
NGTCP2_ERR_NOBUF
;

1781 
p
 = 
de¡
;

1783 *
p
++ = 0x80 | 
unu£d_¿ndom
;

1784 
p
 = 
	`ngtı2_put_ušt32be
(p, 0);

1785 *
p
 = 0;

1786 ià(
dcid
->
d©®’
) {

1787 
	`as£¹
(
dcid
->
d©®’
 > 3);

1788 *
p
 |ğ(
ušt8_t
)((
dcid
->
d©®’
 - 3) << 4);

1790 ià(
scid
->
d©®’
) {

1791 
	`as£¹
(
scid
->
d©®’
 > 3);

1792 *
p
 = (
ušt8_t
)(*°| ((
scid
->
d©®’
 - 3) & 0xf));

1794 ++
p
;

1795 ià(
dcid
->
d©®’
) {

1796 
p
 = 
	`ngtı2_ıymem
Õ, 
dcid
->
d©a
, dcid->
d©®’
);

1798 ià(
scid
->
d©®’
) {

1799 
p
 = 
	`ngtı2_ıymem
Õ, 
scid
->
d©a
, scid->
d©®’
);

1802 
i
 = 0; i < 
nsv
; ++i) {

1803 
p
 = 
	`ngtı2_put_ušt32be
Õ, 
sv
[
i
]);

1806 
	`as£¹
((
size_t
)(
p
 - 
de¡
è=ğ
Ën
);

1808  (
ssize_t
)
Ën
;

1809 
	}
}

1811 
size_t
 
	$ngtı2_pkt_decode_v”siÚ_ÃgÙŸtiÚ
(
ušt32_t
 *
de¡
,

1812 cÚ¡ 
ušt8_t
 *
·ylßd
,

1813 
size_t
 
·ylßdËn
) {

1814 cÚ¡ 
ušt8_t
 *
’d
 = 
·ylßd
 + 
·ylßdËn
;

1816 
	`as£¹
((
·ylßdËn
 % (
ušt32_t
)) == 0);

1818 ; 
·ylßd
 !ğ
’d
;…aylßd +ğ(
ušt32_t
)) {

1819 *
de¡
++ = 
	`ngtı2_g‘_ušt32
(
·ylßd
);

1822  
·ylßdËn
 / (
ušt32_t
);

1823 
	}
}

1825 
	$ngtı2_pkt_decode_¡©–ess_»£t
(
ngtı2_pkt_¡©–ess_»£t
 *
¤
,

1826 cÚ¡ 
ušt8_t
 *
·ylßd
,

1827 
size_t
 
·ylßdËn
) {

1828 cÚ¡ 
ušt8_t
 *
p
 = 
·ylßd
;

1830 ià(
·ylßdËn
 <

1831 
NGTCP2_MIN_STATELESS_RESET_RANDLEN
 + 
NGTCP2_STATELESS_RESET_TOKENLEN
) {

1832  
NGTCP2_ERR_INVALID_ARGUMENT
;

1835 
¤
->
¿nd
 = 
p
;

1836 
¤
->
¿ndËn
 = 
·ylßdËn
 - 
NGTCP2_STATELESS_RESET_TOKENLEN
;

1837 
p
 +ğ
¤
->
¿ndËn
;

1838 
¤
->
¡©–ess_»£t_tok’
 = 
p
;

1841 
	}
}

1843 
	$ngtı2_pkt_decode_»Œy
(
ngtı2_pkt_»Œy
 *
de¡
, 
size_t
 
odc
,

1844 cÚ¡ 
ušt8_t
 *
·ylßd
, 
size_t
 
·ylßdËn
) {

1845 
size_t
 
Ën
 = 1 + 
odc
;

1846 cÚ¡ 
ušt8_t
 *
p
 = 
·ylßd
;

1848 ià(
·ylßdËn
 < 
Ën
) {

1849  
NGTCP2_ERR_INVALID_ARGUMENT
;

1852 
	`ngtı2_cid_š™
(&
de¡
->
odcid
, 
p
, 
odc
);

1853 
p
 +ğ
odc
;

1855 
de¡
->
tok’Ën
 = (
size_t
)(
·ylßd
 + 
·ylßdËn
 - 
p
);

1856 ià(
de¡
->
tok’Ën
) {

1857 
de¡
->
tok’
 = 
p
;

1859 
de¡
->
tok’
 = 
NULL
;

1863 
	}
}

1865 
ušt64_t
 
	$ngtı2_pkt_adju¡_pkt_num
(
ušt64_t
 
max_pkt_num
, ušt64_ˆ
pkt_num
,

1866 
size_t
 
n
) {

1867 
ušt64_t
 
k
 =

1868 
max_pkt_num
 =ğ
NGTCP2_MAX_PKT_NUM
 ? max_pkt_num : max_pkt_num + 1;

1869 
ušt64_t
 
u
 = 
k
 & ~((1Îu << 
n
) - 1);

1870 
ušt64_t
 
a
 = 
u
 | 
pkt_num
;

1871 
ušt64_t
 
b
 = (
u
 + (1Îu << 
n
)è| 
pkt_num
;

1872 
ušt64_t
 
a1
 = 
k
 < 
a
 ?‡ - k : k -‡;

1873 
ušt64_t
 
b1
 = 
k
 < 
b
 ? b - k : k - b;

1875 ià(
a1
 < 
b1
) {

1876  
a
;

1878  
b
;

1879 
	}
}

1881 
	$ngtı2_pkt_v®id©e_ack
(
ngtı2_ack
 *
ä
) {

1882 
ušt64_t
 
Ïrge¡_ack
 = 
ä
->largest_ack;

1883 
size_t
 
i
;

1885 ià(
Ïrge¡_ack
 < 
ä
->
fœ¡_ack_blkËn
) {

1886  
NGTCP2_ERR_ACK_FRAME
;

1889 
Ïrge¡_ack
 -ğ
ä
->
fœ¡_ack_blkËn
;

1891 
i
 = 0; i < 
ä
->
num_blks
; ++i) {

1892 ià(
Ïrge¡_ack
 < 
ä
->
blks
[
i
].
g­
 + 2) {

1893  
NGTCP2_ERR_ACK_FRAME
;

1896 
Ïrge¡_ack
 -ğ
ä
->
blks
[
i
].
g­
 + 2;

1898 ià(
Ïrge¡_ack
 < 
ä
->
blks
[
i
].
blkËn
) {

1899  
NGTCP2_ERR_ACK_FRAME
;

1902 
Ïrge¡_ack
 -ğ
ä
->
blks
[
i
].
blkËn
;

1906 
	}
}

1908 
ssize_t
 
	$ngtı2_pkt_wr™e_¡©–ess_»£t
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

1909 
ušt8_t
 *
¡©–ess_»£t_tok’
,

1910 
ušt8_t
 *
¿nd
, 
size_t
 
¿ndËn
) {

1911 
ušt8_t
 *
p
;

1913 ià(
de¡Ën
 < 1 + 
NGTCP2_MIN_STATELESS_RESET_RANDLEN
 +

1914 
NGTCP2_STATELESS_RESET_TOKENLEN
) {

1915  
NGTCP2_ERR_NOBUF
;

1918 ià(
¿ndËn
 < 
NGTCP2_MIN_STATELESS_RESET_RANDLEN
) {

1919  
NGTCP2_ERR_INVALID_ARGUMENT
;

1922 
p
 = 
de¡
;

1924 
¿ndËn
 = 
	`ngtı2_mš
(
de¡Ën
 - 
NGTCP2_STATELESS_RESET_TOKENLEN
,„andlen);

1926 
p
 = 
	`ngtı2_ıymem
Õ, 
¿nd
, 
¿ndËn
);

1927 
p
 = 
	`ngtı2_ıymem
Õ, 
¡©–ess_»£t_tok’
, 
NGTCP2_STATELESS_RESET_TOKENLEN
);

1928 *
de¡
 = (
ušt8_t
)((*dest & 0x7fu) | 0x40u);

1930  
p
 - 
de¡
;

1931 
	}
}

1933 
ssize_t
 
	$ngtı2_pkt_wr™e_»Œy
(
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

1934 cÚ¡ 
ngtı2_pkt_hd
 *
hd
, cÚ¡ 
ngtı2_cid
 *
odcid
,

1935 cÚ¡ 
ušt8_t
 *
tok’
, 
size_t
 
tok’Ën
) {

1936 
ušt8_t
 *
p
;

1937 
ssize_t
 
nwr™e
;

1939 
	`as£¹
(
hd
->
æags
 & 
NGTCP2_PKT_FLAG_LONG_FORM
);

1940 
	`as£¹
(
hd
->
ty³
 =ğ
NGTCP2_PKT_RETRY
);

1944 
	`as£¹
(
odcid
->
d©®’
 == 0 || odcid->datalen > 3);

1945 
	`as£¹
(
tok’Ën
 > 0);

1947 
nwr™e
 = 
	`ngtı2_pkt_’code_hd_lÚg
(
de¡
, 
de¡Ën
, 
hd
);

1948 ià(
nwr™e
 < 0) {

1949  
nwr™e
;

1952 ià(
de¡Ën
 < (
size_t
)
nwr™e
 + 1 + 
odcid
->
d©®’
 + 
tok’Ën
) {

1953  
NGTCP2_ERR_NOBUF
;

1956 
de¡
[0] &= 0xf0;

1958 
p
 = 
de¡
 + 
nwr™e
;

1960 ià(
odcid
->
d©®’
) {

1961 
de¡
[0] |ğ(
ušt8_t
)(
odcid
->
d©®’
 - 3);

1962 
p
 = 
	`ngtı2_ıymem
Õ, 
odcid
->
d©a
, odcid->
d©®’
);

1965 
p
 = 
	`ngtı2_ıymem
Õ, 
tok’
, 
tok’Ën
);

1967  
p
 - 
de¡
;

1968 
	}
}

1970 
	$ngtı2_pkt_hªdshake_pkt
(cÚ¡ 
ngtı2_pkt_hd
 *
hd
) {

1971  (
hd
->
æags
 & 
NGTCP2_PKT_FLAG_LONG_FORM
) &&

1972 (
hd
->
ty³
 =ğ
NGTCP2_PKT_INITIAL
 || hd->ty³ =ğ
NGTCP2_PKT_HANDSHAKE
);

1973 
	}
}

1975 
size_t
 
	$ngtı2_pkt_¡»am_max_d©®’
(
ušt64_t
 
¡»am_id
, ušt64_ˆ
off£t
,

1976 
size_t
 
Ën
, size_ˆ
Ëá
) {

1977 
size_t
 
n
 = 1 + 
	`ngtı2_put_v¬št_Ën
(
¡»am_id
) +

1978 (
off£t
 ? 
	`ngtı2_put_v¬št_Ën
(offset) : 0);

1980 ià(
Ëá
 <ğ
n
) {

1981  (
size_t
)-1;

1984 
Ëá
 -ğ
n
;

1986 ià(
Ëá
 > 8 + 1073741823 && 
Ën
 > 1073741823) {

1987 
Ën
 = 
	`ngtı2_mš
(len, 4611686018427387903lu);

1988  
	`ngtı2_mš
(
Ën
, 
Ëá
 - 8);

1991 ià(
Ëá
 > 4 + 16383 && 
Ën
 > 16383) {

1992 
Ën
 = 
	`ngtı2_mš
(len, 1073741823);

1993  
	`ngtı2_mš
(
Ën
, 
Ëá
 - 4);

1996 ià(
Ëá
 > 2 + 63 && 
Ën
 > 63) {

1997 
Ën
 = 
	`ngtı2_mš
(len, 16383);

1998  
	`ngtı2_mš
(
Ën
, 
Ëá
 - 2);

2001 
Ën
 = 
	`ngtı2_mš
(len, 63);

2002  
	`ngtı2_mš
(
Ën
, 
Ëá
 - 1);

2003 
	}
}

2005 
size_t
 
	$ngtı2_pkt_üy±o_max_d©®’
(
ušt64_t
 
off£t
, 
size_t
 
Ën
, size_ˆ
Ëá
) {

2006 
size_t
 
n
 = 1 + 
	`ngtı2_put_v¬št_Ën
(
off£t
);

2008 ià(
Ëá
 <ğ
n
) {

2009  (
size_t
)-1;

2012 
Ëá
 -ğ
n
;

2014 ià(
Ëá
 > 8 + 1073741823 && 
Ën
 > 1073741823) {

2015 
Ën
 = 
	`ngtı2_mš
(len, 4611686018427387903lu);

2016  
	`ngtı2_mš
(
Ën
, 
Ëá
 - 8);

2019 ià(
Ëá
 > 4 + 16383 && 
Ën
 > 16383) {

2020 
Ën
 = 
	`ngtı2_mš
(len, 1073741823);

2021  
	`ngtı2_mš
(
Ën
, 
Ëá
 - 4);

2024 ià(
Ëá
 > 2 + 63 && 
Ën
 > 63) {

2025 
Ën
 = 
	`ngtı2_mš
(len, 16383);

2026  
	`ngtı2_mš
(
Ën
, 
Ëá
 - 2);

2029 
Ën
 = 
	`ngtı2_mš
(len, 63);

2030  
	`ngtı2_mš
(
Ën
, 
Ëá
 - 1);

2031 
	}
}

2033 
ušt8_t
 
	$ngtı2_pkt_g‘_ty³_lÚg
(
ušt8_t
 
c
) {

2034  (
c
 & 
NGTCP2_LONG_TYPE_MASK
) >> 4;

2035 
	}
}

2037 
	$ngtı2_pkt_v”ify_»£rved_b™s
(
ušt8_t
 
c
) {

2038 ià(
c
 & 
NGTCP2_HEADER_FORM_BIT
) {

2039  (
c
 & 
NGTCP2_LONG_RESERVED_BIT_MASK
è=ğ0 ? 0 : 
NGTCP2_ERR_PROTO
;

2041  (
c
 & 
NGTCP2_SHORT_RESERVED_BIT_MASK
è=ğ0 ? 0 : 
NGTCP2_ERR_PROTO
;

2042 
	}
}

	@lib/ngtcp2_pkt.h

25 #iâdeà
NGTCP2_PKT_H


26 
	#NGTCP2_PKT_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

35 
	#NGTCP2_HEADER_FORM_BIT
 0x80

	)

36 
	#NGTCP2_FIXED_BIT_MASK
 0x40

	)

37 
	#NGTCP2_PKT_NUMLEN_MASK
 0x03

	)

40 
	#NGTCP2_LONG_TYPE_MASK
 0x30

	)

41 
	#NGTCP2_LONG_RESERVED_BIT_MASK
 0x0c

	)

44 
	#NGTCP2_SHORT_SPIN_BIT_MASK
 0x20

	)

45 
	#NGTCP2_SHORT_RESERVED_BIT_MASK
 0x18

	)

46 
	#NGTCP2_SHORT_KEY_PHASE_BIT
 0x04

	)

49 
	#NGTCP2_SR_TYPE
 0x1f

	)

54 
	#NGTCP2_MIN_LONG_HEADERLEN
 (1 + 4 + 1 + 1 + 1)

	)

56 
	#NGTCP2_STREAM_FIN_BIT
 0x01

	)

57 
	#NGTCP2_STREAM_LEN_BIT
 0x02

	)

58 
	#NGTCP2_STREAM_OFF_BIT
 0x04

	)

63 
	#NGTCP2_STREAM_OVERHEAD
 (1 + 8 + 8 + 8)

	)

68 
	#NGTCP2_CRYPTO_OVERHEAD
 (1 + 8 + 8)

	)

71 
	#NGTCP2_MIN_FRAME_PAYLOADLEN
 16

	)

75 
	#NGTCP2_MAX_VARINT
 ((1ULL << 62è- 1)

	)

79 
	#NGTCP2_MAX_ACK_BLKS
 255

	)

82 
	#NGTCP2_MAX_PKT_NUM
 ((1Îu << 62è- 1)

	)

84 
	gngtı2_pkt_chaš
;

85 
ngtı2_pkt_chaš
 
	tngtı2_pkt_chaš
;

90 
	sngtı2_pkt_chaš
 {

91 
ngtı2_pkt_chaš
 *
	mÃxt
;

92 
ušt8_t
 *
	mpkt
;

93 
size_t
 
	mpk’
;

94 
ngtı2_t¡amp
 
	mts
;

108 
ngtı2_pkt_chaš_Ãw
(
ngtı2_pkt_chaš
 **
µc
, cÚ¡ 
ušt8_t
 *
pkt
,

109 
size_t
 
pk’
, 
ngtı2_t¡amp
 
ts
, 
ngtı2_mem
 *
mem
);

115 
ngtı2_pkt_chaš_d–
(
ngtı2_pkt_chaš
 *
pc
, 
ngtı2_mem
 *
mem
);

123 
ngtı2_pkt_hd_š™
(
ngtı2_pkt_hd
 *
hd
, 
ušt8_t
 
æags
, ušt8_ˆ
ty³
,

124 cÚ¡ 
ngtı2_cid
 *
dcid
, cÚ¡‚gtı2_cid *
scid
,

125 
ušt64_t
 
pkt_num
, 
size_t
 
pkt_numËn
, 
ušt32_t
 
v”siÚ
,

126 
size_t
 
Ën
);

137 
ssize_t
 
ngtı2_pkt_’code_hd_lÚg
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

138 cÚ¡ 
ngtı2_pkt_hd
 *
hd
);

149 
ssize_t
 
ngtı2_pkt_’code_hd_shÜt
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

150 cÚ¡ 
ngtı2_pkt_hd
 *
hd
);

160 
size_t
 
ngtı2_pkt_decode_v”siÚ_ÃgÙŸtiÚ
(
ušt32_t
 *
de¡
,

161 cÚ¡ 
ušt8_t
 *
·ylßd
,

162 
size_t
 
·ylßdËn
);

175 
ngtı2_pkt_decode_¡©–ess_»£t
(
ngtı2_pkt_¡©–ess_»£t
 *
¤
,

176 cÚ¡ 
ušt8_t
 *
·ylßd
,

177 
size_t
 
·ylßdËn
);

190 
ngtı2_pkt_decode_»Œy
(
ngtı2_pkt_»Œy
 *
de¡
, 
size_t
 
odc
,

191 cÚ¡ 
ušt8_t
 *
·ylßd
, 
size_t
 
·ylßdËn
);

204 
ssize_t
 
ngtı2_pkt_decode_¡»am_äame
(
ngtı2_¡»am
 *
de¡
,

205 cÚ¡ 
ušt8_t
 *
·ylßd
,

206 
size_t
 
·ylßdËn
);

219 
ssize_t
 
ngtı2_pkt_decode_ack_äame
(
ngtı2_ack
 *
de¡
, cÚ¡ 
ušt8_t
 *
·ylßd
,

220 
size_t
 
·ylßdËn
);

231 
size_t
 
ngtı2_pkt_decode_·ddšg_äame
(
ngtı2_·ddšg
 *
de¡
,

232 cÚ¡ 
ušt8_t
 *
·ylßd
,

233 
size_t
 
·ylßdËn
);

247 
ssize_t
 
ngtı2_pkt_decode_»£t_¡»am_äame
(
ngtı2_»£t_¡»am
 *
de¡
,

248 cÚ¡ 
ušt8_t
 *
·ylßd
,

249 
size_t
 
·ylßdËn
);

263 
ssize_t
 
ngtı2_pkt_decode_cÚÃùiÚ_şo£_äame
(
ngtı2_cÚÃùiÚ_şo£
 *
de¡
,

264 cÚ¡ 
ušt8_t
 *
·ylßd
,

265 
size_t
 
·ylßdËn
);

278 
ssize_t
 
ngtı2_pkt_decode_max_d©a_äame
(
ngtı2_max_d©a
 *
de¡
,

279 cÚ¡ 
ušt8_t
 *
·ylßd
,

280 
size_t
 
·ylßdËn
);

294 
ssize_t
 
ngtı2_pkt_decode_max_¡»am_d©a_äame
(
ngtı2_max_¡»am_d©a
 *
de¡
,

295 cÚ¡ 
ušt8_t
 *
·ylßd
,

296 
size_t
 
·ylßdËn
);

309 
ssize_t
 
ngtı2_pkt_decode_max_¡»ams_äame
(
ngtı2_max_¡»ams
 *
de¡
,

310 cÚ¡ 
ušt8_t
 *
·ylßd
,

311 
size_t
 
·ylßdËn
);

324 
ssize_t
 
ngtı2_pkt_decode_pšg_äame
(
ngtı2_pšg
 *
de¡
, cÚ¡ 
ušt8_t
 *
·ylßd
,

325 
size_t
 
·ylßdËn
);

339 
ssize_t
 
ngtı2_pkt_decode_d©a_blocked_äame
(
ngtı2_d©a_blocked
 *
de¡
,

340 cÚ¡ 
ušt8_t
 *
·ylßd
,

341 
size_t
 
·ylßdËn
);

355 
ssize_t


356 
ngtı2_pkt_decode_¡»am_d©a_blocked_äame
(
ngtı2_¡»am_d©a_blocked
 *
de¡
,

357 cÚ¡ 
ušt8_t
 *
·ylßd
,

358 
size_t
 
·ylßdËn
);

372 
ssize_t
 
ngtı2_pkt_decode_¡»ams_blocked_äame
(
ngtı2_¡»ams_blocked
 *
de¡
,

373 cÚ¡ 
ušt8_t
 *
·ylßd
,

374 
size_t
 
·ylßdËn
);

390 
ssize_t
 
ngtı2_pkt_decode_Ãw_cÚÃùiÚ_id_äame
(

391 
ngtı2_Ãw_cÚÃùiÚ_id
 *
de¡
, cÚ¡ 
ušt8_t
 *
·ylßd
, 
size_t
 
·ylßdËn
);

405 
ssize_t
 
ngtı2_pkt_decode_¡İ_£ndšg_äame
(
ngtı2_¡İ_£ndšg
 *
de¡
,

406 cÚ¡ 
ušt8_t
 *
·ylßd
,

407 
size_t
 
·ylßdËn
);

421 
ssize_t
 
ngtı2_pkt_decode_·th_ch®Ënge_äame
(
ngtı2_·th_ch®Ënge
 *
de¡
,

422 cÚ¡ 
ušt8_t
 *
·ylßd
,

423 
size_t
 
·ylßdËn
);

437 
ssize_t
 
ngtı2_pkt_decode_·th_»¥Ú£_äame
(
ngtı2_·th_»¥Ú£
 *
de¡
,

438 cÚ¡ 
ušt8_t
 *
·ylßd
,

439 
size_t
 
·ylßdËn
);

452 
ssize_t
 
ngtı2_pkt_decode_üy±o_äame
(
ngtı2_üy±o
 *
de¡
,

453 cÚ¡ 
ušt8_t
 *
·ylßd
,

454 
size_t
 
·ylßdËn
);

467 
ssize_t
 
ngtı2_pkt_decode_Ãw_tok’_äame
(
ngtı2_Ãw_tok’
 *
de¡
,

468 cÚ¡ 
ušt8_t
 *
·ylßd
,

469 
size_t
 
·ylßdËn
);

482 
ssize_t


483 
ngtı2_pkt_decode_»tœe_cÚÃùiÚ_id_äame
(
ngtı2_»tœe_cÚÃùiÚ_id
 *
de¡
,

484 cÚ¡ 
ušt8_t
 *
·ylßd
,

485 
size_t
 
·ylßdËn
);

500 
ssize_t
 
ngtı2_pkt_’code_¡»am_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

501 
ngtı2_¡»am
 *
ä
);

516 
ssize_t
 
ngtı2_pkt_’code_ack_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

517 
ngtı2_ack
 *
ä
);

531 
ssize_t
 
ngtı2_pkt_’code_·ddšg_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

532 cÚ¡ 
ngtı2_·ddšg
 *
ä
);

544 
ssize_t
 
ngtı2_pkt_’code_»£t_¡»am_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

545 cÚ¡ 
ngtı2_»£t_¡»am
 *
ä
);

557 
ssize_t


558 
ngtı2_pkt_’code_cÚÃùiÚ_şo£_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

559 cÚ¡ 
ngtı2_cÚÃùiÚ_şo£
 *
ä
);

571 
ssize_t
 
ngtı2_pkt_’code_max_d©a_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

572 cÚ¡ 
ngtı2_max_d©a
 *
ä
);

584 
ssize_t


585 
ngtı2_pkt_’code_max_¡»am_d©a_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

586 cÚ¡ 
ngtı2_max_¡»am_d©a
 *
ä
);

598 
ssize_t
 
ngtı2_pkt_’code_max_¡»ams_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

599 cÚ¡ 
ngtı2_max_¡»ams
 *
ä
);

611 
ssize_t
 
ngtı2_pkt_’code_pšg_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

612 cÚ¡ 
ngtı2_pšg
 *
ä
);

624 
ssize_t
 
ngtı2_pkt_’code_d©a_blocked_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

625 cÚ¡ 
ngtı2_d©a_blocked
 *
ä
);

638 
ssize_t
 
ngtı2_pkt_’code_¡»am_d©a_blocked_äame
(

639 
ušt8_t
 *
out
, 
size_t
 
ou’
, cÚ¡ 
ngtı2_¡»am_d©a_blocked
 *
ä
);

651 
ssize_t


652 
ngtı2_pkt_’code_¡»ams_blocked_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

653 cÚ¡ 
ngtı2_¡»ams_blocked
 *
ä
);

665 
ssize_t


666 
ngtı2_pkt_’code_Ãw_cÚÃùiÚ_id_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

667 cÚ¡ 
ngtı2_Ãw_cÚÃùiÚ_id
 *
ä
);

679 
ssize_t
 
ngtı2_pkt_’code_¡İ_£ndšg_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

680 cÚ¡ 
ngtı2_¡İ_£ndšg
 *
ä
);

692 
ssize_t
 
ngtı2_pkt_’code_·th_ch®Ënge_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

693 cÚ¡ 
ngtı2_·th_ch®Ënge
 *
ä
);

705 
ssize_t
 
ngtı2_pkt_’code_·th_»¥Ú£_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

706 cÚ¡ 
ngtı2_·th_»¥Ú£
 *
ä
);

718 
ssize_t
 
ngtı2_pkt_’code_üy±o_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

719 cÚ¡ 
ngtı2_üy±o
 *
ä
);

731 
ssize_t
 
ngtı2_pkt_’code_Ãw_tok’_äame
(
ušt8_t
 *
out
, 
size_t
 
ou’
,

732 cÚ¡ 
ngtı2_Ãw_tok’
 *
ä
);

744 
ssize_t
 
ngtı2_pkt_’code_»tœe_cÚÃùiÚ_id_äame
(

745 
ušt8_t
 *
out
, 
size_t
 
ou’
, cÚ¡ 
ngtı2_»tœe_cÚÃùiÚ_id
 *
ä
);

753 
ušt64_t
 
ngtı2_pkt_adju¡_pkt_num
(ušt64_ˆ
max_pkt_num
, ušt64_ˆ
pkt_num
,

754 
size_t
 
n
);

760 
ngtı2_pkt_adju¡_ack_pkt_num
(
ngtı2_ack
 *
ack
, 
ušt64_t
 
max_pkt_num
);

771 
ngtı2_pkt_v®id©e_ack
(
ngtı2_ack
 *
ä
);

777 
ngtı2_pkt_hªdshake_pkt
(cÚ¡ 
ngtı2_pkt_hd
 *
hd
);

786 
size_t
 
ngtı2_pkt_¡»am_max_d©®’
(
ušt64_t
 
¡»am_id
, ušt64_ˆ
off£t
,

787 
size_t
 
Ën
, size_ˆ
Ëá
);

796 
size_t
 
ngtı2_pkt_üy±o_max_d©®’
(
ušt64_t
 
off£t
, size_ˆ
Ën
, size_ˆ
Ëá
);

808 
ngtı2_pkt_v”ify_»£rved_b™s
(
ušt8_t
 
c
);

	@lib/ngtcp2_ppe.c

25 
	~"ngtı2_µe.h
"

27 
	~<¡ršg.h
>

28 
	~<as£¹.h
>

30 
	~"ngtı2_pkt.h
"

31 
	~"ngtı2_¡r.h
"

32 
	~"ngtı2_cÚv.h
"

33 
	~"ngtı2_cÚn.h
"

34 
	~"ngtı2_maüo.h
"

36 
	$ngtı2_µe_š™
(
ngtı2_µe
 *
µe
, 
ušt8_t
 *
out
, 
size_t
 
ou’
,

37 
ngtı2_üy±o_ùx
 *
cùx
) {

38 
	`ngtı2_buf_š™
(&
µe
->
buf
, 
out
, 
ou’
);

40 
µe
->
hdËn
 = 0;

41 
µe
->
Ën_off£t
 = 0;

42 
µe
->
pkt_num_off£t
 = 0;

43 
µe
->
pkt_numËn
 = 0;

44 
µe
->
pkt_num
 = 0;

45 
µe
->
§m¶e_off£t
 = 0;

46 
µe
->
ùx
 = 
cùx
;

47 
	}
}

49 
	$ngtı2_µe_’code_hd
(
ngtı2_µe
 *
µe
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
) {

50 
ssize_t
 
rv
;

51 
ngtı2_buf
 *
buf
 = &
µe
->buf;

52 
ngtı2_üy±o_ùx
 *
ùx
 = 
µe
->ctx;

54 ià(
	`ngtı2_buf_Ëá
(
buf
è< 
ùx
->
«ad_ov”h—d
) {

55  
NGTCP2_ERR_NOBUF
;

58 ià(
hd
->
æags
 & 
NGTCP2_PKT_FLAG_LONG_FORM
) {

59 
µe
->
Ën_off£t
 = 1 + 4 + 1 + 
hd
->
dcid
.
d©®’
 + hd->
scid
.datalen;

60 ià(
hd
->
ty³
 =ğ
NGTCP2_PKT_INITIAL
) {

61 
µe
->
Ën_off£t
 +ğ
	`ngtı2_put_v¬št_Ën
(
hd
->
tok’Ën
) + hd->tokenlen;

63 
µe
->
pkt_num_off£t
 =…³->
Ën_off£t
 + 2;

64 
rv
 = 
	`ngtı2_pkt_’code_hd_lÚg
(

65 
buf
->
Ï¡
, 
	`ngtı2_buf_Ëá
(bufè- 
ùx
->
«ad_ov”h—d
, 
hd
);

67 
µe
->
pkt_num_off£t
 = 1 + 
hd
->
dcid
.
d©®’
;

68 
rv
 = 
	`ngtı2_pkt_’code_hd_shÜt
(

69 
buf
->
Ï¡
, 
	`ngtı2_buf_Ëá
(bufè- 
ùx
->
«ad_ov”h—d
, 
hd
);

71 ià(
rv
 < 0) {

72  ()
rv
;

75 
µe
->
§m¶e_off£t
 =…³->
pkt_num_off£t
 + 4;

77 
buf
->
Ï¡
 +ğ
rv
;

79 
µe
->
pkt_numËn
 = 
hd
->pkt_numlen;

80 
µe
->
hdËn
 = (
size_t
)
rv
;

82 
µe
->
pkt_num
 = 
hd
->pkt_num;

85 
	}
}

87 
	$ngtı2_µe_’code_äame
(
ngtı2_µe
 *
µe
, 
ngtı2_äame
 *
ä
) {

88 
ssize_t
 
rv
;

89 
ngtı2_buf
 *
buf
 = &
µe
->buf;

90 
ngtı2_üy±o_ùx
 *
ùx
 = 
µe
->ctx;

92 ià(
	`ngtı2_buf_Ëá
(
buf
è< 
ùx
->
«ad_ov”h—d
) {

93  
NGTCP2_ERR_NOBUF
;

96 
rv
 = 
	`ngtı2_pkt_’code_äame
(
buf
->
Ï¡
,

97 
	`ngtı2_buf_Ëá
(
buf
è- 
ùx
->
«ad_ov”h—d
, 
ä
);

98 ià(
rv
 < 0) {

99  ()
rv
;

102 
buf
->
Ï¡
 +ğ
rv
;

105 
	}
}

107 
ssize_t
 
	$ngtı2_µe_fš®
(
ngtı2_µe
 *
µe
, cÚ¡ 
ušt8_t
 **
µkt
) {

108 
ssize_t
 
nwr™e
;

109 
ngtı2_buf
 *
buf
 = &
µe
->buf;

110 
ngtı2_üy±o_ùx
 *
ùx
 = 
µe
->ctx;

111 
ngtı2_cÚn
 *
cÚn
 = 
ùx
->
u£r_d©a
;

112 
ušt8_t
 *
·ylßd
 = 
buf
->
begš
 + 
µe
->
hdËn
;

113 
size_t
 
·ylßdËn
 = 
	`ngtı2_buf_Ën
(
buf
è- 
µe
->
hdËn
;

114 
size_t
 
de¡Ën
 = (size_t)(
buf
->
’d
 - buf->
begš
è- 
µe
->
hdËn
;

115 
ušt8_t
 
mask
[
NGTCP2_HP_SAMPLELEN
];

116 
ušt8_t
 *
p
;

117 
size_t
 
i
;

119 
	`as£¹
(
µe
->
ùx
->
’üy±
);

120 
	`as£¹
(
µe
->
ùx
->
hp_mask
);

122 ià(
µe
->
Ën_off£t
) {

123 
	`ngtı2_put_v¬št14
(

124 
buf
->
begš
 + 
µe
->
Ën_off£t
,

125 (
ušt16_t
)(
·ylßdËn
 + 
µe
->
pkt_numËn
 + 
ùx
->
«ad_ov”h—d
));

128 
	`ngtı2_üy±o_ü—‹_nÚû
(
µe
->
nÚû
, 
ùx
->
ckm
->
iv
.
ba£
, ctx->ckm->iv.
Ën
,

129 
µe
->
pkt_num
);

131 
nwr™e
 = 
µe
->
ùx
->
	`’üy±
(
cÚn
, 
·ylßd
, 
de¡Ën
,…aylßd, 
·ylßdËn
,

132 
ùx
->
ckm
->
key
.
ba£
, ctx->ckm->key.
Ën
, 
µe
->
nÚû
,

133 
ùx
->
ckm
->
iv
.
Ën
, 
buf
->
begš
, 
µe
->
hdËn
,

134 
cÚn
->
u£r_d©a
);

135 ià(
nwr™e
 < 0) {

136  
NGTCP2_ERR_CALLBACK_FAILURE
;

139 
buf
->
Ï¡
 = 
·ylßd
 + 
nwr™e
;

142 
	`as£¹
(
µe
->
§m¶e_off£t
 + 
NGTCP2_HP_SAMPLELEN
 <ğ
	`ngtı2_buf_Ën
(
buf
));

144 
nwr™e
 = 
µe
->
ùx
->
	`hp_mask
(
cÚn
, 
mask
, (mask), ctx->
hp
->
ba£
,

145 
ùx
->
hp
->
Ën
, 
buf
->
begš
 + 
µe
->
§m¶e_off£t
,

146 
NGTCP2_HP_SAMPLELEN
, 
cÚn
->
u£r_d©a
);

147 ià(
nwr™e
 < 
NGTCP2_HP_MASKLEN
) {

148  
NGTCP2_ERR_CALLBACK_FAILURE
;

151 
p
 = 
buf
->
begš
;

152 ià(*
p
 & 
NGTCP2_HEADER_FORM_BIT
) {

153 *
p
 = (
ušt8_t
)(*°^ (
mask
[0] & 0x0f));

155 *
p
 = (
ušt8_t
)(*°^ (
mask
[0] & 0x1f));

158 
p
 = 
buf
->
begš
 + 
µe
->
pkt_num_off£t
;

159 
i
 = 0; i < 
µe
->
pkt_numËn
; ++i) {

160 *(
p
 + 
i
è^ğ
mask
[i + 1];

163 ià(
µkt
 !ğ
NULL
) {

164 *
µkt
 = 
buf
->
begš
;

167  (
ssize_t
)
	`ngtı2_buf_Ën
(
buf
);

168 
	}
}

170 
size_t
 
	$ngtı2_µe_Ëá
(
ngtı2_µe
 *
µe
) {

171 
ngtı2_üy±o_ùx
 *
ùx
 = 
µe
->ctx;

173 ià(
	`ngtı2_buf_Ëá
(&
µe
->
buf
è< 
ùx
->
«ad_ov”h—d
) {

177  
	`ngtı2_buf_Ëá
(&
µe
->
buf
è- 
ùx
->
«ad_ov”h—d
;

178 
	}
}

180 
size_t
 
	$ngtı2_µe_·ddšg
(
ngtı2_µe
 *
µe
) {

181 
ngtı2_üy±o_ùx
 *
ùx
 = 
µe
->ctx;

182 
ngtı2_buf
 *
buf
 = &
µe
->buf;

183 
size_t
 
Ën
;

185 
	`as£¹
(
	`ngtı2_buf_Ëá
(
buf
è>ğ
ùx
->
«ad_ov”h—d
);

187 
Ën
 = 
	`ngtı2_buf_Ëá
(
buf
è- 
ùx
->
«ad_ov”h—d
;

188 
	`mem£t
(
buf
->
Ï¡
, 0, 
Ën
);

189 
buf
->
Ï¡
 +ğ
Ën
;

191  
Ën
;

192 
	}
}

194 
size_t
 
	$ngtı2_µe_·ddšg_hp_§m¶e
(
ngtı2_µe
 *
µe
) {

195 
ngtı2_üy±o_ùx
 *
ùx
 = 
µe
->ctx;

196 
ngtı2_buf
 *
buf
 = &
µe
->buf;

197 
size_t
 
max_§m¶–’
;

198 
size_t
 
Ën
 = 0;

200 
max_§m¶–’
 = 
	`ngtı2_buf_Ën
(
buf
è+ 
ùx
->
«ad_ov”h—d
 - 
µe
->
§m¶e_off£t
;

201 ià(
max_§m¶–’
 < 
NGTCP2_HP_SAMPLELEN
) {

202 
Ën
 = 
NGTCP2_HP_SAMPLELEN
 - 
max_§m¶–’
;

203 
	`as£¹
(
	`ngtı2_µe_Ëá
(
µe
è>ğ
Ën
);

204 
	`mem£t
(
buf
->
Ï¡
, 0, 
Ën
);

205 
buf
->
Ï¡
 +ğ
Ën
;

208  
Ën
;

209 
	}
}

211 
	$ngtı2_µe_’su»_hp_§m¶e
(
ngtı2_µe
 *
µe
) {

212 
ngtı2_buf
 *
buf
 = &
µe
->buf;

213  
	`ngtı2_buf_Ëá
(
buf
è>ğ(4 - 
µe
->
pkt_numËn
è+ 
NGTCP2_HP_SAMPLELEN
;

214 
	}
}

	@lib/ngtcp2_ppe.h

25 #iâdeà
NGTCP2_PPE_H


26 
	#NGTCP2_PPE_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

34 
	~"ngtı2_buf.h
"

35 
	~"ngtı2_üy±o.h
"

41 
ngtı2_buf
 
	mbuf
;

42 
ngtı2_üy±o_ùx
 *
	mùx
;

44 
size_t
 
	mhdËn
;

46 
size_t
 
	mËn_off£t
;

48 
size_t
 
	mpkt_num_off£t
;

51 
size_t
 
	mpkt_numËn
;

54 
size_t
 
	m§m¶e_off£t
;

56 
ušt64_t
 
	mpkt_num
;

59 
ušt8_t
 
	mnÚû
[32];

60 } 
	tngtı2_µe
;

65 
ngtı2_µe_š™
(
ngtı2_µe
 *
µe
, 
ušt8_t
 *
out
, 
size_t
 
ou’
,

66 
ngtı2_üy±o_ùx
 *
cùx
);

77 
ngtı2_µe_’code_hd
(
ngtı2_µe
 *
µe
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
);

88 
ngtı2_µe_’code_äame
(
ngtı2_µe
 *
µe
, 
ngtı2_äame
 *
ä
);

101 
ssize_t
 
ngtı2_µe_fš®
(
ngtı2_µe
 *
µe
, cÚ¡ 
ušt8_t
 **
µkt
);

107 
size_t
 
ngtı2_µe_Ëá
(
ngtı2_µe
 *
µe
);

115 
size_t
 
ngtı2_µe_·ddšg
(
ngtı2_µe
 *
µe
);

125 
size_t
 
ngtı2_µe_·ddšg_hp_§m¶e
(
ngtı2_µe
 *
µe
);

132 
ngtı2_µe_’su»_hp_§m¶e
(
ngtı2_µe
 *
µe
);

	@lib/ngtcp2_pq.c

26 
	~"ngtı2_pq.h
"

28 
	~<as£¹.h
>

30 
	~"ngtı2_maüo.h
"

32 
	$ngtı2_pq_š™
(
ngtı2_pq
 *
pq
, 
ngtı2_Ëss
 
Ëss
, 
ngtı2_mem
 *
mem
) {

33 
pq
->
mem
 = mem;

34 
pq
->
ÿ·c™y
 = 0;

35 
pq
->
q
 = 
NULL
;

36 
pq
->
Ëngth
 = 0;

37 
pq
->
Ëss
 =†ess;

38 
	}
}

40 
	$ngtı2_pq_ä“
(
ngtı2_pq
 *
pq
) {

41 
	`ngtı2_mem_ä“
(
pq
->
mem
,…q->
q
);

42 
pq
->
q
 = 
NULL
;

43 
	}
}

45 
	$sw­
(
ngtı2_pq
 *
pq
, 
size_t
 
i
, size_ˆ
j
) {

46 
ngtı2_pq_’Œy
 *
a
 = 
pq
->
q
[
i
];

47 
ngtı2_pq_’Œy
 *
b
 = 
pq
->
q
[
j
];

49 
pq
->
q
[
i
] = 
b
;

50 
b
->
šdex
 = 
i
;

51 
pq
->
q
[
j
] = 
a
;

52 
a
->
šdex
 = 
j
;

53 
	}
}

55 
	$bubbË_up
(
ngtı2_pq
 *
pq
, 
size_t
 
šdex
) {

56 
size_t
 
·»Á
;

57 
šdex
 != 0) {

58 
·»Á
 = (
šdex
 - 1) / 2;

59 ià(!
pq
->
	`Ëss
Õq->
q
[
šdex
],…q->q[
·»Á
])) {

62 
	`sw­
(
pq
, 
·»Á
, 
šdex
);

63 
šdex
 = 
·»Á
;

65 
	}
}

67 
	$ngtı2_pq_push
(
ngtı2_pq
 *
pq
, 
ngtı2_pq_’Œy
 *
™em
) {

68 ià(
pq
->
ÿ·c™y
 <ğpq->
Ëngth
) {

69 *
nq
;

70 
size_t
 
nÿ·c™y
;

72 
nÿ·c™y
 = 
	`ngtı2_max
(4, (
pq
->
ÿ·c™y
 * 2));

74 
nq
 = 
	`ngtı2_mem_»®loc
(
pq
->
mem
,…q->
q
,

75 
nÿ·c™y
 * (
ngtı2_pq_’Œy
 *));

76 ià(
nq
 =ğ
NULL
) {

77  
NGTCP2_ERR_NOMEM
;

79 
pq
->
ÿ·c™y
 = 
nÿ·c™y
;

80 
pq
->
q
 = 
nq
;

82 
pq
->
q
[pq->
Ëngth
] = 
™em
;

83 
™em
->
šdex
 = 
pq
->
Ëngth
;

84 ++
pq
->
Ëngth
;

85 
	`bubbË_up
(
pq
,…q->
Ëngth
 - 1);

87 
	}
}

89 
ngtı2_pq_’Œy
 *
	$ngtı2_pq_tİ
(
ngtı2_pq
 *
pq
) {

90 
	`as£¹
(
pq
->
Ëngth
);

91  
pq
->
q
[0];

92 
	}
}

94 
	$bubbË_down
(
ngtı2_pq
 *
pq
, 
size_t
 
šdex
) {

95 
size_t
 
i
, 
j
, 
mššdex
;

97 
j
 = 
šdex
 * 2 + 1;

98 
mššdex
 = 
šdex
;

99 
i
 = 0; i < 2; ++i, ++
j
) {

100 ià(
j
 >ğ
pq
->
Ëngth
) {

103 ià(
pq
->
	`Ëss
Õq->
q
[
j
],…q->q[
mššdex
])) {

104 
mššdex
 = 
j
;

107 ià(
mššdex
 =ğ
šdex
) {

110 
	`sw­
(
pq
, 
šdex
, 
mššdex
);

111 
šdex
 = 
mššdex
;

113 
	}
}

115 
	$ngtı2_pq_pİ
(
ngtı2_pq
 *
pq
) {

116 ià(
pq
->
Ëngth
 > 0) {

117 
pq
->
q
[0] =…q->q[pq->
Ëngth
 - 1];

118 
pq
->
q
[0]->
šdex
 = 0;

119 --
pq
->
Ëngth
;

120 
	`bubbË_down
(
pq
, 0);

122 
	}
}

124 
	$ngtı2_pq_»move
(
ngtı2_pq
 *
pq
, 
ngtı2_pq_’Œy
 *
™em
) {

125 
	`as£¹
(
pq
->
q
[
™em
->
šdex
] == item);

127 ià(
™em
->
šdex
 == 0) {

128 
	`ngtı2_pq_pİ
(
pq
);

132 ià(
™em
->
šdex
 =ğ
pq
->
Ëngth
 - 1) {

133 --
pq
->
Ëngth
;

137 
pq
->
q
[
™em
->
šdex
] =…q->q[pq->
Ëngth
 - 1];

138 
pq
->
q
[
™em
->
šdex
]->index = item->index;

139 --
pq
->
Ëngth
;

141 ià(
pq
->
	`Ëss
(
™em
,…q->
q
[™em->
šdex
])) {

142 
	`bubbË_down
(
pq
, 
™em
->
šdex
);

144 
	`bubbË_up
(
pq
, 
™em
->
šdex
);

146 
	}
}

148 
	$ngtı2_pq_em±y
(
ngtı2_pq
 *
pq
è{ …q->
Ëngth
 =ğ0; 
	}
}

150 
size_t
 
	$ngtı2_pq_size
(
ngtı2_pq
 *
pq
è{ …q->
Ëngth
; 
	}
}

152 
	$ngtı2_pq_—ch
(
ngtı2_pq
 *
pq
, 
ngtı2_pq_™em_cb
 
fun
, *
¬g
) {

153 
size_t
 
i
;

155 ià(
pq
->
Ëngth
 == 0) {

158 
i
 = 0; i < 
pq
->
Ëngth
; ++i) {

159 ià((*
fun
)(
pq
->
q
[
i
], 
¬g
)) {

164 
	}
}

	@lib/ngtcp2_pq.h

26 #iâdeà
NGTCP2_PQ_H


27 
	#NGTCP2_PQ_H


	)

29 #ifdeà
HAVE_CONFIG_H


30 
	~<cÚfig.h
>

33 
	~<ngtı2/ngtı2.h
>

35 
	~"ngtı2_mem.h
"

42 
	#NGTCP2_PQ_BAD_INDEX
 
SIZE_MAX


	)

45 
size_t
 
	mšdex
;

46 } 
	tngtı2_pq_’Œy
;

49 (*
	tngtı2_Ëss
)(cÚ¡ 
	tngtı2_pq_’Œy
 *
	tlhs
,

50 cÚ¡ 
	tngtı2_pq_’Œy
 *
	trhs
);

54 
ngtı2_pq_’Œy
 **
q
;

56 
ngtı2_mem
 *
mem
;

58 
size_t
 
Ëngth
;

61 
size_t
 
ÿ·c™y
;

63 
ngtı2_Ëss
 
Ëss
;

64 } 
	tngtı2_pq
;

69 
	`ngtı2_pq_š™
(
ngtı2_pq
 *
pq
, 
ngtı2_Ëss
 
Ëss
, 
ngtı2_mem
 *
mem
);

75 
	`ngtı2_pq_ä“
(
ngtı2_pq
 *
pq
);

86 
	`ngtı2_pq_push
(
ngtı2_pq
 *
pq
, 
ngtı2_pq_’Œy
 *
™em
);

92 
ngtı2_pq_’Œy
 *
	`ngtı2_pq_tİ
(
ngtı2_pq
 *
pq
);

98 
	`ngtı2_pq_pİ
(
ngtı2_pq
 *
pq
);

103 
	`ngtı2_pq_em±y
(
ngtı2_pq
 *
pq
);

108 
size_t
 
	`ngtı2_pq_size
(
ngtı2_pq
 *
pq
);

110 (*
	tngtı2_pq_™em_cb
)(
	tngtı2_pq_’Œy
 *
	t™em
, *
	t¬g
);

119 
	`ngtı2_pq_—ch
(
ngtı2_pq
 *
pq
, 
ngtı2_pq_™em_cb
 
fun
, *
¬g
);

124 
	`ngtı2_pq_»move
(
ngtı2_pq
 *
pq
, 
ngtı2_pq_’Œy
 *
™em
);

	@lib/ngtcp2_psl.c

25 
	~"ngtı2_p¦.h
"

27 
	~<¡dlib.h
>

28 
	~<¡ršg.h
>

29 
	~<as£¹.h
>

30 
	~<¡dio.h
>

32 
	~"ngtı2_maüo.h
"

33 
	~"ngtı2_mem.h
"

35 
	$ngtı2_p¦_š™
(
ngtı2_p¦
 *
p¦
, 
ngtı2_mem
 *
mem
) {

36 
ngtı2_p¦_blk
 *
h—d
;

38 
p¦
->
mem
 = mem;

39 
p¦
->
h—d
 = 
	`ngtı2_mem_m®loc
(
mem
, (
ngtı2_p¦_blk
));

40 ià(!
p¦
->
h—d
) {

41  
NGTCP2_ERR_NOMEM
;

43 
p¦
->
äÚt
 =…¦->
h—d
;

44 
p¦
->
n
 = 0;

46 
h—d
 = 
p¦
->head;

48 
h—d
->
Ãxt
 = 
NULL
;

49 
h—d
->
n
 = 1;

50 
h—d
->
Ëaf
 = 1;

51 
h—d
->
nodes
[0].
¿nge
.
begš
 = 
UINT64_MAX
;

52 
h—d
->
nodes
[0].
¿nge
.
’d
 = 
UINT64_MAX
;

53 
h—d
->
nodes
[0].
d©a
 = 
NULL
;

56 
	}
}

61 
	$ä“_blk
(
ngtı2_p¦_blk
 *
blk
, 
ngtı2_mem
 *
mem
) {

62 
size_t
 
i
;

64 ià(!
blk
->
Ëaf
) {

65 
i
 = 0; i < 
blk
->
n
; ++i) {

66 
	`ä“_blk
(
blk
->
nodes
[
i
].blk, 
mem
);

70 
	`ngtı2_mem_ä“
(
mem
, 
blk
);

71 
	}
}

73 
	$ngtı2_p¦_ä“
(
ngtı2_p¦
 *
p¦
) {

74 ià(!
p¦
) {

78 
	`ä“_blk
(
p¦
->
h—d
,…¦->
mem
);

79 
	}
}

89 
ngtı2_p¦_blk
 *
	$p¦_¥l™_blk
(
ngtı2_p¦
 *
p¦
, 
ngtı2_p¦_blk
 *
blk
) {

90 
ngtı2_p¦_blk
 *
rblk
;

92 
rblk
 = 
	`ngtı2_mem_m®loc
(
p¦
->
mem
, (
ngtı2_p¦_blk
));

93 ià(
rblk
 =ğ
NULL
) {

94  
NULL
;

97 
rblk
->
Ãxt
 = 
blk
->next;

98 
blk
->
Ãxt
 = 
rblk
;

99 
rblk
->
Ëaf
 = 
blk
->leaf;

101 
rblk
->
n
 = 
blk
->n / 2;

103 
	`memıy
(
rblk
->
nodes
, &
blk
->nodes[blk->
n
 -„blk->n],

104 (
ngtı2_p¦_node
è* 
rblk
->
n
);

106 
blk
->
n
 -ğ
rblk
->n;

108 
	`as£¹
(
blk
->
n
 >ğ
NGTCP2_PSL_MIN_NBLK
);

109 
	`as£¹
(
rblk
->
n
 >ğ
NGTCP2_PSL_MIN_NBLK
);

111  
rblk
;

112 
	}
}

125 
	$p¦_¥l™_node
(
ngtı2_p¦
 *
p¦
, 
ngtı2_p¦_blk
 *
blk
, 
size_t
 
i
) {

126 
ngtı2_p¦_blk
 *
lblk
 = 
blk
->
nodes
[
i
].blk, *
rblk
;

128 
rblk
 = 
	`p¦_¥l™_blk
(
p¦
, 
lblk
);

129 ià(
rblk
 =ğ
NULL
) {

130  
NGTCP2_ERR_NOMEM
;

133 
	`memmove
(&
blk
->
nodes
[
i
 + 2], &blk->nodes[i + 1],

134 (
ngtı2_p¦_node
è* (
blk
->
n
 - (
i
 + 1)));

136 
blk
->
nodes
[
i
 + 1].blk = 
rblk
;

138 ++
blk
->
n
;

140 
blk
->
nodes
[
i
].
¿nge
 = 
lblk
->nodes[lblk->
n
 - 1].range;

141 
blk
->
nodes
[
i
 + 1].
¿nge
 = 
rblk
->nodes[rblk->
n
 - 1].range;

144 
	}
}

156 
	$p¦_¥l™_h—d
(
ngtı2_p¦
 *
p¦
) {

157 
ngtı2_p¦_blk
 *
rblk
 = 
NULL
, *
lblk
, *
nh—d
 = NULL;

159 
rblk
 = 
	`p¦_¥l™_blk
(
p¦
,…¦->
h—d
);

160 ià(
rblk
 =ğ
NULL
) {

161  
NGTCP2_ERR_NOMEM
;

164 
lblk
 = 
p¦
->
h—d
;

166 
nh—d
 = 
	`ngtı2_mem_m®loc
(
p¦
->
mem
, (
ngtı2_p¦_blk
));

167 ià(
nh—d
 =ğ
NULL
) {

168 
	`ngtı2_mem_ä“
(
p¦
->
mem
, 
rblk
);

169  
NGTCP2_ERR_NOMEM
;

171 
nh—d
->
Ãxt
 = 
NULL
;

172 
nh—d
->
n
 = 2;

173 
nh—d
->
Ëaf
 = 0;

175 
nh—d
->
nodes
[0].
¿nge
 = 
lblk
->nodes[lblk->
n
 - 1].range;

176 
nh—d
->
nodes
[0].
blk
 = 
lblk
;

177 
nh—d
->
nodes
[1].
¿nge
 = 
rblk
->nodes[rblk->
n
 - 1].range;

178 
nh—d
->
nodes
[1].
blk
 = 
rblk
;

180 
p¦
->
h—d
 = 
nh—d
;

183 
	}
}

191 
	$š£¹_node
(
ngtı2_p¦_blk
 *
blk
, 
size_t
 
i
,

192 cÚ¡ 
ngtı2_¿nge
 *
¿nge
, *
d©a
) {

193 
ngtı2_p¦_node
 *
node
;

195 
	`as£¹
(
blk
->
n
 < 
NGTCP2_PSL_MAX_NBLK
);

197 
	`memmove
(&
blk
->
nodes
[
i
 + 1], &blk->nodes[i],

198 (
ngtı2_p¦_node
è* (
blk
->
n
 - 
i
));

200 
node
 = &
blk
->
nodes
[
i
];

201 
node
->
¿nge
 = *range;

202 
node
->
d©a
 = data;

204 ++
blk
->
n
;

205 
	}
}

207 
	$¿nge_š‹r£ù
(cÚ¡ 
ngtı2_¿nge
 *
a
, cÚ¡‚gtı2_¿ng*
b
) {

208  
	`ngtı2_max
(
a
->
begš
, 
b
->begšè< 
	`ngtı2_mš
×->
’d
, b->end);

209 
	}
}

211 
	$ngtı2_p¦_š£¹
(
ngtı2_p¦
 *
p¦
, 
ngtı2_p¦_™
 *
™
,

212 cÚ¡ 
ngtı2_¿nge
 *
¿nge
, *
d©a
) {

213 
ngtı2_p¦_blk
 *
blk
 = 
p¦
->
h—d
;

214 
ngtı2_p¦_node
 *
node
;

215 
size_t
 
i
;

216 
rv
;

218 ià(
blk
->
n
 =ğ
NGTCP2_PSL_MAX_NBLK
) {

219 
rv
 = 
	`p¦_¥l™_h—d
(
p¦
);

220 ià(
rv
 != 0) {

221  
rv
;

223 
blk
 = 
p¦
->
h—d
;

227 
i
 = 0, 
node
 = &
blk
->
nodes
[i];‚ode->
¿nge
.
begš
 <„ange->begin;

228 ++
i
, ++
node
)

231 
	`as£¹
(!
	`¿nge_š‹r£ù
(&
node
->
¿nge
,„ange));

233 ià(
blk
->
Ëaf
) {

234 
	`š£¹_node
(
blk
, 
i
, 
¿nge
, 
d©a
);

235 ++
p¦
->
n
;

236 ià(
™
) {

237 
	`ngtı2_p¦_™_š™
(
™
, 
blk
, 
i
);

242 ià(
node
->
blk
->
n
 =ğ
NGTCP2_PSL_MAX_NBLK
) {

243 
rv
 = 
	`p¦_¥l™_node
(
p¦
, 
blk
, 
i
);

244 ià(
rv
 != 0) {

245  
rv
;

247 ià(
node
->
¿nge
.
begš
 <„ange->begin) {

248 
node
 = &
blk
->
nodes
[
i
 + 1];

252 
blk
 = 
node
->blk;

254 
	}
}

259 
	$»move_node
(
ngtı2_p¦_blk
 *
blk
, 
size_t
 
i
) {

260 
	`memmove
(&
blk
->
nodes
[
i
], &blk->nodes[i + 1],

261 (
ngtı2_p¦_node
è* (
blk
->
n
 - (
i
 + 1)));

263 --
blk
->
n
;

264 
	}
}

276 
ngtı2_p¦_blk
 *
	$p¦_m”ge_node
(
ngtı2_p¦
 *
p¦
, 
ngtı2_p¦_blk
 *
blk
,

277 
size_t
 
i
) {

278 
ngtı2_p¦_blk
 *
lblk
, *
rblk
;

280 
	`as£¹
(
i
 + 1 < 
blk
->
n
);

282 
lblk
 = 
blk
->
nodes
[
i
].blk;

283 
rblk
 = 
blk
->
nodes
[
i
 + 1].blk;

285 
	`as£¹
(
lblk
->
n
 + 
rblk
->À< 
NGTCP2_PSL_MAX_NBLK
);

287 
	`memıy
(&
lblk
->
nodes
[lblk->
n
], &
rblk
->nodes[0],

288 (
ngtı2_p¦_node
è* 
rblk
->
n
);

290 
lblk
->
n
 +ğ
rblk
->n;

291 
lblk
->
Ãxt
 = 
rblk
->next;

293 
	`ngtı2_mem_ä“
(
p¦
->
mem
, 
rblk
);

295 ià(
p¦
->
h—d
 =ğ
blk
 && blk->
n
 == 2) {

296 
	`ngtı2_mem_ä“
(
p¦
->
mem
,…¦->
h—d
);

297 
p¦
->
h—d
 = 
lblk
;

299 
	`»move_node
(
blk
, 
i
 + 1);

300 
blk
->
nodes
[
i
].
¿nge
 = 
lblk
->nodes[lblk->
n
 - 1].range;

303  
lblk
;

304 
	}
}

322 
	$p¦_»loÿ‹_node
(
ngtı2_p¦
 *
p¦
, 
ngtı2_p¦_blk
 **
pblk
,

323 
size_t
 *
pi
) {

324 
ngtı2_p¦_blk
 *
blk
 = *
pblk
;

325 
size_t
 
i
 = *
pi
;

326 
ngtı2_p¦_node
 *
node
 = &
blk
->
nodes
[
i
];

327 
ngtı2_p¦_node
 *
ºode
 = &
blk
->
nodes
[
i
 + 1];

328 
size_t
 
j
;

329 
rv
;

331 
	`as£¹
(
i
 + 1 < 
blk
->
n
);

333 ià(
node
->
blk
->
n
 =ğ
NGTCP2_PSL_MIN_NBLK
 &&

334 
node
->
blk
->
n
 + 
ºode
->blk->À< 
NGTCP2_PSL_MAX_NBLK
) {

335 
j
 = 
node
->
blk
->
n
 - 1;

336 
blk
 = 
	`p¦_m”ge_node
(
p¦
, blk, 
i
);

337 ià(
blk
 !ğ
p¦
->
h—d
) {

340 *
pblk
 = 
blk
;

341 
i
 = 
j
;

342 ià(
blk
->
Ëaf
) {

343 *
pi
 = 
i
;

346 
node
 = &
blk
->
nodes
[
i
];

347 
ºode
 = &
blk
->
nodes
[
i
 + 1];

349 ià(
node
->
blk
->
n
 =ğ
NGTCP2_PSL_MIN_NBLK
 &&

350 
node
->
blk
->
n
 + 
ºode
->blk->À< 
NGTCP2_PSL_MAX_NBLK
) {

351 
j
 = 
node
->
blk
->
n
 - 1;

352 
blk
 = 
	`p¦_m”ge_node
(
p¦
, blk, 
i
);

353 
	`as£¹
(
blk
 !ğ
p¦
->
h—d
);

354 *
pi
 = 
j
;

359 ià(
node
->
blk
->
n
 < 
ºode
->blk->n) {

360 
node
->
blk
->
nodes
[node->blk->
n
] = 
ºode
->blk->nodes[0];

361 
	`memmove
(&
ºode
->
blk
->
nodes
[0], &rnode->blk->nodes[1],

362 (
ngtı2_p¦_node
è* (
ºode
->
blk
->
n
 - 1));

363 --
ºode
->
blk
->
n
;

364 ++
node
->
blk
->
n
;

365 
node
->
¿nge
 =‚ode->
blk
->
nodes
[node->blk->
n
 - 1].range;

366 *
pi
 = 
i
;

370 ià(
ºode
->
blk
->
n
 =ğ
NGTCP2_PSL_MAX_NBLK
) {

371 
rv
 = 
	`p¦_¥l™_node
(
p¦
, 
blk
, 
i
 + 1);

372 ià(
rv
 != 0) {

373  
rv
;

377 
	`memmove
(&
ºode
->
blk
->
nodes
[1], &rnode->blk->nodes[0],

378 (
ngtı2_p¦_node
è* 
ºode
->
blk
->
n
);

380 
ºode
->
blk
->
nodes
[0] = 
node
->blk->nodes[node->blk->
n
 - 1];

381 ++
ºode
->
blk
->
n
;

383 --
node
->
blk
->
n
;

385 
node
->
¿nge
 =‚ode->
blk
->
nodes
[node->blk->
n
 - 1].range;

387 *
pi
 = 
i
 + 1;

389 
	}
}

395 
	$shiá_Ëá
(
ngtı2_p¦_blk
 *
blk
, 
size_t
 
i
) {

396 
ngtı2_p¦_node
 *
Êode
, *
ºode
;

398 
	`as£¹
(
i
 > 0);

400 
Êode
 = &
blk
->
nodes
[
i
 - 1];

401 
ºode
 = &
blk
->
nodes
[
i
];

403 
	`as£¹
(
Êode
->
blk
->
n
 < 
NGTCP2_PSL_MAX_NBLK
);

404 
	`as£¹
(
ºode
->
blk
->
n
 > 
NGTCP2_PSL_MIN_NBLK
);

406 
Êode
->
blk
->
nodes
[Êode->blk->
n
] = 
ºode
->blk->nodes[0];

407 
Êode
->
¿nge
 =†node->
blk
->
nodes
[Êode->blk->
n
].range;

408 ++
Êode
->
blk
->
n
;

410 --
ºode
->
blk
->
n
;

411 
	`memmove
(&
ºode
->
blk
->
nodes
[0], &rnode->blk->nodes[1],

412 (
ngtı2_p¦_node
è* 
ºode
->
blk
->
n
);

413 
	}
}

419 
	$shiá_right
(
ngtı2_p¦_blk
 *
blk
, 
size_t
 
i
) {

420 
ngtı2_p¦_node
 *
Êode
, *
ºode
;

422 
	`as£¹
(
i
 < 
blk
->
n
 - 1);

424 
Êode
 = &
blk
->
nodes
[
i
];

425 
ºode
 = &
blk
->
nodes
[
i
 + 1];

427 
	`as£¹
(
Êode
->
blk
->
n
 > 
NGTCP2_PSL_MIN_NBLK
);

428 
	`as£¹
(
ºode
->
blk
->
n
 < 
NGTCP2_PSL_MAX_NBLK
);

430 
	`memmove
(&
ºode
->
blk
->
nodes
[1], &rnode->blk->nodes[0],

431 (
ngtı2_p¦_node
è* 
ºode
->
blk
->
n
);

432 ++
ºode
->
blk
->
n
;

433 
ºode
->
blk
->
nodes
[0] = 
Êode
->blk->nodes[Êode->blk->
n
 - 1];

435 --
Êode
->
blk
->
n
;

436 
Êode
->
¿nge
 =†node->
blk
->
nodes
[Êode->blk->
n
 - 1].range;

437 
	}
}

439 
	$ngtı2_p¦_»move
(
ngtı2_p¦
 *
p¦
, 
ngtı2_p¦_™
 *
™
,

440 cÚ¡ 
ngtı2_¿nge
 *
¿nge
) {

441 
ngtı2_p¦_blk
 *
blk
 = 
p¦
->
h—d
, *
lblk
, *
rblk
;

442 
ngtı2_p¦_node
 *
node
;

443 
size_t
 
i
, 
j
;

444 
rv
;

446 ià(!
blk
->
Ëaf
 && blk->
n
 =ğ
NGTCP2_PSL_MAX_NBLK
) {

447 
rv
 = 
	`p¦_¥l™_h—d
(
p¦
);

448 ià(
rv
 != 0) {

449  
rv
;

451 
blk
 = 
p¦
->
h—d
;

455 
i
 = 0, 
node
 = &
blk
->
nodes
[i];‚ode->
¿nge
.
begš
 <„ange->begin;

456 ++
i
, ++
node
)

459 ià(
blk
->
Ëaf
) {

460 
	`as£¹
(
i
 < 
blk
->
n
);

461 
	`»move_node
(
blk
, 
i
);

462 --
p¦
->
n
;

463 ià(
™
) {

464 ià(
blk
->
n
 =ğ
i
) {

465 
	`ngtı2_p¦_™_š™
(
™
, 
blk
->
Ãxt
, 0);

467 
	`ngtı2_p¦_™_š™
(
™
, 
blk
, 
i
);

473 ià(
node
->
blk
->
n
 =ğ
NGTCP2_PSL_MAX_NBLK
) {

474 
rv
 = 
	`p¦_¥l™_node
(
p¦
, 
blk
, 
i
);

475 ià(
rv
 != 0) {

476  
rv
;

478 ià(
node
->
¿nge
.
begš
 <„ange->begin) {

479 ++
i
;

480 
node
 = &
blk
->
nodes
[
i
];

484 ià(
	`ngtı2_¿nge_eq
(&
node
->
¿nge
,„ange)) {

485 
rv
 = 
	`p¦_»loÿ‹_node
(
p¦
, &
blk
, &
i
);

486 ià(
rv
 != 0) {

487  
rv
;

489 ià(!
blk
->
Ëaf
) {

490 
node
 = &
blk
->
nodes
[
i
];

491 
blk
 = 
node
->blk;

493 } ià(
node
->
blk
->
n
 =ğ
NGTCP2_PSL_MIN_NBLK
) {

494 
j
 = 
i
 == 0 ? 0 : i - 1;

496 
lblk
 = 
blk
->
nodes
[
j
].blk;

497 
rblk
 = 
blk
->
nodes
[
j
 + 1].blk;

499 ià(
lblk
->
n
 + 
rblk
->À< 
NGTCP2_PSL_MAX_NBLK
) {

500 
blk
 = 
	`p¦_m”ge_node
(
p¦
, blk, 
j
);

502 ià(
i
 =ğ
j
) {

503 
	`shiá_Ëá
(
blk
, 
j
 + 1);

505 
	`shiá_right
(
blk
, 
j
);

507 
blk
 = 
node
->blk;

510 
blk
 = 
node
->blk;

513 
	}
}

515 
ngtı2_p¦_™
 
	$ngtı2_p¦_low”_bound
(
ngtı2_p¦
 *
p¦
,

516 cÚ¡ 
ngtı2_¿nge
 *
¿nge
) {

517 
ngtı2_p¦_blk
 *
blk
 = 
p¦
->
h—d
;

518 
ngtı2_p¦_node
 *
node
;

519 
size_t
 
i
;

522 
i
 = 0, 
node
 = &
blk
->
nodes
[i];‚ode->
¿nge
.
begš
 <„ange->begin &&

523 !
	`¿nge_š‹r£ù
(&
node
->
¿nge
,„ange);

524 ++
i
, 
node
 = &
blk
->
nodes
[i])

527 ià(
blk
->
Ëaf
) {

528 
ngtı2_p¦_™
 
™
 = {
blk
, 
i
};

529  
™
;

532 
blk
 = 
node
->blk;

534 
	}
}

536 
	$ngtı2_p¦_upd©e_¿nge
(
ngtı2_p¦
 *
p¦
, cÚ¡ 
ngtı2_¿nge
 *
Şd_¿nge
,

537 cÚ¡ 
ngtı2_¿nge
 *
Ãw_¿nge
) {

538 
ngtı2_p¦_blk
 *
blk
 = 
p¦
->
h—d
;

539 
ngtı2_p¦_node
 *
node
;

540 
size_t
 
i
;

542 
	`as£¹
(
Şd_¿nge
->
begš
 <ğ
Ãw_¿nge
->begin);

543 
	`as£¹
(
Ãw_¿nge
->
’d
 <ğ
Şd_¿nge
->end);

546 
i
 = 0, 
node
 = &
blk
->
nodes
[i];‚ode->
¿nge
.
begš
 < 
Şd_¿nge
->begin;

547 ++
i
, 
node
 = &
blk
->
nodes
[i])

550 ià(
blk
->
Ëaf
) {

551 
	`as£¹
(
	`ngtı2_¿nge_eq
(&
node
->
¿nge
, 
Şd_¿nge
));

552 
node
->
¿nge
 = *
Ãw_¿nge
;

556 ià(
	`ngtı2_¿nge_eq
(&
node
->
¿nge
, 
Şd_¿nge
)) {

557 
node
->
¿nge
 = *
Ãw_¿nge
;

559 
	`as£¹
(!
	`¿nge_š‹r£ù
(&
node
->
¿nge
, 
Şd_¿nge
));

562 
blk
 = 
node
->blk;

564 
	}
}

566 
	$p¦_´št
(
ngtı2_p¦
 *
p¦
, cÚ¡ 
ngtı2_p¦_blk
 *
blk
,

567 
size_t
 
Ëv–
) {

568 
size_t
 
i
;

570 
	`årštf
(
¡d”r
, "LV=%zu‚=%zu\n", 
Ëv–
, 
blk
->
n
);

572 ià(
blk
->
Ëaf
) {

573 
i
 = 0; i < 
blk
->
n
; ++i) {

574 
	`årštf
(
¡d”r
, " [%" 
PRIu64
 ", %" PRIu64 ")", 
blk
->
nodes
[
i
].
¿nge
.
begš
,

575 
blk
->
nodes
[
i
].
¿nge
.
’d
);

577 
	`årštf
(
¡d”r
, "\n");

581 
i
 = 0; i < 
blk
->
n
; ++i) {

582 
	`p¦_´št
(
p¦
, 
blk
->
nodes
[
i
].blk, 
Ëv–
 + 1);

584 
	}
}

586 
	$ngtı2_p¦_´št
(
ngtı2_p¦
 *
p¦
è{ 
	`p¦_´št
Õ¦,…¦->
h—d
, 0); 
	}
}

588 
ngtı2_p¦_™
 
	$ngtı2_p¦_begš
(cÚ¡ 
ngtı2_p¦
 *
p¦
) {

589 
ngtı2_p¦_™
 
™
 = {
p¦
->
äÚt
, 0};

590  
™
;

591 
	}
}

593 
size_t
 
	$ngtı2_p¦_Ën
(
ngtı2_p¦
 *
p¦
è{ …¦->
n
; 
	}
}

595 
	$ngtı2_p¦_™_š™
(
ngtı2_p¦_™
 *
™
, cÚ¡ 
ngtı2_p¦_blk
 *
blk
,

596 
size_t
 
i
) {

597 
™
->
blk
 = blk;

598 
™
->
i
 = i;

599 
	}
}

601 *
	$ngtı2_p¦_™_g‘
(cÚ¡ 
ngtı2_p¦_™
 *
™
) {

602  
™
->
blk
->
nodes
[™->
i
].
d©a
;

603 
	}
}

605 
	$ngtı2_p¦_™_Ãxt
(
ngtı2_p¦_™
 *
™
) {

606 
	`as£¹
(!
	`ngtı2_p¦_™_’d
(
™
));

608 ià(++
™
->
i
 =ğ™->
blk
->
n
) {

609 
™
->
blk
 = it->blk->
Ãxt
;

610 
™
->
i
 = 0;

612 
	}
}

614 
	$ngtı2_p¦_™_’d
(cÚ¡ 
ngtı2_p¦_™
 *
™
) {

615 
ngtı2_¿nge
 
’d
 = {
UINT64_MAX
, UINT64_MAX};

616  
	`ngtı2_¿nge_eq
(&
’d
, &
™
->
blk
->
nodes
[™->
i
].
¿nge
);

617 
	}
}

619 
ngtı2_¿nge
 
	$ngtı2_p¦_™_¿nge
(cÚ¡ 
ngtı2_p¦_™
 *
™
) {

620  
™
->
blk
->
nodes
[™->
i
].
¿nge
;

621 
	}
}

	@lib/ngtcp2_psl.h

25 #iâdeà
NGTCP2_PSL_H


26 
	#NGTCP2_PSL_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<¡dlib.h
>

34 
	~<ngtı2/ngtı2.h
>

36 
	~"ngtı2_¿nge.h
"

43 
	#NGTCP2_PSL_DEGR
 8

	)

46 
	#NGTCP2_PSL_MAX_NBLK
 (2 * 
NGTCP2_PSL_DEGR
 - 1)

	)

49 
	#NGTCP2_PSL_MIN_NBLK
 (
NGTCP2_PSL_DEGR
 - 1)

	)

51 
	gngtı2_p¦_node
;

52 
ngtı2_p¦_node
 
	tngtı2_p¦_node
;

54 
	gngtı2_p¦_blk
;

55 
ngtı2_p¦_blk
 
	tngtı2_p¦_blk
;

64 
	sngtı2_p¦_node
 {

65 
ngtı2_¿nge
 
	m¿nge
;

67 
ngtı2_p¦_blk
 *
	mblk
;

68 *
	md©a
;

75 
	sngtı2_p¦_blk
 {

77 
ngtı2_p¦_blk
 *
	mÃxt
;

79 
size_t
 
	mn
;

81 
	mËaf
;

82 
ngtı2_p¦_node
 
	mnodes
[
NGTCP2_PSL_MAX_NBLK
];

85 
	gngtı2_p¦_™
;

86 
ngtı2_p¦_™
 
	tngtı2_p¦_™
;

91 
	sngtı2_p¦_™
 {

92 cÚ¡ 
ngtı2_p¦_blk
 *
	mblk
;

93 
size_t
 
	mi
;

96 
	gngtı2_p¦
;

97 
ngtı2_p¦
 
	tngtı2_p¦
;

102 
	sngtı2_p¦
 {

104 
ngtı2_p¦_blk
 *
	mh—d
;

106 
ngtı2_p¦_blk
 *
	mäÚt
;

107 
size_t
 
	mn
;

108 
ngtı2_mem
 *
	mmem
;

120 
ngtı2_p¦_š™
(
ngtı2_p¦
 *
p¦
, 
ngtı2_mem
 *
mem
);

127 
ngtı2_p¦_ä“
(
ngtı2_p¦
 *
p¦
);

143 
ngtı2_p¦_š£¹
(
ngtı2_p¦
 *
p¦
, 
ngtı2_p¦_™
 *
™
,

144 cÚ¡ 
ngtı2_¿nge
 *
¿nge
, *
d©a
);

160 
ngtı2_p¦_»move
(
ngtı2_p¦
 *
p¦
, 
ngtı2_p¦_™
 *
™
,

161 cÚ¡ 
ngtı2_¿nge
 *
¿nge
);

168 
ngtı2_p¦_upd©e_¿nge
(
ngtı2_p¦
 *
p¦
, cÚ¡ 
ngtı2_¿nge
 *
Şd_¿nge
,

169 cÚ¡ 
ngtı2_¿nge
 *
Ãw_¿nge
);

177 
ngtı2_p¦_™
 
ngtı2_p¦_low”_bound
(
ngtı2_p¦
 *
p¦
,

178 cÚ¡ 
ngtı2_¿nge
 *
¿nge
);

185 
ngtı2_p¦_™
 
ngtı2_p¦_begš
(cÚ¡ 
ngtı2_p¦
 *
p¦
);

190 
size_t
 
ngtı2_p¦_Ën
(
ngtı2_p¦
 *
p¦
);

196 
ngtı2_p¦_´št
(
ngtı2_p¦
 *
p¦
);

201 
ngtı2_p¦_™_š™
(
ngtı2_p¦_™
 *
™
, cÚ¡ 
ngtı2_p¦_blk
 *
blk
, 
size_t
 
i
);

208 *
ngtı2_p¦_™_g‘
(cÚ¡ 
ngtı2_p¦_™
 *
™
);

215 
ngtı2_p¦_™_Ãxt
(
ngtı2_p¦_™
 *
™
);

221 
ngtı2_p¦_™_’d
(cÚ¡ 
ngtı2_p¦_™
 *
™
);

229 
ngtı2_¿nge
 
ngtı2_p¦_™_¿nge
(cÚ¡ 
ngtı2_p¦_™
 *
™
);

	@lib/ngtcp2_pv.c

25 
	~"ngtı2_pv.h
"

27 
	~<¡ršg.h
>

29 
	~"ngtı2_mem.h
"

30 
	~"ngtı2_log.h
"

31 
	~"ngtı2_maüo.h
"

33 
	$ngtı2_pv_’Œy_š™
(
ngtı2_pv_’Œy
 *
pv’t
, cÚ¡ 
ušt8_t
 *
d©a
,

34 
ngtı2_t¡amp
 
expœy
) {

35 
	`memıy
(
pv’t
->
d©a
, data, (pvent->data));

36 
pv’t
->
expœy
 =ƒxpiry;

37 
	}
}

39 
	$ngtı2_pv_Ãw
(
ngtı2_pv
 **
µv
, cÚ¡ 
ngtı2_dcid
 *
dcid
,

40 
ngtı2_du¿tiÚ
 
timeout
, 
ušt8_t
 
æags
, 
ngtı2_log
 *
log
,

41 
ngtı2_mem
 *
mem
) {

42 
rv
;

44 (*
µv
èğ
	`ngtı2_mem_m®loc
(
mem
, (
ngtı2_pv
));

45 ià(*
µv
 =ğ
NULL
) {

46  
NGTCP2_ERR_NOMEM
;

49 
rv
 = 
	`ngtı2_ršgbuf_š™
(&(*
µv
)->
’ts
, 
NGTCP2_PV_MAX_ENTRIES
,

50 (
ngtı2_pv_’Œy
), 
mem
);

51 ià(
rv
 != 0) {

52 
	`ngtı2_mem_ä“
(
mem
, *
µv
);

56 
	`ngtı2_dcid_cİy
(&(*
µv
)->
dcid
, dcid);

58 (*
µv
)->
mem
 = mem;

59 (*
µv
)->
log
 =†og;

60 (*
µv
)->
timeout
 =imeout;

61 (*
µv
)->
¡¬‹d_ts
 = 0;

62 (*
µv
)->
loss_couÁ
 = 0;

63 (*
µv
)->
æags
 = flags;

66 
	}
}

68 
	$ngtı2_pv_d–
(
ngtı2_pv
 *
pv
) {

69 ià(
pv
 =ğ
NULL
) {

72 
	`ngtı2_ršgbuf_ä“
(&
pv
->
’ts
);

73 
	`ngtı2_mem_ä“
(
pv
->
mem
,…v);

74 
	}
}

76 
	$ngtı2_pv_’su»_¡¬t
(
ngtı2_pv
 *
pv
, 
ngtı2_t¡amp
 
ts
) {

77 ià(
pv
->
¡¬‹d_ts
) {

80 
pv
->
¡¬‹d_ts
 = 
ts
;

81 
	}
}

83 
	$ngtı2_pv_add_’Œy
(
ngtı2_pv
 *
pv
, cÚ¡ 
ušt8_t
 *
d©a
,

84 
ngtı2_t¡amp
 
expœy
) {

85 
ngtı2_pv_’Œy
 *
’t
 = 
	`ngtı2_ršgbuf_push_back
(&
pv
->
’ts
);

86 
	`ngtı2_pv_’Œy_š™
(
’t
, 
d©a
, 
expœy
);

87 
	}
}

89 
	$ngtı2_pv_fuÎ
(
ngtı2_pv
 *
pv
è{  
	`ngtı2_ršgbuf_fuÎ
(&pv->
’ts
); 
	}
}

91 
	$ngtı2_pv_v®id©e
(
ngtı2_pv
 *
pv
, cÚ¡ 
ngtı2_·th
 *
·th
,

92 cÚ¡ 
ušt8_t
 *
d©a
) {

93 
size_t
 
Ën
 = 
	`ngtı2_ršgbuf_Ën
(&
pv
->
’ts
);

94 
size_t
 
i
;

95 
ngtı2_pv_’Œy
 *
’t
;

97 ià(
Ën
 == 0) {

98  
NGTCP2_ERR_INVALID_STATE
;

103 ià(!
	`ngtı2_·th_eq
(&
pv
->
dcid
.
·th
,…ath)) {

104 
	`ngtı2_log_šfo
(

105 
pv
->
log
, 
NGTCP2_LOG_EVENT_PTV
,

107  
NGTCP2_ERR_INVALID_ARGUMENT
;

110 
i
 = 0; i < 
Ën
; ++i) {

111 
’t
 = 
	`ngtı2_ršgbuf_g‘
(&
pv
->
’ts
, 
i
);

112 ià(
	`memcmp
(
’t
->
d©a
, data, (ent->data)) == 0) {

113 
	`ngtı2_log_šfo
(
pv
->
log
, 
NGTCP2_LOG_EVENT_PTV
, "path has been validated");

118  
NGTCP2_ERR_INVALID_ARGUMENT
;

119 
	}
}

121 
	$ngtı2_pv_hªdË_’Œy_expœy
(
ngtı2_pv
 *
pv
, 
ngtı2_t¡amp
 
ts
) {

122 
ngtı2_pv_’Œy
 *
’t
;

124 ià(
	`ngtı2_ršgbuf_Ën
(&
pv
->
’ts
) == 0) {

128 
’t
 = 
	`ngtı2_ršgbuf_g‘
(&
pv
->
’ts
, 0);

129 ià(
’t
->
expœy
 <ğ
ts
) {

130 ++
pv
->
loss_couÁ
;

132 
	`ngtı2_ršgbuf_pİ_äÚt
(&
pv
->
’ts
);

134 ; 
	`ngtı2_ršgbuf_Ën
(&
pv
->
’ts
);) {

135 
’t
 = 
	`ngtı2_ršgbuf_g‘
(&
pv
->
’ts
, 0);

136 ià(
’t
->
expœy
 <ğ
ts
) {

137 
	`ngtı2_ršgbuf_pİ_äÚt
(&
pv
->
’ts
);

143 
	}
}

145 
	$ngtı2_pv_v®id©iÚ_timed_out
(
ngtı2_pv
 *
pv
, 
ngtı2_t¡amp
 
ts
) {

146  
pv
->
¡¬‹d_ts
 +…v->
timeout
 <ğ
ts
;

147 
	}
}

149 
ngtı2_t¡amp
 
	$ngtı2_pv_Ãxt_expœy
(
ngtı2_pv
 *
pv
) {

150 
ngtı2_t¡amp
 
t
 = 
UINT64_MAX
;

151 
ngtı2_pv_’Œy
 *
’t
;

153 ià(
pv
->
¡¬‹d_ts
) {

154 
t
 = 
pv
->
¡¬‹d_ts
 +…v->
timeout
;

157 ià(
	`ngtı2_ršgbuf_Ën
(&
pv
->
’ts
) == 0) {

158  
t
;

161 
’t
 = 
	`ngtı2_ršgbuf_g‘
(&
pv
->
’ts
, 0);

163  
	`ngtı2_mš
(
t
, 
’t
->
expœy
);

164 
	}
}

	@lib/ngtcp2_pv.h

25 #iâdeà
NGTCP2_PV_H


26 
	#NGTCP2_PV_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

34 
	~"ngtı2_cid.h
"

35 
	~"ngtı2_ršgbuf.h
"

39 
	#NGTCP2_PV_MAX_ENTRIES
 4

	)

41 
	gngtı2_log
;

42 
ngtı2_log
 
	tngtı2_log
;

44 
	gngtı2_äame_chaš
;

45 
ngtı2_äame_chaš
 
	tngtı2_äame_chaš
;

49 
ngtı2_t¡amp
 
	mexpœy
;

51 
ušt8_t
 
	md©a
[8];

52 } 
	tngtı2_pv_’Œy
;

54 
ngtı2_pv_’Œy_š™
(
ngtı2_pv_’Œy
 *
pv’t
, cÚ¡ 
ušt8_t
 *
d©a
,

55 
ngtı2_t¡amp
 
expœy
);

58 
	mNGTCP2_PV_FLAG_NONE
,

61 
	mNGTCP2_PV_FLAG_BLOCKING
 = 0x01,

64 
	mNGTCP2_PV_FLAG_DONT_CARE
 = 0x02,

68 
	mNGTCP2_PV_FLAG_RETIRE_DCID_ON_FINISH
 = 0x04,

72 
	mNGTCP2_PV_FLAG_VERIFY_OLD_PATH_ON_SUCCESS
 = 0x08,

75 
	mNGTCP2_PV_FLAG_INVOKE_CALLBACK
 = 0x10,

76 } 
	tngtı2_pv_æag
;

78 
	gngtı2_pv
;

79 
ngtı2_pv
 
	tngtı2_pv
;

84 
	sngtı2_pv
 {

85 
ngtı2_mem
 *
	mmem
;

86 
ngtı2_log
 *
	mlog
;

88 
ngtı2_dcid
 
	mdcid
;

90 
ngtı2_ršgbuf
 
	m’ts
;

93 
ngtı2_du¿tiÚ
 
	mtimeout
;

95 
ngtı2_t¡amp
 
	m¡¬‹d_ts
;

97 
size_t
 
	mloss_couÁ
;

99 
ušt8_t
 
	mæags
;

113 
ngtı2_pv_Ãw
(
ngtı2_pv
 **
µv
, cÚ¡ 
ngtı2_dcid
 *
dcid
,

114 
ngtı2_du¿tiÚ
 
timeout
, 
ušt8_t
 
æags
, 
ngtı2_log
 *
log
,

115 
ngtı2_mem
 *
mem
);

121 
ngtı2_pv_d–
(
ngtı2_pv
 *
pv
);

126 
ngtı2_pv_’su»_¡¬t
(
ngtı2_pv
 *
pv
, 
ngtı2_t¡amp
 
ts
);

132 
ngtı2_pv_add_’Œy
(
ngtı2_pv
 *
pv
, cÚ¡ 
ušt8_t
 *
d©a
,

133 
ngtı2_t¡amp
 
expœy
);

138 
ngtı2_pv_fuÎ
(
ngtı2_pv
 *
pv
);

152 
ngtı2_pv_v®id©e
(
ngtı2_pv
 *
pv
, cÚ¡ 
ngtı2_·th
 *
·th
,

153 cÚ¡ 
ušt8_t
 *
d©a
);

158 
ngtı2_pv_hªdË_’Œy_expœy
(
ngtı2_pv
 *
pv
, 
ngtı2_t¡amp
 
ts
);

164 
ngtı2_pv_v®id©iÚ_timed_out
(
ngtı2_pv
 *
pv
, 
ngtı2_t¡amp
 
ts
);

169 
ngtı2_t¡amp
 
ngtı2_pv_Ãxt_expœy
(
ngtı2_pv
 *
pv
);

	@lib/ngtcp2_range.c

25 
	~"ngtı2_¿nge.h
"

26 
	~"ngtı2_maüo.h
"

28 
	$ngtı2_¿nge_š™
(
ngtı2_¿nge
 *
r
, 
ušt64_t
 
begš
, ušt64_ˆ
’d
) {

29 
r
->
begš
 = begin;

30 
r
->
’d
 =ƒnd;

31 
	}
}

33 
ngtı2_¿nge
 
	$ngtı2_¿nge_š‹r£ù
(cÚ¡ 
ngtı2_¿nge
 *
a
,

34 cÚ¡ 
ngtı2_¿nge
 *
b
) {

35 
ngtı2_¿nge
 
r
 = {0, 0};

36 
ušt64_t
 
begš
 = 
	`ngtı2_max
(
a
->begš, 
b
->begin);

37 
ušt64_t
 
’d
 = 
	`ngtı2_mš
(
a
->’d, 
b
->end);

38 ià(
begš
 < 
’d
) {

39 
	`ngtı2_¿nge_š™
(&
r
, 
begš
, 
’d
);

41  
r
;

42 
	}
}

44 
ušt64_t
 
	$ngtı2_¿nge_Ën
(cÚ¡ 
ngtı2_¿nge
 *
r
è{ „->
’d
 -„->
begš
; 
	}
}

46 
	$ngtı2_¿nge_eq
(cÚ¡ 
ngtı2_¿nge
 *
a
, cÚ¡‚gtı2_¿ng*
b
) {

47  
a
->
begš
 =ğ
b
->begš &&‡->
’d
 == b->end;

48 
	}
}

50 
	$ngtı2_¿nge_cut
(
ngtı2_¿nge
 *
Ëá
,‚gtı2_¿ng*
right
,

51 cÚ¡ 
ngtı2_¿nge
 *
a
, cÚ¡‚gtı2_¿ng*
b
) {

53 
Ëá
->
begš
 = 
a
->begin;

54 
Ëá
->
’d
 = 
b
->
begš
;

55 
right
->
begš
 = 
b
->
’d
;

56 
right
->
’d
 = 
a
->end;

57 
	}
}

59 
	$ngtı2_¿nge_nÙ_aá”
(cÚ¡ 
ngtı2_¿nge
 *
a
, cÚ¡‚gtı2_¿ng*
b
) {

60  
a
->
’d
 <ğ
b
->end;

61 
	}
}

	@lib/ngtcp2_range.h

25 #iâdeà
NGTCP2_RANGE_H


26 
	#NGTCP2_RANGE_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

38 
ušt64_t
 
	mbegš
;

39 
ušt64_t
 
	m’d
;

40 } 
	tngtı2_¿nge
;

45 
ngtı2_¿nge_š™
(
ngtı2_¿nge
 *
r
, 
ušt64_t
 
begš
, ušt64_ˆ
’d
);

51 
ngtı2_¿nge
 
ngtı2_¿nge_š‹r£ù
(cÚ¡‚gtı2_¿ng*
a
,

52 cÚ¡ 
ngtı2_¿nge
 *
b
);

57 
ušt64_t
 
ngtı2_¿nge_Ën
(cÚ¡ 
ngtı2_¿nge
 *
r
);

63 
ngtı2_¿nge_eq
(cÚ¡ 
ngtı2_¿nge
 *
a
, cÚ¡‚gtı2_¿ng*
b
);

71 
ngtı2_¿nge_cut
(
ngtı2_¿nge
 *
Ëá
,‚gtı2_¿ng*
right
,

72 cÚ¡ 
ngtı2_¿nge
 *
a
, cÚ¡‚gtı2_¿ng*
b
);

78 
ngtı2_¿nge_nÙ_aá”
(cÚ¡ 
ngtı2_¿nge
 *
a
, cÚ¡‚gtı2_¿ng*
b
);

	@lib/ngtcp2_ringbuf.c

25 
	~"ngtı2_ršgbuf.h
"

27 
	~<as£¹.h
>

29 
	~"ngtı2_maüo.h
"

31 
	$ngtı2_ršgbuf_š™
(
ngtı2_ršgbuf
 *
rb
, 
size_t
 
nmemb
, size_ˆ
size
,

32 
ngtı2_mem
 *
mem
) {

33 
	`as£¹
(1 =ğ
	`__butš_pİcouÁ
(()
nmemb
));

35 
rb
->
buf
 = 
	`ngtı2_mem_m®loc
(
mem
, 
nmemb
 * 
size
);

36 ià(
rb
->
buf
 =ğ
NULL
) {

37  
NGTCP2_ERR_NOMEM
;

40 
rb
->
mem
 = mem;

41 
rb
->
nmemb
 =‚memb;

42 
rb
->
size
 = size;

43 
rb
->
fœ¡
 = 0;

44 
rb
->
Ën
 = 0;

47 
	}
}

49 
	$ngtı2_ršgbuf_ä“
(
ngtı2_ršgbuf
 *
rb
) {

50 ià(
rb
 =ğ
NULL
) {

54 
	`ngtı2_mem_ä“
(
rb
->
mem
,„b->
buf
);

55 
	}
}

57 *
	$ngtı2_ršgbuf_push_äÚt
(
ngtı2_ršgbuf
 *
rb
) {

58 
rb
->
fœ¡
 = (rb->fœ¡ - 1è& (rb->
nmemb
 - 1);

59 
rb
->
Ën
 = 
	`ngtı2_mš
Ôb->
nmemb
,„b->len + 1);

61  (*)&
rb
->
buf
[rb->
fœ¡
 *„b->
size
];

62 
	}
}

64 *
	$ngtı2_ršgbuf_push_back
(
ngtı2_ršgbuf
 *
rb
) {

65 
size_t
 
off£t
 = (
rb
->
fœ¡
 +„b->
Ën
è& (rb->
nmemb
 - 1);

67 ià(
rb
->
Ën
 =ğrb->
nmemb
) {

68 
rb
->
fœ¡
 = (rb->fœ¡ + 1è& (rb->
nmemb
 - 1);

70 ++
rb
->
Ën
;

73  (*)&
rb
->
buf
[
off£t
 *„b->
size
];

74 
	}
}

76 
	$ngtı2_ršgbuf_pİ_äÚt
(
ngtı2_ršgbuf
 *
rb
) {

77 
rb
->
fœ¡
 = (rb->fœ¡ + 1è& (rb->
nmemb
 - 1);

78 --
rb
->
Ën
;

79 
	}
}

81 
	$ngtı2_ršgbuf_pİ_back
(
ngtı2_ršgbuf
 *
rb
) {

82 
	`as£¹
(
rb
->
Ën
);

83 --
rb
->
Ën
;

84 
	}
}

86 
	$ngtı2_ršgbuf_»size
(
ngtı2_ršgbuf
 *
rb
, 
size_t
 
Ën
) {

87 
	`as£¹
(
Ën
 <ğ
rb
->
nmemb
);

88 
rb
->
Ën
 =†en;

89 
	}
}

91 *
	$ngtı2_ršgbuf_g‘
(
ngtı2_ršgbuf
 *
rb
, 
size_t
 
off£t
) {

92 
	`as£¹
(
off£t
 < 
rb
->
Ën
);

93 
off£t
 = (
rb
->
fœ¡
 + off£tè& (rb->
nmemb
 - 1);

94  &
rb
->
buf
[
off£t
 *„b->
size
];

95 
	}
}

97 
size_t
 
	$ngtı2_ršgbuf_Ën
(
ngtı2_ršgbuf
 *
rb
è{ „b->
Ën
; 
	}
}

99 
	$ngtı2_ršgbuf_fuÎ
(
ngtı2_ršgbuf
 *
rb
è{ „b->
Ën
 =ğrb->
nmemb
; 
	}
}

	@lib/ngtcp2_ringbuf.h

25 #iâdeà
NGTCP2_RINGBUF_H


26 
	#NGTCP2_RINGBUF_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

34 
	~"ngtı2_mem.h
"

38 
ušt8_t
 *
	mbuf
;

39 
ngtı2_mem
 *
	mmem
;

42 
size_t
 
	mnmemb
;

44 
size_t
 
	msize
;

46 
size_t
 
	mfœ¡
;

48 
size_t
 
	mËn
;

49 } 
	tngtı2_ršgbuf
;

62 
ngtı2_ršgbuf_š™
(
ngtı2_ršgbuf
 *
rb
, 
size_t
 
nmemb
, size_ˆ
size
,

63 
ngtı2_mem
 *
mem
);

69 
ngtı2_ršgbuf_ä“
(
ngtı2_ršgbuf
 *
rb
);

77 *
ngtı2_ršgbuf_push_äÚt
(
ngtı2_ršgbuf
 *
rb
);

84 *
ngtı2_ršgbuf_push_back
(
ngtı2_ršgbuf
 *
rb
);

89 
ngtı2_ršgbuf_pİ_äÚt
(
ngtı2_ršgbuf
 *
rb
);

94 
ngtı2_ršgbuf_pİ_back
(
ngtı2_ršgbuf
 *
rb
);

98 
ngtı2_ršgbuf_»size
(
ngtı2_ršgbuf
 *
rb
, 
size_t
 
Ën
);

102 *
ngtı2_ršgbuf_g‘
(
ngtı2_ršgbuf
 *
rb
, 
size_t
 
off£t
);

105 
size_t
 
ngtı2_ršgbuf_Ën
(
ngtı2_ršgbuf
 *
rb
);

108 
ngtı2_ršgbuf_fuÎ
(
ngtı2_ršgbuf
 *
rb
);

	@lib/ngtcp2_rob.c

25 
	~"ngtı2_rob.h
"

27 
	~<¡ršg.h
>

28 
	~<as£¹.h
>

30 
	~"ngtı2_maüo.h
"

32 
	$ngtı2_rob_g­_Ãw
(
ngtı2_rob_g­
 **
pg
, 
ušt64_t
 
begš
, ušt64_ˆ
’d
,

33 
ngtı2_mem
 *
mem
) {

34 *
pg
 = 
	`ngtı2_mem_m®loc
(
mem
, (
ngtı2_rob_g­
));

35 ià(*
pg
 =ğ
NULL
) {

36  
NGTCP2_ERR_NOMEM
;

39 (*
pg
)->
¿nge
.
begš
 = begin;

40 (*
pg
)->
¿nge
.
’d
 =ƒnd;

43 
	}
}

45 
	$ngtı2_rob_g­_d–
(
ngtı2_rob_g­
 *
g
, 
ngtı2_mem
 *
mem
) {

46 
	`ngtı2_mem_ä“
(
mem
, 
g
);

47 
	}
}

49 
	$ngtı2_rob_d©a_Ãw
(
ngtı2_rob_d©a
 **
pd
, 
ušt64_t
 
off£t
, 
size_t
 
chunk
,

50 
ngtı2_mem
 *
mem
) {

51 *
pd
 = 
	`ngtı2_mem_m®loc
(
mem
, (
ngtı2_rob_d©a
è+ 
chunk
);

52 ià(*
pd
 =ğ
NULL
) {

53  
NGTCP2_ERR_NOMEM
;

56 (*
pd
)->
¿nge
.
begš
 = 
off£t
;

57 (*
pd
)->
¿nge
.
’d
 = 
off£t
 + 
chunk
;

58 (*
pd
)->
begš
 = (
ušt8_t
 *)(*pdè+ (
ngtı2_rob_d©a
);

59 (*
pd
)->
’d
 = (*pd)->
begš
 + 
chunk
;

62 
	}
}

64 
	$ngtı2_rob_d©a_d–
(
ngtı2_rob_d©a
 *
d
, 
ngtı2_mem
 *
mem
) {

65 
	`ngtı2_mem_ä“
(
mem
, 
d
);

66 
	}
}

68 
	$ngtı2_rob_š™
(
ngtı2_rob
 *
rob
, 
size_t
 
chunk
, 
ngtı2_mem
 *
mem
) {

69 
rv
;

70 
ngtı2_rob_g­
 *
g
;

72 
rv
 = 
	`ngtı2_p¦_š™
(&
rob
->
g­p¦
, 
mem
);

73 ià(
rv
 != 0) {

74 
ç_g­p¦_p¦_š™
;

77 
rv
 = 
	`ngtı2_rob_g­_Ãw
(&
g
, 0, 
UINT64_MAX
, 
mem
);

78 ià(
rv
 != 0) {

79 
ç_rob_g­_Ãw
;

82 
rv
 = 
	`ngtı2_p¦_š£¹
(&
rob
->
g­p¦
, 
NULL
, &
g
->
¿nge
, g);

83 ià(
rv
 != 0) {

84 
ç_g­p¦_p¦_š£¹
;

87 
rv
 = 
	`ngtı2_p¦_š™
(&
rob
->
d©­¦
, 
mem
);

88 ià(
rv
 != 0) {

89 
ç_d©­¦_p¦_š™
;

92 
rob
->
chunk
 = chunk;

93 
rob
->
mem
 = mem;

97 
ç_d©­¦_p¦_š™
:

98 
ç_g­p¦_p¦_š£¹
:

99 
	`ngtı2_rob_g­_d–
(
g
, 
mem
);

100 
ç_rob_g­_Ãw
:

101 
	`ngtı2_p¦_ä“
(&
rob
->
g­p¦
);

102 
ç_g­p¦_p¦_š™
:

103  
rv
;

104 
	}
}

106 
	$ngtı2_rob_ä“
(
ngtı2_rob
 *
rob
) {

107 cÚ¡ 
ngtı2_¿nge
 
r
 = {0, 0};

108 
ngtı2_p¦_™
 
™
;

110 ià(
rob
 =ğ
NULL
) {

114 
™
 = 
	`ngtı2_p¦_low”_bound
(&
rob
->
d©­¦
, &
r
); !
	`ngtı2_p¦_™_’d
(&it);

115 
	`ngtı2_p¦_™_Ãxt
(&
™
)) {

116 
	`ngtı2_rob_d©a_d–
(
	`ngtı2_p¦_™_g‘
(&
™
), 
rob
->
mem
);

119 
™
 = 
	`ngtı2_p¦_low”_bound
(&
rob
->
g­p¦
, &
r
); !
	`ngtı2_p¦_™_’d
(&it);

120 
	`ngtı2_p¦_™_Ãxt
(&
™
)) {

121 
	`ngtı2_rob_g­_d–
(
	`ngtı2_p¦_™_g‘
(&
™
), 
rob
->
mem
);

124 
	`ngtı2_p¦_ä“
(&
rob
->
d©­¦
);

125 
	`ngtı2_p¦_ä“
(&
rob
->
g­p¦
);

126 
	}
}

128 
	$rob_wr™e_d©a
(
ngtı2_rob
 *
rob
, 
ušt64_t
 
off£t
, cÚ¡ 
ušt8_t
 *
d©a
,

129 
size_t
 
Ën
) {

130 
size_t
 
n
;

131 
rv
;

132 
ngtı2_rob_d©a
 *
d
;

133 
ngtı2_¿nge
 
¿nge
 = {
off£t
, off£ˆ+ 
Ën
};

134 
ngtı2_p¦_™
 
™
;

136 
™
 = 
	`ngtı2_p¦_low”_bound
(&
rob
->
d©­¦
, &
¿nge
); 
Ën
;

137 
	`ngtı2_p¦_™_Ãxt
(&
™
)) {

138 
d
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

140 ià(
d
 =ğ
NULL
 || 
off£t
 < d->
¿nge
.
begš
) {

141 
rv
 = 
	`ngtı2_rob_d©a_Ãw
(&
d
, (
off£t
 / 
rob
->
chunk
) *„ob->chunk,

142 
rob
->
chunk
,„ob->
mem
);

143 ià(
rv
 != 0) {

144  
rv
;

147 
rv
 = 
	`ngtı2_p¦_š£¹
(&
rob
->
d©­¦
, &
™
, &
d
->
¿nge
, d);

148 ià(
rv
 != 0) {

149 
	`ngtı2_rob_d©a_d–
(
d
, 
rob
->
mem
);

150  
rv
;

152 } ià(
d
->
¿nge
.
begš
 + 
rob
->
chunk
 < 
off£t
) {

153 
	`as£¹
(0);

155 
n
 = 
	`ngtı2_mš
(
Ën
, 
d
->
¿nge
.
begš
 + 
rob
->
chunk
 - 
off£t
);

156 
	`memıy
(
d
->
begš
 + (
off£t
 - d->
¿nge
.begš), 
d©a
, 
n
);

157 
off£t
 +ğ
n
;

158 
d©a
 +ğ
n
;

159 
Ën
 -ğ
n
;

163 
	}
}

165 
	$ngtı2_rob_push
(
ngtı2_rob
 *
rob
, 
ušt64_t
 
off£t
, cÚ¡ 
ušt8_t
 *
d©a
,

166 
size_t
 
d©®’
) {

167 
rv
;

168 
ngtı2_rob_g­
 *
g
;

169 
ngtı2_¿nge
 
m
, 
l
, 
r
, 
q
 = {
off£t
, off£ˆ+ 
d©®’
};

170 
ngtı2_p¦_™
 
™
;

172 
™
 = 
	`ngtı2_p¦_low”_bound
(&
rob
->
g­p¦
, &
q
);

174 ; !
	`ngtı2_p¦_™_’d
(&
™
);) {

175 
g
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

177 
m
 = 
	`ngtı2_¿nge_š‹r£ù
(&
q
, &
g
->
¿nge
);

178 ià(!
	`ngtı2_¿nge_Ën
(&
m
)) {

181 ià(
	`ngtı2_¿nge_eq
(&
g
->
¿nge
, &
m
)) {

182 
rv
 = 
	`ngtı2_p¦_»move
(&
rob
->
g­p¦
, &
™
, &
g
->
¿nge
);

183 ià(
rv
 != 0) {

184  
rv
;

186 
	`ngtı2_rob_g­_d–
(
g
, 
rob
->
mem
);

187 
rv
 = 
	`rob_wr™e_d©a
(
rob
, 
m
.
begš
, 
d©a
 + (m.begš - 
off£t
),

188 
	`ngtı2_¿nge_Ën
(&
m
));

189 ià(
rv
 != 0) {

190  
rv
;

195 
	`ngtı2_¿nge_cut
(&
l
, &
r
, &
g
->
¿nge
, &
m
);

196 ià(
	`ngtı2_¿nge_Ën
(&
l
)) {

197 
	`ngtı2_p¦_upd©e_¿nge
(&
rob
->
g­p¦
, &
g
->
¿nge
, &
l
);

198 
g
->
¿nge
 = 
l
;

200 ià(
	`ngtı2_¿nge_Ën
(&
r
)) {

201 
ngtı2_rob_g­
 *
ng
;

202 
rv
 = 
	`ngtı2_rob_g­_Ãw
(&
ng
, 
r
.
begš
,„.
’d
, 
rob
->
mem
);

203 ià(
rv
 != 0) {

204  
rv
;

206 
rv
 = 
	`ngtı2_p¦_š£¹
(&
rob
->
g­p¦
, &
™
, &
ng
->
¿nge
,‚g);

207 ià(
rv
 != 0) {

208 
	`ngtı2_rob_g­_d–
(
ng
, 
rob
->
mem
);

209  
rv
;

212 } ià(
	`ngtı2_¿nge_Ën
(&
r
)) {

213 
	`ngtı2_p¦_upd©e_¿nge
(&
rob
->
g­p¦
, &
g
->
¿nge
, &
r
);

214 
g
->
¿nge
 = 
r
;

216 
rv
 = 
	`rob_wr™e_d©a
(
rob
, 
m
.
begš
, 
d©a
 + (m.begš - 
off£t
),

217 
	`ngtı2_¿nge_Ën
(&
m
));

218 ià(
rv
 != 0) {

219  
rv
;

221 
	`ngtı2_p¦_™_Ãxt
(&
™
);

224 
	}
}

226 
	$ngtı2_rob_»move_´efix
(
ngtı2_rob
 *
rob
, 
ušt64_t
 
off£t
) {

227 
ngtı2_rob_g­
 *
g
;

228 
ngtı2_rob_d©a
 *
d
;

229 
ngtı2_p¦_™
 
™
;

230 
rv
;

232 
™
 = 
	`ngtı2_p¦_begš
(&
rob
->
g­p¦
);

234 ; !
	`ngtı2_p¦_™_’d
(&
™
);) {

235 
g
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

236 ià(
off£t
 <ğ
g
->
¿nge
.
begš
) {

239 ià(
off£t
 < 
g
->
¿nge
.
’d
) {

240 
ngtı2_¿nge
 
r
 = {
off£t
, 
g
->
¿nge
.
’d
};

241 
	`ngtı2_p¦_upd©e_¿nge
(&
rob
->
g­p¦
, &
g
->
¿nge
, &
r
);

242 
g
->
¿nge
.
begš
 = 
off£t
;

245 
rv
 = 
	`ngtı2_p¦_»move
(&
rob
->
g­p¦
, &
™
, &
g
->
¿nge
);

246 ià(
rv
 != 0) {

247  
rv
;

249 
	`ngtı2_rob_g­_d–
(
g
, 
rob
->
mem
);

252 
™
 = 
	`ngtı2_p¦_begš
(&
rob
->
d©­¦
);

254 ; !
	`ngtı2_p¦_™_’d
(&
™
);) {

255 
d
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

256 ià(
off£t
 < 
d
->
¿nge
.
begš
 + 
rob
->
chunk
) {

259 
rv
 = 
	`ngtı2_p¦_»move
(&
rob
->
d©­¦
, &
™
, &
d
->
¿nge
);

260 ià(
rv
 != 0) {

261  
rv
;

263 
	`ngtı2_rob_d©a_d–
(
d
, 
rob
->
mem
);

267 
	}
}

269 
size_t
 
	$ngtı2_rob_d©a_©
(
ngtı2_rob
 *
rob
, cÚ¡ 
ušt8_t
 **
pde¡
,

270 
ušt64_t
 
off£t
) {

271 
ngtı2_rob_g­
 *
g
;

272 
ngtı2_rob_d©a
 *
d
;

273 
ngtı2_p¦_™
 
™
;

275 
™
 = 
	`ngtı2_p¦_begš
(&
rob
->
g­p¦
);

276 ià(
	`ngtı2_p¦_™_’d
(&
™
)) {

280 
g
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

282 ià(
g
->
¿nge
.
begš
 <ğ
off£t
) {

286 
™
 = 
	`ngtı2_p¦_begš
(&
rob
->
d©­¦
);

287 
d
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

289 
	`as£¹
(
d
);

290 
	`as£¹
(
d
->
¿nge
.
begš
 <ğ
off£t
);

291 
	`as£¹
(
off£t
 < 
d
->
¿nge
.
begš
 + 
rob
->
chunk
);

293 *
pde¡
 = 
d
->
begš
 + (
off£t
 - d->
¿nge
.begin);

295  
	`ngtı2_mš
(
g
->
¿nge
.
begš
, 
d
->¿nge.begš + 
rob
->
chunk
è- 
off£t
;

296 
	}
}

298 
	$ngtı2_rob_pİ
(
ngtı2_rob
 *
rob
, 
ušt64_t
 
off£t
, 
size_t
 
Ën
) {

299 
ngtı2_p¦_™
 
™
;

300 
ngtı2_rob_d©a
 *
d
;

301 
rv
;

303 
™
 = 
	`ngtı2_p¦_begš
(&
rob
->
d©­¦
);

304 
d
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

306 
	`as£¹
(
d
);

308 ià(
off£t
 + 
Ën
 < 
d
->
¿nge
.
begš
 + 
rob
->
chunk
) {

312 
rv
 = 
	`ngtı2_p¦_»move
(&
rob
->
d©­¦
, 
NULL
, &
d
->
¿nge
);

313 ià(
rv
 != 0) {

314  
rv
;

316 
	`ngtı2_rob_d©a_d–
(
d
, 
rob
->
mem
);

319 
	}
}

321 
ušt64_t
 
	$ngtı2_rob_fœ¡_g­_off£t
(
ngtı2_rob
 *
rob
) {

322 
ngtı2_p¦_™
 
™
 = 
	`ngtı2_p¦_begš
(&
rob
->
g­p¦
);

323 
ngtı2_rob_g­
 *
g
;

325 ià(
	`ngtı2_p¦_™_’d
(&
™
)) {

326  
UINT64_MAX
;

329 
g
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

331  
g
->
¿nge
.
begš
;

332 
	}
}

	@lib/ngtcp2_rob.h

25 #iâdeà
NGTCP2_ROB_H


26 
	#NGTCP2_ROB_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

34 
	~"ngtı2_mem.h
"

35 
	~"ngtı2_¿nge.h
"

36 
	~"ngtı2_p¦.h
"

38 
	gngtı2_rob_g­
;

39 
ngtı2_rob_g­
 
	tngtı2_rob_g­
;

45 
	sngtı2_rob_g­
 {

47 
ngtı2_¿nge
 
	m¿nge
;

62 
ngtı2_rob_g­_Ãw
(
ngtı2_rob_g­
 **
pg
, 
ušt64_t
 
begš
, ušt64_ˆ
’d
,

63 
ngtı2_mem
 *
mem
);

70 
ngtı2_rob_g­_d–
(
ngtı2_rob_g­
 *
g
, 
ngtı2_mem
 *
mem
);

72 
	gngtı2_rob_d©a
;

73 
ngtı2_rob_d©a
 
	tngtı2_rob_d©a
;

78 
	sngtı2_rob_d©a
 {

80 
ngtı2_¿nge
 
	m¿nge
;

82 
ušt8_t
 *
	mbegš
;

84 
ušt8_t
 *
	m’d
;

101 
ngtı2_rob_d©a_Ãw
(
ngtı2_rob_d©a
 **
pd
, 
ušt64_t
 
off£t
, 
size_t
 
chunk
,

102 
ngtı2_mem
 *
mem
);

109 
ngtı2_rob_d©a_d–
(
ngtı2_rob_d©a
 *
d
, 
ngtı2_mem
 *
mem
);

118 
ngtı2_p¦
 
	mg­p¦
;

121 
ngtı2_p¦
 
	md©­¦
;

123 
ngtı2_mem
 *
	mmem
;

125 
size_t
 
	mchunk
;

126 } 
	tngtı2_rob
;

138 
ngtı2_rob_š™
(
ngtı2_rob
 *
rob
, 
size_t
 
chunk
, 
ngtı2_mem
 *
mem
);

143 
ngtı2_rob_ä“
(
ngtı2_rob
 *
rob
);

155 
ngtı2_rob_push
(
ngtı2_rob
 *
rob
, 
ušt64_t
 
off£t
, cÚ¡ 
ušt8_t
 *
d©a
,

156 
size_t
 
d©®’
);

168 
ngtı2_rob_»move_´efix
(
ngtı2_rob
 *
rob
, 
ušt64_t
 
off£t
);

176 
size_t
 
ngtı2_rob_d©a_©
(
ngtı2_rob
 *
rob
, cÚ¡ 
ušt8_t
 **
pde¡
,

177 
ušt64_t
 
off£t
);

196 
ngtı2_rob_pİ
(
ngtı2_rob
 *
rob
, 
ušt64_t
 
off£t
, 
size_t
 
Ën
);

202 
ušt64_t
 
ngtı2_rob_fœ¡_g­_off£t
(
ngtı2_rob
 *
rob
);

	@lib/ngtcp2_rtb.c

25 
	~"ngtı2_¹b.h
"

27 
	~<as£¹.h
>

28 
	~<¡ršg.h
>

30 
	~"ngtı2_maüo.h
"

31 
	~"ngtı2_cÚn.h
"

32 
	~"ngtı2_log.h
"

33 
	~"ngtı2_vec.h
"

34 
	~"ngtı2_cc.h
"

36 
	$ngtı2_äame_chaš_Ãw
(
ngtı2_äame_chaš
 **
päc
, 
ngtı2_mem
 *
mem
) {

37 *
päc
 = 
	`ngtı2_mem_m®loc
(
mem
, (
ngtı2_äame_chaš
));

38 ià(*
päc
 =ğ
NULL
) {

39  
NGTCP2_ERR_NOMEM
;

42 
	`ngtı2_äame_chaš_š™
(*
päc
);

45 
	}
}

47 
	$ngtı2_äame_chaš_exŒ®’_Ãw
(
ngtı2_äame_chaš
 **
päc
, 
size_t
 
exŒ®’
,

48 
ngtı2_mem
 *
mem
) {

49 *
päc
 = 
	`ngtı2_mem_m®loc
(
mem
, (
ngtı2_äame_chaš
è+ 
exŒ®’
);

50 ià(*
päc
 =ğ
NULL
) {

51  
NGTCP2_ERR_NOMEM
;

54 
	`ngtı2_äame_chaš_š™
(*
päc
);

57 
	}
}

59 
	$ngtı2_äame_chaš_d–
(
ngtı2_äame_chaš
 *
äc
, 
ngtı2_mem
 *
mem
) {

60 
	`ngtı2_mem_ä“
(
mem
, 
äc
);

61 
	}
}

63 
	$ngtı2_äame_chaš_š™
(
ngtı2_äame_chaš
 *
äc
è{ frc->
Ãxt
 = 
NULL
; 
	}
}

65 
	$ngtı2_¡»am_äame_chaš_Ãw
(
ngtı2_¡»am_äame_chaš
 **
päc
,

66 
ngtı2_mem
 *
mem
) {

67 *
päc
 = 
	`ngtı2_mem_m®loc
(
mem
, (
ngtı2_¡»am_äame_chaš
));

68 ià(*
päc
 =ğ
NULL
) {

69  
NGTCP2_ERR_NOMEM
;

72 
	`ngtı2_äame_chaš_š™
(&(*
päc
)->
äc
);

73 (*
päc
)->
³
.
šdex
 = 
NGTCP2_PQ_BAD_INDEX
;

76 
	}
}

78 
	$ngtı2_¡»am_äame_chaš_d–
(
ngtı2_¡»am_äame_chaš
 *
äc
,

79 
ngtı2_mem
 *
mem
) {

80 
	`ngtı2_mem_ä“
(
mem
, 
äc
);

81 
	}
}

83 
	$ngtı2_üy±o_äame_chaš_Ãw
(
ngtı2_üy±o_äame_chaš
 **
päc
,

84 
ngtı2_mem
 *
mem
) {

85 *
päc
 = 
	`ngtı2_mem_m®loc
(
mem
, (
ngtı2_üy±o_äame_chaš
));

86 ià(*
päc
 =ğ
NULL
) {

87  
NGTCP2_ERR_NOMEM
;

90 
	`ngtı2_äame_chaš_š™
(&(*
päc
)->
äc
);

91 (*
päc
)->
³
.
šdex
 = 
NGTCP2_PQ_BAD_INDEX
;

94 
	}
}

96 
	$ngtı2_üy±o_äame_chaš_d–
(
ngtı2_üy±o_äame_chaš
 *
äc
,

97 
ngtı2_mem
 *
mem
) {

98 
	`ngtı2_mem_ä“
(
mem
, 
äc
);

99 
	}
}

101 
	$ngtı2_äame_chaš_li¡_d–
(
ngtı2_äame_chaš
 *
äc
, 
ngtı2_mem
 *
mem
) {

102 
ngtı2_äame_chaš
 *
Ãxt
;

104 ; 
äc
;) {

105 
Ãxt
 = 
äc
->next;

106 
	`ngtı2_mem_ä“
(
mem
, 
äc
);

107 
äc
 = 
Ãxt
;

109 
	}
}

111 
	$äame_chaš_š£¹
(
ngtı2_äame_chaš
 **
päc
,

112 
ngtı2_äame_chaš
 *
äc
) {

113 
ngtı2_äame_chaš
 **
¶a¡
;

115 
¶a¡
 = &
äc
; *¶a¡;…Ï¡ = &(*¶a¡)->
Ãxt
)

118 *
¶a¡
 = *
päc
;

119 *
päc
 = 
äc
;

120 
	}
}

122 
	$ngtı2_¹b_’Œy_Ãw
(
ngtı2_¹b_’Œy
 **
³Á
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

123 
ngtı2_äame_chaš
 *
äc
, 
ngtı2_t¡amp
 
ts
,

124 
size_t
 
pk’
, 
ušt8_t
 
æags
, 
ngtı2_mem
 *
mem
) {

125 (*
³Á
èğ
	`ngtı2_mem_ÿÎoc
(
mem
, 1, (
ngtı2_¹b_’Œy
));

126 ià(*
³Á
 =ğ
NULL
) {

127  
NGTCP2_ERR_NOMEM
;

130 (*
³Á
)->
hd
 = *hd;

131 (*
³Á
)->
äc
 = frc;

132 (*
³Á
)->
ts
 =s;

133 (*
³Á
)->
pk’
 =…ktlen;

134 (*
³Á
)->
æags
 = flags;

137 
	}
}

139 
	$ngtı2_¹b_’Œy_d–
(
ngtı2_¹b_’Œy
 *
’t
, 
ngtı2_mem
 *
mem
) {

140 ià(
’t
 =ğ
NULL
) {

144 
	`ngtı2_äame_chaš_li¡_d–
(
’t
->
äc
, 
mem
);

146 
	`ngtı2_mem_ä“
(
mem
, 
’t
);

147 
	}
}

149 
	$g»©”
(cÚ¡ 
ngtı2_k¦_key
 *
lhs
, cÚ¡‚gtı2_k¦_key *
rhs
) {

150  
lhs
->
i
 > 
rhs
->i;

151 
	}
}

153 
	$ngtı2_¹b_š™
(
ngtı2_¹b
 *
¹b
, 
ngtı2_deçuÉ_cc
 *
cc
, 
ngtı2_log
 *
log
,

154 
ngtı2_mem
 *
mem
) {

155 
ngtı2_k¦_key
 
šf_key
 = {-1};

157 
	`ngtı2_k¦_š™
(&
¹b
->
’ts
, 
g»©”
, &
šf_key
, 
mem
);

158 
¹b
->
cc
 = cc;

159 
¹b
->
log
 =†og;

160 
¹b
->
mem
 = mem;

161 
¹b
->
Ïrge¡_acked_tx_pkt_num
 = -1;

162 
¹b
->
num_ack_–ic™šg
 = 0;

163 
	}
}

165 
	$ngtı2_¹b_ä“
(
ngtı2_¹b
 *
¹b
) {

166 
ngtı2_k¦_™
 
™
;

168 ià(
¹b
 =ğ
NULL
) {

172 
™
 = 
	`ngtı2_k¦_begš
(&
¹b
->
’ts
);

174 ; !
	`ngtı2_k¦_™_’d
(&
™
); 
	`ngtı2_k¦_™_Ãxt
(&it)) {

175 
	`ngtı2_¹b_’Œy_d–
(
	`ngtı2_k¦_™_g‘
(&
™
), 
¹b
->
mem
);

178 
	`ngtı2_k¦_ä“
(&
¹b
->
’ts
);

179 
	}
}

181 
	$¹b_Ú_add
(
ngtı2_¹b
 *
¹b
, 
ngtı2_¹b_’Œy
 *
’t
) {

182 
¹b
->
cc
->
ccs
->
by‹s_š_æight
 +ğ
’t
->
pk’
;

184 ià(
’t
->
æags
 & 
NGTCP2_RTB_FLAG_ACK_ELICITING
) {

185 ++
¹b
->
num_ack_–ic™šg
;

187 
	}
}

189 
	$¹b_Ú_»move
(
ngtı2_¹b
 *
¹b
, 
ngtı2_¹b_’Œy
 *
’t
) {

190 ià(
’t
->
æags
 & 
NGTCP2_RTB_FLAG_ACK_ELICITING
) {

191 
	`as£¹
(
¹b
->
num_ack_–ic™šg
);

192 --
¹b
->
num_ack_–ic™šg
;

195 
	`as£¹
(
¹b
->
cc
->
ccs
->
by‹s_š_æight
 >ğ
’t
->
pk’
);

196 
¹b
->
cc
->
ccs
->
by‹s_š_æight
 -ğ
’t
->
pk’
;

197 
	}
}

199 
	$¹b_Ú_pkt_lo¡
(
ngtı2_¹b
 *
¹b
, 
ngtı2_äame_chaš
 **
päc
,

200 
ngtı2_¹b_’Œy
 *
’t
) {

201 ià(
’t
->
æags
 & 
NGTCP2_RTB_FLAG_PROBE
) {

204 
	`ngtı2_log_pkt_lo¡
(
¹b
->
log
, &
’t
->
hd
,ƒÁ->
ts
);

208 ià(
’t
->
äc
) {

210 
	`äame_chaš_š£¹
(
päc
, 
’t
->
äc
);

211 
’t
->
äc
 = 
NULL
;

214 
	`ngtı2_¹b_’Œy_d–
(
’t
, 
¹b
->
mem
);

215 
	}
}

217 
	$ngtı2_¹b_add
(
ngtı2_¹b
 *
¹b
, 
ngtı2_¹b_’Œy
 *
’t
) {

218 
rv
;

220 
’t
->
Ãxt
 = 
NULL
;

222 
rv
 = 
	`ngtı2_k¦_š£¹
(&
¹b
->
’ts
, 
NULL
,

223 (cÚ¡ 
ngtı2_k¦_key
 *)&
’t
->
hd
.
pkt_num
,ƒnt);

224 ià(
rv
 != 0) {

225  
rv
;

228 
	`¹b_Ú_add
(
¹b
, 
’t
);

231 
	}
}

233 
ngtı2_k¦_™
 
	$ngtı2_¹b_h—d
(
ngtı2_¹b
 *
¹b
) {

234  
	`ngtı2_k¦_begš
(&
¹b
->
’ts
);

235 
	}
}

237 
	$¹b_»move
(
ngtı2_¹b
 *
¹b
, 
ngtı2_k¦_™
 *
™
,

238 
ngtı2_¹b_’Œy
 *
’t
) {

239 
rv
;

241 
rv
 = 
	`ngtı2_k¦_»move
(&
¹b
->
’ts
, 
™
,

242 (cÚ¡ 
ngtı2_k¦_key
 *)&
’t
->
hd
.
pkt_num
);

243 ià(
rv
 != 0) {

244  
rv
;

246 
	`¹b_Ú_»move
(
¹b
, 
’t
);

247 
	`ngtı2_¹b_’Œy_d–
(
’t
, 
¹b
->
mem
);

249 
	}
}

251 
	$ÿÎ_acked_¡»am_off£t
(
ngtı2_¹b_’Œy
 *
’t
, 
ngtı2_cÚn
 *
cÚn
) {

252 
ngtı2_äame_chaš
 *
äc
;

253 
ušt64_t
 
´ev_¡»am_off£t
, 
¡»am_off£t
;

254 
ngtı2_¡rm
 *
¡rm
;

255 
rv
;

256 
size_t
 
d©®’
;

257 
ngtı2_¡rm
 *
üy±o
 = &
cÚn
->crypto;

259 
äc
 = 
’t
->äc; frc; frøğäc->
Ãxt
) {

260 
äc
->
ä
.
ty³
) {

261 
NGTCP2_FRAME_STREAM
:

262 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
äc
->
ä
.
¡»am
.
¡»am_id
);

263 ià(
¡rm
 =ğ
NULL
) {

266 
´ev_¡»am_off£t
 =

267 
	`ngtı2_g­Œ_fœ¡_g­_off£t
(&
¡rm
->
acked_tx_off£t
);

268 
rv
 = 
	`ngtı2_g­Œ_push
(

269 &
¡rm
->
acked_tx_off£t
, 
äc
->
ä
.
¡»am
.
off£t
,

270 
	`ngtı2_vec_Ën
(
äc
->
ä
.
¡»am
.
d©a
, frc->ä.¡»am.
d©aút
));

271 ià(
rv
 != 0) {

272  
rv
;

275 ià(
cÚn
->
ÿÎbacks
.
acked_¡»am_d©a_off£t
) {

276 
¡»am_off£t
 = 
	`ngtı2_g­Œ_fœ¡_g­_off£t
(&
¡rm
->
acked_tx_off£t
);

277 
d©®’
 = 
¡»am_off£t
 - 
´ev_¡»am_off£t
;

278 ià(
d©®’
 =ğ0 && !
äc
->
ä
.
¡»am
.
fš
) {

282 
rv
 = 
cÚn
->
ÿÎbacks
.
	`acked_¡»am_d©a_off£t
(

283 
cÚn
, 
¡rm
->
¡»am_id
, 
´ev_¡»am_off£t
, 
d©®’
, cÚn->
u£r_d©a
,

284 
¡rm
->
¡»am_u£r_d©a
);

285 ià(
rv
 != 0) {

286  
NGTCP2_ERR_CALLBACK_FAILURE
;

290 
rv
 = 
	`ngtı2_cÚn_şo£_¡»am_if_shut_rdwr
(
cÚn
, 
¡rm
, 
NGTCP2_NO_ERROR
);

291 ià(
rv
 != 0) {

292  
rv
;

295 
NGTCP2_FRAME_CRYPTO
:

296 
´ev_¡»am_off£t
 =

297 
	`ngtı2_g­Œ_fœ¡_g­_off£t
(&
üy±o
->
acked_tx_off£t
);

298 
rv
 = 
	`ngtı2_g­Œ_push
(

299 &
üy±o
->
acked_tx_off£t
, 
äc
->
ä
.üy±o.
Üd”ed_off£t
,

300 
	`ngtı2_vec_Ën
(
äc
->
ä
.
üy±o
.
d©a
, frc->ä.üy±o.
d©aút
));

301 ià(
rv
 != 0) {

302  
rv
;

305 ià(
cÚn
->
ÿÎbacks
.
acked_üy±o_off£t
) {

306 
¡»am_off£t
 = 
	`ngtı2_g­Œ_fœ¡_g­_off£t
(&
üy±o
->
acked_tx_off£t
);

307 
d©®’
 = 
¡»am_off£t
 - 
´ev_¡»am_off£t
;

308 ià(
d©®’
 == 0) {

312 
rv
 = 
cÚn
->
ÿÎbacks
.
	`acked_üy±o_off£t
(cÚn, 
´ev_¡»am_off£t
,

313 
d©®’
, 
cÚn
->
u£r_d©a
);

314 ià(
rv
 != 0) {

315  
NGTCP2_ERR_CALLBACK_FAILURE
;

319 
NGTCP2_FRAME_RESET_STREAM
:

320 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
äc
->
ä
.
»£t_¡»am
.
¡»am_id
);

321 ià(
¡rm
 =ğ
NULL
) {

324 
¡rm
->
æags
 |ğ
NGTCP2_STRM_FLAG_RST_ACKED
;

325 
rv
 = 
	`ngtı2_cÚn_şo£_¡»am_if_shut_rdwr
(
cÚn
, 
¡rm
, 
NGTCP2_NO_ERROR
);

326 ià(
rv
 != 0) {

327  
rv
;

333 
	}
}

335 
	$¹b_Ú_pkt_acked
(
ngtı2_¹b
 *
¹b
, 
ngtı2_¹b_’Œy
 *
’t
) {

336 
ngtı2_cc_pkt
 
pkt
;

338 ià(!(
’t
->
æags
 & 
NGTCP2_RTB_FLAG_ACK_ELICITING
)) {

342 
	`ngtı2_deçuÉ_cc_Ú_pkt_acked
(

343 
¹b
->
cc
, 
	`ngtı2_cc_pkt_š™
(&
pkt
, 
’t
->
hd
.
pkt_num
,ƒÁ->
pk’
,ƒÁ->
ts
));

344 
	}
}

346 
	$ngtı2_¹b_»cv_ack
(
ngtı2_¹b
 *
¹b
, cÚ¡ 
ngtı2_ack
 *
ä
,

347 
ngtı2_cÚn
 *
cÚn
, 
ngtı2_t¡amp
 
ts
) {

348 
ngtı2_¹b_’Œy
 *
’t
;

349 
ušt64_t
 
Ïrge¡_ack
 = 
ä
->Ïrge¡_ack, 
mš_ack
;

350 
size_t
 
i
;

351 
rv
;

352 
ngtı2_k¦_™
 
™
;

353 
ngtı2_k¦_key
 
key
;

354 
ngtı2_rcvry_¡©
 *
rcs
 = 
cÚn
 ? &cÚn->rc : 
NULL
;

356 
¹b
->
Ïrge¡_acked_tx_pkt_num
 =

357 
	`ngtı2_max
(
¹b
->
Ïrge¡_acked_tx_pkt_num
, (
št64_t
)
Ïrge¡_ack
);

360 
™
 = 
	`ngtı2_k¦_low”_bound
(&
¹b
->
’ts
, (cÚ¡ 
ngtı2_k¦_key
 *)&
Ïrge¡_ack
);

362 ià(
	`ngtı2_k¦_™_’d
(&
™
)) {

366 
mš_ack
 = 
Ïrge¡_ack
 - 
ä
->
fœ¡_ack_blkËn
;

368 ; !
	`ngtı2_k¦_™_’d
(&
™
);) {

369 
key
 = 
	`ngtı2_k¦_™_key
(&
™
);

370 ià(
mš_ack
 <ğ(
ušt64_t
)
key
.
i
 && (ušt64_t)key.˜<ğ
Ïrge¡_ack
) {

371 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

372 ià(
cÚn
) {

373 
rv
 = 
	`ÿÎ_acked_¡»am_off£t
(
’t
, 
cÚn
);

374 ià(
rv
 != 0) {

375  
rv
;

377 ià(
Ïrge¡_ack
 =ğ(
ušt64_t
)
key
.
i
 &&

378 (
’t
->
æags
 & 
NGTCP2_RTB_FLAG_ACK_ELICITING
)) {

379 
	`ngtı2_cÚn_upd©e_¹t
(
cÚn
, 
ts
 - 
’t
->ts, 
ä
->
ack_d–ay_unsÿËd
);

381 
	`¹b_Ú_pkt_acked
(
¹b
, 
’t
);

385 
rv
 = 
	`¹b_»move
(
¹b
, &
™
, 
’t
);

386 ià(
rv
 != 0) {

387  
rv
;

394 
i
 = 0; i < 
ä
->
num_blks
;) {

395 
Ïrge¡_ack
 = 
mš_ack
 - 
ä
->
blks
[
i
].
g­
 - 2;

397 
mš_ack
 = 
Ïrge¡_ack
 - 
ä
->
blks
[
i
].
blkËn
;

399 
™
 = 
	`ngtı2_k¦_low”_bound
(&
¹b
->
’ts
,

400 (cÚ¡ 
ngtı2_k¦_key
 *)&
Ïrge¡_ack
);

401 ià(
	`ngtı2_k¦_™_’d
(&
™
)) {

405 ; !
	`ngtı2_k¦_™_’d
(&
™
);) {

406 
key
 = 
	`ngtı2_k¦_™_key
(&
™
);

407 ià((
ušt64_t
)
key
.
i
 < 
mš_ack
) {

410 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

411 ià(
cÚn
) {

412 
rv
 = 
	`ÿÎ_acked_¡»am_off£t
(
’t
, 
cÚn
);

413 ià(
rv
 != 0) {

414  
rv
;

417 
	`¹b_Ú_pkt_acked
(
¹b
, 
’t
);

419 
rv
 = 
	`¹b_»move
(
¹b
, &
™
, 
’t
);

420 ià(
rv
 != 0) {

421  
rv
;

425 ++
i
;

428 ià(!
rcs
) {

432 
rcs
->
üy±o_couÁ
 = 0;

433 
rcs
->
±o_couÁ
 = 0;

434 
rcs
->
´obe_pkt_Ëá
 = 0;

437 
	}
}

439 
	$pkt_lo¡
(
ngtı2_rcvry_¡©
 *
rcs
, cÚ¡ 
ngtı2_¹b_’Œy
 *
’t
,

440 
ušt64_t
 
loss_d–ay
, 
ngtı2_t¡amp
 
lo¡_£nd_time
,

441 
št64_t
 
lo¡_pkt_num
) {

442 ià(
’t
->
ts
 <ğ
lo¡_£nd_time
 || (
št64_t
ëÁ->
hd
.
pkt_num
 <ğ
lo¡_pkt_num
) {

446 ià(
rcs
->
loss_time
 == 0) {

447 
rcs
->
loss_time
 = 
’t
->
ts
 + 
loss_d–ay
;

449 
rcs
->
loss_time
 = 
	`ngtı2_mš
Ôcs->loss_time, 
’t
->
ts
 + 
loss_d–ay
);

453 
	}
}

459 
ušt64_t
 
	$compu‹_pkt_loss_d–ay
(cÚ¡ 
ngtı2_rcvry_¡©
 *
rcs
) {

460  (
ušt64_t
)(
	`ngtı2_max
(()
rcs
->
Ï‹¡_¹t
,„cs->
smoÙhed_¹t
) * 9 /

462 
	}
}

464 
	$ngtı2_¹b_d‘eù_lo¡_pkt
(
ngtı2_¹b
 *
¹b
, 
ngtı2_äame_chaš
 **
päc
,

465 
ngtı2_rcvry_¡©
 *
rcs
, 
ngtı2_t¡amp
 
ts
) {

466 
ngtı2_¹b_’Œy
 *
’t
;

467 
ušt64_t
 
loss_d–ay
;

468 
ngtı2_t¡amp
 
lo¡_£nd_time
;

469 
ngtı2_k¦_™
 
™
;

470 
št64_t
 
lo¡_pkt_num
;

471 
rv
;

473 
rcs
->
loss_time
 = 0;

474 
loss_d–ay
 = 
	`compu‹_pkt_loss_d–ay
(
rcs
);

475 
lo¡_£nd_time
 = 
ts
 - 
loss_d–ay
;

476 
lo¡_pkt_num
 = 
¹b
->
Ïrge¡_acked_tx_pkt_num
 - 
NGTCP2_PACKET_THRESHOLD
;

478 
™
 = 
	`ngtı2_k¦_low”_bound
(

479 &
¹b
->
’ts
, (cÚ¡ 
ngtı2_k¦_key
 *)&¹b->
Ïrge¡_acked_tx_pkt_num
);

480 ; !
	`ngtı2_k¦_™_’d
(&
™
); 
	`ngtı2_k¦_™_Ãxt
(&it)) {

481 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

483 ià(
	`pkt_lo¡
(
rcs
, 
’t
, 
loss_d–ay
, 
lo¡_£nd_time
, 
lo¡_pkt_num
)) {

485 
	`ngtı2_deçuÉ_cc_cÚge¡iÚ_ev’t
(
¹b
->
cc
, 
’t
->
ts
, 
rcs
,s);

487 ; !
	`ngtı2_k¦_™_’d
(&
™
);) {

488 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

489 
rv
 = 
	`ngtı2_k¦_»move
(&
¹b
->
’ts
, &
™
,

490 (cÚ¡ 
ngtı2_k¦_key
 *)&
’t
->
hd
.
pkt_num
);

491 ià(
rv
 != 0) {

492  
rv
;

494 
	`¹b_Ú_»move
(
¹b
, 
’t
);

495 
	`¹b_Ú_pkt_lo¡
(
¹b
, 
päc
, 
’t
);

503 
	}
}

505 
	$ngtı2_¹b_»move_®l
(
ngtı2_¹b
 *
¹b
, 
ngtı2_äame_chaš
 **
päc
) {

506 
ngtı2_¹b_’Œy
 *
’t
;

507 
ngtı2_k¦_™
 
™
;

508 
rv
;

510 
™
 = 
	`ngtı2_k¦_begš
(&
¹b
->
’ts
);

512 ; !
	`ngtı2_k¦_™_’d
(&
™
);) {

513 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

517 
	`ngtı2_log_pkt_lo¡
(
¹b
->
log
, &
’t
->
hd
,ƒÁ->
ts
);

519 
	`¹b_Ú_»move
(
¹b
, 
’t
);

520 
rv
 = 
	`ngtı2_k¦_»move
(&
¹b
->
’ts
, &
™
,

521 (cÚ¡ 
ngtı2_k¦_key
 *)&
’t
->
hd
.
pkt_num
);

522 ià(
rv
 != 0) {

523  
rv
;

525 
	`äame_chaš_š£¹
(
päc
, 
’t
->
äc
);

526 
’t
->
äc
 = 
NULL
;

527 
	`ngtı2_¹b_’Œy_d–
(
’t
, 
¹b
->
mem
);

531 
	}
}

533 
	$ngtı2_¹b_em±y
(
ngtı2_¹b
 *
¹b
) {

534  
	`ngtı2_k¦_Ën
(&
¹b
->
’ts
) == 0;

535 
	}
}

537 
	$ngtı2_¹b_ş—r
(
ngtı2_¹b
 *
¹b
) {

538 
ngtı2_k¦_™
 
™
;

539 
ngtı2_¹b_’Œy
 *
’t
;

541 
™
 = 
	`ngtı2_k¦_begš
(&
¹b
->
’ts
);

543 ; !
	`ngtı2_k¦_™_’d
(&
™
); 
	`ngtı2_k¦_™_Ãxt
(&it)) {

544 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

545 
¹b
->
cc
->
ccs
->
by‹s_š_æight
 -ğ
’t
->
pk’
;

546 
	`ngtı2_¹b_’Œy_d–
(
’t
, 
¹b
->
mem
);

548 
	`ngtı2_k¦_ş—r
(&
¹b
->
’ts
);

550 
¹b
->
Ïrge¡_acked_tx_pkt_num
 = -1;

551 
¹b
->
num_ack_–ic™šg
 = 0;

552 
	}
}

554 
size_t
 
	$ngtı2_¹b_num_ack_–ic™šg
(
ngtı2_¹b
 *
¹b
) {

555  
¹b
->
num_ack_–ic™šg
;

556 
	}
}

	@lib/ngtcp2_rtb.h

25 #iâdeà
NGTCP2_RTB_H


26 
	#NGTCP2_RTB_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

34 
	~"ngtı2_k¦.h
"

35 
	~"ngtı2_pq.h
"

37 
	gngtı2_cÚn
;

38 
ngtı2_cÚn
 
	tngtı2_cÚn
;

40 
	gngtı2_äame_chaš
;

41 
ngtı2_äame_chaš
 
	tngtı2_äame_chaš
;

43 
	gngtı2_log
;

44 
ngtı2_log
 
	tngtı2_log
;

46 
	gngtı2_deçuÉ_cc
;

47 
ngtı2_deçuÉ_cc
 
	tngtı2_deçuÉ_cc
;

52 
	sngtı2_äame_chaš
 {

53 
ngtı2_äame_chaš
 *
	mÃxt
;

54 
ngtı2_äame
 
	mä
;

59 
	#NGTCP2_MAX_STREAM_DATACNT
 8

	)

61 
	gngtı2_¡»am_äame_chaš
;

62 
ngtı2_¡»am_äame_chaš
 
	tngtı2_¡»am_äame_chaš
;

67 
	sngtı2_¡»am_äame_chaš
 {

69 
ngtı2_äame_chaš
 
	mäc
;

71 
ngtı2_äame_chaš
 *
	mÃxt
;

72 
ngtı2_¡»am
 
	mä
;

73 
ngtı2_vec
 
	mexŒa
[
NGTCP2_MAX_STREAM_DATACNT
 - 1];

76 
ngtı2_pq_’Œy
 
	m³
;

81 
	#NGTCP2_MAX_CRYPTO_DATACNT
 8

	)

83 
	gngtı2_üy±o_äame_chaš
;

84 
ngtı2_üy±o_äame_chaš
 
	tngtı2_üy±o_äame_chaš
;

89 
	sngtı2_üy±o_äame_chaš
 {

91 
ngtı2_äame_chaš
 
	mäc
;

93 
ngtı2_äame_chaš
 *
	mÃxt
;

94 
ngtı2_üy±o
 
	mä
;

95 
ngtı2_vec
 
	mexŒa
[
NGTCP2_MAX_CRYPTO_DATACNT
 - 1];

98 
ngtı2_pq_’Œy
 
	m³
;

111 
ngtı2_äame_chaš_Ãw
(
ngtı2_äame_chaš
 **
päc
, 
ngtı2_mem
 *
mem
);

118 
ngtı2_äame_chaš_exŒ®’_Ãw
(
ngtı2_äame_chaš
 **
päc
, 
size_t
 
exŒ®’
,

119 
ngtı2_mem
 *
mem
);

125 
ngtı2_äame_chaš_d–
(
ngtı2_äame_chaš
 *
äc
, 
ngtı2_mem
 *
mem
);

130 
ngtı2_äame_chaš_š™
(
ngtı2_äame_chaš
 *
äc
);

143 
ngtı2_¡»am_äame_chaš_Ãw
(
ngtı2_¡»am_äame_chaš
 **
päc
,

144 
ngtı2_mem
 *
mem
);

146 
ngtı2_¡»am_äame_chaš_d–
(
ngtı2_¡»am_äame_chaš
 *
äc
,

147 
ngtı2_mem
 *
mem
);

160 
ngtı2_üy±o_äame_chaš_Ãw
(
ngtı2_üy±o_äame_chaš
 **
päc
,

161 
ngtı2_mem
 *
mem
);

163 
ngtı2_üy±o_äame_chaš_d–
(
ngtı2_üy±o_äame_chaš
 *
äc
,

164 
ngtı2_mem
 *
mem
);

170 
ngtı2_äame_chaš_li¡_d–
(
ngtı2_äame_chaš
 *
äc
, 
ngtı2_mem
 *
mem
);

173 
	mNGTCP2_RTB_FLAG_NONE
 = 0x00,

176 
	mNGTCP2_RTB_FLAG_PROBE
 = 0x01,

179 
	mNGTCP2_RTB_FLAG_CRYPTO_PKT
 = 0x02,

182 
	mNGTCP2_RTB_FLAG_ACK_ELICITING
 = 0x4,

183 } 
	tngtı2_¹b_æag
;

185 
	gngtı2_¹b_’Œy
;

186 
ngtı2_¹b_’Œy
 
	tngtı2_¹b_’Œy
;

192 
	sngtı2_¹b_’Œy
 {

193 
ngtı2_¹b_’Œy
 *
	mÃxt
;

195 
ngtı2_pkt_hd
 
	mhd
;

196 
ngtı2_äame_chaš
 *
	mäc
;

199 
ngtı2_t¡amp
 
	mts
;

201 
size_t
 
	mpk’
;

203 
ušt8_t
 
	mæags
;

217 
ngtı2_¹b_’Œy_Ãw
(
ngtı2_¹b_’Œy
 **
³Á
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

218 
ngtı2_äame_chaš
 *
äc
, 
ngtı2_t¡amp
 
ts
,

219 
size_t
 
pk’
, 
ušt8_t
 
æags
, 
ngtı2_mem
 *
mem
);

225 
ngtı2_¹b_’Œy_d–
(
ngtı2_¹b_’Œy
 *
’t
, 
ngtı2_mem
 *
mem
);

234 
ngtı2_k¦
 
	m’ts
;

235 
ngtı2_deçuÉ_cc
 *
	mcc
;

236 
ngtı2_log
 *
	mlog
;

237 
ngtı2_mem
 *
	mmem
;

240 
št64_t
 
	mÏrge¡_acked_tx_pkt_num
;

241 
size_t
 
	mnum_ack_–ic™šg
;

242 } 
	tngtı2_¹b
;

247 
ngtı2_¹b_š™
(
ngtı2_¹b
 *
¹b
, 
ngtı2_deçuÉ_cc
 *
cc
, 
ngtı2_log
 *
log
,

248 
ngtı2_mem
 *
mem
);

253 
ngtı2_¹b_ä“
(
ngtı2_¹b
 *
¹b
);

264 
ngtı2_¹b_add
(
ngtı2_¹b
 *
¹b
, 
ngtı2_¹b_’Œy
 *
’t
);

271 
ngtı2_k¦_™
 
ngtı2_¹b_h—d
(
ngtı2_¹b
 *
¹b
);

285 
ngtı2_¹b_»cv_ack
(
ngtı2_¹b
 *
¹b
, cÚ¡ 
ngtı2_ack
 *
ä
,

286 
ngtı2_cÚn
 *
cÚn
, 
ngtı2_t¡amp
 
ts
);

300 
ngtı2_¹b_d‘eù_lo¡_pkt
(
ngtı2_¹b
 *
¹b
, 
ngtı2_äame_chaš
 **
päc
,

301 
ngtı2_rcvry_¡©
 *
rcs
, 
ngtı2_t¡amp
 
ts
);

314 
ngtı2_¹b_»move_®l
(
ngtı2_¹b
 *
¹b
, 
ngtı2_äame_chaš
 **
päc
);

319 
ngtı2_¹b_em±y
(
ngtı2_¹b
 *
¹b
);

326 
ngtı2_¹b_ş—r
(
ngtı2_¹b
 *
¹b
);

332 
size_t
 
ngtı2_¹b_num_ack_–ic™šg
(
ngtı2_¹b
 *
¹b
);

	@lib/ngtcp2_str.c

25 
	~"ngtı2_¡r.h
"

27 
	~<¡ršg.h
>

28 
	~<as£¹.h
>

30 
ušt8_t
 *
	$ngtı2_ıymem
(
ušt8_t
 *
de¡
, cÚ¡ ušt8_ˆ*
¤c
, 
size_t
 
n
) {

31 
	`memıy
(
de¡
, 
¤c
, 
n
);

32  
de¡
 + 
n
;

33 
	}
}

35 
	#LOWER_XDIGITS
 "0123456789abcdef"

	)

37 
ušt8_t
 *
	$ngtı2_’code_hex
(
ušt8_t
 *
de¡
, cÚ¡ ušt8_ˆ*
d©a
, 
size_t
 
Ën
) {

38 
size_t
 
i
;

39 
ušt8_t
 *
p
 = 
de¡
;

41 
i
 = 0; i < 
Ën
; ++i) {

42 *
p
++ = (
ušt8_t
)
LOWER_XDIGITS
[
d©a
[
i
] >> 4];

43 *
p
++ = (
ušt8_t
)
LOWER_XDIGITS
[
d©a
[
i
] & 0xf];

46 *
p
 = '\0';

48  
de¡
;

49 
	}
}

51 
	$ngtı2_v”ify_¡©–ess_»Œy_tok’
(cÚ¡ 
ušt8_t
 *
wªt
,

52 cÚ¡ 
ušt8_t
 *
gÙ
) {

53 
size_t
 
i
;

54 
rv
;

57 
i
 = 0; i < 
NGTCP2_STATELESS_RESET_TOKENLEN
; ++i) {

58 ià(
gÙ
[
i
] != 0) {

63 ià(
i
 =ğ
NGTCP2_STATELESS_RESET_TOKENLEN
) {

64  
NGTCP2_ERR_INVALID_ARGUMENT
;

67 
rv
 = 0;

68 
i
 = 0; i < 
NGTCP2_STATELESS_RESET_TOKENLEN
; ++i) {

69 
rv
 |ğ
wªt
[
i
] ^ 
gÙ
[i];

72  
rv
 =ğ0 ? 0 : 
NGTCP2_ERR_INVALID_ARGUMENT
;

73 
	}
}

	@lib/ngtcp2_str.h

25 #iâdeà
NGTCP2_STR_H


26 
	#NGTCP2_STR_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

37 
ušt8_t
 *
	mba£
;

39 
size_t
 
	mËn
;

40 } 
	tngtı2_¬¿y
;

42 
ušt8_t
 *
ngtı2_ıymem
(ušt8_ˆ*
de¡
, cÚ¡ ušt8_ˆ*
¤c
, 
size_t
 
n
);

50 
ušt8_t
 *
ngtı2_’code_hex
(ušt8_ˆ*
de¡
, cÚ¡ ušt8_ˆ*
d©a
, 
size_t
 
Ën
);

61 
ngtı2_v”ify_¡©–ess_»Œy_tok’
(cÚ¡ 
ušt8_t
 *
wªt
,

62 cÚ¡ 
ušt8_t
 *
gÙ
);

	@lib/ngtcp2_strm.c

25 
	~"ngtı2_¡rm.h
"

27 
	~<¡ršg.h
>

28 
	~<as£¹.h
>

30 
	~"ngtı2_¹b.h
"

31 
	~"ngtı2_pkt.h
"

32 
	~"ngtı2_vec.h
"

33 
	~"ngtı2_maüo.h
"

35 
	$off£t_Ëss
(cÚ¡ 
ngtı2_pq_’Œy
 *
lhs
, cÚ¡‚gtı2_pq_’Œy *
rhs
) {

36 
ngtı2_¡»am_äame_chaš
 *
läc
 =

37 
	`ngtı2_¡ruù_of
(
lhs
, 
ngtı2_¡»am_äame_chaš
, 
³
);

38 
ngtı2_¡»am_äame_chaš
 *
räc
 =

39 
	`ngtı2_¡ruù_of
(
rhs
, 
ngtı2_¡»am_äame_chaš
, 
³
);

41  
läc
->
ä
.
off£t
 < 
räc
->fr.offset;

42 
	}
}

44 
	$ngtı2_¡rm_š™
(
ngtı2_¡rm
 *
¡rm
, 
ušt64_t
 
¡»am_id
, 
ušt32_t
 
æags
,

45 
ušt64_t
 
max_rx_off£t
, ušt64_ˆ
max_tx_off£t
,

46 *
¡»am_u£r_d©a
, 
ngtı2_mem
 *
mem
) {

47 
rv
;

49 
¡rm
->
cyşe
 = 0;

50 
¡rm
->
tx_off£t
 = 0;

51 
¡rm
->
Ï¡_rx_off£t
 = 0;

52 
¡rm
->
nbufã»d
 = 0;

53 
¡rm
->
¡»am_id
 = stream_id;

54 
¡rm
->
æags
 = flags;

55 
¡rm
->
¡»am_u£r_d©a
 = stream_user_data;

56 
¡rm
->
max_rx_off£t
 = sŒm->
un£Á_max_rx_off£t
 = max_rx_offset;

57 
¡rm
->
max_tx_off£t
 = max_tx_offset;

58 
¡rm
->
me
.
key
 = 
¡»am_id
;

59 
¡rm
->
me
.
Ãxt
 = 
NULL
;

60 
¡rm
->
³
.
šdex
 = 
NGTCP2_PQ_BAD_INDEX
;

61 
¡rm
->
mem
 = mem;

67 
¡rm
->
­p_”rÜ_code
 = 0;

68 
	`mem£t
(&
¡rm
->
tx_buf
, 0, (strm->tx_buf));

70 
rv
 = 
	`ngtı2_g­Œ_š™
(&
¡rm
->
acked_tx_off£t
, 
mem
);

71 ià(
rv
 != 0) {

72 
ç_g­Œ_š™
;

75 
rv
 = 
	`ngtı2_rob_š™
(&
¡rm
->
rob
, 8 * 1024, 
mem
);

76 ià(
rv
 != 0) {

77 
ç_rob_š™
;

80 
	`ngtı2_pq_š™
(&
¡rm
->
¡»amäq
, 
off£t_Ëss
, 
mem
);

84 
ç_rob_š™
:

85 
	`ngtı2_g­Œ_ä“
(&
¡rm
->
acked_tx_off£t
);

86 
ç_g­Œ_š™
:

87  
rv
;

88 
	}
}

90 
	$ngtı2_¡rm_ä“
(
ngtı2_¡rm
 *
¡rm
) {

91 
ngtı2_¡»am_äame_chaš
 *
äc
;

93 ià(
¡rm
 =ğ
NULL
) {

97 ; !
	`ngtı2_pq_em±y
(&
¡rm
->
¡»amäq
);) {

98 
äc
 = 
	`ngtı2_¡ruù_of
(
	`ngtı2_pq_tİ
(&
¡rm
->
¡»amäq
),

99 
ngtı2_¡»am_äame_chaš
, 
³
);

100 
	`ngtı2_pq_pİ
(&
¡rm
->
¡»amäq
);

101 
	`ngtı2_¡»am_äame_chaš_d–
(
äc
, 
¡rm
->
mem
);

104 
	`ngtı2_pq_ä“
(&
¡rm
->
¡»amäq
);

105 
	`ngtı2_rob_ä“
(&
¡rm
->
rob
);

106 
	`ngtı2_g­Œ_ä“
(&
¡rm
->
acked_tx_off£t
);

107 
	}
}

109 
ušt64_t
 
	$ngtı2_¡rm_rx_off£t
(
ngtı2_¡rm
 *
¡rm
) {

110  
	`ngtı2_rob_fœ¡_g­_off£t
(&
¡rm
->
rob
);

111 
	}
}

113 
	$ngtı2_¡rm_»cv_»Üd”šg
(
ngtı2_¡rm
 *
¡rm
, cÚ¡ 
ušt8_t
 *
d©a
,

114 
size_t
 
d©®’
, 
ušt64_t
 
off£t
) {

115  
	`ngtı2_rob_push
(&
¡rm
->
rob
, 
off£t
, 
d©a
, 
d©®’
);

116 
	}
}

118 
	$ngtı2_¡rm_shutdown
(
ngtı2_¡rm
 *
¡rm
, 
ušt32_t
 
æags
) {

119 
¡rm
->
æags
 |ğæag & 
NGTCP2_STRM_FLAG_SHUT_RDWR
;

120 
	}
}

122 
	$ngtı2_¡rm_¡»amäq_push
(
ngtı2_¡rm
 *
¡rm
,

123 
ngtı2_¡»am_äame_chaš
 *
äc
) {

124 
ngtı2_¡»am
 *
ä
 = &
äc
->fr;

126 
	`as£¹
(
ä
->
ty³
 =ğ
NGTCP2_FRAME_STREAM
);

127 
	`as£¹
(
äc
->
Ãxt
 =ğ
NULL
);

129  
	`ngtı2_pq_push
(&
¡rm
->
¡»amäq
, &
äc
->
³
);

130 
	}
}

132 
	$ngtı2_¡rm_¡»amäq_pİ
(
ngtı2_¡rm
 *
¡rm
,

133 
ngtı2_¡»am_äame_chaš
 **
päc
, 
size_t
 
Ëá
) {

134 
ngtı2_¡»am
 *
ä
, *
nä
;

135 
ngtı2_¡»am_äame_chaš
 *
äc
, *
näc
;

136 
rv
;

137 
ssize_t
 
n¥l™
;

138 
size_t
 
nm”ged
;

139 
size_t
 
d©®’
;

141 ià(
	`ngtı2_pq_em±y
(&
¡rm
->
¡»amäq
)) {

142 *
päc
 = 
NULL
;

146 
äc
 = 
	`ngtı2_¡ruù_of
(
	`ngtı2_pq_tİ
(&
¡rm
->
¡»amäq
),

147 
ngtı2_¡»am_äame_chaš
, 
³
);

149 
ä
 = &
äc
->fr;

151 
d©®’
 = 
	`ngtı2_vec_Ën
(
ä
->
d©a
, fr->
d©aút
);

153 ià(
Ëá
 == 0) {

155 ià(
d©®’
 || !
	`ngtı2_pq_em±y
(&
¡rm
->
¡»amäq
)) {

156 *
päc
 = 
NULL
;

161 
	`ngtı2_pq_pİ
(&
¡rm
->
¡»amäq
);

162 
äc
->
³
.
šdex
 = 
NGTCP2_PQ_BAD_INDEX
;

164 ià(
d©®’
 > 
Ëá
) {

165 ià(!
	`ngtı2_pq_em±y
(&
¡rm
->
¡»amäq
)) {

166 
näc
 = 
	`ngtı2_¡ruù_of
(
	`ngtı2_pq_tİ
(&
¡rm
->
¡»amäq
),

167 
ngtı2_¡»am_äame_chaš
, 
³
);

168 
nä
 = &
näc
->
ä
;

170 ià(
ä
->
off£t
 + 
d©®’
 =ğ
nä
->offset) {

171 
n¥l™
 =

172 
	`ngtı2_vec_¥l™
(
ä
->
d©a
, &ä->
d©aút
, 
nä
->data, &nfr->datacnt,

173 
Ëá
, 
NGTCP2_MAX_STREAM_DATACNT
);

174 
	`as£¹
(
n¥l™
);

176 ià(
n¥l™
 > 0) {

177 
	`ngtı2_pq_pİ
(&
¡rm
->
¡»amäq
);

178 
nä
->
off£t
 -ğ(
size_t
)
n¥l™
;

179 
	`as£¹
(!
ä
->
fš
);

181 
rv
 = 
	`ngtı2_pq_push
(&
¡rm
->
¡»amäq
, &
näc
->
³
);

182 ià(
rv
 != 0) {

183 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

184 
	`ngtı2_¡»am_äame_chaš_d–
(
näc
, 
¡rm
->
mem
);

185 
	`ngtı2_¡»am_äame_chaš_d–
(
äc
, 
¡rm
->
mem
);

186  
rv
;

189 *
päc
 = 
äc
;

196 
rv
 = 
	`ngtı2_¡»am_äame_chaš_Ãw
(&
näc
, 
¡rm
->
mem
);

197 ià(
rv
 != 0) {

198 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

199 
	`ngtı2_¡»am_äame_chaš_d–
(
äc
, 
¡rm
->
mem
);

200  
rv
;

203 
nä
 = &
näc
->
ä
;

204 
nä
->
ty³
 = 
NGTCP2_FRAME_STREAM
;

205 
nä
->
æags
 = 0;

206 
nä
->
fš
 = 
ä
->fin;

207 
nä
->
¡»am_id
 = 
ä
->stream_id;

208 
nä
->
off£t
 = 
ä
->off£ˆ+ 
Ëá
;

209 
nä
->
d©aút
 = 0;

211 
	`ngtı2_vec_¥l™
(
ä
->
d©a
, &ä->
d©aút
, 
nä
->d©a, &nä->d©aút, 
Ëá
,

212 
NGTCP2_MAX_STREAM_DATACNT
);

214 
ä
->
fš
 = 0;

216 
rv
 = 
	`ngtı2_pq_push
(&
¡rm
->
¡»amäq
, &
näc
->
³
);

217 ià(
rv
 != 0) {

218 
	`as£¹
(
	`ngtı2_”r_is_çl
(
rv
));

219 
	`ngtı2_¡»am_äame_chaš_d–
(
näc
, 
¡rm
->
mem
);

220 
	`ngtı2_¡»am_äame_chaš_d–
(
äc
, 
¡rm
->
mem
);

221  
rv
;

224 *
päc
 = 
äc
;

231 ià(
ä
->
d©aút
 =ğ
NGTCP2_MAX_STREAM_DATACNT
) {

232 *
päc
 = 
äc
;

236 
Ëá
 -ğ
d©®’
;

238 ; 
Ëá
 && 
ä
->
d©aút
 < 
NGTCP2_MAX_STREAM_DATACNT
 &&

239 !
	`ngtı2_pq_em±y
(&
¡rm
->
¡»amäq
);) {

240 
näc
 = 
	`ngtı2_¡ruù_of
(
	`ngtı2_pq_tİ
(&
¡rm
->
¡»amäq
),

241 
ngtı2_¡»am_äame_chaš
, 
³
);

242 
nä
 = &
näc
->
ä
;

244 ià(
nä
->
off£t
 !ğ
ä
->off£ˆ+ 
d©®’
) {

245 
	`as£¹
(
ä
->
off£t
 + 
d©®’
 < 
nä
->offset);

249 ià(
nä
->
fš
 &&‚ä->
d©aút
 == 0) {

250 
äc
->
ä
.
fš
 = 1;

251 
	`ngtı2_pq_pİ
(&
¡rm
->
¡»amäq
);

252 
	`ngtı2_¡»am_äame_chaš_d–
(
näc
, 
¡rm
->
mem
);

256 
nm”ged
 = 
	`ngtı2_vec_m”ge
(
ä
->
d©a
, &ä->
d©aút
, 
nä
->data, &nfr->datacnt,

257 
Ëá
, 
NGTCP2_MAX_STREAM_DATACNT
);

258 ià(
nm”ged
 == 0) {

262 
	`ngtı2_pq_pİ
(&
¡rm
->
¡»amäq
);

264 
d©®’
 +ğ
nm”ged
;

265 
nä
->
off£t
 +ğ
nm”ged
;

266 
Ëá
 -ğ
nm”ged
;

268 ià(
nä
->
d©aút
 == 0) {

269 
äc
->
ä
.
fš
 = 
näc
->fr.fin;

270 
	`ngtı2_¡»am_äame_chaš_d–
(
näc
, 
¡rm
->
mem
);

274 
rv
 = 
	`ngtı2_pq_push
(&
¡rm
->
¡»amäq
, &
näc
->
³
);

275 ià(
rv
 != 0) {

276 
	`ngtı2_¡»am_äame_chaš_d–
(
näc
, 
¡rm
->
mem
);

277 
	`ngtı2_¡»am_äame_chaš_d–
(
äc
, 
¡rm
->
mem
);

278  
rv
;

284 *
päc
 = 
äc
;

286 
	}
}

288 
ngtı2_¡»am_äame_chaš
 *
	$ngtı2_¡rm_¡»amäq_tİ
(
ngtı2_¡rm
 *
¡rm
) {

289 
	`as£¹
(!
	`ngtı2_pq_em±y
(&
¡rm
->
¡»amäq
));

290  
	`ngtı2_¡ruù_of
(
	`ngtı2_pq_tİ
(&
¡rm
->
¡»amäq
),

291 
ngtı2_¡»am_äame_chaš
, 
³
);

292 
	}
}

294 
	$ngtı2_¡rm_¡»amäq_em±y
(
ngtı2_¡rm
 *
¡rm
) {

295  
	`ngtı2_pq_em±y
(&
¡rm
->
¡»amäq
);

296 
	}
}

298 
	$ngtı2_¡rm_¡»amäq_ş—r
(
ngtı2_¡rm
 *
¡rm
) {

299 
ngtı2_¡»am_äame_chaš
 *
äc
;

300 ; !
	`ngtı2_pq_em±y
(&
¡rm
->
¡»amäq
);) {

301 
äc
 = 
	`ngtı2_¡ruù_of
(
	`ngtı2_pq_tİ
(&
¡rm
->
¡»amäq
),

302 
ngtı2_¡»am_äame_chaš
, 
³
);

303 
	`ngtı2_pq_pİ
(&
¡rm
->
¡»amäq
);

304 
	`ngtı2_¡»am_äame_chaš_d–
(
äc
, 
¡rm
->
mem
);

306 
	}
}

308 
	$ngtı2_¡rm_is_tx_queued
(
ngtı2_¡rm
 *
¡rm
) {

309  
¡rm
->
³
.
šdex
 !ğ
NGTCP2_PQ_BAD_INDEX
;

310 
	}
}

	@lib/ngtcp2_strm.h

25 #iâdeà
NGTCP2_STRM_H


26 
	#NGTCP2_STRM_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

34 
	~"ngtı2_rob.h
"

35 
	~"ngtı2_buf.h
"

36 
	~"ngtı2_m­.h
"

37 
	~"ngtı2_g­Œ.h
"

38 
	~"ngtı2_k¦.h
"

39 
	~"ngtı2_pq.h
"

41 
	gngtı2_¡»am_äame_chaš
;

42 
ngtı2_¡»am_äame_chaš
 
	tngtı2_¡»am_äame_chaš
;

45 
	mNGTCP2_STRM_FLAG_NONE
 = 0,

48 
	mNGTCP2_STRM_FLAG_SHUT_RD
 = 0x01,

51 
	mNGTCP2_STRM_FLAG_SHUT_WR
 = 0x02,

52 
	mNGTCP2_STRM_FLAG_SHUT_RDWR
 =

53 
NGTCP2_STRM_FLAG_SHUT_RD
 | 
NGTCP2_STRM_FLAG_SHUT_WR
,

57 
	mNGTCP2_STRM_FLAG_SENT_RST
 = 0x04,

61 
	mNGTCP2_STRM_FLAG_RECV_RST
 = 0x08,

64 
	mNGTCP2_STRM_FLAG_STOP_SENDING
 = 0x10,

67 
	mNGTCP2_STRM_FLAG_RST_ACKED
 = 0x20,

68 } 
	tngtı2_¡rm_æags
;

70 
	gngtı2_¡rm
;

71 
ngtı2_¡rm
 
	tngtı2_¡rm
;

73 
	sngtı2_¡rm
 {

74 
ngtı2_m­_’Œy
 
	mme
;

75 
ngtı2_pq_’Œy
 
	m³
;

76 
ušt64_t
 
	mcyşe
;

77 
ušt64_t
 
	mtx_off£t
;

78 
ngtı2_g­Œ
 
	macked_tx_off£t
;

81 
ušt64_t
 
	mmax_tx_off£t
;

84 
ušt64_t
 
	mÏ¡_rx_off£t
;

85 
ngtı2_rob
 
	mrob
;

90 
ngtı2_pq
 
	m¡»amäq
;

93 
ušt64_t
 
	mmax_rx_off£t
;

97 
ušt64_t
 
	mun£Á_max_rx_off£t
;

98 
ngtı2_mem
 *
	mmem
;

99 
size_t
 
	mnbufã»d
;

100 
ngtı2_buf
 
	mtx_buf
;

101 
ušt64_t
 
	m¡»am_id
;

102 *
	m¡»am_u£r_d©a
;

104 
ušt32_t
 
	mæags
;

107 
ušt16_t
 
	m­p_”rÜ_code
;

119 
ngtı2_¡rm_š™
(
ngtı2_¡rm
 *
¡rm
, 
ušt64_t
 
¡»am_id
, 
ušt32_t
 
æags
,

120 
ušt64_t
 
max_rx_off£t
, ušt64_ˆ
max_tx_off£t
,

121 *
¡»am_u£r_d©a
, 
ngtı2_mem
 *
mem
);

127 
ngtı2_¡rm_ä“
(
ngtı2_¡rm
 *
¡rm
);

133 
ušt64_t
 
ngtı2_¡rm_rx_off£t
(
ngtı2_¡rm
 *
¡rm
);

144 
ngtı2_¡rm_»cv_»Üd”šg
(
ngtı2_¡rm
 *
¡rm
, cÚ¡ 
ušt8_t
 *
d©a
,

145 
size_t
 
d©®’
, 
ušt64_t
 
off£t
);

151 
ngtı2_¡rm_shutdown
(
ngtı2_¡rm
 *
¡rm
, 
ušt32_t
 
æags
);

163 
ngtı2_¡rm_¡»amäq_push
(
ngtı2_¡rm
 *
¡rm
,

164 
ngtı2_¡»am_äame_chaš
 *
äc
);

179 
ngtı2_¡rm_¡»amäq_pİ
(
ngtı2_¡rm
 *
¡rm
,

180 
ngtı2_¡»am_äame_chaš
 **
päc
, 
size_t
 
Ëá
);

186 
ngtı2_¡»am_äame_chaš
 *
ngtı2_¡rm_¡»amäq_tİ
(
ngtı2_¡rm
 *
¡rm
);

191 
ngtı2_¡rm_¡»amäq_em±y
(
ngtı2_¡rm
 *
¡rm
);

196 
ngtı2_¡rm_¡»amäq_ş—r
(
ngtı2_¡rm
 *
¡rm
);

201 
ngtı2_¡rm_is_tx_queued
(
ngtı2_¡rm
 *
¡rm
);

	@lib/ngtcp2_vec.c

25 
	~"ngtı2_vec.h
"

27 
	~<¡ršg.h
>

28 
	~<as£¹.h
>

30 
	~"ngtı2_¡r.h
"

32 
	$ngtı2_vec_Ãw
(
ngtı2_vec
 **
pvec
, cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
,

33 
ngtı2_mem
 *
mem
) {

34 
size_t
 
Ën
;

35 
ušt8_t
 *
p
;

37 
Ën
 = (
ngtı2_vec
è+ 
d©®’
;

39 *
pvec
 = 
	`ngtı2_mem_m®loc
(
mem
, 
Ën
);

40 ià(*
pvec
 =ğ
NULL
) {

41  
NGTCP2_ERR_NOMEM
;

44 
p
 = (
ušt8_t
 *)(*
pvec
è+ (
ngtı2_vec
);

45 (*
pvec
)->
ba£
 = 
p
;

46 (*
pvec
)->
Ën
 = 
d©®’
;

47  
	`ngtı2_ıymem
(
p
, 
d©a
, 
d©®’
);

50 
	}
}

52 
	$ngtı2_vec_d–
(
ngtı2_vec
 *
vec
, 
ngtı2_mem
 *
mem
) {

53 
	`ngtı2_mem_ä“
(
mem
, 
vec
);

54 
	}
}

56 
size_t
 
	$ngtı2_vec_Ën
(cÚ¡ 
ngtı2_vec
 *
vec
, 
size_t
 
n
) {

57 
size_t
 
i
;

58 
size_t
 
»s
 = 0;

60 
i
 = 0; i < 
n
; ++i) {

61 
»s
 +ğ
vec
[
i
].
Ën
;

64  
»s
;

65 
	}
}

67 
ssize_t
 
	$ngtı2_vec_¥l™
(
ngtı2_vec
 *
¤c
, 
size_t
 *
p¤cút
,‚gtı2_veø*
d¡
,

68 
size_t
 *
pd¡út
, size_ˆ
Ëá
, size_ˆ
maxút
) {

69 
size_t
 
i
;

70 
size_t
 
¤cút
 = *
p¤cút
;

71 
size_t
 
nmove
;

72 
size_t
 
exŒa
 = 0;

74 
i
 = 0; i < 
¤cút
; ++i) {

75 ià(
Ëá
 >ğ
¤c
[
i
].
Ën
) {

76 
Ëá
 -ğ
¤c
[
i
].
Ën
;

80 ià(*
pd¡út
 && 
¤c
[
¤cút
 - 1].
ba£
 + src[¤cúˆ- 1].
Ën
 =ğ
d¡
[0].base) {

81 ià(*
pd¡út
 + 
¤cút
 - 
i
 - 1 > 
maxút
) {

85 
d¡
[0].
Ën
 +ğ
¤c
[
¤cút
 - 1].len;

86 
d¡
[0].
ba£
 = 
¤c
[
¤cút
 - 1].base;

87 
exŒa
 = 
¤c
[
¤cút
 - 1].
Ën
;

88 --
¤cút
;

89 } ià(*
pd¡út
 + 
¤cút
 - 
i
 > 
maxút
) {

93 ià(
Ëá
 == 0) {

94 *
p¤cút
 = 
i
;

96 *
p¤cút
 = 
i
 + 1;

99 
nmove
 = 
¤cút
 - 
i
;

100 
	`memmove
(
d¡
 + 
nmove
, d¡, (
ngtı2_vec
è* (*
pd¡út
));

101 *
pd¡út
 +ğ
nmove
;

102 
	`memıy
(
d¡
, 
¤c
 + 
i
, (
ngtı2_vec
è* 
nmove
);

104 
d¡
[0].
Ën
 -ğ
Ëá
;

105 
d¡
[0].
ba£
 +ğ
Ëá
;

106 
¤c
[
i
].
Ën
 = 
Ëá
;

108 ià(
nmove
 == 0) {

109 
exŒa
 -ğ
Ëá
;

112  (
ssize_t
)(
	`ngtı2_vec_Ën
(
d¡
, 
nmove
è+ 
exŒa
);

116 
	}
}

118 
size_t
 
	$ngtı2_vec_m”ge
(
ngtı2_vec
 *
d¡
, 
size_t
 *
pd¡út
,‚gtı2_veø*
¤c
,

119 
size_t
 *
p¤cút
, size_ˆ
Ëá
, size_ˆ
maxút
) {

120 
size_t
 
Üig_Ëá
 = 
Ëá
;

121 
size_t
 
i
;

122 
ngtı2_vec
 *
a
, *
b
;

124 
	`as£¹
(
maxút
);

126 ià(*
pd¡út
 == 0) {

127 ià(*
p¤cút
 == 0) {

131 
a
 = &
d¡
[0];

132 
b
 = &
¤c
[0];

134 ià(
Ëá
 >ğ
b
->
Ën
) {

135 *
a
 = *
b
;

136 ++*
pd¡út
;

137 
Ëá
 -ğ
b
->
Ën
;

138 
i
 = 1;

140 
a
->
Ën
 = 
Ëá
;

141 
a
->
ba£
 = 
b
->base;

143 
b
->
Ën
 -ğ
Ëá
;

144 
b
->
ba£
 +ğ
Ëá
;

146  
Ëá
;

149 
i
 = 0;

152 ; 
Ëá
 && *
pd¡út
 < 
maxút
 && 
i
 < *
p¤cút
; ++i) {

153 
a
 = &
d¡
[*
pd¡út
 - 1];

154 
b
 = &
¤c
[
i
];

156 ià(
Ëá
 >ğ
b
->
Ën
) {

157 ià(
a
->
ba£
 +‡->
Ën
 =ğ
b
->base) {

158 
a
->
Ën
 +ğ
b
->len;

160 
d¡
[(*
pd¡út
)++] = *
b
;

162 
Ëá
 -ğ
b
->
Ën
;

166 ià(
a
->
ba£
 +‡->
Ën
 =ğ
b
->base) {

167 
a
->
Ën
 +ğ
Ëá
;

169 
d¡
[*
pd¡út
].
Ën
 = 
Ëá
;

170 
d¡
[*
pd¡út
].
ba£
 = 
b
->base;

171 ++*
pd¡út
;

174 
b
->
Ën
 -ğ
Ëá
;

175 
b
->
ba£
 +ğ
Ëá
;

176 
Ëá
 = 0;

181 
	`memmove
(
¤c
, srø+ 
i
, (
ngtı2_vec
è* (*
p¤cút
 - i));

182 *
p¤cút
 -ğ
i
;

184  
Üig_Ëá
 - 
Ëá
;

185 
	}
}

187 
size_t
 
	$ngtı2_vec_cİy
(
ngtı2_vec
 *
d¡
, 
size_t
 
d¡út
, cÚ¡‚gtı2_veø*
¤c
,

188 
size_t
 
¤cút
, size_ˆ
Ëá
) {

189 
size_t
 
i
, 
j
;

191 
i
 = 0, 
j
 = 0; 
Ëá
 > 0 && i < 
¤cút
 && j < 
d¡út
;) {

192 ià(
¤c
[
i
].
Ën
 == 0) {

193 ++
i
;

196 
d¡
[
j
] = 
¤c
[
i
];

197 ià(
d¡
[
j
].
Ën
 > 
Ëá
) {

198 
d¡
[
j
].
Ën
 = 
Ëá
;

199  
j
 + 1;

201 
Ëá
 -ğ
d¡
[
j
].
Ën
;

202 ++
i
;

203 ++
j
;

206  
j
;

207 
	}
}

	@lib/ngtcp2_vec.h

25 #iâdeà
NGTCP2_VEC_H


26 
	#NGTCP2_VEC_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

34 
	~"ngtı2_mem.h
"

43 
ngtı2_vec_Ãw
(
ngtı2_vec
 **
pvec
, cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
,

44 
ngtı2_mem
 *
mem
);

50 
ngtı2_vec_d–
(
ngtı2_vec
 *
vec
, 
ngtı2_mem
 *
mem
);

55 
size_t
 
ngtı2_vec_Ën
(cÚ¡ 
ngtı2_vec
 *
vec
, size_ˆ
n
);

69 
ssize_t
 
ngtı2_vec_¥l™
(
ngtı2_vec
 *
¤c
, 
size_t
 *
p¤cút
,‚gtı2_veø*
d¡
,

70 
size_t
 *
pd¡út
, size_ˆ
Ëá
, size_ˆ
maxút
);

81 
size_t
 
ngtı2_vec_m”ge
(
ngtı2_vec
 *
d¡
, size_ˆ*
pd¡út
,‚gtı2_veø*
¤c
,

82 
size_t
 *
p¤cút
, size_ˆ
Ëá
, size_ˆ
maxút
);

90 
size_t
 
ngtı2_vec_cİy
(
ngtı2_vec
 *
d¡
, size_ˆ
d¡út
, cÚ¡‚gtı2_veø*
¤c
,

91 
size_t
 
¤cút
, size_ˆ
Ëá
);

	@tests/main.c

26 #ifdeà
HAVE_CONFIG_H


27 
	~<cÚfig.h
>

30 
	~<¡dio.h
>

31 
	~<¡ršg.h
>

32 
	~<CUn™/Basic.h
>

34 
	~"ngtı2_pkt_‹¡.h
"

35 
	~"ngtı2_¿nge_‹¡.h
"

36 
	~"ngtı2_rob_‹¡.h
"

37 
	~"ngtı2_¹b_‹¡.h
"

38 
	~"ngtı2_ackŒ_‹¡.h
"

39 
	~"ngtı2_üy±o_‹¡.h
"

40 
	~"ngtı2_idŒ_‹¡.h
"

41 
	~"ngtı2_cÚn_‹¡.h
"

42 
	~"ngtı2_ršgbuf_‹¡.h
"

43 
	~"ngtı2_cÚv_‹¡.h
"

44 
	~"ngtı2_p¦_‹¡.h
"

45 
	~"ngtı2_k¦_‹¡.h
"

46 
	~"ngtı2_m­_‹¡.h
"

47 
	~"ngtı2_g­Œ_‹¡.h
"

48 
	~"ngtı2_vec_‹¡.h
"

49 
	~"ngtı2_¡rm_‹¡.h
"

50 
	~"ngtı2_pv_‹¡.h
"

52 
	$š™_su™e1
(è{  0; 
	}
}

54 
	$ş—n_su™e1
(è{  0; 
	}
}

56 
	$maš
() {

57 
CU_pSu™e
 
pSu™e
 = 
NULL
;

58 
num_‹¡s_çed
;

61 ià(
CUE_SUCCESS
 !ğ
	`CU_š™Ÿlize_»gi¡ry
())

62  ()
	`CU_g‘_”rÜ
();

65 
pSu™e
 = 
	`CU_add_su™e
("libngtı2_Te¡Su™e", 
š™_su™e1
, 
ş—n_su™e1
);

66 ià(
NULL
 =ğ
pSu™e
) {

67 
	`CU_ş—nup_»gi¡ry
();

68  ()
	`CU_g‘_”rÜ
();

72 ià(!
	`CU_add_‹¡
(
pSu™e
, "pkt_decode_hd_long",

73 
‹¡_ngtı2_pkt_decode_hd_lÚg
) ||

74 !
	`CU_add_‹¡
(
pSu™e
, "pkt_decode_hd_short",

75 
‹¡_ngtı2_pkt_decode_hd_shÜt
) ||

76 !
	`CU_add_‹¡
(
pSu™e
, "pkt_decode_stream_frame",

77 
‹¡_ngtı2_pkt_decode_¡»am_äame
) ||

78 !
	`CU_add_‹¡
(
pSu™e
, "pkt_decode_ack_frame",

79 
‹¡_ngtı2_pkt_decode_ack_äame
) ||

80 !
	`CU_add_‹¡
(
pSu™e
, "pkt_decode_padding_frame",

81 
‹¡_ngtı2_pkt_decode_·ddšg_äame
) ||

82 !
	`CU_add_‹¡
(
pSu™e
, "pkt_encode_stream_frame",

83 
‹¡_ngtı2_pkt_’code_¡»am_äame
) ||

84 !
	`CU_add_‹¡
(
pSu™e
, "pkt_encode_ack_frame",

85 
‹¡_ngtı2_pkt_’code_ack_äame
) ||

86 !
	`CU_add_‹¡
(
pSu™e
, "pkt_encode_reset_stream_frame",

87 
‹¡_ngtı2_pkt_’code_»£t_¡»am_äame
) ||

88 !
	`CU_add_‹¡
(
pSu™e
, "pkt_encode_connection_close_frame",

89 
‹¡_ngtı2_pkt_’code_cÚÃùiÚ_şo£_äame
) ||

90 !
	`CU_add_‹¡
(
pSu™e
, "pkt_encode_connection_close_app_frame",

91 
‹¡_ngtı2_pkt_’code_cÚÃùiÚ_şo£_­p_äame
) ||

92 !
	`CU_add_‹¡
(
pSu™e
, "pkt_encode_max_data_frame",

93 
‹¡_ngtı2_pkt_’code_max_d©a_äame
) ||

94 !
	`CU_add_‹¡
(
pSu™e
, "pkt_encode_max_stream_data_frame",

95 
‹¡_ngtı2_pkt_’code_max_¡»am_d©a_äame
) ||

96 !
	`CU_add_‹¡
(
pSu™e
, "pkt_encode_max_streams_frame",

97 
‹¡_ngtı2_pkt_’code_max_¡»ams_äame
) ||

98 !
	`CU_add_‹¡
(
pSu™e
, "pkt_encode_ping_frame",

99 
‹¡_ngtı2_pkt_’code_pšg_äame
) ||

100 !
	`CU_add_‹¡
(
pSu™e
, "pkt_encode_data_blocked_frame",

101 
‹¡_ngtı2_pkt_’code_d©a_blocked_äame
) ||

102 !
	`CU_add_‹¡
(
pSu™e
, "pkt_encode_stream_data_blocked_frame",

103 
‹¡_ngtı2_pkt_’code_¡»am_d©a_blocked_äame
) ||

104 !
	`CU_add_‹¡
(
pSu™e
, "pkt_encode_streams_blocked_frame",

105 
‹¡_ngtı2_pkt_’code_¡»ams_blocked_äame
) ||

106 !
	`CU_add_‹¡
(
pSu™e
, "pkt_encode_new_connection_id_frame",

107 
‹¡_ngtı2_pkt_’code_Ãw_cÚÃùiÚ_id_äame
) ||

108 !
	`CU_add_‹¡
(
pSu™e
, "pkt_encode_stop_sending_frame",

109 
‹¡_ngtı2_pkt_’code_¡İ_£ndšg_äame
) ||

110 !
	`CU_add_‹¡
(
pSu™e
, "pkt_encode_path_challenge_frame",

111 
‹¡_ngtı2_pkt_’code_·th_ch®Ënge_äame
) ||

112 !
	`CU_add_‹¡
(
pSu™e
, "pkt_encode_path_response_frame",

113 
‹¡_ngtı2_pkt_’code_·th_»¥Ú£_äame
) ||

114 !
	`CU_add_‹¡
(
pSu™e
, "pkt_encode_crypto_frame",

115 
‹¡_ngtı2_pkt_’code_üy±o_äame
) ||

116 !
	`CU_add_‹¡
(
pSu™e
, "pkt_encode_new_token_frame",

117 
‹¡_ngtı2_pkt_’code_Ãw_tok’_äame
) ||

118 !
	`CU_add_‹¡
(
pSu™e
, "pkt_encode_retire_connection_id",

119 
‹¡_ngtı2_pkt_’code_»tœe_cÚÃùiÚ_id
) ||

120 !
	`CU_add_‹¡
(
pSu™e
, "pkt_adjust_pkt_num",

121 
‹¡_ngtı2_pkt_adju¡_pkt_num
) ||

122 !
	`CU_add_‹¡
(
pSu™e
, "pkt_v®id©e_ack", 
‹¡_ngtı2_pkt_v®id©e_ack
) ||

123 !
	`CU_add_‹¡
(
pSu™e
, "pkt_write_stateless_reset",

124 
‹¡_ngtı2_pkt_wr™e_¡©–ess_»£t
) ||

125 !
	`CU_add_‹¡
(
pSu™e
, "pkt_wr™e_»Œy", 
‹¡_ngtı2_pkt_wr™e_»Œy
) ||

126 !
	`CU_add_‹¡
(
pSu™e
, "pkt_write_version_negotiation",

127 
‹¡_ngtı2_pkt_wr™e_v”siÚ_ÃgÙŸtiÚ
) ||

128 !
	`CU_add_‹¡
(
pSu™e
, "pkt_stream_max_datalen",

129 
‹¡_ngtı2_pkt_¡»am_max_d©®’
) ||

130 !
	`CU_add_‹¡
(
pSu™e
, "g‘_v¬št", 
‹¡_ngtı2_g‘_v¬št
) ||

131 !
	`CU_add_‹¡
(
pSu™e
, "g‘_v¬št_Ën", 
‹¡_ngtı2_g‘_v¬št_Ën
) ||

132 !
	`CU_add_‹¡
(
pSu™e
, "put_v¬št_Ën", 
‹¡_ngtı2_put_v¬št_Ën
) ||

133 !
	`CU_add_‹¡
(
pSu™e
, "nth_server_bidi_id",

134 
‹¡_ngtı2_Áh_£rv”_bidi_id
) ||

135 !
	`CU_add_‹¡
(
pSu™e
, "nth_server_uni_id",

136 
‹¡_ngtı2_Áh_£rv”_uni_id
) ||

137 !
	`CU_add_‹¡
(
pSu™e
, "nth_client_bidi_id",

138 
‹¡_ngtı2_Áh_ş›Á_bidi_id
) ||

139 !
	`CU_add_‹¡
(
pSu™e
, "nth_client_uni_id",

140 
‹¡_ngtı2_Áh_ş›Á_uni_id
) ||

141 !
	`CU_add_‹¡
(
pSu™e
, "¿nge_š‹r£ù", 
‹¡_ngtı2_¿nge_š‹r£ù
) ||

142 !
	`CU_add_‹¡
(
pSu™e
, "¿nge_cut", 
‹¡_ngtı2_¿nge_cut
) ||

143 !
	`CU_add_‹¡
(
pSu™e
, "¿nge_nÙ_aá”", 
‹¡_ngtı2_¿nge_nÙ_aá”
) ||

144 !
	`CU_add_‹¡
(
pSu™e
, "p¦_š£¹", 
‹¡_ngtı2_p¦_š£¹
) ||

145 !
	`CU_add_‹¡
(
pSu™e
, "k¦_š£¹", 
‹¡_ngtı2_k¦_š£¹
) ||

146 !
	`CU_add_‹¡
(
pSu™e
, "k¦_ş—r", 
‹¡_ngtı2_k¦_ş—r
) ||

147 !
	`CU_add_‹¡
(
pSu™e
, "rob_push", 
‹¡_ngtı2_rob_push
) ||

148 !
	`CU_add_‹¡
(
pSu™e
, "rob_push_¿ndom", 
‹¡_ngtı2_rob_push_¿ndom
) ||

149 !
	`CU_add_‹¡
(
pSu™e
, "rob_d©a_©", 
‹¡_ngtı2_rob_d©a_©
) ||

150 !
	`CU_add_‹¡
(
pSu™e
, "rob_remove_prefix",

151 
‹¡_ngtı2_rob_»move_´efix
) ||

152 !
	`CU_add_‹¡
(
pSu™e
, "ackŒ_add", 
‹¡_ngtı2_ackŒ_add
) ||

153 !
	`CU_add_‹¡
(
pSu™e
, "ackŒ_eviùiÚ", 
‹¡_ngtı2_ackŒ_eviùiÚ
) ||

154 !
	`CU_add_‹¡
(
pSu™e
, "ackŒ_fÜg‘", 
‹¡_ngtı2_ackŒ_fÜg‘
) ||

155 !
	`CU_add_‹¡
(
pSu™e
, "ackŒ_»cv_ack", 
‹¡_ngtı2_ackŒ_»cv_ack
) ||

156 !
	`CU_add_‹¡
(
pSu™e
, "encode_transport_params",

157 
‹¡_ngtı2_’code_Œª¥Üt_·¿ms
) ||

158 !
	`CU_add_‹¡
(
pSu™e
, "¹b_add", 
‹¡_ngtı2_¹b_add
) ||

159 !
	`CU_add_‹¡
(
pSu™e
, "¹b_»cv_ack", 
‹¡_ngtı2_¹b_»cv_ack
) ||

160 !
	`CU_add_‹¡
(
pSu™e
, "¹b_ş—r", 
‹¡_ngtı2_¹b_ş—r
) ||

161 !
	`CU_add_‹¡
(
pSu™e
, "idŒ_İ’", 
‹¡_ngtı2_idŒ_İ’
) ||

162 !
	`CU_add_‹¡
(
pSu™e
, "ringbuf_push_front",

163 
‹¡_ngtı2_ršgbuf_push_äÚt
) ||

164 !
	`CU_add_‹¡
(
pSu™e
, "ringbuf_pop_front",

165 
‹¡_ngtı2_ršgbuf_pİ_äÚt
) ||

166 !
	`CU_add_‹¡
(
pSu™e
, "conn_stream_open_close",

167 
‹¡_ngtı2_cÚn_¡»am_İ’_şo£
) ||

168 !
	`CU_add_‹¡
(
pSu™e
, "conn_stream_rx_flow_control",

169 
‹¡_ngtı2_cÚn_¡»am_rx_æow_cÚŒŞ
) ||

170 !
	`CU_add_‹¡
(
pSu™e
, "conn_stream_rx_flow_control_error",

171 
‹¡_ngtı2_cÚn_¡»am_rx_æow_cÚŒŞ_”rÜ
) ||

172 !
	`CU_add_‹¡
(
pSu™e
, "conn_stream_tx_flow_control",

173 
‹¡_ngtı2_cÚn_¡»am_tx_æow_cÚŒŞ
) ||

174 !
	`CU_add_‹¡
(
pSu™e
, "conn_rx_flow_control",

175 
‹¡_ngtı2_cÚn_rx_æow_cÚŒŞ
) ||

176 !
	`CU_add_‹¡
(
pSu™e
, "conn_rx_flow_control_error",

177 
‹¡_ngtı2_cÚn_rx_æow_cÚŒŞ_”rÜ
) ||

178 !
	`CU_add_‹¡
(
pSu™e
, "conn_tx_flow_control",

179 
‹¡_ngtı2_cÚn_tx_æow_cÚŒŞ
) ||

180 !
	`CU_add_‹¡
(
pSu™e
, "conn_shutdown_stream_write",

181 
‹¡_ngtı2_cÚn_shutdown_¡»am_wr™e
) ||

182 !
	`CU_add_‹¡
(
pSu™e
, "conn_recv_reset_stream",

183 
‹¡_ngtı2_cÚn_»cv_»£t_¡»am
) ||

184 !
	`CU_add_‹¡
(
pSu™e
, "conn_recv_stop_sending",

185 
‹¡_ngtı2_cÚn_»cv_¡İ_£ndšg
) ||

186 !
	`CU_add_‹¡
(
pSu™e
, "conn_recv_conn_id_omitted",

187 
‹¡_ngtı2_cÚn_»cv_cÚn_id_om™‹d
) ||

188 !
	`CU_add_‹¡
(
pSu™e
, "conn_short_pkt_type",

189 
‹¡_ngtı2_cÚn_shÜt_pkt_ty³
) ||

190 !
	`CU_add_‹¡
(
pSu™e
, "conn_recv_stateless_reset",

191 
‹¡_ngtı2_cÚn_»cv_¡©–ess_»£t
) ||

192 !
	`CU_add_‹¡
(
pSu™e
, "cÚn_»cv_»Œy", 
‹¡_ngtı2_cÚn_»cv_»Œy
) ||

193 !
	`CU_add_‹¡
(
pSu™e
, "conn_recv_delayed_handshake_pkt",

194 
‹¡_ngtı2_cÚn_»cv_d–ayed_hªdshake_pkt
) ||

195 !
	`CU_add_‹¡
(
pSu™e
, "conn_recv_max_streams",

196 
‹¡_ngtı2_cÚn_»cv_max_¡»ams
) ||

197 !
	`CU_add_‹¡
(
pSu™e
, "cÚn_hªdshake", 
‹¡_ngtı2_cÚn_hªdshake
) ||

198 !
	`CU_add_‹¡
(
pSu™e
, "conn_handshake_error",

199 
‹¡_ngtı2_cÚn_hªdshake_”rÜ
) ||

200 !
	`CU_add_‹¡
(
pSu™e
, "conn_client_write_handshake",

201 
‹¡_ngtı2_cÚn_ş›Á_wr™e_hªdshake
) ||

202 !
	`CU_add_‹¡
(
pSu™e
, "conn_retransmit_protected",

203 
‹¡_ngtı2_cÚn_»Œªsm™_´Ùeùed
) ||

204 !
	`CU_add_‹¡
(
pSu™e
, "conn_send_max_stream_data",

205 
‹¡_ngtı2_cÚn_£nd_max_¡»am_d©a
) ||

206 !
	`CU_add_‹¡
(
pSu™e
, "conn_recv_stream_data",

207 
‹¡_ngtı2_cÚn_»cv_¡»am_d©a
) ||

208 !
	`CU_add_‹¡
(
pSu™e
, "cÚn_»cv_pšg", 
‹¡_ngtı2_cÚn_»cv_pšg
) ||

209 !
	`CU_add_‹¡
(
pSu™e
, "conn_recv_max_stream_data",

210 
‹¡_ngtı2_cÚn_»cv_max_¡»am_d©a
) ||

211 !
	`CU_add_‹¡
(
pSu™e
, "conn_send_early_data",

212 
‹¡_ngtı2_cÚn_£nd_—¾y_d©a
) ||

213 !
	`CU_add_‹¡
(
pSu™e
, "conn_recv_early_data",

214 
‹¡_ngtı2_cÚn_»cv_—¾y_d©a
) ||

215 !
	`CU_add_‹¡
(
pSu™e
, "conn_recv_compound_pkt",

216 
‹¡_ngtı2_cÚn_»cv_compound_pkt
) ||

217 !
	`CU_add_‹¡
(
pSu™e
, "conn_pkt_payloadlen",

218 
‹¡_ngtı2_cÚn_pkt_·ylßdËn
) ||

219 !
	`CU_add_‹¡
(
pSu™e
, "conn_writev_stream",

220 
‹¡_ngtı2_cÚn_wr™ev_¡»am
) ||

221 !
	`CU_add_‹¡
(
pSu™e
, "conn_recv_new_connection_id",

222 
‹¡_ngtı2_cÚn_»cv_Ãw_cÚÃùiÚ_id
) ||

223 !
	`CU_add_‹¡
(
pSu™e
, "conn_recv_retire_connection_id",

224 
‹¡_ngtı2_cÚn_»cv_»tœe_cÚÃùiÚ_id
) ||

225 !
	`CU_add_‹¡
(
pSu™e
, "conn_server_path_validation",

226 
‹¡_ngtı2_cÚn_£rv”_·th_v®id©iÚ
) ||

227 !
	`CU_add_‹¡
(
pSu™e
, "conn_client_connection_migration",

228 
‹¡_ngtı2_cÚn_ş›Á_wr™e_hªdshake
) ||

229 !
	`CU_add_‹¡
(
pSu™e
, "conn_recv_path_challenge",

230 
‹¡_ngtı2_cÚn_»cv_·th_ch®Ënge
) ||

231 !
	`CU_add_‹¡
(
pSu™e
, "m­", 
‹¡_ngtı2_m­
) ||

232 !
	`CU_add_‹¡
(
pSu™e
, "m­_funùiÚ®", 
‹¡_ngtı2_m­_funùiÚ®
) ||

233 !
	`CU_add_‹¡
(
pSu™e
, "m­_—ch_ä“", 
‹¡_ngtı2_m­_—ch_ä“
) ||

234 !
	`CU_add_‹¡
(
pSu™e
, "m­_ş—r", 
‹¡_ngtı2_m­_ş—r
) ||

235 !
	`CU_add_‹¡
(
pSu™e
, "g­Œ_push", 
‹¡_ngtı2_g­Œ_push
) ||

236 !
	`CU_add_‹¡
(
pSu™e
, "g­Œ_is_pushed", 
‹¡_ngtı2_g­Œ_is_pushed
) ||

237 !
	`CU_add_‹¡
(
pSu™e
, "vec_¥l™", 
‹¡_ngtı2_vec_¥l™
) ||

238 !
	`CU_add_‹¡
(
pSu™e
, "vec_m”ge", 
‹¡_ngtı2_vec_m”ge
) ||

239 !
	`CU_add_‹¡
(
pSu™e
, "strm_streamfrq_pop",

240 
‹¡_ngtı2_¡rm_¡»amäq_pİ
) ||

241 !
	`CU_add_‹¡
(
pSu™e
, "pv_add_’Œy", 
‹¡_ngtı2_pv_add_’Œy
) ||

242 !
	`CU_add_‹¡
(
pSu™e
, "pv_v®id©e", 
‹¡_ngtı2_pv_v®id©e
)) {

243 
	`CU_ş—nup_»gi¡ry
();

244  ()
	`CU_g‘_”rÜ
();

248 
	`CU_basic_£t_mode
(
CU_BRM_VERBOSE
);

249 
	`CU_basic_run_‹¡s
();

250 
num_‹¡s_çed
 = 
	`CU_g‘_numb”_of_‹¡s_çed
();

251 
	`CU_ş—nup_»gi¡ry
();

252 ià(
	`CU_g‘_”rÜ
(è=ğ
CUE_SUCCESS
) {

253  ()
num_‹¡s_çed
;

255 
	`´štf
("CUn™ E¼Ü: %s\n", 
	`CU_g‘_”rÜ_msg
());

256  ()
	`CU_g‘_”rÜ
();

258 
	}
}

	@tests/ngtcp2_acktr_test.c

25 
	~"ngtı2_ackŒ_‹¡.h
"

27 
	~<CUn™/CUn™.h
>

29 
	~"ngtı2_ackŒ.h
"

30 
	~"ngtı2_‹¡_h–³r.h
"

32 
	$‹¡_ngtı2_ackŒ_add
() {

33 cÚ¡ 
ušt64_t
 
pkt_nums
[] = {1, 5, 7, 6, 2, 3};

34 
ngtı2_ackŒ
 
ackŒ
;

35 
ngtı2_ackŒ_’Œy
 *
’t
;

36 
ngtı2_k¦_™
 
™
;

37 
size_t
 
i
;

38 
rv
;

39 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

40 
ngtı2_log
 
log
;

42 
	`ngtı2_log_š™
(&
log
, 
NULL
, NULL, 0, NULL);

43 
	`ngtı2_ackŒ_š™
(&
ackŒ
, &
log
, 
mem
);

45 
i
 = 0; i < 
	`¬¿yËn
(
pkt_nums
); ++i) {

46 
rv
 = 
	`ngtı2_ackŒ_add
(&
ackŒ
, 
pkt_nums
[
i
], 1, 999);

48 
	`CU_ASSERT
(0 =ğ
rv
);

51 
™
 = 
	`ngtı2_ackŒ_g‘
(&
ackŒ
);

52 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

54 
	`CU_ASSERT
(7 =ğ
’t
->
pkt_num
);

55 
	`CU_ASSERT
(3 =ğ
’t
->
Ën
);

57 
	`ngtı2_k¦_™_Ãxt
(&
™
);

58 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

60 
	`CU_ASSERT
(3 =ğ
’t
->
pkt_num
);

61 
	`CU_ASSERT
(3 =ğ
’t
->
Ën
);

63 
	`ngtı2_k¦_™_Ãxt
(&
™
);

65 
	`CU_ASSERT
(
	`ngtı2_k¦_™_’d
(&
™
));

67 
	`ngtı2_ackŒ_ä“
(&
ackŒ
);

73 
	`ngtı2_ackŒ_š™
(&
ackŒ
, &
log
, 
mem
);

75 
	`ngtı2_ackŒ_add
(&
ackŒ
, 1, 1, 100);

76 
	`ngtı2_ackŒ_add
(&
ackŒ
, 0, 1, 101);

78 
	`CU_ASSERT
(1 =ğ
	`ngtı2_k¦_Ën
(&
ackŒ
.
’ts
));

80 
™
 = 
	`ngtı2_ackŒ_g‘
(&
ackŒ
);

81 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

83 
	`CU_ASSERT
(1 =ğ
’t
->
pkt_num
);

84 
	`CU_ASSERT
(2 =ğ
’t
->
Ën
);

85 
	`CU_ASSERT
(100 =ğ
’t
->
t¡amp
);

87 
	`ngtı2_ackŒ_ä“
(&
ackŒ
);

91 
	`ngtı2_ackŒ_š™
(&
ackŒ
, &
log
, 
mem
);

93 
	`ngtı2_ackŒ_add
(&
ackŒ
, 0, 1, 100);

94 
	`ngtı2_ackŒ_add
(&
ackŒ
, 1, 1, 101);

96 
	`CU_ASSERT
(1 =ğ
	`ngtı2_k¦_Ën
(&
ackŒ
.
’ts
));

98 
™
 = 
	`ngtı2_ackŒ_g‘
(&
ackŒ
);

99 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

101 
	`CU_ASSERT
(1 =ğ
’t
->
pkt_num
);

102 
	`CU_ASSERT
(2 =ğ
’t
->
Ën
);

103 
	`CU_ASSERT
(101 =ğ
’t
->
t¡amp
);

105 
	`ngtı2_ackŒ_ä“
(&
ackŒ
);

108 
	`ngtı2_ackŒ_š™
(&
ackŒ
, &
log
, 
mem
);

110 
	`ngtı2_ackŒ_add
(&
ackŒ
, 0, 1, 100);

111 
	`ngtı2_ackŒ_add
(&
ackŒ
, 2, 1, 101);

112 
	`ngtı2_ackŒ_add
(&
ackŒ
, 3, 1, 102);

114 
	`CU_ASSERT
(2 =ğ
	`ngtı2_k¦_Ën
(&
ackŒ
.
’ts
));

116 
	`ngtı2_ackŒ_add
(&
ackŒ
, 1, 1, 103);

118 
	`CU_ASSERT
(1 =ğ
	`ngtı2_k¦_Ën
(&
ackŒ
.
’ts
));

120 
™
 = 
	`ngtı2_ackŒ_g‘
(&
ackŒ
);

121 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

123 
	`CU_ASSERT
(3 =ğ
’t
->
pkt_num
);

124 
	`CU_ASSERT
(4 =ğ
’t
->
Ën
);

125 
	`CU_ASSERT
(102 =ğ
’t
->
t¡amp
);

127 
	`ngtı2_ackŒ_ä“
(&
ackŒ
);

131 
	`ngtı2_ackŒ_š™
(&
ackŒ
, &
log
, 
mem
);

133 
	`ngtı2_ackŒ_add
(&
ackŒ
, 0, 1, 100);

134 
	`ngtı2_ackŒ_add
(&
ackŒ
, 3, 1, 101);

135 
	`ngtı2_ackŒ_add
(&
ackŒ
, 4, 1, 102);

137 
	`CU_ASSERT
(2 =ğ
	`ngtı2_k¦_Ën
(&
ackŒ
.
’ts
));

139 
	`ngtı2_ackŒ_add
(&
ackŒ
, 1, 1, 103);

141 
	`CU_ASSERT
(2 =ğ
	`ngtı2_k¦_Ën
(&
ackŒ
.
’ts
));

143 
™
 = 
	`ngtı2_ackŒ_g‘
(&
ackŒ
);

144 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

146 
	`CU_ASSERT
(4 =ğ
’t
->
pkt_num
);

147 
	`CU_ASSERT
(2 =ğ
’t
->
Ën
);

148 
	`CU_ASSERT
(102 =ğ
’t
->
t¡amp
);

150 
	`ngtı2_k¦_™_Ãxt
(&
™
);

151 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

153 
	`CU_ASSERT
(1 =ğ
’t
->
pkt_num
);

154 
	`CU_ASSERT
(2 =ğ
’t
->
Ën
);

155 
	`CU_ASSERT
(103 =ğ
’t
->
t¡amp
);

157 
	`ngtı2_ackŒ_ä“
(&
ackŒ
);

161 
	`ngtı2_ackŒ_š™
(&
ackŒ
, &
log
, 
mem
);

163 
	`ngtı2_ackŒ_add
(&
ackŒ
, 0, 1, 100);

164 
	`ngtı2_ackŒ_add
(&
ackŒ
, 3, 1, 101);

165 
	`ngtı2_ackŒ_add
(&
ackŒ
, 4, 1, 102);

167 
	`CU_ASSERT
(2 =ğ
	`ngtı2_k¦_Ën
(&
ackŒ
.
’ts
));

169 
	`ngtı2_ackŒ_add
(&
ackŒ
, 2, 1, 103);

171 
	`CU_ASSERT
(2 =ğ
	`ngtı2_k¦_Ën
(&
ackŒ
.
’ts
));

173 
™
 = 
	`ngtı2_ackŒ_g‘
(&
ackŒ
);

174 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

176 
	`CU_ASSERT
(4 =ğ
’t
->
pkt_num
);

177 
	`CU_ASSERT
(3 =ğ
’t
->
Ën
);

178 
	`CU_ASSERT
(102 =ğ
’t
->
t¡amp
);

180 
	`ngtı2_k¦_™_Ãxt
(&
™
);

181 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

183 
	`CU_ASSERT
(0 =ğ
’t
->
pkt_num
);

184 
	`CU_ASSERT
(1 =ğ
’t
->
Ën
);

185 
	`CU_ASSERT
(100 =ğ
’t
->
t¡amp
);

187 
	`ngtı2_ackŒ_ä“
(&
ackŒ
);

190 
	`ngtı2_ackŒ_š™
(&
ackŒ
, &
log
, 
mem
);

192 
	`ngtı2_ackŒ_add
(&
ackŒ
, 0, 1, 0);

193 
	`ngtı2_ackŒ_add
(&
ackŒ
, 4, 1, 0);

194 
	`ngtı2_ackŒ_add
(&
ackŒ
, 2, 1, 0);

196 
	`CU_ASSERT
(3 =ğ
	`ngtı2_k¦_Ën
(&
ackŒ
.
’ts
));

198 
	`ngtı2_ackŒ_ä“
(&
ackŒ
);

199 
	}
}

201 
	$‹¡_ngtı2_ackŒ_eviùiÚ
() {

202 
ngtı2_ackŒ
 
ackŒ
;

203 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

204 
size_t
 
i
;

205 
ngtı2_ackŒ_’Œy
 *
’t
;

206 cÚ¡ 
size_t
 
exŒa
 = 17;

207 
ngtı2_log
 
log
;

208 
ngtı2_k¦_™
 
™
;

210 
	`ngtı2_log_š™
(&
log
, 
NULL
, NULL, 0, NULL);

211 
	`ngtı2_ackŒ_š™
(&
ackŒ
, &
log
, 
mem
);

213 
i
 = 0; i < 
NGTCP2_ACKTR_MAX_ENT
 + 
exŒa
; ++i) {

214 
	`ngtı2_ackŒ_add
(&
ackŒ
, 
i
 * 2, 1, 999 + i);

217 
	`CU_ASSERT
(
NGTCP2_ACKTR_MAX_ENT
 =ğ
	`ngtı2_k¦_Ën
(&
ackŒ
.
’ts
));

219 
i
 = 0, 
™
 = 
	`ngtı2_ackŒ_g‘
(&
ackŒ
); !
	`ngtı2_k¦_™_’d
(&it);

220 ++
i
, 
	`ngtı2_k¦_™_Ãxt
(&
™
)) {

221 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

223 
	`CU_ASSERT
((
NGTCP2_ACKTR_MAX_ENT
 + 
exŒa
 - 1è* 2 - 
i
 * 2 =ğ
’t
->
pkt_num
);

226 
	`ngtı2_ackŒ_ä“
(&
ackŒ
);

229 
	`ngtı2_ackŒ_š™
(&
ackŒ
, &
log
, 
mem
);

231 
i
 = 
NGTCP2_ACKTR_MAX_ENT
 + 
exŒa
; i > 0; --i) {

232 
	`ngtı2_ackŒ_add
(&
ackŒ
, (
i
 - 1) * 2, 1, 999 + i);

235 
	`CU_ASSERT
(
NGTCP2_ACKTR_MAX_ENT
 =ğ
	`ngtı2_k¦_Ën
(&
ackŒ
.
’ts
));

237 
i
 = 0, 
™
 = 
	`ngtı2_ackŒ_g‘
(&
ackŒ
); !
	`ngtı2_k¦_™_’d
(&it);

238 ++
i
, 
	`ngtı2_k¦_™_Ãxt
(&
™
)) {

239 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

241 
	`CU_ASSERT
((
NGTCP2_ACKTR_MAX_ENT
 + 
exŒa
 - 1è* 2 - 
i
 * 2 =ğ
’t
->
pkt_num
);

244 
	`ngtı2_ackŒ_ä“
(&
ackŒ
);

245 
	}
}

247 
	$‹¡_ngtı2_ackŒ_fÜg‘
() {

248 
ngtı2_ackŒ
 
ackŒ
;

249 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

250 
size_t
 
i
;

251 
ngtı2_ackŒ_’Œy
 *
’t
;

252 
ngtı2_log
 
log
;

253 
ngtı2_k¦_™
 
™
;

255 
	`ngtı2_log_š™
(&
log
, 
NULL
, NULL, 0, NULL);

256 
	`ngtı2_ackŒ_š™
(&
ackŒ
, &
log
, 
mem
);

258 
i
 = 0; i < 7; ++i) {

259 
	`ngtı2_ackŒ_add
(&
ackŒ
, 
i
 * 2, 1, 999 + i);

262 
	`CU_ASSERT
(7 =ğ
	`ngtı2_k¦_Ën
(&
ackŒ
.
’ts
));

264 
™
 = 
	`ngtı2_ackŒ_g‘
(&
ackŒ
);

265 
	`ngtı2_k¦_™_Ãxt
(&
™
);

266 
	`ngtı2_k¦_™_Ãxt
(&
™
);

267 
	`ngtı2_k¦_™_Ãxt
(&
™
);

268 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

269 
	`ngtı2_ackŒ_fÜg‘
(&
ackŒ
, 
’t
);

271 
	`CU_ASSERT
(3 =ğ
	`ngtı2_k¦_Ën
(&
ackŒ
.
’ts
));

273 
™
 = 
	`ngtı2_ackŒ_g‘
(&
ackŒ
);

274 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

276 
	`CU_ASSERT
(12 =ğ
’t
->
pkt_num
);

278 
	`ngtı2_k¦_™_Ãxt
(&
™
);

279 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

281 
	`CU_ASSERT
(10 =ğ
’t
->
pkt_num
);

283 
	`ngtı2_k¦_™_Ãxt
(&
™
);

284 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

286 
	`CU_ASSERT
(8 =ğ
’t
->
pkt_num
);

288 
™
 = 
	`ngtı2_ackŒ_g‘
(&
ackŒ
);

289 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

291 
	`ngtı2_ackŒ_fÜg‘
(&
ackŒ
, 
’t
);

293 
	`CU_ASSERT
(0 =ğ
	`ngtı2_k¦_Ën
(&
ackŒ
.
’ts
));

295 
	`ngtı2_ackŒ_ä“
(&
ackŒ
);

296 
	}
}

298 
	$‹¡_ngtı2_ackŒ_»cv_ack
() {

299 
ngtı2_ackŒ
 
ackŒ
;

300 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

301 
size_t
 
i
;

302 
ngtı2_ack
 
ackä
;

303 
ušt64_t
 
½kt_nums
[] = {

314 
ngtı2_ackŒ_’Œy
 *
’t
;

315 
ngtı2_log
 
log
;

316 
ngtı2_k¦_™
 
™
;

318 
	`ngtı2_log_š™
(&
log
, 
NULL
, NULL, 0, NULL);

319 
	`ngtı2_ackŒ_š™
(&
ackŒ
, &
log
, 
mem
);

321 
i
 = 0; i < 
	`¬¿yËn
(
½kt_nums
); ++i) {

322 
	`ngtı2_ackŒ_add
(&
ackŒ
, 
½kt_nums
[
i
], 1, 999 + i);

325 
	`CU_ASSERT
(6 =ğ
	`ngtı2_k¦_Ën
(&
ackŒ
.
’ts
));

327 
	`ngtı2_ackŒ_add_ack
(&
ackŒ
, 998, 4497);

328 
	`ngtı2_ackŒ_add_ack
(&
ackŒ
, 999, 4499);

330 
ackä
.
ty³
 = 
NGTCP2_FRAME_ACK
;

331 
ackä
.
Ïrge¡_ack
 = 998;

332 
ackä
.
ack_d–ay
 = 0;

333 
ackä
.
fœ¡_ack_blkËn
 = 0;

334 
ackä
.
num_blks
 = 0;

336 
	`ngtı2_ackŒ_»cv_ack
(&
ackŒ
, &
ackä
);

338 
	`CU_ASSERT
(1 =ğ
	`ngtı2_ršgbuf_Ën
(&
ackŒ
.
acks
));

339 
	`CU_ASSERT
(1 =ğ
	`ngtı2_k¦_Ën
(&
ackŒ
.
’ts
));

341 
™
 = 
	`ngtı2_k¦_begš
(&
ackŒ
.
’ts
);

342 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

344 
	`CU_ASSERT
(4500 =ğ
’t
->
pkt_num
);

345 
	`CU_ASSERT
(2 =ğ
’t
->
Ën
);

347 
ackä
.
ty³
 = 
NGTCP2_FRAME_ACK
;

348 
ackä
.
Ïrge¡_ack
 = 999;

349 
ackä
.
ack_d–ay
 = 0;

350 
ackä
.
fœ¡_ack_blkËn
 = 0;

351 
ackä
.
num_blks
 = 0;

353 
	`ngtı2_ackŒ_»cv_ack
(&
ackŒ
, &
ackä
);

355 
	`CU_ASSERT
(0 =ğ
	`ngtı2_ršgbuf_Ën
(&
ackŒ
.
acks
));

356 
	`CU_ASSERT
(1 =ğ
	`ngtı2_k¦_Ën
(&
ackŒ
.
’ts
));

358 
™
 = 
	`ngtı2_k¦_begš
(&
ackŒ
.
’ts
);

359 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

361 
	`CU_ASSERT
(4500 =ğ
’t
->
pkt_num
);

362 
	`CU_ASSERT
(1 =ğ
’t
->
Ën
);

364 
	`ngtı2_ackŒ_ä“
(&
ackŒ
);

365 
	}
}

	@tests/ngtcp2_acktr_test.h

25 #iâdeà
NGTCP2_ACKTR_TEST_H


26 
	#NGTCP2_ACKTR_TEST_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
‹¡_ngtı2_ackŒ_add
();

33 
‹¡_ngtı2_ackŒ_eviùiÚ
();

34 
‹¡_ngtı2_ackŒ_fÜg‘
();

35 
‹¡_ngtı2_ackŒ_»cv_ack
();

	@tests/ngtcp2_conn_test.c

25 
	~"ngtı2_cÚn_‹¡.h
"

27 
	~<as£¹.h
>

29 
	~<CUn™/CUn™.h
>

31 
	~"ngtı2_cÚn.h
"

32 
	~"ngtı2_‹¡_h–³r.h
"

33 
	~"ngtı2_mem.h
"

34 
	~"ngtı2_pkt.h
"

35 
	~"ngtı2_cid.h
"

36 
	~"ngtı2_cÚv.h
"

38 
ssize_t
 
	$nuÎ_’üy±
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

39 cÚ¡ 
ušt8_t
 *
¶aš‹xt
, 
size_t
 
¶aš‹x’
,

40 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

41 cÚ¡ 
ušt8_t
 *
nÚû
, 
size_t
 
nÚûËn
,

42 cÚ¡ 
ušt8_t
 *
ad
, 
size_t
 
adËn
, *
u£r_d©a
) {

43 ()
cÚn
;

44 ()
de¡
;

45 ()
de¡Ën
;

46 ()
¶aš‹xt
;

47 ()
key
;

48 ()
keyËn
;

49 ()
nÚû
;

50 ()
nÚûËn
;

51 ()
ad
;

52 ()
adËn
;

53 ()
u£r_d©a
;

54  (
ssize_t
)
¶aš‹x’
 + 
NGTCP2_FAKE_AEAD_OVERHEAD
;

55 
	}
}

57 
ssize_t
 
	$nuÎ_deüy±
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

58 cÚ¡ 
ušt8_t
 *
ch”‹xt
, 
size_t
 
ch”‹x’
,

59 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

60 cÚ¡ 
ušt8_t
 *
nÚû
, 
size_t
 
nÚûËn
,

61 cÚ¡ 
ušt8_t
 *
ad
, 
size_t
 
adËn
, *
u£r_d©a
) {

62 ()
cÚn
;

63 ()
de¡
;

64 ()
de¡Ën
;

65 ()
ch”‹xt
;

66 ()
key
;

67 ()
keyËn
;

68 ()
nÚû
;

69 ()
nÚûËn
;

70 ()
ad
;

71 ()
adËn
;

72 ()
u£r_d©a
;

73 
	`as£¹
(
de¡Ën
 >ğ
ch”‹x’
);

74 
	`as£¹
(
ch”‹x’
 >ğ
NGTCP2_FAKE_AEAD_OVERHEAD
);

75 
	`memmove
(
de¡
, 
ch”‹xt
, 
ch”‹x’
 - 
NGTCP2_FAKE_AEAD_OVERHEAD
);

76  (
ssize_t
)
ch”‹x’
 - 
NGTCP2_FAKE_AEAD_OVERHEAD
;

77 
	}
}

79 
ssize_t
 
	$ç_deüy±
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

80 cÚ¡ 
ušt8_t
 *
ch”‹xt
, 
size_t
 
ch”‹x’
,

81 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

82 cÚ¡ 
ušt8_t
 *
nÚû
, 
size_t
 
nÚûËn
,

83 cÚ¡ 
ušt8_t
 *
ad
, 
size_t
 
adËn
, *
u£r_d©a
) {

84 ()
cÚn
;

85 ()
de¡
;

86 ()
de¡Ën
;

87 ()
ch”‹xt
;

88 ()
ch”‹x’
;

89 ()
key
;

90 ()
keyËn
;

91 ()
nÚû
;

92 ()
nÚûËn
;

93 ()
ad
;

94 ()
adËn
;

95 ()
u£r_d©a
;

96  
NGTCP2_ERR_TLS_DECRYPT
;

97 
	}
}

99 
ssize_t
 
	$nuÎ_hp_mask
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

100 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

101 cÚ¡ 
ušt8_t
 *
§m¶e
, 
size_t
 
§m¶–’
,

102 *
u£r_d©a
) {

103 ()
cÚn
;

104 ()
key
;

105 ()
keyËn
;

106 ()
u£r_d©a
;

107 ()
§m¶e
;

108 ()
§m¶–’
;

109 
	`as£¹
(
de¡Ën
 >ğ(
NGTCP2_FAKE_HP_MASK
) - 1);

110 
	`memıy
(
de¡
, 
NGTCP2_FAKE_HP_MASK
, (NGTCP2_FAKE_HP_MASK) - 1);

111  (
ssize_t
)((
NGTCP2_FAKE_HP_MASK
) - 1);

112 
	}
}

114 
	$g‘_Ãw_cÚÃùiÚ_id
(
ngtı2_cÚn
 *
cÚn
, 
ngtı2_cid
 *
cid
,

115 
ušt8_t
 *
tok’
, 
size_t
 
cidËn
,

116 *
u£r_d©a
) {

117 ()
u£r_d©a
;

118 
	`mem£t
(
cid
->
d©a
, 0, 
cidËn
);

119 
cid
->
d©a
[0] = (
ušt8_t
)(
cÚn
->
tx_Ï¡_cid_£q
 + 1);

120 
cid
->
d©®’
 = 
cidËn
;

121 
	`mem£t
(
tok’
, 0, 
NGTCP2_STATELESS_RESET_TOKENLEN
);

123 
	}
}

125 
ušt8_t
 
	gnuÎ_key
[16];

126 
ušt8_t
 
	gnuÎ_iv
[16];

127 
ušt8_t
 
	gnuÎ_²
[16];

128 
ušt8_t
 
	gnuÎ_d©a
[4096];

129 
ngtı2_·th
 
	gnuÎ_·th
 = {};

130 
ngtı2_·th
 
	gÃw_·th
 = {{1, (
ušt8_t
 *)"1"}, {1, (uint8_t *)"2"}};

132 
ngtı2_vec
 *
	$nuÎ_d©av
(
ngtı2_vec
 *
d©av
, 
size_t
 
Ën
) {

133 
d©av
->
ba£
 = 
nuÎ_d©a
;

134 
d©av
->
Ën
 =†en;

135  
d©av
;

136 
	}
}

139 
ušt64_t
 
	mpkt_num
;

143 
ušt64_t
 
	m¡»am_id
;

144 
	mfš
;

145 
size_t
 
	md©®’
;

146 } 
	m¡»am_d©a
;

147 } 
	tmy_u£r_d©a
;

149 
	$ş›Á_š™Ÿl
(
ngtı2_cÚn
 *
cÚn
, *
u£r_d©a
) {

150 ()
u£r_d©a
;

152 
	`ngtı2_cÚn_subm™_üy±o_d©a
(
cÚn
, 
nuÎ_d©a
, 217);

155 
	}
}

157 
	$ş›Á_š™Ÿl_—¾y_d©a
(
ngtı2_cÚn
 *
cÚn
, *
u£r_d©a
) {

158 ()
u£r_d©a
;

160 
	`ngtı2_cÚn_subm™_üy±o_d©a
(
cÚn
, 
nuÎ_d©a
, 217);

162 
	`ngtı2_cÚn_š¡®l_—¾y_keys
(
cÚn
, 
nuÎ_key
, ÒuÎ_key), 
nuÎ_iv
,

163 (
nuÎ_iv
), 
nuÎ_²
, (null_pn));

166 
	}
}

168 
	$»cv_ş›Á_š™Ÿl
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_cid
 *
dcid
,

169 *
u£r_d©a
) {

170 ()
cÚn
;

171 ()
dcid
;

172 ()
u£r_d©a
;

174 
	}
}

176 
	$»cv_üy±o_d©a
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
off£t
,

177 cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
,

178 *
u£r_d©a
) {

179 ()
cÚn
;

180 ()
off£t
;

181 ()
d©a
;

182 ()
d©®’
;

183 ()
u£r_d©a
;

185 
	}
}

187 
	$»cv_üy±o_d©a_£rv”_—¾y_d©a
(
ngtı2_cÚn
 *
cÚn
,

188 
ušt64_t
 
off£t
,

189 cÚ¡ 
ušt8_t
 *
d©a
,

190 
size_t
 
d©®’
, *
u£r_d©a
) {

191 ()
off£t
;

192 ()
d©a
;

193 ()
d©®’
;

194 ()
u£r_d©a
;

196 
	`as£¹
(
cÚn
->
£rv”
);

198 
	`ngtı2_cÚn_subm™_üy±o_d©a
(
cÚn
, 
nuÎ_d©a
, 179);

200 
	`ngtı2_cÚn_š¡®l_tx_keys
(
cÚn
, 
nuÎ_key
, ÒuÎ_key), 
nuÎ_iv
,

201 (
nuÎ_iv
), 
nuÎ_²
, (null_pn));

202 
	`ngtı2_cÚn_š¡®l_rx_keys
(
cÚn
, 
nuÎ_key
, ÒuÎ_key), 
nuÎ_iv
,

203 (
nuÎ_iv
), 
nuÎ_²
, (null_pn));

205 
cÚn
->
ÿÎbacks
.
»cv_üy±o_d©a
 =„ecv_crypto_data;

208 
	}
}

210 
	$»cv_üy±o_hªdshake_”rÜ
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
off£t
,

211 cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
,

212 *
u£r_d©a
) {

213 ()
cÚn
;

214 ()
off£t
;

215 ()
d©a
;

216 ()
d©®’
;

217 ()
u£r_d©a
;

218  
NGTCP2_ERR_CRYPTO
;

219 
	}
}

221 
	$»cv_üy±o_çl_®”t_g’”©ed
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
off£t
,

222 cÚ¡ 
ušt8_t
 *
d©a
,

223 
size_t
 
d©®’
, *
u£r_d©a
) {

224 ()
cÚn
;

225 ()
off£t
;

226 ()
d©a
;

227 ()
d©®’
;

228 ()
u£r_d©a
;

229  
NGTCP2_ERR_CRYPTO
;

230 
	}
}

232 
	$»cv_üy±o_d©a_£rv”
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
off£t
,

233 cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©®’
,

234 *
u£r_d©a
) {

235 ()
off£t
;

236 ()
d©a
;

237 ()
d©®’
;

238 ()
u£r_d©a
;

240 
	`ngtı2_cÚn_subm™_üy±o_d©a
(
cÚn
, 
nuÎ_d©a
, 218);

243 
	}
}

245 
	$»cv_¡»am_d©a
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
¡»am_id
, 
fš
,

246 
ušt64_t
 
off£t
, cÚ¡ 
ušt8_t
 *
d©a
,

247 
size_t
 
d©®’
, *
u£r_d©a
,

248 *
¡»am_u£r_d©a
) {

249 
my_u£r_d©a
 *
ud
 = 
u£r_d©a
;

250 ()
cÚn
;

251 ()
off£t
;

252 ()
d©a
;

253 ()
¡»am_u£r_d©a
;

255 ià(
ud
) {

256 
ud
->
¡»am_d©a
.
¡»am_id
 = stream_id;

257 
ud
->
¡»am_d©a
.
fš
 = fin;

258 
ud
->
¡»am_d©a
.
d©®’
 = datalen;

262 
	}
}

264 
	$»cv_»Œy
(
ngtı2_cÚn
 *
cÚn
, cÚ¡ 
ngtı2_pkt_hd
 *
hd
,

265 cÚ¡ 
ngtı2_pkt_»Œy
 *
»Œy
, *
u£r_d©a
) {

266 ()
cÚn
;

267 ()
hd
;

268 ()
»Œy
;

269 ()
u£r_d©a
;

271 
	}
}

273 
	$g’¿nd
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

274 
ngtı2_¿nd_ùx
 
ùx
, *
u£r_d©a
) {

275 ()
cÚn
;

276 ()
ùx
;

277 ()
u£r_d©a
;

279 
	`mem£t
(
de¡
, 0, 
de¡Ën
);

282 
	}
}

284 
	$£rv”_deçuÉ_£‰šgs
(
ngtı2_£‰šgs
 *
£‰šgs
) {

285 
size_t
 
i
;

287 
£‰šgs
->
log_´štf
 = 
NULL
;

288 
£‰šgs
->
š™Ÿl_ts
 = 0;

289 
£‰šgs
->
max_¡»am_d©a_bidi_loÿl
 = 65535;

290 
£‰šgs
->
max_¡»am_d©a_bidi_»mÙe
 = 65535;

291 
£‰šgs
->
max_¡»am_d©a_uni
 = 65535;

292 
£‰šgs
->
max_d©a
 = 128 * 1024;

293 
£‰šgs
->
max_¡»ams_bidi
 = 3;

294 
£‰šgs
->
max_¡»ams_uni
 = 2;

295 
£‰šgs
->
idË_timeout
 = 60;

296 
£‰šgs
->
max_·ck‘_size
 = 65535;

297 
£‰šgs
->
¡©–ess_»£t_tok’_´e£Á
 = 1;

298 
i
 = 0; i < 
NGTCP2_STATELESS_RESET_TOKENLEN
; ++i) {

299 
£‰šgs
->
¡©–ess_»£t_tok’
[
i
] = (
ušt8_t
)i;

301 
	}
}

303 
	$ş›Á_deçuÉ_£‰šgs
(
ngtı2_£‰šgs
 *
£‰šgs
) {

304 
£‰šgs
->
log_´štf
 = 
NULL
;

305 
£‰šgs
->
š™Ÿl_ts
 = 0;

306 
£‰šgs
->
max_¡»am_d©a_bidi_loÿl
 = 65535;

307 
£‰šgs
->
max_¡»am_d©a_bidi_»mÙe
 = 65535;

308 
£‰šgs
->
max_¡»am_d©a_uni
 = 65535;

309 
£‰šgs
->
max_d©a
 = 128 * 1024;

310 
£‰šgs
->
max_¡»ams_bidi
 = 0;

311 
£‰šgs
->
max_¡»ams_uni
 = 2;

312 
£‰šgs
->
idË_timeout
 = 60;

313 
£‰šgs
->
max_·ck‘_size
 = 65535;

314 
£‰šgs
->
¡©–ess_»£t_tok’_´e£Á
 = 0;

315 
	}
}

317 
	$£tup_deçuÉ_£rv”
(
ngtı2_cÚn
 **
pcÚn
) {

318 
ngtı2_cÚn_ÿÎbacks
 
cb
;

319 
ngtı2_£‰šgs
 
£‰šgs
;

320 
ngtı2_cid
 
dcid
, 
scid
;

322 
	`dcid_š™
(&
dcid
);

323 
	`scid_š™
(&
scid
);

325 
	`mem£t
(&
cb
, 0, (cb));

326 
cb
.
š_deüy±
 = 
nuÎ_deüy±
;

327 
cb
.
š_’üy±
 = 
nuÎ_’üy±
;

328 
cb
.
š_hp_mask
 = 
nuÎ_hp_mask
;

329 
cb
.
deüy±
 = 
nuÎ_deüy±
;

330 
cb
.
’üy±
 = 
nuÎ_’üy±
;

331 
cb
.
hp_mask
 = 
nuÎ_hp_mask
;

332 
cb
.
»cv_üy±o_d©a
 =„ecv_crypto_data;

333 
cb
.
g‘_Ãw_cÚÃùiÚ_id
 = get_new_connection_id;

334 
cb
.
¿nd
 = 
g’¿nd
;

335 
	`£rv”_deçuÉ_£‰šgs
(&
£‰šgs
);

337 
	`ngtı2_cÚn_£rv”_Ãw
(
pcÚn
, &
dcid
, &
scid
, &
nuÎ_·th
, 
NGTCP2_PROTO_VER_MAX
,

338 &
cb
, &
£‰šgs
, 
NULL
);

339 
	`ngtı2_cÚn_š¡®l_hªdshake_tx_keys
(*
pcÚn
, 
nuÎ_key
, (null_key),

340 
nuÎ_iv
, ÒuÎ_iv), 
nuÎ_²
,

341 (
nuÎ_²
));

342 
	`ngtı2_cÚn_š¡®l_hªdshake_rx_keys
(*
pcÚn
, 
nuÎ_key
, (null_key),

343 
nuÎ_iv
, ÒuÎ_iv), 
nuÎ_²
,

344 (
nuÎ_²
));

345 
	`ngtı2_cÚn_š¡®l_tx_keys
(*
pcÚn
, 
nuÎ_key
, ÒuÎ_key), 
nuÎ_iv
,

346 (
nuÎ_iv
), 
nuÎ_²
, (null_pn));

347 
	`ngtı2_cÚn_š¡®l_rx_keys
(*
pcÚn
, 
nuÎ_key
, ÒuÎ_key), 
nuÎ_iv
,

348 (
nuÎ_iv
), 
nuÎ_²
, (null_pn));

349 
	`ngtı2_cÚn_£t_«ad_ov”h—d
(*
pcÚn
, 
NGTCP2_FAKE_AEAD_OVERHEAD
);

350 (*
pcÚn
)->
¡©e
 = 
NGTCP2_CS_POST_HANDSHAKE
;

351 (*
pcÚn
)->
æags
 |ğ
NGTCP2_CONN_FLAG_CONN_ID_NEGOTIATED
 |

352 
NGTCP2_CONN_FLAG_SADDR_VERIFIED
 |

353 
NGTCP2_CONN_FLAG_HANDSHAKE_COMPLETED
 |

354 
NGTCP2_CONN_FLAG_HANDSHAKE_COMPLETED_HANDLED
;

355 (*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»am_d©a_bidi_loÿl
 = 64 * 1024;

356 (*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»am_d©a_bidi_»mÙe
 = 64 * 1024;

357 (*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»am_d©a_uni
 = 64 * 1024;

358 (*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»ams_bidi
 = 0;

359 (*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»ams_uni
 = 1;

360 (*
pcÚn
)->
»mÙe_£‰šgs
.
max_d©a
 = 64 * 1024;

361 (*
pcÚn
)->
max_loÿl_¡»am_id_bidi
 =

362 
	`ngtı2_Áh_£rv”_bidi_id
((*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»ams_bidi
);

363 (*
pcÚn
)->
max_loÿl_¡»am_id_uni
 =

364 
	`ngtı2_Áh_£rv”_uni_id
((*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»ams_uni
);

365 (*
pcÚn
)->
max_tx_off£t
 = (*pcÚn)->
»mÙe_£‰šgs
.
max_d©a
;

366 
	}
}

368 
	$£tup_deçuÉ_ş›Á
(
ngtı2_cÚn
 **
pcÚn
) {

369 
ngtı2_cÚn_ÿÎbacks
 
cb
;

370 
ngtı2_£‰šgs
 
£‰šgs
;

371 
ngtı2_cid
 
dcid
, 
scid
;

373 
	`dcid_š™
(&
dcid
);

374 
	`scid_š™
(&
scid
);

376 
	`mem£t
(&
cb
, 0, (cb));

377 
cb
.
š_deüy±
 = 
nuÎ_deüy±
;

378 
cb
.
š_’üy±
 = 
nuÎ_’üy±
;

379 
cb
.
š_hp_mask
 = 
nuÎ_hp_mask
;

380 
cb
.
deüy±
 = 
nuÎ_deüy±
;

381 
cb
.
’üy±
 = 
nuÎ_’üy±
;

382 
cb
.
hp_mask
 = 
nuÎ_hp_mask
;

383 
cb
.
»cv_üy±o_d©a
 =„ecv_crypto_data;

384 
cb
.
g‘_Ãw_cÚÃùiÚ_id
 = get_new_connection_id;

385 
	`ş›Á_deçuÉ_£‰šgs
(&
£‰šgs
);

387 
	`ngtı2_cÚn_ş›Á_Ãw
(
pcÚn
, &
dcid
, &
scid
, &
nuÎ_·th
, 
NGTCP2_PROTO_VER_MAX
,

388 &
cb
, &
£‰šgs
, 
NULL
);

389 
	`ngtı2_cÚn_š¡®l_hªdshake_tx_keys
(*
pcÚn
, 
nuÎ_key
, (null_key),

390 
nuÎ_iv
, ÒuÎ_iv), 
nuÎ_²
,

391 (
nuÎ_²
));

392 
	`ngtı2_cÚn_š¡®l_hªdshake_rx_keys
(*
pcÚn
, 
nuÎ_key
, (null_key),

393 
nuÎ_iv
, ÒuÎ_iv), 
nuÎ_²
,

394 (
nuÎ_²
));

395 
	`ngtı2_cÚn_š¡®l_tx_keys
(*
pcÚn
, 
nuÎ_key
, ÒuÎ_key), 
nuÎ_iv
,

396 (
nuÎ_iv
), 
nuÎ_²
, (null_pn));

397 
	`ngtı2_cÚn_š¡®l_rx_keys
(*
pcÚn
, 
nuÎ_key
, ÒuÎ_key), 
nuÎ_iv
,

398 (
nuÎ_iv
), 
nuÎ_²
, (null_pn));

399 
	`ngtı2_cÚn_£t_«ad_ov”h—d
(*
pcÚn
, 
NGTCP2_FAKE_AEAD_OVERHEAD
);

400 (*
pcÚn
)->
¡©e
 = 
NGTCP2_CS_POST_HANDSHAKE
;

401 (*
pcÚn
)->
æags
 |ğ
NGTCP2_CONN_FLAG_CONN_ID_NEGOTIATED
 |

402 
NGTCP2_CONN_FLAG_HANDSHAKE_COMPLETED
 |

403 
NGTCP2_CONN_FLAG_HANDSHAKE_COMPLETED_HANDLED
;

404 (*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»am_d©a_bidi_loÿl
 = 64 * 1024;

405 (*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»am_d©a_bidi_»mÙe
 = 64 * 1024;

406 (*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»am_d©a_uni
 = 64 * 1024;

407 (*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»ams_bidi
 = 1;

408 (*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»ams_uni
 = 1;

409 (*
pcÚn
)->
»mÙe_£‰šgs
.
max_d©a
 = 64 * 1024;

410 (*
pcÚn
)->
max_loÿl_¡»am_id_bidi
 =

411 
	`ngtı2_Áh_ş›Á_bidi_id
((*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»ams_bidi
);

412 (*
pcÚn
)->
max_loÿl_¡»am_id_uni
 =

413 
	`ngtı2_Áh_ş›Á_uni_id
((*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»ams_uni
);

414 (*
pcÚn
)->
max_tx_off£t
 = (*pcÚn)->
»mÙe_£‰šgs
.
max_d©a
;

415 
	}
}

417 
	$£tup_hªdshake_£rv”
(
ngtı2_cÚn
 **
pcÚn
) {

418 
ngtı2_cÚn_ÿÎbacks
 
cb
;

419 
ngtı2_£‰šgs
 
£‰šgs
;

420 
ngtı2_cid
 
dcid
, 
scid
;

422 
	`dcid_š™
(&
dcid
);

423 
	`scid_š™
(&
scid
);

425 
	`mem£t
(&
cb
, 0, (cb));

426 
cb
.
»cv_ş›Á_š™Ÿl
 =„ecv_client_initial;

427 
cb
.
»cv_üy±o_d©a
 = 
»cv_üy±o_d©a_£rv”
;

428 
cb
.
š_deüy±
 = 
nuÎ_deüy±
;

429 
cb
.
š_’üy±
 = 
nuÎ_’üy±
;

430 
cb
.
š_hp_mask
 = 
nuÎ_hp_mask
;

431 
cb
.
deüy±
 = 
nuÎ_deüy±
;

432 
cb
.
’üy±
 = 
nuÎ_’üy±
;

433 
cb
.
hp_mask
 = 
nuÎ_hp_mask
;

434 
cb
.
¿nd
 = 
g’¿nd
;

435 
	`£rv”_deçuÉ_£‰šgs
(&
£‰šgs
);

437 
	`ngtı2_cÚn_£rv”_Ãw
(
pcÚn
, &
dcid
, &
scid
, &
nuÎ_·th
, 
NGTCP2_PROTO_VER_MAX
,

438 &
cb
, &
£‰šgs
, 
NULL
);

439 
	`ngtı2_cÚn_š¡®l_š™Ÿl_tx_keys
(*
pcÚn
, 
nuÎ_key
, (null_key),

440 
nuÎ_iv
, ÒuÎ_iv), 
nuÎ_²
,

441 (
nuÎ_²
));

442 
	`ngtı2_cÚn_š¡®l_š™Ÿl_rx_keys
(*
pcÚn
, 
nuÎ_key
, (null_key),

443 
nuÎ_iv
, ÒuÎ_iv), 
nuÎ_²
,

444 (
nuÎ_²
));

445 
	`ngtı2_cÚn_š¡®l_hªdshake_tx_keys
(*
pcÚn
, 
nuÎ_key
, (null_key),

446 
nuÎ_iv
, ÒuÎ_iv), 
nuÎ_²
,

447 (
nuÎ_²
));

448 
	`ngtı2_cÚn_š¡®l_hªdshake_rx_keys
(*
pcÚn
, 
nuÎ_key
, (null_key),

449 
nuÎ_iv
, ÒuÎ_iv), 
nuÎ_²
,

450 (
nuÎ_²
));

451 
	`ngtı2_cÚn_£t_«ad_ov”h—d
(*
pcÚn
, 
NGTCP2_FAKE_AEAD_OVERHEAD
);

452 
	}
}

454 
	$£tup_hªdshake_ş›Á
(
ngtı2_cÚn
 **
pcÚn
) {

455 
ngtı2_cÚn_ÿÎbacks
 
cb
;

456 
ngtı2_£‰šgs
 
£‰šgs
;

457 
ngtı2_cid
 
rcid
, 
scid
;

459 
	`rcid_š™
(&
rcid
);

460 
	`scid_š™
(&
scid
);

462 
	`mem£t
(&
cb
, 0, (cb));

463 
cb
.
ş›Á_š™Ÿl
 = client_initial;

464 
cb
.
»cv_üy±o_d©a
 =„ecv_crypto_data;

465 
cb
.
š_deüy±
 = 
nuÎ_deüy±
;

466 
cb
.
š_’üy±
 = 
nuÎ_’üy±
;

467 
cb
.
š_hp_mask
 = 
nuÎ_hp_mask
;

468 
	`ş›Á_deçuÉ_£‰šgs
(&
£‰šgs
);

470 
	`ngtı2_cÚn_ş›Á_Ãw
(
pcÚn
, &
rcid
, &
scid
, &
nuÎ_·th
, 
NGTCP2_PROTO_VER_MAX
,

471 &
cb
, &
£‰šgs
, 
NULL
);

472 
	`ngtı2_cÚn_š¡®l_š™Ÿl_tx_keys
(*
pcÚn
, 
nuÎ_key
, (null_key),

473 
nuÎ_iv
, ÒuÎ_iv), 
nuÎ_²
,

474 (
nuÎ_²
));

475 
	`ngtı2_cÚn_š¡®l_š™Ÿl_rx_keys
(*
pcÚn
, 
nuÎ_key
, (null_key),

476 
nuÎ_iv
, ÒuÎ_iv), 
nuÎ_²
,

477 (
nuÎ_²
));

478 
	}
}

480 
	$£tup_—¾y_£rv”
(
ngtı2_cÚn
 **
pcÚn
) {

481 
ngtı2_cÚn_ÿÎbacks
 
cb
;

482 
ngtı2_£‰šgs
 
£‰šgs
;

483 
ngtı2_cid
 
dcid
, 
scid
;

485 
	`dcid_š™
(&
dcid
);

486 
	`scid_š™
(&
scid
);

488 
	`mem£t
(&
cb
, 0, (cb));

489 
cb
.
»cv_ş›Á_š™Ÿl
 =„ecv_client_initial;

490 
cb
.
»cv_üy±o_d©a
 = 
»cv_üy±o_d©a_£rv”_—¾y_d©a
;

491 
cb
.
š_deüy±
 = 
nuÎ_deüy±
;

492 
cb
.
š_’üy±
 = 
nuÎ_’üy±
;

493 
cb
.
š_hp_mask
 = 
nuÎ_hp_mask
;

494 
cb
.
deüy±
 = 
nuÎ_deüy±
;

495 
cb
.
’üy±
 = 
nuÎ_’üy±
;

496 
cb
.
hp_mask
 = 
nuÎ_hp_mask
;

497 
cb
.
¿nd
 = 
g’¿nd
;

498 
	`£rv”_deçuÉ_£‰šgs
(&
£‰šgs
);

500 
	`ngtı2_cÚn_£rv”_Ãw
(
pcÚn
, &
dcid
, &
scid
, &
nuÎ_·th
, 
NGTCP2_PROTO_VER_MAX
,

501 &
cb
, &
£‰šgs
, 
NULL
);

502 
	`ngtı2_cÚn_š¡®l_š™Ÿl_tx_keys
(*
pcÚn
, 
nuÎ_key
, (null_key),

503 
nuÎ_iv
, ÒuÎ_iv), 
nuÎ_²
,

504 (
nuÎ_²
));

505 
	`ngtı2_cÚn_š¡®l_š™Ÿl_rx_keys
(*
pcÚn
, 
nuÎ_key
, (null_key),

506 
nuÎ_iv
, ÒuÎ_iv), 
nuÎ_²
,

507 (
nuÎ_²
));

508 
	`ngtı2_cÚn_š¡®l_—¾y_keys
(*
pcÚn
, 
nuÎ_key
, ÒuÎ_key), 
nuÎ_iv
,

509 (
nuÎ_iv
), 
nuÎ_²
, (null_pn));

510 
	`ngtı2_cÚn_£t_«ad_ov”h—d
(*
pcÚn
, 
NGTCP2_FAKE_AEAD_OVERHEAD
);

511 (*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»am_d©a_bidi_loÿl
 = 64 * 1024;

512 (*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»am_d©a_bidi_»mÙe
 = 64 * 1024;

513 (*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»am_d©a_uni
 = 64 * 1024;

514 (*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»ams_bidi
 = 0;

515 (*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»ams_uni
 = 1;

516 (*
pcÚn
)->
»mÙe_£‰šgs
.
max_d©a
 = 64 * 1024;

517 (*
pcÚn
)->
max_loÿl_¡»am_id_bidi
 =

518 
	`ngtı2_Áh_£rv”_bidi_id
((*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»ams_bidi
);

519 (*
pcÚn
)->
max_loÿl_¡»am_id_uni
 =

520 
	`ngtı2_Áh_£rv”_uni_id
((*
pcÚn
)->
»mÙe_£‰šgs
.
max_¡»ams_uni
);

521 (*
pcÚn
)->
max_tx_off£t
 = (*pcÚn)->
»mÙe_£‰šgs
.
max_d©a
;

522 
	}
}

524 
	$£tup_—¾y_ş›Á
(
ngtı2_cÚn
 **
pcÚn
) {

525 
ngtı2_cÚn_ÿÎbacks
 
cb
;

526 
ngtı2_£‰šgs
 
£‰šgs
;

527 
ngtı2_Œª¥Üt_·¿ms
 
·¿ms
;

528 
ngtı2_cid
 
dcid
, 
scid
;

530 
	`dcid_š™
(&
dcid
);

531 
	`scid_š™
(&
scid
);

533 
	`mem£t
(&
cb
, 0, (cb));

534 
cb
.
ş›Á_š™Ÿl
 = 
ş›Á_š™Ÿl_—¾y_d©a
;

535 
cb
.
»cv_üy±o_d©a
 =„ecv_crypto_data;

536 
cb
.
š_deüy±
 = 
nuÎ_deüy±
;

537 
cb
.
š_’üy±
 = 
nuÎ_’üy±
;

538 
cb
.
š_hp_mask
 = 
nuÎ_hp_mask
;

539 
cb
.
deüy±
 = 
nuÎ_deüy±
;

540 
cb
.
’üy±
 = 
nuÎ_’üy±
;

541 
cb
.
hp_mask
 = 
nuÎ_hp_mask
;

542 
	`ş›Á_deçuÉ_£‰šgs
(&
£‰šgs
);

544 
	`ngtı2_cÚn_ş›Á_Ãw
(
pcÚn
, &
dcid
, &
scid
, &
nuÎ_·th
, 
NGTCP2_PROTO_VER_MAX
,

545 &
cb
, &
£‰šgs
, 
NULL
);

546 
	`ngtı2_cÚn_š¡®l_š™Ÿl_tx_keys
(*
pcÚn
, 
nuÎ_key
, (null_key),

547 
nuÎ_iv
, ÒuÎ_iv), 
nuÎ_²
,

548 (
nuÎ_²
));

549 
	`ngtı2_cÚn_š¡®l_š™Ÿl_rx_keys
(*
pcÚn
, 
nuÎ_key
, (null_key),

550 
nuÎ_iv
, ÒuÎ_iv), 
nuÎ_²
,

551 (
nuÎ_²
));

552 
	`ngtı2_cÚn_£t_«ad_ov”h—d
(*
pcÚn
, 
NGTCP2_FAKE_AEAD_OVERHEAD
);

554 
·¿ms
.
š™Ÿl_max_¡»am_d©a_bidi_loÿl
 = 64 * 1024;

555 
·¿ms
.
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
 = 64 * 1024;

556 
·¿ms
.
š™Ÿl_max_¡»am_d©a_uni
 = 64 * 1024;

557 
·¿ms
.
š™Ÿl_max_¡»ams_bidi
 = 1;

558 
·¿ms
.
š™Ÿl_max_¡»ams_uni
 = 1;

559 
·¿ms
.
š™Ÿl_max_d©a
 = 64 * 1024;

561 
	`ngtı2_cÚn_£t_—¾y_»mÙe_Œª¥Üt_·¿ms
(*
pcÚn
, &
·¿ms
);

562 
	}
}

564 
	$‹¡_ngtı2_cÚn_¡»am_İ’_şo£
() {

565 
ngtı2_cÚn
 *
cÚn
;

566 
ušt8_t
 
buf
[2048];

567 
size_t
 
pk’
;

568 
ssize_t
 
¥k’
;

569 
rv
;

570 
ngtı2_äame
 
ä
;

571 
ngtı2_¡rm
 *
¡rm
;

572 
ušt64_t
 
¡»am_id
;

574 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

576 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

577 
ä
.
¡»am
.
æags
 = 0;

578 
ä
.
¡»am
.
¡»am_id
 = 4;

579 
ä
.
¡»am
.
fš
 = 0;

580 
ä
.
¡»am
.
off£t
 = 0;

581 
ä
.
¡»am
.
d©aút
 = 1;

582 
ä
.
¡»am
.
d©a
[0].
Ën
 = 17;

583 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

585 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

587 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

589 
	`CU_ASSERT
(0 =ğ
rv
);

591 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4);

593 
	`CU_ASSERT
(
NGTCP2_STRM_FLAG_NONE
 =ğ
¡rm
->
æags
);

595 
ä
.
¡»am
.
fš
 = 1;

596 
ä
.
¡»am
.
off£t
 = 17;

597 
ä
.
¡»am
.
d©aút
 = 0;

599 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 2, &
ä
);

601 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 2);

603 
	`CU_ASSERT
(0 =ğ
rv
);

604 
	`CU_ASSERT
(
NGTCP2_STRM_FLAG_SHUT_RD
 =ğ
¡rm
->
æags
);

605 
	`CU_ASSERT
(
ä
.
¡»am
.
off£t
 =ğ
¡rm
->
Ï¡_rx_off£t
);

606 
	`CU_ASSERT
(
ä
.
¡»am
.
off£t
 =ğ
	`ngtı2_¡rm_rx_off£t
(
¡rm
));

608 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), NULL, 4, 1,

609 
NULL
, 0, 3);

611 
	`CU_ASSERT
(
¥k’
 > 0);

613 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4);

615 
	`CU_ASSERT
(
NULL
 !ğ
¡rm
);

618 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

619 
ä
.
¡»am
.
æags
 = 0;

620 
ä
.
¡»am
.
¡»am_id
 = 2;

621 
ä
.
¡»am
.
fš
 = 0;

622 
ä
.
¡»am
.
off£t
 = 0;

623 
ä
.
¡»am
.
d©aút
 = 1;

624 
ä
.
¡»am
.
d©a
[0].
Ën
 = 19;

625 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

627 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 3, &
ä
);

629 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 3);

631 
	`CU_ASSERT
(0 =ğ
rv
);

633 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 2);

635 
	`CU_ASSERT
(
NGTCP2_STRM_FLAG_SHUT_WR
 =ğ
¡rm
->
æags
);

636 
	`CU_ASSERT
(
ä
.
¡»am
.
d©a
[0].
Ën
 =ğ
¡rm
->
Ï¡_rx_off£t
);

637 
	`CU_ASSERT
(
ä
.
¡»am
.
d©a
[0].
Ën
 =ğ
	`ngtı2_¡rm_rx_off£t
(
¡rm
));

640 
rv
 = 
	`ngtı2_cÚn_İ’_uni_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

642 
	`CU_ASSERT
(0 =ğ
rv
);

643 
	`CU_ASSERT
(3 =ğ
¡»am_id
);

645 
rv
 = 
	`ngtı2_cÚn_İ’_uni_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

647 
	`CU_ASSERT
(
NGTCP2_ERR_STREAM_ID_BLOCKED
 =ğ
rv
);

649 
	`ngtı2_cÚn_d–
(
cÚn
);

650 
	}
}

652 
	$‹¡_ngtı2_cÚn_¡»am_rx_æow_cÚŒŞ
() {

653 
ngtı2_cÚn
 *
cÚn
;

654 
ušt8_t
 
buf
[2048];

655 
size_t
 
pk’
;

656 
ssize_t
 
¥k’
;

657 
rv
;

658 
ngtı2_äame
 
ä
;

659 
ngtı2_¡rm
 *
¡rm
;

660 
size_t
 
i
;

662 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

664 
cÚn
->
loÿl_£‰šgs
.
max_¡»am_d©a_bidi_»mÙe
 = 2047;

666 
i
 = 0; i < 3; ++i) {

667 
ušt64_t
 
¡»am_id
 = 
i
 * 4;

668 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

669 
ä
.
¡»am
.
æags
 = 0;

670 
ä
.
¡»am
.
¡»am_id
 = stream_id;

671 
ä
.
¡»am
.
fš
 = 0;

672 
ä
.
¡»am
.
off£t
 = 0;

673 
ä
.
¡»am
.
d©aút
 = 1;

674 
ä
.
¡»am
.
d©a
[0].
Ën
 = 1024;

675 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

677 
pk’
 =

678 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 
i
, &
ä
);

679 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

681 
	`CU_ASSERT
(0 =ğ
rv
);

683 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
);

685 
	`CU_ASSERT
(
NULL
 !ğ
¡rm
);

687 
rv
 = 
	`ngtı2_cÚn_ex‹nd_max_¡»am_off£t
(
cÚn
, 
¡»am_id
,

688 
ä
.
¡»am
.
d©a
[0].
Ën
);

690 
	`CU_ASSERT
(0 =ğ
rv
);

693 
	`CU_ASSERT
(3 =ğ
	`ngtı2_pq_size
(&
cÚn
->
tx_¡rmq
));

695 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 0);

697 
	`CU_ASSERT
(
	`ngtı2_¡rm_is_tx_queued
(
¡rm
));

699 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4);

701 
	`CU_ASSERT
(
	`ngtı2_¡rm_is_tx_queued
(
¡rm
));

703 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 8);

705 
	`CU_ASSERT
(
	`ngtı2_¡rm_is_tx_queued
(
¡rm
));

707 
¥k’
 = 
	`ngtı2_cÚn_wr™e_pkt
(
cÚn
, 
NULL
, 
buf
, (buf), 2);

709 
	`CU_ASSERT
(
¥k’
 > 0);

710 
	`CU_ASSERT
(
	`ngtı2_pq_em±y
(&
cÚn
->
tx_¡rmq
));

712 
i
 = 0; i < 3; ++i) {

713 
ušt64_t
 
¡»am_id
 = 
i
 * 4;

714 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
);

716 
	`CU_ASSERT
(2047 + 1024 =ğ
¡rm
->
max_rx_off£t
);

719 
	`ngtı2_cÚn_d–
(
cÚn
);

720 
	}
}

722 
	$‹¡_ngtı2_cÚn_¡»am_rx_æow_cÚŒŞ_”rÜ
() {

723 
ngtı2_cÚn
 *
cÚn
;

724 
ušt8_t
 
buf
[2048];

725 
size_t
 
pk’
;

726 
rv
;

727 
ngtı2_äame
 
ä
;

729 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

731 
cÚn
->
loÿl_£‰šgs
.
max_¡»am_d©a_bidi_»mÙe
 = 1023;

733 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

734 
ä
.
¡»am
.
æags
 = 0;

735 
ä
.
¡»am
.
¡»am_id
 = 4;

736 
ä
.
¡»am
.
fš
 = 0;

737 
ä
.
¡»am
.
off£t
 = 0;

738 
ä
.
¡»am
.
d©aút
 = 1;

739 
ä
.
¡»am
.
d©a
[0].
Ën
 = 1024;

740 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

742 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

743 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

745 
	`CU_ASSERT
(
NGTCP2_ERR_FLOW_CONTROL
 =ğ
rv
);

747 
	`ngtı2_cÚn_d–
(
cÚn
);

748 
	}
}

750 
	$‹¡_ngtı2_cÚn_¡»am_tx_æow_cÚŒŞ
() {

751 
ngtı2_cÚn
 *
cÚn
;

752 
ušt8_t
 
buf
[2048];

753 
size_t
 
pk’
;

754 
ssize_t
 
¥k’
;

755 
rv
;

756 
ngtı2_äame
 
ä
;

757 
ngtı2_¡rm
 *
¡rm
;

758 
ssize_t
 
nwr™e
;

759 
ušt64_t
 
¡»am_id
;

761 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

763 
cÚn
->
»mÙe_£‰šgs
.
max_¡»am_d©a_bidi_»mÙe
 = 2047;

765 
rv
 = 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

767 
	`CU_ASSERT
(0 =ğ
rv
);

769 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
);

770 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), &
nwr™e
,

771 
¡»am_id
, 0, 
nuÎ_d©a
, 1024, 1);

773 
	`CU_ASSERT
(
¥k’
 > 0);

774 
	`CU_ASSERT
(1024 =ğ
nwr™e
);

775 
	`CU_ASSERT
(1024 =ğ
¡rm
->
tx_off£t
);

777 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), &
nwr™e
,

778 
¡»am_id
, 0, 
nuÎ_d©a
, 1024, 2);

780 
	`CU_ASSERT
(
¥k’
 > 0);

781 
	`CU_ASSERT
(1023 =ğ
nwr™e
);

782 
	`CU_ASSERT
(2047 =ğ
¡rm
->
tx_off£t
);

784 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), &
nwr™e
,

785 
¡»am_id
, 0, 
nuÎ_d©a
, 1024, 3);

787 
	`CU_ASSERT
(
NGTCP2_ERR_STREAM_DATA_BLOCKED
 =ğ
¥k’
);

790 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), &
nwr™e
,

791 
¡»am_id
, 0, 
nuÎ_d©a
, 0, 3);

793 
	`CU_ASSERT
(
¥k’
 > 0);

794 
	`CU_ASSERT
(0 =ğ
nwr™e
);

795 
	`CU_ASSERT
(2047 =ğ
¡rm
->
tx_off£t
);

797 
ä
.
ty³
 = 
NGTCP2_FRAME_MAX_STREAM_DATA
;

798 
ä
.
max_¡»am_d©a
.
¡»am_id
 = stream_id;

799 
ä
.
max_¡»am_d©a
.max_stream_data = 2048;

801 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

803 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 4);

805 
	`CU_ASSERT
(0 =ğ
rv
);

806 
	`CU_ASSERT
(2048 =ğ
¡rm
->
max_tx_off£t
);

808 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), &
nwr™e
,

809 
¡»am_id
, 0, 
nuÎ_d©a
, 1024, 5);

811 
	`CU_ASSERT
(
¥k’
 > 0);

812 
	`CU_ASSERT
(1 =ğ
nwr™e
);

813 
	`CU_ASSERT
(2048 =ğ
¡rm
->
tx_off£t
);

815 
	`ngtı2_cÚn_d–
(
cÚn
);

818 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

820 
cÚn
->
ccs
.
cwnd
 = 1;

822 
rv
 = 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

824 
	`CU_ASSERT
(0 =ğ
rv
);

826 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), &
nwr™e
,

827 
¡»am_id
, 1, 
nuÎ_d©a
, 1024, 1);

829 
	`CU_ASSERT
(0 =ğ
¥k’
);

830 
	`CU_ASSERT
(-1 =ğ
nwr™e
);

832 
	`ngtı2_cÚn_d–
(
cÚn
);

833 
	}
}

835 
	$‹¡_ngtı2_cÚn_rx_æow_cÚŒŞ
() {

836 
ngtı2_cÚn
 *
cÚn
;

837 
ušt8_t
 
buf
[2048];

838 
size_t
 
pk’
;

839 
ssize_t
 
¥k’
;

840 
rv
;

841 
ngtı2_äame
 
ä
;

843 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

845 
cÚn
->
loÿl_£‰šgs
.
max_d©a
 = 1024;

846 
cÚn
->
max_rx_off£t
 = 1024;

847 
cÚn
->
un£Á_max_rx_off£t
 = 1024;

849 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

850 
ä
.
¡»am
.
æags
 = 0;

851 
ä
.
¡»am
.
¡»am_id
 = 4;

852 
ä
.
¡»am
.
fš
 = 0;

853 
ä
.
¡»am
.
off£t
 = 0;

854 
ä
.
¡»am
.
d©aút
 = 1;

855 
ä
.
¡»am
.
d©a
[0].
Ën
 = 1023;

856 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

858 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

859 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

861 
	`CU_ASSERT
(0 =ğ
rv
);

863 
	`ngtı2_cÚn_ex‹nd_max_off£t
(
cÚn
, 1023);

865 
	`CU_ASSERT
(1024 + 1023 =ğ
cÚn
->
un£Á_max_rx_off£t
);

866 
	`CU_ASSERT
(1024 =ğ
cÚn
->
max_rx_off£t
);

868 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

869 
ä
.
¡»am
.
æags
 = 0;

870 
ä
.
¡»am
.
¡»am_id
 = 4;

871 
ä
.
¡»am
.
fš
 = 0;

872 
ä
.
¡»am
.
off£t
 = 1023;

873 
ä
.
¡»am
.
d©aút
 = 1;

874 
ä
.
¡»am
.
d©a
[0].
Ën
 = 1;

875 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

877 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 2, &
ä
);

878 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 2);

880 
	`CU_ASSERT
(0 =ğ
rv
);

882 
	`ngtı2_cÚn_ex‹nd_max_off£t
(
cÚn
, 1);

884 
	`CU_ASSERT
(2048 =ğ
cÚn
->
un£Á_max_rx_off£t
);

885 
	`CU_ASSERT
(1024 =ğ
cÚn
->
max_rx_off£t
);

887 
¥k’
 = 
	`ngtı2_cÚn_wr™e_pkt
(
cÚn
, 
NULL
, 
buf
, (buf), 3);

889 
	`CU_ASSERT
(
¥k’
 > 0);

890 
	`CU_ASSERT
(2048 =ğ
cÚn
->
max_rx_off£t
);

892 
	`ngtı2_cÚn_d–
(
cÚn
);

893 
	}
}

895 
	$‹¡_ngtı2_cÚn_rx_æow_cÚŒŞ_”rÜ
() {

896 
ngtı2_cÚn
 *
cÚn
;

897 
ušt8_t
 
buf
[2048];

898 
size_t
 
pk’
;

899 
rv
;

900 
ngtı2_äame
 
ä
;

902 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

904 
cÚn
->
loÿl_£‰šgs
.
max_d©a
 = 1024;

905 
cÚn
->
max_rx_off£t
 = 1024;

906 
cÚn
->
un£Á_max_rx_off£t
 = 1024;

908 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

909 
ä
.
¡»am
.
æags
 = 0;

910 
ä
.
¡»am
.
¡»am_id
 = 4;

911 
ä
.
¡»am
.
fš
 = 0;

912 
ä
.
¡»am
.
off£t
 = 0;

913 
ä
.
¡»am
.
d©aút
 = 1;

914 
ä
.
¡»am
.
d©a
[0].
Ën
 = 1025;

915 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

917 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

918 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

920 
	`CU_ASSERT
(
NGTCP2_ERR_FLOW_CONTROL
 =ğ
rv
);

922 
	`ngtı2_cÚn_d–
(
cÚn
);

923 
	}
}

925 
	$‹¡_ngtı2_cÚn_tx_æow_cÚŒŞ
() {

926 
ngtı2_cÚn
 *
cÚn
;

927 
ušt8_t
 
buf
[2048];

928 
size_t
 
pk’
;

929 
ssize_t
 
¥k’
;

930 
rv
;

931 
ngtı2_äame
 
ä
;

932 
ssize_t
 
nwr™e
;

933 
ušt64_t
 
¡»am_id
;

935 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

937 
cÚn
->
»mÙe_£‰šgs
.
max_d©a
 = 2048;

938 
cÚn
->
max_tx_off£t
 = 2048;

940 
rv
 = 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

942 
	`CU_ASSERT
(0 =ğ
rv
);

944 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), &
nwr™e
,

945 
¡»am_id
, 0, 
nuÎ_d©a
, 1024, 1);

947 
	`CU_ASSERT
(
¥k’
 > 0);

948 
	`CU_ASSERT
(1024 =ğ
nwr™e
);

949 
	`CU_ASSERT
(1024 =ğ
cÚn
->
tx_off£t
);

951 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), &
nwr™e
,

952 
¡»am_id
, 0, 
nuÎ_d©a
, 1023, 2);

954 
	`CU_ASSERT
(
¥k’
 > 0);

955 
	`CU_ASSERT
(1023 =ğ
nwr™e
);

956 
	`CU_ASSERT
(1024 + 1023 =ğ
cÚn
->
tx_off£t
);

958 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), &
nwr™e
,

959 
¡»am_id
, 0, 
nuÎ_d©a
, 1024, 3);

961 
	`CU_ASSERT
(
¥k’
 > 0);

962 
	`CU_ASSERT
(1 =ğ
nwr™e
);

963 
	`CU_ASSERT
(2048 =ğ
cÚn
->
tx_off£t
);

965 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), &
nwr™e
,

966 
¡»am_id
, 0, 
nuÎ_d©a
, 1024, 4);

968 
	`CU_ASSERT
(
NGTCP2_ERR_STREAM_DATA_BLOCKED
 =ğ
¥k’
);

969 
	`CU_ASSERT
(-1 =ğ
nwr™e
);

971 
ä
.
ty³
 = 
NGTCP2_FRAME_MAX_DATA
;

972 
ä
.
max_d©a
.max_data = 3072;

974 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

976 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 5);

978 
	`CU_ASSERT
(0 =ğ
rv
);

979 
	`CU_ASSERT
(3072 =ğ
cÚn
->
max_tx_off£t
);

981 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), &
nwr™e
,

982 
¡»am_id
, 0, 
nuÎ_d©a
, 1024, 4);

984 
	`CU_ASSERT
(
¥k’
 > 0);

985 
	`CU_ASSERT
(1024 =ğ
nwr™e
);

986 
	`CU_ASSERT
(3072 =ğ
cÚn
->
tx_off£t
);

988 
	`ngtı2_cÚn_d–
(
cÚn
);

989 
	}
}

991 
	$‹¡_ngtı2_cÚn_shutdown_¡»am_wr™e
() {

992 
ngtı2_cÚn
 *
cÚn
;

993 
rv
;

994 
ngtı2_äame_chaš
 *
äc
;

995 
ušt8_t
 
buf
[2048];

996 
ngtı2_äame
 
ä
;

997 
size_t
 
pk’
;

998 
ssize_t
 
¥k’
;

999 
ngtı2_¡rm
 *
¡rm
;

1000 
ušt64_t
 
¡»am_id
;

1003 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1005 
rv
 = 
	`ngtı2_cÚn_shutdown_¡»am_wr™e
(
cÚn
, 4, 
NGTCP2_APP_ERR01
);

1007 
	`CU_ASSERT
(
NGTCP2_ERR_STREAM_NOT_FOUND
 =ğ
rv
);

1009 
	`ngtı2_cÚn_d–
(
cÚn
);

1012 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

1014 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

1015 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), NULL, 
¡»am_id
, 0,

1016 
nuÎ_d©a
, 1239, 1);

1017 
rv
 = 
	`ngtı2_cÚn_shutdown_¡»am_wr™e
(
cÚn
, 
¡»am_id
, 
NGTCP2_APP_ERR01
);

1019 
	`CU_ASSERT
(0 =ğ
rv
);

1021 
äc
 = 
cÚn
->
pkŠs
.
äq
; frc; frøğäc->
Ãxt
) {

1022 ià(
äc
->
ä
.
ty³
 =ğ
NGTCP2_FRAME_RESET_STREAM
) {

1027 
	`CU_ASSERT
(
NULL
 !ğ
äc
);

1028 
	`CU_ASSERT
(
¡»am_id
 =ğ
äc
->
ä
.
»£t_¡»am
.stream_id);

1029 
	`CU_ASSERT
(
NGTCP2_APP_ERR01
 =ğ
äc
->
ä
.
»£t_¡»am
.
­p_”rÜ_code
);

1030 
	`CU_ASSERT
(1239 =ğ
äc
->
ä
.
»£t_¡»am
.
fš®_off£t
);

1032 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
);

1034 
	`CU_ASSERT
(
NULL
 !ğ
¡rm
);

1035 
	`CU_ASSERT
(
NGTCP2_APP_ERR01
 =ğ
¡rm
->
­p_”rÜ_code
);

1037 
¥k’
 = 
	`ngtı2_cÚn_wr™e_pkt
(
cÚn
, 
NULL
, 
buf
, (buf), 2);

1039 
	`CU_ASSERT
(
¥k’
 > 0);

1041 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

1042 
ä
.
»£t_¡»am
.
¡»am_id
 = stream_id;

1043 
ä
.
»£t_¡»am
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR02
;

1044 
ä
.
»£t_¡»am
.
fš®_off£t
 = 100;

1046 
pk’
 =

1047 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 890, &
ä
);

1049 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 2);

1051 
	`CU_ASSERT
(0 =ğ
rv
);

1052 
	`CU_ASSERT
(
NULL
 !ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
));

1054 
ä
.
ty³
 = 
NGTCP2_FRAME_ACK
;

1055 
ä
.
ack
.
Ïrge¡_ack
 = 
cÚn
->
pkŠs
.
Ï¡_tx_pkt_num
;

1056 
ä
.
ack
.
ack_d–ay
 = 0;

1057 
ä
.
ack
.
fœ¡_ack_blkËn
 = 0;

1058 
ä
.
ack
.
num_blks
 = 0;

1060 
pk’
 =

1061 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 899, &
ä
);

1062 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 2);

1064 
	`CU_ASSERT
(0 =ğ
rv
);

1065 
	`CU_ASSERT
(
NULL
 =ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
));

1067 
	`ngtı2_cÚn_d–
(
cÚn
);

1070 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

1072 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

1074 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

1075 
ä
.
¡»am
.
¡»am_id
 = stream_id;

1076 
ä
.
¡»am
.
fš
 = 0;

1077 
ä
.
¡»am
.
off£t
 = 0;

1078 
ä
.
¡»am
.
d©aút
 = 0;

1080 
pk’
 =

1081 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 119, &
ä
);

1083 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1085 
	`CU_ASSERT
(0 =ğ
rv
);

1086 
	`CU_ASSERT
(
NULL
 !ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
));

1088 
rv
 = 
	`ngtı2_cÚn_shutdown_¡»am_wr™e
(
cÚn
, 
¡»am_id
, 
NGTCP2_APP_ERR01
);

1090 
	`CU_ASSERT
(0 =ğ
rv
);

1091 
	`CU_ASSERT
(
NULL
 !ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
));

1093 
¥k’
 = 
	`ngtı2_cÚn_wr™e_pkt
(
cÚn
, 
NULL
, 
buf
, (buf), 2);

1095 
	`CU_ASSERT
(
¥k’
 > 0);

1098 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

1099 
ä
.
¡»am
.
fš
 = 1;

1100 
ä
.
¡»am
.
off£t
 = 0;

1101 
ä
.
¡»am
.
d©aút
 = 0;

1103 
pk’
 =

1104 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 121, &
ä
);

1105 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 2);

1107 
	`CU_ASSERT
(0 =ğ
rv
);

1108 
	`CU_ASSERT
(
NULL
 !ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
));

1110 
ä
.
ty³
 = 
NGTCP2_FRAME_ACK
;

1111 
ä
.
ack
.
Ïrge¡_ack
 = 
cÚn
->
pkŠs
.
Ï¡_tx_pkt_num
;

1112 
ä
.
ack
.
ack_d–ay
 = 0;

1113 
ä
.
ack
.
fœ¡_ack_blkËn
 = 0;

1114 
ä
.
ack
.
num_blks
 = 0;

1116 
pk’
 =

1117 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 332, &
ä
);

1119 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 3);

1121 
	`CU_ASSERT
(0 =ğ
rv
);

1122 
	`CU_ASSERT
(
NULL
 =ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
));

1124 
	`ngtı2_cÚn_d–
(
cÚn
);

1125 
	}
}

1127 
	$‹¡_ngtı2_cÚn_»cv_»£t_¡»am
() {

1128 
ngtı2_cÚn
 *
cÚn
;

1129 
rv
;

1130 
ušt8_t
 
buf
[2048];

1131 
ngtı2_äame
 
ä
;

1132 
size_t
 
pk’
;

1133 
ssize_t
 
¥k’
;

1134 
ngtı2_¡rm
 *
¡rm
;

1135 
ušt64_t
 
¡»am_id
;

1138 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1140 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

1141 
ä
.
¡»am
.
æags
 = 0;

1142 
ä
.
¡»am
.
¡»am_id
 = 4;

1143 
ä
.
¡»am
.
fš
 = 0;

1144 
ä
.
¡»am
.
off£t
 = 0;

1145 
ä
.
¡»am
.
d©aút
 = 1;

1146 
ä
.
¡»am
.
d©a
[0].
Ën
 = 955;

1147 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

1149 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

1150 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1152 
	`CU_ASSERT
(0 =ğ
rv
);

1154 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), NULL, 4, 0, 
nuÎ_d©a
,

1157 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

1158 
ä
.
»£t_¡»am
.
¡»am_id
 = 4;

1159 
ä
.
»£t_¡»am
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR02
;

1160 
ä
.
»£t_¡»am
.
fš®_off£t
 = 955;

1162 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 2, &
ä
);

1163 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 3);

1165 
	`CU_ASSERT
(0 =ğ
rv
);

1167 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4);

1169 
	`CU_ASSERT
(
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_SHUT_RD
);

1170 
	`CU_ASSERT
(
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_RECV_RST
);

1172 
	`ngtı2_cÚn_d–
(
cÚn
);

1175 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1177 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

1178 
ä
.
¡»am
.
æags
 = 0;

1179 
ä
.
¡»am
.
¡»am_id
 = 4;

1180 
ä
.
¡»am
.
fš
 = 0;

1181 
ä
.
¡»am
.
off£t
 = 0;

1182 
ä
.
¡»am
.
d©aút
 = 1;

1183 
ä
.
¡»am
.
d©a
[0].
Ën
 = 955;

1184 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

1186 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

1187 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1189 
	`CU_ASSERT
(0 =ğ
rv
);

1191 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), NULL, 4, 0, 
nuÎ_d©a
,

1193 
	`ngtı2_cÚn_shutdown_¡»am_»ad
(
cÚn
, 4, 
NGTCP2_APP_ERR01
);

1194 
	`ngtı2_cÚn_wr™e_pkt
(
cÚn
, 
NULL
, 
buf
, (buf), 3);

1196 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

1197 
ä
.
»£t_¡»am
.
¡»am_id
 = 4;

1198 
ä
.
»£t_¡»am
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR02
;

1199 
ä
.
»£t_¡»am
.
fš®_off£t
 = 955;

1201 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 2, &
ä
);

1202 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 4);

1204 
	`CU_ASSERT
(0 =ğ
rv
);

1205 
	`CU_ASSERT
(
NULL
 !ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4));

1207 
	`ngtı2_cÚn_d–
(
cÚn
);

1210 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1212 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

1213 
ä
.
¡»am
.
æags
 = 0;

1214 
ä
.
¡»am
.
¡»am_id
 = 4;

1215 
ä
.
¡»am
.
fš
 = 0;

1216 
ä
.
¡»am
.
off£t
 = 0;

1217 
ä
.
¡»am
.
d©aút
 = 1;

1218 
ä
.
¡»am
.
d©a
[0].
Ën
 = 955;

1219 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

1221 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

1222 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1224 
	`CU_ASSERT
(0 =ğ
rv
);

1226 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), NULL, 4, 0, 
nuÎ_d©a
,

1228 
	`ngtı2_cÚn_shutdown_¡»am_wr™e
(
cÚn
, 4, 
NGTCP2_APP_ERR01
);

1229 
	`ngtı2_cÚn_wr™e_pkt
(
cÚn
, 
NULL
, 
buf
, (buf), 3);

1231 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

1232 
ä
.
»£t_¡»am
.
¡»am_id
 = 4;

1233 
ä
.
»£t_¡»am
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR02
;

1234 
ä
.
»£t_¡»am
.
fš®_off£t
 = 955;

1236 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 2, &
ä
);

1237 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 4);

1239 
	`CU_ASSERT
(0 =ğ
rv
);

1240 
	`CU_ASSERT
(
NULL
 !ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4));

1242 
ä
.
ty³
 = 
NGTCP2_FRAME_ACK
;

1243 
ä
.
ack
.
Ïrge¡_ack
 = 
cÚn
->
pkŠs
.
Ï¡_tx_pkt_num
;

1244 
ä
.
ack
.
ack_d–ay
 = 0;

1245 
ä
.
ack
.
fœ¡_ack_blkËn
 = 0;

1246 
ä
.
ack
.
num_blks
 = 0;

1248 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 3, &
ä
);

1249 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 5);

1251 
	`CU_ASSERT
(0 =ğ
rv
);

1252 
	`CU_ASSERT
(
NULL
 =ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4));

1254 
	`ngtı2_cÚn_d–
(
cÚn
);

1257 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1259 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

1260 
ä
.
¡»am
.
æags
 = 0;

1261 
ä
.
¡»am
.
¡»am_id
 = 4;

1262 
ä
.
¡»am
.
fš
 = 0;

1263 
ä
.
¡»am
.
off£t
 = 0;

1264 
ä
.
¡»am
.
d©aút
 = 1;

1265 
ä
.
¡»am
.
d©a
[0].
Ën
 = 955;

1266 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

1268 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

1269 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1271 
	`CU_ASSERT
(0 =ğ
rv
);

1273 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), NULL, 4, 0, 
nuÎ_d©a
,

1276 
ä
.
ty³
 = 
NGTCP2_FRAME_STOP_SENDING
;

1277 
ä
.
¡İ_£ndšg
.
¡»am_id
 = 4;

1278 
ä
.
¡İ_£ndšg
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR01
;

1280 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 2, &
ä
);

1281 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 3);

1283 
	`CU_ASSERT
(0 =ğ
rv
);

1284 
	`CU_ASSERT
(
NULL
 !ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4));

1286 
¥k’
 = 
	`ngtı2_cÚn_wr™e_pkt
(
cÚn
, 
NULL
, 
buf
, (buf), 4);

1288 
	`CU_ASSERT
(
¥k’
 > 0);

1290 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

1291 
ä
.
»£t_¡»am
.
¡»am_id
 = 4;

1292 
ä
.
»£t_¡»am
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR02
;

1293 
ä
.
»£t_¡»am
.
fš®_off£t
 = 955;

1295 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 3, &
ä
);

1296 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 4);

1298 
	`CU_ASSERT
(0 =ğ
rv
);

1299 
	`CU_ASSERT
(
NULL
 !ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4));

1301 
ä
.
ty³
 = 
NGTCP2_FRAME_ACK
;

1302 
ä
.
ack
.
Ïrge¡_ack
 = 
cÚn
->
pkŠs
.
Ï¡_tx_pkt_num
;

1303 
ä
.
ack
.
ack_d–ay
 = 0;

1304 
ä
.
ack
.
fœ¡_ack_blkËn
 = 0;

1305 
ä
.
ack
.
num_blks
 = 0;

1307 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 4, &
ä
);

1308 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 5);

1310 
	`CU_ASSERT
(0 =ğ
rv
);

1311 
	`CU_ASSERT
(
NULL
 =ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4));

1313 
	`ngtı2_cÚn_d–
(
cÚn
);

1316 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1318 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

1319 
ä
.
¡»am
.
æags
 = 0;

1320 
ä
.
¡»am
.
¡»am_id
 = 4;

1321 
ä
.
¡»am
.
fš
 = 0;

1322 
ä
.
¡»am
.
off£t
 = 0;

1323 
ä
.
¡»am
.
d©aút
 = 1;

1324 
ä
.
¡»am
.
d©a
[0].
Ën
 = 955;

1325 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

1327 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

1328 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1330 
	`CU_ASSERT
(0 =ğ
rv
);

1332 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

1333 
ä
.
»£t_¡»am
.
¡»am_id
 = 4;

1334 
ä
.
»£t_¡»am
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR02
;

1335 
ä
.
»£t_¡»am
.
fš®_off£t
 = 954;

1337 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 2, &
ä
);

1338 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 2);

1340 
	`CU_ASSERT
(
NGTCP2_ERR_FINAL_OFFSET
 =ğ
rv
);

1342 
	`ngtı2_cÚn_d–
(
cÚn
);

1346 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1348 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

1349 
ä
.
¡»am
.
æags
 = 0;

1350 
ä
.
¡»am
.
¡»am_id
 = 4;

1351 
ä
.
¡»am
.
fš
 = 1;

1352 
ä
.
¡»am
.
off£t
 = 0;

1353 
ä
.
¡»am
.
d©aút
 = 1;

1354 
ä
.
¡»am
.
d©a
[0].
Ën
 = 955;

1355 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

1357 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

1358 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1360 
	`CU_ASSERT
(0 =ğ
rv
);

1362 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

1363 
ä
.
»£t_¡»am
.
¡»am_id
 = 4;

1364 
ä
.
»£t_¡»am
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR02
;

1365 
ä
.
»£t_¡»am
.
fš®_off£t
 = 956;

1367 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 2, &
ä
);

1368 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 2);

1370 
	`CU_ASSERT
(
NGTCP2_ERR_FINAL_OFFSET
 =ğ
rv
);

1372 
	`ngtı2_cÚn_d–
(
cÚn
);

1375 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1377 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

1378 
ä
.
»£t_¡»am
.
¡»am_id
 = 1;

1379 
ä
.
»£t_¡»am
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR01
;

1380 
ä
.
»£t_¡»am
.
fš®_off£t
 = 0;

1382 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

1383 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1385 
	`CU_ASSERT
(
NGTCP2_ERR_STREAM_STATE
 =ğ
rv
);

1387 
	`ngtı2_cÚn_d–
(
cÚn
);

1390 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1392 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

1393 
ä
.
»£t_¡»am
.
¡»am_id
 = 0;

1394 
ä
.
»£t_¡»am
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR01
;

1395 
ä
.
»£t_¡»am
.
fš®_off£t
 = 1999;

1397 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

1398 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1400 
	`CU_ASSERT
(0 =ğ
rv
);

1401 
	`CU_ASSERT
(
NULL
 =ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 0));

1402 
	`CU_ASSERT
(12 =ğ
cÚn
->
un£Á_max_»mÙe_¡»am_id_bidi
);

1404 
	`ngtı2_cÚn_d–
(
cÚn
);

1408 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1410 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

1411 
ä
.
»£t_¡»am
.
¡»am_id
 = 16;

1412 
ä
.
»£t_¡»am
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR01
;

1413 
ä
.
»£t_¡»am
.
fš®_off£t
 = 0;

1415 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

1416 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1418 
	`CU_ASSERT
(
NGTCP2_ERR_STREAM_LIMIT
 =ğ
rv
);

1420 
	`ngtı2_cÚn_d–
(
cÚn
);

1424 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1426 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

1427 
ä
.
»£t_¡»am
.
¡»am_id
 = 4;

1428 
ä
.
»£t_¡»am
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR01
;

1429 
ä
.
»£t_¡»am
.
fš®_off£t
 = 0;

1431 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

1432 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1434 
	`CU_ASSERT
(0 =ğ
rv
);

1435 
	`CU_ASSERT
(

1436 
	`ngtı2_idŒ_is_İ’
(&
cÚn
->
»mÙe_bidi_idŒ
, 
ä
.
»£t_¡»am
.
¡»am_id
));

1438 
	`ngtı2_cÚn_d–
(
cÚn
);

1443 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1445 
cÚn
->
loÿl_£‰šgs
.
max_¡»am_d©a_bidi_»mÙe
 = 1 << 21;

1447 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

1448 
ä
.
»£t_¡»am
.
¡»am_id
 = 4;

1449 
ä
.
»£t_¡»am
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR01
;

1450 
ä
.
»£t_¡»am
.
fš®_off£t
 = 1 << 20;

1452 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

1453 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1455 
	`CU_ASSERT
(
NGTCP2_ERR_FLOW_CONTROL
 =ğ
rv
);

1457 
	`ngtı2_cÚn_d–
(
cÚn
);

1462 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1464 
cÚn
->
max_rx_off£t
 = 1 << 21;

1466 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

1467 
ä
.
»£t_¡»am
.
¡»am_id
 = 4;

1468 
ä
.
»£t_¡»am
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR01
;

1469 
ä
.
»£t_¡»am
.
fš®_off£t
 = 1 << 20;

1471 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

1472 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1474 
	`CU_ASSERT
(
NGTCP2_ERR_FLOW_CONTROL
 =ğ
rv
);

1476 
	`ngtı2_cÚn_d–
(
cÚn
);

1480 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1482 
cÚn
->
loÿl_£‰šgs
.
max_¡»am_d©a_bidi_»mÙe
 = 1 << 21;

1484 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

1485 
ä
.
¡»am
.
æags
 = 0;

1486 
ä
.
¡»am
.
¡»am_id
 = 4;

1487 
ä
.
¡»am
.
fš
 = 0;

1488 
ä
.
¡»am
.
off£t
 = 0;

1489 
ä
.
¡»am
.
d©aút
 = 1;

1490 
ä
.
¡»am
.
d©a
[0].
Ën
 = 955;

1491 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

1493 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

1494 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1496 
	`CU_ASSERT
(0 =ğ
rv
);

1498 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

1499 
ä
.
»£t_¡»am
.
¡»am_id
 = 4;

1500 
ä
.
»£t_¡»am
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR02
;

1501 
ä
.
»£t_¡»am
.
fš®_off£t
 = 1024 * 1024;

1503 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 2, &
ä
);

1504 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 2);

1506 
	`CU_ASSERT
(
NGTCP2_ERR_FLOW_CONTROL
 =ğ
rv
);

1508 
	`ngtı2_cÚn_d–
(
cÚn
);

1512 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1514 
cÚn
->
max_rx_off£t
 = 1 << 21;

1516 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

1517 
ä
.
¡»am
.
æags
 = 0;

1518 
ä
.
¡»am
.
¡»am_id
 = 4;

1519 
ä
.
¡»am
.
fš
 = 0;

1520 
ä
.
¡»am
.
off£t
 = 0;

1521 
ä
.
¡»am
.
d©aút
 = 1;

1522 
ä
.
¡»am
.
d©a
[0].
Ën
 = 955;

1523 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

1525 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

1526 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1528 
	`CU_ASSERT
(0 =ğ
rv
);

1530 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

1531 
ä
.
»£t_¡»am
.
¡»am_id
 = 4;

1532 
ä
.
»£t_¡»am
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR02
;

1533 
ä
.
»£t_¡»am
.
fš®_off£t
 = 1024 * 1024;

1535 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 2, &
ä
);

1536 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 2);

1538 
	`CU_ASSERT
(
NGTCP2_ERR_FLOW_CONTROL
 =ğ
rv
);

1540 
	`ngtı2_cÚn_d–
(
cÚn
);

1544 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1546 
rv
 = 
	`ngtı2_cÚn_İ’_uni_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

1548 
	`CU_ASSERT
(0 =ğ
rv
);

1550 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

1551 
ä
.
»£t_¡»am
.
¡»am_id
 = stream_id;

1552 
ä
.
»£t_¡»am
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR02
;

1553 
ä
.
»£t_¡»am
.
fš®_off£t
 = 0;

1555 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

1556 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1558 
	`CU_ASSERT
(
NGTCP2_ERR_PROTO
 =ğ
rv
);

1560 
	`ngtı2_cÚn_d–
(
cÚn
);

1561 
	}
}

1563 
	$‹¡_ngtı2_cÚn_»cv_¡İ_£ndšg
() {

1564 
ngtı2_cÚn
 *
cÚn
;

1565 
rv
;

1566 
ušt8_t
 
buf
[2048];

1567 
ngtı2_äame
 
ä
;

1568 
size_t
 
pk’
;

1569 
ssize_t
 
¥k’
;

1570 
ngtı2_¡rm
 *
¡rm
;

1571 
ngtı2_t¡amp
 
t
 = 0;

1572 
ušt64_t
 
pkt_num
 = 0;

1573 
ngtı2_äame_chaš
 *
äc
;

1574 
ušt64_t
 
¡»am_id
;

1577 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

1579 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

1580 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), NULL, 
¡»am_id
, 0,

1581 
nuÎ_d©a
, 333, ++
t
);

1583 
ä
.
ty³
 = 
NGTCP2_FRAME_STOP_SENDING
;

1584 
ä
.
¡İ_£ndšg
.
¡»am_id
 = stream_id;

1585 
ä
.
¡İ_£ndšg
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR01
;

1587 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

1588 ++
pkt_num
, &
ä
);

1589 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

1591 
	`CU_ASSERT
(0 =ğ
rv
);

1593 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
);

1595 
	`CU_ASSERT
(
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_SHUT_WR
);

1596 
	`CU_ASSERT
(
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_SENT_RST
);

1598 
äc
 = 
cÚn
->
pkŠs
.
äq
; frc; frøğäc->
Ãxt
) {

1599 ià(
äc
->
ä
.
ty³
 =ğ
NGTCP2_FRAME_RESET_STREAM
) {

1604 
	`CU_ASSERT
(
NULL
 !ğ
äc
);

1605 
	`CU_ASSERT
(
NGTCP2_APP_ERR01
 =ğ
äc
->
ä
.
»£t_¡»am
.
­p_”rÜ_code
);

1606 
	`CU_ASSERT
(333 =ğ
äc
->
ä
.
»£t_¡»am
.
fš®_off£t
);

1608 
	`ngtı2_cÚn_d–
(
cÚn
);

1611 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

1613 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

1614 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), NULL, 
¡»am_id
, 0,

1615 
nuÎ_d©a
, 333, ++
t
);

1617 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

1618 
ä
.
»£t_¡»am
.
¡»am_id
 = stream_id;

1619 
ä
.
»£t_¡»am
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR01
;

1620 
ä
.
»£t_¡»am
.
fš®_off£t
 = 0;

1622 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

1623 ++
pkt_num
, &
ä
);

1624 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

1626 
	`CU_ASSERT
(0 =ğ
rv
);

1628 
ä
.
ty³
 = 
NGTCP2_FRAME_STOP_SENDING
;

1629 
ä
.
¡İ_£ndšg
.
¡»am_id
 = stream_id;

1630 
ä
.
¡İ_£ndšg
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR01
;

1632 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

1633 ++
pkt_num
, &
ä
);

1634 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

1636 
	`CU_ASSERT
(0 =ğ
rv
);

1637 
	`CU_ASSERT
(
NULL
 !ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
));

1639 
äc
 = 
cÚn
->
pkŠs
.
äq
; frc; frøğäc->
Ãxt
) {

1640 ià(
äc
->
ä
.
ty³
 =ğ
NGTCP2_FRAME_RESET_STREAM
) {

1645 
	`CU_ASSERT
(
NULL
 !ğ
äc
);

1646 
	`CU_ASSERT
(
NGTCP2_APP_ERR01
 =ğ
äc
->
ä
.
»£t_¡»am
.
­p_”rÜ_code
);

1647 
	`CU_ASSERT
(333 =ğ
äc
->
ä
.
»£t_¡»am
.
fš®_off£t
);

1649 
¥k’
 = 
	`ngtı2_cÚn_wr™e_pkt
(
cÚn
, 
NULL
, 
buf
, (buf), ++
t
);

1651 
	`CU_ASSERT
(
¥k’
 > 0);

1653 
ä
.
ty³
 = 
NGTCP2_FRAME_ACK
;

1654 
ä
.
ack
.
Ïrge¡_ack
 = 
cÚn
->
pkŠs
.
Ï¡_tx_pkt_num
;

1655 
ä
.
ack
.
ack_d–ay
 = 0;

1656 
ä
.
ack
.
fœ¡_ack_blkËn
 = 0;

1657 
ä
.
ack
.
num_blks
 = 0;

1659 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

1660 ++
pkt_num
, &
ä
);

1661 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

1663 
	`CU_ASSERT
(0 =ğ
rv
);

1664 
	`CU_ASSERT
(
NULL
 =ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
));

1666 
	`ngtı2_cÚn_d–
(
cÚn
);

1670 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1672 
ä
.
ty³
 = 
NGTCP2_FRAME_STOP_SENDING
;

1673 
ä
.
¡İ_£ndšg
.
¡»am_id
 = 0;

1674 
ä
.
¡İ_£ndšg
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR01
;

1676 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

1677 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1679 
	`CU_ASSERT
(0 =ğ
rv
);

1681 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 0);

1683 
	`CU_ASSERT
(
NULL
 !ğ
¡rm
);

1684 
	`CU_ASSERT
(
¡rm
->
æags
 & 
NGTCP2_STRM_FLAG_SHUT_WR
);

1686 
	`ngtı2_cÚn_d–
(
cÚn
);

1690 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1692 
ä
.
ty³
 = 
NGTCP2_FRAME_STOP_SENDING
;

1693 
ä
.
¡İ_£ndšg
.
¡»am_id
 = 1;

1694 
ä
.
¡İ_£ndšg
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR01
;

1696 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

1697 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1699 
	`CU_ASSERT
(
NGTCP2_ERR_STREAM_STATE
 =ğ
rv
);

1701 
	`ngtı2_cÚn_d–
(
cÚn
);

1704 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1706 
rv
 = 
	`ngtı2_cÚn_İ’_uni_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

1708 
	`CU_ASSERT
(0 =ğ
rv
);

1710 
ä
.
ty³
 = 
NGTCP2_FRAME_STOP_SENDING
;

1711 
ä
.
¡İ_£ndšg
.
¡»am_id
 = stream_id;

1712 
ä
.
¡İ_£ndšg
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR01
;

1714 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

1715 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1717 
	`CU_ASSERT
(0 =ğ
rv
);

1718 
	`CU_ASSERT
(
NGTCP2_FRAME_RESET_STREAM
 =ğ
cÚn
->
pkŠs
.
äq
->
ä
.
ty³
);

1720 
	`ngtı2_cÚn_d–
(
cÚn
);

1724 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1726 
ä
.
ty³
 = 
NGTCP2_FRAME_STOP_SENDING
;

1727 
ä
.
¡İ_£ndšg
.
¡»am_id
 = 3;

1728 
ä
.
¡İ_£ndšg
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR01
;

1730 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

1731 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1733 
	`CU_ASSERT
(
NGTCP2_ERR_STREAM_STATE
 =ğ
rv
);

1735 
	`ngtı2_cÚn_d–
(
cÚn
);

1736 
	}
}

1738 
	$‹¡_ngtı2_cÚn_»cv_cÚn_id_om™‹d
() {

1739 
ngtı2_cÚn
 *
cÚn
;

1740 
rv
;

1741 
ušt8_t
 
buf
[2048];

1742 
ngtı2_äame
 
ä
;

1743 
size_t
 
pk’
;

1744 
ngtı2_k¦_™
 
™
;

1745 
ngtı2_scid
 *
scid
;

1747 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

1748 
ä
.
¡»am
.
æags
 = 0;

1749 
ä
.
¡»am
.
¡»am_id
 = 4;

1750 
ä
.
¡»am
.
fš
 = 0;

1751 
ä
.
¡»am
.
off£t
 = 0;

1752 
ä
.
¡»am
.
d©aút
 = 1;

1753 
ä
.
¡»am
.
d©a
[0].
Ën
 = 100;

1754 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

1758 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1760 
pk’
 =

1761 
	`wr™e_sšgË_äame_pkt_w™hout_cÚn_id
(
cÚn
, 
buf
, (buf), 1, &
ä
);

1762 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1765 
	`CU_ASSERT
(0 =ğ
rv
);

1766 
	`CU_ASSERT
(
NULL
 =ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4));

1768 
	`ngtı2_cÚn_d–
(
cÚn
);

1771 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1772 
	`ngtı2_cid_z”o
(&
cÚn
->
oscid
);

1774 
™
 = 
	`ngtı2_k¦_begš
(&
cÚn
->
scids
);

1775 
scid
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

1776 
	`ngtı2_cid_z”o
(&
scid
->
cid
);

1778 
pk’
 =

1779 
	`wr™e_sšgË_äame_pkt_w™hout_cÚn_id
(
cÚn
, 
buf
, (buf), 1, &
ä
);

1780 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

1782 
	`CU_ASSERT
(0 =ğ
rv
);

1783 
	`CU_ASSERT
(
NULL
 !ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4));

1785 
	`ngtı2_cÚn_d–
(
cÚn
);

1786 
	}
}

1788 
	$‹¡_ngtı2_cÚn_shÜt_pkt_ty³
() {

1789 
ngtı2_cÚn
 *
cÚn
;

1790 
ngtı2_pkt_hd
 
hd
;

1791 
ušt8_t
 
buf
[2048];

1792 
ssize_t
 
¥k’
;

1793 
ušt64_t
 
¡»am_id
;

1796 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

1798 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

1799 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), NULL,

1800 
¡»am_id
, 0, 
nuÎ_d©a
, 19, 1);

1802 
	`CU_ASSERT
(
¥k’
 > 0);

1803 
	`CU_ASSERT
(
	`pkt_decode_hd_shÜt_mask
(&
hd
, 
buf
, (
size_t
)
¥k’
,

1804 
cÚn
->
oscid
.
d©®’
) > 0);

1805 
	`CU_ASSERT
(1 =ğ
hd
.
pkt_numËn
);

1807 
	`ngtı2_cÚn_d–
(
cÚn
);

1810 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

1811 
cÚn
->
pkŠs
.
¹b
.
Ïrge¡_acked_tx_pkt_num
 = 0x6afa2f;

1812 
cÚn
->
pkŠs
.
Ï¡_tx_pkt_num
 = 0x6afd78;

1814 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

1815 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), NULL,

1816 
¡»am_id
, 0, 
nuÎ_d©a
, 19, 1);

1818 
	`CU_ASSERT
(
¥k’
 > 0);

1819 
	`CU_ASSERT
(
	`pkt_decode_hd_shÜt_mask
(&
hd
, 
buf
, (
size_t
)
¥k’
,

1820 
cÚn
->
oscid
.
d©®’
) > 0);

1821 
	`CU_ASSERT
(2 =ğ
hd
.
pkt_numËn
);

1823 
	`ngtı2_cÚn_d–
(
cÚn
);

1826 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

1827 
cÚn
->
pkŠs
.
¹b
.
Ïrge¡_acked_tx_pkt_num
 = 0x6afa2f;

1828 
cÚn
->
pkŠs
.
Ï¡_tx_pkt_num
 = 0x6bc106;

1830 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

1831 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), NULL,

1832 
¡»am_id
, 0, 
nuÎ_d©a
, 19, 1);

1834 
	`CU_ASSERT
(
¥k’
 > 0);

1835 
	`CU_ASSERT
(
	`pkt_decode_hd_shÜt_mask
(&
hd
, 
buf
, (
size_t
)
¥k’
,

1836 
cÚn
->
oscid
.
d©®’
) > 0);

1837 
	`CU_ASSERT
(3 =ğ
hd
.
pkt_numËn
);

1839 
	`ngtı2_cÚn_d–
(
cÚn
);

1842 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

1843 
cÚn
->
pkŠs
.
¹b
.
Ïrge¡_acked_tx_pkt_num
 = 1;

1844 
cÚn
->
pkŠs
.
Ï¡_tx_pkt_num
 = 127;

1846 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

1847 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), NULL,

1848 
¡»am_id
, 0, 
nuÎ_d©a
, 19, 1);

1850 
	`CU_ASSERT
(
¥k’
 > 0);

1851 
	`CU_ASSERT
(
	`pkt_decode_hd_shÜt_mask
(&
hd
, 
buf
, (
size_t
)
¥k’
,

1852 
cÚn
->
oscid
.
d©®’
) > 0);

1853 
	`CU_ASSERT
(1 =ğ
hd
.
pkt_numËn
);

1855 
	`ngtı2_cÚn_d–
(
cÚn
);

1858 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

1859 
cÚn
->
pkŠs
.
¹b
.
Ïrge¡_acked_tx_pkt_num
 = 1;

1860 
cÚn
->
pkŠs
.
Ï¡_tx_pkt_num
 = 128;

1862 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

1863 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), NULL,

1864 
¡»am_id
, 0, 
nuÎ_d©a
, 19, 1);

1866 
	`CU_ASSERT
(
¥k’
 > 0);

1867 
	`CU_ASSERT
(
	`pkt_decode_hd_shÜt_mask
(&
hd
, 
buf
, (
size_t
)
¥k’
,

1868 
cÚn
->
oscid
.
d©®’
) > 0);

1869 
	`CU_ASSERT
(2 =ğ
hd
.
pkt_numËn
);

1871 
	`ngtı2_cÚn_d–
(
cÚn
);

1874 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

1875 
cÚn
->
pkŠs
.
¹b
.
Ïrge¡_acked_tx_pkt_num
 = 1;

1876 
cÚn
->
pkŠs
.
Ï¡_tx_pkt_num
 = 32767;

1878 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

1879 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), NULL,

1880 
¡»am_id
, 0, 
nuÎ_d©a
, 19, 1);

1882 
	`CU_ASSERT
(
¥k’
 > 0);

1883 
	`CU_ASSERT
(

1884 
	`pkt_decode_hd_shÜt
(&
hd
, 
buf
, (
size_t
)
¥k’
, 
cÚn
->
oscid
.
d©®’
) > 0);

1885 
	`CU_ASSERT
(2 =ğ
hd
.
pkt_numËn
);

1887 
	`ngtı2_cÚn_d–
(
cÚn
);

1890 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

1891 
cÚn
->
pkŠs
.
¹b
.
Ïrge¡_acked_tx_pkt_num
 = 1;

1892 
cÚn
->
pkŠs
.
Ï¡_tx_pkt_num
 = 32768;

1894 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

1895 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), NULL,

1896 
¡»am_id
, 0, 
nuÎ_d©a
, 19, 1);

1898 
	`CU_ASSERT
(
¥k’
 > 0);

1899 
	`CU_ASSERT
(

1900 
	`pkt_decode_hd_shÜt
(&
hd
, 
buf
, (
size_t
)
¥k’
, 
cÚn
->
oscid
.
d©®’
) > 0);

1901 
	`CU_ASSERT
(3 =ğ
hd
.
pkt_numËn
);

1903 
	`ngtı2_cÚn_d–
(
cÚn
);

1906 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

1907 
cÚn
->
pkŠs
.
¹b
.
Ïrge¡_acked_tx_pkt_num
 = 1;

1908 
cÚn
->
pkŠs
.
Ï¡_tx_pkt_num
 = 8388607;

1910 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

1911 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), NULL,

1912 
¡»am_id
, 0, 
nuÎ_d©a
, 19, 1);

1914 
	`CU_ASSERT
(
¥k’
 > 0);

1915 
	`CU_ASSERT
(

1916 
	`pkt_decode_hd_shÜt
(&
hd
, 
buf
, (
size_t
)
¥k’
, 
cÚn
->
oscid
.
d©®’
) > 0);

1917 
	`CU_ASSERT
(3 =ğ
hd
.
pkt_numËn
);

1919 
	`ngtı2_cÚn_d–
(
cÚn
);

1922 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

1923 
cÚn
->
pkŠs
.
¹b
.
Ïrge¡_acked_tx_pkt_num
 = 1;

1924 
cÚn
->
pkŠs
.
Ï¡_tx_pkt_num
 = 8388608;

1926 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

1927 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), NULL,

1928 
¡»am_id
, 0, 
nuÎ_d©a
, 19, 1);

1930 
	`CU_ASSERT
(
¥k’
 > 0);

1931 
	`CU_ASSERT
(

1932 
	`pkt_decode_hd_shÜt
(&
hd
, 
buf
, (
size_t
)
¥k’
, 
cÚn
->
oscid
.
d©®’
) > 0);

1933 
	`CU_ASSERT
(4 =ğ
hd
.
pkt_numËn
);

1935 
	`ngtı2_cÚn_d–
(
cÚn
);

1938 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

1939 
cÚn
->
pkŠs
.
¹b
.
Ïrge¡_acked_tx_pkt_num
 = 1;

1940 
cÚn
->
pkŠs
.
Ï¡_tx_pkt_num
 = 
NGTCP2_MAX_PKT_NUM
 - 1;

1942 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

1943 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), NULL,

1944 
¡»am_id
, 0, 
nuÎ_d©a
, 19, 1);

1946 
	`CU_ASSERT
(
¥k’
 > 0);

1947 
	`CU_ASSERT
(

1948 
	`pkt_decode_hd_shÜt
(&
hd
, 
buf
, (
size_t
)
¥k’
, 
cÚn
->
oscid
.
d©®’
) > 0);

1949 
	`CU_ASSERT
(4 =ğ
hd
.
pkt_numËn
);

1951 
	`ngtı2_cÚn_d–
(
cÚn
);

1952 
	}
}

1954 
	$‹¡_ngtı2_cÚn_»cv_¡©–ess_»£t
() {

1955 
ngtı2_cÚn
 *
cÚn
;

1956 
ušt8_t
 
buf
[256];

1957 
ssize_t
 
¥k’
;

1958 
rv
;

1959 
size_t
 
i
;

1960 
ušt8_t
 
tok’
[
NGTCP2_STATELESS_RESET_TOKENLEN
];

1962 
i
 = 0; i < 
NGTCP2_STATELESS_RESET_TOKENLEN
; ++i) {

1963 
tok’
[
i
] = (
ušt8_t
)~i;

1967 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

1968 
cÚn
->
ÿÎbacks
.
deüy±
 = 
ç_deüy±
;

1969 
cÚn
->
pkŠs
.
max_rx_pkt_num
 = 24324325;

1971 
	`memıy
(
cÚn
->
dcid
.
tok’
,ok’, 
NGTCP2_STATELESS_RESET_TOKENLEN
);

1973 
¥k’
 = 
	`ngtı2_pkt_wr™e_¡©–ess_»£t
(

1974 
buf
, (buf), 
tok’
, 
nuÎ_d©a
, 
NGTCP2_MIN_STATELESS_RESET_RANDLEN
);

1976 
	`CU_ASSERT
(
¥k’
 > 0);

1978 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, (
size_t
)
¥k’
, 1);

1980 
	`CU_ASSERT
(
NGTCP2_ERR_DRAINING
 =ğ
rv
);

1981 
	`CU_ASSERT
(
NGTCP2_CS_DRAINING
 =ğ
cÚn
->
¡©e
);

1983 
	`ngtı2_cÚn_d–
(
cÚn
);

1986 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

1987 
cÚn
->
ÿÎbacks
.
deüy±
 = 
ç_deüy±
;

1988 
cÚn
->
pkŠs
.
max_rx_pkt_num
 = 3255454;

1990 
	`memıy
(
cÚn
->
dcid
.
tok’
,ok’, 
NGTCP2_STATELESS_RESET_TOKENLEN
);

1992 
¥k’
 =

1993 
	`ngtı2_pkt_wr™e_¡©–ess_»£t
(
buf
, (buf), 
tok’
, 
nuÎ_d©a
, 29);

1995 
	`CU_ASSERT
(
¥k’
 > 0);

1997 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, (
size_t
)
¥k’
, 1);

1999 
	`CU_ASSERT
(
NGTCP2_ERR_DRAINING
 =ğ
rv
);

2000 
	`CU_ASSERT
(
NGTCP2_CS_DRAINING
 =ğ
cÚn
->
¡©e
);

2002 
	`ngtı2_cÚn_d–
(
cÚn
);

2005 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

2006 
cÚn
->
ÿÎbacks
.
deüy±
 = 
ç_deüy±
;

2007 
cÚn
->
pkŠs
.
max_rx_pkt_num
 = 24324325;

2009 
¥k’
 =

2010 
	`ngtı2_pkt_wr™e_¡©–ess_»£t
(
buf
, (buf), 
tok’
, 
nuÎ_d©a
, 29);

2012 
	`CU_ASSERT
(
¥k’
 > 0);

2014 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, (
size_t
)
¥k’
, 1);

2016 
	`CU_ASSERT
(0 =ğ
rv
);

2017 
	`CU_ASSERT
(
NGTCP2_CS_DRAINING
 !ğ
cÚn
->
¡©e
);

2019 
	`ngtı2_cÚn_d–
(
cÚn
);

2020 
	}
}

2022 
	$‹¡_ngtı2_cÚn_»cv_»Œy
() {

2023 
ngtı2_cÚn
 *
cÚn
;

2024 
ušt8_t
 
buf
[2048];

2025 
ssize_t
 
¥k’
;

2026 
ngtı2_pkt_hd
 
hd
;

2027 
ušt64_t
 
t
 = 0;

2028 
ngtı2_cid
 
dcid
;

2029 cÚ¡ 
ušt8_t
 
tok’
[] = "address-validation-token";

2030 
size_t
 
i
;

2031 
ušt64_t
 
¡»am_id
;

2032 
ssize_t
 
d©®’
;

2033 
rv
;

2034 
ngtı2_vec
 
d©av
;

2035 
ngtı2_¡rm
 *
¡rm
;

2037 
	`dcid_š™
(&
dcid
);

2038 
	`£tup_hªdshake_ş›Á
(&
cÚn
);

2039 
cÚn
->
ÿÎbacks
.
»cv_»Œy
 =„ecv_retry;

2041 
¥k’
 = 
	`ngtı2_cÚn_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), ++
t
);

2043 
	`CU_ASSERT
(
¥k’
 > 0);

2045 
i
 = 0; i < 1; ++i) {

2046 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_LONG_FORM
, 
NGTCP2_PKT_RETRY
,

2047 &
cÚn
->
oscid
, &
dcid
, 0, 0, cÚn->
v”siÚ
, 0);

2049 
¥k’
 = 
	`ngtı2_pkt_wr™e_»Œy
(
buf
, (buf), &
hd
,

2050 
	`ngtı2_cÚn_g‘_dcid
(
cÚn
), 
tok’
,

2051 
	`¡rsize
(
tok’
));

2053 
	`CU_ASSERT
(
¥k’
 > 0);

2055 
rv
 = 
	`ngtı2_cÚn_»ad_hªdshake
(
cÚn
, 
buf
, (
size_t
)
¥k’
, ++
t
);

2057 
	`CU_ASSERT
(0 =ğ
rv
);

2059 
¥k’
 = 
	`ngtı2_cÚn_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), ++
t
);

2061 ià(
i
 == 1) {

2063 
	`CU_ASSERT
(
¥k’
 == 0);

2065 
	`CU_ASSERT
(
¥k’
 > 0);

2066 
	`CU_ASSERT
(1 =ğ
cÚn
->
š_pkŠs
.
Ï¡_tx_pkt_num
);

2067 
	`CU_ASSERT
(
	`ngtı2_cid_eq
(&
dcid
, 
	`ngtı2_cÚn_g‘_dcid
(
cÚn
)));

2068 
	`CU_ASSERT
(
cÚn
->
æags
 & 
NGTCP2_CONN_FLAG_RECV_RETRY
);

2072 
	`ngtı2_cÚn_d–
(
cÚn
);

2075 
	`£tup_hªdshake_ş›Á
(&
cÚn
);

2076 
cÚn
->
ÿÎbacks
.
»cv_»Œy
 =„ecv_retry;

2078 
¥k’
 = 
	`ngtı2_cÚn_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), ++
t
);

2080 
	`CU_ASSERT
(
¥k’
 > 0);

2082 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_LONG_FORM
, 
NGTCP2_PKT_RETRY
,

2083 &
cÚn
->
oscid
, &
dcid
, 0, 0, cÚn->
v”siÚ
, 0);

2085 
¥k’
 = 
	`ngtı2_pkt_wr™e_»Œy
(
buf
, (buf), &
hd
, &
dcid
, 
tok’
,

2086 
	`¡rsize
(
tok’
));

2088 
	`CU_ASSERT
(
¥k’
 > 0);

2090 
rv
 = 
	`ngtı2_cÚn_»ad_hªdshake
(
cÚn
, 
buf
, (
size_t
)
¥k’
, ++
t
);

2092 
	`CU_ASSERT
(0 =ğ
rv
);

2094 
¥k’
 = 
	`ngtı2_cÚn_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), ++
t
);

2096 
	`CU_ASSERT
(0 =ğ
¥k’
);

2098 
	`ngtı2_cÚn_d–
(
cÚn
);

2101 
	`£tup_—¾y_ş›Á
(&
cÚn
);

2102 
cÚn
->
ÿÎbacks
.
»cv_»Œy
 =„ecv_retry;

2104 
rv
 = 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

2106 
	`CU_ASSERT
(0 =ğ
rv
);

2108 
¥k’
 = 
	`ngtı2_cÚn_ş›Á_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), &
d©®’
,

2109 
¡»am_id
, 0,

2110 
	`nuÎ_d©av
(&
d©av
, 219), 1, ++
t
);

2112 
	`CU_ASSERT
((
buf
è=ğ
¥k’
);

2113 
	`CU_ASSERT
(219 =ğ
d©®’
);

2115 
¥k’
 =

2116 
	`ngtı2_cÚn_wr™ev_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), &
d©®’
,

2117 
¡»am_id
, 0, 
	`nuÎ_d©av
(&
d©av
, 119), 1, ++
t
);

2119 
	`CU_ASSERT
(
¥k’
 > 0);

2120 
	`CU_ASSERT
(119 =ğ
d©®’
);

2122 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_LONG_FORM
, 
NGTCP2_PKT_RETRY
,

2123 &
cÚn
->
oscid
, &
dcid
, 0, 0, cÚn->
v”siÚ
, 0);

2125 
¥k’
 = 
	`ngtı2_pkt_wr™e_»Œy
(

2126 
buf
, (buf), &
hd
, 
	`ngtı2_cÚn_g‘_dcid
(
cÚn
), 
tok’
, 
	`¡rsize
(token));

2128 
	`CU_ASSERT
(
¥k’
 > 0);

2130 
rv
 = 
	`ngtı2_cÚn_»ad_hªdshake
(
cÚn
, 
buf
, (
size_t
)
¥k’
, ++
t
);

2132 
	`CU_ASSERT
(0 =ğ
rv
);

2134 
¥k’
 = 
	`ngtı2_cÚn_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), ++
t
);

2136 
	`CU_ASSERT
(
¥k’
 > 219 + 119);

2137 
	`CU_ASSERT
(2 =ğ
cÚn
->
pkŠs
.
Ï¡_tx_pkt_num
);

2139 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 
¡»am_id
);

2141 
	`CU_ASSERT
(
	`ngtı2_pq_em±y
(&
¡rm
->
¡»amäq
));

2144 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), &
d©®’
,

2145 
¡»am_id
, 0, 
nuÎ_d©a
, 120, ++
t
);

2147 
	`CU_ASSERT
(
¥k’
 > 0);

2148 
	`CU_ASSERT
(3 =ğ
cÚn
->
pkŠs
.
Ï¡_tx_pkt_num
);

2149 
	`CU_ASSERT
(120 =ğ
d©®’
);

2150 
	`CU_ASSERT
(
NULL
 =ğ
cÚn
->
pkŠs
.
äq
);

2151 
	`CU_ASSERT
(!
	`ngtı2_¹b_em±y
(&
cÚn
->
pkŠs
.
¹b
));

2153 
	`ngtı2_cÚn_d–
(
cÚn
);

2154 
	}
}

2156 
	$‹¡_ngtı2_cÚn_»cv_d–ayed_hªdshake_pkt
() {

2157 
ngtı2_cÚn
 *
cÚn
;

2158 
ušt8_t
 
buf
[2048];

2159 
size_t
 
pk’
;

2160 
ngtı2_äame
 
ä
;

2161 
rv
;

2164 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

2166 
ä
.
ty³
 = 
NGTCP2_FRAME_CRYPTO
;

2167 
ä
.
üy±o
.
off£t
 = 0;

2168 
ä
.
üy±o
.
d©aút
 = 1;

2169 
ä
.
üy±o
.
d©a
[0].
Ën
 = 567;

2170 
ä
.
üy±o
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

2172 
pk’
 = 
	`wr™e_sšgË_äame_hªdshake_pkt
(

2173 
cÚn
, 
buf
, (buf), 
NGTCP2_PKT_HANDSHAKE
, &cÚn->
oscid
,

2174 
	`ngtı2_cÚn_g‘_dcid
(
cÚn
), 1, 
NGTCP2_PROTO_VER_MAX
, &
ä
);

2175 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

2177 
	`CU_ASSERT
(0 =ğ
rv
);

2178 
	`CU_ASSERT
(1 =ğ
	`ngtı2_k¦_Ën
(&
cÚn
->
hs_pkŠs
.
ackŒ
.
’ts
));

2179 
	`CU_ASSERT
(
cÚn
->
hs_pkŠs
.
ackŒ
.
æags
 & 
NGTCP2_ACKTR_FLAG_ACTIVE_ACK
);

2181 
	`ngtı2_cÚn_d–
(
cÚn
);

2209 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

2211 
ä
.
ty³
 = 
NGTCP2_FRAME_ACK
;

2212 
ä
.
ack
.
Ïrge¡_ack
 = 1000000007;

2213 
ä
.
ack
.
ack_d–ay
 = 122;

2214 
ä
.
ack
.
fœ¡_ack_blkËn
 = 0;

2215 
ä
.
ack
.
num_blks
 = 0;

2217 
pk’
 = 
	`wr™e_sšgË_äame_hªdshake_pkt
(

2218 
cÚn
, 
buf
, (buf), 
NGTCP2_PKT_HANDSHAKE
, &cÚn->
oscid
,

2219 
	`ngtı2_cÚn_g‘_dcid
(
cÚn
), 0, 
NGTCP2_PROTO_VER_MAX
, &
ä
);

2220 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

2222 
	`CU_ASSERT
(0 =ğ
rv
);

2223 
	`CU_ASSERT
(1 =ğ
	`ngtı2_k¦_Ën
(&
cÚn
->
hs_pkŠs
.
ackŒ
.
’ts
));

2224 
	`CU_ASSERT
(!
cÚn
->
hs_pkŠs
.
ackŒ
.
æags
);

2226 
	`ngtı2_cÚn_d–
(
cÚn
);

2227 
	}
}

2229 
	$‹¡_ngtı2_cÚn_»cv_max_¡»ams
() {

2230 
ngtı2_cÚn
 *
cÚn
;

2231 
ušt8_t
 
buf
[2048];

2232 
size_t
 
pk’
;

2233 
rv
;

2234 
ngtı2_äame
 
ä
;

2236 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

2238 
ä
.
ty³
 = 
NGTCP2_FRAME_MAX_STREAMS_UNI
;

2239 
ä
.
max_¡»ams
.max_streams = 999;

2241 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 1, &
ä
);

2242 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 1);

2244 
	`CU_ASSERT
(0 =ğ
rv
);

2245 
	`CU_ASSERT
(((999 - 1è<< 2è+ 0x02 =ğ
cÚn
->
max_loÿl_¡»am_id_uni
);

2247 
ä
.
ty³
 = 
NGTCP2_FRAME_MAX_STREAMS_BIDI
;

2248 
ä
.
max_¡»ams
.max_streams = 997;

2250 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
, 2, &
ä
);

2251 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, 2);

2253 
	`CU_ASSERT
(0 =ğ
rv
);

2254 
	`CU_ASSERT
(((997 - 1è<< 2è=ğ
cÚn
->
max_loÿl_¡»am_id_bidi
);

2256 
	`ngtı2_cÚn_d–
(
cÚn
);

2257 
	}
}

2259 
	$‹¡_ngtı2_cÚn_hªdshake
() {

2260 
ngtı2_cÚn
 *
cÚn
;

2261 
ušt8_t
 
buf
[2048];

2262 
size_t
 
pk’
;

2263 
ssize_t
 
¥k’
;

2264 
ngtı2_äame
 
ä
;

2265 
ušt64_t
 
pkt_num
 = 12345689, 
t
 = 0;

2266 
ngtı2_cid
 
rcid
;

2267 
rv
;

2269 
	`rcid_š™
(&
rcid
);

2271 
	`£tup_hªdshake_£rv”
(&
cÚn
);

2273 
ä
.
ty³
 = 
NGTCP2_FRAME_CRYPTO
;

2274 
ä
.
üy±o
.
off£t
 = 0;

2275 
ä
.
üy±o
.
d©aút
 = 1;

2276 
ä
.
üy±o
.
d©a
[0].
Ën
 = 45;

2277 
ä
.
üy±o
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

2279 
pk’
 = 
	`wr™e_sšgË_äame_hªdshake_pkt
(

2280 
cÚn
, 
buf
, (buf), 
NGTCP2_PKT_INITIAL
, &
rcid
,

2281 
	`ngtı2_cÚn_g‘_dcid
(
cÚn
), ++
pkt_num
, cÚn->
v”siÚ
, &
ä
);

2283 
rv
 = 
	`ngtı2_cÚn_»ad_hªdshake
(
cÚn
, 
buf
, 
pk’
, ++
t
);

2285 
	`CU_ASSERT
(0 =ğ
rv
);

2287 
¥k’
 = 
	`ngtı2_cÚn_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), ++
t
);

2289 
	`CU_ASSERT
(
¥k’
 > 0);

2291 
	`ngtı2_cÚn_d–
(
cÚn
);

2292 
	}
}

2294 
	$‹¡_ngtı2_cÚn_hªdshake_”rÜ
() {

2295 
ngtı2_cÚn
 *
cÚn
;

2296 
ušt8_t
 
buf
[2048];

2297 
size_t
 
pk’
;

2298 
ssize_t
 
¥k’
;

2299 
ngtı2_äame
 
ä
;

2300 
ušt64_t
 
pkt_num
 = 107, 
t
 = 0;

2301 
ngtı2_cid
 
rcid
;

2302 
rv
;

2304 
	`rcid_š™
(&
rcid
);

2307 
	`£tup_hªdshake_ş›Á
(&
cÚn
);

2308 
cÚn
->
ÿÎbacks
.
»cv_üy±o_d©a
 = 
»cv_üy±o_hªdshake_”rÜ
;

2309 
¥k’
 = 
	`ngtı2_cÚn_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), ++
t
);

2311 
	`CU_ASSERT
(
¥k’
 > 0);

2313 
ä
.
ty³
 = 
NGTCP2_FRAME_CRYPTO
;

2314 
ä
.
üy±o
.
off£t
 = 0;

2315 
ä
.
üy±o
.
d©aút
 = 1;

2316 
ä
.
üy±o
.
d©a
[0].
Ën
 = 333;

2317 
ä
.
üy±o
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

2319 
pk’
 = 
	`wr™e_sšgË_äame_hªdshake_pkt
(

2320 
cÚn
, 
buf
, (buf), 
NGTCP2_PKT_INITIAL
, &cÚn->
oscid
,

2321 
	`ngtı2_cÚn_g‘_dcid
(
cÚn
), ++
pkt_num
, cÚn->
v”siÚ
, &
ä
);

2323 
rv
 = 
	`ngtı2_cÚn_»ad_hªdshake
(
cÚn
, 
buf
, 
pk’
, ++
t
);

2325 
	`CU_ASSERT
(
NGTCP2_ERR_CRYPTO
 =ğ
rv
);

2327 
	`ngtı2_cÚn_d–
(
cÚn
);

2330 
	`£tup_hªdshake_£rv”
(&
cÚn
);

2331 
cÚn
->
ÿÎbacks
.
»cv_üy±o_d©a
 = 
»cv_üy±o_hªdshake_”rÜ
;

2333 
ä
.
ty³
 = 
NGTCP2_FRAME_CRYPTO
;

2334 
ä
.
üy±o
.
off£t
 = 0;

2335 
ä
.
üy±o
.
d©aút
 = 1;

2336 
ä
.
üy±o
.
d©a
[0].
Ën
 = 551;

2337 
ä
.
üy±o
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

2339 
pk’
 = 
	`wr™e_sšgË_äame_hªdshake_pkt
(

2340 
cÚn
, 
buf
, (buf), 
NGTCP2_PKT_INITIAL
, &
rcid
,

2341 
	`ngtı2_cÚn_g‘_dcid
(
cÚn
), ++
pkt_num
, cÚn->
v”siÚ
, &
ä
);

2343 
rv
 = 
	`ngtı2_cÚn_»ad_hªdshake
(
cÚn
, 
buf
, 
pk’
, ++
t
);

2345 
	`CU_ASSERT
(
NGTCP2_ERR_CRYPTO
 =ğ
rv
);

2347 
	`ngtı2_cÚn_d–
(
cÚn
);

2348 
	}
}

2350 
	$‹¡_ngtı2_cÚn_ş›Á_wr™e_hªdshake
() {

2351 
ngtı2_cÚn
 *
cÚn
;

2352 
ušt8_t
 
buf
[1240];

2353 
ssize_t
 
¥k’
;

2354 
ngtı2_t¡amp
 
t
 = 0;

2355 
ušt64_t
 
¡»am_id
;

2356 
rv
;

2357 
ssize_t
 
d©®’
;

2358 
ngtı2_vec
 
d©av
;

2362 
	`£tup_—¾y_ş›Á
(&
cÚn
);

2364 
rv
 = 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

2366 
	`CU_ASSERT
(0 =ğ
rv
);

2368 
¥k’
 = 
	`ngtı2_cÚn_ş›Á_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), &
d©®’
,

2369 
¡»am_id
, 0,

2370 
	`nuÎ_d©av
(&
d©av
, 199), 1, ++
t
);

2372 
	`CU_ASSERT
((
buf
è=ğ
¥k’
);

2373 
	`CU_ASSERT
(199 =ğ
d©®’
);

2375 
	`ngtı2_cÚn_d–
(
cÚn
);

2378 
	`£tup_—¾y_ş›Á
(&
cÚn
);

2380 
rv
 = 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

2382 
	`CU_ASSERT
(0 =ğ
rv
);

2384 
¥k’
 = 
	`ngtı2_cÚn_ş›Á_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), &
d©®’
,

2385 
¡»am_id
, 1, 
NULL
, 0, ++
t
);

2387 
	`CU_ASSERT
((
buf
è=ğ
¥k’
);

2388 
	`CU_ASSERT
(0 =ğ
d©®’
);

2390 
	`ngtı2_cÚn_d–
(
cÚn
);

2393 
	`£tup_—¾y_ş›Á
(&
cÚn
);

2395 
rv
 = 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

2397 
	`CU_ASSERT
(0 =ğ
rv
);

2399 
¥k’
 = 
	`ngtı2_cÚn_ş›Á_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), &
d©®’
,

2400 (
ušt64_t
)-1, 0, 
NULL
, 0, ++
t
);

2402 
	`CU_ASSERT
(
¥k’
 > 0);

2406 
¥k’
 = 
	`ngtı2_cÚn_ş›Á_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), &
d©®’
,

2407 
¡»am_id
, 0, 
NULL
, 0, ++
t
);

2409 
	`CU_ASSERT
(
¥k’
 > 0);

2411 
	`ngtı2_cÚn_d–
(
cÚn
);

2414 
	`£tup_—¾y_ş›Á
(&
cÚn
);

2416 
rv
 = 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

2418 
	`CU_ASSERT
(0 =ğ
rv
);

2420 
¥k’
 = 
	`ngtı2_cÚn_ş›Á_wr™e_hªdshake
(

2421 
cÚn
, 
buf
,

2422 
NGTCP2_MIN_LONG_HEADERLEN
 + 1 + 
	`ngtı2_cÚn_g‘_dcid
(
cÚn
)->
d©®’
 +

2423 
cÚn
->
oscid
.
d©®’
 + 300,

2424 &
d©®’
, 
¡»am_id
, 1, 
NULL
, 0, ++
t
);

2426 
	`CU_ASSERT
(
¥k’
 > 0);

2427 
	`CU_ASSERT
(-1 =ğ
d©®’
);

2429 
	`ngtı2_cÚn_d–
(
cÚn
);

2430 
	}
}

2432 
	$‹¡_ngtı2_cÚn_»Œªsm™_´Ùeùed
() {

2433 
ngtı2_cÚn
 *
cÚn
;

2434 
ušt8_t
 
buf
[2048];

2435 
ssize_t
 
¥k’
;

2436 
ngtı2_t¡amp
 
t
 = 0;

2437 
ušt64_t
 
¡»am_id
, 
¡»am_id_a
, 
¡»am_id_b
;

2438 
ngtı2_k¦_™
 
™
;

2441 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

2443 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

2444 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), NULL,

2445 
¡»am_id
, 0, 
nuÎ_d©a
, 126, ++
t
);

2447 
	`CU_ASSERT
(
¥k’
 > 0);

2450 
t
 +ğ
NGTCP2_SECONDS
;

2452 
cÚn
->
pkŠs
.
¹b
.
Ïrge¡_acked_tx_pkt_num
 = 1000000007;

2453 
™
 = 
	`ngtı2_¹b_h—d
(&
cÚn
->
pkŠs
.
¹b
);

2454 
	`ngtı2_cÚn_d‘eù_lo¡_pkt
(
cÚn
, &cÚn->
pkŠs
, &cÚn->
rcs
, ++
t
);

2455 
¥k’
 = 
	`ngtı2_cÚn_wr™e_pkt
(
cÚn
, 
NULL
, 
buf
, (buf), ++
t
);

2457 
	`CU_ASSERT
(
¥k’
 > 0);

2458 
	`CU_ASSERT
(
NULL
 =ğ
cÚn
->
pkŠs
.
äq
);

2460 
™
 = 
	`ngtı2_¹b_h—d
(&
cÚn
->
pkŠs
.
¹b
);

2462 
	`CU_ASSERT
(!
	`ngtı2_k¦_™_’d
(&
™
));

2464 
	`ngtı2_cÚn_d–
(
cÚn
);

2467 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

2468 
cÚn
->
max_loÿl_¡»am_id_bidi
 = 8;

2470 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id_a
, 
NULL
);

2471 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id_b
, 
NULL
);

2473 
	`ngtı2_cÚn_shutdown_¡»am_wr™e
(
cÚn
, 
¡»am_id_a
, 
NGTCP2_APP_ERR01
);

2474 
	`ngtı2_cÚn_shutdown_¡»am_wr™e
(
cÚn
, 
¡»am_id_b
, 
NGTCP2_APP_ERR01
);

2476 
¥k’
 = 
	`ngtı2_cÚn_wr™e_pkt
(
cÚn
, 
NULL
, 
buf
, (buf), ++
t
);

2478 
	`CU_ASSERT
(
¥k’
 > 0);

2481 
t
 +ğ
NGTCP2_SECONDS
;

2483 
cÚn
->
pkŠs
.
¹b
.
Ïrge¡_acked_tx_pkt_num
 = 1000000007;

2484 
™
 = 
	`ngtı2_¹b_h—d
(&
cÚn
->
pkŠs
.
¹b
);

2485 
	`ngtı2_cÚn_d‘eù_lo¡_pkt
(
cÚn
, &cÚn->
pkŠs
, &cÚn->
rcs
, ++
t
);

2486 
¥k’
 = 
	`ngtı2_cÚn_wr™e_pkt
(
cÚn
, 
NULL
, 
buf
, (
size_t
)(¥k’ - 1), ++
t
);

2488 
	`CU_ASSERT
(
¥k’
 > 0);

2490 
™
 = 
	`ngtı2_¹b_h—d
(&
cÚn
->
pkŠs
.
¹b
);

2492 
	`CU_ASSERT
(!
	`ngtı2_k¦_™_’d
(&
™
));

2493 
	`CU_ASSERT
(
NULL
 !ğ
cÚn
->
pkŠs
.
äq
);

2495 
	`ngtı2_cÚn_d–
(
cÚn
);

2496 
	}
}

2498 
	$‹¡_ngtı2_cÚn_£nd_max_¡»am_d©a
() {

2499 
ngtı2_cÚn
 *
cÚn
;

2500 
ušt8_t
 
buf
[2048];

2501 
size_t
 
pk’
;

2502 
ngtı2_¡rm
 *
¡rm
;

2503 
ušt64_t
 
pkt_num
 = 890;

2504 
ngtı2_t¡amp
 
t
 = 0;

2505 
ngtı2_äame
 
ä
;

2506 
rv
;

2507 cÚ¡ 
ušt32_t
 
d©®’
 = 1024;

2510 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

2511 
cÚn
->
loÿl_£‰šgs
.
max_¡»am_d©a_bidi_»mÙe
 = 
d©®’
;

2513 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2514 
ä
.
¡»am
.
¡»am_id
 = 4;

2515 
ä
.
¡»am
.
fš
 = 0;

2516 
ä
.
¡»am
.
off£t
 = 0;

2517 
ä
.
¡»am
.
d©aút
 = 1;

2518 
ä
.
¡»am
.
d©a
[0].
Ën
 = 
d©®’
;

2519 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

2521 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2522 ++
pkt_num
, &
ä
);

2524 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2526 
	`CU_ASSERT
(0 =ğ
rv
);

2528 
rv
 = 
	`ngtı2_cÚn_ex‹nd_max_¡»am_off£t
(
cÚn
, 4, 
d©®’
);

2530 
	`CU_ASSERT
(0 =ğ
rv
);

2532 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4);

2534 
	`CU_ASSERT
(
	`ngtı2_¡rm_is_tx_queued
(
¡rm
));

2536 
	`ngtı2_cÚn_d–
(
cÚn
);

2539 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

2540 
cÚn
->
loÿl_£‰šgs
.
max_¡»am_d©a_bidi_»mÙe
 = 
d©®’
;

2542 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2543 
ä
.
¡»am
.
¡»am_id
 = 4;

2544 
ä
.
¡»am
.
fš
 = 1;

2545 
ä
.
¡»am
.
off£t
 = 0;

2546 
ä
.
¡»am
.
d©aút
 = 1;

2547 
ä
.
¡»am
.
d©a
[0].
Ën
 = 
d©®’
;

2548 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

2550 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2551 ++
pkt_num
, &
ä
);

2553 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2555 
	`CU_ASSERT
(0 =ğ
rv
);

2557 
rv
 = 
	`ngtı2_cÚn_ex‹nd_max_¡»am_off£t
(
cÚn
, 4, 
d©®’
);

2559 
	`CU_ASSERT
(0 =ğ
rv
);

2561 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4);

2563 
	`CU_ASSERT
(!
	`ngtı2_¡rm_is_tx_queued
(
¡rm
));

2565 
	`ngtı2_cÚn_d–
(
cÚn
);

2569 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

2570 
cÚn
->
loÿl_£‰šgs
.
max_¡»am_d©a_bidi_»mÙe
 = 
d©®’
;

2572 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2573 
ä
.
¡»am
.
¡»am_id
 = 4;

2574 
ä
.
¡»am
.
fš
 = 0;

2575 
ä
.
¡»am
.
off£t
 = 0;

2576 
ä
.
¡»am
.
d©aút
 = 1;

2577 
ä
.
¡»am
.
d©a
[0].
Ën
 = 
d©®’
;

2578 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

2580 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2581 ++
pkt_num
, &
ä
);

2583 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2585 
	`CU_ASSERT
(0 =ğ
rv
);

2587 
rv
 = 
	`ngtı2_cÚn_shutdown_¡»am_»ad
(
cÚn
, 4, 
NGTCP2_APP_ERR01
);

2589 
	`CU_ASSERT
(0 =ğ
rv
);

2591 
rv
 = 
	`ngtı2_cÚn_ex‹nd_max_¡»am_off£t
(
cÚn
, 4, 
d©®’
);

2593 
	`CU_ASSERT
(0 =ğ
rv
);

2595 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4);

2597 
	`CU_ASSERT
(!
	`ngtı2_¡rm_is_tx_queued
(
¡rm
));

2599 
	`ngtı2_cÚn_d–
(
cÚn
);

2603 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

2604 
cÚn
->
loÿl_£‰šgs
.
max_¡»am_d©a_bidi_»mÙe
 = 
d©®’
;

2606 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2607 
ä
.
¡»am
.
¡»am_id
 = 4;

2608 
ä
.
¡»am
.
fš
 = 0;

2609 
ä
.
¡»am
.
off£t
 = 0;

2610 
ä
.
¡»am
.
d©aút
 = 1;

2611 
ä
.
¡»am
.
d©a
[0].
Ën
 = 
d©®’
;

2612 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

2614 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2615 ++
pkt_num
, &
ä
);

2617 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2619 
	`CU_ASSERT
(0 =ğ
rv
);

2621 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

2622 
ä
.
»£t_¡»am
.
¡»am_id
 = 4;

2623 
ä
.
»£t_¡»am
.
­p_”rÜ_code
 = 
NGTCP2_APP_ERR01
;

2624 
ä
.
»£t_¡»am
.
fš®_off£t
 = 
d©®’
;

2626 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2627 ++
pkt_num
, &
ä
);

2629 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2631 
	`CU_ASSERT
(0 =ğ
rv
);

2633 
rv
 = 
	`ngtı2_cÚn_ex‹nd_max_¡»am_off£t
(
cÚn
, 4, 
d©®’
);

2635 
	`CU_ASSERT
(0 =ğ
rv
);

2636 
	`CU_ASSERT
(
	`ngtı2_pq_em±y
(&
cÚn
->
tx_¡rmq
));

2638 
	`ngtı2_cÚn_d–
(
cÚn
);

2639 
	}
}

2641 
	$‹¡_ngtı2_cÚn_»cv_¡»am_d©a
() {

2642 
ušt8_t
 
buf
[1024];

2643 
ngtı2_cÚn
 *
cÚn
;

2644 
my_u£r_d©a
 
ud
;

2645 
ušt64_t
 
pkt_num
 = 612;

2646 
ngtı2_t¡amp
 
t
 = 0;

2647 
ngtı2_äame
 
ä
;

2648 
size_t
 
pk’
;

2649 
rv
;

2650 
ušt64_t
 
¡»am_id
;

2651 
size_t
 
i
;

2654 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

2655 
cÚn
->
ÿÎbacks
.
»cv_¡»am_d©a
 =„ecv_stream_data;

2656 
cÚn
->
u£r_d©a
 = &
ud
;

2658 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2659 
ä
.
¡»am
.
¡»am_id
 = 4;

2660 
ä
.
¡»am
.
fš
 = 0;

2661 
ä
.
¡»am
.
off£t
 = 0;

2662 
ä
.
¡»am
.
d©aút
 = 1;

2663 
ä
.
¡»am
.
d©a
[0].
Ën
 = 111;

2664 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

2666 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2667 ++
pkt_num
, &
ä
);

2669 
	`mem£t
(&
ud
, 0, (ud));

2670 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2672 
	`CU_ASSERT
(0 =ğ
rv
);

2673 
	`CU_ASSERT
(4 =ğ
ud
.
¡»am_d©a
.
¡»am_id
);

2674 
	`CU_ASSERT
(0 =ğ
ud
.
¡»am_d©a
.
fš
);

2675 
	`CU_ASSERT
(111 =ğ
ud
.
¡»am_d©a
.
d©®’
);

2677 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2678 
ä
.
¡»am
.
¡»am_id
 = 4;

2679 
ä
.
¡»am
.
fš
 = 1;

2680 
ä
.
¡»am
.
off£t
 = 111;

2681 
ä
.
¡»am
.
d©aút
 = 1;

2682 
ä
.
¡»am
.
d©a
[0].
Ën
 = 99;

2683 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

2685 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2686 ++
pkt_num
, &
ä
);

2688 
	`mem£t
(&
ud
, 0, (ud));

2689 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2691 
	`CU_ASSERT
(0 =ğ
rv
);

2692 
	`CU_ASSERT
(4 =ğ
ud
.
¡»am_d©a
.
¡»am_id
);

2693 
	`CU_ASSERT
(1 =ğ
ud
.
¡»am_d©a
.
fš
);

2694 
	`CU_ASSERT
(99 =ğ
ud
.
¡»am_d©a
.
d©®’
);

2696 
	`ngtı2_cÚn_d–
(
cÚn
);

2700 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

2701 
cÚn
->
ÿÎbacks
.
»cv_¡»am_d©a
 =„ecv_stream_data;

2702 
cÚn
->
u£r_d©a
 = &
ud
;

2704 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2705 
ä
.
¡»am
.
¡»am_id
 = 4;

2706 
ä
.
¡»am
.
fš
 = 0;

2707 
ä
.
¡»am
.
off£t
 = 0;

2708 
ä
.
¡»am
.
d©aút
 = 1;

2709 
ä
.
¡»am
.
d©a
[0].
Ën
 = 111;

2710 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

2712 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2713 ++
pkt_num
, &
ä
);

2715 
	`mem£t
(&
ud
, 0, (ud));

2716 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2718 
	`CU_ASSERT
(0 =ğ
rv
);

2719 
	`CU_ASSERT
(4 =ğ
ud
.
¡»am_d©a
.
¡»am_id
);

2720 
	`CU_ASSERT
(0 =ğ
ud
.
¡»am_d©a
.
fš
);

2721 
	`CU_ASSERT
(111 =ğ
ud
.
¡»am_d©a
.
d©®’
);

2723 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2724 
ä
.
¡»am
.
¡»am_id
 = 4;

2725 
ä
.
¡»am
.
fš
 = 1;

2726 
ä
.
¡»am
.
off£t
 = 111;

2727 
ä
.
¡»am
.
d©aút
 = 0;

2729 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2730 ++
pkt_num
, &
ä
);

2732 
	`mem£t
(&
ud
, 0, (ud));

2733 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2735 
	`CU_ASSERT
(0 =ğ
rv
);

2736 
	`CU_ASSERT
(4 =ğ
ud
.
¡»am_d©a
.
¡»am_id
);

2737 
	`CU_ASSERT
(1 =ğ
ud
.
¡»am_d©a
.
fš
);

2738 
	`CU_ASSERT
(0 =ğ
ud
.
¡»am_d©a
.
d©®’
);

2740 
	`ngtı2_cÚn_d–
(
cÚn
);

2744 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

2745 
cÚn
->
ÿÎbacks
.
»cv_¡»am_d©a
 =„ecv_stream_data;

2746 
cÚn
->
u£r_d©a
 = &
ud
;

2748 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2749 
ä
.
¡»am
.
¡»am_id
 = 4;

2750 
ä
.
¡»am
.
fš
 = 1;

2751 
ä
.
¡»am
.
off£t
 = 599;

2752 
ä
.
¡»am
.
d©aút
 = 0;

2754 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2755 ++
pkt_num
, &
ä
);

2757 
	`mem£t
(&
ud
, 0, (ud));

2758 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2760 
	`CU_ASSERT
(0 =ğ
rv
);

2761 
	`CU_ASSERT
(0 =ğ
ud
.
¡»am_d©a
.
¡»am_id
);

2763 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2764 
ä
.
¡»am
.
¡»am_id
 = 4;

2765 
ä
.
¡»am
.
fš
 = 0;

2766 
ä
.
¡»am
.
off£t
 = 0;

2767 
ä
.
¡»am
.
d©aút
 = 1;

2768 
ä
.
¡»am
.
d©a
[0].
Ën
 = 599;

2769 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

2771 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2772 ++
pkt_num
, &
ä
);

2774 
	`mem£t
(&
ud
, 0, (ud));

2775 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2777 
	`CU_ASSERT
(0 =ğ
rv
);

2778 
	`CU_ASSERT
(4 =ğ
ud
.
¡»am_d©a
.
¡»am_id
);

2779 
	`CU_ASSERT
(1 =ğ
ud
.
¡»am_d©a
.
fš
);

2780 
	`CU_ASSERT
(599 =ğ
ud
.
¡»am_d©a
.
d©®’
);

2782 
	`ngtı2_cÚn_d–
(
cÚn
);

2787 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

2788 
cÚn
->
ÿÎbacks
.
»cv_¡»am_d©a
 =„ecv_stream_data;

2789 
cÚn
->
u£r_d©a
 = &
ud
;

2791 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2792 
ä
.
¡»am
.
¡»am_id
 = 4;

2793 
ä
.
¡»am
.
fš
 = 1;

2794 
ä
.
¡»am
.
off£t
 = 599;

2795 
ä
.
¡»am
.
d©aút
 = 0;

2797 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2798 ++
pkt_num
, &
ä
);

2800 
	`mem£t
(&
ud
, 0, (ud));

2801 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2803 
	`CU_ASSERT
(0 =ğ
rv
);

2804 
	`CU_ASSERT
(0 =ğ
ud
.
¡»am_d©a
.
¡»am_id
);

2806 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2807 
ä
.
¡»am
.
¡»am_id
 = 4;

2808 
ä
.
¡»am
.
fš
 = 1;

2809 
ä
.
¡»am
.
off£t
 = 0;

2810 
ä
.
¡»am
.
d©aút
 = 1;

2811 
ä
.
¡»am
.
d©a
[0].
Ën
 = 599;

2812 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

2814 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2815 ++
pkt_num
, &
ä
);

2817 
	`mem£t
(&
ud
, 0, (ud));

2818 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2820 
	`CU_ASSERT
(0 =ğ
rv
);

2821 
	`CU_ASSERT
(4 =ğ
ud
.
¡»am_d©a
.
¡»am_id
);

2822 
	`CU_ASSERT
(1 =ğ
ud
.
¡»am_d©a
.
fš
);

2823 
	`CU_ASSERT
(599 =ğ
ud
.
¡»am_d©a
.
d©®’
);

2825 
	`ngtı2_cÚn_d–
(
cÚn
);

2828 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

2829 
cÚn
->
ÿÎbacks
.
»cv_¡»am_d©a
 =„ecv_stream_data;

2830 
cÚn
->
u£r_d©a
 = &
ud
;

2832 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2833 
ä
.
¡»am
.
¡»am_id
 = 3;

2834 
ä
.
¡»am
.
fš
 = 0;

2835 
ä
.
¡»am
.
off£t
 = 0;

2836 
ä
.
¡»am
.
d©aút
 = 1;

2837 
ä
.
¡»am
.
d©a
[0].
Ën
 = 911;

2838 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

2840 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2841 ++
pkt_num
, &
ä
);

2843 
	`mem£t
(&
ud
, 0, (ud));

2844 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2846 
	`CU_ASSERT
(0 =ğ
rv
);

2847 
	`CU_ASSERT
(3 =ğ
ud
.
¡»am_d©a
.
¡»am_id
);

2848 
	`CU_ASSERT
(0 =ğ
ud
.
¡»am_d©a
.
fš
);

2849 
	`CU_ASSERT
(911 =ğ
ud
.
¡»am_d©a
.
d©®’
);

2851 
	`ngtı2_cÚn_d–
(
cÚn
);

2854 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

2855 
cÚn
->
ÿÎbacks
.
»cv_¡»am_d©a
 =„ecv_stream_data;

2856 
cÚn
->
max_»mÙe_¡»am_id_uni
 = 0;

2857 
cÚn
->
u£r_d©a
 = &
ud
;

2859 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2860 
ä
.
¡»am
.
¡»am_id
 = 2;

2861 
ä
.
¡»am
.
fš
 = 0;

2862 
ä
.
¡»am
.
off£t
 = 0;

2863 
ä
.
¡»am
.
d©aút
 = 1;

2864 
ä
.
¡»am
.
d©a
[0].
Ën
 = 911;

2865 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

2867 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2868 ++
pkt_num
, &
ä
);

2870 
	`mem£t
(&
ud
, 0, (ud));

2871 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2873 
	`CU_ASSERT
(
NGTCP2_ERR_STREAM_LIMIT
 =ğ
rv
);

2875 
	`ngtı2_cÚn_d–
(
cÚn
);

2879 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

2881 
rv
 = 
	`ngtı2_cÚn_İ’_uni_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

2883 
	`CU_ASSERT
(0 =ğ
rv
);

2885 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2886 
ä
.
¡»am
.
¡»am_id
 = stream_id;

2887 
ä
.
¡»am
.
fš
 = 0;

2888 
ä
.
¡»am
.
off£t
 = 0;

2889 
ä
.
¡»am
.
d©aút
 = 1;

2890 
ä
.
¡»am
.
d©a
[0].
Ën
 = 9;

2891 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

2893 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2894 ++
pkt_num
, &
ä
);

2896 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2898 
	`CU_ASSERT
(
NGTCP2_ERR_PROTO
 =ğ
rv
);

2900 
	`ngtı2_cÚn_d–
(
cÚn
);

2903 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

2904 
cÚn
->
ÿÎbacks
.
»cv_üy±o_d©a
 = 
»cv_üy±o_çl_®”t_g’”©ed
;

2906 
ä
.
ty³
 = 
NGTCP2_FRAME_CRYPTO
;

2907 
ä
.
üy±o
.
off£t
 = 0;

2908 
ä
.
üy±o
.
d©aút
 = 1;

2909 
ä
.
üy±o
.
d©a
[0].
Ën
 = 139;

2910 
ä
.
üy±o
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

2912 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2913 ++
pkt_num
, &
ä
);

2915 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2917 
	`CU_ASSERT
(
NGTCP2_ERR_CRYPTO
 =ğ
rv
);

2919 
	`ngtı2_cÚn_d–
(
cÚn
);

2922 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

2924 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2925 
ä
.
¡»am
.
¡»am_id
 = 4;

2926 
ä
.
¡»am
.
fš
 = 0;

2927 
ä
.
¡»am
.
off£t
 = 0;

2928 
ä
.
¡»am
.
d©aút
 = 0;

2930 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2931 ++
pkt_num
, &
ä
);

2933 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2935 
	`CU_ASSERT
(0 =ğ
rv
);

2936 
	`CU_ASSERT
(
NULL
 !ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4));

2938 
	`ngtı2_cÚn_d–
(
cÚn
);

2942 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

2943 
cÚn
->
ÿÎbacks
.
»cv_¡»am_d©a
 =„ecv_stream_data;

2944 
cÚn
->
u£r_d©a
 = &
ud
;

2946 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2947 
ä
.
¡»am
.
¡»am_id
 = 4;

2948 
ä
.
¡»am
.
fš
 = 0;

2949 
ä
.
¡»am
.
off£t
 = 0;

2950 
ä
.
¡»am
.
d©aút
 = 0;

2952 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2953 ++
pkt_num
, &
ä
);

2955 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2957 
	`CU_ASSERT
(0 =ğ
rv
);

2958 
	`CU_ASSERT
(
NULL
 !ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4));

2960 
rv
 = 
	`ngtı2_cÚn_shutdown_¡»am_»ad
(
cÚn
, 4, 99);

2962 
	`CU_ASSERT
(0 =ğ
rv
);

2964 
i
 = 0; i < 2; ++i) {

2965 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2966 
ä
.
¡»am
.
¡»am_id
 = 4;

2967 
ä
.
¡»am
.
fš
 = 1;

2968 
ä
.
¡»am
.
off£t
 = 0;

2969 
ä
.
¡»am
.
d©aút
 = 1;

2970 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

2971 
ä
.
¡»am
.
d©a
[0].
Ën
 = 19;

2973 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2974 ++
pkt_num
, &
ä
);

2976 
ud
.
¡»am_d©a
.
¡»am_id
 = 0;

2977 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

2979 
	`CU_ASSERT
(0 =ğ
rv
);

2980 
	`CU_ASSERT
(0 =ğ
ud
.
¡»am_d©a
.
¡»am_id
);

2983 
	`ngtı2_cÚn_d–
(
cÚn
);

2987 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

2988 
cÚn
->
ÿÎbacks
.
»cv_¡»am_d©a
 =„ecv_stream_data;

2989 
cÚn
->
u£r_d©a
 = &
ud
;

2991 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

2992 
ä
.
¡»am
.
¡»am_id
 = 0;

2993 
ä
.
¡»am
.
fš
 = 0;

2994 
ä
.
¡»am
.
off£t
 = 0;

2995 
ä
.
¡»am
.
d©aút
 = 0;

2997 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

2998 ++
pkt_num
, &
ä
);

2999 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

3001 
	`CU_ASSERT
(0 =ğ
rv
);

3002 
	`CU_ASSERT
(
NULL
 !ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 0));

3004 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

3005 
ä
.
»£t_¡»am
.
¡»am_id
 = 0;

3006 
ä
.
»£t_¡»am
.
­p_”rÜ_code
 = 999;

3007 
ä
.
»£t_¡»am
.
fš®_off£t
 = 199;

3009 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

3010 ++
pkt_num
, &
ä
);

3011 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

3013 
	`CU_ASSERT
(0 =ğ
rv
);

3014 
	`CU_ASSERT
(
NULL
 !ğ
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 0));

3016 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

3017 
ä
.
¡»am
.
¡»am_id
 = 0;

3018 
ä
.
¡»am
.
fš
 = 0;

3019 
ä
.
¡»am
.
off£t
 = 0;

3020 
ä
.
¡»am
.
d©aút
 = 1;

3021 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

3022 
ä
.
¡»am
.
d©a
[0].
Ën
 = 198;

3024 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

3025 ++
pkt_num
, &
ä
);

3026 
ud
.
¡»am_d©a
.
¡»am_id
 = (
ušt64_t
)-1;

3027 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

3029 
	`CU_ASSERT
(0 =ğ
rv
);

3030 
	`CU_ASSERT
((
ušt64_t
)-1 =ğ
ud
.
¡»am_d©a
.
¡»am_id
);

3032 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

3033 
ä
.
¡»am
.
¡»am_id
 = 0;

3034 
ä
.
¡»am
.
fš
 = 1;

3035 
ä
.
¡»am
.
off£t
 = 198;

3036 
ä
.
¡»am
.
d©aút
 = 1;

3037 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

3038 
ä
.
¡»am
.
d©a
[0].
Ën
 = 1;

3040 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

3041 ++
pkt_num
, &
ä
);

3042 
ud
.
¡»am_d©a
.
¡»am_id
 = (
ušt64_t
)-1;

3043 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

3045 
	`CU_ASSERT
(0 =ğ
rv
);

3046 
	`CU_ASSERT
((
ušt64_t
)-1 =ğ
ud
.
¡»am_d©a
.
¡»am_id
);

3048 
	`ngtı2_cÚn_d–
(
cÚn
);

3049 
	}
}

3051 
	$‹¡_ngtı2_cÚn_»cv_pšg
() {

3052 
ušt8_t
 
buf
[1024];

3053 
ngtı2_cÚn
 *
cÚn
;

3054 
ušt64_t
 
pkt_num
 = 133;

3055 
ngtı2_t¡amp
 
t
 = 0;

3056 
ngtı2_äame
 
ä
;

3057 
size_t
 
pk’
;

3058 
rv
;

3060 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

3062 
ä
.
ty³
 = 
NGTCP2_FRAME_PING
;

3064 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

3065 ++
pkt_num
, &
ä
);

3066 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

3068 
	`CU_ASSERT
(0 =ğ
rv
);

3069 
	`CU_ASSERT
(
NULL
 =ğ
cÚn
->
pkŠs
.
äq
);

3071 
	`ngtı2_cÚn_d–
(
cÚn
);

3072 
	}
}

3074 
	$‹¡_ngtı2_cÚn_»cv_max_¡»am_d©a
() {

3075 
ušt8_t
 
buf
[1024];

3076 
ngtı2_cÚn
 *
cÚn
;

3077 
ušt64_t
 
pkt_num
 = 1000000007;

3078 
ngtı2_t¡amp
 
t
 = 0;

3079 
ngtı2_äame
 
ä
;

3080 
size_t
 
pk’
;

3081 
rv
;

3082 
ngtı2_¡rm
 *
¡rm
;

3086 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

3088 
ä
.
ty³
 = 
NGTCP2_FRAME_MAX_STREAM_DATA
;

3089 
ä
.
max_¡»am_d©a
.
¡»am_id
 = 4;

3090 
ä
.
max_¡»am_d©a
.max_stream_data = 8092;

3092 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

3093 ++
pkt_num
, &
ä
);

3095 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

3097 
	`CU_ASSERT
(
NGTCP2_ERR_STREAM_STATE
 =ğ
rv
);

3099 
	`ngtı2_cÚn_d–
(
cÚn
);

3103 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

3105 
ä
.
ty³
 = 
NGTCP2_FRAME_MAX_STREAM_DATA
;

3106 
ä
.
max_¡»am_d©a
.
¡»am_id
 = 2;

3107 
ä
.
max_¡»am_d©a
.max_stream_data = 8092;

3109 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

3110 ++
pkt_num
, &
ä
);

3112 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

3114 
	`CU_ASSERT
(
NGTCP2_ERR_PROTO
 =ğ
rv
);

3116 
	`ngtı2_cÚn_d–
(
cÚn
);

3120 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

3122 
ä
.
ty³
 = 
NGTCP2_FRAME_MAX_STREAM_DATA
;

3123 
ä
.
max_¡»am_d©a
.
¡»am_id
 = 1;

3124 
ä
.
max_¡»am_d©a
.max_stream_data = 1000000009;

3126 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

3127 ++
pkt_num
, &
ä
);

3129 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

3131 
	`CU_ASSERT
(
NGTCP2_ERR_STREAM_LIMIT
 =ğ
rv
);

3133 
	`ngtı2_cÚn_d–
(
cÚn
);

3137 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

3139 
ä
.
ty³
 = 
NGTCP2_FRAME_MAX_STREAM_DATA
;

3140 
ä
.
max_¡»am_d©a
.
¡»am_id
 = 4;

3141 
ä
.
max_¡»am_d©a
.max_stream_data = 1000000009;

3143 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

3144 ++
pkt_num
, &
ä
);

3146 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

3148 
	`CU_ASSERT
(0 =ğ
rv
);

3150 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4);

3152 
	`CU_ASSERT
(
NULL
 !ğ
¡rm
);

3153 
	`CU_ASSERT
(1000000009 =ğ
¡rm
->
max_tx_off£t
);

3155 
	`ngtı2_cÚn_d–
(
cÚn
);

3159 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

3161 
ä
.
ty³
 = 
NGTCP2_FRAME_MAX_STREAM_DATA
;

3162 
ä
.
max_¡»am_d©a
.
¡»am_id
 = 2;

3163 
ä
.
max_¡»am_d©a
.max_stream_data = 1000000009;

3165 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

3166 ++
pkt_num
, &
ä
);

3168 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

3170 
	`CU_ASSERT
(
NGTCP2_ERR_PROTO
 =ğ
rv
);

3172 
	`ngtı2_cÚn_d–
(
cÚn
);

3175 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

3177 
¡rm
 = 
	`İ’_¡»am
(
cÚn
, 4);

3179 
ä
.
ty³
 = 
NGTCP2_FRAME_MAX_STREAM_DATA
;

3180 
ä
.
max_¡»am_d©a
.
¡»am_id
 = 4;

3181 
ä
.
max_¡»am_d©a
.max_stream_data = 1000000009;

3183 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

3184 ++
pkt_num
, &
ä
);

3186 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

3188 
	`CU_ASSERT
(0 =ğ
rv
);

3189 
	`CU_ASSERT
(1000000009 =ğ
¡rm
->
max_tx_off£t
);

3191 
	`ngtı2_cÚn_d–
(
cÚn
);

3192 
	}
}

3194 
	$‹¡_ngtı2_cÚn_£nd_—¾y_d©a
() {

3195 
ngtı2_cÚn
 *
cÚn
;

3196 
ssize_t
 
¥k’
;

3197 
ssize_t
 
d©®’
;

3198 
ušt8_t
 
buf
[1024];

3199 
ušt64_t
 
¡»am_id
;

3200 
rv
;

3201 
ngtı2_t¡amp
 
t
 = 0;

3203 
	`£tup_—¾y_ş›Á
(&
cÚn
);

3205 
rv
 = 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

3207 
	`CU_ASSERT
(0 =ğ
rv
);

3209 
¥k’
 = 
	`ngtı2_cÚn_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), ++
t
);

3211 
	`CU_ASSERT
(
¥k’
 > 0);

3213 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, (buf), &
d©®’
,

3214 
¡»am_id
, 1, 
nuÎ_d©a
, 1024, ++
t
);

3216 
	`CU_ASSERT
((
ssize_t
)(
buf
è=ğ
¥k’
);

3217 
	`CU_ASSERT
(959 =ğ
d©®’
);

3219 
	`ngtı2_cÚn_d–
(
cÚn
);

3223 
	`£tup_—¾y_ş›Á
(&
cÚn
);

3225 
rv
 = 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

3227 
	`CU_ASSERT
(0 =ğ
rv
);

3229 
¥k’
 = 
	`ngtı2_cÚn_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), ++
t
);

3231 
	`CU_ASSERT
(
¥k’
 > 0);

3238 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, 64, &
d©®’
, 
¡»am_id
,

3239 0, 
nuÎ_d©a
, 10, ++
t
);

3241 
	`CU_ASSERT
(0 =ğ
¥k’
);

3242 
	`CU_ASSERT
(-1 =ğ
d©®’
);

3244 
	`ngtı2_cÚn_d–
(
cÚn
);

3247 
	`£tup_—¾y_ş›Á
(&
cÚn
);

3249 
rv
 = 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

3251 
	`CU_ASSERT
(0 =ğ
rv
);

3253 
¥k’
 = 
	`ngtı2_cÚn_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), ++
t
);

3255 
	`CU_ASSERT
(
¥k’
 > 0);

3257 
¥k’
 = 
	`ngtı2_cÚn_wr™e_¡»am
(
cÚn
, 
NULL
, 
buf
, 65, &
d©®’
, 
¡»am_id
,

3258 0, 
nuÎ_d©a
, 10, ++
t
);

3260 
	`CU_ASSERT
(
¥k’
 > 0);

3261 
	`CU_ASSERT
(1 =ğ
d©®’
);

3263 
	`ngtı2_cÚn_d–
(
cÚn
);

3264 
	}
}

3266 
	$‹¡_ngtı2_cÚn_»cv_—¾y_d©a
() {

3267 
ngtı2_cÚn
 *
cÚn
;

3268 
ušt8_t
 
buf
[2048];

3269 
size_t
 
pk’
;

3270 
ssize_t
 
¥k’
;

3271 
ngtı2_äame
 
ä
;

3272 
ušt64_t
 
pkt_num
 = 1;

3273 
ngtı2_t¡amp
 
t
 = 0;

3274 
ngtı2_¡rm
 *
¡rm
;

3275 
ngtı2_cid
 
rcid
;

3276 
rv
;

3278 
	`rcid_š™
(&
rcid
);

3280 
	`£tup_—¾y_£rv”
(&
cÚn
);

3282 
ä
.
ty³
 = 
NGTCP2_FRAME_CRYPTO
;

3283 
ä
.
üy±o
.
off£t
 = 0;

3284 
ä
.
üy±o
.
d©aút
 = 1;

3285 
ä
.
üy±o
.
d©a
[0].
Ën
 = 121;

3286 
ä
.
üy±o
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

3288 
pk’
 = 
	`wr™e_sšgË_äame_hªdshake_pkt
(

3289 
cÚn
, 
buf
, (buf), 
NGTCP2_PKT_INITIAL
, &
rcid
,

3290 
	`ngtı2_cÚn_g‘_dcid
(
cÚn
), ++
pkt_num
, cÚn->
v”siÚ
, &
ä
);

3292 
rv
 = 
	`ngtı2_cÚn_»ad_hªdshake
(
cÚn
, 
buf
, 
pk’
, ++
t
);

3294 
	`CU_ASSERT
(0 =ğ
rv
);

3296 
¥k’
 = 
	`ngtı2_cÚn_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), ++
t
);

3298 
	`CU_ASSERT
(
¥k’
 > 0);

3300 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

3301 
ä
.
¡»am
.
¡»am_id
 = 4;

3302 
ä
.
¡»am
.
fš
 = 1;

3303 
ä
.
¡»am
.
off£t
 = 0;

3304 
ä
.
¡»am
.
d©aút
 = 1;

3305 
ä
.
¡»am
.
d©a
[0].
Ën
 = 911;

3306 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

3308 
pk’
 = 
	`wr™e_sšgË_äame_hªdshake_pkt
(

3309 
cÚn
, 
buf
, (buf), 
NGTCP2_PKT_0RTT_PROTECTED
, &
rcid
,

3310 
	`ngtı2_cÚn_g‘_dcid
(
cÚn
), ++
pkt_num
, cÚn->
v”siÚ
, &
ä
);

3312 
rv
 = 
	`ngtı2_cÚn_»ad_hªdshake
(
cÚn
, 
buf
, 
pk’
, ++
t
);

3314 
	`CU_ASSERT
(0 =ğ
rv
);

3316 
¥k’
 = 
	`ngtı2_cÚn_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), ++
t
);

3318 
	`CU_ASSERT
(
¥k’
 > 0);

3320 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4);

3322 
	`CU_ASSERT
(
NULL
 !ğ
¡rm
);

3323 
	`CU_ASSERT
(911 =ğ
¡rm
->
Ï¡_rx_off£t
);

3325 
	`ngtı2_cÚn_d–
(
cÚn
);

3328 
	`£tup_—¾y_£rv”
(&
cÚn
);

3330 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

3331 
ä
.
¡»am
.
¡»am_id
 = 4;

3332 
ä
.
¡»am
.
fš
 = 1;

3333 
ä
.
¡»am
.
off£t
 = 0;

3334 
ä
.
¡»am
.
d©aút
 = 1;

3335 
ä
.
¡»am
.
d©a
[0].
Ën
 = 119;

3336 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

3338 
pk’
 = 
	`wr™e_sšgË_äame_hªdshake_pkt
(

3339 
cÚn
, 
buf
, (buf), 
NGTCP2_PKT_0RTT_PROTECTED
, &
rcid
,

3340 
	`ngtı2_cÚn_g‘_dcid
(
cÚn
), ++
pkt_num
, cÚn->
v”siÚ
, &
ä
);

3342 
rv
 = 
	`ngtı2_cÚn_»ad_hªdshake
(
cÚn
, 
buf
, 
pk’
, ++
t
);

3344 
	`CU_ASSERT
(0 =ğ
rv
);

3346 
¥k’
 = 
	`ngtı2_cÚn_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), ++
t
);

3348 
	`CU_ASSERT
(0 =ğ
¥k’
);

3350 
ä
.
ty³
 = 
NGTCP2_FRAME_CRYPTO
;

3351 
ä
.
üy±o
.
off£t
 = 0;

3352 
ä
.
üy±o
.
d©aút
 = 1;

3353 
ä
.
üy±o
.
d©a
[0].
Ën
 = 319;

3354 
ä
.
üy±o
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

3356 
pk’
 = 
	`wr™e_sšgË_äame_hªdshake_pkt
(

3357 
cÚn
, 
buf
, (buf), 
NGTCP2_PKT_INITIAL
, &
rcid
,

3358 
	`ngtı2_cÚn_g‘_dcid
(
cÚn
), ++
pkt_num
, cÚn->
v”siÚ
, &
ä
);

3360 
rv
 = 
	`ngtı2_cÚn_»ad_hªdshake
(
cÚn
, 
buf
, 
pk’
, ++
t
);

3362 
	`CU_ASSERT
(0 =ğ
rv
);

3364 
¥k’
 = 
	`ngtı2_cÚn_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), ++
t
);

3366 
	`CU_ASSERT
(
¥k’
 > 0);

3368 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4);

3370 
	`CU_ASSERT
(
NULL
 !ğ
¡rm
);

3371 
	`CU_ASSERT
(119 =ğ
¡rm
->
Ï¡_rx_off£t
);

3373 
	`ngtı2_cÚn_d–
(
cÚn
);

3376 
	`£tup_—¾y_£rv”
(&
cÚn
);

3378 
ä
.
ty³
 = 
NGTCP2_FRAME_CRYPTO
;

3379 
ä
.
üy±o
.
off£t
 = 0;

3380 
ä
.
üy±o
.
d©aút
 = 1;

3381 
ä
.
üy±o
.
d©a
[0].
Ën
 = 111;

3382 
ä
.
üy±o
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

3384 
pk’
 = 
	`wr™e_sšgË_äame_hªdshake_pkt
(

3385 
cÚn
, 
buf
, (buf), 
NGTCP2_PKT_INITIAL
, &
rcid
,

3386 
	`ngtı2_cÚn_g‘_dcid
(
cÚn
), ++
pkt_num
, cÚn->
v”siÚ
, &
ä
);

3388 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

3389 
ä
.
¡»am
.
¡»am_id
 = 4;

3390 
ä
.
¡»am
.
fš
 = 1;

3391 
ä
.
¡»am
.
off£t
 = 0;

3392 
ä
.
¡»am
.
d©aút
 = 1;

3393 
ä
.
¡»am
.
d©a
[0].
Ën
 = 999;

3394 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

3396 
pk’
 +ğ
	`wr™e_sšgË_äame_hªdshake_pkt
(

3397 
cÚn
, 
buf
 + 
pk’
, (bufè-…k’, 
NGTCP2_PKT_0RTT_PROTECTED
,

3398 &
rcid
, 
	`ngtı2_cÚn_g‘_dcid
(
cÚn
), ++
pkt_num
, cÚn->
v”siÚ
, &
ä
);

3400 
rv
 = 
	`ngtı2_cÚn_»ad_hªdshake
(
cÚn
, 
buf
, 
pk’
, ++
t
);

3402 
	`CU_ASSERT
(0 =ğ
rv
);

3404 
¥k’
 = 
	`ngtı2_cÚn_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), ++
t
);

3406 
	`CU_ASSERT
(
¥k’
 > 0);

3408 
¡rm
 = 
	`ngtı2_cÚn_fšd_¡»am
(
cÚn
, 4);

3410 
	`CU_ASSERT
(
NULL
 !ğ
¡rm
);

3411 
	`CU_ASSERT
(999 =ğ
¡rm
->
Ï¡_rx_off£t
);

3413 
	`ngtı2_cÚn_d–
(
cÚn
);

3414 
	}
}

3416 
	$‹¡_ngtı2_cÚn_»cv_compound_pkt
() {

3417 
ngtı2_cÚn
 *
cÚn
;

3418 
ušt8_t
 
buf
[2048];

3419 
size_t
 
pk’
;

3420 
ssize_t
 
¥k’
;

3421 
ngtı2_äame
 
ä
;

3422 
ušt64_t
 
pkt_num
 = 1;

3423 
ngtı2_t¡amp
 
t
 = 0;

3424 
ngtı2_ackŒ_’Œy
 *
ack’t
;

3425 
rv
;

3426 
ngtı2_k¦_™
 
™
;

3429 
	`£tup_hªdshake_£rv”
(&
cÚn
);

3431 
ä
.
ty³
 = 
NGTCP2_FRAME_CRYPTO
;

3432 
ä
.
üy±o
.
off£t
 = 0;

3433 
ä
.
üy±o
.
d©aút
 = 1;

3434 
ä
.
üy±o
.
d©a
[0].
Ën
 = 131;

3435 
ä
.
üy±o
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

3437 
pk’
 = 
	`wr™e_sšgË_äame_hªdshake_pkt
(

3438 
cÚn
, 
buf
, (buf), 
NGTCP2_PKT_INITIAL
, &cÚn->
oscid
,

3439 
	`ngtı2_cÚn_g‘_dcid
(
cÚn
), ++
pkt_num
, cÚn->
v”siÚ
, &
ä
);

3441 
pk’
 +ğ
	`wr™e_sšgË_äame_hªdshake_pkt
(

3442 
cÚn
, 
buf
 + 
pk’
, (bufè-…k’, 
NGTCP2_PKT_INITIAL
,

3443 &
cÚn
->
oscid
, 
	`ngtı2_cÚn_g‘_dcid
(cÚn), ++
pkt_num
, cÚn->
v”siÚ
, &
ä
);

3445 
rv
 = 
	`ngtı2_cÚn_»ad_hªdshake
(
cÚn
, 
buf
, 
pk’
, ++
t
);

3447 
	`CU_ASSERT
(0 =ğ
rv
);

3449 
¥k’
 = 
	`ngtı2_cÚn_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), ++
t
);

3451 
	`CU_ASSERT
(
¥k’
 > 0);

3453 
™
 = 
	`ngtı2_ackŒ_g‘
(&
cÚn
->
š_pkŠs
.
ackŒ
);

3454 
ack’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

3456 
	`CU_ASSERT
(
pkt_num
 =ğ
ack’t
->pkt_num);

3457 
	`CU_ASSERT
(2 =ğ
ack’t
->
Ën
);

3459 
	`ngtı2_k¦_™_Ãxt
(&
™
);

3460 
	`ngtı2_k¦_™_’d
(&
™
);

3462 
	`ngtı2_cÚn_d–
(
cÚn
);

3465 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

3467 
ä
.
ty³
 = 
NGTCP2_FRAME_PADDING
;

3468 
ä
.
·ddšg
.
Ën
 = 1;

3470 
pk’
 = 
	`wr™e_sšgË_äame_hªdshake_pkt
(

3471 
cÚn
, 
buf
, (buf), 
NGTCP2_PKT_HANDSHAKE
, &cÚn->
oscid
,

3472 
	`ngtı2_cÚn_g‘_dcid
(
cÚn
), ++
pkt_num
, cÚn->
v”siÚ
, &
ä
);

3474 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

3475 
ä
.
¡»am
.
¡»am_id
 = 4;

3476 
ä
.
¡»am
.
fš
 = 0;

3477 
ä
.
¡»am
.
off£t
 = 0;

3478 
ä
.
¡»am
.
d©aút
 = 1;

3479 
ä
.
¡»am
.
d©a
[0].
Ën
 = 426;

3480 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

3482 
pk’
 +ğ
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
 +…ktlen, (buf) -…ktlen,

3483 &
cÚn
->
oscid
, ++
pkt_num
, &
ä
);

3485 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

3487 
	`CU_ASSERT
(0 =ğ
rv
);

3489 
™
 = 
	`ngtı2_ackŒ_g‘
(&
cÚn
->
pkŠs
.
ackŒ
);

3490 
ack’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

3492 
	`CU_ASSERT
(
ack’t
->
pkt_num
 ==…kt_num);

3494 
™
 = 
	`ngtı2_ackŒ_g‘
(&
cÚn
->
hs_pkŠs
.
ackŒ
);

3495 
ack’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

3497 
	`CU_ASSERT
(
ack’t
->
pkt_num
 ==…kt_num - 1);

3499 
	`ngtı2_cÚn_d–
(
cÚn
);

3500 
	}
}

3502 
	$‹¡_ngtı2_cÚn_pkt_·ylßdËn
() {

3503 
ngtı2_cÚn
 *
cÚn
;

3504 
ušt8_t
 
buf
[2048];

3505 
size_t
 
pk’
;

3506 
ssize_t
 
¥k’
;

3507 
ngtı2_äame
 
ä
;

3508 
ušt64_t
 
pkt_num
 = 1;

3509 
ngtı2_t¡amp
 
t
 = 0;

3510 
ušt64_t
 
·ylßdËn
;

3511 
rv
;

3512 cÚ¡ 
ngtı2_cid
 *
dcid
;

3515 
	`£tup_hªdshake_£rv”
(&
cÚn
);

3517 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

3518 
ä
.
¡»am
.
¡»am_id
 = 0;

3519 
ä
.
¡»am
.
fš
 = 0;

3520 
ä
.
¡»am
.
off£t
 = 0;

3521 
ä
.
¡»am
.
d©aút
 = 1;

3522 
ä
.
¡»am
.
d©a
[0].
Ën
 = 131;

3523 
ä
.
¡»am
.
d©a
[0].
ba£
 = 
nuÎ_d©a
;

3525 
dcid
 = 
	`ngtı2_cÚn_g‘_dcid
(
cÚn
);

3527 
pk’
 = 
	`wr™e_sšgË_äame_hªdshake_pkt
(

3528 
cÚn
, 
buf
, (buf), 
NGTCP2_PKT_INITIAL
, &cÚn->
oscid
, 
dcid
, ++
pkt_num
,

3529 
cÚn
->
v”siÚ
, &
ä
);

3531 
·ylßdËn
 = 
	`»ad_pkt_·ylßdËn
(
buf
, 
dcid
, &
cÚn
->
oscid
);

3532 
	`wr™e_pkt_·ylßdËn
(
buf
, 
dcid
, &
cÚn
->
oscid
, 
·ylßdËn
 + 1);

3535 
rv
 = 
	`ngtı2_cÚn_»ad_hªdshake
(
cÚn
, 
buf
, 
pk’
, ++
t
);

3537 
	`CU_ASSERT
(0 =ğ
rv
);

3538 
	`CU_ASSERT
(
NGTCP2_CS_SERVER_INITIAL
 =ğ
cÚn
->
¡©e
);

3540 
¥k’
 = 
	`ngtı2_cÚn_wr™e_hªdshake
(
cÚn
, 
buf
, (buf), ++
t
);

3542 
	`CU_ASSERT
(
¥k’
 == 0);

3543 
	`CU_ASSERT
(0 =ğ
	`ngtı2_k¦_Ën
(&
cÚn
->
š_pkŠs
.
ackŒ
.
’ts
));

3545 
	`ngtı2_cÚn_d–
(
cÚn
);

3546 
	}
}

3548 
	$‹¡_ngtı2_cÚn_wr™ev_¡»am
() {

3549 
ngtı2_cÚn
 *
cÚn
;

3550 
ušt8_t
 
buf
[2048];

3551 
ssize_t
 
¥k’
;

3552 
ngtı2_t¡amp
 
t
 = 0;

3553 
rv
;

3554 
ušt64_t
 
¡»am_id
;

3555 
ngtı2_vec
 
d©av
 = {
nuÎ_d©a
, 10};

3556 
ssize_t
 
d©®’
;

3560 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

3563 
¥k’
 = 
	`ngtı2_cÚn_wr™e_pkt
(
cÚn
, 
NULL
, 
buf
, (buf), ++
t
);

3565 
	`CU_ASSERT
(
¥k’
 > 0);

3567 
rv
 = 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

3569 
	`CU_ASSERT
(0 =ğ
rv
);

3576 
¥k’
 = 
	`ngtı2_cÚn_wr™ev_¡»am
(
cÚn
, 
NULL
, 
buf
, 39, &
d©®’
, 
¡»am_id
,

3577 0, &
d©av
, 1, ++
t
);

3579 
	`CU_ASSERT
(0 =ğ
¥k’
);

3580 
	`CU_ASSERT
(-1 =ğ
d©®’
);

3582 
	`ngtı2_cÚn_d–
(
cÚn
);

3585 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

3588 
¥k’
 = 
	`ngtı2_cÚn_wr™e_pkt
(
cÚn
, 
NULL
, 
buf
, (buf), ++
t
);

3590 
	`CU_ASSERT
(
¥k’
 > 0);

3592 
rv
 = 
	`ngtı2_cÚn_İ’_bidi_¡»am
(
cÚn
, &
¡»am_id
, 
NULL
);

3594 
	`CU_ASSERT
(0 =ğ
rv
);

3596 
¥k’
 = 
	`ngtı2_cÚn_wr™ev_¡»am
(
cÚn
, 
NULL
, 
buf
, 40, &
d©®’
, 
¡»am_id
,

3597 0, &
d©av
, 1, ++
t
);

3599 
	`CU_ASSERT
(
¥k’
 > 0);

3600 
	`CU_ASSERT
(1 =ğ
d©®’
);

3602 
	`ngtı2_cÚn_d–
(
cÚn
);

3603 
	}
}

3605 
	$‹¡_ngtı2_cÚn_»cv_Ãw_cÚÃùiÚ_id
() {

3606 
ngtı2_cÚn
 *
cÚn
;

3607 
ušt8_t
 
buf
[2048];

3608 
size_t
 
pk’
;

3609 
ngtı2_t¡amp
 
t
 = 0;

3610 
ušt64_t
 
pkt_num
 = 0;

3611 
ngtı2_äame
 
ä
;

3612 cÚ¡ 
ušt8_t
 
cid
[] = {0xf0, 0xf1, 0xf2, 0xf3};

3613 cÚ¡ 
ušt8_t
 
tok’
[
NGTCP2_STATELESS_RESET_TOKENLEN
] = {0xff};

3614 
ngtı2_dcid
 *
dcid
;

3615 
rv
;

3617 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

3619 
ä
.
ty³
 = 
NGTCP2_FRAME_NEW_CONNECTION_ID
;

3620 
ä
.
Ãw_cÚÃùiÚ_id
.
£q
 = 1;

3621 
	`ngtı2_cid_š™
(&
ä
.
Ãw_cÚÃùiÚ_id
.
cid
, cid, (cid));

3622 
	`memıy
(
ä
.
Ãw_cÚÃùiÚ_id
.
¡©–ess_»£t_tok’
, 
tok’
, (token));

3624 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

3625 ++
pkt_num
, &
ä
);

3627 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

3629 
	`CU_ASSERT
(0 =ğ
rv
);

3630 
	`CU_ASSERT
(1 =ğ
	`ngtı2_ršgbuf_Ën
(&
cÚn
->
dcids
));

3632 
dcid
 = 
	`ngtı2_ršgbuf_g‘
(&
cÚn
->
dcids
, 0);

3634 
	`CU_ASSERT
(
	`ngtı2_cid_eq
(&
ä
.
Ãw_cÚÃùiÚ_id
.
cid
, &
dcid
->cid));

3635 
	`CU_ASSERT
(0 =ğ
	`memcmp
(
ä
.
Ãw_cÚÃùiÚ_id
.
¡©–ess_»£t_tok’
, 
dcid
->
tok’
,

3636 (
ä
.
Ãw_cÚÃùiÚ_id
.
¡©–ess_»£t_tok’
)));

3638 
	`ngtı2_cÚn_d–
(
cÚn
);

3639 
	}
}

3641 
	$‹¡_ngtı2_cÚn_»cv_»tœe_cÚÃùiÚ_id
() {

3642 
ngtı2_cÚn
 *
cÚn
;

3643 
ušt8_t
 
buf
[2048];

3644 
size_t
 
pk’
;

3645 
ssize_t
 
¥k’
;

3646 
ngtı2_t¡amp
 
t
 = 1000000009;

3647 
ušt64_t
 
pkt_num
 = 0;

3648 
ngtı2_äame
 
ä
;

3649 
rv
;

3650 
ngtı2_k¦_™
 
™
;

3651 
ngtı2_scid
 *
scid
;

3652 
ušt64_t
 
£q
;

3654 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

3657 
¥k’
 = 
	`ngtı2_cÚn_wr™e_pkt
(
cÚn
, 
NULL
, 
buf
, (buf), 
t
);

3659 
	`CU_ASSERT
(
¥k’
 > 0);

3661 
™
 = 
	`ngtı2_k¦_begš
(&
cÚn
->
scids
);

3662 
scid
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

3663 
£q
 = 
scid
->seq;

3665 
	`CU_ASSERT
(
NGTCP2_SCID_FLAG_NONE
 =ğ
scid
->
æags
);

3666 
	`CU_ASSERT
(
UINT64_MAX
 =ğ
scid
->
ts_»tœed
);

3667 
	`CU_ASSERT
(0 =ğ
	`ngtı2_pq_size
(&
cÚn
->
u£d_scids
));

3669 
ä
.
ty³
 = 
NGTCP2_FRAME_RETIRE_CONNECTION_ID
;

3670 
ä
.
»tœe_cÚÃùiÚ_id
.
£q
 = seq;

3672 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

3673 ++
pkt_num
, &
ä
);

3675 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

3677 
	`CU_ASSERT
(0 =ğ
rv
);

3678 
	`CU_ASSERT
(
NGTCP2_SCID_FLAG_RETIRED
 =ğ
scid
->
æags
);

3679 
	`CU_ASSERT
(1000000010 =ğ
scid
->
ts_»tœed
);

3680 
	`CU_ASSERT
(2 =ğ
	`ngtı2_pq_size
(&
cÚn
->
u£d_scids
));

3682 
	`ngtı2_cÚn_d–
(
cÚn
);

3683 
	}
}

3685 
	$‹¡_ngtı2_cÚn_£rv”_·th_v®id©iÚ
() {

3686 
ngtı2_cÚn
 *
cÚn
;

3687 
ušt8_t
 
buf
[2048];

3688 
size_t
 
pk’
;

3689 
ssize_t
 
¥k’
;

3690 
ngtı2_t¡amp
 
t
 = 900;

3691 
ušt64_t
 
pkt_num
 = 0;

3692 
ngtı2_äame
 
ä
;

3693 
rv
;

3694 cÚ¡ 
ušt8_t
 
¿w_cid
[] = {0x0f, 0x00, 0x00, 0x00};

3695 
ngtı2_cid
 
cid
;

3696 cÚ¡ 
ušt8_t
 
tok’
[
NGTCP2_STATELESS_RESET_TOKENLEN
] = {0xff};

3698 
	`ngtı2_cid_š™
(&
cid
, 
¿w_cid
, (raw_cid));

3700 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

3702 
ä
.
ty³
 = 
NGTCP2_FRAME_NEW_CONNECTION_ID
;

3703 
ä
.
Ãw_cÚÃùiÚ_id
.
£q
 = 1;

3704 
ä
.
Ãw_cÚÃùiÚ_id
.
cid
 = cid;

3705 
	`memıy
(
ä
.
Ãw_cÚÃùiÚ_id
.
¡©–ess_»£t_tok’
, 
tok’
, (token));

3707 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

3708 ++
pkt_num
, &
ä
);

3710 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

3712 
	`CU_ASSERT
(0 =ğ
rv
);

3714 
ä
.
ty³
 = 
NGTCP2_FRAME_PING
;

3716 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

3717 ++
pkt_num
, &
ä
);

3719 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
Ãw_·th
, 
buf
, 
pk’
, ++
t
);

3721 
	`CU_ASSERT
(0 =ğ
rv
);

3722 
	`CU_ASSERT
(
NULL
 !ğ
cÚn
->
pv
);

3724 
¥k’
 = 
	`ngtı2_cÚn_wr™e_pkt
(
cÚn
, 
NULL
, 
buf
, (buf), 
t
);

3726 
	`CU_ASSERT
(
¥k’
 > 0);

3727 
	`CU_ASSERT
(
	`ngtı2_ršgbuf_Ën
(&
cÚn
->
pv
->
’ts
) > 0);

3729 
ä
.
ty³
 = 
NGTCP2_FRAME_PATH_RESPONSE
;

3730 
	`mem£t
(
ä
.
·th_»¥Ú£
.
d©a
, 0, (fr.path_response.data));

3732 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

3733 ++
pkt_num
, &
ä
);

3735 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
Ãw_·th
, 
buf
, 
pk’
, ++
t
);

3737 
	`CU_ASSERT
(0 =ğ
rv
);

3738 
	`CU_ASSERT
(
	`ngtı2_·th_eq
(&
Ãw_·th
, &
cÚn
->
dcid
.
·th
));

3739 
	`CU_ASSERT
(
	`ngtı2_cid_eq
(&
cid
, &
cÚn
->
dcid
.cid));

3741 
	`ngtı2_cÚn_d–
(
cÚn
);

3742 
	}
}

3744 
	$‹¡_ngtı2_cÚn_ş›Á_cÚÃùiÚ_mig¿tiÚ
() {

3745 
ngtı2_cÚn
 *
cÚn
;

3746 
ušt8_t
 
buf
[2048];

3747 
size_t
 
pk’
;

3748 
ssize_t
 
¥k’
;

3749 
ngtı2_t¡amp
 
t
 = 900;

3750 
ušt64_t
 
pkt_num
 = 0;

3751 
ngtı2_äame
 
ä
;

3752 
rv
;

3753 cÚ¡ 
ušt8_t
 
¿w_cid
[] = {0x0f, 0x00, 0x00, 0x00};

3754 
ngtı2_cid
 
cid
;

3755 cÚ¡ 
ušt8_t
 
tok’
[
NGTCP2_STATELESS_RESET_TOKENLEN
] = {0xff};

3757 
	`ngtı2_cid_š™
(&
cid
, 
¿w_cid
, (raw_cid));

3759 
	`£tup_deçuÉ_ş›Á
(&
cÚn
);

3761 
ä
.
ty³
 = 
NGTCP2_FRAME_NEW_CONNECTION_ID
;

3762 
ä
.
Ãw_cÚÃùiÚ_id
.
£q
 = 1;

3763 
ä
.
Ãw_cÚÃùiÚ_id
.
cid
 = cid;

3764 
	`memıy
(
ä
.
Ãw_cÚÃùiÚ_id
.
¡©–ess_»£t_tok’
, 
tok’
, (token));

3766 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

3767 ++
pkt_num
, &
ä
);

3769 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

3771 
	`CU_ASSERT
(0 =ğ
rv
);

3773 
rv
 = 
	`ngtı2_cÚn_š™Ÿ‹_mig¿tiÚ
(
cÚn
, &
Ãw_·th
, ++
t
);

3775 
	`CU_ASSERT
(0 =ğ
rv
);

3776 
	`CU_ASSERT
(
NULL
 !ğ
cÚn
->
pv
);

3778 
¥k’
 = 
	`ngtı2_cÚn_wr™e_pkt
(
cÚn
, 
NULL
, 
buf
, (buf), 
t
);

3780 
	`CU_ASSERT
(
¥k’
 > 0);

3781 
	`CU_ASSERT
(
	`ngtı2_ršgbuf_Ën
(&
cÚn
->
pv
->
’ts
) > 0);

3783 
ä
.
ty³
 = 
NGTCP2_FRAME_PATH_RESPONSE
;

3784 
	`mem£t
(
ä
.
·th_»¥Ú£
.
d©a
, 0, (fr.path_response.data));

3786 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

3787 ++
pkt_num
, &
ä
);

3789 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
Ãw_·th
, 
buf
, 
pk’
, ++
t
);

3791 
	`CU_ASSERT
(0 =ğ
rv
);

3792 
	`CU_ASSERT
(
	`ngtı2_·th_eq
(&
Ãw_·th
, &
cÚn
->
dcid
.
·th
));

3793 
	`CU_ASSERT
(
	`ngtı2_cid_eq
(&
cid
, &
cÚn
->
dcid
.cid));

3795 
	`ngtı2_cÚn_d–
(
cÚn
);

3796 
	}
}

3798 
	$‹¡_ngtı2_cÚn_»cv_·th_ch®Ënge
() {

3799 
ngtı2_cÚn
 *
cÚn
;

3800 
ušt8_t
 
buf
[2048];

3801 
size_t
 
pk’
;

3802 
ssize_t
 
¥k’
;

3803 
ngtı2_t¡amp
 
t
 = 11;

3804 
ušt64_t
 
pkt_num
 = 0;

3805 
ngtı2_äame
 
ä
;

3806 
rv
;

3807 cÚ¡ 
ušt8_t
 
¿w_cid
[] = {0x0f, 0x00, 0x00, 0x00};

3808 
ngtı2_cid
 
cid
;

3809 cÚ¡ 
ušt8_t
 
tok’
[
NGTCP2_STATELESS_RESET_TOKENLEN
] = {0xff};

3810 cÚ¡ 
ušt8_t
 
d©a
[] = {0xf1, 0xf2, 0xf3, 0xf4, 0xf5, 0xf6, 0xf7, 0xf8};

3811 
ngtı2_·th_¡Üage
 
ps
;

3812 
ngtı2_dcid
 *
dcid
;

3814 
	`ngtı2_cid_š™
(&
cid
, 
¿w_cid
, (raw_cid));

3816 
	`£tup_deçuÉ_£rv”
(&
cÚn
);

3818 
ä
.
ty³
 = 
NGTCP2_FRAME_NEW_CONNECTION_ID
;

3819 
ä
.
Ãw_cÚÃùiÚ_id
.
£q
 = 1;

3820 
ä
.
Ãw_cÚÃùiÚ_id
.
cid
 = cid;

3821 
	`memıy
(
ä
.
Ãw_cÚÃùiÚ_id
.
¡©–ess_»£t_tok’
, 
tok’
, (token));

3823 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

3824 ++
pkt_num
, &
ä
);

3826 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
nuÎ_·th
, 
buf
, 
pk’
, ++
t
);

3828 
	`CU_ASSERT
(0 =ğ
rv
);

3830 
ä
.
ty³
 = 
NGTCP2_FRAME_PATH_CHALLENGE
;

3831 
	`memıy
(
ä
.
·th_ch®Ënge
.
d©a
, data, (fr.path_challenge.data));

3833 
pk’
 = 
	`wr™e_sšgË_äame_pkt
(
cÚn
, 
buf
, (buf), &cÚn->
oscid
,

3834 ++
pkt_num
, &
ä
);

3836 
rv
 = 
	`ngtı2_cÚn_»ad_pkt
(
cÚn
, &
Ãw_·th
, 
buf
, 
pk’
, ++
t
);

3838 
	`CU_ASSERT
(0 =ğ
rv
);

3839 
	`CU_ASSERT
(
	`ngtı2_ršgbuf_Ën
(&
cÚn
->
rx_·th_ch®Ënge
) > 0);

3841 
	`ngtı2_·th_¡Üage_z”o
(&
ps
);

3843 
¥k’
 = 
	`ngtı2_cÚn_wr™e_pkt
(
cÚn
, &
ps
.
·th
, 
buf
, (buf), ++
t
);

3845 
	`CU_ASSERT
(
¥k’
 > 0);

3846 
	`CU_ASSERT
(
	`ngtı2_·th_eq
(&
Ãw_·th
, &
ps
.
·th
));

3847 
	`CU_ASSERT
(0 =ğ
	`ngtı2_ršgbuf_Ën
(&
cÚn
->
rx_·th_ch®Ënge
));

3848 
	`CU_ASSERT
(1 =ğ
	`ngtı2_ršgbuf_Ën
(&
cÚn
->
bound_dcids
));

3850 
dcid
 = 
	`ngtı2_ršgbuf_g‘
(&
cÚn
->
bound_dcids
, 0);

3852 
	`CU_ASSERT
(
	`ngtı2_·th_eq
(&
Ãw_·th
, &
dcid
->
·th
));

3854 
	`ngtı2_cÚn_d–
(
cÚn
);

3855 
	}
}

	@tests/ngtcp2_conn_test.h

25 #iâdeà
NGTCP2_CONN_TEST_H


26 
	#NGTCP2_CONN_TEST_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
‹¡_ngtı2_cÚn_¡»am_İ’_şo£
();

33 
‹¡_ngtı2_cÚn_¡»am_rx_æow_cÚŒŞ
();

34 
‹¡_ngtı2_cÚn_¡»am_rx_æow_cÚŒŞ_”rÜ
();

35 
‹¡_ngtı2_cÚn_¡»am_tx_æow_cÚŒŞ
();

36 
‹¡_ngtı2_cÚn_rx_æow_cÚŒŞ
();

37 
‹¡_ngtı2_cÚn_rx_æow_cÚŒŞ_”rÜ
();

38 
‹¡_ngtı2_cÚn_tx_æow_cÚŒŞ
();

39 
‹¡_ngtı2_cÚn_shutdown_¡»am_wr™e
();

40 
‹¡_ngtı2_cÚn_»cv_»£t_¡»am
();

41 
‹¡_ngtı2_cÚn_»cv_¡İ_£ndšg
();

42 
‹¡_ngtı2_cÚn_»cv_cÚn_id_om™‹d
();

43 
‹¡_ngtı2_cÚn_shÜt_pkt_ty³
();

44 
‹¡_ngtı2_cÚn_»cv_¡©–ess_»£t
();

45 
‹¡_ngtı2_cÚn_»cv_»Œy
();

46 
‹¡_ngtı2_cÚn_»cv_d–ayed_hªdshake_pkt
();

47 
‹¡_ngtı2_cÚn_»cv_max_¡»ams
();

48 
‹¡_ngtı2_cÚn_hªdshake
();

49 
‹¡_ngtı2_cÚn_hªdshake_”rÜ
();

50 
‹¡_ngtı2_cÚn_ş›Á_wr™e_hªdshake
();

51 
‹¡_ngtı2_cÚn_»Œªsm™_´Ùeùed
();

52 
‹¡_ngtı2_cÚn_£nd_max_¡»am_d©a
();

53 
‹¡_ngtı2_cÚn_»cv_¡»am_d©a
();

54 
‹¡_ngtı2_cÚn_»cv_pšg
();

55 
‹¡_ngtı2_cÚn_»cv_max_¡»am_d©a
();

56 
‹¡_ngtı2_cÚn_£nd_—¾y_d©a
();

57 
‹¡_ngtı2_cÚn_»cv_—¾y_d©a
();

58 
‹¡_ngtı2_cÚn_»cv_compound_pkt
();

59 
‹¡_ngtı2_cÚn_pkt_·ylßdËn
();

60 
‹¡_ngtı2_cÚn_wr™ev_¡»am
();

61 
‹¡_ngtı2_cÚn_»cv_Ãw_cÚÃùiÚ_id
();

62 
‹¡_ngtı2_cÚn_»cv_»tœe_cÚÃùiÚ_id
();

63 
‹¡_ngtı2_cÚn_£rv”_·th_v®id©iÚ
();

64 
‹¡_ngtı2_cÚn_ş›Á_cÚÃùiÚ_mig¿tiÚ
();

65 
‹¡_ngtı2_cÚn_»cv_·th_ch®Ënge
();

	@tests/ngtcp2_conv_test.c

25 
	~"ngtı2_cÚv_‹¡.h
"

27 
	~<as£¹.h
>

29 
	~<CUn™/CUn™.h
>

31 
	~"ngtı2_cÚv.h
"

32 
	~"ngtı2_‹¡_h–³r.h
"

34 
	$‹¡_ngtı2_g‘_v¬št
() {

35 
ušt8_t
 
buf
[256];

36 
ušt8_t
 *
p
;

37 
size_t
 
Ä—d
;

38 
ušt64_t
 
n
;

41 
n
 = 1;

42 
p
 = 
	`ngtı2_put_v¬št
(
buf
, 0);

44 
	`CU_ASSERT
(1 =ğ
p
 - 
buf
);

46 
n
 = 
	`ngtı2_g‘_v¬št
(&
Ä—d
, 
buf
);

48 
	`CU_ASSERT
(1 =ğ
Ä—d
);

49 
	`CU_ASSERT
(0 =ğ
n
);

52 
n
 = 0;

53 
p
 = 
	`ngtı2_put_v¬št
(
buf
, 63);

55 
	`CU_ASSERT
(1 =ğ
p
 - 
buf
);

57 
n
 = 
	`ngtı2_g‘_v¬št
(&
Ä—d
, 
buf
);

59 
	`CU_ASSERT
(1 =ğ
Ä—d
);

60 
	`CU_ASSERT
(63 =ğ
n
);

63 
n
 = 0;

64 
p
 = 
	`ngtı2_put_v¬št
(
buf
, 64);

66 
	`CU_ASSERT
(2 =ğ
p
 - 
buf
);

68 
n
 = 
	`ngtı2_g‘_v¬št
(&
Ä—d
, 
buf
);

70 
	`CU_ASSERT
(2 =ğ
Ä—d
);

71 
	`CU_ASSERT
(64 =ğ
n
);

74 
n
 = 0;

75 
p
 = 
	`ngtı2_put_v¬št
(
buf
, 16383);

77 
	`CU_ASSERT
(2 =ğ
p
 - 
buf
);

79 
n
 = 
	`ngtı2_g‘_v¬št
(&
Ä—d
, 
buf
);

81 
	`CU_ASSERT
(2 =ğ
Ä—d
);

82 
	`CU_ASSERT
(16383 =ğ
n
);

85 
n
 = 0;

86 
p
 = 
	`ngtı2_put_v¬št
(
buf
, 16384);

88 
	`CU_ASSERT
(4 =ğ
p
 - 
buf
);

90 
n
 = 
	`ngtı2_g‘_v¬št
(&
Ä—d
, 
buf
);

92 
	`CU_ASSERT
(4 =ğ
Ä—d
);

93 
	`CU_ASSERT
(16384 =ğ
n
);

96 
n
 = 0;

97 
p
 = 
	`ngtı2_put_v¬št
(
buf
, 1073741823);

99 
	`CU_ASSERT
(4 =ğ
p
 - 
buf
);

101 
n
 = 
	`ngtı2_g‘_v¬št
(&
Ä—d
, 
buf
);

103 
	`CU_ASSERT
(4 =ğ
Ä—d
);

104 
	`CU_ASSERT
(1073741823 =ğ
n
);

107 
n
 = 0;

108 
p
 = 
	`ngtı2_put_v¬št
(
buf
, 1073741824);

110 
	`CU_ASSERT
(8 =ğ
p
 - 
buf
);

112 
n
 = 
	`ngtı2_g‘_v¬št
(&
Ä—d
, 
buf
);

114 
	`CU_ASSERT
(8 =ğ
Ä—d
);

115 
	`CU_ASSERT
(1073741824 =ğ
n
);

118 
n
 = 0;

119 
p
 = 
	`ngtı2_put_v¬št
(
buf
, 4611686018427387903ULL);

121 
	`CU_ASSERT
(8 =ğ
p
 - 
buf
);

123 
n
 = 
	`ngtı2_g‘_v¬št
(&
Ä—d
, 
buf
);

125 
	`CU_ASSERT
(8 =ğ
Ä—d
);

126 
	`CU_ASSERT
(4611686018427387903ULL =ğ
n
);

127 
	}
}

129 
	$‹¡_ngtı2_g‘_v¬št_Ën
() {

130 
ušt8_t
 
c
;

132 
c
 = 0x00;

134 
	`CU_ASSERT
(1 =ğ
	`ngtı2_g‘_v¬št_Ën
(&
c
));

136 
c
 = 0x40;

138 
	`CU_ASSERT
(2 =ğ
	`ngtı2_g‘_v¬št_Ën
(&
c
));

140 
c
 = 0x80;

142 
	`CU_ASSERT
(4 =ğ
	`ngtı2_g‘_v¬št_Ën
(&
c
));

144 
c
 = 0xc0;

146 
	`CU_ASSERT
(8 =ğ
	`ngtı2_g‘_v¬št_Ën
(&
c
));

147 
	}
}

149 
	$‹¡_ngtı2_put_v¬št_Ën
() {

150 
	`CU_ASSERT
(1 =ğ
	`ngtı2_put_v¬št_Ën
(0));

151 
	`CU_ASSERT
(1 =ğ
	`ngtı2_put_v¬št_Ën
(63));

152 
	`CU_ASSERT
(2 =ğ
	`ngtı2_put_v¬št_Ën
(64));

153 
	`CU_ASSERT
(2 =ğ
	`ngtı2_put_v¬št_Ën
(16383));

154 
	`CU_ASSERT
(4 =ğ
	`ngtı2_put_v¬št_Ën
(16384));

155 
	`CU_ASSERT
(4 =ğ
	`ngtı2_put_v¬št_Ën
(1073741823));

156 
	`CU_ASSERT
(8 =ğ
	`ngtı2_put_v¬št_Ën
(1073741824));

157 
	`CU_ASSERT
(8 =ğ
	`ngtı2_put_v¬št_Ën
(4611686018427387903ULL));

158 
	}
}

160 
	$‹¡_ngtı2_Áh_£rv”_bidi_id
() {

161 
	`CU_ASSERT
(0 =ğ
	`ngtı2_Áh_£rv”_bidi_id
(0));

162 
	`CU_ASSERT
(1 =ğ
	`ngtı2_Áh_£rv”_bidi_id
(1));

163 
	`CU_ASSERT
(5 =ğ
	`ngtı2_Áh_£rv”_bidi_id
(2));

164 
	`CU_ASSERT
(9 =ğ
	`ngtı2_Áh_£rv”_bidi_id
(3));

165 
	}
}

167 
	$‹¡_ngtı2_Áh_£rv”_uni_id
() {

168 
	`CU_ASSERT
(0 =ğ
	`ngtı2_Áh_£rv”_uni_id
(0));

169 
	`CU_ASSERT
(3 =ğ
	`ngtı2_Áh_£rv”_uni_id
(1));

170 
	`CU_ASSERT
(7 =ğ
	`ngtı2_Áh_£rv”_uni_id
(2));

171 
	`CU_ASSERT
(11 =ğ
	`ngtı2_Áh_£rv”_uni_id
(3));

172 
	}
}

174 
	$‹¡_ngtı2_Áh_ş›Á_bidi_id
() {

175 
	`CU_ASSERT
(0 =ğ
	`ngtı2_Áh_ş›Á_bidi_id
(0));

176 
	`CU_ASSERT
(0 =ğ
	`ngtı2_Áh_ş›Á_bidi_id
(1));

177 
	`CU_ASSERT
(4 =ğ
	`ngtı2_Áh_ş›Á_bidi_id
(2));

178 
	`CU_ASSERT
(8 =ğ
	`ngtı2_Áh_ş›Á_bidi_id
(3));

179 
	}
}

181 
	$‹¡_ngtı2_Áh_ş›Á_uni_id
() {

182 
	`CU_ASSERT
(0 =ğ
	`ngtı2_Áh_ş›Á_uni_id
(0));

183 
	`CU_ASSERT
(2 =ğ
	`ngtı2_Áh_ş›Á_uni_id
(1));

184 
	`CU_ASSERT
(6 =ğ
	`ngtı2_Áh_ş›Á_uni_id
(2));

185 
	`CU_ASSERT
(10 =ğ
	`ngtı2_Áh_ş›Á_uni_id
(3));

186 
	}
}

	@tests/ngtcp2_conv_test.h

25 #iâdeà
NGTCP2_CONV_TEST_H


26 
	#NGTCP2_CONV_TEST_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
‹¡_ngtı2_g‘_v¬št
();

33 
‹¡_ngtı2_g‘_v¬št_Ën
();

34 
‹¡_ngtı2_put_v¬št_Ën
();

35 
‹¡_ngtı2_Áh_£rv”_bidi_id
();

36 
‹¡_ngtı2_Áh_£rv”_uni_id
();

37 
‹¡_ngtı2_Áh_ş›Á_bidi_id
();

38 
‹¡_ngtı2_Áh_ş›Á_uni_id
();

	@tests/ngtcp2_crypto_test.c

25 
	~"ngtı2_üy±o_‹¡.h
"

27 
	~<as£¹.h
>

29 
	~<CUn™/CUn™.h
>

31 
	~"ngtı2_üy±o.h
"

32 
	~"ngtı2_cid.h
"

33 
	~"ngtı2_‹¡_h–³r.h
"

35 
	$‹¡_ngtı2_’code_Œª¥Üt_·¿ms
() {

36 
ngtı2_Œª¥Üt_·¿ms
 
·¿ms
, 
Å¬ams
;

37 
ušt8_t
 
buf
[512];

38 
ssize_t
 
nwr™e
;

39 
rv
;

40 
size_t
 
i
;

41 
ngtı2_cid
 
ocid
;

43 
	`dcid_š™
(&
ocid
);

45 
	`mem£t
(&
·¿ms
, 0, (params));

46 
	`mem£t
(&
Å¬ams
, 0, (nparams));

49 
·¿ms
.
v
.
ch
.
š™Ÿl_v”siÚ
 = 0xe1e2e3e4u;

50 
·¿ms
.
max_·ck‘_size
 = 
NGTCP2_MAX_PKT_SIZE
;

51 
·¿ms
.
ack_d–ay_expÚ’t
 = 
NGTCP2_DEFAULT_ACK_DELAY_EXPONENT
;

52 
·¿ms
.
max_ack_d–ay
 = 
NGTCP2_DEFAULT_MAX_ACK_DELAY
;

54 
nwr™e
 = 
	`ngtı2_’code_Œª¥Üt_·¿ms
(

55 
buf
, (buf), 
NGTCP2_TRANSPORT_PARAMS_TYPE_CLIENT_HELLO
, &
·¿ms
);

57 
	`CU_ASSERT
(4 + 2 =ğ
nwr™e
);

59 
rv
 = 
	`ngtı2_decode_Œª¥Üt_·¿ms
(

60 &
Å¬ams
, 
NGTCP2_TRANSPORT_PARAMS_TYPE_CLIENT_HELLO
, 
buf
, (
size_t
)
nwr™e
);

62 
	`CU_ASSERT
(0 =ğ
rv
);

63 
	`CU_ASSERT
(
·¿ms
.
v
.
ch
.
š™Ÿl_v”siÚ
 =ğ
Å¬ams
.v.ch.initial_version);

64 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»am_d©a_bidi_loÿl
 ==

65 
Å¬ams
.
š™Ÿl_max_¡»am_d©a_bidi_loÿl
);

66 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
 ==

67 
Å¬ams
.
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
);

68 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»am_d©a_uni
 ==

69 
Å¬ams
.
š™Ÿl_max_¡»am_d©a_uni
);

70 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_d©a
 =ğ
Å¬ams
.initial_max_data);

71 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»ams_bidi
 ==

72 
Å¬ams
.
š™Ÿl_max_¡»ams_bidi
);

73 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»ams_uni
 =ğ
Å¬ams
.initial_max_streams_uni);

74 
	`CU_ASSERT
(
·¿ms
.
idË_timeout
 =ğ
Å¬ams
.idle_timeout);

75 
	`CU_ASSERT
(
·¿ms
.
max_·ck‘_size
 =ğ
Å¬ams
.max_packet_size);

76 
	`CU_ASSERT
(
·¿ms
.
ack_d–ay_expÚ’t
 =ğ
Å¬ams
.ack_delay_exponent);

77 
	`CU_ASSERT
(
·¿ms
.
¡©–ess_»£t_tok’_´e£Á
 ==

78 
Å¬ams
.
¡©–ess_»£t_tok’_´e£Á
);

79 
	`CU_ASSERT
(
·¿ms
.
di§bË_mig¿tiÚ
 =ğ
Å¬ams
.disable_migration);

80 
	`CU_ASSERT
(
·¿ms
.
max_ack_d–ay
 =ğ
Å¬ams
.max_ack_delay);

82 
	`mem£t
(&
·¿ms
, 0, (params));

83 
	`mem£t
(&
Å¬ams
, 0, (nparams));

86 
·¿ms
.
v
.
“
.
ÃgÙŸ‹d_v”siÚ
 = 0xf1f2f3f4u;

87 
·¿ms
.
v
.
“
.
suµÜ‹d_v”siÚs
[0] = 0xd1d2d3d4u;

88 
·¿ms
.
v
.
“
.
suµÜ‹d_v”siÚs
[1] = 0xe1e2e3e4u;

89 
·¿ms
.
v
.
“
.
suµÜ‹d_v”siÚs
[2] = 0xf1f2f3f4u;

90 
·¿ms
.
v
.
“
.
Ën
 = 3;

91 
·¿ms
.
max_·ck‘_size
 = 
NGTCP2_MAX_PKT_SIZE
;

92 
·¿ms
.
ack_d–ay_expÚ’t
 = 
NGTCP2_DEFAULT_ACK_DELAY_EXPONENT
;

93 
·¿ms
.
max_ack_d–ay
 = 
NGTCP2_DEFAULT_MAX_ACK_DELAY
;

95 
nwr™e
 = 
	`ngtı2_’code_Œª¥Üt_·¿ms
(

96 
buf
, (buf), 
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
,

97 &
·¿ms
);

99 
	`CU_ASSERT
(4 + 1 +

101 
nwr™e
);

103 
rv
 = 
	`ngtı2_decode_Œª¥Üt_·¿ms
(

104 &
Å¬ams
, 
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
, 
buf
,

105 (
size_t
)
nwr™e
);

107 
	`CU_ASSERT
(0 =ğ
rv
);

108 
	`CU_ASSERT
(
·¿ms
.
v
.
“
.
ÃgÙŸ‹d_v”siÚ
 =ğ
Å¬ams
.v.ee.negotiated_version);

109 
	`CU_ASSERT
(
·¿ms
.
v
.
“
.
Ën
 =ğ
Å¬ams
.v.ee.len);

110 
i
 = 0; i < 3; ++i) {

111 
	`CU_ASSERT
(
·¿ms
.
v
.
“
.
suµÜ‹d_v”siÚs
[
i
] ==

112 
Å¬ams
.
v
.
“
.
suµÜ‹d_v”siÚs
[
i
]);

114 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»am_d©a_bidi_loÿl
 ==

115 
Å¬ams
.
š™Ÿl_max_¡»am_d©a_bidi_loÿl
);

116 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
 ==

117 
Å¬ams
.
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
);

118 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»am_d©a_uni
 ==

119 
Å¬ams
.
š™Ÿl_max_¡»am_d©a_uni
);

120 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_d©a
 =ğ
Å¬ams
.initial_max_data);

121 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»ams_bidi
 ==

122 
Å¬ams
.
š™Ÿl_max_¡»ams_bidi
);

123 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»ams_uni
 =ğ
Å¬ams
.initial_max_streams_uni);

124 
	`CU_ASSERT
(
·¿ms
.
idË_timeout
 =ğ
Å¬ams
.idle_timeout);

125 
	`CU_ASSERT
(
·¿ms
.
max_·ck‘_size
 =ğ
Å¬ams
.max_packet_size);

126 
	`CU_ASSERT
(
·¿ms
.
¡©–ess_»£t_tok’_´e£Á
 ==

127 
Å¬ams
.
¡©–ess_»£t_tok’_´e£Á
);

128 
	`CU_ASSERT
(
·¿ms
.
ack_d–ay_expÚ’t
 =ğ
Å¬ams
.ack_delay_exponent);

129 
	`CU_ASSERT
(
·¿ms
.
di§bË_mig¿tiÚ
 =ğ
Å¬ams
.disable_migration);

130 
	`CU_ASSERT
(
·¿ms
.
max_ack_d–ay
 =ğ
Å¬ams
.max_ack_delay);

132 
	`mem£t
(&
·¿ms
, 0, (params));

133 
	`mem£t
(&
Å¬ams
, 0, (nparams));

136 
·¿ms
.
v
.
ch
.
š™Ÿl_v”siÚ
 = 0xe1e2e3e4u;

137 
·¿ms
.
š™Ÿl_max_¡»am_d©a_bidi_loÿl
 = 1000000007;

138 
·¿ms
.
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
 = 961748941;

139 
·¿ms
.
š™Ÿl_max_¡»am_d©a_uni
 = 982451653;

140 
·¿ms
.
š™Ÿl_max_d©a
 = 1000000009;

141 
·¿ms
.
š™Ÿl_max_¡»ams_bidi
 = 909;

142 
·¿ms
.
š™Ÿl_max_¡»ams_uni
 = 911;

143 
·¿ms
.
idË_timeout
 = 1023;

144 
·¿ms
.
max_·ck‘_size
 = 1400;

145 
·¿ms
.
ack_d–ay_expÚ’t
 = 20;

146 
·¿ms
.
di§bË_mig¿tiÚ
 = 1;

147 
·¿ms
.
max_ack_d–ay
 = 59;

149 
i
 = 0;

150 
i
 < 4 + 2 + 8 * 4 + 6 * 2 + 6 + 6 + 5 + 4 + 5;

151 ++
i
) {

152 
nwr™e
 = 
	`ngtı2_’code_Œª¥Üt_·¿ms
(

153 
buf
, 
i
, 
NGTCP2_TRANSPORT_PARAMS_TYPE_CLIENT_HELLO
, &
·¿ms
);

154 
	`CU_ASSERT
(
NGTCP2_ERR_NOBUF
 =ğ
nwr™e
);

156 
nwr™e
 = 
	`ngtı2_’code_Œª¥Üt_·¿ms
(

157 
buf
, 
i
, 
NGTCP2_TRANSPORT_PARAMS_TYPE_CLIENT_HELLO
, &
·¿ms
);

159 
	`CU_ASSERT
((
ssize_t
)
i
 =ğ
nwr™e
);

161 
i
 = 0; (
ssize_t
)˜< 
nwr™e
; ++i) {

162 
rv
 = 
	`ngtı2_decode_Œª¥Üt_·¿ms
(

163 &
Å¬ams
, 
NGTCP2_TRANSPORT_PARAMS_TYPE_CLIENT_HELLO
, 
buf
, 
i
);

165 
	`CU_ASSERT
(
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
 =ğ
rv
);

168 
rv
 = 
	`ngtı2_decode_Œª¥Üt_·¿ms
(

169 &
Å¬ams
, 
NGTCP2_TRANSPORT_PARAMS_TYPE_CLIENT_HELLO
, 
buf
, (
size_t
)
nwr™e
);

171 
	`CU_ASSERT
(0 =ğ
rv
);

172 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»am_d©a_bidi_loÿl
 ==

173 
Å¬ams
.
š™Ÿl_max_¡»am_d©a_bidi_loÿl
);

174 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
 ==

175 
Å¬ams
.
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
);

176 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»am_d©a_uni
 ==

177 
Å¬ams
.
š™Ÿl_max_¡»am_d©a_uni
);

178 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_d©a
 =ğ
Å¬ams
.initial_max_data);

179 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»ams_bidi
 ==

180 
Å¬ams
.
š™Ÿl_max_¡»ams_bidi
);

181 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»ams_uni
 =ğ
Å¬ams
.initial_max_streams_uni);

182 
	`CU_ASSERT
(
·¿ms
.
idË_timeout
 =ğ
Å¬ams
.idle_timeout);

183 
	`CU_ASSERT
(
·¿ms
.
max_·ck‘_size
 =ğ
Å¬ams
.max_packet_size);

184 
	`CU_ASSERT
(
·¿ms
.
ack_d–ay_expÚ’t
 =ğ
Å¬ams
.ack_delay_exponent);

185 
	`CU_ASSERT
(
·¿ms
.
di§bË_mig¿tiÚ
 =ğ
Å¬ams
.disable_migration);

186 
	`CU_ASSERT
(
·¿ms
.
max_ack_d–ay
 =ğ
Å¬ams
.max_ack_delay);

188 
	`mem£t
(&
·¿ms
, 0, (params));

189 
	`mem£t
(&
Å¬ams
, 0, (nparams));

192 
·¿ms
.
v
.
“
.
ÃgÙŸ‹d_v”siÚ
 = 0xf1f2f3f4u;

193 
·¿ms
.
v
.
“
.
suµÜ‹d_v”siÚs
[0] = 0xd1d2d3d4u;

194 
·¿ms
.
v
.
“
.
suµÜ‹d_v”siÚs
[1] = 0xe1e2e3e4u;

195 
·¿ms
.
v
.
“
.
suµÜ‹d_v”siÚs
[2] = 0xf1f2f3f4u;

196 
·¿ms
.
v
.
“
.
Ën
 = 3;

197 
·¿ms
.
š™Ÿl_max_¡»am_d©a_bidi_loÿl
 = 1000000007;

198 
·¿ms
.
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
 = 961748941;

199 
·¿ms
.
š™Ÿl_max_¡»am_d©a_uni
 = 982451653;

200 
·¿ms
.
š™Ÿl_max_d©a
 = 1000000009;

201 
·¿ms
.
š™Ÿl_max_¡»ams_bidi
 = 908;

202 
·¿ms
.
š™Ÿl_max_¡»ams_uni
 = 16383;

203 
·¿ms
.
idË_timeout
 = 16363;

204 
·¿ms
.
max_·ck‘_size
 = 1200;

205 
·¿ms
.
¡©–ess_»£t_tok’_´e£Á
 = 1;

206 
	`mem£t
(
·¿ms
.
¡©–ess_»£t_tok’
, 0xf1,

207 (
·¿ms
.
¡©–ess_»£t_tok’
));

208 
·¿ms
.
ack_d–ay_expÚ’t
 = 20;

209 
·¿ms
.
´eã¼ed_add»ss
.
_v”siÚ
 = 
NGTCP2_IP_VERSION_6
;

210 
·¿ms
.
´eã¼ed_add»ss
.
_add»s¦’
 = 255;

211 
	`mem£t
(
·¿ms
.
´eã¼ed_add»ss
.
_add»ss
, 0xe1,

212 
·¿ms
.
´eã¼ed_add»ss
.
_add»s¦’
);

213 
·¿ms
.
´eã¼ed_add»ss
.
pÜt
 = 63111;

214 
	`scid_š™
(&
·¿ms
.
´eã¼ed_add»ss
.
cid
);

215 
	`mem£t
(
·¿ms
.
´eã¼ed_add»ss
.
¡©–ess_»£t_tok’
, 0xd1,

216 (
·¿ms
.
´eã¼ed_add»ss
.
¡©–ess_»£t_tok’
));

217 
·¿ms
.
di§bË_mig¿tiÚ
 = 1;

218 
·¿ms
.
max_ack_d–ay
 = 63;

219 
·¿ms
.
Üigš®_cÚÃùiÚ_id_´e£Á
 = 1;

220 
·¿ms
.
Üigš®_cÚÃùiÚ_id
 = 
ocid
;

222 
i
 = 0;

223 
i
 < 4 + 1 +

226 (4 + 1 + 1 + 255 + 2 + 1 + 
·¿ms
.
´eã¼ed_add»ss
.
cid
.
d©®’
 +

227 
NGTCP2_STATELESS_RESET_TOKENLEN
) +

228 4 + 4 + 
·¿ms
.
Üigš®_cÚÃùiÚ_id
.
d©®’
;

229 ++
i
) {

230 
nwr™e
 = 
	`ngtı2_’code_Œª¥Üt_·¿ms
(

231 
buf
, 
i
, 
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
, &
·¿ms
);

233 
	`CU_ASSERT
(
NGTCP2_ERR_NOBUF
 =ğ
nwr™e
);

235 
nwr™e
 = 
	`ngtı2_’code_Œª¥Üt_·¿ms
(

236 
buf
, 
i
, 
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
, &
·¿ms
);

238 
	`CU_ASSERT
((
ssize_t
)
i
 =ğ
nwr™e
);

240 
i
 = 0; (
ssize_t
)˜< 
nwr™e
; ++i) {

241 
rv
 = 
	`ngtı2_decode_Œª¥Üt_·¿ms
(

242 &
Å¬ams
, 
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
, 
buf
, 
i
);

244 
	`CU_ASSERT
(
rv
 =ğ
NGTCP2_ERR_MALFORMED_TRANSPORT_PARAM
);

247 
rv
 = 
	`ngtı2_decode_Œª¥Üt_·¿ms
(

248 &
Å¬ams
, 
NGTCP2_TRANSPORT_PARAMS_TYPE_ENCRYPTED_EXTENSIONS
, 
buf
,

249 (
size_t
)
nwr™e
);

251 
	`CU_ASSERT
(0 =ğ
rv
);

252 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»am_d©a_bidi_loÿl
 ==

253 
Å¬ams
.
š™Ÿl_max_¡»am_d©a_bidi_loÿl
);

254 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
 ==

255 
Å¬ams
.
š™Ÿl_max_¡»am_d©a_bidi_»mÙe
);

256 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»am_d©a_uni
 ==

257 
Å¬ams
.
š™Ÿl_max_¡»am_d©a_uni
);

258 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_d©a
 =ğ
Å¬ams
.initial_max_data);

259 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»ams_bidi
 ==

260 
Å¬ams
.
š™Ÿl_max_¡»ams_bidi
);

261 
	`CU_ASSERT
(
·¿ms
.
š™Ÿl_max_¡»ams_uni
 =ğ
Å¬ams
.initial_max_streams_uni);

262 
	`CU_ASSERT
(
·¿ms
.
idË_timeout
 =ğ
Å¬ams
.idle_timeout);

263 
	`CU_ASSERT
(
·¿ms
.
max_·ck‘_size
 =ğ
Å¬ams
.max_packet_size);

264 
	`CU_ASSERT
(0 =ğ
	`memcmp
(
·¿ms
.
¡©–ess_»£t_tok’
,

265 
Å¬ams
.
¡©–ess_»£t_tok’
,

266 (
·¿ms
.
¡©–ess_»£t_tok’
)));

267 
	`CU_ASSERT
(
·¿ms
.
ack_d–ay_expÚ’t
 =ğ
Å¬ams
.ack_delay_exponent);

268 
	`CU_ASSERT
(
·¿ms
.
´eã¼ed_add»ss
.
_v”siÚ
 ==

269 
Å¬ams
.
´eã¼ed_add»ss
.
_v”siÚ
);

270 
	`CU_ASSERT
(
·¿ms
.
´eã¼ed_add»ss
.
_add»s¦’
 ==

271 
Å¬ams
.
´eã¼ed_add»ss
.
_add»s¦’
);

272 
	`CU_ASSERT
(0 =ğ
	`memcmp
(
·¿ms
.
´eã¼ed_add»ss
.
_add»ss
,

273 
Å¬ams
.
´eã¼ed_add»ss
.
_add»ss
,

274 
·¿ms
.
´eã¼ed_add»ss
.
_add»s¦’
));

275 
	`CU_ASSERT
(
·¿ms
.
´eã¼ed_add»ss
.
pÜt
 =ğ
Å¬ams
.preferred_address.port);

276 
	`CU_ASSERT
(
	`ngtı2_cid_eq
(&
·¿ms
.
´eã¼ed_add»ss
.
cid
,

277 &
Å¬ams
.
´eã¼ed_add»ss
.
cid
));

278 
	`CU_ASSERT
(0 ==

279 
	`memcmp
(
·¿ms
.
´eã¼ed_add»ss
.
¡©–ess_»£t_tok’
,

280 
Å¬ams
.
´eã¼ed_add»ss
.
¡©–ess_»£t_tok’
,

281 (
·¿ms
.
´eã¼ed_add»ss
.
¡©–ess_»£t_tok’
)));

282 
	`CU_ASSERT
(
·¿ms
.
di§bË_mig¿tiÚ
 =ğ
Å¬ams
.disable_migration);

283 
	`CU_ASSERT
(
·¿ms
.
max_ack_d–ay
 =ğ
Å¬ams
.max_ack_delay);

284 
	`CU_ASSERT
(
·¿ms
.
Üigš®_cÚÃùiÚ_id_´e£Á
 ==

285 
Å¬ams
.
Üigš®_cÚÃùiÚ_id_´e£Á
);

286 
	`CU_ASSERT
(
	`ngtı2_cid_eq
(&
·¿ms
.
Üigš®_cÚÃùiÚ_id
,

287 &
Å¬ams
.
Üigš®_cÚÃùiÚ_id
));

288 
	}
}

	@tests/ngtcp2_crypto_test.h

25 #iâdeà
NGTCP2_CRYPTO_TEST_H


26 
	#NGTCP2_CRYPTO_TEST_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
‹¡_ngtı2_’code_Œª¥Üt_·¿ms
();

	@tests/ngtcp2_gaptr_test.c

25 
	~"ngtı2_g­Œ_‹¡.h
"

27 
	~<CUn™/CUn™.h
>

29 
	~"ngtı2_g­Œ.h
"

30 
	~"ngtı2_‹¡_h–³r.h
"

31 
	~"ngtı2_mem.h
"

33 
	$‹¡_ngtı2_g­Œ_push
() {

34 
ngtı2_g­Œ
 
g­Œ
;

35 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

36 
ngtı2_p¦_™
 
™
;

37 
ngtı2_¿nge
 
r
;

38 
rv
;

39 
size_t
 
i
;

41 
	`ngtı2_g­Œ_š™
(&
g­Œ
, 
mem
);

43 
™
 = 
	`ngtı2_p¦_begš
(&
g­Œ
.
g­
);

44 
r
 = 
	`ngtı2_p¦_™_¿nge
(&
™
);

46 
	`CU_ASSERT
(0 =ğ
r
.
begš
);

47 
	`CU_ASSERT
(
UINT64_MAX
 =ğ
r
.
’d
);

49 
rv
 = 
	`ngtı2_g­Œ_push
(&
g­Œ
, 0, 1);

51 
	`CU_ASSERT
(0 =ğ
rv
);

53 
™
 = 
	`ngtı2_p¦_begš
(&
g­Œ
.
g­
);

54 
r
 = 
	`ngtı2_p¦_™_¿nge
(&
™
);

56 
	`CU_ASSERT
(1 =ğ
r
.
begš
);

57 
	`CU_ASSERT
(
UINT64_MAX
 =ğ
r
.
’d
);

59 
rv
 = 
	`ngtı2_g­Œ_push
(&
g­Œ
, 12389, 133);

61 
	`CU_ASSERT
(0 =ğ
rv
);

63 
™
 = 
	`ngtı2_p¦_begš
(&
g­Œ
.
g­
);

64 
r
 = 
	`ngtı2_p¦_™_¿nge
(&
™
);

66 
	`CU_ASSERT
(1 =ğ
r
.
begš
);

67 
	`CU_ASSERT
(12389 =ğ
r
.
’d
);

69 
	`ngtı2_p¦_™_Ãxt
(&
™
);

70 
r
 = 
	`ngtı2_p¦_™_¿nge
(&
™
);

72 
	`CU_ASSERT
(12389 + 133 =ğ
r
.
begš
);

73 
	`CU_ASSERT
(
UINT64_MAX
 =ğ
r
.
’d
);

75 
i
 = 0; i < 2; ++i) {

76 
rv
 = 
	`ngtı2_g­Œ_push
(&
g­Œ
, 1, 12389);

78 
	`CU_ASSERT
(0 =ğ
rv
);

80 
™
 = 
	`ngtı2_p¦_begš
(&
g­Œ
.
g­
);

81 
r
 = 
	`ngtı2_p¦_™_¿nge
(&
™
);

83 
	`CU_ASSERT
(12389 + 133 =ğ
r
.
begš
);

84 
	`CU_ASSERT
(
UINT64_MAX
 =ğ
r
.
’d
);

87 
rv
 = 
	`ngtı2_g­Œ_push
(&
g­Œ
, 12389 + 133 - 1, 2);

89 
	`CU_ASSERT
(0 =ğ
rv
);

91 
™
 = 
	`ngtı2_p¦_begš
(&
g­Œ
.
g­
);

92 
r
 = 
	`ngtı2_p¦_™_¿nge
(&
™
);

94 
	`CU_ASSERT
(12389 + 133 + 1 =ğ
r
.
begš
);

95 
	`CU_ASSERT
(
UINT64_MAX
 =ğ
r
.
’d
);

97 
	`ngtı2_g­Œ_ä“
(&
g­Œ
);

98 
	}
}

100 
	$‹¡_ngtı2_g­Œ_is_pushed
() {

101 
ngtı2_g­Œ
 
g­Œ
;

102 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

103 
rv
;

105 
	`ngtı2_g­Œ_š™
(&
g­Œ
, 
mem
);

107 
rv
 = 
	`ngtı2_g­Œ_push
(&
g­Œ
, 1000000007, 1009);

109 
	`CU_ASSERT
(0 =ğ
rv
);

110 
	`CU_ASSERT
(
	`ngtı2_g­Œ_is_pushed
(&
g­Œ
, 1000000007, 1009));

111 
	`CU_ASSERT
(!
	`ngtı2_g­Œ_is_pushed
(&
g­Œ
, 1000000007, 1010));

113 
	`ngtı2_g­Œ_ä“
(&
g­Œ
);

114 
	}
}

	@tests/ngtcp2_gaptr_test.h

25 #iâdeà
NGTCP2_GAPTR_TEST_H


26 
	#NGTCP2_GAPTR_TEST_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
‹¡_ngtı2_g­Œ_push
();

33 
‹¡_ngtı2_g­Œ_is_pushed
();

	@tests/ngtcp2_idtr_test.c

25 
	~"ngtı2_idŒ_‹¡.h
"

27 
	~<CUn™/CUn™.h
>

29 
	~"ngtı2_idŒ.h
"

30 
	~"ngtı2_‹¡_h–³r.h
"

31 
	~"ngtı2_mem.h
"

33 
ušt64_t
 
	$¡»am_id_äom_id
(
ušt64_t
 
id
è{  id * 4; 
	}
}

35 
	$‹¡_ngtı2_idŒ_İ’
() {

36 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

37 
ngtı2_idŒ
 
idŒ
;

38 
rv
;

39 
ngtı2_p¦_™
 
™
;

40 
ngtı2_¿nge
 
key
;

42 
rv
 = 
	`ngtı2_idŒ_š™
(&
idŒ
, 0, 
mem
);

44 
	`CU_ASSERT
(0 =ğ
rv
);

46 
rv
 = 
	`ngtı2_idŒ_İ’
(&
idŒ
, 
	`¡»am_id_äom_id
(0));

48 
	`CU_ASSERT
(0 =ğ
rv
);

50 
™
 = 
	`ngtı2_p¦_begš
(&
idŒ
.
g­
.gap);

51 
key
 = 
	`ngtı2_p¦_™_¿nge
(&
™
);

53 
	`CU_ASSERT
(1 =ğ
key
.
begš
);

54 
	`CU_ASSERT
(
UINT64_MAX
 =ğ
key
.
’d
);

56 
rv
 = 
	`ngtı2_idŒ_İ’
(&
idŒ
, 
	`¡»am_id_äom_id
(1000000007));

58 
	`CU_ASSERT
(0 =ğ
rv
);

60 
™
 = 
	`ngtı2_p¦_begš
(&
idŒ
.
g­
.gap);

61 
key
 = 
	`ngtı2_p¦_™_¿nge
(&
™
);

63 
	`CU_ASSERT
(1 =ğ
key
.
begš
);

64 
	`CU_ASSERT
(1000000007 =ğ
key
.
’d
);

66 
	`ngtı2_p¦_™_Ãxt
(&
™
);

67 
key
 = 
	`ngtı2_p¦_™_¿nge
(&
™
);

69 
	`CU_ASSERT
(1000000008 =ğ
key
.
begš
);

70 
	`CU_ASSERT
(
UINT64_MAX
 =ğ
key
.
’d
);

72 
rv
 = 
	`ngtı2_idŒ_İ’
(&
idŒ
, 
	`¡»am_id_äom_id
(0));

74 
	`CU_ASSERT
(
NGTCP2_ERR_STREAM_IN_USE
 =ğ
rv
);

76 
rv
 = 
	`ngtı2_idŒ_İ’
(&
idŒ
, 
	`¡»am_id_äom_id
(1000000007));

78 
	`CU_ASSERT
(
NGTCP2_ERR_STREAM_IN_USE
 =ğ
rv
);

80 
	`ngtı2_idŒ_ä“
(&
idŒ
);

81 
	}
}

	@tests/ngtcp2_idtr_test.h

25 #iâdeà
NGTCP2_IDTR_TEST_H


26 
	#NGTCP2_IDTR_TEST_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
‹¡_ngtı2_idŒ_İ’
();

	@tests/ngtcp2_ksl_test.c

25 
	~"ngtı2_k¦_‹¡.h
"

27 
	~<CUn™/CUn™.h
>

29 
	~"ngtı2_k¦.h
"

30 
	~"ngtı2_‹¡_h–³r.h
"

32 
	$Ëss
(cÚ¡ 
ngtı2_k¦_key
 *
lhs
, cÚ¡‚gtı2_k¦_key *
rhs
) {

33  
lhs
->
i
 < 
rhs
->i;

34 
	}
}

36 
ngtı2_k¦_key
 
	gšf_key
 = {
INT64_MAX
};

38 
	$‹¡_ngtı2_k¦_š£¹
() {

39 cÚ¡ 
št64_t
 
keys
[] = {10, 3, 8, 11, 16, 12, 1, 5, 4,

41 
ngtı2_k¦
 
k¦
;

42 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

43 
size_t
 
i
;

44 
ngtı2_k¦_™
 
™
;

45 
ngtı2_k¦_key
 
key
;

47 
	`ngtı2_k¦_š™
(&
k¦
, 
Ëss
, &
šf_key
, 
mem
);

49 
i
 = 0; i < 
	`¬¿yËn
(
keys
); ++i) {

50 
	`ngtı2_k¦_š£¹
(&
k¦
, 
NULL
, (cÚ¡ 
ngtı2_k¦_key
 *)&
keys
[
i
], NULL);

51 
™
 = 
	`ngtı2_k¦_low”_bound
(&
k¦
, (cÚ¡ 
ngtı2_k¦_key
 *)&
keys
[
i
]);

53 
	`CU_ASSERT
(
keys
[
i
] =ğ
	`ngtı2_k¦_™_key
(&
™
).i);

56 
i
 = 0; i < 
	`¬¿yËn
(
keys
); ++i) {

57 
	`ngtı2_k¦_»move
(&
k¦
, 
NULL
, (cÚ¡ 
ngtı2_k¦_key
 *)&
keys
[
i
]);

58 
™
 = 
	`ngtı2_k¦_low”_bound
(&
k¦
, (cÚ¡ 
ngtı2_k¦_key
 *)&
keys
[
i
]);

59 
key
 = 
	`ngtı2_k¦_™_key
(&
™
);

61 
	`CU_ASSERT
(
keys
[
i
] < 
key
.i);

64 
	`ngtı2_k¦_ä“
(&
k¦
);

67 
	`ngtı2_k¦_š™
(&
k¦
, 
Ëss
, &
šf_key
, 
mem
);

69 
i
 = 0; i < 16; ++i) {

70 
	`ngtı2_k¦_š£¹
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, (
št64_t
)
i
), NULL);

75 
	`ngtı2_k¦_»move
(&
k¦
, &
™
, 
	`ngtı2_k¦_key_i
(&
key
, 7));

77 
	`CU_ASSERT
(8 =ğ
	`ngtı2_k¦_™_key
(&
™
).
i
);

79 
™
 = 
	`ngtı2_k¦_low”_bound
(&
k¦
, 
	`ngtı2_k¦_key_i
(&
key
, 8));

81 
	`CU_ASSERT
(8 =ğ
	`ngtı2_k¦_™_key
(&
™
).
i
);

82 
	`CU_ASSERT
(8 =ğ
k¦
.
h—d
->
nodes
[0].
key
.
i
);

84 
	`ngtı2_k¦_ä“
(&
k¦
);

88 
	`ngtı2_k¦_š™
(&
k¦
, 
Ëss
, &
šf_key
, 
mem
);

90 
i
 = 0; i < 120; ++i) {

91 
	`ngtı2_k¦_š£¹
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, (
št64_t
)
i
), NULL);

94 
	`ngtı2_k¦_»move
(&
k¦
, &
™
, 
	`ngtı2_k¦_key_i
(&
key
, 63));

96 
	`CU_ASSERT
(64 =ğ
	`ngtı2_k¦_™_key
(&
™
).
i
);

98 
™
 = 
	`ngtı2_k¦_low”_bound
(&
k¦
, 
	`ngtı2_k¦_key_i
(&
key
, 63));

100 
	`CU_ASSERT
(64 =ğ
	`ngtı2_k¦_™_key
(&
™
).
i
);

102 
	`ngtı2_k¦_ä“
(&
k¦
);

105 
	`ngtı2_k¦_š™
(&
k¦
, 
Ëss
, &
šf_key
, 
mem
);

107 
i
 = 0; i < 15; ++i) {

108 
	`ngtı2_k¦_š£¹
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, (
št64_t
)
i
), NULL);

112 
	`ngtı2_k¦_»move
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, 6));

113 
	`ngtı2_k¦_»move
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, 7));

114 
	`ngtı2_k¦_»move
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, 8));

116 
	`CU_ASSERT
(13 =ğ
k¦
.
h—d
->
n
);

118 
	`ngtı2_k¦_ä“
(&
k¦
);

121 
	`ngtı2_k¦_š™
(&
k¦
, 
Ëss
, &
šf_key
, 
mem
);

123 
i
 = 0; i < 15 + 8; ++i) {

124 
	`ngtı2_k¦_š£¹
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, (
št64_t
)
i
), NULL);

128 
	`ngtı2_k¦_»move
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, 6));

129 
	`ngtı2_k¦_»move
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, 5));

130 
	`ngtı2_k¦_»move
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, 8));

132 
	`CU_ASSERT
(2 =ğ
k¦
.
h—d
->
n
);

133 
	`CU_ASSERT
(13 =ğ
k¦
.
h—d
->
nodes
[0].
blk
->
n
);

134 
	`CU_ASSERT
(8 =ğ
k¦
.
h—d
->
nodes
[1].
blk
->
n
);

136 
	`ngtı2_k¦_ä“
(&
k¦
);

139 
	`ngtı2_k¦_š™
(&
k¦
, 
Ëss
, &
šf_key
, 
mem
);

142 
i
 = 0; i < 100; ++i) {

143 
	`ngtı2_k¦_š£¹
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, (
št64_t
)
i
), NULL);

147 
i
 = 0; i < 50; ++i) {

148 
	`ngtı2_k¦_»move
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, (
št64_t
)
i
));

151 
i
 = 99;

152 
™
 = 
	`ngtı2_k¦_’d
(&
k¦
); !
	`ngtı2_k¦_™_begš
(&it);) {

153 
	`ngtı2_k¦_™_´ev
(&
™
);

155 
	`CU_ASSERT
((
št64_t
)
i
-- =ğ
	`ngtı2_k¦_™_key
(&
™
).i);

159 
i
 = 50; i < 88; ++i) {

160 
	`ngtı2_k¦_»move
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, (
št64_t
)
i
));

163 
i
 = 99;

164 
™
 = 
	`ngtı2_k¦_’d
(&
k¦
); !
	`ngtı2_k¦_™_begš
(&it);) {

165 
	`ngtı2_k¦_™_´ev
(&
™
);

167 
	`CU_ASSERT
((
št64_t
)
i
-- =ğ
	`ngtı2_k¦_™_key
(&
™
).i);

170 
	`ngtı2_k¦_ä“
(&
k¦
);

173 
	`ngtı2_k¦_š™
(&
k¦
, 
Ëss
, &
šf_key
, 
mem
);

175 
i
 = 0; i < 7609; ++i) {

176 
	`ngtı2_k¦_š£¹
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, (
št64_t
)
i
), NULL);

179 
	`ngtı2_k¦_»move
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, 999));

181 
	`CU_ASSERT
(2 =ğ
k¦
.
h—d
->
n
);

183 
	`ngtı2_k¦_ä“
(&
k¦
);

186 
	`ngtı2_k¦_š™
(&
k¦
, 
Ëss
, &
šf_key
, 
mem
);

188 
i
 = 0; i < 22; ++i) {

189 
	`ngtı2_k¦_š£¹
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, (
št64_t
)
i
), NULL);

192 
	`CU_ASSERT
(2 =ğ
k¦
.
h—d
->
n
);

194 
	`ngtı2_k¦_»move
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, 21));

196 
	`CU_ASSERT
(3 =ğ
k¦
.
h—d
->
n
);

198 
	`ngtı2_k¦_ä“
(&
k¦
);

201 
	`ngtı2_k¦_š™
(&
k¦
, 
Ëss
, &
šf_key
, 
mem
);

203 
i
 = 1; i < 1500; i += 100) {

204 
	`ngtı2_k¦_š£¹
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, (
št64_t
)
i
), NULL);

207 
	`ngtı2_k¦_»move
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, 1401));

208 
	`ngtı2_k¦_»move
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, 1301));

210 
	`CU_ASSERT
(701 =ğ
k¦
.
h—d
->
nodes
[1].
blk
->nodes[0].
key
.
i
);

212 
	`ngtı2_k¦_ä“
(&
k¦
);

215 
	`ngtı2_k¦_š™
(&
k¦
, 
Ëss
, &
šf_key
, 
mem
);

217 
i
 = 0; i < 15; ++i) {

218 
	`ngtı2_k¦_š£¹
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, (
št64_t
)
i
), NULL);

221 
	`ngtı2_k¦_»move
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, 6));

222 
	`ngtı2_k¦_»move
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, 5));

224 
	`CU_ASSERT
(8 ==

225 
k¦
.
h—d
->
nodes
[0].
blk
->nodes[k¦.h—d->nodes[0].blk->
n
 - 1].
key
.
i
);

227 
	`ngtı2_k¦_ä“
(&
k¦
);

230 
	`ngtı2_k¦_š™
(&
k¦
, 
Ëss
, &
šf_key
, 
mem
);

232 
i
 = 0; i < 130; ++i) {

233 
	`ngtı2_k¦_š£¹
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, (
št64_t
)
i
), NULL);

236 
i
 = 116; i <= 129; ++i) {

237 
	`ngtı2_k¦_»move
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, (
št64_t
)
i
));

240 
	`CU_ASSERT
(2 =ğ
k¦
.
h—d
->
n
);

242 
	`ngtı2_k¦_»move
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, 55));

244 
	`CU_ASSERT
(14 =ğ
k¦
.
h—d
->
n
);

246 
	`ngtı2_k¦_ä“
(&
k¦
);

247 
	}
}

249 
	$‹¡_ngtı2_k¦_ş—r
() {

250 
ngtı2_k¦
 
k¦
;

251 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

252 
ngtı2_k¦_™
 
™
;

253 
size_t
 
i
;

254 
ngtı2_k¦_key
 
key
;

256 
	`ngtı2_k¦_š™
(&
k¦
, 
Ëss
, &
šf_key
, 
mem
);

258 
i
 = 0; i < 100; ++i) {

259 
	`ngtı2_k¦_š£¹
(&
k¦
, 
NULL
, 
	`ngtı2_k¦_key_i
(&
key
, (
št64_t
)
i
), NULL);

262 
	`ngtı2_k¦_ş—r
(&
k¦
);

264 
	`CU_ASSERT
(0 =ğ
	`ngtı2_k¦_Ën
(&
k¦
));

266 
™
 = 
	`ngtı2_k¦_begš
(&
k¦
);

268 
	`CU_ASSERT
(
	`ngtı2_k¦_™_’d
(&
™
));

270 
™
 = 
	`ngtı2_k¦_’d
(&
k¦
);

272 
	`CU_ASSERT
(
	`ngtı2_k¦_™_’d
(&
™
));

274 
	`ngtı2_k¦_ä“
(&
k¦
);

275 
	}
}

	@tests/ngtcp2_ksl_test.h

25 #iâdeà
NGTCP2_KSL_TEST_H


26 
	#NGTCP2_KSL_TEST_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
‹¡_ngtı2_k¦_š£¹
();

33 
‹¡_ngtı2_k¦_ş—r
();

	@tests/ngtcp2_map_test.c

26 
	~"ngtı2_m­_‹¡.h
"

28 
	~<CUn™/CUn™.h
>

30 
	~"ngtı2_m­.h
"

32 
	s¡»Áry
 {

33 
ngtı2_m­_’Œy
 
	mm­_’Œy
;

34 cÚ¡ *
	m¡r
;

35 } 
	t¡»Áry
;

37 
	$¡»Áry_š™
(
¡»Áry
 *
’Œy
, 
key_ty³
 
key
, cÚ¡ *
¡r
) {

38 
	`ngtı2_m­_’Œy_š™
(&
’Œy
->
m­_’Œy
, 
key
);

39 
’Œy
->
¡r
 = str;

40 
	}
}

42 
	$‹¡_ngtı2_m­
() {

43 
¡»Áry
 
foo
, 
FOO
, 
b¬
, 
baz
, 
shrubb”y
;

44 
ngtı2_m­
 
m­
;

45 
	`ngtı2_m­_š™
(&
m­
, 
	`ngtı2_mem_deçuÉ
());

47 
	`¡»Áry_š™
(&
foo
, 1, "foo");

48 
	`¡»Áry_š™
(&
FOO
, 1, "FOO");

49 
	`¡»Áry_š™
(&
b¬
, 2, "bar");

50 
	`¡»Áry_š™
(&
baz
, 3, "baz");

51 
	`¡»Áry_š™
(&
shrubb”y
, 4, "shrubbery");

53 
	`CU_ASSERT
(0 =ğ
	`ngtı2_m­_š£¹
(&
m­
, &
foo
.
m­_’Œy
));

54 
	`CU_ASSERT
(
	`¡rcmp
("foo", ((
¡»Áry
 *)
	`ngtı2_m­_fšd
(&
m­
, 1))->
¡r
) == 0);

55 
	`CU_ASSERT
(1 =ğ
	`ngtı2_m­_size
(&
m­
));

57 
	`CU_ASSERT
(
NGTCP2_ERR_INVALID_ARGUMENT
 ==

58 
	`ngtı2_m­_š£¹
(&
m­
, &
FOO
.
m­_’Œy
));

60 
	`CU_ASSERT
(1 =ğ
	`ngtı2_m­_size
(&
m­
));

61 
	`CU_ASSERT
(
	`¡rcmp
("foo", ((
¡»Áry
 *)
	`ngtı2_m­_fšd
(&
m­
, 1))->
¡r
) == 0);

63 
	`CU_ASSERT
(0 =ğ
	`ngtı2_m­_š£¹
(&
m­
, &
b¬
.
m­_’Œy
));

64 
	`CU_ASSERT
(2 =ğ
	`ngtı2_m­_size
(&
m­
));

66 
	`CU_ASSERT
(0 =ğ
	`ngtı2_m­_š£¹
(&
m­
, &
baz
.
m­_’Œy
));

67 
	`CU_ASSERT
(3 =ğ
	`ngtı2_m­_size
(&
m­
));

69 
	`CU_ASSERT
(0 =ğ
	`ngtı2_m­_š£¹
(&
m­
, &
shrubb”y
.
m­_’Œy
));

70 
	`CU_ASSERT
(4 =ğ
	`ngtı2_m­_size
(&
m­
));

72 
	`CU_ASSERT
(
	`¡rcmp
("baz", ((
¡»Áry
 *)
	`ngtı2_m­_fšd
(&
m­
, 3))->
¡r
) == 0);

74 
	`ngtı2_m­_»move
(&
m­
, 3);

75 
	`CU_ASSERT
(3 =ğ
	`ngtı2_m­_size
(&
m­
));

76 
	`CU_ASSERT
(
NULL
 =ğ
	`ngtı2_m­_fšd
(&
m­
, 3));

78 
	`ngtı2_m­_»move
(&
m­
, 1);

79 
	`CU_ASSERT
(2 =ğ
	`ngtı2_m­_size
(&
m­
));

80 
	`CU_ASSERT
(
NULL
 =ğ
	`ngtı2_m­_fšd
(&
m­
, 1));

83 
	`ngtı2_m­_»move
(&
m­
, 1);

84 
	`CU_ASSERT
(2 =ğ
	`ngtı2_m­_size
(&
m­
));

85 
	`CU_ASSERT
(
NULL
 =ğ
	`ngtı2_m­_fšd
(&
m­
, 1));

87 
	`CU_ASSERT
(
	`¡rcmp
("b¬", ((
¡»Áry
 *)
	`ngtı2_m­_fšd
(&
m­
, 2))->
¡r
) == 0);

88 
	`CU_ASSERT
(
	`¡rcmp
("shrubb”y", ((
¡»Áry
 *)
	`ngtı2_m­_fšd
(&
m­
, 4))->
¡r
) ==

91 
	`ngtı2_m­_ä“
(&
m­
);

92 
	}
}

94 
	$shufæe
(*
a
, 
n
) {

95 
i
;

96 
i
 = 
n
 - 1; i >= 1; --i) {

97 
size_t
 
j
 = (size_t)(()(
i
 + 1è* 
	`¿nd
(è/ (
RAND_MAX
 + 1.0));

98 
t
 = 
a
[
j
];

99 
a
[
j
] =‡[
i
];

100 
a
[
i
] = 
t
;

102 
	}
}

104 
	$—chfun
(
ngtı2_m­_’Œy
 *
’Œy
, *
±r
) {

105 ()
’Œy
;

106 ()
±r
;

109 
	}
}

111 
	#NUM_ENT
 6000

	)

112 
¡»Áry
 
	g¬r
[
NUM_ENT
];

113 
	gÜd”
[
NUM_ENT
];

115 
	$‹¡_ngtı2_m­_funùiÚ®
() {

116 
ngtı2_m­
 
m­
;

117 
i
;

119 
	`ngtı2_m­_š™
(&
m­
, 
	`ngtı2_mem_deçuÉ
());

120 
i
 = 0; i < 
NUM_ENT
; ++i) {

121 
	`¡»Áry_š™
(&
¬r
[
i
], (
key_ty³
)(i + 1), "foo");

122 
Üd”
[
i
] = i + 1;

125 
	`shufæe
(
Üd”
, 
NUM_ENT
);

126 
i
 = 0; i < 
NUM_ENT
; ++i) {

127 
	`CU_ASSERT
(0 =ğ
	`ngtı2_m­_š£¹
(&
m­
, &
¬r
[
Üd”
[
i
] - 1].
m­_’Œy
));

130 
	`ngtı2_m­_—ch
(&
m­
, 
—chfun
, 
NULL
);

132 
	`shufæe
(
Üd”
, 
NUM_ENT
);

133 
i
 = 0; i < 
NUM_ENT
; ++i) {

134 
	`ngtı2_m­_fšd
(&
m­
, (
key_ty³
)
Üd”
[
i
]);

137 
	`shufæe
(
Üd”
, 
NUM_ENT
);

138 
i
 = 0; i < 
NUM_ENT
; ++i) {

139 
	`CU_ASSERT
(0 =ğ
	`ngtı2_m­_»move
(&
m­
, (
key_ty³
)
Üd”
[
i
]));

143 
i
 = 0; i < 
NUM_ENT
; ++i) {

144 
	`¡»Áry_š™
(&
¬r
[
i
], (
key_ty³
)(i + 1), "foo");

147 
i
 = 0; i < 
NUM_ENT
; ++i) {

148 
	`CU_ASSERT
(0 =ğ
	`ngtı2_m­_š£¹
(&
m­
, &
¬r
[
i
].
m­_’Œy
));

150 
	`ngtı2_m­_—ch_ä“
(&
m­
, 
—chfun
, 
NULL
);

151 
	`ngtı2_m­_ä“
(&
m­
);

152 
	}
}

154 
	$’Œy_ä“
(
ngtı2_m­_’Œy
 *
’Œy
, *
±r
) {

155 
ngtı2_mem
 *
mem
 = 
±r
;

157 
mem
->
	`ä“
(
’Œy
, 
NULL
);

159 
	}
}

161 
	$‹¡_ngtı2_m­_—ch_ä“
() {

162 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

163 
¡»Áry
 *
foo
 = 
mem
->
	`m®loc
((¡»Áry), 
NULL
),

164 *
b¬
 = 
mem
->
	`m®loc
((
¡»Áry
), 
NULL
),

165 *
baz
 = 
mem
->
	`m®loc
((
¡»Áry
), 
NULL
),

166 *
shrubb”y
 = 
mem
->
	`m®loc
((
¡»Áry
), 
NULL
);

167 
ngtı2_m­
 
m­
;

168 
	`ngtı2_m­_š™
(&
m­
, 
	`ngtı2_mem_deçuÉ
());

170 
	`¡»Áry_š™
(
foo
, 1, "foo");

171 
	`¡»Áry_š™
(
b¬
, 2, "bar");

172 
	`¡»Áry_š™
(
baz
, 3, "baz");

173 
	`¡»Áry_š™
(
shrubb”y
, 4, "shrubbery");

175 
	`ngtı2_m­_š£¹
(&
m­
, &
foo
->
m­_’Œy
);

176 
	`ngtı2_m­_š£¹
(&
m­
, &
b¬
->
m­_’Œy
);

177 
	`ngtı2_m­_š£¹
(&
m­
, &
baz
->
m­_’Œy
);

178 
	`ngtı2_m­_š£¹
(&
m­
, &
shrubb”y
->
m­_’Œy
);

180 
	`ngtı2_m­_—ch_ä“
(&
m­
, 
’Œy_ä“
, 
mem
);

181 
	`ngtı2_m­_ä“
(&
m­
);

182 
	}
}

184 
	$‹¡_ngtı2_m­_ş—r
() {

185 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

186 
ngtı2_m­
 
m­
;

187 
¡»Áry
 
foo
;

189 
	`¡»Áry_š™
(&
foo
, 1, "foo");

191 
	`ngtı2_m­_š™
(&
m­
, 
mem
);

193 
	`CU_ASSERT
(0 =ğ
	`ngtı2_m­_š£¹
(&
m­
, &
foo
.
m­_’Œy
));

195 
	`ngtı2_m­_ş—r
(&
m­
);

197 
	`CU_ASSERT
(0 =ğ
	`ngtı2_m­_size
(&
m­
));

199 
	`ngtı2_m­_ä“
(&
m­
);

200 
	}
}

	@tests/ngtcp2_map_test.h

26 #iâdeà
NGTCP2_MAP_TEST_H


27 
	#NGTCP2_MAP_TEST_H


	)

29 #ifdeà
HAVE_CONFIG_H


30 
	~<cÚfig.h
>

33 
‹¡_ngtı2_m­
();

34 
‹¡_ngtı2_m­_funùiÚ®
();

35 
‹¡_ngtı2_m­_—ch_ä“
();

36 
‹¡_ngtı2_m­_ş—r
();

	@tests/ngtcp2_pkt_test.c

25 
	~"ngtı2_pkt_‹¡.h
"

27 
	~<as£¹.h
>

29 
	~<CUn™/CUn™.h
>

31 
	~"ngtı2_pkt.h
"

32 
	~"ngtı2_‹¡_h–³r.h
"

33 
	~"ngtı2_cÚv.h
"

34 
	~"ngtı2_cid.h
"

36 
	$‹¡_ngtı2_pkt_decode_hd_lÚg
() {

37 
ngtı2_pkt_hd
 
hd
, 
nhd
;

38 
ušt8_t
 
buf
[256];

39 
ssize_t
 
rv
;

40 
ngtı2_cid
 
dcid
, 
scid
;

41 
size_t
 
Ën
;

43 
	`dcid_š™
(&
dcid
);

44 
	`scid_š™
(&
scid
);

47 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_LONG_FORM
, 
NGTCP2_PKT_HANDSHAKE
,

48 &
dcid
, &
scid
, 0xe1e2e3e4u, 4, 0x000000ff, 16383);

50 
rv
 = 
	`ngtı2_pkt_’code_hd_lÚg
(
buf
, (buf), &
hd
);

52 
Ën
 = 1 + 4 + 1 + 
dcid
.
d©®’
 + 
scid
.datalen + 2 + 4;

54 
	`CU_ASSERT
((
ssize_t
)
Ën
 =ğ
rv
);

56 
rv
 = 
	`pkt_decode_hd_lÚg
(&
nhd
, 
buf
, 
Ën
);

58 
	`CU_ASSERT
((
ssize_t
)
Ën
 =ğ
rv
);

59 
	`CU_ASSERT
(
hd
.
ty³
 =ğ
nhd
.type);

60 
	`CU_ASSERT
(
hd
.
æags
 =ğ
nhd
.flags);

61 
	`CU_ASSERT
(
	`ngtı2_cid_eq
(&
hd
.
dcid
, &
nhd
.dcid));

62 
	`CU_ASSERT
(
	`ngtı2_cid_eq
(&
hd
.
scid
, &
nhd
.scid));

63 
	`CU_ASSERT
(0xe1e2e3e4u =ğ
nhd
.
pkt_num
);

64 
	`CU_ASSERT
(
hd
.
v”siÚ
 =ğ
nhd
.version);

65 
	`CU_ASSERT
(
hd
.
Ën
 =ğ
nhd
.len);

69 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_LONG_FORM
, 
NGTCP2_PKT_HANDSHAKE
,

70 &
dcid
, &
scid
, 0, 4, 0, 0);

72 
rv
 = 
	`ngtı2_pkt_’code_hd_lÚg
(
buf
, (buf), &
hd
);

74 
Ën
 = 1 + 4 + 1 + 
dcid
.
d©®’
 + 
scid
.datalen;

76 
	`CU_ASSERT
((
ssize_t
)
Ën
 =ğ
rv
 - 2 - 4 );

78 
rv
 = 
	`pkt_decode_hd_lÚg
(&
nhd
, 
buf
, 
Ën
);

80 
	`CU_ASSERT
((
ssize_t
)
Ën
 =ğ
rv
);

81 
	`CU_ASSERT
(
NGTCP2_PKT_VERSION_NEGOTIATION
 =ğ
nhd
.
ty³
);

82 
	`CU_ASSERT
(
hd
.
æags
 =ğ
nhd
.flags);

83 
	`CU_ASSERT
(
	`ngtı2_cid_eq
(&
hd
.
dcid
, &
nhd
.dcid));

84 
	`CU_ASSERT
(
	`ngtı2_cid_eq
(&
hd
.
scid
, &
nhd
.scid));

85 
	`CU_ASSERT
(
hd
.
pkt_num
 =ğ
nhd
.pkt_num);

86 
	`CU_ASSERT
(
hd
.
v”siÚ
 =ğ
nhd
.version);

87 
	`CU_ASSERT
(
hd
.
Ën
 =ğ
nhd
.len);

88 
	}
}

90 
	$‹¡_ngtı2_pkt_decode_hd_shÜt
() {

91 
ngtı2_pkt_hd
 
hd
, 
nhd
;

92 
ušt8_t
 
buf
[256];

93 
ssize_t
 
rv
;

94 
size_t
 
ex³ùedËn
;

95 
ngtı2_cid
 
dcid
, 
zcid
;

97 
	`dcid_š™
(&
dcid
);

98 
	`ngtı2_cid_z”o
(&
zcid
);

101 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_NONE
, 
NGTCP2_PKT_SHORT
, &
dcid
, 
NULL
,

104 
ex³ùedËn
 = 1 + 
dcid
.
d©®’
 + 4;

106 
rv
 = 
	`ngtı2_pkt_’code_hd_shÜt
(
buf
, (buf), &
hd
);

108 
	`CU_ASSERT
((
ssize_t
)
ex³ùedËn
 =ğ
rv
);

110 
rv
 = 
	`pkt_decode_hd_shÜt
(&
nhd
, 
buf
, 
ex³ùedËn
, 
dcid
.
d©®’
);

112 
	`CU_ASSERT
((
ssize_t
)
ex³ùedËn
 =ğ
rv
);

113 
	`CU_ASSERT
(
hd
.
æags
 =ğ
nhd
.flags);

114 
	`CU_ASSERT
(
NGTCP2_PKT_SHORT
 =ğ
nhd
.
ty³
);

115 
	`CU_ASSERT
(
	`ngtı2_cid_eq
(&
dcid
, &
nhd
.dcid));

116 
	`CU_ASSERT
(
	`ngtı2_cid_em±y
(&
nhd
.
scid
));

117 
	`CU_ASSERT
(0xe1e2e3e4u =ğ
nhd
.
pkt_num
);

118 
	`CU_ASSERT
(
hd
.
pkt_numËn
 =ğ
nhd
.pkt_numlen);

119 
	`CU_ASSERT
(0 =ğ
nhd
.
v”siÚ
);

120 
	`CU_ASSERT
(0 =ğ
nhd
.
Ën
);

123 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_NONE
, 
NGTCP2_PKT_SHORT
, &
dcid
, 
NULL
,

126 
ex³ùedËn
 = 1 + 
dcid
.
d©®’
 + 2;

128 
rv
 = 
	`ngtı2_pkt_’code_hd_shÜt
(
buf
, (buf), &
hd
);

130 
	`CU_ASSERT
((
ssize_t
)
ex³ùedËn
 =ğ
rv
);

132 
rv
 = 
	`pkt_decode_hd_shÜt
(&
nhd
, 
buf
, 
ex³ùedËn
, 
dcid
.
d©®’
);

134 
	`CU_ASSERT
((
ssize_t
)
ex³ùedËn
 =ğ
rv
);

135 
	`CU_ASSERT
(
hd
.
æags
 =ğ
nhd
.flags);

136 
	`CU_ASSERT
(
NGTCP2_PKT_SHORT
 =ğ
nhd
.
ty³
);

137 
	`CU_ASSERT
(
	`ngtı2_cid_eq
(&
dcid
, &
nhd
.dcid));

138 
	`CU_ASSERT
(
	`ngtı2_cid_em±y
(&
nhd
.
scid
));

139 
	`CU_ASSERT
(0xe3e4u =ğ
nhd
.
pkt_num
);

140 
	`CU_ASSERT
(
hd
.
pkt_numËn
 =ğ
nhd
.pkt_numlen);

141 
	`CU_ASSERT
(0 =ğ
nhd
.
v”siÚ
);

142 
	`CU_ASSERT
(0 =ğ
nhd
.
Ën
);

145 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_NONE
, 
NGTCP2_PKT_SHORT
, &
dcid
, 
NULL
,

148 
ex³ùedËn
 = 1 + 
dcid
.
d©®’
 + 1;

150 
rv
 = 
	`ngtı2_pkt_’code_hd_shÜt
(
buf
, (buf), &
hd
);

152 
	`CU_ASSERT
((
ssize_t
)
ex³ùedËn
 =ğ
rv
);

154 
rv
 = 
	`pkt_decode_hd_shÜt
(&
nhd
, 
buf
, 
ex³ùedËn
, 
dcid
.
d©®’
);

156 
	`CU_ASSERT
((
ssize_t
)
ex³ùedËn
 =ğ
rv
);

157 
	`CU_ASSERT
(
hd
.
æags
 =ğ
nhd
.flags);

158 
	`CU_ASSERT
(
NGTCP2_PKT_SHORT
 =ğ
nhd
.
ty³
);

159 
	`CU_ASSERT
(
	`ngtı2_cid_eq
(&
dcid
, &
nhd
.dcid));

160 
	`CU_ASSERT
(
	`ngtı2_cid_em±y
(&
nhd
.
scid
));

161 
	`CU_ASSERT
(0xe4 =ğ
nhd
.
pkt_num
);

162 
	`CU_ASSERT
(
hd
.
pkt_numËn
 =ğ
nhd
.pkt_numlen);

163 
	`CU_ASSERT
(0 =ğ
nhd
.
v”siÚ
);

164 
	`CU_ASSERT
(0 =ğ
nhd
.
Ën
);

167 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_KEY_PHASE
, 
NGTCP2_PKT_SHORT
, &
dcid
,

168 
NULL
, 0xe1e2e3e4u, 4, 0xd1d2d3d4u, 0);

170 
ex³ùedËn
 = 1 + 
dcid
.
d©®’
 + 4;

172 
rv
 = 
	`ngtı2_pkt_’code_hd_shÜt
(
buf
, (buf), &
hd
);

174 
	`CU_ASSERT
((
ssize_t
)
ex³ùedËn
 =ğ
rv
);

176 
rv
 = 
	`pkt_decode_hd_shÜt
(&
nhd
, 
buf
, 
ex³ùedËn
, 
dcid
.
d©®’
);

178 
	`CU_ASSERT
((
ssize_t
)
ex³ùedËn
 =ğ
rv
);

181 
	`CU_ASSERT
(
NGTCP2_PKT_FLAG_NONE
 =ğ
nhd
.
æags
);

182 
	`CU_ASSERT
(
NGTCP2_PKT_SHORT
 =ğ
nhd
.
ty³
);

183 
	`CU_ASSERT
(
	`ngtı2_cid_eq
(&
dcid
, &
nhd
.dcid));

184 
	`CU_ASSERT
(
	`ngtı2_cid_em±y
(&
nhd
.
scid
));

185 
	`CU_ASSERT
(0xe1e2e3e4u =ğ
nhd
.
pkt_num
);

186 
	`CU_ASSERT
(
hd
.
pkt_numËn
 =ğ
nhd
.pkt_numlen);

187 
	`CU_ASSERT
(0 =ğ
nhd
.
v”siÚ
);

188 
	`CU_ASSERT
(0 =ğ
nhd
.
Ën
);

191 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_NONE
, 
NGTCP2_PKT_SHORT
, 
NULL
, NULL,

194 
ex³ùedËn
 = 1 + 4;

196 
rv
 = 
	`ngtı2_pkt_’code_hd_shÜt
(
buf
, (buf), &
hd
);

198 
	`CU_ASSERT
((
ssize_t
)
ex³ùedËn
 =ğ
rv
);

200 
rv
 = 
	`pkt_decode_hd_shÜt
(&
nhd
, 
buf
, 
ex³ùedËn
, 0);

202 
	`CU_ASSERT
((
ssize_t
)
ex³ùedËn
 =ğ
rv
);

203 
	`CU_ASSERT
(
hd
.
æags
 =ğ
nhd
.flags);

204 
	`CU_ASSERT
(
NGTCP2_PKT_SHORT
 =ğ
nhd
.
ty³
);

205 
	`CU_ASSERT
(
	`ngtı2_cid_em±y
(&
nhd
.
dcid
));

206 
	`CU_ASSERT
(
	`ngtı2_cid_em±y
(&
nhd
.
scid
));

207 
	`CU_ASSERT
(0xe1e2e3e4u =ğ
nhd
.
pkt_num
);

208 
	`CU_ASSERT
(
hd
.
pkt_numËn
 =ğ
nhd
.pkt_numlen);

209 
	`CU_ASSERT
(0 =ğ
nhd
.
v”siÚ
);

210 
	`CU_ASSERT
(0 =ğ
nhd
.
Ën
);

211 
	}
}

213 
	$‹¡_ngtı2_pkt_decode_¡»am_äame
() {

214 
ušt8_t
 
buf
[256];

215 
size_t
 
buæ’
;

216 
ngtı2_äame
 
ä
;

217 
ssize_t
 
rv
;

218 
size_t
 
ex³ùedËn
;

221 
buæ’
 = 
	`ngtı2_t_’code_¡»am_äame
(
buf
, 
NGTCP2_STREAM_LEN_BIT
, 0xf1f2f3f4u,

224 
ex³ùedËn
 = 1 + 8 + 8 + 1 + 20;

226 
	`CU_ASSERT
(
ex³ùedËn
 =ğ
buæ’
);

228 
rv
 = 
	`ngtı2_pkt_decode_¡»am_äame
(&
ä
.
¡»am
, 
buf
, 
buæ’
);

230 
	`CU_ASSERT
((
ssize_t
)
ex³ùedËn
 =ğ
rv
);

231 
	`CU_ASSERT
(0 =ğ
ä
.
¡»am
.
fš
);

232 
	`CU_ASSERT
(0xf1f2f3f4u =ğ
ä
.
¡»am
.
¡»am_id
);

233 
	`CU_ASSERT
(0x31f2f3f4f5f6f7f8Îu =ğ
ä
.
¡»am
.
off£t
);

234 
	`CU_ASSERT
(1 =ğ
ä
.
¡»am
.
d©aút
);

235 
	`CU_ASSERT
(0x14 =ğ
ä
.
¡»am
.
d©a
[0].
Ën
);

239 
rv
 = 
	`ngtı2_pkt_decode_¡»am_äame
(&
ä
.
¡»am
, 
buf
, 
buæ’
 - 1);

241 
	`CU_ASSERT
(
NGTCP2_ERR_FRAME_ENCODING
 =ğ
rv
);

243 
	`mem£t
(&
ä
, 0, (fr));

246 
buæ’
 = 
	`ngtı2_t_’code_¡»am_äame
(
buf
, 
NGTCP2_STREAM_LEN_BIT
, 0x31, 0x00,

249 
ex³ùedËn
 = 1 + 1 + 0 + 1 + 20;

251 
	`CU_ASSERT
(
ex³ùedËn
 =ğ
buæ’
);

253 
rv
 = 
	`ngtı2_pkt_decode_¡»am_äame
(&
ä
.
¡»am
, 
buf
, 
buæ’
);

255 
	`CU_ASSERT
((
ssize_t
)
ex³ùedËn
 =ğ
rv
);

256 
	`CU_ASSERT
(0 =ğ
ä
.
¡»am
.
fš
);

257 
	`CU_ASSERT
(0x31 =ğ
ä
.
¡»am
.
¡»am_id
);

258 
	`CU_ASSERT
(0x00 =ğ
ä
.
¡»am
.
off£t
);

259 
	`CU_ASSERT
(1 =ğ
ä
.
¡»am
.
d©aút
);

260 
	`CU_ASSERT
(0x14 =ğ
ä
.
¡»am
.
d©a
[0].
Ën
);

264 
rv
 = 
	`ngtı2_pkt_decode_¡»am_äame
(&
ä
.
¡»am
, 
buf
, 
buæ’
 - 1);

266 
	`CU_ASSERT
(
NGTCP2_ERR_FRAME_ENCODING
 =ğ
rv
);

268 
	`mem£t
(&
ä
, 0, (fr));

271 
buæ’
 = 
	`ngtı2_t_’code_¡»am_äame
(
buf
, 
NGTCP2_STREAM_FIN_BIT
, 0x31f2f3f4u,

274 
ex³ùedËn
 = 1 + 4 + 20;

276 
	`CU_ASSERT
(
ex³ùedËn
 =ğ
buæ’
);

278 
rv
 = 
	`ngtı2_pkt_decode_¡»am_äame
(&
ä
.
¡»am
, 
buf
, 
buæ’
);

280 
	`CU_ASSERT
((
ssize_t
)
ex³ùedËn
 =ğ
rv
);

281 
	`CU_ASSERT
(1 =ğ
ä
.
¡»am
.
fš
);

282 
	`CU_ASSERT
(0x31f2f3f4u =ğ
ä
.
¡»am
.
¡»am_id
);

283 
	`CU_ASSERT
(0x00 =ğ
ä
.
¡»am
.
off£t
);

284 
	`CU_ASSERT
(1 =ğ
ä
.
¡»am
.
d©aút
);

285 
	`CU_ASSERT
(0x14 =ğ
ä
.
¡»am
.
d©a
[0].
Ën
);

287 
	`mem£t
(&
ä
, 0, (fr));

288 
	}
}

290 
	$‹¡_ngtı2_pkt_decode_ack_äame
() {

291 
ušt8_t
 
buf
[256];

292 
size_t
 
buæ’
;

293 
ngtı2_äame
 
ä
;

294 
ssize_t
 
rv
;

295 
size_t
 
ex³ùedËn
;

298 
buæ’
 = 
	`ngtı2_t_’code_ack_äame
(
buf
, 0x31f2f3f4f5f6f7f8llu,

302 
ex³ùedËn
 = 1 + 8 + 1 + 1 + 8 + 2 + 8;

304 
	`CU_ASSERT
(
ex³ùedËn
 =ğ
buæ’
);

306 
rv
 = 
	`ngtı2_pkt_decode_ack_äame
(&
ä
.
ack
, 
buf
, 
buæ’
);

308 
	`CU_ASSERT
((
ssize_t
)
ex³ùedËn
 =ğ
rv
);

309 
	`CU_ASSERT
(0x31f2f3f4f5f6f7f8Îu =ğ
ä
.
ack
.
Ïrge¡_ack
);

310 
	`CU_ASSERT
(1 =ğ
ä
.
ack
.
num_blks
);

311 
	`CU_ASSERT
(0x31e2e3e4e5e6e7e8Îu =ğ
ä
.
ack
.
fœ¡_ack_blkËn
);

312 
	`CU_ASSERT
(99 =ğ
ä
.
ack
.
blks
[0].
g­
);

313 
	`CU_ASSERT
(0x31d2d3d4d5d6d7d8Îu =ğ
ä
.
ack
.
blks
[0].
blkËn
);

314 
	}
}

316 
	$‹¡_ngtı2_pkt_decode_·ddšg_äame
() {

317 
ušt8_t
 
buf
[256];

318 
ngtı2_äame
 
ä
;

319 
size_t
 
rv
;

320 
size_t
 
·ddšgËn
 = 31;

322 
	`mem£t
(
buf
, 0, 
·ddšgËn
);

323 
buf
[
·ddšgËn
] = 
NGTCP2_FRAME_STREAM
;

325 
rv
 = 
	`ngtı2_pkt_decode_·ddšg_äame
(&
ä
.
·ddšg
, 
buf
, 
·ddšgËn
 + 1);

327 
	`CU_ASSERT
(
·ddšgËn
 =ğ
rv
);

328 
	`CU_ASSERT
((
size_t
)31 =ğ
ä
.
·ddšg
.
Ën
);

329 
	}
}

331 
	$‹¡_ngtı2_pkt_’code_¡»am_äame
() {

332 cÚ¡ 
ušt8_t
 
d©a
[] = "0123456789abcdef0";

333 
ušt8_t
 
buf
[256];

334 
ngtı2_äame
 
ä
, 
nä
;

335 
ssize_t
 
rv
;

336 
size_t
 
äam–’
;

337 
size_t
 
i
;

340 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

341 
ä
.
¡»am
.
fš
 = 0;

342 
ä
.
¡»am
.
¡»am_id
 = 0xf1f2f3f4u;

343 
ä
.
¡»am
.
off£t
 = 0x31f2f3f4f5f6f7f8llu;

344 
ä
.
¡»am
.
d©aút
 = 1;

345 
ä
.
¡»am
.
d©a
[0].
Ën
 = 
	`¡rsize
(data);

346 
ä
.
¡»am
.
d©a
[0].
ba£
 = (
ušt8_t
 *)data;

348 
äam–’
 = 1 + 8 + 8 + 1 + 17;

350 
rv
 = 
	`ngtı2_pkt_’code_¡»am_äame
(
buf
, (buf), &
ä
.
¡»am
);

352 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

354 
rv
 = 
	`ngtı2_pkt_decode_¡»am_äame
(&
nä
.
¡»am
, 
buf
, 
äam–’
);

356 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

357 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

358 
	`CU_ASSERT
((
NGTCP2_STREAM_OFF_BIT
 | 
NGTCP2_STREAM_LEN_BIT
) ==

359 
nä
.
¡»am
.
æags
);

360 
	`CU_ASSERT
(
ä
.
¡»am
.
fš
 =ğ
nä
.stream.fin);

361 
	`CU_ASSERT
(
ä
.
¡»am
.
¡»am_id
 =ğ
nä
.stream.stream_id);

362 
	`CU_ASSERT
(
ä
.
¡»am
.
off£t
 =ğ
nä
.stream.offset);

363 
	`CU_ASSERT
(1 =ğ
nä
.
¡»am
.
d©aút
);

364 
	`CU_ASSERT
(
ä
.
¡»am
.
d©a
[0].
Ën
 =ğ
nä
.stream.data[0].len);

365 
	`CU_ASSERT
(0 =ğ
	`memcmp
(
ä
.
¡»am
.
d©a
[0].
ba£
, 
nä
.stream.data[0].base,

366 
ä
.
¡»am
.
d©a
[0].
Ën
));

368 
	`mem£t
(&
nä
, 0, (nfr));

371 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

372 
ä
.
¡»am
.
fš
 = 0;

373 
ä
.
¡»am
.
¡»am_id
 = 0x31;

374 
ä
.
¡»am
.
off£t
 = 0;

375 
ä
.
¡»am
.
d©aút
 = 1;

376 
ä
.
¡»am
.
d©a
[0].
Ën
 = 
	`¡rsize
(data);

377 
ä
.
¡»am
.
d©a
[0].
ba£
 = (
ušt8_t
 *)data;

379 
äam–’
 = 1 + 1 + 1 + 17;

381 
rv
 = 
	`ngtı2_pkt_’code_¡»am_äame
(
buf
, (buf), &
ä
.
¡»am
);

383 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

385 
rv
 = 
	`ngtı2_pkt_decode_¡»am_äame
(&
nä
.
¡»am
, 
buf
, 
äam–’
);

387 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

388 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

389 
	`CU_ASSERT
(
NGTCP2_STREAM_LEN_BIT
 =ğ
nä
.
¡»am
.
æags
);

390 
	`CU_ASSERT
(
ä
.
¡»am
.
fš
 =ğ
nä
.stream.fin);

391 
	`CU_ASSERT
(
ä
.
¡»am
.
¡»am_id
 =ğ
nä
.stream.stream_id);

392 
	`CU_ASSERT
(
ä
.
¡»am
.
off£t
 =ğ
nä
.stream.offset);

393 
	`CU_ASSERT
(1 =ğ
nä
.
¡»am
.
d©aút
);

394 
	`CU_ASSERT
(
ä
.
¡»am
.
d©a
[0].
Ën
 =ğ
nä
.stream.data[0].len);

395 
	`CU_ASSERT
(0 =ğ
	`memcmp
(
ä
.
¡»am
.
d©a
[0].
ba£
, 
nä
.stream.data[0].base,

396 
ä
.
¡»am
.
d©a
[0].
Ën
));

398 
	`mem£t
(&
nä
, 0, (nfr));

401 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

402 
ä
.
¡»am
.
fš
 = 1;

403 
ä
.
¡»am
.
¡»am_id
 = 0xf1f2f3f4u;

404 
ä
.
¡»am
.
off£t
 = 0x31f2f3f4f5f6f7f8llu;

405 
ä
.
¡»am
.
d©aút
 = 1;

406 
ä
.
¡»am
.
d©a
[0].
Ën
 = 
	`¡rsize
(data);

407 
ä
.
¡»am
.
d©a
[0].
ba£
 = (
ušt8_t
 *)data;

409 
äam–’
 = 1 + 8 + 8 + 1 + 17;

411 
rv
 = 
	`ngtı2_pkt_’code_¡»am_äame
(
buf
, (buf), &
ä
.
¡»am
);

413 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

415 
rv
 = 
	`ngtı2_pkt_decode_¡»am_äame
(&
nä
.
¡»am
, 
buf
, 
äam–’
);

417 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

418 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

419 
	`CU_ASSERT
((
NGTCP2_STREAM_FIN_BIT
 | 
NGTCP2_STREAM_OFF_BIT
 |

420 
NGTCP2_STREAM_LEN_BIT
è=ğ
nä
.
¡»am
.
æags
);

421 
	`CU_ASSERT
(
ä
.
¡»am
.
fš
 =ğ
nä
.stream.fin);

422 
	`CU_ASSERT
(
ä
.
¡»am
.
¡»am_id
 =ğ
nä
.stream.stream_id);

423 
	`CU_ASSERT
(
ä
.
¡»am
.
off£t
 =ğ
nä
.stream.offset);

424 
	`CU_ASSERT
(1 =ğ
nä
.
¡»am
.
d©aút
);

425 
	`CU_ASSERT
(
ä
.
¡»am
.
d©a
[0].
Ën
 =ğ
nä
.stream.data[0].len);

426 
	`CU_ASSERT
(0 =ğ
	`memcmp
(
ä
.
¡»am
.
d©a
[0].
ba£
, 
nä
.stream.data[0].base,

427 
ä
.
¡»am
.
d©a
[0].
Ën
));

430 
i
 = 1; i < 
äam–’
; ++i) {

431 
rv
 = 
	`ngtı2_pkt_decode_¡»am_äame
(&
nä
.
¡»am
, 
buf
, 
i
);

433 
	`CU_ASSERT
(
NGTCP2_ERR_FRAME_ENCODING
 =ğ
rv
);

436 
	`mem£t
(&
nä
, 0, (nfr));

439 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

440 
ä
.
¡»am
.
fš
 = 1;

441 
ä
.
¡»am
.
¡»am_id
 = 0xf1f2f3f4u;

442 
ä
.
¡»am
.
off£t
 = 0x31f2f3f4f5f6f7f8llu;

443 
ä
.
¡»am
.
d©aút
 = 1;

444 
ä
.
¡»am
.
d©a
[0].
Ën
 = 
	`¡rsize
(data);

445 
ä
.
¡»am
.
d©a
[0].
ba£
 = (
ušt8_t
 *)data;

447 
äam–’
 = 1 + 8 + 8 + 1 + 17;

449 
rv
 = 
	`ngtı2_pkt_’code_¡»am_äame
(
buf
, 
äam–’
 - 1, &
ä
.
¡»am
);

451 
	`CU_ASSERT
(
NGTCP2_ERR_NOBUF
 =ğ
rv
);

452 
	}
}

454 
	$‹¡_ngtı2_pkt_’code_ack_äame
() {

455 
ušt8_t
 
buf
[256];

456 
ngtı2_max_äame
 
mä
, 
nmä
;

457 
ngtı2_äame
 *
ä
 = &
mä
.ä, *
nä
 = &
nmä
.fr;

458 
ssize_t
 
rv
;

459 
size_t
 
äam–’
;

460 
size_t
 
i
;

461 
ngtı2_ack_blk
 *
blks
;

464 
ä
->
ty³
 = 
NGTCP2_FRAME_ACK
;

465 
ä
->
ack
.
Ïrge¡_ack
 = 0xf1f2f3f4llu;

466 
ä
->
ack
.
fœ¡_ack_blkËn
 = 0;

467 
ä
->
ack
.
ack_d–ay
 = 0;

468 
ä
->
ack
.
num_blks
 = 0;

470 
äam–’
 = 1 + 8 + 1 + 1 + 1;

472 
rv
 = 
	`ngtı2_pkt_’code_ack_äame
(
buf
, (buf), &
ä
->
ack
);

474 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

476 
rv
 = 
	`ngtı2_pkt_decode_ack_äame
(&
nä
->
ack
, 
buf
, 
äam–’
);

478 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

479 
	`CU_ASSERT
(
ä
->
ty³
 =ğ
nä
->type);

480 
	`CU_ASSERT
(
ä
->
ack
.
Ïrge¡_ack
 =ğ
nä
->ack.largest_ack);

481 
	`CU_ASSERT
(
ä
->
ack
.
ack_d–ay
 =ğ
nä
->ack.ack_delay);

482 
	`CU_ASSERT
(
ä
->
ack
.
num_blks
 =ğ
nä
->ack.num_blks);

484 
	`mem£t
(&
nmä
, 0, (nmfr));

487 
ä
->
ty³
 = 
NGTCP2_FRAME_ACK
;

488 
ä
->
ack
.
Ïrge¡_ack
 = 0xf1f2f3f4llu;

489 
ä
->
ack
.
fœ¡_ack_blkËn
 = 0xe1e2e3e4llu;

490 
ä
->
ack
.
ack_d–ay
 = 0xf1f2;

491 
ä
->
ack
.
num_blks
 = 2;

492 
blks
 = 
ä
->
ack
.blks;

493 
blks
[0].
g­
 = 255;

494 
blks
[0].
blkËn
 = 0xd1d2d3d4llu;

495 
blks
[1].
g­
 = 1;

496 
blks
[1].
blkËn
 = 0xd1d2d3d4llu;

498 
äam–’
 = 1 + 8 + 4 + 1 + 8 + (2 + 8) + (1 + 8);

500 
rv
 = 
	`ngtı2_pkt_’code_ack_äame
(
buf
, (buf), &
ä
->
ack
);

502 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

504 
rv
 = 
	`ngtı2_pkt_decode_ack_äame
(&
nä
->
ack
, 
buf
, 
äam–’
);

506 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

507 
	`CU_ASSERT
(
ä
->
ty³
 =ğ
nä
->type);

508 
	`CU_ASSERT
(
ä
->
ack
.
Ïrge¡_ack
 =ğ
nä
->ack.largest_ack);

509 
	`CU_ASSERT
(
ä
->
ack
.
ack_d–ay
 =ğ
nä
->ack.ack_delay);

510 
	`CU_ASSERT
(
ä
->
ack
.
num_blks
 =ğ
nä
->ack.num_blks);

512 
i
 = 0; i < 
ä
->
ack
.
num_blks
; ++i) {

513 
	`CU_ASSERT
(
ä
->
ack
.
blks
[
i
].
g­
 =ğ
nä
->ack.blks[i].gap);

514 
	`CU_ASSERT
(
ä
->
ack
.
blks
[
i
].
blkËn
 =ğ
nä
->ack.blks[i].blklen);

517 
	`mem£t
(&
nmä
, 0, (nmfr));

518 
	}
}

520 
	$‹¡_ngtı2_pkt_’code_»£t_¡»am_äame
() {

521 
ušt8_t
 
buf
[32];

522 
ngtı2_»£t_¡»am
 
ä
, 
nä
;

523 
ssize_t
 
rv
;

524 
size_t
 
äam–’
 = 1 + 4 + 2 + 8;

526 
ä
.
ty³
 = 
NGTCP2_FRAME_RESET_STREAM
;

527 
ä
.
¡»am_id
 = 1000000007;

528 
ä
.
­p_”rÜ_code
 = 0xe1e2;

529 
ä
.
fš®_off£t
 = 0x31f2f3f4f5f6f7f8llu;

531 
rv
 = 
	`ngtı2_pkt_’code_»£t_¡»am_äame
(
buf
, (buf), &
ä
);

533 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

535 
rv
 = 
	`ngtı2_pkt_decode_»£t_¡»am_äame
(&
nä
, 
buf
, 
äam–’
);

537 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

538 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

539 
	`CU_ASSERT
(
ä
.
¡»am_id
 =ğ
nä
.stream_id);

540 
	`CU_ASSERT
(
ä
.
­p_”rÜ_code
 =ğ
nä
.app_error_code);

541 
	`CU_ASSERT
(
ä
.
fš®_off£t
 =ğ
nä
.final_offset);

542 
	}
}

544 
	$‹¡_ngtı2_pkt_’code_cÚÃùiÚ_şo£_äame
() {

545 
ušt8_t
 
buf
[2048];

546 
ngtı2_äame
 
ä
, 
nä
;

547 
ssize_t
 
rv
;

548 
size_t
 
äam–’
;

549 
ušt8_t
 
»asÚ
[1024];

551 
	`mem£t
(
»asÚ
, 0xfa, (reason));

554 
ä
.
ty³
 = 
NGTCP2_FRAME_CONNECTION_CLOSE
;

555 
ä
.
cÚÃùiÚ_şo£
.
”rÜ_code
 = 0xf1f2u;

556 
ä
.
cÚÃùiÚ_şo£
.
äame_ty³
 = 255;

557 
ä
.
cÚÃùiÚ_şo£
.
»asÚËn
 = 0;

558 
ä
.
cÚÃùiÚ_şo£
.
»asÚ
 = 
NULL
;

560 
äam–’
 = 1 + 2 + 2 + 1;

562 
rv
 = 
	`ngtı2_pkt_’code_cÚÃùiÚ_şo£_äame
(
buf
, (buf),

563 &
ä
.
cÚÃùiÚ_şo£
);

565 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

567 
rv
 = 
	`ngtı2_pkt_decode_cÚÃùiÚ_şo£_äame
(&
nä
.
cÚÃùiÚ_şo£
, 
buf
,

568 
äam–’
);

570 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

571 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

572 
	`CU_ASSERT
(
ä
.
cÚÃùiÚ_şo£
.
”rÜ_code
 =ğ
nä
.connection_close.error_code);

573 
	`CU_ASSERT
(
ä
.
cÚÃùiÚ_şo£
.
»asÚËn
 =ğ
nä
.connection_close.reasonlen);

574 
	`CU_ASSERT
(
ä
.
cÚÃùiÚ_şo£
.
»asÚ
 =ğ
nä
.connection_close.reason);

576 
	`mem£t
(&
nä
, 0, (nfr));

579 
ä
.
ty³
 = 
NGTCP2_FRAME_CONNECTION_CLOSE
;

580 
ä
.
cÚÃùiÚ_şo£
.
”rÜ_code
 = 0xf3f4u;

581 
ä
.
cÚÃùiÚ_şo£
.
äame_ty³
 = 0;

582 
ä
.
cÚÃùiÚ_şo£
.
»asÚËn
 = (
»asÚ
);

583 
ä
.
cÚÃùiÚ_şo£
.
»asÚ
 =„eason;

585 
äam–’
 = 1 + 2 + 1 + 2 + (
»asÚ
);

587 
rv
 = 
	`ngtı2_pkt_’code_cÚÃùiÚ_şo£_äame
(
buf
, (buf),

588 &
ä
.
cÚÃùiÚ_şo£
);

590 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

592 
rv
 = 
	`ngtı2_pkt_decode_cÚÃùiÚ_şo£_äame
(&
nä
.
cÚÃùiÚ_şo£
, 
buf
,

593 
äam–’
);

595 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

596 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

597 
	`CU_ASSERT
(
ä
.
cÚÃùiÚ_şo£
.
”rÜ_code
 =ğ
nä
.connection_close.error_code);

598 
	`CU_ASSERT
(
ä
.
cÚÃùiÚ_şo£
.
»asÚËn
 =ğ
nä
.connection_close.reasonlen);

599 
	`CU_ASSERT
(0 =ğ
	`memcmp
(
»asÚ
, 
nä
.
cÚÃùiÚ_şo£
.reason, (reason)));

601 
	`mem£t
(&
nä
, 0, (nfr));

602 
	}
}

604 
	$‹¡_ngtı2_pkt_’code_cÚÃùiÚ_şo£_­p_äame
() {

605 
ušt8_t
 
buf
[2048];

606 
ngtı2_äame
 
ä
, 
nä
;

607 
ssize_t
 
rv
;

608 
size_t
 
äam–’
;

609 
ušt8_t
 
»asÚ
[1024];

611 
	`mem£t
(
»asÚ
, 0xfa, (reason));

614 
ä
.
ty³
 = 
NGTCP2_FRAME_CONNECTION_CLOSE_APP
;

615 
ä
.
cÚÃùiÚ_şo£
.
”rÜ_code
 = 0xf1f2u;

616 
ä
.
cÚÃùiÚ_şo£
.
äame_ty³
 = 0xff;

617 
ä
.
cÚÃùiÚ_şo£
.
»asÚËn
 = 0;

618 
ä
.
cÚÃùiÚ_şo£
.
»asÚ
 = 
NULL
;

620 
äam–’
 = 1 + 2 + 1;

622 
rv
 = 
	`ngtı2_pkt_’code_cÚÃùiÚ_şo£_äame
(
buf
, (buf),

623 &
ä
.
cÚÃùiÚ_şo£
);

625 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

627 
rv
 = 
	`ngtı2_pkt_decode_cÚÃùiÚ_şo£_äame
(&
nä
.
cÚÃùiÚ_şo£
, 
buf
,

628 
äam–’
);

630 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

631 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

632 
	`CU_ASSERT
(
ä
.
cÚÃùiÚ_şo£
.
”rÜ_code
 =ğ
nä
.connection_close.error_code);

633 
	`CU_ASSERT
(0 =ğ
nä
.
cÚÃùiÚ_şo£
.
äame_ty³
);

634 
	`CU_ASSERT
(
ä
.
cÚÃùiÚ_şo£
.
»asÚËn
 =ğ
nä
.connection_close.reasonlen);

635 
	`CU_ASSERT
(
ä
.
cÚÃùiÚ_şo£
.
»asÚ
 =ğ
nä
.connection_close.reason);

637 
	`mem£t
(&
nä
, 0, (nfr));

638 
	}
}

640 
	$‹¡_ngtı2_pkt_’code_max_d©a_äame
() {

641 
ušt8_t
 
buf
[16];

642 
ngtı2_max_d©a
 
ä
, 
nä
;

643 
ssize_t
 
rv
;

644 
size_t
 
äam–’
 = 1 + 8;

646 
ä
.
ty³
 = 
NGTCP2_FRAME_MAX_DATA
;

647 
ä
.
max_d©a
 = 0x31f2f3f4f5f6f7f8llu;

649 
rv
 = 
	`ngtı2_pkt_’code_max_d©a_äame
(
buf
, (buf), &
ä
);

651 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

653 
rv
 = 
	`ngtı2_pkt_decode_max_d©a_äame
(&
nä
, 
buf
, 
äam–’
);

655 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

656 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

657 
	`CU_ASSERT
(
ä
.
max_d©a
 =ğ
nä
.max_data);

658 
	}
}

660 
	$‹¡_ngtı2_pkt_’code_max_¡»am_d©a_äame
() {

661 
ušt8_t
 
buf
[17];

662 
ngtı2_max_¡»am_d©a
 
ä
, 
nä
;

663 
ssize_t
 
rv
;

664 
size_t
 
äam–’
 = 1 + 8 + 8;

666 
ä
.
ty³
 = 
NGTCP2_FRAME_MAX_STREAM_DATA
;

667 
ä
.
¡»am_id
 = 0xf1f2f3f4u;

668 
ä
.
max_¡»am_d©a
 = 0x35f6f7f8f9fafbfcllu;

670 
rv
 = 
	`ngtı2_pkt_’code_max_¡»am_d©a_äame
(
buf
, (buf), &
ä
);

672 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

674 
rv
 = 
	`ngtı2_pkt_decode_max_¡»am_d©a_äame
(&
nä
, 
buf
, 
äam–’
);

676 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

677 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

678 
	`CU_ASSERT
(
ä
.
¡»am_id
 =ğ
nä
.stream_id);

679 
	`CU_ASSERT
(
ä
.
max_¡»am_d©a
 =ğ
nä
.max_stream_data);

680 
	}
}

682 
	$‹¡_ngtı2_pkt_’code_max_¡»ams_äame
() {

683 
ušt8_t
 
buf
[16];

684 
ngtı2_max_¡»ams
 
ä
, 
nä
;

685 
ssize_t
 
rv
;

686 
size_t
 
äam–’
 = 1 + 8;

688 
ä
.
ty³
 = 
NGTCP2_FRAME_MAX_STREAMS_BIDI
;

689 
ä
.
max_¡»ams
 = 0xf1f2f3f4u;

691 
rv
 = 
	`ngtı2_pkt_’code_max_¡»ams_äame
(
buf
, (buf), &
ä
);

693 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

695 
rv
 = 
	`ngtı2_pkt_decode_max_¡»ams_äame
(&
nä
, 
buf
, 
äam–’
);

697 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

698 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

699 
	`CU_ASSERT
(
ä
.
max_¡»ams
 =ğ
nä
.max_streams);

700 
	}
}

702 
	$‹¡_ngtı2_pkt_’code_pšg_äame
() {

703 
ušt8_t
 
buf
[3];

704 
ngtı2_pšg
 
ä
, 
nä
;

705 
ssize_t
 
rv
;

706 
size_t
 
äam–’
;

708 
ä
.
ty³
 = 
NGTCP2_FRAME_PING
;

710 
äam–’
 = 1;

712 
rv
 = 
	`ngtı2_pkt_’code_pšg_äame
(
buf
, (buf), &
ä
);

714 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

716 
rv
 = 
	`ngtı2_pkt_decode_pšg_äame
(&
nä
, 
buf
, 
äam–’
);

718 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

719 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

720 
	}
}

722 
	$‹¡_ngtı2_pkt_’code_d©a_blocked_äame
() {

723 
ušt8_t
 
buf
[9];

724 
ngtı2_d©a_blocked
 
ä
, 
nä
;

725 
ssize_t
 
rv
;

726 
size_t
 
äam–’
 = 1 + 8;

728 
ä
.
ty³
 = 
NGTCP2_FRAME_DATA_BLOCKED
;

729 
ä
.
off£t
 = 0x31f2f3f4f5f6f7f8llu;

731 
rv
 = 
	`ngtı2_pkt_’code_d©a_blocked_äame
(
buf
, (buf), &
ä
);

733 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

735 
rv
 = 
	`ngtı2_pkt_decode_d©a_blocked_äame
(&
nä
, 
buf
, 
äam–’
);

737 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

738 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

739 
	`CU_ASSERT
(
ä
.
off£t
 =ğ
nä
.offset);

740 
	}
}

742 
	$‹¡_ngtı2_pkt_’code_¡»am_d©a_blocked_äame
() {

743 
ušt8_t
 
buf
[17];

744 
ngtı2_¡»am_d©a_blocked
 
ä
, 
nä
;

745 
ssize_t
 
rv
;

746 
size_t
 
äam–’
 = 1 + 8 + 8;

748 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM_DATA_BLOCKED
;

749 
ä
.
¡»am_id
 = 0xf1f2f3f4u;

750 
ä
.
off£t
 = 0x35f6f7f8f9fafbfcllu;

752 
rv
 = 
	`ngtı2_pkt_’code_¡»am_d©a_blocked_äame
(
buf
, (buf), &
ä
);

754 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

756 
rv
 = 
	`ngtı2_pkt_decode_¡»am_d©a_blocked_äame
(&
nä
, 
buf
, 
äam–’
);

758 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

759 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

760 
	`CU_ASSERT
(
ä
.
¡»am_id
 =ğ
nä
.stream_id);

761 
	`CU_ASSERT
(
ä
.
off£t
 =ğ
nä
.offset);

762 
	}
}

764 
	$‹¡_ngtı2_pkt_’code_¡»ams_blocked_äame
() {

765 
ušt8_t
 
buf
[9];

766 
ngtı2_¡»ams_blocked
 
ä
, 
nä
;

767 
ssize_t
 
rv
;

768 
size_t
 
äam–’
 = 1 + 8;

770 
ä
.
ty³
 = 
NGTCP2_FRAME_STREAMS_BLOCKED_BIDI
;

771 
ä
.
¡»am_lim™
 = 0xf1f2f3f4u;

773 
rv
 = 
	`ngtı2_pkt_’code_¡»ams_blocked_äame
(
buf
, (buf), &
ä
);

775 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

777 
rv
 = 
	`ngtı2_pkt_decode_¡»ams_blocked_äame
(&
nä
, 
buf
, 
äam–’
);

779 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

780 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

781 
	`CU_ASSERT
(
ä
.
¡»am_lim™
 =ğ
nä
.stream_limit);

782 
	}
}

784 
	$‹¡_ngtı2_pkt_’code_Ãw_cÚÃùiÚ_id_äame
() {

785 
ušt8_t
 
buf
[256];

786 
ngtı2_Ãw_cÚÃùiÚ_id
 
ä
, 
nä
;

787 
ssize_t
 
rv
;

788 
size_t
 
äam–’
 = 1 + 4 + 1 + 18 + 
NGTCP2_STATELESS_RESET_TOKENLEN
;

790 
ä
.
ty³
 = 
NGTCP2_FRAME_NEW_CONNECTION_ID
;

791 
ä
.
£q
 = 1000000009;

792 
	`scid_š™
(&
ä
.
cid
);

793 
	`mem£t
(
ä
.
¡©–ess_»£t_tok’
, 0xe1, (fr.stateless_reset_token));

795 
rv
 = 
	`ngtı2_pkt_’code_Ãw_cÚÃùiÚ_id_äame
(
buf
, (buf), &
ä
);

797 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

799 
rv
 = 
	`ngtı2_pkt_decode_Ãw_cÚÃùiÚ_id_äame
(&
nä
, 
buf
, 
äam–’
);

801 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

802 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

803 
	`CU_ASSERT
(
ä
.
£q
 =ğ
nä
.seq);

804 
	`CU_ASSERT
(
	`ngtı2_cid_eq
(&
ä
.
cid
, &
nä
.cid));

805 
	`CU_ASSERT
(0 =ğ
	`memcmp
(
ä
.
¡©–ess_»£t_tok’
, 
nä
.stateless_reset_token,

806 (
ä
.
¡©–ess_»£t_tok’
)));

807 
	}
}

809 
	$‹¡_ngtı2_pkt_’code_¡İ_£ndšg_äame
() {

810 
ušt8_t
 
buf
[16];

811 
ngtı2_¡İ_£ndšg
 
ä
, 
nä
;

812 
ssize_t
 
rv
;

813 
size_t
 
äam–’
 = 1 + 8 + 2;

815 
ä
.
ty³
 = 
NGTCP2_FRAME_STOP_SENDING
;

816 
ä
.
¡»am_id
 = 0xf1f2f3f4u;

817 
ä
.
­p_”rÜ_code
 = 0xe1e2u;

819 
rv
 = 
	`ngtı2_pkt_’code_¡İ_£ndšg_äame
(
buf
, (buf), &
ä
);

821 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

823 
rv
 = 
	`ngtı2_pkt_decode_¡İ_£ndšg_äame
(&
nä
, 
buf
, 
äam–’
);

825 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

826 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

827 
	`CU_ASSERT
(
ä
.
¡»am_id
 =ğ
nä
.stream_id);

828 
	`CU_ASSERT
(
ä
.
­p_”rÜ_code
 =ğ
nä
.app_error_code);

829 
	}
}

831 
	$‹¡_ngtı2_pkt_’code_·th_ch®Ënge_äame
() {

832 
ušt8_t
 
buf
[9];

833 
ngtı2_·th_ch®Ënge
 
ä
, 
nä
;

834 
ssize_t
 
rv
;

835 
size_t
 
äam–’
 = 1 + 8;

836 
size_t
 
i
;

838 
ä
.
ty³
 = 
NGTCP2_FRAME_PATH_CHALLENGE
;

839 
i
 = 0; i < (
ä
.
d©a
); ++i) {

840 
ä
.
d©a
[
i
] = (
ušt8_t
)(i + 1);

843 
rv
 = 
	`ngtı2_pkt_’code_·th_ch®Ënge_äame
(
buf
, (buf), &
ä
);

845 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

847 
rv
 = 
	`ngtı2_pkt_decode_·th_ch®Ënge_äame
(&
nä
, 
buf
, 
äam–’
);

849 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

850 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

851 
	`CU_ASSERT
(0 =ğ
	`memcmp
(
ä
.
d©a
, 
nä
.data, (fr.data)));

852 
	}
}

854 
	$‹¡_ngtı2_pkt_’code_·th_»¥Ú£_äame
() {

855 
ušt8_t
 
buf
[9];

856 
ngtı2_·th_»¥Ú£
 
ä
, 
nä
;

857 
ssize_t
 
rv
;

858 
size_t
 
äam–’
 = 1 + 8;

859 
size_t
 
i
;

861 
ä
.
ty³
 = 
NGTCP2_FRAME_PATH_RESPONSE
;

862 
i
 = 0; i < (
ä
.
d©a
); ++i) {

863 
ä
.
d©a
[
i
] = (
ušt8_t
)(i + 1);

866 
rv
 = 
	`ngtı2_pkt_’code_·th_»¥Ú£_äame
(
buf
, (buf), &
ä
);

868 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

870 
rv
 = 
	`ngtı2_pkt_decode_·th_»¥Ú£_äame
(&
nä
, 
buf
, 
äam–’
);

872 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

873 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

874 
	`CU_ASSERT
(0 =ğ
	`memcmp
(
ä
.
d©a
, 
nä
.data, (fr.data)));

875 
	}
}

877 
	$‹¡_ngtı2_pkt_’code_üy±o_äame
() {

878 cÚ¡ 
ušt8_t
 
d©a
[] = "0123456789abcdef1";

879 
ušt8_t
 
buf
[256];

880 
ngtı2_äame
 
ä
, 
nä
;

881 
ssize_t
 
rv
;

882 
size_t
 
äam–’
;

884 
ä
.
ty³
 = 
NGTCP2_FRAME_CRYPTO
;

885 
ä
.
üy±o
.
off£t
 = 0x31f2f3f4f5f6f7f8llu;

886 
ä
.
üy±o
.
d©aút
 = 1;

887 
ä
.
üy±o
.
d©a
[0].
Ën
 = 
	`¡rsize
(data);

888 
ä
.
üy±o
.
d©a
[0].
ba£
 = (
ušt8_t
 *)data;

890 
äam–’
 = 1 + 8 + 1 + 17;

892 
rv
 = 
	`ngtı2_pkt_’code_üy±o_äame
(
buf
, (buf), &
ä
.
üy±o
);

894 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

896 
rv
 = 
	`ngtı2_pkt_decode_üy±o_äame
(&
nä
.
üy±o
, 
buf
, 
äam–’
);

898 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

899 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

900 
	`CU_ASSERT
(
ä
.
üy±o
.
off£t
 =ğ
nä
.crypto.offset);

901 
	`CU_ASSERT
(
ä
.
üy±o
.
d©aút
 =ğ
nä
.crypto.datacnt);

902 
	`CU_ASSERT
(
ä
.
üy±o
.
d©a
[0].
Ën
 =ğ
nä
.crypto.data[0].len);

903 
	`CU_ASSERT
(0 =ğ
	`memcmp
(
ä
.
üy±o
.
d©a
[0].
ba£
, 
nä
.crypto.data[0].base,

904 
ä
.
üy±o
.
d©a
[0].
Ën
));

905 
	}
}

907 
	$‹¡_ngtı2_pkt_’code_Ãw_tok’_äame
() {

908 cÚ¡ 
ušt8_t
 
tok’
[] = "0123456789abcdef2";

909 
ušt8_t
 
buf
[256];

910 
ngtı2_äame
 
ä
, 
nä
;

911 
ssize_t
 
rv
;

912 
size_t
 
äam–’
;

914 
ä
.
ty³
 = 
NGTCP2_FRAME_NEW_TOKEN
;

915 
ä
.
Ãw_tok’
.
tok’Ën
 = 
	`¡rsize
(
tok’
);

916 
ä
.
Ãw_tok’
.
tok’
 =oken;

918 
äam–’
 = 1 + 1 + 
	`¡rsize
(
tok’
);

920 
rv
 = 
	`ngtı2_pkt_’code_Ãw_tok’_äame
(
buf
, (buf), &
ä
.
Ãw_tok’
);

922 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

924 
rv
 = 
	`ngtı2_pkt_decode_Ãw_tok’_äame
(&
nä
.
Ãw_tok’
, 
buf
, 
äam–’
);

926 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

927 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

928 
	`CU_ASSERT
(
ä
.
Ãw_tok’
.
tok’Ën
 =ğ
nä
.new_token.tokenlen);

929 
	`CU_ASSERT
(0 =ğ
	`memcmp
(
ä
.
Ãw_tok’
.
tok’
, 
nä
.new_token.token,

930 
ä
.
Ãw_tok’
.
tok’Ën
));

931 
	}
}

933 
	$‹¡_ngtı2_pkt_’code_»tœe_cÚÃùiÚ_id
() {

934 
ušt8_t
 
buf
[256];

935 
ngtı2_äame
 
ä
, 
nä
;

936 
ssize_t
 
rv
;

937 
size_t
 
äam–’
;

939 
ä
.
ty³
 = 
NGTCP2_FRAME_RETIRE_CONNECTION_ID
;

940 
ä
.
»tœe_cÚÃùiÚ_id
.
£q
 = 1000000007;

942 
äam–’
 = 1 + 
	`ngtı2_put_v¬št_Ën
(
ä
.
»tœe_cÚÃùiÚ_id
.
£q
);

944 
rv
 = 
	`ngtı2_pkt_’code_»tœe_cÚÃùiÚ_id_äame
(
buf
, (buf),

945 &
ä
.
»tœe_cÚÃùiÚ_id
);

947 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

949 
rv
 = 
	`ngtı2_pkt_decode_»tœe_cÚÃùiÚ_id_äame
(&
nä
.
»tœe_cÚÃùiÚ_id
,

950 
buf
, 
äam–’
);

952 
	`CU_ASSERT
((
ssize_t
)
äam–’
 =ğ
rv
);

953 
	`CU_ASSERT
(
ä
.
ty³
 =ğ
nä
.type);

954 
	`CU_ASSERT
(
ä
.
»tœe_cÚÃùiÚ_id
.
£q
 =ğ
nä
.retire_connection_id.seq);

955 
	}
}

957 
	$‹¡_ngtı2_pkt_adju¡_pkt_num
() {

958 
	`CU_ASSERT
(0xaa831f94llu ==

959 
	`ngtı2_pkt_adju¡_pkt_num
(0xaa82f30ellu, 0x1f94, 16));

961 
	`CU_ASSERT
(0x01fà=ğ
	`ngtı2_pkt_adju¡_pkt_num
(0x0100, 0xff, 8));

962 
	`CU_ASSERT
(0x02fà=ğ
	`ngtı2_pkt_adju¡_pkt_num
(0x01ff, 0xff, 8));

964 
	`CU_ASSERT
(0x3fffffffffffffabllu ==

965 
	`ngtı2_pkt_adju¡_pkt_num
(
NGTCP2_MAX_PKT_NUM
, 0xab, 8));

966 
	}
}

968 
	$‹¡_ngtı2_pkt_v®id©e_ack
() {

969 
rv
;

970 
ngtı2_ack
 
ä
;

973 
ä
.
Ïrge¡_ack
 = 1;

974 
ä
.
fœ¡_ack_blkËn
 = 2;

975 
ä
.
num_blks
 = 0;

977 
rv
 = 
	`ngtı2_pkt_v®id©e_ack
(&
ä
);

979 
	`CU_ASSERT
(
NGTCP2_ERR_ACK_FRAME
 =ğ
rv
);

982 
ä
.
Ïrge¡_ack
 = 250;

983 
ä
.
fœ¡_ack_blkËn
 = 1;

984 
ä
.
num_blks
 = 1;

985 
ä
.
blks
[0].
g­
 = 248;

986 
ä
.
blks
[0].
blkËn
 = 0;

988 
rv
 = 
	`ngtı2_pkt_v®id©e_ack
(&
ä
);

990 
	`CU_ASSERT
(
NGTCP2_ERR_ACK_FRAME
 =ğ
rv
);

993 
ä
.
Ïrge¡_ack
 = 250;

994 
ä
.
fœ¡_ack_blkËn
 = 0;

995 
ä
.
num_blks
 = 1;

996 
ä
.
blks
[0].
g­
 = 248;

997 
ä
.
blks
[0].
blkËn
 = 1;

999 
rv
 = 
	`ngtı2_pkt_v®id©e_ack
(&
ä
);

1001 
	`CU_ASSERT
(
NGTCP2_ERR_ACK_FRAME
 =ğ
rv
);

1002 
	}
}

1004 
	$‹¡_ngtı2_pkt_wr™e_¡©–ess_»£t
() {

1005 
ušt8_t
 
buf
[256];

1006 
ssize_t
 
¥k’
;

1007 
ušt8_t
 
tok’
[
NGTCP2_STATELESS_RESET_TOKENLEN
];

1008 
ušt8_t
 
¿nd
[256];

1009 
size_t
 
i
;

1010 
ušt8_t
 *
p
;

1011 
size_t
 
¿ndËn
;

1013 
	`mem£t
(
¿nd
, 0, (rand));

1014 
i
 = 0; i < 
NGTCP2_STATELESS_RESET_TOKENLEN
; ++i) {

1015 
tok’
[
i
] = (
ušt8_t
)(i + 1);

1018 
¥k’
 = 
	`ngtı2_pkt_wr™e_¡©–ess_»£t
(
buf
, (buf), 
tok’
, 
¿nd
,

1019 (
¿nd
));

1021 
p
 = 
buf
;

1023 
	`CU_ASSERT
(256 =ğ
¥k’
);

1024 
	`CU_ASSERT
(0 =ğ(*
p
 & 
NGTCP2_HEADER_FORM_BIT
));

1025 
	`CU_ASSERT
((*
p
 & 
NGTCP2_FIXED_BIT_MASK
));

1027 ++
p
;

1029 
¿ndËn
 = (
size_t
)(
¥k’
 - (
p
 - 
buf
è- 
NGTCP2_STATELESS_RESET_TOKENLEN
);

1031 
	`CU_ASSERT
(0 =ğ
	`memcmp
(
¿nd
, 
p
, 
¿ndËn
));

1033 
p
 +ğ
¿ndËn
;

1035 
	`CU_ASSERT
(0 =ğ
	`memcmp
(
tok’
, 
p
, 
NGTCP2_STATELESS_RESET_TOKENLEN
));

1037 
p
 +ğ
NGTCP2_STATELESS_RESET_TOKENLEN
;

1039 
	`CU_ASSERT
(
¥k’
 =ğ
p
 - 
buf
);

1042 
¥k’
 =

1043 
	`ngtı2_pkt_wr™e_¡©–ess_»£t
(
buf
,

1044 1 + 
NGTCP2_MIN_STATELESS_RESET_RANDLEN
 -

1045 1 + 
NGTCP2_STATELESS_RESET_TOKENLEN
,

1046 
tok’
, 
¿nd
, (rand));

1048 
	`CU_ASSERT
(
NGTCP2_ERR_NOBUF
 =ğ
¥k’
);

1049 
	}
}

1051 
	$‹¡_ngtı2_pkt_wr™e_»Œy
() {

1052 
ušt8_t
 
buf
[256];

1053 
ssize_t
 
¥k’
;

1054 
ngtı2_cid
 
scid
, 
dcid
, 
odcid
;

1055 
ngtı2_pkt_hd
 
hd
, 
nhd
;

1056 
ušt8_t
 
tok’
[32];

1057 
size_t
 
i
;

1058 
ngtı2_pkt_»Œy
 
»Œy
;

1059 
ssize_t
 
Ä—d
;

1060 
rv
;

1062 
	`scid_š™
(&
scid
);

1063 
	`dcid_š™
(&
dcid
);

1064 
	`rcid_š™
(&
odcid
);

1066 
i
 = 0; i < (
tok’
); ++i) {

1067 
tok’
[
i
] = (
ušt8_t
)i;

1070 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_LONG_FORM
, 
NGTCP2_PKT_RETRY
, &
dcid
,

1071 &
scid
, 0, 0, 
NGTCP2_PROTO_VER_D17
, 0);

1073 
¥k’
 = 
	`ngtı2_pkt_wr™e_»Œy
(
buf
, (buf), &
hd
, &
odcid
, 
tok’
,

1074 (
tok’
));

1076 
	`CU_ASSERT
(
¥k’
 > 0);

1078 
	`mem£t
(&
nhd
, 0, (nhd));

1080 
Ä—d
 = 
	`ngtı2_pkt_decode_hd_lÚg
(&
nhd
, 
buf
, (
size_t
)
¥k’
);

1082 
	`CU_ASSERT
(
Ä—d
 > 0);

1083 
	`CU_ASSERT
(
hd
.
ty³
 =ğ
nhd
.type);

1084 
	`CU_ASSERT
(
hd
.
v”siÚ
 =ğ
nhd
.version);

1085 
	`CU_ASSERT
(
	`ngtı2_cid_eq
(&
hd
.
dcid
, &
nhd
.dcid));

1086 
	`CU_ASSERT
(
	`ngtı2_cid_eq
(&
hd
.
scid
, &
nhd
.scid));

1088 
rv
 = 
	`ngtı2_pkt_decode_»Œy
(&
»Œy
, 
odcid
.
d©®’
, 
buf
 + 
Ä—d
,

1089 (
size_t
)(
¥k’
 - 
Ä—d
));

1091 
	`CU_ASSERT
(0 =ğ
rv
);

1092 
	`CU_ASSERT
(
	`ngtı2_cid_eq
(&
odcid
, &
»Œy
.odcid));

1093 
	`CU_ASSERT
(0 =ğ
	`memcmp
(
tok’
, 
»Œy
.token, (token)));

1094 
	}
}

1096 
	$‹¡_ngtı2_pkt_wr™e_v”siÚ_ÃgÙŸtiÚ
() {

1097 
ušt8_t
 
buf
[256];

1098 
ssize_t
 
¥k’
;

1099 cÚ¡ 
ušt32_t
 
sv
[] = {0xf1f2f3f4, 0x1f2f3f4f};

1100 
ušt8_t
 *
p
;

1101 
size_t
 
i
;

1102 
ngtı2_cid
 
dcid
, 
scid
;

1104 
	`dcid_š™
(&
dcid
);

1105 
	`scid_š™
(&
scid
);

1107 
¥k’
 = 
	`ngtı2_pkt_wr™e_v”siÚ_ÃgÙŸtiÚ
(
buf
, (buf), 133, &
dcid
,

1108 &
scid
, 
sv
, 
	`¬¿yËn
(sv));

1110 
	`CU_ASSERT
((
ssize_t
)(1 + 4 + 1 + 
dcid
.
d©®’
 + 
scid
.datalen +

1111 
	`¬¿yËn
(
sv
è* 4è=ğ
¥k’
);

1113 
p
 = 
buf
;

1115 
	`CU_ASSERT
((0x80 | 133è=ğ
buf
[0]);

1117 ++
p
;

1119 
	`CU_ASSERT
(0 =ğ
	`ngtı2_g‘_ušt32
(
p
));

1121 
p
 +ğ(
ušt32_t
);

1123 
	`CU_ASSERT
(
dcid
.
d©®’
 =ğ(
size_t
)((*
p
 >> 4) + 3));

1124 
	`CU_ASSERT
(
scid
.
d©®’
 =ğ(
size_t
)((*
p
 & 0xf) + 3));

1126 ++
p
;

1128 
	`CU_ASSERT
(0 =ğ
	`memcmp
(
dcid
.
d©a
, 
p
, dcid.
d©®’
));

1130 
p
 +ğ
dcid
.
d©®’
;

1132 
	`CU_ASSERT
(0 =ğ
	`memcmp
(
scid
.
d©a
, 
p
, scid.
d©®’
));

1134 
p
 +ğ
scid
.
d©®’
;

1136 
i
 = 0; i < 
	`¬¿yËn
(
sv
); ++i, 
p
 += 4) {

1137 
	`CU_ASSERT
(
sv
[
i
] =ğ
	`ngtı2_g‘_ušt32
(
p
));

1139 
	}
}

1141 
	$‹¡_ngtı2_pkt_¡»am_max_d©®’
() {

1142 
size_t
 
Ën
;

1144 
Ën
 = 
	`ngtı2_pkt_¡»am_max_d©®’
(63, 0, 0, 2);

1146 
	`CU_ASSERT
((
size_t
)-1 =ğ
Ën
);

1148 
Ën
 = 
	`ngtı2_pkt_¡»am_max_d©®’
(63, 0, 0, 3);

1150 
	`CU_ASSERT
(0 =ğ
Ën
);

1152 
Ën
 = 
	`ngtı2_pkt_¡»am_max_d©®’
(63, 0, 1, 3);

1154 
	`CU_ASSERT
(0 =ğ
Ën
);

1156 
Ën
 = 
	`ngtı2_pkt_¡»am_max_d©®’
(63, 0, 1, 4);

1158 
	`CU_ASSERT
(1 =ğ
Ën
);

1160 
Ën
 = 
	`ngtı2_pkt_¡»am_max_d©®’
(63, 1, 1, 4);

1162 
	`CU_ASSERT
(0 =ğ
Ën
);

1164 
Ën
 = 
	`ngtı2_pkt_¡»am_max_d©®’
(63, 0, 63, 66);

1166 
	`CU_ASSERT
(63 =ğ
Ën
);

1168 
Ën
 = 
	`ngtı2_pkt_¡»am_max_d©®’
(63, 0, 63, 65);

1170 
	`CU_ASSERT
(62 =ğ
Ën
);

1172 
Ën
 = 
	`ngtı2_pkt_¡»am_max_d©®’
(63, 0, 1396, 1400);

1174 
	`CU_ASSERT
(1396 =ğ
Ën
);

1176 
Ën
 = 
	`ngtı2_pkt_¡»am_max_d©®’
(63, 0, 1396, 1399);

1178 
	`CU_ASSERT
(1395 =ğ
Ën
);

1180 
Ën
 = 
	`ngtı2_pkt_¡»am_max_d©®’
(63, 0, 1396, 9);

1182 
	`CU_ASSERT
(6 =ğ
Ën
);

1184 
Ën
 = 
	`ngtı2_pkt_¡»am_max_d©®’
(63, 0, 16385, 16391);

1186 
	`CU_ASSERT
(16385 =ğ
Ën
);

1188 
Ën
 = 
	`ngtı2_pkt_¡»am_max_d©®’
(63, 0, 16385, 16390);

1190 
	`CU_ASSERT
(16384 =ğ
Ën
);

1192 
Ën
 = 
	`ngtı2_pkt_¡»am_max_d©®’
(63, 0, 1073741824, 1073741834);

1194 
	`CU_ASSERT
(1073741824 =ğ
Ën
);

1196 
Ën
 = 
	`ngtı2_pkt_¡»am_max_d©®’
(63, 0, 1073741824, 1073741833);

1198 
	`CU_ASSERT
(1073741823 =ğ
Ën
);

1200 
Ën
 = 
	`ngtı2_pkt_¡»am_max_d©®’
(63, 0, 16383, 16387);

1202 
	`CU_ASSERT
(16383 =ğ
Ën
);

1203 
	}
}

	@tests/ngtcp2_pkt_test.h

25 #iâdeà
NGTCP2_PKT_TEST_H


26 
	#NGTCP2_PKT_TEST_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
‹¡_ngtı2_pkt_decode_hd_lÚg
();

33 
‹¡_ngtı2_pkt_decode_hd_shÜt
();

34 
‹¡_ngtı2_pkt_decode_¡»am_äame
();

35 
‹¡_ngtı2_pkt_decode_ack_äame
();

36 
‹¡_ngtı2_pkt_decode_·ddšg_äame
();

37 
‹¡_ngtı2_pkt_’code_¡»am_äame
();

38 
‹¡_ngtı2_pkt_’code_ack_äame
();

39 
‹¡_ngtı2_pkt_’code_»£t_¡»am_äame
();

40 
‹¡_ngtı2_pkt_’code_cÚÃùiÚ_şo£_äame
();

41 
‹¡_ngtı2_pkt_’code_cÚÃùiÚ_şo£_­p_äame
();

42 
‹¡_ngtı2_pkt_’code_­¶iÿtiÚ_şo£_äame
();

43 
‹¡_ngtı2_pkt_’code_max_d©a_äame
();

44 
‹¡_ngtı2_pkt_’code_max_¡»am_d©a_äame
();

45 
‹¡_ngtı2_pkt_’code_max_¡»ams_äame
();

46 
‹¡_ngtı2_pkt_’code_pšg_äame
();

47 
‹¡_ngtı2_pkt_’code_d©a_blocked_äame
();

48 
‹¡_ngtı2_pkt_’code_¡»am_d©a_blocked_äame
();

49 
‹¡_ngtı2_pkt_’code_¡»ams_blocked_äame
();

50 
‹¡_ngtı2_pkt_’code_Ãw_cÚÃùiÚ_id_äame
();

51 
‹¡_ngtı2_pkt_’code_¡İ_£ndšg_äame
();

52 
‹¡_ngtı2_pkt_’code_·th_ch®Ënge_äame
();

53 
‹¡_ngtı2_pkt_’code_·th_»¥Ú£_äame
();

54 
‹¡_ngtı2_pkt_’code_üy±o_äame
();

55 
‹¡_ngtı2_pkt_’code_Ãw_tok’_äame
();

56 
‹¡_ngtı2_pkt_’code_»tœe_cÚÃùiÚ_id
();

57 
‹¡_ngtı2_pkt_adju¡_pkt_num
();

58 
‹¡_ngtı2_pkt_v®id©e_ack
();

59 
‹¡_ngtı2_pkt_wr™e_¡©–ess_»£t
();

60 
‹¡_ngtı2_pkt_wr™e_»Œy
();

61 
‹¡_ngtı2_pkt_wr™e_v”siÚ_ÃgÙŸtiÚ
();

62 
‹¡_ngtı2_pkt_¡»am_max_d©®’
();

	@tests/ngtcp2_psl_test.c

25 
	~"ngtı2_p¦_‹¡.h
"

27 
	~<CUn™/CUn™.h
>

29 
	~"ngtı2_p¦.h
"

30 
	~"ngtı2_‹¡_h–³r.h
"

32 
	$‹¡_ngtı2_p¦_š£¹
() {

33 cÚ¡ 
ngtı2_¿nge
 
keys
[] = {

37 
ngtı2_p¦
 
p¦
;

38 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

39 
size_t
 
i
;

40 
ngtı2_¿nge
 
r
;

41 
ngtı2_p¦_™
 
™
;

43 
	`ngtı2_p¦_š™
(&
p¦
, 
mem
);

45 
i
 = 0; i < 
	`¬¿yËn
(
keys
); ++i) {

46 
	`ngtı2_p¦_š£¹
(&
p¦
, 
NULL
, &
keys
[
i
], NULL);

47 
™
 = 
	`ngtı2_p¦_low”_bound
(&
p¦
, &
keys
[
i
]);

48 
r
 = 
	`ngtı2_p¦_™_¿nge
(&
™
);

49 
	`CU_ASSERT
(
	`ngtı2_¿nge_eq
(&
keys
[
i
], &
r
));

52 
i
 = 0; i < 
	`¬¿yËn
(
keys
); ++i) {

53 
	`ngtı2_p¦_»move
(&
p¦
, 
NULL
, &
keys
[
i
]);

54 
™
 = 
	`ngtı2_p¦_low”_bound
(&
p¦
, &
keys
[
i
]);

55 
r
 = 
	`ngtı2_p¦_™_¿nge
(&
™
);

57 
	`CU_ASSERT
(
keys
[
i
].
’d
 <ğ
r
.
begš
);

60 
	`ngtı2_p¦_ä“
(&
p¦
);

63 
	`ngtı2_p¦_š™
(&
p¦
, 
mem
);

65 
i
 = 0; i < 16; ++i) {

66 
	`ngtı2_¿nge_š™
(&
r
, 
i
, i + 1);

67 
	`ngtı2_p¦_š£¹
(&
p¦
, 
NULL
, &
r
, NULL);

71 
	`ngtı2_¿nge_š™
(&
r
, 7, 8);

72 
	`ngtı2_p¦_»move
(&
p¦
, &
™
, &
r
);

73 
r
 = 
	`ngtı2_p¦_™_¿nge
(&
™
);

75 
	`CU_ASSERT
(8 =ğ
r
.
begš
);

76 
	`CU_ASSERT
(9 =ğ
r
.
’d
);

78 
™
 = 
	`ngtı2_p¦_low”_bound
(&
p¦
, &
r
);

79 
r
 = 
	`ngtı2_p¦_™_¿nge
(&
™
);

81 
	`CU_ASSERT
(8 =ğ
r
.
begš
);

82 
	`CU_ASSERT
(9 =ğ
r
.
’d
);

84 
r
 = 
p¦
.
h—d
->
nodes
[0].
¿nge
;

86 
	`CU_ASSERT
(8 =ğ
r
.
begš
);

87 
	`CU_ASSERT
(9 =ğ
r
.
’d
);

89 
	`ngtı2_p¦_ä“
(&
p¦
);

93 
	`ngtı2_p¦_š™
(&
p¦
, 
mem
);

95 
i
 = 0; i < 120; ++i) {

96 
	`ngtı2_¿nge_š™
(&
r
, 
i
, i + 1);

97 
	`ngtı2_p¦_š£¹
(&
p¦
, 
NULL
, &
r
, NULL);

100 
	`ngtı2_¿nge_š™
(&
r
, 63, 64);

101 
	`ngtı2_p¦_»move
(&
p¦
, &
™
, &
r
);

102 
r
 = 
	`ngtı2_p¦_™_¿nge
(&
™
);

104 
	`CU_ASSERT
(64 =ğ
r
.
begš
);

105 
	`CU_ASSERT
(65 =ğ
r
.
’d
);

107 
™
 = 
	`ngtı2_p¦_low”_bound
(&
p¦
, &
r
);

108 
r
 = 
	`ngtı2_p¦_™_¿nge
(&
™
);

110 
	`CU_ASSERT
(64 =ğ
r
.
begš
);

111 
	`CU_ASSERT
(65 =ğ
r
.
’d
);

113 
	`ngtı2_p¦_ä“
(&
p¦
);

116 
	`ngtı2_p¦_š™
(&
p¦
, 
mem
);

118 
i
 = 0; i < 15; ++i) {

119 
	`ngtı2_¿nge_š™
(&
r
, 
i
, i + 1);

120 
	`ngtı2_p¦_š£¹
(&
p¦
, 
NULL
, &
r
, NULL);

124 
	`ngtı2_¿nge_š™
(&
r
, 6, 7);

125 
	`ngtı2_p¦_»move
(&
p¦
, 
NULL
, &
r
);

127 
	`ngtı2_¿nge_š™
(&
r
, 7, 8);

128 
	`ngtı2_p¦_»move
(&
p¦
, 
NULL
, &
r
);

130 
	`ngtı2_¿nge_š™
(&
r
, 8, 9);

131 
	`ngtı2_p¦_»move
(&
p¦
, 
NULL
, &
r
);

133 
	`CU_ASSERT
(13 =ğ
p¦
.
h—d
->
n
);

135 
	`ngtı2_p¦_ä“
(&
p¦
);

138 
	`ngtı2_p¦_š™
(&
p¦
, 
mem
);

140 
i
 = 0; i < 15 + 8; ++i) {

141 
	`ngtı2_¿nge_š™
(&
r
, 
i
, i + 1);

142 
	`ngtı2_p¦_š£¹
(&
p¦
, 
NULL
, &
r
, NULL);

146 
	`ngtı2_¿nge_š™
(&
r
, 6, 7);

147 
	`ngtı2_p¦_»move
(&
p¦
, 
NULL
, &
r
);

149 
	`ngtı2_¿nge_š™
(&
r
, 5, 6);

150 
	`ngtı2_p¦_»move
(&
p¦
, 
NULL
, &
r
);

152 
	`ngtı2_¿nge_š™
(&
r
, 8, 9);

153 
	`ngtı2_p¦_»move
(&
p¦
, 
NULL
, &
r
);

155 
	`CU_ASSERT
(2 =ğ
p¦
.
h—d
->
n
);

156 
	`CU_ASSERT
(13 =ğ
p¦
.
h—d
->
nodes
[0].
blk
->
n
);

157 
	`CU_ASSERT
(8 =ğ
p¦
.
h—d
->
nodes
[1].
blk
->
n
);

159 
	`ngtı2_p¦_ä“
(&
p¦
);

162 
	`ngtı2_p¦_š™
(&
p¦
, 
mem
);

164 
i
 = 0; i < 7609; ++i) {

165 
	`ngtı2_¿nge_š™
(&
r
, 
i
, i + 1);

166 
	`ngtı2_p¦_š£¹
(&
p¦
, 
NULL
, &
r
, NULL);

169 
	`ngtı2_¿nge_š™
(&
r
, 999, 1000);

170 
	`ngtı2_p¦_»move
(&
p¦
, 
NULL
, &
r
);

172 
	`CU_ASSERT
(2 =ğ
p¦
.
h—d
->
n
);

174 
	`ngtı2_p¦_ä“
(&
p¦
);

177 
	`ngtı2_p¦_š™
(&
p¦
, 
mem
);

179 
i
 = 0; i < 22; ++i) {

180 
	`ngtı2_¿nge_š™
(&
r
, 
i
, i + 1);

181 
	`ngtı2_p¦_š£¹
(&
p¦
, 
NULL
, &
r
, NULL);

184 
	`CU_ASSERT
(2 =ğ
p¦
.
h—d
->
n
);

186 
	`ngtı2_¿nge_š™
(&
r
, 21, 22);

187 
	`ngtı2_p¦_»move
(&
p¦
, 
NULL
, &
r
);

189 
	`CU_ASSERT
(3 =ğ
p¦
.
h—d
->
n
);

191 
	`ngtı2_p¦_ä“
(&
p¦
);

194 
	`ngtı2_p¦_š™
(&
p¦
, 
mem
);

196 
i
 = 1; i < 1500; i += 100) {

197 
	`ngtı2_¿nge_š™
(&
r
, 
i
, i + 1);

198 
	`ngtı2_p¦_š£¹
(&
p¦
, 
NULL
, &
r
, NULL);

201 
	`ngtı2_¿nge_š™
(&
r
, 1401, 1402);

202 
	`ngtı2_p¦_»move
(&
p¦
, 
NULL
, &
r
);

203 
	`ngtı2_¿nge_š™
(&
r
, 1301, 1302);

204 
	`ngtı2_p¦_»move
(&
p¦
, 
NULL
, &
r
);

206 
	`CU_ASSERT
(701 =ğ
p¦
.
h—d
->
nodes
[1].
blk
->nodes[0].
¿nge
.
begš
);

208 
	`ngtı2_p¦_ä“
(&
p¦
);

211 
	`ngtı2_p¦_š™
(&
p¦
, 
mem
);

213 
i
 = 0; i < 15; ++i) {

214 
	`ngtı2_¿nge_š™
(&
r
, 
i
, i + 1);

215 
	`ngtı2_p¦_š£¹
(&
p¦
, 
NULL
, &
r
, NULL);

218 
	`ngtı2_¿nge_š™
(&
r
, 6, 7);

219 
	`ngtı2_p¦_»move
(&
p¦
, 
NULL
, &
r
);

220 
	`ngtı2_¿nge_š™
(&
r
, 5, 6);

221 
	`ngtı2_p¦_»move
(&
p¦
, 
NULL
, &
r
);

223 
	`CU_ASSERT
(

225 
p¦
.
h—d
->
nodes
[0].
blk
->nodes[p¦.h—d->nodes[0].blk->
n
 - 1].
¿nge
.
begš
);

227 
	`ngtı2_p¦_ä“
(&
p¦
);

230 
	`ngtı2_p¦_š™
(&
p¦
, 
mem
);

232 
i
 = 0; i < 130; ++i) {

233 
	`ngtı2_¿nge_š™
(&
r
, 
i
, i + 1);

234 
	`ngtı2_p¦_š£¹
(&
p¦
, 
NULL
, &
r
, NULL);

237 
i
 = 116; i <= 129; ++i) {

238 
	`ngtı2_¿nge_š™
(&
r
, 
i
, i + 1);

239 
	`ngtı2_p¦_»move
(&
p¦
, 
NULL
, &
r
);

242 
	`CU_ASSERT
(2 =ğ
p¦
.
h—d
->
n
);

244 
	`ngtı2_¿nge_š™
(&
r
, 55, 56);

245 
	`ngtı2_p¦_»move
(&
p¦
, 
NULL
, &
r
);

247 
	`CU_ASSERT
(14 =ğ
p¦
.
h—d
->
n
);

249 
	`ngtı2_p¦_ä“
(&
p¦
);

250 
	}
}

	@tests/ngtcp2_psl_test.h

25 #iâdeà
NGTCP2_PSL_TEST_H


26 
	#NGTCP2_PSL_TEST_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
‹¡_ngtı2_p¦_š£¹
();

	@tests/ngtcp2_pv_test.c

25 
	~"ngtı2_pv_‹¡.h
"

27 
	~<CUn™/CUn™.h
>

29 
	~"ngtı2_pv.h
"

30 
	~"ngtı2_‹¡_h–³r.h
"

32 
	$‹¡_ngtı2_pv_add_’Œy
() {

33 
ngtı2_pv
 *
pv
;

34 
rv
;

35 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

36 
ngtı2_cid
 
cid
;

37 cÚ¡ 
ušt8_t
 
tok’
[
NGTCP2_STATELESS_RESET_TOKENLEN
] = {0xff};

38 
ngtı2_dcid
 
dcid
;

39 
ngtı2_log
 
log
;

40 
ušt8_t
 
d©a
[8];

41 
size_t
 
i
;

42 
ngtı2_du¿tiÚ
 
timeout
 = 100ULL * 
NGTCP2_SECONDS
;

43 
ngtı2_t¡amp
 
t
 = 1;

45 
	`dcid_š™
(&
cid
);

46 
	`ngtı2_dcid_š™
(&
dcid
, 1000000007, &
cid
, 
tok’
);

47 
	`ngtı2_log_š™
(&
log
, 
NULL
, NULL, 0, NULL);

49 
rv
 = 
	`ngtı2_pv_Ãw
(&
pv
, &
dcid
, 
timeout
, 
NGTCP2_PV_FLAG_NONE
, &
log
, 
mem
);

51 
	`CU_ASSERT
(0 =ğ
rv
);

53 
	`ngtı2_pv_’su»_¡¬t
(
pv
, 
t
);

55 
	`mem£t
(
d©a
, 0, (data));

57 
i
 = 0; i < 
NGTCP2_PV_MAX_ENTRIES
 - 1; ++i) {

58 
	`ngtı2_pv_add_’Œy
(
pv
, 
d©a
, 100 + 
i
);

60 
	`CU_ASSERT
(
i
 + 1 =ğ
	`ngtı2_ršgbuf_Ën
(&
pv
->
’ts
));

61 
	`CU_ASSERT
(!
	`ngtı2_pv_fuÎ
(
pv
));

64 
	`ngtı2_pv_add_’Œy
(
pv
, 
d©a
, 100 + 
NGTCP2_PV_MAX_ENTRIES
);

66 
	`CU_ASSERT
(
NGTCP2_PV_MAX_ENTRIES
 =ğ
	`ngtı2_ršgbuf_Ën
(&
pv
->
’ts
));

67 
	`CU_ASSERT
(
	`ngtı2_pv_fuÎ
(
pv
));

68 
	`CU_ASSERT
(100 =ğ
	`ngtı2_pv_Ãxt_expœy
(
pv
));

70 
	`ngtı2_pv_hªdË_’Œy_expœy
(
pv
, 100);

72 
	`CU_ASSERT
(
NGTCP2_PV_MAX_ENTRIES
 - 1 =ğ
	`ngtı2_ršgbuf_Ën
(&
pv
->
’ts
));

73 
	`CU_ASSERT
(101 =ğ
	`ngtı2_pv_Ãxt_expœy
(
pv
));

75 
	`ngtı2_pv_hªdË_’Œy_expœy
(
pv
, 100 + 
NGTCP2_PV_MAX_ENTRIES
);

77 
	`CU_ASSERT
(0 =ğ
	`ngtı2_ršgbuf_Ën
(&
pv
->
’ts
));

78 
	`CU_ASSERT
(
timeout
 + 
t
 =ğ
	`ngtı2_pv_Ãxt_expœy
(
pv
));

80 
	`ngtı2_pv_d–
(
pv
);

81 
	}
}

83 
	$‹¡_ngtı2_pv_v®id©e
() {

84 
ngtı2_pv
 *
pv
;

85 
rv
;

86 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

87 
ngtı2_cid
 
cid
;

88 cÚ¡ 
ušt8_t
 
tok’
[
NGTCP2_STATELESS_RESET_TOKENLEN
] = {0xff};

89 
ngtı2_dcid
 
dcid
;

90 
ngtı2_log
 
log
;

91 
ušt8_t
 
d©a
[8];

92 
ngtı2_du¿tiÚ
 
timeout
 = 100ULL * 
NGTCP2_SECONDS
;

93 
ngtı2_t¡amp
 
t
 = 1;

94 
ngtı2_·th
 
·th
 = {{1, (
ušt8_t
 *)"1"}, {1, (uint8_t *)"2"}};

95 
ngtı2_·th
 
®t_·th
 = {{1, (
ušt8_t
 *)"3"}, {1, (uint8_t *)"4"}};

97 
	`dcid_š™
(&
cid
);

98 
	`ngtı2_dcid_š™
(&
dcid
, 1000000007, &
cid
, 
tok’
);

99 
	`ngtı2_·th_cİy
(&
dcid
.
·th
, &path);

100 
	`ngtı2_log_š™
(&
log
, 
NULL
, NULL, 0, NULL);

102 
rv
 = 
	`ngtı2_pv_Ãw
(&
pv
, &
dcid
, 
timeout
, 
NGTCP2_PV_FLAG_NONE
, &
log
, 
mem
);

104 
	`CU_ASSERT
(0 =ğ
rv
);

106 
	`ngtı2_pv_’su»_¡¬t
(
pv
, 
t
);

108 
	`mem£t
(
d©a
, 0, (data));

109 
	`ngtı2_pv_add_’Œy
(
pv
, 
d©a
, 100);

111 
	`mem£t
(
d©a
, 1, (data));

112 
	`ngtı2_pv_add_’Œy
(
pv
, 
d©a
, 100);

114 
	`mem£t
(
d©a
, 2, (data));

115 
	`ngtı2_pv_add_’Œy
(
pv
, 
d©a
, 100);

117 
	`mem£t
(
d©a
, 1, (data));

118 
rv
 = 
	`ngtı2_pv_v®id©e
(
pv
, &
®t_·th
, 
d©a
);

120 
	`CU_ASSERT
(
NGTCP2_ERR_INVALID_ARGUMENT
 =ğ
rv
);

122 
rv
 = 
	`ngtı2_pv_v®id©e
(
pv
, &
·th
, 
d©a
);

124 
	`CU_ASSERT
(0 =ğ
rv
);

126 
	`mem£t
(
d©a
, 3, (data));

127 
rv
 = 
	`ngtı2_pv_v®id©e
(
pv
, &
·th
, 
d©a
);

129 
	`CU_ASSERT
(
NGTCP2_ERR_INVALID_ARGUMENT
 =ğ
rv
);

131 
	`ngtı2_pv_d–
(
pv
);

132 
	}
}

	@tests/ngtcp2_pv_test.h

25 #iâdeà
NGTCP2_PV_TEST_H


26 
	#NGTCP2_PV_TEST_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
‹¡_ngtı2_pv_add_’Œy
();

33 
‹¡_ngtı2_pv_v®id©e
();

	@tests/ngtcp2_range_test.c

25 
	~"ngtı2_¿nge_‹¡.h
"

27 
	~<CUn™/CUn™.h
>

29 
	~"ngtı2_¿nge.h
"

30 
	~"ngtı2_‹¡_h–³r.h
"

32 
	$‹¡_ngtı2_¿nge_š‹r£ù
() {

33 
ngtı2_¿nge
 
a
, 
b
, 
c
;

35 
	`ngtı2_¿nge_š™
(&
a
, 0, 
UINT64_MAX
);

36 
	`ngtı2_¿nge_š™
(&
b
, 0, 1000000007);

37 
c
 = 
	`ngtı2_¿nge_š‹r£ù
(&
a
, &
b
);

39 
	`CU_ASSERT
(0 =ğ
c
.
begš
);

40 
	`CU_ASSERT
(1000000007 =ğ
c
.
’d
);

42 
	`ngtı2_¿nge_š™
(&
a
, 1000000007, 
UINT64_MAX
);

43 
	`ngtı2_¿nge_š™
(&
b
, 0, 
UINT64_MAX
);

44 
c
 = 
	`ngtı2_¿nge_š‹r£ù
(&
a
, &
b
);

46 
	`CU_ASSERT
(1000000007 =ğ
c
.
begš
);

47 
	`CU_ASSERT
(
UINT64_MAX
 =ğ
c
.
’d
);

49 
	`ngtı2_¿nge_š™
(&
a
, 0, 
UINT64_MAX
);

50 
	`ngtı2_¿nge_š™
(&
b
, 33333, 55555);

51 
c
 = 
	`ngtı2_¿nge_š‹r£ù
(&
a
, &
b
);

53 
	`CU_ASSERT
(33333 =ğ
c
.
begš
);

54 
	`CU_ASSERT
(55555 =ğ
c
.
’d
);

56 
	`ngtı2_¿nge_š™
(&
a
, 0, 1000000009);

57 
	`ngtı2_¿nge_š™
(&
b
, 1000000007, 
UINT64_MAX
);

58 
c
 = 
	`ngtı2_¿nge_š‹r£ù
(&
a
, &
b
);

60 
	`CU_ASSERT
(1000000007 =ğ
c
.
begš
);

61 
	`CU_ASSERT
(1000000009 =ğ
c
.
’d
);

62 
	}
}

64 
	$‹¡_ngtı2_¿nge_cut
() {

65 
ngtı2_¿nge
 
a
, 
b
, 
l
, 
r
;

67 
	`ngtı2_¿nge_š™
(&
a
, 0, 
UINT64_MAX
);

68 
	`ngtı2_¿nge_š™
(&
b
, 1000000007, 1000000009);

69 
	`ngtı2_¿nge_cut
(&
l
, &
r
, &
a
, &
b
);

71 
	`CU_ASSERT
(0 =ğ
l
.
begš
);

72 
	`CU_ASSERT
(1000000007 =ğ
l
.
’d
);

73 
	`CU_ASSERT
(1000000009 =ğ
r
.
begš
);

74 
	`CU_ASSERT
(
UINT64_MAX
 =ğ
r
.
’d
);

76 
	`ngtı2_¿nge_š™
(&
a
, 0, 
UINT64_MAX
);

77 
	`ngtı2_¿nge_š™
(&
b
, 0, 1000000007);

78 
	`ngtı2_¿nge_cut
(&
l
, &
r
, &
a
, &
b
);

80 
	`CU_ASSERT
(0 =ğ
	`ngtı2_¿nge_Ën
(&
l
));

81 
	`CU_ASSERT
(1000000007 =ğ
r
.
begš
);

82 
	`CU_ASSERT
(
UINT64_MAX
 =ğ
r
.
’d
);

84 
	`ngtı2_¿nge_š™
(&
a
, 0, 
UINT64_MAX
);

85 
	`ngtı2_¿nge_š™
(&
b
, 1000000009, 
UINT64_MAX
);

86 
	`ngtı2_¿nge_cut
(&
l
, &
r
, &
a
, &
b
);

88 
	`CU_ASSERT
(0 =ğ
l
.
begš
);

89 
	`CU_ASSERT
(1000000009 =ğ
l
.
’d
);

90 
	`CU_ASSERT
(0 =ğ
	`ngtı2_¿nge_Ën
(&
r
));

91 
	}
}

93 
	$‹¡_ngtı2_¿nge_nÙ_aá”
() {

94 
ngtı2_¿nge
 
a
, 
b
;

96 
	`ngtı2_¿nge_š™
(&
a
, 1, 1000000007);

97 
	`ngtı2_¿nge_š™
(&
b
, 0, 1000000007);

99 
	`CU_ASSERT
(
	`ngtı2_¿nge_nÙ_aá”
(&
a
, &
b
));

101 
	`ngtı2_¿nge_š™
(&
a
, 1, 1000000008);

102 
	`ngtı2_¿nge_š™
(&
b
, 0, 1000000007);

104 
	`CU_ASSERT
(!
	`ngtı2_¿nge_nÙ_aá”
(&
a
, &
b
));

105 
	}
}

	@tests/ngtcp2_range_test.h

25 #iâdeà
NGTCP2_RANGE_TEST_H


26 
	#NGTCP2_RANGE_TEST_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
‹¡_ngtı2_¿nge_š‹r£ù
();

33 
‹¡_ngtı2_¿nge_cut
();

34 
‹¡_ngtı2_¿nge_nÙ_aá”
();

	@tests/ngtcp2_ringbuf_test.c

25 
	~"ngtı2_ršgbuf_‹¡.h
"

27 
	~<CUn™/CUn™.h
>

29 
	~"ngtı2_ršgbuf.h
"

30 
	~"ngtı2_‹¡_h–³r.h
"

33 
št32_t
 
	ma
;

34 
ušt64_t
 
	mb
;

35 } 
	tšts
;

37 
	$‹¡_ngtı2_ršgbuf_push_äÚt
() {

38 
ngtı2_ršgbuf
 
rb
;

39 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

40 
size_t
 
i
;

42 
	`ngtı2_ršgbuf_š™
(&
rb
, 64, (
šts
), 
mem
);

44 
i
 = 0; i < 64; ++i) {

45 
šts
 *
p
 = 
	`ngtı2_ršgbuf_push_äÚt
(&
rb
);

46 
p
->
a
 = (
št32_t
)(
i
 + 1);

47 
p
->
b
 = (
i
 + 1) * 10;

50 
	`CU_ASSERT
(64 =ğ
	`ngtı2_ršgbuf_Ën
(&
rb
));

52 
i
 = 0; i < 64; ++i) {

53 
šts
 *
p
 = 
	`ngtı2_ršgbuf_g‘
(&
rb
, 
i
);

54 
	`CU_ASSERT
((
št32_t
)(64 - 
i
è=ğ
p
->
a
);

55 
	`CU_ASSERT
((64 - 
i
è* 10 =ğ
p
->
b
);

58 
	`ngtı2_ršgbuf_push_äÚt
(&
rb
);

60 
	`CU_ASSERT
(64 =ğ
	`ngtı2_ršgbuf_Ën
(&
rb
));

61 
	`CU_ASSERT
((
št32_t
)64 =ğ((
šts
 *)
	`ngtı2_ršgbuf_g‘
(&
rb
, 1))->
a
);

63 
	`ngtı2_ršgbuf_ä“
(&
rb
);

64 
	}
}

66 
	$‹¡_ngtı2_ršgbuf_pİ_äÚt
() {

67 
ngtı2_ršgbuf
 
rb
;

68 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

69 
size_t
 
i
;

71 
	`ngtı2_ršgbuf_š™
(&
rb
, 4, (
šts
), 
mem
);

73 
i
 = 0; i < 5; ++i) {

74 
šts
 *
p
 = 
	`ngtı2_ršgbuf_push_äÚt
(&
rb
);

75 
p
->
a
 = (
št32_t
)
i
;

78 
	`CU_ASSERT
(4 =ğ
	`ngtı2_ršgbuf_Ën
(&
rb
));

80 
i
 = 4; i >= 1; --i) {

81 
šts
 *
p
 = 
	`ngtı2_ršgbuf_g‘
(&
rb
, 0);

83 
	`CU_ASSERT
((
št32_t
)
i
 =ğ
p
->
a
);

85 
	`ngtı2_ršgbuf_pİ_äÚt
(&
rb
);

88 
	`CU_ASSERT
(0 =ğ
	`ngtı2_ršgbuf_Ën
(&
rb
));

90 
	`ngtı2_ršgbuf_ä“
(&
rb
);

91 
	}
}

	@tests/ngtcp2_ringbuf_test.h

25 #iâdeà
NGTCP2_RINGBUF_TEST_H


26 
	#NGTCP2_RINGBUF_TEST_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
‹¡_ngtı2_ršgbuf_push_äÚt
();

33 
‹¡_ngtı2_ršgbuf_pİ_äÚt
();

	@tests/ngtcp2_rob_test.c

25 
	~"ngtı2_rob_‹¡.h
"

27 
	~<CUn™/CUn™.h
>

29 
	~"ngtı2_rob.h
"

30 
	~"ngtı2_‹¡_h–³r.h
"

31 
	~"ngtı2_mem.h
"

32 
	~"ngtı2_maüo.h
"

34 
	$‹¡_ngtı2_rob_push
() {

35 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

36 
ngtı2_rob
 
rob
;

37 
rv
;

38 
ušt8_t
 
d©a
[256];

39 
ngtı2_rob_g­
 *
g
;

40 
ngtı2_p¦_™
 
™
;

43 
	`ngtı2_rob_š™
(&
rob
, 64, 
mem
);

45 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 34567, 
d©a
, 145);

47 
	`CU_ASSERT
(0 =ğ
rv
);

49 
™
 = 
	`ngtı2_p¦_begš
(&
rob
.
g­p¦
);

50 
g
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

52 
	`CU_ASSERT
(0 =ğ
g
->
¿nge
.
begš
);

53 
	`CU_ASSERT
(34567 =ğ
g
->
¿nge
.
’d
);

55 
	`ngtı2_p¦_™_Ãxt
(&
™
);

56 
g
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

58 
	`CU_ASSERT
(34567 + 145 =ğ
g
->
¿nge
.
begš
);

59 
	`CU_ASSERT
(
UINT64_MAX
 =ğ
g
->
¿nge
.
’d
);

61 
	`ngtı2_p¦_™_Ãxt
(&
™
);

63 
	`CU_ASSERT
(
	`ngtı2_p¦_™_’d
(&
™
));

65 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 34565, 
d©a
, 1);

67 
	`CU_ASSERT
(0 =ğ
rv
);

69 
™
 = 
	`ngtı2_p¦_begš
(&
rob
.
g­p¦
);

70 
g
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

72 
	`CU_ASSERT
(0 =ğ
g
->
¿nge
.
begš
);

73 
	`CU_ASSERT
(34565 =ğ
g
->
¿nge
.
’d
);

75 
	`ngtı2_p¦_™_Ãxt
(&
™
);

76 
g
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

78 
	`CU_ASSERT
(34566 =ğ
g
->
¿nge
.
begš
);

79 
	`CU_ASSERT
(34567 =ğ
g
->
¿nge
.
’d
);

81 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 34563, 
d©a
, 1);

83 
	`CU_ASSERT
(0 =ğ
rv
);

85 
™
 = 
	`ngtı2_p¦_begš
(&
rob
.
g­p¦
);

86 
g
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

88 
	`CU_ASSERT
(0 =ğ
g
->
¿nge
.
begš
);

89 
	`CU_ASSERT
(34563 =ğ
g
->
¿nge
.
’d
);

91 
	`ngtı2_p¦_™_Ãxt
(&
™
);

92 
g
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

94 
	`CU_ASSERT
(34564 =ğ
g
->
¿nge
.
begš
);

95 
	`CU_ASSERT
(34565 =ğ
g
->
¿nge
.
’d
);

97 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 34561, 
d©a
, 151);

99 
	`CU_ASSERT
(0 =ğ
rv
);

101 
™
 = 
	`ngtı2_p¦_begš
(&
rob
.
g­p¦
);

102 
g
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

104 
	`CU_ASSERT
(0 =ğ
g
->
¿nge
.
begš
);

105 
	`CU_ASSERT
(34561 =ğ
g
->
¿nge
.
’d
);

107 
	`ngtı2_p¦_™_Ãxt
(&
™
);

108 
g
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

110 
	`CU_ASSERT
(34567 + 145 =ğ
g
->
¿nge
.
begš
);

111 
	`CU_ASSERT
(
UINT64_MAX
 =ğ
g
->
¿nge
.
’d
);

113 
	`ngtı2_p¦_™_Ãxt
(&
™
);

115 
	`CU_ASSERT
(
	`ngtı2_p¦_™_’d
(&
™
));

117 
	`ngtı2_rob_ä“
(&
rob
);

120 
	`ngtı2_rob_š™
(&
rob
, 64, 
mem
);

122 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 0, 
d©a
, 123);

124 
	`CU_ASSERT
(0 =ğ
rv
);

126 
™
 = 
	`ngtı2_p¦_begš
(&
rob
.
g­p¦
);

127 
g
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

129 
	`CU_ASSERT
(123 =ğ
g
->
¿nge
.
begš
);

130 
	`CU_ASSERT
(
UINT64_MAX
 =ğ
g
->
¿nge
.
’d
);

132 
	`ngtı2_p¦_™_Ãxt
(&
™
);

134 
	`CU_ASSERT
(
	`ngtı2_p¦_™_’d
(&
™
));

136 
	`ngtı2_rob_ä“
(&
rob
);

139 
	`ngtı2_rob_š™
(&
rob
, 64, 
mem
);

141 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 
UINT64_MAX
 - 123, 
d©a
, 123);

143 
	`CU_ASSERT
(0 =ğ
rv
);

145 
™
 = 
	`ngtı2_p¦_begš
(&
rob
.
g­p¦
);

146 
g
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

148 
	`CU_ASSERT
(0 =ğ
g
->
¿nge
.
begš
);

149 
	`CU_ASSERT
(
UINT64_MAX
 - 123 =ğ
g
->
¿nge
.
’d
);

151 
	`ngtı2_p¦_™_Ãxt
(&
™
);

153 
	`CU_ASSERT
(
	`ngtı2_p¦_™_’d
(&
™
));

155 
	`ngtı2_rob_ä“
(&
rob
);

156 
	}
}

158 
ngtı2_¿nge
 
	g¿ndkeys
[] = {

260 
	$‹¡_ngtı2_rob_push_¿ndom
() {

261 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

262 
ngtı2_rob
 
rob
;

263 
rv
;

264 
ušt8_t
 
d©a
[512];

265 
size_t
 
i
;

267 
	`ngtı2_rob_š™
(&
rob
, 1024 * 1024, 
mem
);

268 
i
 = 0; i < 
	`¬¿yËn
(
¿ndkeys
); ++i) {

269 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 
¿ndkeys
[
i
].
begš
, &
d©a
[0],

270 
	`ngtı2_¿nge_Ën
(&
¿ndkeys
[
i
]));

272 
	`CU_ASSERT
(0 =ğ
rv
);

275 
	`CU_ASSERT
(51401 =ğ
	`ngtı2_rob_fœ¡_g­_off£t
(&
rob
));

277 
	`ngtı2_rob_ä“
(&
rob
);

278 
	}
}

280 
	$‹¡_ngtı2_rob_d©a_©
() {

281 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

282 
ngtı2_rob
 
rob
;

283 
rv
;

284 
ušt8_t
 
d©a
[256];

285 
size_t
 
i
;

286 cÚ¡ 
ušt8_t
 *
p
;

287 
size_t
 
Ën
;

288 
ngtı2_rob_d©a
 *
d
;

289 
ngtı2_p¦_™
 
™
;

290 
ngtı2_rob_g­
 *
g
;

292 
i
 = 0; i < (
d©a
); ++i) {

293 
d©a
[
i
] = (
ušt8_t
)i;

296 
	`ngtı2_rob_š™
(&
rob
, 16, 
mem
);

298 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 3, &
d©a
[3], 13);

300 
	`CU_ASSERT
(0 =ğ
rv
);

302 
Ën
 = 
	`ngtı2_rob_d©a_©
(&
rob
, &
p
, 0);

304 
	`CU_ASSERT
(0 =ğ
Ën
);

306 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 0, &
d©a
[0], 3);

308 
	`CU_ASSERT
(0 =ğ
rv
);

310 
Ën
 = 
	`ngtı2_rob_d©a_©
(&
rob
, &
p
, 0);

312 
	`CU_ASSERT
(16 =ğ
Ën
);

314 
i
 = 0; i < 
Ën
; ++i) {

315 
	`CU_ASSERT
((
ušt8_t
)
i
 =ğ*(
p
 + i));

318 
	`ngtı2_rob_pİ
(&
rob
, 0, 
Ën
);

320 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 16, &
d©a
[16], 5);

322 
	`CU_ASSERT
(0 =ğ
rv
);

324 
Ën
 = 
	`ngtı2_rob_d©a_©
(&
rob
, &
p
, 16);

326 
	`CU_ASSERT
(5 =ğ
Ën
);

328 
i
 = 16; i < 
Ën
; ++i) {

329 
	`CU_ASSERT
((
ušt8_t
)
i
 =ğ*(
p
 + i));

332 
	`ngtı2_rob_ä“
(&
rob
);

335 
	`ngtı2_rob_š™
(&
rob
, 16, 
mem
);

337 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 0, &
d©a
[0], 47);

339 
	`CU_ASSERT
(0 =ğ
rv
);

341 
Ën
 = 
	`ngtı2_rob_d©a_©
(&
rob
, &
p
, 0);

343 
	`CU_ASSERT
(16 =ğ
Ën
);

345 
	`ngtı2_rob_pİ
(&
rob
, 0, 
Ën
);

346 
Ën
 = 
	`ngtı2_rob_d©a_©
(&
rob
, &
p
, 16);

348 
	`CU_ASSERT
(16 =ğ
Ën
);

350 
	`ngtı2_rob_pİ
(&
rob
, 16, 
Ën
);

351 
Ën
 = 
	`ngtı2_rob_d©a_©
(&
rob
, &
p
, 32);

353 
	`CU_ASSERT
(15 =ğ
Ën
);

355 
	`ngtı2_rob_pİ
(&
rob
, 32, 
Ën
);

356 
	`ngtı2_rob_ä“
(&
rob
);

360 
	`ngtı2_rob_š™
(&
rob
, 16, 
mem
);

362 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 17, &
d©a
[17], 2);

364 
	`CU_ASSERT
(0 =ğ
rv
);

366 
Ën
 = 
	`ngtı2_rob_d©a_©
(&
rob
, &
p
, 0);

368 
	`CU_ASSERT
(0 =ğ
Ën
);

370 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 0, &
d©a
[0], 3);

372 
	`CU_ASSERT
(0 =ğ
rv
);

374 
Ën
 = 
	`ngtı2_rob_d©a_©
(&
rob
, &
p
, 0);

376 
	`CU_ASSERT
(3 =ğ
Ën
);

378 
	`ngtı2_rob_pİ
(&
rob
, 0, 
Ën
);

380 
Ën
 = 
	`ngtı2_rob_d©a_©
(&
rob
, &
p
, 3);

382 
	`CU_ASSERT
(0 =ğ
Ën
);

384 
	`ngtı2_rob_ä“
(&
rob
);

388 
	`ngtı2_rob_š™
(&
rob
, 16, 
mem
);

390 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 0, &
d©a
[0], 3);

392 
	`CU_ASSERT
(0 =ğ
rv
);

394 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 16, &
d©a
[16], 32);

396 
	`CU_ASSERT
(0 =ğ
rv
);

398 
™
 = 
	`ngtı2_p¦_begš
(&
rob
.
d©­¦
);

399 
	`ngtı2_p¦_™_Ãxt
(&
™
);

400 
d
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

402 
	`CU_ASSERT
(16 =ğ
d
->
¿nge
.
begš
);

404 
	`ngtı2_p¦_™_Ãxt
(&
™
);

405 
d
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

407 
	`CU_ASSERT
(32 =ğ
d
->
¿nge
.
begš
);

409 
	`ngtı2_p¦_™_Ãxt
(&
™
);

411 
	`CU_ASSERT
(
	`ngtı2_p¦_™_’d
(&
™
));

413 
	`ngtı2_rob_ä“
(&
rob
);

416 
	`ngtı2_rob_š™
(&
rob
, 16, 
mem
);

418 
i
 = 0; i < (
d©a
); i += 2) {

419 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 
i
, &
d©a
[i], 1);

421 
	`CU_ASSERT
(0 =ğ
rv
);

424 
i
 = 1; i < (
d©a
); i += 2) {

425 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 
i
, &
d©a
[i], 1);

427 
	`CU_ASSERT
(0 =ğ
rv
);

430 
i
 = 0; i < (
d©a
) / 16; ++i) {

431 
Ën
 = 
	`ngtı2_rob_d©a_©
(&
rob
, &
p
, 
i
 * 16);

433 
	`CU_ASSERT
(16 =ğ
Ën
);

435 
	`ngtı2_rob_pİ
(&
rob
, 
i
 * 16, 
Ën
);

438 
™
 = 
	`ngtı2_p¦_begš
(&
rob
.
g­p¦
);

439 
g
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

441 
	`CU_ASSERT
(256 =ğ
g
->
¿nge
.
begš
);

443 
™
 = 
	`ngtı2_p¦_begš
(&
rob
.
d©­¦
);

445 
	`CU_ASSERT
(
	`ngtı2_p¦_™_’d
(&
™
));

447 
	`ngtı2_rob_ä“
(&
rob
);

450 
	`ngtı2_rob_š™
(&
rob
, 16, 
mem
);

452 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 0, &
d©a
[0], 5);

454 
	`CU_ASSERT
(0 =ğ
rv
);

456 
Ën
 = 
	`ngtı2_rob_d©a_©
(&
rob
, &
p
, 0);

458 
	`CU_ASSERT
(5 =ğ
Ën
);

460 
	`ngtı2_rob_pİ
(&
rob
, 0, 
Ën
);

462 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 2, &
d©a
[2], 8);

464 
	`CU_ASSERT
(0 =ğ
rv
);

466 
Ën
 = 
	`ngtı2_rob_d©a_©
(&
rob
, &
p
, 5);

468 
	`CU_ASSERT
(5 =ğ
Ën
);

470 
	`ngtı2_rob_pİ
(&
rob
, 5, 
Ën
);

472 
	`ngtı2_rob_ä“
(&
rob
);

475 
	`ngtı2_rob_š™
(&
rob
, 16, 
mem
);

477 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 0, &
d©a
[0], 16);

479 
	`CU_ASSERT
(0 =ğ
rv
);

481 
Ën
 = 
	`ngtı2_rob_d©a_©
(&
rob
, &
p
, 0);

483 
	`CU_ASSERT
(16 =ğ
Ën
);

485 
	`ngtı2_rob_pİ
(&
rob
, 0, 
Ën
);

487 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 0, &
d©a
[0], 32);

489 
	`CU_ASSERT
(0 =ğ
rv
);

491 
Ën
 = 
	`ngtı2_rob_d©a_©
(&
rob
, &
p
, 16);

493 
	`CU_ASSERT
(16 =ğ
Ën
);

495 
	`ngtı2_rob_pİ
(&
rob
, 16, 
Ën
);

497 
	`ngtı2_rob_ä“
(&
rob
);

498 
	}
}

500 
	$‹¡_ngtı2_rob_»move_´efix
() {

501 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

502 
ngtı2_rob
 
rob
;

503 
ngtı2_rob_g­
 *
g
;

504 
ngtı2_rob_d©a
 *
d
;

505 
ngtı2_p¦_™
 
™
;

506 
ušt8_t
 
d©a
[256];

507 
rv
;

510 
	`ngtı2_rob_š™
(&
rob
, 16, 
mem
);

512 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 1, &
d©a
[1], 32);

514 
	`CU_ASSERT
(0 =ğ
rv
);

516 
	`ngtı2_rob_»move_´efix
(&
rob
, 33);

518 
™
 = 
	`ngtı2_p¦_begš
(&
rob
.
g­p¦
);

519 
g
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

521 
	`CU_ASSERT
(33 =ğ
g
->
¿nge
.
begš
);

523 
™
 = 
	`ngtı2_p¦_begš
(&
rob
.
d©­¦
);

524 
d
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

526 
	`CU_ASSERT
(32 =ğ
d
->
¿nge
.
begš
);

528 
	`ngtı2_rob_ä“
(&
rob
);

531 
	`ngtı2_rob_š™
(&
rob
, 16, 
mem
);

533 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 1, &
d©a
[1], 3);

535 
	`CU_ASSERT
(0 =ğ
rv
);

537 
rv
 = 
	`ngtı2_rob_push
(&
rob
, 5, &
d©a
[5], 2);

539 
	`CU_ASSERT
(0 =ğ
rv
);

541 
	`ngtı2_rob_»move_´efix
(&
rob
, 16);

543 
™
 = 
	`ngtı2_p¦_begš
(&
rob
.
g­p¦
);

544 
g
 = 
	`ngtı2_p¦_™_g‘
(&
™
);

546 
	`CU_ASSERT
(16 =ğ
g
->
¿nge
.
begš
);

548 
	`ngtı2_p¦_™_Ãxt
(&
™
);

550 
	`CU_ASSERT
(
	`ngtı2_p¦_™_’d
(&
™
));

552 
	`ngtı2_rob_ä“
(&
rob
);

553 
	}
}

	@tests/ngtcp2_rob_test.h

25 #iâdeà
NGTCP2_ROB_TEST_H


26 
	#NGTCP2_ROB_TEST_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
‹¡_ngtı2_rob_push
();

33 
‹¡_ngtı2_rob_push_¿ndom
();

34 
‹¡_ngtı2_rob_d©a_©
();

35 
‹¡_ngtı2_rob_»move_´efix
();

	@tests/ngtcp2_rtb_test.c

25 
	~"ngtı2_¹b_‹¡.h
"

27 
	~<CUn™/CUn™.h
>

29 
	~"ngtı2_¹b.h
"

30 
	~"ngtı2_‹¡_h–³r.h
"

31 
	~"ngtı2_mem.h
"

32 
	~"ngtı2_pkt.h
"

34 
	$cc_¡©_š™
(
ngtı2_cc_¡©
 *
ccs
) {

35 
	`mem£t
(
ccs
, 0, (
ngtı2_cc_¡©
));

36 
	}
}

38 
	$‹¡_ngtı2_¹b_add
() {

39 
ngtı2_¹b
 
¹b
;

40 
ngtı2_¹b_’Œy
 *
’t
;

41 
rv
;

42 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

43 
ngtı2_pkt_hd
 
hd
;

44 
ngtı2_log
 
log
;

45 
ngtı2_cid
 
dcid
;

46 
ngtı2_k¦_™
 
™
;

47 
ngtı2_cc_¡©
 
ccs
;

48 
ngtı2_deçuÉ_cc
 
cc
;

50 
	`dcid_š™
(&
dcid
);

51 
	`cc_¡©_š™
(&
ccs
);

52 
	`ngtı2_log_š™
(&
log
, 
NULL
, NULL, 0, NULL);

53 
	`ngtı2_deçuÉ_cc_š™
(&
cc
, &
ccs
, &
log
);

54 
	`ngtı2_¹b_š™
(&
¹b
, &
cc
, &
log
, 
mem
);

56 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_NONE
, 
NGTCP2_PKT_SHORT
, &
dcid
, 
NULL
,

57 1000000007, 1, 
NGTCP2_PROTO_VER_MAX
, 0);

59 
rv
 = 
	`ngtı2_¹b_’Œy_Ãw
(&
’t
, &
hd
, 
NULL
, 10, 0, 
NGTCP2_RTB_FLAG_NONE
, 
mem
);

61 
	`CU_ASSERT
(0 =ğ
rv
);

63 
	`ngtı2_¹b_add
(&
¹b
, 
’t
);

65 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_NONE
, 
NGTCP2_PKT_SHORT
, &
dcid
, 
NULL
,

66 1000000008, 2, 
NGTCP2_PROTO_VER_MAX
, 0);

68 
rv
 = 
	`ngtı2_¹b_’Œy_Ãw
(&
’t
, &
hd
, 
NULL
, 9, 0, 
NGTCP2_RTB_FLAG_NONE
, 
mem
);

70 
	`CU_ASSERT
(0 =ğ
rv
);

72 
	`ngtı2_¹b_add
(&
¹b
, 
’t
);

74 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_NONE
, 
NGTCP2_PKT_SHORT
, &
dcid
, 
NULL
,

75 1000000009, 4, 
NGTCP2_PROTO_VER_MAX
, 0);

77 
rv
 = 
	`ngtı2_¹b_’Œy_Ãw
(&
’t
, &
hd
, 
NULL
, 11, 0, 
NGTCP2_RTB_FLAG_NONE
, 
mem
);

79 
	`CU_ASSERT
(0 =ğ
rv
);

81 
	`ngtı2_¹b_add
(&
¹b
, 
’t
);

83 
™
 = 
	`ngtı2_¹b_h—d
(&
¹b
);

84 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

87 
	`CU_ASSERT
(1000000009 =ğ
’t
->
hd
.
pkt_num
);

89 
	`ngtı2_k¦_™_Ãxt
(&
™
);

90 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

92 
	`CU_ASSERT
(1000000008 =ğ
’t
->
hd
.
pkt_num
);

94 
	`ngtı2_k¦_™_Ãxt
(&
™
);

95 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

97 
	`CU_ASSERT
(1000000007 =ğ
’t
->
hd
.
pkt_num
);

99 
	`ngtı2_k¦_™_Ãxt
(&
™
);

101 
	`CU_ASSERT
(
	`ngtı2_k¦_™_’d
(&
™
));

103 
	`ngtı2_¹b_ä“
(&
¹b
);

104 
	`ngtı2_deçuÉ_cc_ä“
(&
cc
);

105 
	}
}

107 
	$add_¹b_’Œy_¿nge
(
ngtı2_¹b
 *
¹b
, 
ušt64_t
 
ba£_pkt_num
,

108 
size_t
 
Ën
, 
ngtı2_mem
 *
mem
) {

109 
ngtı2_pkt_hd
 
hd
;

110 
ngtı2_¹b_’Œy
 *
’t
;

111 
ušt64_t
 
i
;

112 
ngtı2_cid
 
dcid
;

114 
	`dcid_š™
(&
dcid
);

116 
i
 = 
ba£_pkt_num
; i < ba£_pkt_num + 
Ën
; ++i) {

117 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_NONE
, 
NGTCP2_PKT_SHORT
, &
dcid
, 
NULL
,

118 
i
, 1, 
NGTCP2_PROTO_VER_MAX
, 0);

119 
	`ngtı2_¹b_’Œy_Ãw
(&
’t
, &
hd
, 
NULL
, 0, 0, 
NGTCP2_RTB_FLAG_NONE
, 
mem
);

120 
	`ngtı2_¹b_add
(
¹b
, 
’t
);

122 
	}
}

124 
	$£tup_¹b_fixtu»
(
ngtı2_¹b
 *
¹b
, 
ngtı2_mem
 *
mem
) {

126 
	`add_¹b_’Œy_¿nge
(
¹b
, 100, 55, 
mem
);

128 
	`add_¹b_’Œy_¿nge
(
¹b
, 180, 5, 
mem
);

130 
	`add_¹b_’Œy_¿nge
(
¹b
, 440, 7, 
mem
);

131 
	}
}

133 
	$as£¹_¹b_’Œy_nÙ_found
(
ngtı2_¹b
 *
¹b
, 
ušt64_t
 
pkt_num
) {

134 
ngtı2_k¦_™
 
™
 = 
	`ngtı2_¹b_h—d
(
¹b
);

135 
ngtı2_¹b_’Œy
 *
’t
;

137 ; !
	`ngtı2_k¦_™_’d
(&
™
); 
	`ngtı2_k¦_™_Ãxt
(&it)) {

138 
’t
 = 
	`ngtı2_k¦_™_g‘
(&
™
);

139 
	`CU_ASSERT
(
’t
->
hd
.
pkt_num
 !=…kt_num);

141 
	}
}

143 
	$‹¡_ngtı2_¹b_»cv_ack
() {

144 
ngtı2_¹b
 
¹b
;

145 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

146 
ngtı2_max_äame
 
mä
;

147 
ngtı2_ack
 *
ä
 = &
mä
.
ackä
.
ack
;

148 
ngtı2_ack_blk
 *
blks
;

149 
ngtı2_log
 
log
;

150 
ngtı2_cc_¡©
 
ccs
;

151 
ngtı2_deçuÉ_cc
 
cc
;

152 
ngtı2_pkt_hd
 
hd
;

154 
	`ngtı2_log_š™
(&
log
, 
NULL
, NULL, 0, NULL);

155 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_NONE
, 
NGTCP2_PKT_SHORT
, 
NULL
, NULL, 0,

156 1, 
NGTCP2_PROTO_VER_MAX
, 0);

159 
	`cc_¡©_š™
(&
ccs
);

160 
	`ngtı2_deçuÉ_cc_š™
(&
cc
, &
ccs
, &
log
);

161 
	`ngtı2_¹b_š™
(&
¹b
, &
cc
, &
log
, 
mem
);

162 
	`£tup_¹b_fixtu»
(&
¹b
, 
mem
);

164 
	`CU_ASSERT
(67 =ğ
	`ngtı2_k¦_Ën
(&
¹b
.
’ts
));

166 
ä
->
Ïrge¡_ack
 = 446;

167 
ä
->
fœ¡_ack_blkËn
 = 1;

168 
ä
->
num_blks
 = 0;

170 
	`ngtı2_¹b_»cv_ack
(&
¹b
, 
ä
, 
NULL
, 1000000009);

172 
	`CU_ASSERT
(65 =ğ
	`ngtı2_k¦_Ën
(&
¹b
.
’ts
));

173 
	`as£¹_¹b_’Œy_nÙ_found
(&
¹b
, 446);

174 
	`as£¹_¹b_’Œy_nÙ_found
(&
¹b
, 445);

176 
	`ngtı2_¹b_ä“
(&
¹b
);

177 
	`ngtı2_deçuÉ_cc_ä“
(&
cc
);

180 
	`cc_¡©_š™
(&
ccs
);

181 
	`ngtı2_deçuÉ_cc_š™
(&
cc
, &
ccs
, &
log
);

182 
	`ngtı2_¹b_š™
(&
¹b
, &
cc
, &
log
, 
mem
);

183 
	`£tup_¹b_fixtu»
(&
¹b
, 
mem
);

185 
ä
->
Ïrge¡_ack
 = 441;

186 
ä
->
fœ¡_ack_blkËn
 = 3;

187 
ä
->
num_blks
 = 2;

188 
blks
 = 
ä
->blks;

189 
blks
[0].
g­
 = 253;

190 
blks
[0].
blkËn
 = 0;

191 
blks
[1].
g­
 = 1;

192 
blks
[1].
blkËn
 = 1;

194 
	`ngtı2_¹b_»cv_ack
(&
¹b
, 
ä
, 
NULL
, 1000000009);

196 
	`CU_ASSERT
(63 =ğ
	`ngtı2_k¦_Ën
(&
¹b
.
’ts
));

197 
	`CU_ASSERT
(441 =ğ
¹b
.
Ïrge¡_acked_tx_pkt_num
);

198 
	`as£¹_¹b_’Œy_nÙ_found
(&
¹b
, 441);

199 
	`as£¹_¹b_’Œy_nÙ_found
(&
¹b
, 440);

200 
	`as£¹_¹b_’Œy_nÙ_found
(&
¹b
, 183);

201 
	`as£¹_¹b_’Œy_nÙ_found
(&
¹b
, 180);

203 
	`ngtı2_¹b_ä“
(&
¹b
);

204 
	`ngtı2_deçuÉ_cc_ä“
(&
cc
);

207 
	`cc_¡©_š™
(&
ccs
);

208 
	`ngtı2_deçuÉ_cc_š™
(&
cc
, &
ccs
, &
log
);

209 
	`ngtı2_¹b_š™
(&
¹b
, &
cc
, &
log
, 
mem
);

210 
	`add_¹b_’Œy_¿nge
(&
¹b
, 0, 1, 
mem
);

212 
ä
->
Ïrge¡_ack
 = 250;

213 
ä
->
fœ¡_ack_blkËn
 = 0;

214 
ä
->
num_blks
 = 1;

215 
ä
->
blks
[0].
g­
 = 248;

216 
ä
->
blks
[0].
blkËn
 = 0;

218 
	`ngtı2_¹b_»cv_ack
(&
¹b
, 
ä
, 
NULL
, 1000000009);

220 
	`as£¹_¹b_’Œy_nÙ_found
(&
¹b
, 0);

222 
	`ngtı2_¹b_ä“
(&
¹b
);

223 
	`ngtı2_deçuÉ_cc_ä“
(&
cc
);

226 
	`cc_¡©_š™
(&
ccs
);

227 
	`ngtı2_deçuÉ_cc_š™
(&
cc
, &
ccs
, &
log
);

228 
	`ngtı2_¹b_š™
(&
¹b
, &
cc
, &
log
, 
mem
);

229 
	`add_¹b_’Œy_¿nge
(&
¹b
, 0, 1, 
mem
);

231 
ä
->
Ïrge¡_ack
 = 0;

232 
ä
->
fœ¡_ack_blkËn
 = 0;

233 
ä
->
num_blks
 = 0;

235 
	`ngtı2_¹b_»cv_ack
(&
¹b
, 
ä
, 
NULL
, 1000000009);

237 
	`as£¹_¹b_’Œy_nÙ_found
(&
¹b
, 0);

239 
	`ngtı2_¹b_ä“
(&
¹b
);

240 
	`ngtı2_deçuÉ_cc_ä“
(&
cc
);

243 
	`cc_¡©_š™
(&
ccs
);

244 
	`ngtı2_deçuÉ_cc_š™
(&
cc
, &
ccs
, &
log
);

245 
	`ngtı2_¹b_š™
(&
¹b
, &
cc
, &
log
, 
mem
);

246 
	`add_¹b_’Œy_¿nge
(&
¹b
, 0, 1, 
mem
);

248 
ä
->
Ïrge¡_ack
 = 2;

249 
ä
->
fœ¡_ack_blkËn
 = 0;

250 
ä
->
num_blks
 = 1;

251 
ä
->
blks
[0].
g­
 = 0;

252 
ä
->
blks
[0].
blkËn
 = 0;

254 
	`ngtı2_¹b_»cv_ack
(&
¹b
, 
ä
, 
NULL
, 1000000009);

256 
	`as£¹_¹b_’Œy_nÙ_found
(&
¹b
, 0);

258 
	`ngtı2_¹b_ä“
(&
¹b
);

259 
	`ngtı2_deçuÉ_cc_ä“
(&
cc
);

260 
	}
}

262 
	$‹¡_ngtı2_¹b_ş—r
() {

263 
ngtı2_¹b
 
¹b
;

264 
ngtı2_¹b_’Œy
 *
’t
;

265 
rv
;

266 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

267 
ngtı2_pkt_hd
 
hd
;

268 
ngtı2_log
 
log
;

269 
ngtı2_cid
 
dcid
;

270 
ngtı2_cc_¡©
 
ccs
;

271 
ngtı2_deçuÉ_cc
 
cc
;

273 
	`dcid_š™
(&
dcid
);

274 
	`cc_¡©_š™
(&
ccs
);

275 
	`ngtı2_log_š™
(&
log
, 
NULL
, NULL, 0, NULL);

276 
	`ngtı2_deçuÉ_cc_š™
(&
cc
, &
ccs
, &
log
);

277 
	`ngtı2_¹b_š™
(&
¹b
, &
cc
, &
log
, 
mem
);

279 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_NONE
, 
NGTCP2_PKT_SHORT
, &
dcid
, 
NULL
,

280 1000000007, 1, 
NGTCP2_PROTO_VER_MAX
, 0);

282 
rv
 =

283 
	`ngtı2_¹b_’Œy_Ãw
(&
’t
, &
hd
, 
NULL
, 10, 111, 
NGTCP2_RTB_FLAG_NONE
, 
mem
);

285 
	`CU_ASSERT
(0 =ğ
rv
);

287 
	`ngtı2_¹b_add
(&
¹b
, 
’t
);

289 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_NONE
, 
NGTCP2_PKT_SHORT
, &
dcid
, 
NULL
,

290 1000000009, 1, 
NGTCP2_PROTO_VER_MAX
, 0);

292 
rv
 =

293 
	`ngtı2_¹b_’Œy_Ãw
(&
’t
, &
hd
, 
NULL
, 11, 123, 
NGTCP2_RTB_FLAG_NONE
, 
mem
);

295 
	`CU_ASSERT
(0 =ğ
rv
);

297 
	`ngtı2_¹b_add
(&
¹b
, 
’t
);

298 
	`ngtı2_¹b_ş—r
(&
¹b
);

300 
	`CU_ASSERT
(0 =ğ
ccs
.
by‹s_š_æight
);

301 
	`CU_ASSERT
(-1 =ğ
¹b
.
Ïrge¡_acked_tx_pkt_num
);

302 
	`CU_ASSERT
(0 =ğ
	`ngtı2_k¦_Ën
(&
¹b
.
’ts
));

304 
	`ngtı2_¹b_ä“
(&
¹b
);

305 
	`ngtı2_deçuÉ_cc_ä“
(&
cc
);

306 
	}
}

	@tests/ngtcp2_rtb_test.h

25 #iâdeà
NGTCP2_RTB_TEST_H


26 
	#NGTCP2_RTB_TEST_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
‹¡_ngtı2_¹b_add
();

33 
‹¡_ngtı2_¹b_»cv_ack
();

34 
‹¡_ngtı2_¹b_ş—r
();

	@tests/ngtcp2_strm_test.c

25 
	~"ngtı2_¡rm_‹¡.h
"

27 
	~<CUn™/CUn™.h
>

29 
	~"ngtı2_¡rm.h
"

30 
	~"ngtı2_‹¡_h–³r.h
"

32 
ušt8_t
 
	gnuÎd©a
[1024];

34 
	$£tup_¡rm_¡»amäq_fixtu»
(
ngtı2_¡rm
 *
¡rm
, 
ngtı2_mem
 *
mem
) {

35 
ngtı2_¡»am_äame_chaš
 *
äc
;

36 
ngtı2_vec
 *
d©a
;

38 
	`ngtı2_¡rm_š™
(
¡rm
, 0, 
NGTCP2_STRM_FLAG_NONE
, 0, 0, 
NULL
, 
mem
);

40 
	`ngtı2_¡»am_äame_chaš_Ãw
(&
äc
, 
mem
);

41 
äc
->
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

42 
äc
->
ä
.
fš
 = 0;

43 
äc
->
ä
.
off£t
 = 0;

44 
äc
->
ä
.
d©aút
 = 2;

45 
d©a
 = 
äc
->
ä
.data;

46 
d©a
[0].
Ën
 = 11;

47 
d©a
[0].
ba£
 = 
nuÎd©a
;

48 
d©a
[1].
Ën
 = 19;

49 
d©a
[1].
ba£
 = 
nuÎd©a
 + 11;

51 
	`ngtı2_¡rm_¡»amäq_push
(
¡rm
, 
äc
);

53 
	`ngtı2_¡»am_äame_chaš_Ãw
(&
äc
, 
mem
);

54 
äc
->
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

55 
äc
->
ä
.
fš
 = 0;

56 
äc
->
ä
.
off£t
 = 30;

57 
äc
->
ä
.
d©aút
 = 2;

58 
d©a
 = 
äc
->
ä
.data;

59 
d©a
[0].
Ën
 = 17;

60 
d©a
[0].
ba£
 = 
nuÎd©a
 + 30;

61 
d©a
[1].
Ën
 = 29;

62 
d©a
[1].
ba£
 = 
nuÎd©a
 + 30 + 17;

64 
	`ngtı2_¡rm_¡»amäq_push
(
¡rm
, 
äc
);

66 
	`ngtı2_¡»am_äame_chaš_Ãw
(&
äc
, 
mem
);

67 
äc
->
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

68 
äc
->
ä
.
fš
 = 0;

69 
äc
->
ä
.
off£t
 = 76;

70 
äc
->
ä
.
d©aút
 = 2;

71 
d©a
 = 
äc
->
ä
.data;

72 
d©a
[0].
Ën
 = 31;

73 
d©a
[0].
ba£
 = 
nuÎd©a
 + 256;

74 
d©a
[1].
Ën
 = 1;

75 
d©a
[1].
ba£
 = 
nuÎd©a
 + 512;

77 
	`ngtı2_¡rm_¡»amäq_push
(
¡rm
, 
äc
);

78 
	}
}

80 
	$‹¡_ngtı2_¡rm_¡»amäq_pİ
() {

81 
ngtı2_¡rm
 
¡rm
;

82 
ngtı2_¡»am_äame_chaš
 *
äc
;

83 
ngtı2_mem
 *
mem
 = 
	`ngtı2_mem_deçuÉ
();

84 
rv
;

85 
ngtı2_vec
 *
d©a
;

88 
	`£tup_¡rm_¡»amäq_fixtu»
(&
¡rm
, 
mem
);

90 
äc
 = 
NULL
;

91 
rv
 = 
	`ngtı2_¡rm_¡»amäq_pİ
(&
¡rm
, &
äc
, 30);

93 
	`CU_ASSERT
(0 =ğ
rv
);

94 
	`CU_ASSERT
(2 =ğ
äc
->
ä
.
d©aút
);

96 
d©a
 = 
äc
->
ä
.data;

98 
	`CU_ASSERT
(11 =ğ
d©a
[0].
Ën
);

99 
	`CU_ASSERT
(19 =ğ
d©a
[1].
Ën
);

100 
	`CU_ASSERT
(2 =ğ
	`ngtı2_pq_size
(&
¡rm
.
¡»amäq
));

102 
	`ngtı2_¡»am_äame_chaš_d–
(
äc
, 
mem
);

103 
	`ngtı2_¡rm_ä“
(&
¡rm
);

106 
	`£tup_¡rm_¡»amäq_fixtu»
(&
¡rm
, 
mem
);

108 
äc
 = 
NULL
;

109 
rv
 = 
	`ngtı2_¡rm_¡»amäq_pİ
(&
¡rm
, &
äc
, 76);

111 
	`CU_ASSERT
(0 =ğ
rv
);

112 
	`CU_ASSERT
(2 =ğ
äc
->
ä
.
d©aút
);

114 
d©a
 = 
äc
->
ä
.data;

116 
	`CU_ASSERT
(11 =ğ
d©a
[0].
Ën
);

117 
	`CU_ASSERT
(19 + 46 =ğ
d©a
[1].
Ën
);

118 
	`CU_ASSERT
(1 =ğ
	`ngtı2_pq_size
(&
¡rm
.
¡»amäq
));

120 
	`ngtı2_¡»am_äame_chaš_d–
(
äc
, 
mem
);

121 
	`ngtı2_¡rm_ä“
(&
¡rm
);

124 
	`£tup_¡rm_¡»amäq_fixtu»
(&
¡rm
, 
mem
);

126 
äc
 = 
NULL
;

127 
rv
 = 
	`ngtı2_¡rm_¡»amäq_pİ
(&
¡rm
, &
äc
, 75);

129 
	`CU_ASSERT
(0 =ğ
rv
);

130 
	`CU_ASSERT
(2 =ğ
äc
->
ä
.
d©aút
);

132 
d©a
 = 
äc
->
ä
.data;

134 
	`CU_ASSERT
(11 =ğ
d©a
[0].
Ën
);

135 
	`CU_ASSERT
(19 + 45 =ğ
d©a
[1].
Ën
);

136 
	`CU_ASSERT
(2 =ğ
	`ngtı2_pq_size
(&
¡rm
.
¡»amäq
));

138 
	`ngtı2_¡»am_äame_chaš_d–
(
äc
, 
mem
);

140 
äc
 = 
NULL
;

141 
rv
 = 
	`ngtı2_¡rm_¡»amäq_pİ
(&
¡rm
, &
äc
, 1);

143 
	`CU_ASSERT
(0 =ğ
rv
);

144 
	`CU_ASSERT
(75 =ğ
äc
->
ä
.
off£t
);

145 
	`CU_ASSERT
(1 =ğ
äc
->
ä
.
d©aút
);

146 
	`CU_ASSERT
(1 =ğ
äc
->
ä
.
d©a
[0].
Ën
);

147 
	`CU_ASSERT
(
nuÎd©a
 + 30 + 17 + 28 =ğ
äc
->
ä
.
d©a
[0].
ba£
);

149 
	`ngtı2_¡»am_äame_chaš_d–
(
äc
, 
mem
);

150 
	`ngtı2_¡rm_ä“
(&
¡rm
);

153 
	`£tup_¡rm_¡»amäq_fixtu»
(&
¡rm
, 
mem
);

155 
äc
 = 
NULL
;

156 
rv
 = 
	`ngtı2_¡rm_¡»amäq_pİ
(&
¡rm
, &
äc
, 77);

158 
	`CU_ASSERT
(0 =ğ
rv
);

159 
	`CU_ASSERT
(3 =ğ
äc
->
ä
.
d©aút
);

161 
d©a
 = 
äc
->
ä
.data;

163 
	`CU_ASSERT
(11 =ğ
d©a
[0].
Ën
);

164 
	`CU_ASSERT
(19 + 46 =ğ
d©a
[1].
Ën
);

165 
	`CU_ASSERT
(1 =ğ
d©a
[2].
Ën
);

166 
	`CU_ASSERT
(
nuÎd©a
 + 256 =ğ
d©a
[2].
ba£
);

167 
	`CU_ASSERT
(1 =ğ
	`ngtı2_pq_size
(&
¡rm
.
¡»amäq
));

169 
	`ngtı2_¡»am_äame_chaš_d–
(
äc
, 
mem
);

171 
äc
 = 
NULL
;

172 
rv
 = 
	`ngtı2_¡rm_¡»amäq_pİ
(&
¡rm
, &
äc
, 1024);

174 
	`CU_ASSERT
(0 =ğ
rv
);

175 
	`CU_ASSERT
(77 =ğ
äc
->
ä
.
off£t
);

176 
	`CU_ASSERT
(2 =ğ
äc
->
ä
.
d©aút
);

178 
d©a
 = 
äc
->
ä
.data;

180 
	`CU_ASSERT
(30 =ğ
d©a
[0].
Ën
);

181 
	`CU_ASSERT
(
nuÎd©a
 + 256 + 1 =ğ
d©a
[0].
ba£
);

183 
	`ngtı2_¡»am_äame_chaš_d–
(
äc
, 
mem
);

184 
	`ngtı2_¡rm_ä“
(&
¡rm
);

187 
	`£tup_¡rm_¡»amäq_fixtu»
(&
¡rm
, 
mem
);

189 
äc
 = 
NULL
;

190 
rv
 = 
	`ngtı2_¡rm_¡»amäq_pİ
(&
¡rm
, &
äc
, 12);

192 
	`CU_ASSERT
(0 =ğ
rv
);

193 
	`CU_ASSERT
(0 =ğ
äc
->
ä
.
off£t
);

194 
	`CU_ASSERT
(2 =ğ
äc
->
ä
.
d©aút
);

196 
d©a
 = 
äc
->
ä
.data;

198 
	`CU_ASSERT
(11 =ğ
d©a
[0].
Ën
);

199 
	`CU_ASSERT
(
nuÎd©a
 =ğ
d©a
[0].
ba£
);

200 
	`CU_ASSERT
(1 =ğ
d©a
[1].
Ën
);

201 
	`CU_ASSERT
(
nuÎd©a
 + 11 =ğ
d©a
[1].
ba£
);

203 
	`ngtı2_¡»am_äame_chaš_d–
(
äc
, 
mem
);

205 
äc
 = 
NULL
;

206 
rv
 = 
	`ngtı2_¡rm_¡»amäq_pİ
(&
¡rm
, &
äc
, 1024);

208 
	`CU_ASSERT
(0 =ğ
rv
);

209 
	`CU_ASSERT
(12 =ğ
äc
->
ä
.
off£t
);

210 
	`CU_ASSERT
(4 =ğ
äc
->
ä
.
d©aút
);

212 
d©a
 = 
äc
->
ä
.data;

214 
	`CU_ASSERT
(35 =ğ
d©a
[0].
Ën
);

215 
	`CU_ASSERT
(
nuÎd©a
 + 12 =ğ
d©a
[0].
ba£
);

217 
d©a
 = 
äc
->
ä
.data;

219 
	`ngtı2_¡»am_äame_chaš_d–
(
äc
, 
mem
);

220 
	`ngtı2_¡rm_ä“
(&
¡rm
);

223 
	`ngtı2_¡rm_š™
(&
¡rm
, 0, 
NGTCP2_STRM_FLAG_NONE
, 0, 0, 
NULL
, 
mem
);

225 
	`ngtı2_¡»am_äame_chaš_Ãw
(&
äc
, 
mem
);

226 
äc
->
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

227 
äc
->
ä
.
fš
 = 0;

228 
äc
->
ä
.
off£t
 = 0;

229 
äc
->
ä
.
d©aút
 = 1;

230 
d©a
 = 
äc
->
ä
.data;

231 
d©a
[0].
Ën
 = 11;

232 
d©a
[0].
ba£
 = 
nuÎd©a
;

234 
	`ngtı2_¡rm_¡»amäq_push
(&
¡rm
, 
äc
);

236 
	`ngtı2_¡»am_äame_chaš_Ãw
(&
äc
, 
mem
);

237 
äc
->
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

238 
äc
->
ä
.
fš
 = 0;

239 
äc
->
ä
.
off£t
 = 30;

240 
äc
->
ä
.
d©aút
 = 1;

241 
d©a
 = 
äc
->
ä
.data;

242 
d©a
[0].
Ën
 = 17;

243 
d©a
[0].
ba£
 = 
nuÎd©a
 + 30;

245 
	`ngtı2_¡rm_¡»amäq_push
(&
¡rm
, 
äc
);

247 
äc
 = 
NULL
;

248 
rv
 = 
	`ngtı2_¡rm_¡»amäq_pİ
(&
¡rm
, &
äc
, 1024);

250 
	`CU_ASSERT
(0 =ğ
rv
);

251 
	`CU_ASSERT
(1 =ğ
äc
->
ä
.
d©aút
);

252 
	`CU_ASSERT
(11 =ğ
äc
->
ä
.
d©a
[0].
Ën
);

253 
	`CU_ASSERT
(1 =ğ
	`ngtı2_pq_size
(&
¡rm
.
¡»amäq
));

255 
	`ngtı2_¡»am_äame_chaš_d–
(
äc
, 
mem
);

256 
	`ngtı2_¡rm_ä“
(&
¡rm
);

259 
	`ngtı2_¡rm_š™
(&
¡rm
, 0, 
NGTCP2_STRM_FLAG_NONE
, 0, 0, 
NULL
, 
mem
);

261 
	`ngtı2_¡»am_äame_chaš_Ãw
(&
äc
, 
mem
);

262 
äc
->
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

263 
äc
->
ä
.
fš
 = 0;

264 
äc
->
ä
.
off£t
 = 0;

265 
äc
->
ä
.
d©aút
 = 1;

266 
d©a
 = 
äc
->
ä
.data;

267 
d©a
[0].
Ën
 = 11;

268 
d©a
[0].
ba£
 = 
nuÎd©a
;

270 
	`ngtı2_¡rm_¡»amäq_push
(&
¡rm
, 
äc
);

272 
	`ngtı2_¡»am_äame_chaš_Ãw
(&
äc
, 
mem
);

273 
äc
->
ä
.
ty³
 = 
NGTCP2_FRAME_STREAM
;

274 
äc
->
ä
.
fš
 = 1;

275 
äc
->
ä
.
off£t
 = 11;

276 
äc
->
ä
.
d©aút
 = 0;

278 
	`ngtı2_¡rm_¡»amäq_push
(&
¡rm
, 
äc
);

280 
äc
 = 
NULL
;

281 
rv
 = 
	`ngtı2_¡rm_¡»amäq_pİ
(&
¡rm
, &
äc
, 1024);

283 
	`CU_ASSERT
(0 =ğ
rv
);

284 
	`CU_ASSERT
(1 =ğ
äc
->
ä
.
fš
);

285 
	`CU_ASSERT
(1 =ğ
äc
->
ä
.
d©aút
);

287 
	`ngtı2_¡»am_äame_chaš_d–
(
äc
, 
mem
);

288 
	`ngtı2_¡rm_ä“
(&
¡rm
);

289 
	}
}

	@tests/ngtcp2_strm_test.h

25 #iâdeà
NGTCP2_STRM_TEST_H


26 
	#NGTCP2_STRM_TEST_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
‹¡_ngtı2_¡rm_¡»amäq_pİ
();

	@tests/ngtcp2_test_helper.c

25 
	~"ngtı2_‹¡_h–³r.h
"

27 
	~<¡ršg.h
>

28 
	~<as£¹.h
>

30 
	~"ngtı2_cÚv.h
"

31 
	~"ngtı2_pkt.h
"

32 
	~"ngtı2_µe.h
"

34 
size_t
 
	$ngtı2_t_’code_¡»am_äame
(
ušt8_t
 *
out
, ušt8_ˆ
æags
,

35 
ušt64_t
 
¡»am_id
, ušt64_ˆ
off£t
,

36 
ušt16_t
 
d©®’
) {

37 
ušt8_t
 *
p
 = 
out
;

39 ià(
off£t
) {

40 
æags
 |ğ
NGTCP2_STREAM_OFF_BIT
;

42 *
p
++ = 
NGTCP2_FRAME_STREAM
 | 
æags
;

44 
p
 = 
	`ngtı2_put_v¬št
Õ, 
¡»am_id
);

46 ià(
off£t
) {

47 
p
 = 
	`ngtı2_put_v¬št
Õ, 
off£t
);

50 ià(
æags
 & 
NGTCP2_STREAM_LEN_BIT
) {

51 
p
 = 
	`ngtı2_put_v¬št
Õ, 
d©®’
);

54 
	`mem£t
(
p
, 0, 
d©®’
);

55 
p
 +ğ
d©®’
;

57  (
size_t
)(
p
 - 
out
);

58 
	}
}

60 
size_t
 
	$ngtı2_t_’code_ack_äame
(
ušt8_t
 *
out
, 
ušt64_t
 
Ïrge¡_ack
,

61 
ušt64_t
 
fœ¡_ack_blkËn
, ušt64_ˆ
g­
,

62 
ušt64_t
 
ack_blkËn
) {

63 
ušt8_t
 *
p
 = 
out
;

65 
p
 = 
out
;

67 *
p
++ = 
NGTCP2_FRAME_ACK
;

69 
p
 = 
	`ngtı2_put_v¬št
Õ, 
Ïrge¡_ack
);

71 
p
 = 
	`ngtı2_put_v¬št
(p, 0);

73 
p
 = 
	`ngtı2_put_v¬št
(p, 1);

75 
p
 = 
	`ngtı2_put_v¬št
Õ, 
fœ¡_ack_blkËn
);

77 
p
 = 
	`ngtı2_put_v¬št
Õ, 
g­
);

79 
p
 = 
	`ngtı2_put_v¬št
Õ, 
ack_blkËn
);

81  (
size_t
)(
p
 - 
out
);

82 
	}
}

84 
ssize_t
 
	$nuÎ_’üy±
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

85 cÚ¡ 
ušt8_t
 *
¶aš‹xt
, 
size_t
 
¶aš‹x’
,

86 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

87 cÚ¡ 
ušt8_t
 *
nÚû
, 
size_t
 
nÚûËn
,

88 cÚ¡ 
ušt8_t
 *
ad
, 
size_t
 
adËn
, *
u£r_d©a
) {

89 ()
cÚn
;

90 ()
de¡
;

91 ()
de¡Ën
;

92 ()
¶aš‹xt
;

93 ()
key
;

94 ()
keyËn
;

95 ()
nÚû
;

96 ()
nÚûËn
;

97 ()
ad
;

98 ()
adËn
;

99 ()
u£r_d©a
;

100  (
ssize_t
)
¶aš‹x’
 + 
NGTCP2_FAKE_AEAD_OVERHEAD
;

101 
	}
}

103 
ssize_t
 
	$nuÎ_hp_mask
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
de¡
, 
size_t
 
de¡Ën
,

104 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

105 cÚ¡ 
ušt8_t
 *
§m¶e
, 
size_t
 
§m¶–’
,

106 *
u£r_d©a
) {

107 ()
cÚn
;

108 ()
key
;

109 ()
keyËn
;

110 ()
u£r_d©a
;

111 ()
§m¶e
;

112 ()
§m¶–’
;

113 
	`as£¹
(
de¡Ën
 >ğ(
NGTCP2_FAKE_HP_MASK
) - 1);

114 
	`memıy
(
de¡
, 
NGTCP2_FAKE_HP_MASK
, (NGTCP2_FAKE_HP_MASK) - 1);

115  (
ssize_t
)((
NGTCP2_FAKE_HP_MASK
) - 1);

116 
	}
}

118 
size_t
 
	$wr™e_sšgË_äame_pkt
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
out
, 
size_t
 
ou’
,

119 cÚ¡ 
ngtı2_cid
 *
dcid
, 
ušt64_t
 
pkt_num
,

120 
ngtı2_äame
 *
ä
) {

121 
ngtı2_üy±o_ùx
 
ùx
;

122 
ngtı2_µe
 
µe
;

123 
ngtı2_pkt_hd
 
hd
;

124 
rv
;

125 
ssize_t
 
n
;

127 
	`mem£t
(&
ùx
, 0, (ctx));

128 
ùx
.
’üy±
 = 
nuÎ_’üy±
;

129 
ùx
.
hp_mask
 = 
nuÎ_hp_mask
;

130 
ùx
.
ckm
 = 
cÚn
->
pkŠs
.
rx_ckm
;

131 
ùx
.
hp
 = 
cÚn
->
pkŠs
.
rx_hp
;

132 
ùx
.
«ad_ov”h—d
 = 
NGTCP2_FAKE_AEAD_OVERHEAD
;

133 
ùx
.
u£r_d©a
 = 
cÚn
;

135 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_NONE
, 
NGTCP2_PKT_SHORT
, 
dcid
, 
NULL
,

136 
pkt_num
, 4, 
NGTCP2_PROTO_VER_MAX
, 0);

138 
	`ngtı2_µe_š™
(&
µe
, 
out
, 
ou’
, &
ùx
);

139 
rv
 = 
	`ngtı2_µe_’code_hd
(&
µe
, &
hd
);

140 
	`as£¹
(0 =ğ
rv
);

141 
rv
 = 
	`ngtı2_µe_’code_äame
(&
µe
, 
ä
);

142 
	`as£¹
(0 =ğ
rv
);

143 
n
 = 
	`ngtı2_µe_fš®
(&
µe
, 
NULL
);

144 
	`as£¹
(
n
 > 0);

146  (
size_t
)
n
;

147 
	}
}

149 
size_t
 
	$wr™e_sšgË_äame_pkt_w™hout_cÚn_id
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
out
,

150 
size_t
 
ou’
, 
ušt64_t
 
pkt_num
,

151 
ngtı2_äame
 *
ä
) {

152 
ngtı2_üy±o_ùx
 
ùx
;

153 
ngtı2_µe
 
µe
;

154 
ngtı2_pkt_hd
 
hd
;

155 
rv
;

156 
ssize_t
 
n
;

158 
	`mem£t
(&
ùx
, 0, (ctx));

159 
ùx
.
’üy±
 = 
nuÎ_’üy±
;

160 
ùx
.
hp_mask
 = 
nuÎ_hp_mask
;

161 
ùx
.
ckm
 = 
cÚn
->
pkŠs
.
rx_ckm
;

162 
ùx
.
hp
 = 
cÚn
->
pkŠs
.
rx_hp
;

163 
ùx
.
«ad_ov”h—d
 = 
NGTCP2_FAKE_AEAD_OVERHEAD
;

164 
ùx
.
u£r_d©a
 = 
cÚn
;

166 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_NONE
, 
NGTCP2_PKT_SHORT
, 
NULL
, NULL,

167 
pkt_num
, 4, 
NGTCP2_PROTO_VER_MAX
, 0);

169 
	`ngtı2_µe_š™
(&
µe
, 
out
, 
ou’
, &
ùx
);

170 
rv
 = 
	`ngtı2_µe_’code_hd
(&
µe
, &
hd
);

171 
	`as£¹
(0 =ğ
rv
);

172 
rv
 = 
	`ngtı2_µe_’code_äame
(&
µe
, 
ä
);

173 
	`as£¹
(0 =ğ
rv
);

174 
n
 = 
	`ngtı2_µe_fš®
(&
µe
, 
NULL
);

175 
	`as£¹
(
n
 > 0);

176  (
size_t
)
n
;

177 
	}
}

179 
size_t
 
	$wr™e_sšgË_äame_hªdshake_pkt
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
out
,

180 
size_t
 
ou’
, 
ušt8_t
 
pkt_ty³
,

181 cÚ¡ 
ngtı2_cid
 *
dcid
,

182 cÚ¡ 
ngtı2_cid
 *
scid
,

183 
ušt64_t
 
pkt_num
, 
ušt32_t
 
v”siÚ
,

184 
ngtı2_äame
 *
ä
) {

185 
ngtı2_üy±o_ùx
 
ùx
;

186 
ngtı2_µe
 
µe
;

187 
ngtı2_pkt_hd
 
hd
;

188 
rv
;

189 
ssize_t
 
n
;

191 
	`mem£t
(&
ùx
, 0, (ctx));

192 
ùx
.
’üy±
 = 
nuÎ_’üy±
;

193 
ùx
.
hp_mask
 = 
nuÎ_hp_mask
;

194 
pkt_ty³
) {

195 
NGTCP2_PKT_INITIAL
:

196 
ùx
.
ckm
 = 
cÚn
->
š_pkŠs
.
rx_ckm
;

197 
ùx
.
hp
 = 
cÚn
->
š_pkŠs
.
rx_hp
;

198 
ùx
.
«ad_ov”h—d
 = 
NGTCP2_INITIAL_AEAD_OVERHEAD
;

200 
NGTCP2_PKT_HANDSHAKE
:

201 
ùx
.
ckm
 = 
cÚn
->
hs_pkŠs
.
rx_ckm
;

202 
ùx
.
hp
 = 
cÚn
->
hs_pkŠs
.
rx_hp
;

203 
ùx
.
«ad_ov”h—d
 = 
NGTCP2_FAKE_AEAD_OVERHEAD
;

205 
NGTCP2_PKT_0RTT_PROTECTED
:

206 
ùx
.
ckm
 = 
cÚn
->
—¾y_ckm
;

207 
ùx
.
hp
 = 
cÚn
->
—¾y_hp
;

208 
ùx
.
«ad_ov”h—d
 = 
NGTCP2_FAKE_AEAD_OVERHEAD
;

211 
	`as£¹
(0);

213 
ùx
.
u£r_d©a
 = 
cÚn
;

215 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_LONG_FORM
, 
pkt_ty³
, 
dcid
, 
scid
,

216 
pkt_num
, 4, 
v”siÚ
, 0);

218 
	`ngtı2_µe_š™
(&
µe
, 
out
, 
ou’
, &
ùx
);

219 
rv
 = 
	`ngtı2_µe_’code_hd
(&
µe
, &
hd
);

220 
	`as£¹
(0 =ğ
rv
);

221 
rv
 = 
	`ngtı2_µe_’code_äame
(&
µe
, 
ä
);

222 
	`as£¹
(0 =ğ
rv
);

223 
n
 = 
	`ngtı2_µe_fš®
(&
µe
, 
NULL
);

224 
	`as£¹
(
n
 > 0);

225  (
size_t
)
n
;

226 
	}
}

228 
size_t
 
	$wr™e_hªdshake_pkt
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
out
, 
size_t
 
ou’
,

229 
ušt8_t
 
pkt_ty³
, cÚ¡ 
ngtı2_cid
 *
dcid
,

230 cÚ¡ 
ngtı2_cid
 *
scid
, 
ušt64_t
 
pkt_num
,

231 
ušt32_t
 
v”siÚ
, 
ngtı2_äame
 *
äa
, 
size_t
 
äËn
) {

232 
ngtı2_üy±o_ùx
 
ùx
;

233 
ngtı2_µe
 
µe
;

234 
ngtı2_pkt_hd
 
hd
;

235 
ngtı2_äame
 *
ä
;

236 
rv
;

237 
ssize_t
 
n
;

238 
size_t
 
i
;

240 
	`mem£t
(&
ùx
, 0, (ctx));

241 
ùx
.
’üy±
 = 
nuÎ_’üy±
;

242 
ùx
.
hp_mask
 = 
nuÎ_hp_mask
;

243 
pkt_ty³
) {

244 
NGTCP2_PKT_INITIAL
:

245 
ùx
.
ckm
 = 
cÚn
->
š_pkŠs
.
rx_ckm
;

246 
ùx
.
hp
 = 
cÚn
->
š_pkŠs
.
rx_hp
;

247 
ùx
.
«ad_ov”h—d
 = 
NGTCP2_INITIAL_AEAD_OVERHEAD
;

249 
NGTCP2_PKT_HANDSHAKE
:

250 
ùx
.
ckm
 = 
cÚn
->
hs_pkŠs
.
rx_ckm
;

251 
ùx
.
hp
 = 
cÚn
->
hs_pkŠs
.
rx_hp
;

252 
ùx
.
«ad_ov”h—d
 = 
NGTCP2_FAKE_AEAD_OVERHEAD
;

254 
NGTCP2_PKT_0RTT_PROTECTED
:

255 
ùx
.
ckm
 = 
cÚn
->
—¾y_ckm
;

256 
ùx
.
hp
 = 
cÚn
->
—¾y_hp
;

257 
ùx
.
«ad_ov”h—d
 = 
NGTCP2_FAKE_AEAD_OVERHEAD
;

260 
	`as£¹
(0);

262 
ùx
.
u£r_d©a
 = 
cÚn
;

264 
	`ngtı2_pkt_hd_š™
(&
hd
, 
NGTCP2_PKT_FLAG_LONG_FORM
, 
pkt_ty³
, 
dcid
, 
scid
,

265 
pkt_num
, 4, 
v”siÚ
, 0);

267 
	`ngtı2_µe_š™
(&
µe
, 
out
, 
ou’
, &
ùx
);

268 
rv
 = 
	`ngtı2_µe_’code_hd
(&
µe
, &
hd
);

269 
	`as£¹
(0 =ğ
rv
);

271 
i
 = 0; i < 
äËn
; ++i) {

272 
ä
 = &
äa
[
i
];

273 
rv
 = 
	`ngtı2_µe_’code_äame
(&
µe
, 
ä
);

274 
	`as£¹
(0 =ğ
rv
);

277 
n
 = 
	`ngtı2_µe_fš®
(&
µe
, 
NULL
);

278 
	`as£¹
(
n
 > 0);

279  (
size_t
)
n
;

280 
	}
}

282 
ngtı2_¡rm
 *
	$İ’_¡»am
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
¡»am_id
) {

283 
ngtı2_¡rm
 *
¡rm
;

284 
rv
;

286 
¡rm
 = 
	`ngtı2_mem_m®loc
(
cÚn
->
mem
, (
ngtı2_¡rm
));

287 
	`as£¹
(
¡rm
);

289 
rv
 = 
	`ngtı2_cÚn_š™_¡»am
(
cÚn
, 
¡rm
, 
¡»am_id
, 
NULL
);

290 
	`as£¹
(0 =ğ
rv
);

292  
¡rm
;

293 
	}
}

295 
size_t
 
	$¹b_’Œy_Ëngth
(cÚ¡ 
ngtı2_¹b_’Œy
 *
’t
) {

296 
size_t
 
Ën
 = 0;

298 ; 
’t
;ƒÁ =ƒÁ->
Ãxt
) {

299 ++
Ën
;

302  
Ën
;

303 
	}
}

305 
	$dcid_š™
(
ngtı2_cid
 *
cid
) {

306 cÚ¡ 
ušt8_t
 
id
[] = "\xff\xaa\xaa\xaa\xaa\xaa\xaa\xaa\xaa\xaa\xaa\xaa"

308 
	`ngtı2_cid_š™
(
cid
, 
id
, (id) - 1);

309 
	}
}

311 
	$scid_š™
(
ngtı2_cid
 *
cid
) {

312 cÚ¡ 
ušt8_t
 
id
[] = "\xee\xaa\xaa\xaa\xaa\xaa\xaa\xaa\xaa\xaa\xaa\xaa"

314 
	`ngtı2_cid_š™
(
cid
, 
id
, (id) - 1);

315 
	}
}

317 
	$rcid_š™
(
ngtı2_cid
 *
cid
) {

318 cÚ¡ 
ušt8_t
 
id
[] = "\xdd\xaa\xaa\xaa\xaa\xaa\xaa\xaa\xaa\xaa\xaa\xaa"

320 
	`ngtı2_cid_š™
(
cid
, 
id
, (id) - 1);

321 
	}
}

323 
ušt64_t
 
	$»ad_pkt_·ylßdËn
(cÚ¡ 
ušt8_t
 *
pkt
, cÚ¡ 
ngtı2_cid
 *
dcid
,

324 cÚ¡ 
ngtı2_cid
 *
scid
) {

325 
size_t
 
Ä—d
;

327  
	`ngtı2_g‘_v¬št
(&
Ä—d
,

328 &
pkt
[1 + 4 + 1 + 
dcid
->
d©®’
 + 
scid
->datalen]);

329 
	}
}

331 
	$wr™e_pkt_·ylßdËn
(
ušt8_t
 *
pkt
, cÚ¡ 
ngtı2_cid
 *
dcid
,

332 cÚ¡ 
ngtı2_cid
 *
scid
, 
ušt64_t
 
·ylßdËn
) {

333 
	`as£¹
(
·ylßdËn
 < 16384);

334 
	`ngtı2_put_v¬št14
(&
pkt
[1 + 4 + 1 + 
dcid
->
d©®’
 + 
scid
->datalen],

335 (
ušt16_t
)
·ylßdËn
);

336 
	}
}

338 
ssize_t
 
	$pkt_decode_hd_lÚg
(
ngtı2_pkt_hd
 *
de¡
, cÚ¡ 
ušt8_t
 *
pkt
,

339 
size_t
 
pk’
) {

340 cÚ¡ 
ušt8_t
 *
p
;

341 
ssize_t
 
Ä—d
;

343 
Ä—d
 = 
	`ngtı2_pkt_decode_hd_lÚg
(
de¡
, 
pkt
, 
pk’
);

344 ià(
Ä—d
 < 0 || 
de¡
->
ty³
 =ğ
NGTCP2_PKT_VERSION_NEGOTIATION
) {

345  
Ä—d
;

348 ià((
size_t
)
Ä—d
 =ğ
pk’
) {

349  
NGTCP2_ERR_INVALID_ARGUMENT
;

352 
p
 = 
pkt
 + 
Ä—d
;

354 
de¡
->
pkt_numËn
 = (
size_t
)(
pkt
[0] & 
NGTCP2_PKT_NUMLEN_MASK
) + 1;

355 ià(
pk’
 < (
size_t
)
Ä—d
 + 
de¡
->
pkt_numËn
) {

356  
NGTCP2_ERR_INVALID_ARGUMENT
;

359 
de¡
->
pkt_num
 = 
	`ngtı2_g‘_pkt_num
(
p
, de¡->
pkt_numËn
);

361  
Ä—d
 + (
ssize_t
)
de¡
->
pkt_numËn
;

362 
	}
}

364 
ssize_t
 
	$pkt_decode_hd_shÜt
(
ngtı2_pkt_hd
 *
de¡
, cÚ¡ 
ušt8_t
 *
pkt
,

365 
size_t
 
pk’
, size_ˆ
dcidËn
) {

366 cÚ¡ 
ušt8_t
 *
p
;

367 
ssize_t
 
Ä—d
;

369 
Ä—d
 = 
	`ngtı2_pkt_decode_hd_shÜt
(
de¡
, 
pkt
, 
pk’
, 
dcidËn
);

370 ià(
Ä—d
 < 0) {

371  
Ä—d
;

374 ià((
size_t
)
Ä—d
 =ğ
pk’
) {

375  
NGTCP2_ERR_INVALID_ARGUMENT
;

378 
p
 = 
pkt
 + 
Ä—d
;

380 
de¡
->
pkt_numËn
 = (
size_t
)(
pkt
[0] & 
NGTCP2_PKT_NUMLEN_MASK
) + 1;

381 ià(
pk’
 < (
size_t
)
Ä—d
 + 
de¡
->
pkt_numËn
) {

382  
NGTCP2_ERR_INVALID_ARGUMENT
;

385 
de¡
->
pkt_num
 = 
	`ngtı2_g‘_pkt_num
(
p
, de¡->
pkt_numËn
);

387  
Ä—d
 + (
ssize_t
)
de¡
->
pkt_numËn
;

388 
	}
}

390 
ssize_t
 
	$pkt_decode_hd_shÜt_mask
(
ngtı2_pkt_hd
 *
de¡
, cÚ¡ 
ušt8_t
 *
pkt
,

391 
size_t
 
pk’
, size_ˆ
dcidËn
) {

392 cÚ¡ 
ušt8_t
 
mask
[] = 
NGTCP2_FAKE_HP_MASK
;

393 cÚ¡ 
ušt8_t
 *
p
;

394 
ssize_t
 
Ä—d
;

395 
ušt8_t
 
hb
;

396 
ušt8_t
 
pkt_numbuf
[4];

397 
size_t
 
i
;

399 
Ä—d
 = 
	`ngtı2_pkt_decode_hd_shÜt
(
de¡
, 
pkt
, 
pk’
, 
dcidËn
);

400 ià(
Ä—d
 < 0) {

401  
Ä—d
;

404 ià((
size_t
)
Ä—d
 =ğ
pk’
) {

405  
NGTCP2_ERR_INVALID_ARGUMENT
;

408 
p
 = 
pkt
 + 
Ä—d
;

410 
hb
 = (
ušt8_t
)(
pkt
[0] ^ (
mask
[0] & 0x1f));

412 
de¡
->
pkt_numËn
 = (
size_t
)(
hb
 & 
NGTCP2_PKT_NUMLEN_MASK
) + 1;

413 ià(
pk’
 < (
size_t
)
Ä—d
 + 
de¡
->
pkt_numËn
) {

414  
NGTCP2_ERR_INVALID_ARGUMENT
;

417 
i
 = 0; i < 
de¡
->
pkt_numËn
; ++i) {

418 
pkt_numbuf
[
i
] = *(
p
 + iè^ 
mask
[i + 1];

421 
de¡
->
pkt_num
 = 
	`ngtı2_g‘_pkt_num
(
pkt_numbuf
, de¡->
pkt_numËn
);

423  
Ä—d
 + (
ssize_t
)
de¡
->
pkt_numËn
;

424 
	}
}

	@tests/ngtcp2_test_helper.h

25 #iâdeà
NGTCP2_TEST_HELPER_H


26 
	#NGTCP2_TEST_HELPER_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
	~<ngtı2/ngtı2.h
>

34 
	~"ngtı2_cÚn.h
"

39 
	#¡rsize
(
S
è((Sè- 1)

	)

44 
	#¬¿yËn
(
A
è((Aè/ (A[0]))

	)

50 
	#NGTCP2_APP_ERR01
 0xff01u

	)

51 
	#NGTCP2_APP_ERR02
 0xff02u

	)

59 
	#NGTCP2_FAKE_AEAD_OVERHEAD
 
NGTCP2_INITIAL_AEAD_OVERHEAD


	)

63 
	#NGTCP2_FAKE_HP_MASK
 "\x00\x00\x00\x00\x00"

	)

75 
size_t
 
ngtı2_t_’code_¡»am_äame
(
ušt8_t
 *
out
, ušt8_ˆ
æags
,

76 
ušt64_t
 
¡»am_id
, ušt64_ˆ
off£t
,

77 
ušt16_t
 
d©®’
);

86 
size_t
 
ngtı2_t_’code_ack_äame
(
ušt8_t
 *
out
, 
ušt64_t
 
Ïrge¡_ack
,

87 
ušt64_t
 
fœ¡_ack_blkËn
, ušt64_ˆ
g­
,

88 
ušt64_t
 
ack_blkËn
);

95 
size_t
 
wr™e_sšgË_äame_pkt
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
out
, size_ˆ
ou’
,

96 cÚ¡ 
ngtı2_cid
 *
dcid
, 
ušt64_t
 
pkt_num
,

97 
ngtı2_äame
 *
ä
);

105 
size_t
 
wr™e_sšgË_äame_pkt_w™hout_cÚn_id
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
out
,

106 
size_t
 
ou’
, 
ušt64_t
 
pkt_num
,

107 
ngtı2_äame
 *
ä
);

115 
size_t
 
wr™e_sšgË_äame_hªdshake_pkt
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
out
,

116 
size_t
 
ou’
, 
ušt8_t
 
pkt_ty³
,

117 cÚ¡ 
ngtı2_cid
 *
dcid
,

118 cÚ¡ 
ngtı2_cid
 *
scid
,

119 
ušt64_t
 
pkt_num
, 
ušt32_t
 
v”siÚ
,

120 
ngtı2_äame
 *
ä
);

127 
size_t
 
wr™e_hªdshake_pkt
(
ngtı2_cÚn
 *
cÚn
, 
ušt8_t
 *
out
, size_ˆ
ou’
,

128 
ušt8_t
 
pkt_ty³
, cÚ¡ 
ngtı2_cid
 *
dcid
,

129 cÚ¡ 
ngtı2_cid
 *
scid
, 
ušt64_t
 
pkt_num
,

130 
ušt32_t
 
v”siÚ
, 
ngtı2_äame
 *
äa
, 
size_t
 
äËn
);

135 
ngtı2_¡rm
 *
İ’_¡»am
(
ngtı2_cÚn
 *
cÚn
, 
ušt64_t
 
¡»am_id
);

141 
size_t
 
¹b_’Œy_Ëngth
(cÚ¡ 
ngtı2_¹b_’Œy
 *
’t
);

143 
scid_š™
(
ngtı2_cid
 *
cid
);

144 
dcid_š™
(
ngtı2_cid
 *
cid
);

145 
rcid_š™
(
ngtı2_cid
 *
cid
);

151 
ušt64_t
 
»ad_pkt_·ylßdËn
(cÚ¡ 
ušt8_t
 *
pkt
, cÚ¡ 
ngtı2_cid
 *
dcid
,

152 cÚ¡ 
ngtı2_cid
 *
scid
);

158 
wr™e_pkt_·ylßdËn
(
ušt8_t
 *
pkt
, cÚ¡ 
ngtı2_cid
 *
dcid
,

159 cÚ¡ 
ngtı2_cid
 *
scid
, 
ušt64_t
 
·ylßdËn
);

166 
ssize_t
 
pkt_decode_hd_lÚg
(
ngtı2_pkt_hd
 *
de¡
, cÚ¡ 
ušt8_t
 *
pkt
,

167 
size_t
 
pk’
);

174 
ssize_t
 
pkt_decode_hd_shÜt
(
ngtı2_pkt_hd
 *
de¡
, cÚ¡ 
ušt8_t
 *
pkt
,

175 
size_t
 
pk’
, size_ˆ
dcidËn
);

182 
ssize_t
 
pkt_decode_hd_shÜt_mask
(
ngtı2_pkt_hd
 *
de¡
, cÚ¡ 
ušt8_t
 *
pkt
,

183 
size_t
 
pk’
, size_ˆ
dcidËn
);

	@tests/ngtcp2_vec_test.c

25 
	~"ngtı2_vec_‹¡.h
"

27 
	~<CUn™/CUn™.h
>

29 
	~"ngtı2_vec.h
"

30 
	~"ngtı2_‹¡_h–³r.h
"

32 
	$‹¡_ngtı2_vec_¥l™
() {

33 
ušt8_t
 
nuÎd©a
[1024];

34 
ngtı2_vec
 
a
[16], 
b
[16];

35 
size_t
 
aút
, 
bút
;

36 
ssize_t
 
n¥l™
;

39 
aút
 = 1;

40 
a
[0].
Ën
 = 135;

41 
a
[0].
ba£
 = 
nuÎd©a
;

43 
bút
 = 0;

44 
b
[0].
Ën
 = 0;

45 
b
[0].
ba£
 = 
NULL
;

47 
n¥l™
 = 
	`ngtı2_vec_¥l™
(
a
, &
aút
, 
b
, &
bút
, 135, 16);

49 
	`CU_ASSERT
(0 =ğ
n¥l™
);

50 
	`CU_ASSERT
(1 =ğ
aút
);

51 
	`CU_ASSERT
(135 =ğ
a
[0].
Ën
);

52 
	`CU_ASSERT
(
nuÎd©a
 =ğ
a
[0].
ba£
);

53 
	`CU_ASSERT
(0 =ğ
bút
);

54 
	`CU_ASSERT
(0 =ğ
b
[0].
Ën
);

55 
	`CU_ASSERT
(
NULL
 =ğ
b
[0].
ba£
);

58 
aút
 = 1;

59 
a
[0].
Ën
 = 135;

60 
a
[0].
ba£
 = 
nuÎd©a
;

62 
bút
 = 0;

63 
b
[0].
Ën
 = 0;

64 
b
[0].
ba£
 = 
NULL
;

66 
n¥l™
 = 
	`ngtı2_vec_¥l™
(
a
, &
aút
, 
b
, &
bút
, 87, 16);

68 
	`CU_ASSERT
(48 =ğ
n¥l™
);

69 
	`CU_ASSERT
(1 =ğ
aút
);

70 
	`CU_ASSERT
(87 =ğ
a
[0].
Ën
);

71 
	`CU_ASSERT
(
nuÎd©a
 =ğ
a
[0].
ba£
);

72 
	`CU_ASSERT
(1 =ğ
bút
);

73 
	`CU_ASSERT
(48 =ğ
b
[0].
Ën
);

74 
	`CU_ASSERT
(
nuÎd©a
 + 87 =ğ
b
[0].
ba£
);

77 
aút
 = 2;

78 
a
[0].
Ën
 = 33;

79 
a
[0].
ba£
 = 
nuÎd©a
;

80 
a
[1].
Ën
 = 89;

81 
a
[1].
ba£
 = 
nuÎd©a
 + 33;

83 
bút
 = 0;

84 
b
[0].
Ën
 = 0;

85 
b
[0].
ba£
 = 
NULL
;

87 
n¥l™
 = 
	`ngtı2_vec_¥l™
(
a
, &
aút
, 
b
, &
bút
, 33, 16);

89 
	`CU_ASSERT
(89 =ğ
n¥l™
);

90 
	`CU_ASSERT
(1 =ğ
aút
);

91 
	`CU_ASSERT
(33 =ğ
a
[0].
Ën
);

92 
	`CU_ASSERT
(
nuÎd©a
 =ğ
a
[0].
ba£
);

93 
	`CU_ASSERT
(1 =ğ
bút
);

94 
	`CU_ASSERT
(89 =ğ
b
[0].
Ën
);

95 
	`CU_ASSERT
(
nuÎd©a
 + 33 =ğ
b
[0].
ba£
);

98 
aút
 = 3;

99 
a
[0].
Ën
 = 33;

100 
a
[0].
ba£
 = 
nuÎd©a
;

101 
a
[1].
Ën
 = 89;

102 
a
[1].
ba£
 = 
nuÎd©a
 + 33;

103 
a
[2].
Ën
 = 211;

104 
a
[2].
ba£
 = 
nuÎd©a
 + 33 + 89;

106 
bút
 = 0;

107 
b
[0].
Ën
 = 0;

108 
b
[0].
ba£
 = 
NULL
;

110 
n¥l™
 = 
	`ngtı2_vec_¥l™
(
a
, &
aút
, 
b
, &
bút
, 34, 16);

112 
	`CU_ASSERT
(88 + 211 =ğ
n¥l™
);

113 
	`CU_ASSERT
(2 =ğ
aút
);

114 
	`CU_ASSERT
(33 =ğ
a
[0].
Ën
);

115 
	`CU_ASSERT
(
nuÎd©a
 =ğ
a
[0].
ba£
);

116 
	`CU_ASSERT
(1 =ğ
a
[1].
Ën
);

117 
	`CU_ASSERT
(
nuÎd©a
 + 33 =ğ
a
[1].
ba£
);

118 
	`CU_ASSERT
(2 =ğ
bút
);

119 
	`CU_ASSERT
(88 =ğ
b
[0].
Ën
);

120 
	`CU_ASSERT
(
nuÎd©a
 + 34 =ğ
b
[0].
ba£
);

121 
	`CU_ASSERT
(211 =ğ
b
[1].
Ën
);

122 
	`CU_ASSERT
(
nuÎd©a
 + 34 + 88 =ğ
b
[1].
ba£
);

126 
aút
 = 2;

127 
a
[0].
Ën
 = 33;

128 
a
[0].
ba£
 = 
nuÎd©a
;

129 
a
[1].
Ën
 = 89;

130 
a
[1].
ba£
 = 
nuÎd©a
 + 33;

132 
bút
 = 2;

133 
b
[0].
Ën
 = 17;

134 
b
[0].
ba£
 = 
nuÎd©a
 + 33 + 89;

135 
b
[1].
Ën
 = 3;

136 
b
[1].
ba£
 = 
nuÎd©a
 + 33 + 89 + 17;

138 
n¥l™
 = 
	`ngtı2_vec_¥l™
(
a
, &
aút
, 
b
, &
bút
, 33, 16);

140 
	`CU_ASSERT
(89 =ğ
n¥l™
);

141 
	`CU_ASSERT
(1 =ğ
aút
);

142 
	`CU_ASSERT
(33 =ğ
a
[0].
Ën
);

143 
	`CU_ASSERT
(
nuÎd©a
 =ğ
a
[0].
ba£
);

144 
	`CU_ASSERT
(2 =ğ
bút
);

145 
	`CU_ASSERT
(89 + 17 =ğ
b
[0].
Ën
);

146 
	`CU_ASSERT
(
nuÎd©a
 + 33 =ğ
b
[0].
ba£
);

147 
	`CU_ASSERT
(3 =ğ
b
[1].
Ën
);

148 
	`CU_ASSERT
(
nuÎd©a
 + 33 + 89 + 17 =ğ
b
[1].
ba£
);

152 
aút
 = 2;

153 
a
[0].
Ën
 = 33;

154 
a
[0].
ba£
 = 
nuÎd©a
;

155 
a
[1].
Ën
 = 89;

156 
a
[1].
ba£
 = 
nuÎd©a
 + 33;

158 
bút
 = 2;

159 
b
[0].
Ën
 = 17;

160 
b
[0].
ba£
 = 
nuÎd©a
 + 33 + 89;

161 
b
[1].
Ën
 = 3;

162 
b
[1].
ba£
 = 
nuÎd©a
 + 33 + 89 + 17;

164 
n¥l™
 = 
	`ngtı2_vec_¥l™
(
a
, &
aút
, 
b
, &
bút
, 34, 16);

166 
	`CU_ASSERT
(88 =ğ
n¥l™
);

167 
	`CU_ASSERT
(2 =ğ
aút
);

168 
	`CU_ASSERT
(33 =ğ
a
[0].
Ën
);

169 
	`CU_ASSERT
(
nuÎd©a
 =ğ
a
[0].
ba£
);

170 
	`CU_ASSERT
(1 =ğ
a
[1].
Ën
);

171 
	`CU_ASSERT
(
nuÎd©a
 + 33 =ğ
a
[1].
ba£
);

172 
	`CU_ASSERT
(2 =ğ
bút
);

173 
	`CU_ASSERT
(88 + 17 =ğ
b
[0].
Ën
);

174 
	`CU_ASSERT
(
nuÎd©a
 + 34 =ğ
b
[0].
ba£
);

175 
	`CU_ASSERT
(3 =ğ
b
[1].
Ën
);

176 
	`CU_ASSERT
(
nuÎd©a
 + 33 + 89 + 17 =ğ
b
[1].
ba£
);

180 
aút
 = 3;

181 
a
[0].
Ën
 = 33;

182 
a
[0].
ba£
 = 
nuÎd©a
;

183 
a
[1].
Ën
 = 89;

184 
a
[1].
ba£
 = 
nuÎd©a
 + 33;

185 
a
[2].
Ën
 = 211;

186 
a
[2].
ba£
 = 
nuÎd©a
 + 33 + 89;

188 
bút
 = 2;

189 
b
[0].
Ën
 = 17;

190 
b
[0].
ba£
 = 
nuÎd©a
 + 33 + 89 + 211;

191 
b
[1].
Ën
 = 3;

192 
b
[1].
ba£
 = 
nuÎd©a
 + 33 + 89 + 211 + 17;

194 
n¥l™
 = 
	`ngtı2_vec_¥l™
(
a
, &
aút
, 
b
, &
bút
, 34, 16);

196 
	`CU_ASSERT
(88 + 211 =ğ
n¥l™
);

197 
	`CU_ASSERT
(2 =ğ
aút
);

198 
	`CU_ASSERT
(33 =ğ
a
[0].
Ën
);

199 
	`CU_ASSERT
(
nuÎd©a
 =ğ
a
[0].
ba£
);

200 
	`CU_ASSERT
(1 =ğ
a
[1].
Ën
);

201 
	`CU_ASSERT
(
nuÎd©a
 + 33 =ğ
a
[1].
ba£
);

202 
	`CU_ASSERT
(3 =ğ
bút
);

203 
	`CU_ASSERT
(88 =ğ
b
[0].
Ën
);

204 
	`CU_ASSERT
(
nuÎd©a
 + 34 =ğ
b
[0].
ba£
);

205 
	`CU_ASSERT
(211 + 17 =ğ
b
[1].
Ën
);

206 
	`CU_ASSERT
(
nuÎd©a
 + 34 + 88 =ğ
b
[1].
ba£
);

207 
	`CU_ASSERT
(3 =ğ
b
[2].
Ën
);

208 
	`CU_ASSERT
(
nuÎd©a
 + 33 + 89 + 211 + 17 =ğ
b
[2].
ba£
);

212 
aút
 = 2;

213 
a
[0].
Ën
 = 33;

214 
a
[0].
ba£
 = 
nuÎd©a
;

215 
a
[1].
Ën
 = 89;

216 
a
[1].
ba£
 = 
nuÎd©a
 + 33;

218 
bút
 = 2;

219 
b
[0].
Ën
 = 17;

220 
b
[0].
ba£
 = 
nuÎd©a
 + 256;

221 
b
[1].
Ën
 = 3;

222 
b
[1].
ba£
 = 
nuÎd©a
 + 256 + 17;

224 
n¥l™
 = 
	`ngtı2_vec_¥l™
(
a
, &
aút
, 
b
, &
bút
, 33, 16);

226 
	`CU_ASSERT
(89 =ğ
n¥l™
);

227 
	`CU_ASSERT
(1 =ğ
aút
);

228 
	`CU_ASSERT
(33 =ğ
a
[0].
Ën
);

229 
	`CU_ASSERT
(
nuÎd©a
 =ğ
a
[0].
ba£
);

230 
	`CU_ASSERT
(3 =ğ
bút
);

231 
	`CU_ASSERT
(89 =ğ
b
[0].
Ën
);

232 
	`CU_ASSERT
(
nuÎd©a
 + 33 =ğ
b
[0].
ba£
);

233 
	`CU_ASSERT
(17 =ğ
b
[1].
Ën
);

234 
	`CU_ASSERT
(
nuÎd©a
 + 256 =ğ
b
[1].
ba£
);

235 
	`CU_ASSERT
(3 =ğ
b
[2].
Ën
);

236 
	`CU_ASSERT
(
nuÎd©a
 + 256 + 17 =ğ
b
[2].
ba£
);

239 
aút
 = 2;

240 
a
[0].
Ën
 = 33;

241 
a
[0].
ba£
 = 
nuÎd©a
;

242 
a
[1].
Ën
 = 89;

243 
a
[1].
ba£
 = 
nuÎd©a
 + 33;

245 
bút
 = 1;

246 
b
[0].
Ën
 = 17;

247 
b
[0].
ba£
 = 
nuÎd©a
 + 33 + 89;

249 
n¥l™
 = 
	`ngtı2_vec_¥l™
(
a
, &
aút
, 
b
, &
bút
, 32, 1);

251 
	`CU_ASSERT
(-1 =ğ
n¥l™
);

254 
aút
 = 2;

255 
a
[0].
Ën
 = 33;

256 
a
[0].
ba£
 = 
nuÎd©a
;

257 
a
[1].
Ën
 = 89;

258 
a
[1].
ba£
 = 
nuÎd©a
 + 33;

260 
bút
 = 1;

261 
b
[0].
Ën
 = 17;

262 
b
[0].
ba£
 = 
nuÎd©a
 + 256;

264 
n¥l™
 = 
	`ngtı2_vec_¥l™
(
a
, &
aút
, 
b
, &
bút
, 33, 1);

266 
	`CU_ASSERT
(-1 =ğ
n¥l™
);

267 
	}
}

269 
	$‹¡_ngtı2_vec_m”ge
() {

270 
ušt8_t
 
nuÎd©a
[1024];

271 
ngtı2_vec
 
a
[16], 
b
[16];

272 
size_t
 
aút
, 
bút
;

273 
size_t
 
nm”ged
;

276 
aút
 = 1;

277 
a
[0].
Ën
 = 33;

278 
a
[0].
ba£
 = 
nuÎd©a
;

280 
bút
 = 1;

281 
b
[0].
Ën
 = 11;

282 
b
[0].
ba£
 = 
nuÎd©a
 + 33;

284 
nm”ged
 = 
	`ngtı2_vec_m”ge
(
a
, &
aút
, 
b
, &
bút
, 11, 16);

286 
	`CU_ASSERT
(11 =ğ
nm”ged
);

287 
	`CU_ASSERT
(1 =ğ
aút
);

288 
	`CU_ASSERT
(44 =ğ
a
[0].
Ën
);

289 
	`CU_ASSERT
(
nuÎd©a
 =ğ
a
[0].
ba£
);

290 
	`CU_ASSERT
(0 =ğ
bút
);

293 
aút
 = 1;

294 
a
[0].
Ën
 = 33;

295 
a
[0].
ba£
 = 
nuÎd©a
;

297 
bút
 = 1;

298 
b
[0].
Ën
 = 11;

299 
b
[0].
ba£
 = 
nuÎd©a
 + 33;

301 
nm”ged
 = 
	`ngtı2_vec_m”ge
(
a
, &
aút
, 
b
, &
bút
, 10, 16);

303 
	`CU_ASSERT
(10 =ğ
nm”ged
);

304 
	`CU_ASSERT
(1 =ğ
aút
);

305 
	`CU_ASSERT
(43 =ğ
a
[0].
Ën
);

306 
	`CU_ASSERT
(
nuÎd©a
 =ğ
a
[0].
ba£
);

307 
	`CU_ASSERT
(1 =ğ
bút
);

308 
	`CU_ASSERT
(1 =ğ
b
[0].
Ën
);

309 
	`CU_ASSERT
(
nuÎd©a
 + 33 + 10 =ğ
b
[0].
ba£
);

312 
aút
 = 1;

313 
a
[0].
Ën
 = 33;

314 
a
[0].
ba£
 = 
nuÎd©a
;

316 
bút
 = 1;

317 
b
[0].
Ën
 = 11;

318 
b
[0].
ba£
 = 
nuÎd©a
 + 256;

320 
nm”ged
 = 
	`ngtı2_vec_m”ge
(
a
, &
aút
, 
b
, &
bút
, 11, 16);

322 
	`CU_ASSERT
(11 =ğ
nm”ged
);

323 
	`CU_ASSERT
(2 =ğ
aút
);

324 
	`CU_ASSERT
(33 =ğ
a
[0].
Ën
);

325 
	`CU_ASSERT
(
nuÎd©a
 =ğ
a
[0].
ba£
);

326 
	`CU_ASSERT
(11 =ğ
a
[1].
Ën
);

327 
	`CU_ASSERT
(
nuÎd©a
 + 256 =ğ
a
[1].
ba£
);

328 
	`CU_ASSERT
(0 =ğ
bút
);

331 
aút
 = 1;

332 
a
[0].
Ën
 = 33;

333 
a
[0].
ba£
 = 
nuÎd©a
;

335 
bút
 = 1;

336 
b
[0].
Ën
 = 11;

337 
b
[0].
ba£
 = 
nuÎd©a
 + 256;

339 
nm”ged
 = 
	`ngtı2_vec_m”ge
(
a
, &
aút
, 
b
, &
bút
, 10, 16);

341 
	`CU_ASSERT
(10 =ğ
nm”ged
);

342 
	`CU_ASSERT
(2 =ğ
aút
);

343 
	`CU_ASSERT
(33 =ğ
a
[0].
Ën
);

344 
	`CU_ASSERT
(
nuÎd©a
 =ğ
a
[0].
ba£
);

345 
	`CU_ASSERT
(10 =ğ
a
[1].
Ën
);

346 
	`CU_ASSERT
(
nuÎd©a
 + 256 =ğ
a
[1].
ba£
);

347 
	`CU_ASSERT
(1 =ğ
bút
);

348 
	`CU_ASSERT
(1 =ğ
b
[0].
Ën
);

349 
	`CU_ASSERT
(
nuÎd©a
 + 256 + 10 =ğ
b
[0].
ba£
);

352 
aút
 = 1;

353 
a
[0].
Ën
 = 33;

354 
a
[0].
ba£
 = 
nuÎd©a
;

356 
bút
 = 2;

357 
b
[0].
Ën
 = 11;

358 
b
[0].
ba£
 = 
nuÎd©a
 + 256;

359 
b
[1].
Ën
 = 19;

360 
b
[1].
ba£
 = 
nuÎd©a
 + 256 + 11;

362 
nm”ged
 = 
	`ngtı2_vec_m”ge
(
a
, &
aút
, 
b
, &
bút
, 11, 16);

364 
	`CU_ASSERT
(11 =ğ
nm”ged
);

365 
	`CU_ASSERT
(2 =ğ
aút
);

366 
	`CU_ASSERT
(33 =ğ
a
[0].
Ën
);

367 
	`CU_ASSERT
(
nuÎd©a
 =ğ
a
[0].
ba£
);

368 
	`CU_ASSERT
(11 =ğ
a
[1].
Ën
);

369 
	`CU_ASSERT
(
nuÎd©a
 + 256 =ğ
a
[1].
ba£
);

370 
	`CU_ASSERT
(1 =ğ
bút
);

371 
	`CU_ASSERT
(19 =ğ
b
[0].
Ën
);

372 
	`CU_ASSERT
(
nuÎd©a
 + 256 + 11 =ğ
b
[0].
ba£
);

373 
	}
}

	@tests/ngtcp2_vec_test.h

25 #iâdeà
NGTCP2_VEC_TEST_H


26 
	#NGTCP2_VEC_TEST_H


	)

28 #ifdeà
HAVE_CONFIG_H


29 
	~<cÚfig.h
>

32 
‹¡_ngtı2_vec_¥l™
();

33 
‹¡_ngtı2_vec_m”ge
();

	@third-party/http-parser/bench.c

21 
	~"h‰p_·r£r.h
"

22 
	~<as£¹.h
>

23 
	~<¡dio.h
>

24 
	~<¡ršg.h
>

25 
	~<sys/time.h
>

27 cÚ¡ 
	gd©a
[] =

42 cÚ¡ 
size_t
 
	gd©a_Ën
 = (
d©a
) - 1;

44 
	$Ú_šfo
(
h‰p_·r£r
* 
p
) {

46 
	}
}

49 
	$Ú_d©a
(
h‰p_·r£r
* 
p
, cÚ¡ *
©
, 
size_t
 
Ëngth
) {

51 
	}
}

53 
h‰p_·r£r_£‰šgs
 
	g£‰šgs
 = {

54 .
Ú_mes§ge_begš
 = 
Ú_šfo
,

55 .
	gÚ_h—d”s_com¶‘e
 = 
Ú_šfo
,

56 .
	gÚ_mes§ge_com¶‘e
 = 
Ú_šfo
,

57 .
	gÚ_h—d”_f›ld
 = 
Ú_d©a
,

58 .
	gÚ_h—d”_v®ue
 = 
Ú_d©a
,

59 .
	gÚ_u¾
 = 
Ú_d©a
,

60 .
	gÚ_¡©us
 = 
Ú_d©a
,

61 .
	gÚ_body
 = 
Ú_d©a


64 
	$b’ch
(
™”_couÁ
, 
s’t
) {

65 
h‰p_·r£r
 
·r£r
;

66 
i
;

67 
”r
;

68 
timev®
 
¡¬t
;

69 
timev®
 
’d
;

70 
½s
;

72 ià(!
s’t
) {

73 
”r
 = 
	`g‘timeofday
(&
¡¬t
, 
NULL
);

74 
	`as£¹
(
”r
 == 0);

77 
i
 = 0; i < 
™”_couÁ
; i++) {

78 
size_t
 
·r£d
;

79 
	`h‰p_·r£r_š™
(&
·r£r
, 
HTTP_REQUEST
);

81 
·r£d
 = 
	`h‰p_·r£r_execu‹
(&
·r£r
, &
£‰šgs
, 
d©a
, 
d©a_Ën
);

82 
	`as£¹
(
·r£d
 =ğ
d©a_Ën
);

85 ià(!
s’t
) {

86 
”r
 = 
	`g‘timeofday
(&
’d
, 
NULL
);

87 
	`as£¹
(
”r
 == 0);

89 
	`årštf
(
¡dout
, "Benchmark„esult:\n");

91 
½s
 = (è(
’d
.
tv_£c
 - 
¡¬t
.tv_sec) +

92 (
’d
.
tv_u£c
 - 
¡¬t
.tv_usec) * 1e-6f;

93 
	`årštf
(
¡dout
, "Took %à£cÚd tØrun\n", 
½s
);

95 
½s
 = (è
™”_couÁ
 /„ps;

96 
	`årštf
(
¡dout
, "%à»q/£c\n", 
½s
);

97 
	`fæush
(
¡dout
);

101 
	}
}

103 
	$maš
(
¬gc
, ** 
¬gv
) {

104 ià(
¬gc
 =ğ2 && 
	`¡rcmp
(
¬gv
[1], "infinite") == 0) {

106 
	`b’ch
(5000000, 1);

109  
	`b’ch
(5000000, 0);

111 
	}
}

	@third-party/http-parser/contrib/parsertrace.c

27 
	~"h‰p_·r£r.h
"

28 
	~<¡dio.h
>

29 
	~<¡dlib.h
>

30 
	~<¡ršg.h
>

32 
	$Ú_mes§ge_begš
(
h‰p_·r£r
* 
_
) {

33 ()
_
;

34 
	`´štf
("\n***MESSAGE BEGIN***\n\n");

36 
	}
}

38 
	$Ú_h—d”s_com¶‘e
(
h‰p_·r£r
* 
_
) {

39 ()
_
;

40 
	`´štf
("\n***HEADERS COMPLETE***\n\n");

42 
	}
}

44 
	$Ú_mes§ge_com¶‘e
(
h‰p_·r£r
* 
_
) {

45 ()
_
;

46 
	`´štf
("\n***MESSAGE COMPLETE***\n\n");

48 
	}
}

50 
	$Ú_u¾
(
h‰p_·r£r
* 
_
, cÚ¡ * 
©
, 
size_t
 
Ëngth
) {

51 ()
_
;

52 
	`´štf
("U¾: %.*s\n", ()
Ëngth
, 
©
);

54 
	}
}

56 
	$Ú_h—d”_f›ld
(
h‰p_·r£r
* 
_
, cÚ¡ * 
©
, 
size_t
 
Ëngth
) {

57 ()
_
;

58 
	`´štf
("H—d” f›ld: %.*s\n", ()
Ëngth
, 
©
);

60 
	}
}

62 
	$Ú_h—d”_v®ue
(
h‰p_·r£r
* 
_
, cÚ¡ * 
©
, 
size_t
 
Ëngth
) {

63 ()
_
;

64 
	`´štf
("H—d” v®ue: %.*s\n", ()
Ëngth
, 
©
);

66 
	}
}

68 
	$Ú_body
(
h‰p_·r£r
* 
_
, cÚ¡ * 
©
, 
size_t
 
Ëngth
) {

69 ()
_
;

70 
	`´štf
("Body: %.*s\n", ()
Ëngth
, 
©
);

72 
	}
}

74 
	$u§ge
(cÚ¡ * 
Çme
) {

75 
	`årštf
(
¡d”r
,

79 
Çme
);

80 
	`ex™
(
EXIT_FAILURE
);

81 
	}
}

83 
	$maš
(
¬gc
, * 
¬gv
[]) {

84 
h‰p_·r£r_ty³
 
fe_ty³
;

86 ià(
¬gc
 != 3) {

87 
	`u§ge
(
¬gv
[0]);

90 * 
ty³
 = 
¬gv
[1];

91 ià(
ty³
[0] != '-') {

92 
	`u§ge
(
¬gv
[0]);

95 
ty³
[1]) {

98 
fe_ty³
 = 
HTTP_RESPONSE
;

101 
fe_ty³
 = 
HTTP_REQUEST
;

104 
fe_ty³
 = 
HTTP_BOTH
;

107 
	`u§ge
(
¬gv
[0]);

110 * 
f’ame
 = 
¬gv
[2];

111 
FILE
* 
fe
 = 
	`fİ’
(
f’ame
, "r");

112 ià(
fe
 =ğ
NULL
) {

113 
	`³¼Ü
("fopen");

114 
ç
;

117 
	`f£ek
(
fe
, 0, 
SEEK_END
);

118 
fe_Ëngth
 = 
	`á–l
(
fe
);

119 ià(
fe_Ëngth
 == -1) {

120 
	`³¼Ü
("ftell");

121 
ç
;

123 
	`f£ek
(
fe
, 0, 
SEEK_SET
);

125 * 
d©a
 = 
	`m®loc
(
fe_Ëngth
);

126 ià(
	`ä—d
(
d©a
, 1, 
fe_Ëngth
, 
fe
è!ğ(
size_t
)file_length) {

127 
	`årštf
(
¡d”r
, "couldn't„eadƒntire file\n");

128 
	`ä“
(
d©a
);

129 
ç
;

132 
h‰p_·r£r_£‰šgs
 
£‰šgs
;

133 
	`mem£t
(&
£‰šgs
, 0, (settings));

134 
£‰šgs
.
Ú_mes§ge_begš
 = on_message_begin;

135 
£‰šgs
.
Ú_u¾
 = on_url;

136 
£‰šgs
.
Ú_h—d”_f›ld
 = on_header_field;

137 
£‰šgs
.
Ú_h—d”_v®ue
 = on_header_value;

138 
£‰šgs
.
Ú_h—d”s_com¶‘e
 = on_headers_complete;

139 
£‰šgs
.
Ú_body
 = on_body;

140 
£‰šgs
.
Ú_mes§ge_com¶‘e
 = on_message_complete;

142 
h‰p_·r£r
 
·r£r
;

143 
	`h‰p_·r£r_š™
(&
·r£r
, 
fe_ty³
);

144 
size_t
 
Å¬£d
 = 
	`h‰p_·r£r_execu‹
(&
·r£r
, &
£‰šgs
, 
d©a
, 
fe_Ëngth
);

145 
	`ä“
(
d©a
);

147 ià(
Å¬£d
 !ğ(
size_t
)
fe_Ëngth
) {

148 
	`årštf
(
¡d”r
,

150 
	`h‰p_”ºo_desütiÚ
(
	`HTTP_PARSER_ERRNO
(&
·r£r
)),

151 
	`h‰p_”ºo_Çme
(
	`HTTP_PARSER_ERRNO
(&
·r£r
)));

152 
ç
;

155  
EXIT_SUCCESS
;

157 
ç
:

158 
	`fşo£
(
fe
);

159  
EXIT_FAILURE
;

160 
	}
}

	@third-party/http-parser/contrib/url_parser.c

1 
	~"h‰p_·r£r.h
"

2 
	~<¡dio.h
>

3 
	~<¡ršg.h
>

6 
	$dump_u¾
 (cÚ¡ *
u¾
, cÚ¡ 
h‰p_·r£r_u¾
 *
u
)

8 
i
;

10 
	`´štf
("\tf›ld_£t: 0x%x,…Üt: %u\n", 
u
->
f›ld_£t
, u->
pÜt
);

11 
i
 = 0; i < 
UF_MAX
; i++) {

12 ià((
u
->
f›ld_£t
 & (1 << 
i
)) == 0) {

13 
	`´štf
("\tf›ld_d©a[%u]: un£t\n", 
i
);

17 
	`´štf
("\tfield_data[%u]: off: %u,†en: %u,…art: %.*s\n",

18 
i
,

19 
u
->
f›ld_d©a
[
i
].
off
,

20 
u
->
f›ld_d©a
[
i
].
Ën
,

21 
u
->
f›ld_d©a
[
i
].
Ën
,

22 
u¾
 + 
u
->
f›ld_d©a
[
i
].
off
);

24 
	}
}

26 
	$maš
(
¬gc
, ** 
¬gv
) {

27 
h‰p_·r£r_u¾
 
u
;

28 
Ën
, 
cÚÃù
, 
»suÉ
;

30 ià(
¬gc
 != 3) {

31 
	`´štf
("SyÁax : % cÚÃù|g‘ u¾\n", 
¬gv
[0]);

34 
Ën
 = 
	`¡¾’
(
¬gv
[2]);

35 
cÚÃù
 = 
	`¡rcmp
("cÚÃù", 
¬gv
[1]) == 0 ? 1 : 0;

36 
	`´štf
("P¬sšg %s, cÚÃù %d\n", 
¬gv
[2], 
cÚÃù
);

38 
	`h‰p_·r£r_u¾_š™
(&
u
);

39 
»suÉ
 = 
	`h‰p_·r£r_·r£_u¾
(
¬gv
[2], 
Ën
, 
cÚÃù
, &
u
);

40 ià(
»suÉ
 != 0) {

41 
	`´štf
("P¬£ƒ¼Ü : %d\n", 
»suÉ
);

42  
»suÉ
;

44 
	`´štf
("Parse ok,„esult : \n");

45 
	`dump_u¾
(
¬gv
[2], &
u
);

47 
	}
}

	@third-party/http-parser/http_parser.c

24 
	~"h‰p_·r£r.h
"

25 
	~<as£¹.h
>

26 
	~<¡ddef.h
>

27 
	~<ùy³.h
>

28 
	~<¡dlib.h
>

29 
	~<¡ršg.h
>

30 
	~<lim™s.h
>

32 #iâdeà
ULLONG_MAX


33 
	#ULLONG_MAX
 ((
ušt64_t
è-1è

	)

36 #iâdeà
MIN


37 
	#MIN
(
a
,
b
è(×è< (bè? (aè: (b))

	)

40 #iâdeà
ARRAY_SIZE


41 
	#ARRAY_SIZE
(
a
è(×è/ (×)[0]))

	)

44 #iâdeà
BIT_AT


45 
	#BIT_AT
(
a
, 
i
) \

46 (!!((è(
a
)[(è(
i
) >> 3] & \

47 (1 << ((è(
i
è& 7))))

	)

50 #iâdeà
ELEM_AT


51 
	#ELEM_AT
(
a
, 
i
, 
v
è((è(iè< 
	`ARRAY_SIZE
×è? (a)[(i)] : (v))

	)

54 
	#SET_ERRNO
(
e
) \

56 
·r£r
->
h‰p_”ºo
 = (
e
); \

57 } 0)

	)

59 
	#CURRENT_STATE
(è
p_¡©e


	)

60 
	#UPDATE_STATE
(
V
è
p_¡©e
 = (
¡©e
è(V);

	)

61 
	#RETURN
(
V
) \

63 
·r£r
->
¡©e
 = 
	`CURRENT_STATE
(); \

64  (
V
); \

65 } 0);

	)

66 
	#REEXECUTE
() \

67 
»execu‹
; \

68 

	)

70 #ifdeà
__GNUC__


71 
	#LIKELY
(
X
è
	`__butš_ex³ù
(!!(X), 1)

	)

72 
	#UNLIKELY
(
X
è
	`__butš_ex³ù
(!!(X), 0)

	)

74 
	#LIKELY
(
X
è(X)

	)

75 
	#UNLIKELY
(
X
è(X)

	)

80 
	#CALLBACK_NOTIFY_
(
FOR
, 
ER
) \

82 
	`as£¹
(
	`HTTP_PARSER_ERRNO
(
·r£r
è=ğ
HPE_OK
); \

84 ià(
	`LIKELY
(
£‰šgs
->
Ú_
##
FOR
)) { \

85 
·r£r
->
¡©e
 = 
	`CURRENT_STATE
(); \

86 ià(
	`UNLIKELY
(0 !ğ
£‰šgs
->
Ú_
##
	`FOR
(
·r£r
))) { \

87 
	`SET_ERRNO
(
HPE_CB_
##
FOR
); \

89 
	`UPDATE_STATE
(
·r£r
->
¡©e
); \

92 ià(
	`UNLIKELY
(
	`HTTP_PARSER_ERRNO
(
·r£r
è!ğ
HPE_OK
)) { \

93  (
ER
); \

96 } 0)

	)

99 
	#CALLBACK_NOTIFY
(
FOR
è
	`CALLBACK_NOTIFY_
(FOR, 
p
 - 
d©a
 + 1)

	)

102 
	#CALLBACK_NOTIFY_NOADVANCE
(
FOR
è
	`CALLBACK_NOTIFY_
(FOR, 
p
 - 
d©a
)

	)

105 
	#CALLBACK_DATA_
(
FOR
, 
LEN
, 
ER
) \

107 
	`as£¹
(
	`HTTP_PARSER_ERRNO
(
·r£r
è=ğ
HPE_OK
); \

109 ià(
FOR
##
_m¬k
) { \

110 ià(
	`LIKELY
(
£‰šgs
->
Ú_
##
FOR
)) { \

111 
·r£r
->
¡©e
 = 
	`CURRENT_STATE
(); \

112 ià(
	`UNLIKELY
(0 != \

113 
£‰šgs
->
Ú_
##
	`FOR
(
·r£r
, 
FOR
##
_m¬k
, (
LEN
)))) { \

114 
	`SET_ERRNO
(
HPE_CB_
##
FOR
); \

116 
	`UPDATE_STATE
(
·r£r
->
¡©e
); \

119 ià(
	`UNLIKELY
(
	`HTTP_PARSER_ERRNO
(
·r£r
è!ğ
HPE_OK
)) { \

120  (
ER
); \

123 
FOR
##
_m¬k
 = 
NULL
; \

125 } 0)

	)

128 
	#CALLBACK_DATA
(
FOR
) \

129 
	`CALLBACK_DATA_
(
FOR
, 
p
 - FOR##
_m¬k
,… - 
d©a
 + 1)

	)

132 
	#CALLBACK_DATA_NOADVANCE
(
FOR
) \

133 
	`CALLBACK_DATA_
(
FOR
, 
p
 - FOR##
_m¬k
,… - 
d©a
)

	)

136 
	#MARK
(
FOR
) \

138 ià(!
FOR
##
_m¬k
) { \

139 
FOR
##
_m¬k
 = 
p
; \

141 } 0)

	)

154 
	#COUNT_HEADER_SIZE
(
V
) \

156 
·r£r
->
Ä—d
 +ğ(
V
); \

157 ià(
	`UNLIKELY
(
·r£r
->
Ä—d
 > (
HTTP_MAX_HEADER_SIZE
))) { \

158 
	`SET_ERRNO
(
HPE_HEADER_OVERFLOW
); \

159 
”rÜ
; \

161 } 0)

	)

164 
	#PROXY_CONNECTION
 "´oxy-cÚÃùiÚ"

	)

165 
	#CONNECTION
 "cÚÃùiÚ"

	)

166 
	#CONTENT_LENGTH
 "cÚ‹Á-Ëngth"

	)

167 
	#TRANSFER_ENCODING
 "Œªsãr-’codšg"

	)

168 
	#UPGRADE
 "upg¿de"

	)

169 
	#CHUNKED
 "chunked"

	)

170 
	#KEEP_ALIVE
 "k“p-®ive"

	)

171 
	#CLOSE
 "şo£"

	)

174 cÚ¡ *
	gm‘hod_¡ršgs
[] =

176 
	#XX
(
num
, 
Çme
, 
¡ršg
è#¡ršg,

	)

177 
HTTP_METHOD_MAP
(
XX
)

178 #undeà
XX


189 cÚ¡ 
	gtok’s
[256] = {

224 cÚ¡ 
št8_t
 
	gunhex
[256] =

236 #ià
HTTP_PARSER_STRICT


237 
	#T
(
v
è0

	)

239 
	#T
(
v
è
	)
v

243 cÚ¡ 
ušt8_t
 
	gnÜm®_u¾_ch¬
[32] = {

247 0 | 
T
(2) | 0 | 0 | T(16) | 0 | 0 | 0,

277 #undeà
T


279 
	e¡©e


280 { 
	ms_d—d
 = 1

282 , 
	ms_¡¬t_»q_Ü_»s


283 , 
	ms_»s_Ü_»¥_H


284 , 
	ms_¡¬t_»s


285 , 
	ms_»s_H


286 , 
	ms_»s_HT


287 , 
	ms_»s_HTT


288 , 
	ms_»s_HTTP


289 , 
	ms_»s_h‰p_majÜ


290 , 
	ms_»s_h‰p_dÙ


291 , 
	ms_»s_h‰p_mšÜ


292 , 
	ms_»s_h‰p_’d


293 , 
	ms_»s_fœ¡_¡©us_code


294 , 
	ms_»s_¡©us_code


295 , 
	ms_»s_¡©us_¡¬t


296 , 
	ms_»s_¡©us


297 , 
	ms_»s_lše_®mo¡_dÚe


299 , 
	ms_¡¬t_»q


301 , 
	ms_»q_m‘hod


302 , 
	ms_»q_¥aûs_befÜe_u¾


303 , 
	ms_»q_schema


304 , 
	ms_»q_schema_¦ash


305 , 
	ms_»q_schema_¦ash_¦ash


306 , 
	ms_»q_£rv”_¡¬t


307 , 
	ms_»q_£rv”


308 , 
	ms_»q_£rv”_w™h_©


309 , 
	ms_»q_·th


310 , 
	ms_»q_qu”y_¡ršg_¡¬t


311 , 
	ms_»q_qu”y_¡ršg


312 , 
	ms_»q_äagm’t_¡¬t


313 , 
	ms_»q_äagm’t


314 , 
	ms_»q_h‰p_¡¬t


315 , 
	ms_»q_h‰p_H


316 , 
	ms_»q_h‰p_HT


317 , 
	ms_»q_h‰p_HTT


318 , 
	ms_»q_h‰p_HTTP


319 , 
	ms_»q_h‰p_majÜ


320 , 
	ms_»q_h‰p_dÙ


321 , 
	ms_»q_h‰p_mšÜ


322 , 
	ms_»q_h‰p_’d


323 , 
	ms_»q_lše_®mo¡_dÚe


325 , 
	ms_h—d”_f›ld_¡¬t


326 , 
	ms_h—d”_f›ld


327 , 
	ms_h—d”_v®ue_disÿrd_ws


328 , 
	ms_h—d”_v®ue_disÿrd_ws_®mo¡_dÚe


329 , 
	ms_h—d”_v®ue_disÿrd_lws


330 , 
	ms_h—d”_v®ue_¡¬t


331 , 
	ms_h—d”_v®ue


332 , 
	ms_h—d”_v®ue_lws


334 , 
	ms_h—d”_®mo¡_dÚe


336 , 
	ms_chunk_size_¡¬t


337 , 
	ms_chunk_size


338 , 
	ms_chunk_·¿m‘”s


339 , 
	ms_chunk_size_®mo¡_dÚe


341 , 
	ms_h—d”s_®mo¡_dÚe


342 , 
	ms_h—d”s_dÚe


349 , 
	ms_chunk_d©a


350 , 
	ms_chunk_d©a_®mo¡_dÚe


351 , 
	ms_chunk_d©a_dÚe


353 , 
	ms_body_id’t™y


354 , 
	ms_body_id’t™y_eof


356 , 
	ms_mes§ge_dÚe


360 
	#PARSING_HEADER
(
¡©e
è(¡©<ğ
s_h—d”s_dÚe
)

	)

363 
	eh—d”_¡©es


364 { 
	mh_g’”®
 = 0

365 , 
	mh_C


366 , 
	mh_CO


367 , 
	mh_CON


369 , 
	mh_m©chšg_cÚÃùiÚ


370 , 
	mh_m©chšg_´oxy_cÚÃùiÚ


371 , 
	mh_m©chšg_cÚ‹Á_Ëngth


372 , 
	mh_m©chšg_Œªsãr_’codšg


373 , 
	mh_m©chšg_upg¿de


375 , 
	mh_cÚÃùiÚ


376 , 
	mh_cÚ‹Á_Ëngth


377 , 
	mh_Œªsãr_’codšg


378 , 
	mh_upg¿de


380 , 
	mh_m©chšg_Œªsãr_’codšg_chunked


381 , 
	mh_m©chšg_cÚÃùiÚ_tok’_¡¬t


382 , 
	mh_m©chšg_cÚÃùiÚ_k“p_®ive


383 , 
	mh_m©chšg_cÚÃùiÚ_şo£


384 , 
	mh_m©chšg_cÚÃùiÚ_upg¿de


385 , 
	mh_m©chšg_cÚÃùiÚ_tok’


387 , 
	mh_Œªsãr_’codšg_chunked


388 , 
	mh_cÚÃùiÚ_k“p_®ive


389 , 
	mh_cÚÃùiÚ_şo£


390 , 
	mh_cÚÃùiÚ_upg¿de


393 
	eh‰p_ho¡_¡©e


395 
	ms_h‰p_ho¡_d—d
 = 1

396 , 
	ms_h‰p_u£ršfo_¡¬t


397 , 
	ms_h‰p_u£ršfo


398 , 
	ms_h‰p_ho¡_¡¬t


399 , 
	ms_h‰p_ho¡_v6_¡¬t


400 , 
	ms_h‰p_ho¡


401 , 
	ms_h‰p_ho¡_v6


402 , 
	ms_h‰p_ho¡_v6_’d


403 , 
	ms_h‰p_ho¡_v6_zÚe_¡¬t


404 , 
	ms_h‰p_ho¡_v6_zÚe


405 , 
	ms_h‰p_ho¡_pÜt_¡¬t


406 , 
	ms_h‰p_ho¡_pÜt


410 
	#CR
 '\r'

	)

411 
	#LF
 '\n'

	)

412 
	#LOWER
(
c
è()(ø| 0x20)

	)

413 
	#IS_ALPHA
(
c
è(
	`LOWER
(cè>ğ'a' && LOWER(cè<ğ'z')

	)

414 
	#IS_NUM
(
c
è((cè>ğ'0' && (cè<ğ'9')

	)

415 
	#IS_ALPHANUM
(
c
è(
	`IS_ALPHA
(cè|| 
	`IS_NUM
(c))

	)

416 
	#IS_HEX
(
c
è(
	`IS_NUM
(cè|| (
	`LOWER
(cè>ğ'a' && LOWER(cè<ğ'f'))

	)

417 
	#IS_MARK
(
c
) ((c) == '-' || (c) == '_' || (c) == '.' || \

418 (
c
) == '!' || (c) == '~' || (c) == '*' || (c) == '\'' || (c) == '(' || \

419 (
c
è=ğ')')

	)

420 
	#IS_USERINFO_CHAR
(
c
è(
	`IS_ALPHANUM
(cè|| 
	`IS_MARK
(c) || (c) == '%' || \

421 (
c
) == ';' || (c) == ':' || (c) == '&' || (c) == '=' || (c) == '+' || \

422 (
c
è=ğ'$' || (cè=ğ',')

	)

424 
	#STRICT_TOKEN
(
c
è(
tok’s
[()c])

	)

426 #ià
HTTP_PARSER_STRICT


427 
	#TOKEN
(
c
è(
tok’s
[()c])

	)

428 
	#IS_URL_CHAR
(
c
è(
	`BIT_AT
(
nÜm®_u¾_ch¬
, ()c))

	)

429 
	#IS_HOST_CHAR
(
c
è(
	`IS_ALPHANUM
(cè|| (cè=ğ'.' || (cè=ğ'-')

	)

431 
	#TOKEN
(
c
è((ø=ğ' 'è? ' ' : 
tok’s
[()c])

	)

432 
	#IS_URL_CHAR
(
c
) \

433 (
	`BIT_AT
(
nÜm®_u¾_ch¬
, ()
c
è|| ((cè& 0x80))

	)

434 
	#IS_HOST_CHAR
(
c
) \

435 (
	`IS_ALPHANUM
(
c
è|| (cè=ğ'.' || (cè=ğ'-' || (cè=ğ'_')

	)

442 
	#IS_HEADER_CHAR
(
ch
) \

443 (
ch
 =ğ
CR
 || ch =ğ
LF
 || ch =ğ9 || (()ch > 31 && ch !ğ127))

	)

445 
	#¡¬t_¡©e
 (
·r£r
->
ty³
 =ğ
HTTP_REQUEST
 ? 
s_¡¬t_»q
 : 
s_¡¬t_»s
)

	)

448 #ià
HTTP_PARSER_STRICT


449 
	#STRICT_CHECK
(
cÚd
) \

451 ià(
cÚd
) { \

452 
	`SET_ERRNO
(
HPE_STRICT
); \

453 
”rÜ
; \

455 } 0)

	)

456 
	#NEW_MESSAGE
(è(
	`h‰p_should_k“p_®ive
(
·r£r
è? 
¡¬t_¡©e
 : 
s_d—d
)

	)

458 
	#STRICT_CHECK
(
cÚd
)

	)

459 
	#NEW_MESSAGE
(è
¡¬t_¡©e


	)

464 
	#HTTP_STRERROR_GEN
(
n
, 
s
è{ "HPE_" #n, s },

	)

466 cÚ¡ *
	mÇme
;

467 cÚ¡ *
	mdesütiÚ
;

468 } 
	gh‰p_¡»¼Ü_b
[] = {

469 
HTTP_ERRNO_MAP
(
HTTP_STRERROR_GEN
)

471 #undeà
HTTP_STRERROR_GEN


473 
h‰p_mes§ge_Ãeds_eof
(cÚ¡ 
h‰p_·r£r
 *
·r£r
);

486 
¡©e


487 
	$·r£_u¾_ch¬
(
¡©e
 
s
, cÚ¡ 
ch
)

489 ià(
ch
 == ' ' || ch == '\r' || ch == '\n') {

490  
s_d—d
;

493 #ià
HTTP_PARSER_STRICT


494 ià(
ch
 == '\t' || ch == '\f') {

495  
s_d—d
;

499 
s
) {

500 
s_»q_¥aûs_befÜe_u¾
:

505 ià(
ch
 == '/' || ch == '*') {

506  
s_»q_·th
;

509 ià(
	`IS_ALPHA
(
ch
)) {

510  
s_»q_schema
;

515 
s_»q_schema
:

516 ià(
	`IS_ALPHA
(
ch
)) {

517  
s
;

520 ià(
ch
 == ':') {

521  
s_»q_schema_¦ash
;

526 
s_»q_schema_¦ash
:

527 ià(
ch
 == '/') {

528  
s_»q_schema_¦ash_¦ash
;

533 
s_»q_schema_¦ash_¦ash
:

534 ià(
ch
 == '/') {

535  
s_»q_£rv”_¡¬t
;

540 
s_»q_£rv”_w™h_©
:

541 ià(
ch
 == '@') {

542  
s_d—d
;

546 
s_»q_£rv”_¡¬t
:

547 
s_»q_£rv”
:

548 ià(
ch
 == '/') {

549  
s_»q_·th
;

552 ià(
ch
 == '?') {

553  
s_»q_qu”y_¡ršg_¡¬t
;

556 ià(
ch
 == '@') {

557  
s_»q_£rv”_w™h_©
;

560 ià(
	`IS_USERINFO_CHAR
(
ch
) || ch == '[' || ch == ']') {

561  
s_»q_£rv”
;

566 
s_»q_·th
:

567 ià(
	`IS_URL_CHAR
(
ch
)) {

568  
s
;

571 
ch
) {

573  
s_»q_qu”y_¡ršg_¡¬t
;

576  
s_»q_äagm’t_¡¬t
;

581 
s_»q_qu”y_¡ršg_¡¬t
:

582 
s_»q_qu”y_¡ršg
:

583 ià(
	`IS_URL_CHAR
(
ch
)) {

584  
s_»q_qu”y_¡ršg
;

587 
ch
) {

590  
s_»q_qu”y_¡ršg
;

593  
s_»q_äagm’t_¡¬t
;

598 
s_»q_äagm’t_¡¬t
:

599 ià(
	`IS_URL_CHAR
(
ch
)) {

600  
s_»q_äagm’t
;

603 
ch
) {

605  
s_»q_äagm’t
;

608  
s
;

613 
s_»q_äagm’t
:

614 ià(
	`IS_URL_CHAR
(
ch
)) {

615  
s
;

618 
ch
) {

621  
s
;

631  
s_d—d
;

632 
	}
}

634 
size_t
 
	$h‰p_·r£r_execu‹
 (
h‰p_·r£r
 *
·r£r
,

635 cÚ¡ 
h‰p_·r£r_£‰šgs
 *
£‰šgs
,

636 cÚ¡ *
d©a
,

637 
size_t
 
Ën
)

639 
c
, 
ch
;

640 
št8_t
 
unhex_v®
;

641 cÚ¡ *
p
 = 
d©a
;

642 cÚ¡ *
h—d”_f›ld_m¬k
 = 0;

643 cÚ¡ *
h—d”_v®ue_m¬k
 = 0;

644 cÚ¡ *
u¾_m¬k
 = 0;

645 cÚ¡ *
body_m¬k
 = 0;

646 cÚ¡ *
¡©us_m¬k
 = 0;

647 
¡©e
 
p_¡©e
 = (¡©eè
·r£r
->state;

648 cÚ¡ 
Ën›Á
 = 
·r£r
->
Ën›Á_h‰p_h—d”s
;

651 ià(
	`HTTP_PARSER_ERRNO
(
·r£r
è!ğ
HPE_OK
) {

655 ià(
Ën
 == 0) {

656 
	`CURRENT_STATE
()) {

657 
s_body_id’t™y_eof
:

661 
	`CALLBACK_NOTIFY_NOADVANCE
(
mes§ge_com¶‘e
);

664 
s_d—d
:

665 
s_¡¬t_»q_Ü_»s
:

666 
s_¡¬t_»s
:

667 
s_¡¬t_»q
:

671 
	`SET_ERRNO
(
HPE_INVALID_EOF_STATE
);

677 ià(
	`CURRENT_STATE
(è=ğ
s_h—d”_f›ld
)

678 
h—d”_f›ld_m¬k
 = 
d©a
;

679 ià(
	`CURRENT_STATE
(è=ğ
s_h—d”_v®ue
)

680 
h—d”_v®ue_m¬k
 = 
d©a
;

681 
	`CURRENT_STATE
()) {

682 
s_»q_·th
:

683 
s_»q_schema
:

684 
s_»q_schema_¦ash
:

685 
s_»q_schema_¦ash_¦ash
:

686 
s_»q_£rv”_¡¬t
:

687 
s_»q_£rv”
:

688 
s_»q_£rv”_w™h_©
:

689 
s_»q_qu”y_¡ršg_¡¬t
:

690 
s_»q_qu”y_¡ršg
:

691 
s_»q_äagm’t_¡¬t
:

692 
s_»q_äagm’t
:

693 
u¾_m¬k
 = 
d©a
;

695 
s_»s_¡©us
:

696 
¡©us_m¬k
 = 
d©a
;

702 
p
=
d©a
;… !ğd©¨+ 
Ën
;…++) {

703 
ch
 = *
p
;

705 ià(
	`PARSING_HEADER
(
	`CURRENT_STATE
()))

706 
	`COUNT_HEADER_SIZE
(1);

708 
»execu‹
:

709 
	`CURRENT_STATE
()) {

711 
s_d—d
:

715 ià(
	`LIKELY
(
ch
 =ğ
CR
 || ch =ğ
LF
))

718 
	`SET_ERRNO
(
HPE_CLOSED_CONNECTION
);

719 
”rÜ
;

721 
s_¡¬t_»q_Ü_»s
:

723 ià(
ch
 =ğ
CR
 || ch =ğ
LF
)

725 
·r£r
->
æags
 = 0;

726 
·r£r
->
cÚ‹Á_Ëngth
 = 
ULLONG_MAX
;

728 ià(
ch
 == 'H') {

729 
	`UPDATE_STATE
(
s_»s_Ü_»¥_H
);

731 
	`CALLBACK_NOTIFY
(
mes§ge_begš
);

733 
·r£r
->
ty³
 = 
HTTP_REQUEST
;

734 
	`UPDATE_STATE
(
s_¡¬t_»q
);

735 
	`REEXECUTE
();

741 
s_»s_Ü_»¥_H
:

742 ià(
ch
 == 'T') {

743 
·r£r
->
ty³
 = 
HTTP_RESPONSE
;

744 
	`UPDATE_STATE
(
s_»s_HT
);

746 ià(
	`UNLIKELY
(
ch
 != 'E')) {

747 
	`SET_ERRNO
(
HPE_INVALID_CONSTANT
);

748 
”rÜ
;

751 
·r£r
->
ty³
 = 
HTTP_REQUEST
;

752 
·r£r
->
m‘hod
 = 
HTTP_HEAD
;

753 
·r£r
->
šdex
 = 2;

754 
	`UPDATE_STATE
(
s_»q_m‘hod
);

758 
s_¡¬t_»s
:

760 
·r£r
->
æags
 = 0;

761 
·r£r
->
cÚ‹Á_Ëngth
 = 
ULLONG_MAX
;

763 
ch
) {

765 
	`UPDATE_STATE
(
s_»s_H
);

768 
CR
:

769 
LF
:

773 
	`SET_ERRNO
(
HPE_INVALID_CONSTANT
);

774 
”rÜ
;

777 
	`CALLBACK_NOTIFY
(
mes§ge_begš
);

781 
s_»s_H
:

782 
	`STRICT_CHECK
(
ch
 != 'T');

783 
	`UPDATE_STATE
(
s_»s_HT
);

786 
s_»s_HT
:

787 
	`STRICT_CHECK
(
ch
 != 'T');

788 
	`UPDATE_STATE
(
s_»s_HTT
);

791 
s_»s_HTT
:

792 
	`STRICT_CHECK
(
ch
 != 'P');

793 
	`UPDATE_STATE
(
s_»s_HTTP
);

796 
s_»s_HTTP
:

797 
	`STRICT_CHECK
(
ch
 != '/');

798 
	`UPDATE_STATE
(
s_»s_h‰p_majÜ
);

801 
s_»s_h‰p_majÜ
:

802 ià(
	`UNLIKELY
(!
	`IS_NUM
(
ch
))) {

803 
	`SET_ERRNO
(
HPE_INVALID_VERSION
);

804 
”rÜ
;

807 
·r£r
->
h‰p_majÜ
 = 
ch
 - '0';

808 
	`UPDATE_STATE
(
s_»s_h‰p_dÙ
);

811 
s_»s_h‰p_dÙ
:

813 ià(
	`UNLIKELY
(
ch
 != '.')) {

814 
	`SET_ERRNO
(
HPE_INVALID_VERSION
);

815 
”rÜ
;

818 
	`UPDATE_STATE
(
s_»s_h‰p_mšÜ
);

822 
s_»s_h‰p_mšÜ
:

823 ià(
	`UNLIKELY
(!
	`IS_NUM
(
ch
))) {

824 
	`SET_ERRNO
(
HPE_INVALID_VERSION
);

825 
”rÜ
;

828 
·r£r
->
h‰p_mšÜ
 = 
ch
 - '0';

829 
	`UPDATE_STATE
(
s_»s_h‰p_’d
);

832 
s_»s_h‰p_’d
:

834 ià(
	`UNLIKELY
(
ch
 != ' ')) {

835 
	`SET_ERRNO
(
HPE_INVALID_VERSION
);

836 
”rÜ
;

839 
	`UPDATE_STATE
(
s_»s_fœ¡_¡©us_code
);

843 
s_»s_fœ¡_¡©us_code
:

845 ià(!
	`IS_NUM
(
ch
)) {

846 ià(
ch
 == ' ') {

850 
	`SET_ERRNO
(
HPE_INVALID_STATUS
);

851 
”rÜ
;

853 
·r£r
->
¡©us_code
 = 
ch
 - '0';

854 
	`UPDATE_STATE
(
s_»s_¡©us_code
);

858 
s_»s_¡©us_code
:

860 ià(!
	`IS_NUM
(
ch
)) {

861 
ch
) {

863 
	`UPDATE_STATE
(
s_»s_¡©us_¡¬t
);

865 
CR
:

866 
LF
:

867 
	`UPDATE_STATE
(
s_»s_¡©us_¡¬t
);

868 
	`REEXECUTE
();

871 
	`SET_ERRNO
(
HPE_INVALID_STATUS
);

872 
”rÜ
;

877 
·r£r
->
¡©us_code
 *= 10;

878 
·r£r
->
¡©us_code
 +ğ
ch
 - '0';

880 ià(
	`UNLIKELY
(
·r£r
->
¡©us_code
 > 999)) {

881 
	`SET_ERRNO
(
HPE_INVALID_STATUS
);

882 
”rÜ
;

888 
s_»s_¡©us_¡¬t
:

890 
	`MARK
(
¡©us
);

891 
	`UPDATE_STATE
(
s_»s_¡©us
);

892 
·r£r
->
šdex
 = 0;

894 ià(
ch
 =ğ
CR
 || ch =ğ
LF
)

895 
	`REEXECUTE
();

900 
s_»s_¡©us
:

901 ià(
ch
 =ğ
CR
) {

902 
	`UPDATE_STATE
(
s_»s_lše_®mo¡_dÚe
);

903 
	`CALLBACK_DATA
(
¡©us
);

907 ià(
ch
 =ğ
LF
) {

908 
	`UPDATE_STATE
(
s_h—d”_f›ld_¡¬t
);

909 
	`CALLBACK_DATA
(
¡©us
);

915 
s_»s_lše_®mo¡_dÚe
:

916 
	`STRICT_CHECK
(
ch
 !ğ
LF
);

917 
	`UPDATE_STATE
(
s_h—d”_f›ld_¡¬t
);

920 
s_¡¬t_»q
:

922 ià(
ch
 =ğ
CR
 || ch =ğ
LF
)

924 
·r£r
->
æags
 = 0;

925 
·r£r
->
cÚ‹Á_Ëngth
 = 
ULLONG_MAX
;

927 ià(
	`UNLIKELY
(!
	`IS_ALPHA
(
ch
))) {

928 
	`SET_ERRNO
(
HPE_INVALID_METHOD
);

929 
”rÜ
;

932 
·r£r
->
m‘hod
 = (
h‰p_m‘hod
) 0;

933 
·r£r
->
šdex
 = 1;

934 
ch
) {

935 'A': 
·r£r
->
m‘hod
 = 
HTTP_ACL
; ;

936 'B': 
·r£r
->
m‘hod
 = 
HTTP_BIND
; ;

937 'C': 
·r£r
->
m‘hod
 = 
HTTP_CONNECT
; ;

938 'D': 
·r£r
->
m‘hod
 = 
HTTP_DELETE
; ;

939 'G': 
·r£r
->
m‘hod
 = 
HTTP_GET
; ;

940 'H': 
·r£r
->
m‘hod
 = 
HTTP_HEAD
; ;

941 'L': 
·r£r
->
m‘hod
 = 
HTTP_LOCK
; ;

942 'M': 
·r£r
->
m‘hod
 = 
HTTP_MKCOL
; ;

943 'N': 
·r£r
->
m‘hod
 = 
HTTP_NOTIFY
; ;

944 'O': 
·r£r
->
m‘hod
 = 
HTTP_OPTIONS
; ;

945 'P': 
·r£r
->
m‘hod
 = 
HTTP_POST
;

948 'R': 
·r£r
->
m‘hod
 = 
HTTP_REPORT
; ;

949 'S': 
·r£r
->
m‘hod
 = 
HTTP_SUBSCRIBE
; ;

950 'T': 
·r£r
->
m‘hod
 = 
HTTP_TRACE
; ;

951 'U': 
·r£r
->
m‘hod
 = 
HTTP_UNLOCK
; ;

953 
	`SET_ERRNO
(
HPE_INVALID_METHOD
);

954 
”rÜ
;

956 
	`UPDATE_STATE
(
s_»q_m‘hod
);

958 
	`CALLBACK_NOTIFY
(
mes§ge_begš
);

963 
s_»q_m‘hod
:

965 cÚ¡ *
m©ch”
;

966 ià(
	`UNLIKELY
(
ch
 == '\0')) {

967 
	`SET_ERRNO
(
HPE_INVALID_METHOD
);

968 
”rÜ
;

971 
m©ch”
 = 
m‘hod_¡ršgs
[
·r£r
->
m‘hod
];

972 ià(
ch
 =ğ' ' && 
m©ch”
[
·r£r
->
šdex
] == '\0') {

973 
	`UPDATE_STATE
(
s_»q_¥aûs_befÜe_u¾
);

974 } ià(
ch
 =ğ
m©ch”
[
·r£r
->
šdex
]) {

976 } ià((
ch
 >= 'A' && ch <= 'Z') || ch == '-') {

978 
·r£r
->
m‘hod
 << 16 |…¬£r->
šdex
 << 8 | 
ch
) {

979 
	#XX
(
m‘h
, 
pos
, 
ch
, 
Ãw_m‘h
) \

980 (
HTTP_
##
m‘h
 << 16 | 
pos
 << 8 | 
ch
): \

981 
·r£r
->
m‘hod
 = 
HTTP_
##
Ãw_m‘h
; ;

	)

983 
	`XX
(
POST
, 1, 'U', 
PUT
)

984 
	`XX
(
POST
, 1, 'A', 
PATCH
)

985 
	`XX
(
POST
, 1, 'R', 
PROPFIND
)

986 
	`XX
(
PUT
, 2, 'R', 
PURGE
)

987 
	`XX
(
CONNECT
, 1, 'H', 
CHECKOUT
)

988 
	`XX
(
CONNECT
, 2, 'P', 
COPY
)

989 
	`XX
(
MKCOL
, 1, 'O', 
MOVE
)

990 
	`XX
(
MKCOL
, 1, 'E', 
MERGE
)

991 
	`XX
(
MKCOL
, 1, '-', 
MSEARCH
)

992 
	`XX
(
MKCOL
, 2, 'A', 
MKACTIVITY
)

993 
	`XX
(
MKCOL
, 3, 'A', 
MKCALENDAR
)

994 
	`XX
(
SUBSCRIBE
, 1, 'E', 
SEARCH
)

995 
	`XX
(
REPORT
, 2, 'B', 
REBIND
)

996 
	`XX
(
PROPFIND
, 4, 'P', 
PROPPATCH
)

997 
	`XX
(
LOCK
, 1, 'I', 
LINK
)

998 
	`XX
(
UNLOCK
, 2, 'S', 
UNSUBSCRIBE
)

999 
	`XX
(
UNLOCK
, 2, 'B', 
UNBIND
)

1000 
	`XX
(
UNLOCK
, 3, 'I', 
UNLINK
)

1001 #undeà
XX


1003 
	`SET_ERRNO
(
HPE_INVALID_METHOD
);

1004 
”rÜ
;

1007 
	`SET_ERRNO
(
HPE_INVALID_METHOD
);

1008 
”rÜ
;

1011 ++
·r£r
->
šdex
;

1015 
s_»q_¥aûs_befÜe_u¾
:

1017 ià(
ch
 == ' ') ;

1019 
	`MARK
(
u¾
);

1020 ià(
·r£r
->
m‘hod
 =ğ
HTTP_CONNECT
) {

1021 
	`UPDATE_STATE
(
s_»q_£rv”_¡¬t
);

1024 
	`UPDATE_STATE
(
	`·r£_u¾_ch¬
(
	`CURRENT_STATE
(), 
ch
));

1025 ià(
	`UNLIKELY
(
	`CURRENT_STATE
(è=ğ
s_d—d
)) {

1026 
	`SET_ERRNO
(
HPE_INVALID_URL
);

1027 
”rÜ
;

1033 
s_»q_schema
:

1034 
s_»q_schema_¦ash
:

1035 
s_»q_schema_¦ash_¦ash
:

1036 
s_»q_£rv”_¡¬t
:

1038 
ch
) {

1041 
CR
:

1042 
LF
:

1043 
	`SET_ERRNO
(
HPE_INVALID_URL
);

1044 
”rÜ
;

1046 
	`UPDATE_STATE
(
	`·r£_u¾_ch¬
(
	`CURRENT_STATE
(), 
ch
));

1047 ià(
	`UNLIKELY
(
	`CURRENT_STATE
(è=ğ
s_d—d
)) {

1048 
	`SET_ERRNO
(
HPE_INVALID_URL
);

1049 
”rÜ
;

1056 
s_»q_£rv”
:

1057 
s_»q_£rv”_w™h_©
:

1058 
s_»q_·th
:

1059 
s_»q_qu”y_¡ršg_¡¬t
:

1060 
s_»q_qu”y_¡ršg
:

1061 
s_»q_äagm’t_¡¬t
:

1062 
s_»q_äagm’t
:

1064 
ch
) {

1066 
	`UPDATE_STATE
(
s_»q_h‰p_¡¬t
);

1067 
	`CALLBACK_DATA
(
u¾
);

1069 
CR
:

1070 
LF
:

1071 
·r£r
->
h‰p_majÜ
 = 0;

1072 
·r£r
->
h‰p_mšÜ
 = 9;

1073 
	`CALLBACK_DATA
(
u¾
);

1074 ià(
ch
 =ğ
CR
) {

1075 
	`UPDATE_STATE
(
s_»q_lše_®mo¡_dÚe
);

1077 
	`UPDATE_STATE
(
s_h—d”s_®mo¡_dÚe
);

1078 
	`REEXECUTE
();

1082 
	`UPDATE_STATE
(
	`·r£_u¾_ch¬
(
	`CURRENT_STATE
(), 
ch
));

1083 ià(
	`UNLIKELY
(
	`CURRENT_STATE
(è=ğ
s_d—d
)) {

1084 
	`SET_ERRNO
(
HPE_INVALID_URL
);

1085 
”rÜ
;

1091 
s_»q_h‰p_¡¬t
:

1092 
ch
) {

1094 
	`UPDATE_STATE
(
s_»q_h‰p_H
);

1099 
	`SET_ERRNO
(
HPE_INVALID_CONSTANT
);

1100 
”rÜ
;

1104 
s_»q_h‰p_H
:

1105 
	`STRICT_CHECK
(
ch
 != 'T');

1106 
	`UPDATE_STATE
(
s_»q_h‰p_HT
);

1109 
s_»q_h‰p_HT
:

1110 
	`STRICT_CHECK
(
ch
 != 'T');

1111 
	`UPDATE_STATE
(
s_»q_h‰p_HTT
);

1114 
s_»q_h‰p_HTT
:

1115 
	`STRICT_CHECK
(
ch
 != 'P');

1116 
	`UPDATE_STATE
(
s_»q_h‰p_HTTP
);

1119 
s_»q_h‰p_HTTP
:

1120 
	`STRICT_CHECK
(
ch
 != '/');

1121 
	`UPDATE_STATE
(
s_»q_h‰p_majÜ
);

1124 
s_»q_h‰p_majÜ
:

1125 ià(
	`UNLIKELY
(!
	`IS_NUM
(
ch
))) {

1126 
	`SET_ERRNO
(
HPE_INVALID_VERSION
);

1127 
”rÜ
;

1130 
·r£r
->
h‰p_majÜ
 = 
ch
 - '0';

1131 
	`UPDATE_STATE
(
s_»q_h‰p_dÙ
);

1134 
s_»q_h‰p_dÙ
:

1136 ià(
	`UNLIKELY
(
ch
 != '.')) {

1137 
	`SET_ERRNO
(
HPE_INVALID_VERSION
);

1138 
”rÜ
;

1141 
	`UPDATE_STATE
(
s_»q_h‰p_mšÜ
);

1145 
s_»q_h‰p_mšÜ
:

1146 ià(
	`UNLIKELY
(!
	`IS_NUM
(
ch
))) {

1147 
	`SET_ERRNO
(
HPE_INVALID_VERSION
);

1148 
”rÜ
;

1151 
·r£r
->
h‰p_mšÜ
 = 
ch
 - '0';

1152 
	`UPDATE_STATE
(
s_»q_h‰p_’d
);

1155 
s_»q_h‰p_’d
:

1157 ià(
ch
 =ğ
CR
) {

1158 
	`UPDATE_STATE
(
s_»q_lše_®mo¡_dÚe
);

1162 ià(
ch
 =ğ
LF
) {

1163 
	`UPDATE_STATE
(
s_h—d”_f›ld_¡¬t
);

1167 
	`SET_ERRNO
(
HPE_INVALID_VERSION
);

1168 
”rÜ
;

1173 
s_»q_lše_®mo¡_dÚe
:

1175 ià(
	`UNLIKELY
(
ch
 !ğ
LF
)) {

1176 
	`SET_ERRNO
(
HPE_LF_EXPECTED
);

1177 
”rÜ
;

1180 ià(
·r£r
->
h‰p_majÜ
 == 0) {

1181 
	`UPDATE_STATE
(
s_h—d”s_®mo¡_dÚe
);

1182 
	`REEXECUTE
();

1184 
	`UPDATE_STATE
(
s_h—d”_f›ld_¡¬t
);

1189 
s_h—d”_f›ld_¡¬t
:

1191 ià(
ch
 =ğ
CR
) {

1192 
	`UPDATE_STATE
(
s_h—d”s_®mo¡_dÚe
);

1196 ià(
ch
 =ğ
LF
) {

1199 
	`UPDATE_STATE
(
s_h—d”s_®mo¡_dÚe
);

1200 
	`REEXECUTE
();

1203 
c
 = 
	`TOKEN
(
ch
);

1205 ià(
	`UNLIKELY
(!
c
)) {

1206 
	`SET_ERRNO
(
HPE_INVALID_HEADER_TOKEN
);

1207 
”rÜ
;

1210 
	`MARK
(
h—d”_f›ld
);

1212 
·r£r
->
šdex
 = 0;

1213 
	`UPDATE_STATE
(
s_h—d”_f›ld
);

1215 
c
) {

1217 
·r£r
->
h—d”_¡©e
 = 
h_C
;

1221 
·r£r
->
h—d”_¡©e
 = 
h_m©chšg_´oxy_cÚÃùiÚ
;

1225 
·r£r
->
h—d”_¡©e
 = 
h_m©chšg_Œªsãr_’codšg
;

1229 
·r£r
->
h—d”_¡©e
 = 
h_m©chšg_upg¿de
;

1233 
·r£r
->
h—d”_¡©e
 = 
h_g’”®
;

1239 
s_h—d”_f›ld
:

1241 cÚ¡ * 
¡¬t
 = 
p
;

1242 ; 
p
 !ğ
d©a
 + 
Ën
;…++) {

1243 
ch
 = *
p
;

1244 
c
 = 
	`TOKEN
(
ch
);

1246 ià(!
c
)

1249 
·r£r
->
h—d”_¡©e
) {

1250 
h_g’”®
:

1253 
h_C
:

1254 
·r£r
->
šdex
++;

1255 
·r£r
->
h—d”_¡©e
 = (
c
 =ğ'o' ? 
h_CO
 : 
h_g’”®
);

1258 
h_CO
:

1259 
·r£r
->
šdex
++;

1260 
·r£r
->
h—d”_¡©e
 = (
c
 =ğ'n' ? 
h_CON
 : 
h_g’”®
);

1263 
h_CON
:

1264 
·r£r
->
šdex
++;

1265 
c
) {

1267 
·r£r
->
h—d”_¡©e
 = 
h_m©chšg_cÚÃùiÚ
;

1270 
·r£r
->
h—d”_¡©e
 = 
h_m©chšg_cÚ‹Á_Ëngth
;

1273 
·r£r
->
h—d”_¡©e
 = 
h_g’”®
;

1280 
h_m©chšg_cÚÃùiÚ
:

1281 
·r£r
->
šdex
++;

1282 ià(
·r£r
->
šdex
 > (
CONNECTION
)-1

1283 || 
c
 !ğ
CONNECTION
[
·r£r
->
šdex
]) {

1284 
·r£r
->
h—d”_¡©e
 = 
h_g’”®
;

1285 } ià(
·r£r
->
šdex
 =ğ(
CONNECTION
)-2) {

1286 
·r£r
->
h—d”_¡©e
 = 
h_cÚÃùiÚ
;

1292 
h_m©chšg_´oxy_cÚÃùiÚ
:

1293 
·r£r
->
šdex
++;

1294 ià(
·r£r
->
šdex
 > (
PROXY_CONNECTION
)-1

1295 || 
c
 !ğ
PROXY_CONNECTION
[
·r£r
->
šdex
]) {

1296 
·r£r
->
h—d”_¡©e
 = 
h_g’”®
;

1297 } ià(
·r£r
->
šdex
 =ğ(
PROXY_CONNECTION
)-2) {

1298 
·r£r
->
h—d”_¡©e
 = 
h_cÚÃùiÚ
;

1304 
h_m©chšg_cÚ‹Á_Ëngth
:

1305 
·r£r
->
šdex
++;

1306 ià(
·r£r
->
šdex
 > (
CONTENT_LENGTH
)-1

1307 || 
c
 !ğ
CONTENT_LENGTH
[
·r£r
->
šdex
]) {

1308 
·r£r
->
h—d”_¡©e
 = 
h_g’”®
;

1309 } ià(
·r£r
->
šdex
 =ğ(
CONTENT_LENGTH
)-2) {

1310 
·r£r
->
h—d”_¡©e
 = 
h_cÚ‹Á_Ëngth
;

1316 
h_m©chšg_Œªsãr_’codšg
:

1317 
·r£r
->
šdex
++;

1318 ià(
·r£r
->
šdex
 > (
TRANSFER_ENCODING
)-1

1319 || 
c
 !ğ
TRANSFER_ENCODING
[
·r£r
->
šdex
]) {

1320 
·r£r
->
h—d”_¡©e
 = 
h_g’”®
;

1321 } ià(
·r£r
->
šdex
 =ğ(
TRANSFER_ENCODING
)-2) {

1322 
·r£r
->
h—d”_¡©e
 = 
h_Œªsãr_’codšg
;

1328 
h_m©chšg_upg¿de
:

1329 
·r£r
->
šdex
++;

1330 ià(
·r£r
->
šdex
 > (
UPGRADE
)-1

1331 || 
c
 !ğ
UPGRADE
[
·r£r
->
šdex
]) {

1332 
·r£r
->
h—d”_¡©e
 = 
h_g’”®
;

1333 } ià(
·r£r
->
šdex
 =ğ(
UPGRADE
)-2) {

1334 
·r£r
->
h—d”_¡©e
 = 
h_upg¿de
;

1338 
h_cÚÃùiÚ
:

1339 
h_cÚ‹Á_Ëngth
:

1340 
h_Œªsãr_’codšg
:

1341 
h_upg¿de
:

1342 ià(
ch
 !ğ' 'è
·r£r
->
h—d”_¡©e
 = 
h_g’”®
;

1346 
	`as£¹
(0 && "Unknown header_state");

1351 
	`COUNT_HEADER_SIZE
(
p
 - 
¡¬t
);

1353 ià(
p
 =ğ
d©a
 + 
Ën
) {

1354 --
p
;

1358 ià(
ch
 == ':') {

1359 
	`UPDATE_STATE
(
s_h—d”_v®ue_disÿrd_ws
);

1360 
	`CALLBACK_DATA
(
h—d”_f›ld
);

1364 
	`SET_ERRNO
(
HPE_INVALID_HEADER_TOKEN
);

1365 
”rÜ
;

1368 
s_h—d”_v®ue_disÿrd_ws
:

1369 ià(
ch
 == ' ' || ch == '\t') ;

1371 ià(
ch
 =ğ
CR
) {

1372 
	`UPDATE_STATE
(
s_h—d”_v®ue_disÿrd_ws_®mo¡_dÚe
);

1376 ià(
ch
 =ğ
LF
) {

1377 
	`UPDATE_STATE
(
s_h—d”_v®ue_disÿrd_lws
);

1383 
s_h—d”_v®ue_¡¬t
:

1385 
	`MARK
(
h—d”_v®ue
);

1387 
	`UPDATE_STATE
(
s_h—d”_v®ue
);

1388 
·r£r
->
šdex
 = 0;

1390 
c
 = 
	`LOWER
(
ch
);

1392 
·r£r
->
h—d”_¡©e
) {

1393 
h_upg¿de
:

1394 
·r£r
->
æags
 |ğ
F_UPGRADE
;

1395 
·r£r
->
h—d”_¡©e
 = 
h_g’”®
;

1398 
h_Œªsãr_’codšg
:

1400 ià('c' =ğ
c
) {

1401 
·r£r
->
h—d”_¡©e
 = 
h_m©chšg_Œªsãr_’codšg_chunked
;

1403 
·r£r
->
h—d”_¡©e
 = 
h_g’”®
;

1407 
h_cÚ‹Á_Ëngth
:

1408 ià(
	`UNLIKELY
(!
	`IS_NUM
(
ch
))) {

1409 
	`SET_ERRNO
(
HPE_INVALID_CONTENT_LENGTH
);

1410 
”rÜ
;

1413 ià(
·r£r
->
æags
 & 
F_CONTENTLENGTH
) {

1414 
	`SET_ERRNO
(
HPE_UNEXPECTED_CONTENT_LENGTH
);

1415 
”rÜ
;

1418 
·r£r
->
æags
 |ğ
F_CONTENTLENGTH
;

1419 
·r£r
->
cÚ‹Á_Ëngth
 = 
ch
 - '0';

1422 
h_cÚÃùiÚ
:

1424 ià(
c
 == 'k') {

1425 
·r£r
->
h—d”_¡©e
 = 
h_m©chšg_cÚÃùiÚ_k“p_®ive
;

1427 } ià(
c
 == 'c') {

1428 
·r£r
->
h—d”_¡©e
 = 
h_m©chšg_cÚÃùiÚ_şo£
;

1429 } ià(
c
 == 'u') {

1430 
·r£r
->
h—d”_¡©e
 = 
h_m©chšg_cÚÃùiÚ_upg¿de
;

1432 
·r£r
->
h—d”_¡©e
 = 
h_m©chšg_cÚÃùiÚ_tok’
;

1437 
h_m©chšg_cÚÃùiÚ_tok’_¡¬t
:

1441 
·r£r
->
h—d”_¡©e
 = 
h_g’”®
;

1447 
s_h—d”_v®ue
:

1449 cÚ¡ * 
¡¬t
 = 
p
;

1450 
h—d”_¡©es
 
h_¡©e
 = (h—d”_¡©esè
·r£r
->
h—d”_¡©e
;

1451 ; 
p
 !ğ
d©a
 + 
Ën
;…++) {

1452 
ch
 = *
p
;

1453 ià(
ch
 =ğ
CR
) {

1454 
	`UPDATE_STATE
(
s_h—d”_®mo¡_dÚe
);

1455 
·r£r
->
h—d”_¡©e
 = 
h_¡©e
;

1456 
	`CALLBACK_DATA
(
h—d”_v®ue
);

1460 ià(
ch
 =ğ
LF
) {

1461 
	`UPDATE_STATE
(
s_h—d”_®mo¡_dÚe
);

1462 
	`COUNT_HEADER_SIZE
(
p
 - 
¡¬t
);

1463 
·r£r
->
h—d”_¡©e
 = 
h_¡©e
;

1464 
	`CALLBACK_DATA_NOADVANCE
(
h—d”_v®ue
);

1465 
	`REEXECUTE
();

1468 ià(!
Ën›Á
 && !
	`IS_HEADER_CHAR
(
ch
)) {

1469 
	`SET_ERRNO
(
HPE_INVALID_HEADER_TOKEN
);

1470 
”rÜ
;

1473 
c
 = 
	`LOWER
(
ch
);

1475 
h_¡©e
) {

1476 
h_g’”®
:

1478 cÚ¡ * 
p_ü
;

1479 cÚ¡ * 
p_lf
;

1480 
size_t
 
lim™
 = 
d©a
 + 
Ën
 - 
p
;

1482 
lim™
 = 
	`MIN
Öim™, 
HTTP_MAX_HEADER_SIZE
);

1484 
p_ü
 = (cÚ¡ *è
	`memchr
(
p
, 
CR
, 
lim™
);

1485 
p_lf
 = (cÚ¡ *è
	`memchr
(
p
, 
LF
, 
lim™
);

1486 ià(
p_ü
 !ğ
NULL
) {

1487 ià(
p_lf
 !ğ
NULL
 && 
p_ü
 >=…_lf)

1488 
p
 = 
p_lf
;

1490 
p
 = 
p_ü
;

1491 } ià(
	`UNLIKELY
(
p_lf
 !ğ
NULL
)) {

1492 
p
 = 
p_lf
;

1494 
p
 = 
d©a
 + 
Ën
;

1496 --
p
;

1501 
h_cÚÃùiÚ
:

1502 
h_Œªsãr_’codšg
:

1503 
	`as£¹
(0 && "Shouldn't get here.");

1506 
h_cÚ‹Á_Ëngth
:

1508 
ušt64_t
 
t
;

1510 ià(
ch
 == ' ') ;

1512 ià(
	`UNLIKELY
(!
	`IS_NUM
(
ch
))) {

1513 
	`SET_ERRNO
(
HPE_INVALID_CONTENT_LENGTH
);

1514 
·r£r
->
h—d”_¡©e
 = 
h_¡©e
;

1515 
”rÜ
;

1518 
t
 = 
·r£r
->
cÚ‹Á_Ëngth
;

1519 
t
 *= 10;

1520 
t
 +ğ
ch
 - '0';

1523 ià(
	`UNLIKELY
((
ULLONG_MAX
 - 10è/ 10 < 
·r£r
->
cÚ‹Á_Ëngth
)) {

1524 
	`SET_ERRNO
(
HPE_INVALID_CONTENT_LENGTH
);

1525 
·r£r
->
h—d”_¡©e
 = 
h_¡©e
;

1526 
”rÜ
;

1529 
·r£r
->
cÚ‹Á_Ëngth
 = 
t
;

1534 
h_m©chšg_Œªsãr_’codšg_chunked
:

1535 
·r£r
->
šdex
++;

1536 ià(
·r£r
->
šdex
 > (
CHUNKED
)-1

1537 || 
c
 !ğ
CHUNKED
[
·r£r
->
šdex
]) {

1538 
h_¡©e
 = 
h_g’”®
;

1539 } ià(
·r£r
->
šdex
 =ğ(
CHUNKED
)-2) {

1540 
h_¡©e
 = 
h_Œªsãr_’codšg_chunked
;

1544 
h_m©chšg_cÚÃùiÚ_tok’_¡¬t
:

1546 ià(
c
 == 'k') {

1547 
h_¡©e
 = 
h_m©chšg_cÚÃùiÚ_k“p_®ive
;

1549 } ià(
c
 == 'c') {

1550 
h_¡©e
 = 
h_m©chšg_cÚÃùiÚ_şo£
;

1551 } ià(
c
 == 'u') {

1552 
h_¡©e
 = 
h_m©chšg_cÚÃùiÚ_upg¿de
;

1553 } ià(
	`STRICT_TOKEN
(
c
)) {

1554 
h_¡©e
 = 
h_m©chšg_cÚÃùiÚ_tok’
;

1555 } ià(
c
 == ' ' || c == '\t') {

1558 
h_¡©e
 = 
h_g’”®
;

1563 
h_m©chšg_cÚÃùiÚ_k“p_®ive
:

1564 
·r£r
->
šdex
++;

1565 ià(
·r£r
->
šdex
 > (
KEEP_ALIVE
)-1

1566 || 
c
 !ğ
KEEP_ALIVE
[
·r£r
->
šdex
]) {

1567 
h_¡©e
 = 
h_m©chšg_cÚÃùiÚ_tok’
;

1568 } ià(
·r£r
->
šdex
 =ğ(
KEEP_ALIVE
)-2) {

1569 
h_¡©e
 = 
h_cÚÃùiÚ_k“p_®ive
;

1574 
h_m©chšg_cÚÃùiÚ_şo£
:

1575 
·r£r
->
šdex
++;

1576 ià(
·r£r
->
šdex
 > (
CLOSE
)-1 || 
c
 != CLOSE[parser->index]) {

1577 
h_¡©e
 = 
h_m©chšg_cÚÃùiÚ_tok’
;

1578 } ià(
·r£r
->
šdex
 =ğ(
CLOSE
)-2) {

1579 
h_¡©e
 = 
h_cÚÃùiÚ_şo£
;

1584 
h_m©chšg_cÚÃùiÚ_upg¿de
:

1585 
·r£r
->
šdex
++;

1586 ià(
·r£r
->
šdex
 > (
UPGRADE
) - 1 ||

1587 
c
 !ğ
UPGRADE
[
·r£r
->
šdex
]) {

1588 
h_¡©e
 = 
h_m©chšg_cÚÃùiÚ_tok’
;

1589 } ià(
·r£r
->
šdex
 =ğ(
UPGRADE
)-2) {

1590 
h_¡©e
 = 
h_cÚÃùiÚ_upg¿de
;

1594 
h_m©chšg_cÚÃùiÚ_tok’
:

1595 ià(
ch
 == ',') {

1596 
h_¡©e
 = 
h_m©chšg_cÚÃùiÚ_tok’_¡¬t
;

1597 
·r£r
->
šdex
 = 0;

1601 
h_Œªsãr_’codšg_chunked
:

1602 ià(
ch
 !ğ' 'è
h_¡©e
 = 
h_g’”®
;

1605 
h_cÚÃùiÚ_k“p_®ive
:

1606 
h_cÚÃùiÚ_şo£
:

1607 
h_cÚÃùiÚ_upg¿de
:

1608 ià(
ch
 == ',') {

1609 ià(
h_¡©e
 =ğ
h_cÚÃùiÚ_k“p_®ive
) {

1610 
·r£r
->
æags
 |ğ
F_CONNECTION_KEEP_ALIVE
;

1611 } ià(
h_¡©e
 =ğ
h_cÚÃùiÚ_şo£
) {

1612 
·r£r
->
æags
 |ğ
F_CONNECTION_CLOSE
;

1613 } ià(
h_¡©e
 =ğ
h_cÚÃùiÚ_upg¿de
) {

1614 
·r£r
->
æags
 |ğ
F_CONNECTION_UPGRADE
;

1616 
h_¡©e
 = 
h_m©chšg_cÚÃùiÚ_tok’_¡¬t
;

1617 
·r£r
->
šdex
 = 0;

1618 } ià(
ch
 != ' ') {

1619 
h_¡©e
 = 
h_m©chšg_cÚÃùiÚ_tok’
;

1624 
	`UPDATE_STATE
(
s_h—d”_v®ue
);

1625 
h_¡©e
 = 
h_g’”®
;

1629 
·r£r
->
h—d”_¡©e
 = 
h_¡©e
;

1631 
	`COUNT_HEADER_SIZE
(
p
 - 
¡¬t
);

1633 ià(
p
 =ğ
d©a
 + 
Ën
)

1634 --
p
;

1638 
s_h—d”_®mo¡_dÚe
:

1640 ià(
	`UNLIKELY
(
ch
 !ğ
LF
)) {

1641 
	`SET_ERRNO
(
HPE_LF_EXPECTED
);

1642 
”rÜ
;

1645 
	`UPDATE_STATE
(
s_h—d”_v®ue_lws
);

1649 
s_h—d”_v®ue_lws
:

1651 ià(
ch
 == ' ' || ch == '\t') {

1652 
	`UPDATE_STATE
(
s_h—d”_v®ue_¡¬t
);

1653 
	`REEXECUTE
();

1657 
·r£r
->
h—d”_¡©e
) {

1658 
h_cÚÃùiÚ_k“p_®ive
:

1659 
·r£r
->
æags
 |ğ
F_CONNECTION_KEEP_ALIVE
;

1661 
h_cÚÃùiÚ_şo£
:

1662 
·r£r
->
æags
 |ğ
F_CONNECTION_CLOSE
;

1664 
h_Œªsãr_’codšg_chunked
:

1665 
·r£r
->
æags
 |ğ
F_CHUNKED
;

1667 
h_cÚÃùiÚ_upg¿de
:

1668 
·r£r
->
æags
 |ğ
F_CONNECTION_UPGRADE
;

1674 
	`UPDATE_STATE
(
s_h—d”_f›ld_¡¬t
);

1675 
	`REEXECUTE
();

1678 
s_h—d”_v®ue_disÿrd_ws_®mo¡_dÚe
:

1680 
	`STRICT_CHECK
(
ch
 !ğ
LF
);

1681 
	`UPDATE_STATE
(
s_h—d”_v®ue_disÿrd_lws
);

1685 
s_h—d”_v®ue_disÿrd_lws
:

1687 ià(
ch
 == ' ' || ch == '\t') {

1688 
	`UPDATE_STATE
(
s_h—d”_v®ue_disÿrd_ws
);

1691 
·r£r
->
h—d”_¡©e
) {

1692 
h_cÚÃùiÚ_k“p_®ive
:

1693 
·r£r
->
æags
 |ğ
F_CONNECTION_KEEP_ALIVE
;

1695 
h_cÚÃùiÚ_şo£
:

1696 
·r£r
->
æags
 |ğ
F_CONNECTION_CLOSE
;

1698 
h_cÚÃùiÚ_upg¿de
:

1699 
·r£r
->
æags
 |ğ
F_CONNECTION_UPGRADE
;

1701 
h_Œªsãr_’codšg_chunked
:

1702 
·r£r
->
æags
 |ğ
F_CHUNKED
;

1709 
	`MARK
(
h—d”_v®ue
);

1710 
	`UPDATE_STATE
(
s_h—d”_f›ld_¡¬t
);

1711 
	`CALLBACK_DATA_NOADVANCE
(
h—d”_v®ue
);

1712 
	`REEXECUTE
();

1716 
s_h—d”s_®mo¡_dÚe
:

1718 
	`STRICT_CHECK
(
ch
 !ğ
LF
);

1720 ià(
·r£r
->
æags
 & 
F_TRAILING
) {

1722 
	`UPDATE_STATE
(
s_mes§ge_dÚe
);

1723 
	`CALLBACK_NOTIFY_NOADVANCE
(
chunk_com¶‘e
);

1724 
	`REEXECUTE
();

1729 ià((
·r£r
->
æags
 & 
F_CHUNKED
) &&

1730 (
·r£r
->
æags
 & 
F_CONTENTLENGTH
)) {

1731 
	`SET_ERRNO
(
HPE_UNEXPECTED_CONTENT_LENGTH
);

1732 
”rÜ
;

1735 
	`UPDATE_STATE
(
s_h—d”s_dÚe
);

1738 ià((
·r£r
->
æags
 & 
F_UPGRADE
) &&

1739 (
·r£r
->
æags
 & 
F_CONNECTION_UPGRADE
)) {

1744 
·r£r
->
upg¿de
 =

1745 (
·r£r
->
ty³
 =ğ
HTTP_REQUEST
 ||…¬£r->
¡©us_code
 == 101);

1747 
·r£r
->
upg¿de
 = (·r£r->
m‘hod
 =ğ
HTTP_CONNECT
);

1759 ià(
£‰šgs
->
Ú_h—d”s_com¶‘e
) {

1760 
£‰šgs
->
	`Ú_h—d”s_com¶‘e
(
·r£r
)) {

1765 
·r£r
->
upg¿de
 = 1;

1769 
·r£r
->
æags
 |ğ
F_SKIPBODY
;

1773 
	`SET_ERRNO
(
HPE_CB_h—d”s_com¶‘e
);

1774 
	`RETURN
(
p
 - 
d©a
);

1778 ià(
	`HTTP_PARSER_ERRNO
(
·r£r
è!ğ
HPE_OK
) {

1779 
	`RETURN
(
p
 - 
d©a
);

1782 
	`REEXECUTE
();

1785 
s_h—d”s_dÚe
:

1787 
hasBody
;

1788 
	`STRICT_CHECK
(
ch
 !ğ
LF
);

1790 
·r£r
->
Ä—d
 = 0;

1792 
hasBody
 = 
·r£r
->
æags
 & 
F_CHUNKED
 ||

1793 (
·r£r
->
cÚ‹Á_Ëngth
 > 0 &&…¬£r->cÚ‹Á_Ëngth !ğ
ULLONG_MAX
);

1794 ià(
·r£r
->
upg¿de
 && (·r£r->
m‘hod
 =ğ
HTTP_CONNECT
 ||

1795 (
·r£r
->
æags
 & 
F_SKIPBODY
è|| !
hasBody
)) {

1797 
	`UPDATE_STATE
(
	`NEW_MESSAGE
());

1798 
	`CALLBACK_NOTIFY
(
mes§ge_com¶‘e
);

1799 
	`RETURN
((
p
 - 
d©a
) + 1);

1802 ià(
·r£r
->
æags
 & 
F_SKIPBODY
) {

1803 
	`UPDATE_STATE
(
	`NEW_MESSAGE
());

1804 
	`CALLBACK_NOTIFY
(
mes§ge_com¶‘e
);

1805 } ià(
·r£r
->
æags
 & 
F_CHUNKED
) {

1807 
	`UPDATE_STATE
(
s_chunk_size_¡¬t
);

1809 ià(
·r£r
->
cÚ‹Á_Ëngth
 == 0) {

1811 
	`UPDATE_STATE
(
	`NEW_MESSAGE
());

1812 
	`CALLBACK_NOTIFY
(
mes§ge_com¶‘e
);

1813 } ià(
·r£r
->
cÚ‹Á_Ëngth
 !ğ
ULLONG_MAX
) {

1815 
	`UPDATE_STATE
(
s_body_id’t™y
);

1817 ià(!
	`h‰p_mes§ge_Ãeds_eof
(
·r£r
)) {

1819 
	`UPDATE_STATE
(
	`NEW_MESSAGE
());

1820 
	`CALLBACK_NOTIFY
(
mes§ge_com¶‘e
);

1823 
	`UPDATE_STATE
(
s_body_id’t™y_eof
);

1831 
s_body_id’t™y
:

1833 
ušt64_t
 
to_»ad
 = 
	`MIN
(
·r£r
->
cÚ‹Á_Ëngth
,

1834 (
ušt64_t
è((
d©a
 + 
Ën
è- 
p
));

1836 
	`as£¹
(
·r£r
->
cÚ‹Á_Ëngth
 != 0

1837 && 
·r£r
->
cÚ‹Á_Ëngth
 !ğ
ULLONG_MAX
);

1844 
	`MARK
(
body
);

1845 
·r£r
->
cÚ‹Á_Ëngth
 -ğ
to_»ad
;

1846 
p
 +ğ
to_»ad
 - 1;

1848 ià(
·r£r
->
cÚ‹Á_Ëngth
 == 0) {

1849 
	`UPDATE_STATE
(
s_mes§ge_dÚe
);

1860 
	`CALLBACK_DATA_
(
body
, 
p
 - 
body_m¬k
 + 1,… - 
d©a
);

1861 
	`REEXECUTE
();

1868 
s_body_id’t™y_eof
:

1869 
	`MARK
(
body
);

1870 
p
 = 
d©a
 + 
Ën
 - 1;

1874 
s_mes§ge_dÚe
:

1875 
	`UPDATE_STATE
(
	`NEW_MESSAGE
());

1876 
	`CALLBACK_NOTIFY
(
mes§ge_com¶‘e
);

1877 ià(
·r£r
->
upg¿de
) {

1879 
	`RETURN
((
p
 - 
d©a
) + 1);

1883 
s_chunk_size_¡¬t
:

1885 
	`as£¹
(
·r£r
->
Ä—d
 == 1);

1886 
	`as£¹
(
·r£r
->
æags
 & 
F_CHUNKED
);

1888 
unhex_v®
 = 
unhex
[()
ch
];

1889 ià(
	`UNLIKELY
(
unhex_v®
 == -1)) {

1890 
	`SET_ERRNO
(
HPE_INVALID_CHUNK_SIZE
);

1891 
”rÜ
;

1894 
·r£r
->
cÚ‹Á_Ëngth
 = 
unhex_v®
;

1895 
	`UPDATE_STATE
(
s_chunk_size
);

1899 
s_chunk_size
:

1901 
ušt64_t
 
t
;

1903 
	`as£¹
(
·r£r
->
æags
 & 
F_CHUNKED
);

1905 ià(
ch
 =ğ
CR
) {

1906 
	`UPDATE_STATE
(
s_chunk_size_®mo¡_dÚe
);

1910 
unhex_v®
 = 
unhex
[()
ch
];

1912 ià(
unhex_v®
 == -1) {

1913 ià(
ch
 == ';' || ch == ' ') {

1914 
	`UPDATE_STATE
(
s_chunk_·¿m‘”s
);

1918 
	`SET_ERRNO
(
HPE_INVALID_CHUNK_SIZE
);

1919 
”rÜ
;

1922 
t
 = 
·r£r
->
cÚ‹Á_Ëngth
;

1923 
t
 *= 16;

1924 
t
 +ğ
unhex_v®
;

1927 ià(
	`UNLIKELY
((
ULLONG_MAX
 - 16è/ 16 < 
·r£r
->
cÚ‹Á_Ëngth
)) {

1928 
	`SET_ERRNO
(
HPE_INVALID_CONTENT_LENGTH
);

1929 
”rÜ
;

1932 
·r£r
->
cÚ‹Á_Ëngth
 = 
t
;

1936 
s_chunk_·¿m‘”s
:

1938 
	`as£¹
(
·r£r
->
æags
 & 
F_CHUNKED
);

1940 ià(
ch
 =ğ
CR
) {

1941 
	`UPDATE_STATE
(
s_chunk_size_®mo¡_dÚe
);

1947 
s_chunk_size_®mo¡_dÚe
:

1949 
	`as£¹
(
·r£r
->
æags
 & 
F_CHUNKED
);

1950 
	`STRICT_CHECK
(
ch
 !ğ
LF
);

1952 
·r£r
->
Ä—d
 = 0;

1954 ià(
·r£r
->
cÚ‹Á_Ëngth
 == 0) {

1955 
·r£r
->
æags
 |ğ
F_TRAILING
;

1956 
	`UPDATE_STATE
(
s_h—d”_f›ld_¡¬t
);

1958 
	`UPDATE_STATE
(
s_chunk_d©a
);

1960 
	`CALLBACK_NOTIFY
(
chunk_h—d”
);

1964 
s_chunk_d©a
:

1966 
ušt64_t
 
to_»ad
 = 
	`MIN
(
·r£r
->
cÚ‹Á_Ëngth
,

1967 (
ušt64_t
è((
d©a
 + 
Ën
è- 
p
));

1969 
	`as£¹
(
·r£r
->
æags
 & 
F_CHUNKED
);

1970 
	`as£¹
(
·r£r
->
cÚ‹Á_Ëngth
 != 0

1971 && 
·r£r
->
cÚ‹Á_Ëngth
 !ğ
ULLONG_MAX
);

1976 
	`MARK
(
body
);

1977 
·r£r
->
cÚ‹Á_Ëngth
 -ğ
to_»ad
;

1978 
p
 +ğ
to_»ad
 - 1;

1980 ià(
·r£r
->
cÚ‹Á_Ëngth
 == 0) {

1981 
	`UPDATE_STATE
(
s_chunk_d©a_®mo¡_dÚe
);

1987 
s_chunk_d©a_®mo¡_dÚe
:

1988 
	`as£¹
(
·r£r
->
æags
 & 
F_CHUNKED
);

1989 
	`as£¹
(
·r£r
->
cÚ‹Á_Ëngth
 == 0);

1990 
	`STRICT_CHECK
(
ch
 !ğ
CR
);

1991 
	`UPDATE_STATE
(
s_chunk_d©a_dÚe
);

1992 
	`CALLBACK_DATA
(
body
);

1995 
s_chunk_d©a_dÚe
:

1996 
	`as£¹
(
·r£r
->
æags
 & 
F_CHUNKED
);

1997 
	`STRICT_CHECK
(
ch
 !ğ
LF
);

1998 
·r£r
->
Ä—d
 = 0;

1999 
	`UPDATE_STATE
(
s_chunk_size_¡¬t
);

2000 
	`CALLBACK_NOTIFY
(
chunk_com¶‘e
);

2004 
	`as£¹
(0 && "unhandled state");

2005 
	`SET_ERRNO
(
HPE_INVALID_INTERNAL_STATE
);

2006 
”rÜ
;

2020 
	`as£¹
(((
h—d”_f›ld_m¬k
 ? 1 : 0) +

2021 (
h—d”_v®ue_m¬k
 ? 1 : 0) +

2022 (
u¾_m¬k
 ? 1 : 0) +

2023 (
body_m¬k
 ? 1 : 0) +

2024 (
¡©us_m¬k
 ? 1 : 0)) <= 1);

2026 
	`CALLBACK_DATA_NOADVANCE
(
h—d”_f›ld
);

2027 
	`CALLBACK_DATA_NOADVANCE
(
h—d”_v®ue
);

2028 
	`CALLBACK_DATA_NOADVANCE
(
u¾
);

2029 
	`CALLBACK_DATA_NOADVANCE
(
body
);

2030 
	`CALLBACK_DATA_NOADVANCE
(
¡©us
);

2032 
	`RETURN
(
Ën
);

2034 
”rÜ
:

2035 ià(
	`HTTP_PARSER_ERRNO
(
·r£r
è=ğ
HPE_OK
) {

2036 
	`SET_ERRNO
(
HPE_UNKNOWN
);

2039 
	`RETURN
(
p
 - 
d©a
);

2040 
	}
}

2045 
	$h‰p_mes§ge_Ãeds_eof
 (cÚ¡ 
h‰p_·r£r
 *
·r£r
)

2047 ià(
·r£r
->
ty³
 =ğ
HTTP_REQUEST
) {

2052 ià(
·r£r
->
¡©us_code
 / 100 == 1 ||

2053 
·r£r
->
¡©us_code
 == 204 ||

2054 
·r£r
->
¡©us_code
 == 304 ||

2055 
·r£r
->
æags
 & 
F_SKIPBODY
) {

2059 ià((
·r£r
->
æags
 & 
F_CHUNKED
è||…¬£r->
cÚ‹Á_Ëngth
 !ğ
ULLONG_MAX
) {

2064 
	}
}

2068 
	$h‰p_should_k“p_®ive
 (cÚ¡ 
h‰p_·r£r
 *
·r£r
)

2070 ià(
·r£r
->
h‰p_majÜ
 > 0 &&…¬£r->
h‰p_mšÜ
 > 0) {

2072 ià(
·r£r
->
æags
 & 
F_CONNECTION_CLOSE
) {

2077 ià(!(
·r£r
->
æags
 & 
F_CONNECTION_KEEP_ALIVE
)) {

2082  !
	`h‰p_mes§ge_Ãeds_eof
(
·r£r
);

2083 
	}
}

2087 
	$h‰p_m‘hod_¡r
 (
h‰p_m‘hod
 
m
)

2089  
	`ELEM_AT
(
m‘hod_¡ršgs
, 
m
, "<unknown>");

2090 
	}
}

2094 
	$h‰p_·r£r_š™
 (
h‰p_·r£r
 *
·r£r
, 
h‰p_·r£r_ty³
 
t
)

2096 *
d©a
 = 
·r£r
->data;

2097 
	`mem£t
(
·r£r
, 0, (*parser));

2098 
·r£r
->
d©a
 = data;

2099 
·r£r
->
ty³
 = 
t
;

2100 
·r£r
->
¡©e
 = (
t
 =ğ
HTTP_REQUEST
 ? 
s_¡¬t_»q
 : (ˆ=ğ
HTTP_RESPONSE
 ? 
s_¡¬t_»s
 : 
s_¡¬t_»q_Ü_»s
));

2101 
·r£r
->
h‰p_”ºo
 = 
HPE_OK
;

2102 
	}
}

2105 
	$h‰p_·r£r_£‰šgs_š™
(
h‰p_·r£r_£‰šgs
 *
£‰šgs
)

2107 
	`mem£t
(
£‰šgs
, 0, (*settings));

2108 
	}
}

2111 
	$h‰p_”ºo_Çme
(
h‰p_”ºo
 
”r
) {

2112 
	`as£¹
(((
size_t
è
”r
è< 
	`ARRAY_SIZE
(
h‰p_¡»¼Ü_b
));

2113  
h‰p_¡»¼Ü_b
[
”r
].
Çme
;

2114 
	}
}

2117 
	$h‰p_”ºo_desütiÚ
(
h‰p_”ºo
 
”r
) {

2118 
	`as£¹
(((
size_t
è
”r
è< 
	`ARRAY_SIZE
(
h‰p_¡»¼Ü_b
));

2119  
h‰p_¡»¼Ü_b
[
”r
].
desütiÚ
;

2120 
	}
}

2122 
h‰p_ho¡_¡©e


2123 
	$h‰p_·r£_ho¡_ch¬
(
h‰p_ho¡_¡©e
 
s
, cÚ¡ 
ch
) {

2124 
s
) {

2125 
s_h‰p_u£ršfo
:

2126 
s_h‰p_u£ršfo_¡¬t
:

2127 ià(
ch
 == '@') {

2128  
s_h‰p_ho¡_¡¬t
;

2131 ià(
	`IS_USERINFO_CHAR
(
ch
)) {

2132  
s_h‰p_u£ršfo
;

2136 
s_h‰p_ho¡_¡¬t
:

2137 ià(
ch
 == '[') {

2138  
s_h‰p_ho¡_v6_¡¬t
;

2141 ià(
	`IS_HOST_CHAR
(
ch
)) {

2142  
s_h‰p_ho¡
;

2147 
s_h‰p_ho¡
:

2148 ià(
	`IS_HOST_CHAR
(
ch
)) {

2149  
s_h‰p_ho¡
;

2153 
s_h‰p_ho¡_v6_’d
:

2154 ià(
ch
 == ':') {

2155  
s_h‰p_ho¡_pÜt_¡¬t
;

2160 
s_h‰p_ho¡_v6
:

2161 ià(
ch
 == ']') {

2162  
s_h‰p_ho¡_v6_’d
;

2166 
s_h‰p_ho¡_v6_¡¬t
:

2167 ià(
	`IS_HEX
(
ch
) || ch == ':' || ch == '.') {

2168  
s_h‰p_ho¡_v6
;

2171 ià(
s
 =ğ
s_h‰p_ho¡_v6
 && 
ch
 == '%') {

2172  
s_h‰p_ho¡_v6_zÚe_¡¬t
;

2176 
s_h‰p_ho¡_v6_zÚe
:

2177 ià(
ch
 == ']') {

2178  
s_h‰p_ho¡_v6_’d
;

2182 
s_h‰p_ho¡_v6_zÚe_¡¬t
:

2184 ià(
	`IS_ALPHANUM
(
ch
) || ch == '%' || ch == '.' || ch == '-' || ch == '_' ||

2185 
ch
 == '~') {

2186  
s_h‰p_ho¡_v6_zÚe
;

2190 
s_h‰p_ho¡_pÜt
:

2191 
s_h‰p_ho¡_pÜt_¡¬t
:

2192 ià(
	`IS_NUM
(
ch
)) {

2193  
s_h‰p_ho¡_pÜt
;

2201  
s_h‰p_ho¡_d—d
;

2202 
	}
}

2205 
	$h‰p_·r£_ho¡
(cÚ¡ * 
buf
, 
h‰p_·r£r_u¾
 *
u
, 
found_©
) {

2206 
h‰p_ho¡_¡©e
 
s
;

2208 cÚ¡ *
p
;

2209 
size_t
 
buæ’
 = 
u
->
f›ld_d©a
[
UF_HOST
].
off
 + u->f›ld_d©a[UF_HOST].
Ën
;

2211 
	`as£¹
(
u
->
f›ld_£t
 & (1 << 
UF_HOST
));

2213 
u
->
f›ld_d©a
[
UF_HOST
].
Ën
 = 0;

2215 
s
 = 
found_©
 ? 
s_h‰p_u£ršfo_¡¬t
 : 
s_h‰p_ho¡_¡¬t
;

2217 
p
 = 
buf
 + 
u
->
f›ld_d©a
[
UF_HOST
].
off
;… < buà+ 
buæ’
;…++) {

2218 
h‰p_ho¡_¡©e
 
Ãw_s
 = 
	`h‰p_·r£_ho¡_ch¬
(
s
, *
p
);

2220 ià(
Ãw_s
 =ğ
s_h‰p_ho¡_d—d
) {

2224 
Ãw_s
) {

2225 
s_h‰p_ho¡
:

2226 ià(
s
 !ğ
s_h‰p_ho¡
) {

2227 
u
->
f›ld_d©a
[
UF_HOST
].
off
 = 
p
 - 
buf
;

2229 
u
->
f›ld_d©a
[
UF_HOST
].
Ën
++;

2232 
s_h‰p_ho¡_v6
:

2233 ià(
s
 !ğ
s_h‰p_ho¡_v6
) {

2234 
u
->
f›ld_d©a
[
UF_HOST
].
off
 = 
p
 - 
buf
;

2236 
u
->
f›ld_d©a
[
UF_HOST
].
Ën
++;

2239 
s_h‰p_ho¡_v6_zÚe_¡¬t
:

2240 
s_h‰p_ho¡_v6_zÚe
:

2241 
u
->
f›ld_d©a
[
UF_HOST
].
Ën
++;

2244 
s_h‰p_ho¡_pÜt
:

2245 ià(
s
 !ğ
s_h‰p_ho¡_pÜt
) {

2246 
u
->
f›ld_d©a
[
UF_PORT
].
off
 = 
p
 - 
buf
;

2247 
u
->
f›ld_d©a
[
UF_PORT
].
Ën
 = 0;

2248 
u
->
f›ld_£t
 |ğ(1 << 
UF_PORT
);

2250 
u
->
f›ld_d©a
[
UF_PORT
].
Ën
++;

2253 
s_h‰p_u£ršfo
:

2254 ià(
s
 !ğ
s_h‰p_u£ršfo
) {

2255 
u
->
f›ld_d©a
[
UF_USERINFO
].
off
 = 
p
 - 
buf
 ;

2256 
u
->
f›ld_d©a
[
UF_USERINFO
].
Ën
 = 0;

2257 
u
->
f›ld_£t
 |ğ(1 << 
UF_USERINFO
);

2259 
u
->
f›ld_d©a
[
UF_USERINFO
].
Ën
++;

2265 
s
 = 
Ãw_s
;

2269 
s
) {

2270 
s_h‰p_ho¡_¡¬t
:

2271 
s_h‰p_ho¡_v6_¡¬t
:

2272 
s_h‰p_ho¡_v6
:

2273 
s_h‰p_ho¡_v6_zÚe_¡¬t
:

2274 
s_h‰p_ho¡_v6_zÚe
:

2275 
s_h‰p_ho¡_pÜt_¡¬t
:

2276 
s_h‰p_u£ršfo
:

2277 
s_h‰p_u£ršfo_¡¬t
:

2284 
	}
}

2287 
	$h‰p_·r£r_u¾_š™
(
h‰p_·r£r_u¾
 *
u
) {

2288 
	`mem£t
(
u
, 0, (*u));

2289 
	}
}

2292 
	$h‰p_·r£r_·r£_u¾
(cÚ¡ *
buf
, 
size_t
 
buæ’
, 
is_cÚÃù
,

2293 
h‰p_·r£r_u¾
 *
u
)

2295 
¡©e
 
s
;

2296 cÚ¡ *
p
;

2297 
h‰p_·r£r_u¾_f›lds
 
uf
, 
Şd_uf
;

2298 
found_©
 = 0;

2300 
u
->
pÜt
 = u->
f›ld_£t
 = 0;

2301 
s
 = 
is_cÚÃù
 ? 
s_»q_£rv”_¡¬t
 : 
s_»q_¥aûs_befÜe_u¾
;

2302 
Şd_uf
 = 
UF_MAX
;

2304 
p
 = 
buf
;… < buà+ 
buæ’
;…++) {

2305 
s
 = 
	`·r£_u¾_ch¬
(s, *
p
);

2308 
s
) {

2309 
s_d—d
:

2313 
s_»q_schema_¦ash
:

2314 
s_»q_schema_¦ash_¦ash
:

2315 
s_»q_£rv”_¡¬t
:

2316 
s_»q_qu”y_¡ršg_¡¬t
:

2317 
s_»q_äagm’t_¡¬t
:

2320 
s_»q_schema
:

2321 
uf
 = 
UF_SCHEMA
;

2324 
s_»q_£rv”_w™h_©
:

2325 
found_©
 = 1;

2328 
s_»q_£rv”
:

2329 
uf
 = 
UF_HOST
;

2332 
s_»q_·th
:

2333 
uf
 = 
UF_PATH
;

2336 
s_»q_qu”y_¡ršg
:

2337 
uf
 = 
UF_QUERY
;

2340 
s_»q_äagm’t
:

2341 
uf
 = 
UF_FRAGMENT
;

2345 
	`as£¹
(!"Unexpected state");

2350 ià(
uf
 =ğ
Şd_uf
) {

2351 
u
->
f›ld_d©a
[
uf
].
Ën
++;

2355 
u
->
f›ld_d©a
[
uf
].
off
 = 
p
 - 
buf
;

2356 
u
->
f›ld_d©a
[
uf
].
Ën
 = 1;

2358 
u
->
f›ld_£t
 |ğ(1 << 
uf
);

2359 
Şd_uf
 = 
uf
;

2364 ià((
u
->
f›ld_£t
 & (1 << 
UF_SCHEMA
)) &&

2365 (
u
->
f›ld_£t
 & (1 << 
UF_HOST
)) == 0) {

2369 ià(
u
->
f›ld_£t
 & (1 << 
UF_HOST
)) {

2370 ià(
	`h‰p_·r£_ho¡
(
buf
, 
u
, 
found_©
) != 0) {

2376 ià(
is_cÚÃù
 && 
u
->
f›ld_£t
 !ğ((1 << 
UF_HOST
)|(1 << 
UF_PORT
))) {

2380 ià(
u
->
f›ld_£t
 & (1 << 
UF_PORT
)) {

2382 
v
 = 
	`¡¹oul
(
buf
 + 
u
->
f›ld_d©a
[
UF_PORT
].
off
, 
NULL
, 10);

2385 ià(
v
 > 0xffff) {

2389 
u
->
pÜt
 = (
ušt16_t
è
v
;

2393 
	}
}

2396 
	$h‰p_·r£r_·u£
(
h‰p_·r£r
 *
·r£r
, 
·u£d
) {

2401 ià(
	`HTTP_PARSER_ERRNO
(
·r£r
è=ğ
HPE_OK
 ||

2402 
	`HTTP_PARSER_ERRNO
(
·r£r
è=ğ
HPE_PAUSED
) {

2403 
	`SET_ERRNO
((
·u£d
è? 
HPE_PAUSED
 : 
HPE_OK
);

2405 
	`as£¹
(0 && "Attemptingo…ause…arser inƒrror state");

2407 
	}
}

2410 
	$h‰p_body_is_fš®
(cÚ¡ 
h‰p_·r£r
 *
·r£r
) {

2411  
·r£r
->
¡©e
 =ğ
s_mes§ge_dÚe
;

2412 
	}
}

2415 
	$h‰p_·r£r_v”siÚ
() {

2416  
HTTP_PARSER_VERSION_MAJOR
 * 0x10000 |

2417 
HTTP_PARSER_VERSION_MINOR
 * 0x00100 |

2418 
HTTP_PARSER_VERSION_PATCH
 * 0x00001;

2419 
	}
}

	@third-party/http-parser/http_parser.h

21 #iâdeà
h‰p_·r£r_h


22 
	#h‰p_·r£r_h


	)

23 #ifdeà
__ılu¥lus


28 
	#HTTP_PARSER_VERSION_MAJOR
 2

	)

29 
	#HTTP_PARSER_VERSION_MINOR
 7

	)

30 
	#HTTP_PARSER_VERSION_PATCH
 1

	)

32 
	~<¡ddef.h
>

33 #ià
defšed
(
_WIN32
è&& !defšed(
__MINGW32__
) && \

34 (!
defšed
(
_MSC_VER
è|| _MSC_VER<1600è&& !defšed(
__WINE__
)

35 
	~<Ba£Tsd.h
>

36 
__št8
 
	tšt8_t
;

37 
	t__št8
 
	tušt8_t
;

38 
__št16
 
	tšt16_t
;

39 
	t__št16
 
	tušt16_t
;

40 
__št32
 
	tšt32_t
;

41 
	t__št32
 
	tušt32_t
;

42 
__št64
 
	tšt64_t
;

43 
	t__št64
 
	tušt64_t
;

45 
	~<¡dšt.h
>

51 #iâdeà
HTTP_PARSER_STRICT


52 
	#HTTP_PARSER_STRICT
 1

	)

62 #iâdeà
HTTP_MAX_HEADER_SIZE


63 
	#HTTP_MAX_HEADER_SIZE
 (80*1024)

	)

66 
h‰p_·r£r
 
	th‰p_·r£r
;

67 
h‰p_·r£r_£‰šgs
 
	th‰p_·r£r_£‰šgs
;

88 (*
h‰p_d©a_cb
è(
	th‰p_·r£r
*, cÚ¡ *
	t©
, 
	tsize_t
 
	tËngth
);

89 (*
h‰p_cb
è(
	th‰p_·r£r
*);

93 
	#HTTP_STATUS_MAP
(
XX
) \

94 
	`XX
(100, 
CONTINUE
, 
CÚtšue
) \

95 
	`XX
(101, 
SWITCHING_PROTOCOLS
, 
Sw™chšg
 
PrÙocŞs
) \

96 
	`XX
(102, 
PROCESSING
, 
Proûssšg
) \

97 
	`XX
(200, 
OK
, OK) \

98 
	`XX
(201, 
CREATED
, 
C»©ed
) \

99 
	`XX
(202, 
ACCEPTED
, 
Acû±ed
) \

100 
	`XX
(203, 
NON_AUTHORITATIVE_INFORMATION
, 
NÚ
-
AuthÜ™©ive
 
InfÜm©iÚ
) \

101 
	`XX
(204, 
NO_CONTENT
, 
No
 
CÚ‹Á
) \

102 
	`XX
(205, 
RESET_CONTENT
, 
Re£t
 
CÚ‹Á
) \

103 
	`XX
(206, 
PARTIAL_CONTENT
, 
P¬tŸl
 
CÚ‹Á
) \

104 
	`XX
(207, 
MULTI_STATUS
, 
MuÉi
-
Stus
) \

105 
	`XX
(208, 
ALREADY_REPORTED
, 
AÌ—dy
 
R•Ü‹d
) \

106 
	`XX
(226, 
IM_USED
, 
IM
 
U£d
) \

107 
	`XX
(300, 
MULTIPLE_CHOICES
, 
MuÉË
 
Choiûs
) \

108 
	`XX
(301, 
MOVED_PERMANENTLY
, 
Moved
 
P”mª’y
) \

109 
	`XX
(302, 
FOUND
, 
Found
) \

110 
	`XX
(303, 
SEE_OTHER
, 
S“
 
Oth”
) \

111 
	`XX
(304, 
NOT_MODIFIED
, 
NÙ
 
Modif›d
) \

112 
	`XX
(305, 
USE_PROXY
, 
U£
 
Proxy
) \

113 
	`XX
(307, 
TEMPORARY_REDIRECT
, 
TempÜ¬y
 
Redœeù
) \

114 
	`XX
(308, 
PERMANENT_REDIRECT
, 
P”mª’t
 
Redœeù
) \

115 
	`XX
(400, 
BAD_REQUEST
, 
Bad
 
Reque¡
) \

116 
	`XX
(401, 
UNAUTHORIZED
, 
UÇuthÜized
) \

117 
	`XX
(402, 
PAYMENT_REQUIRED
, 
Paym’t
 
Requœed
) \

118 
	`XX
(403, 
FORBIDDEN
, 
FÜbidd’
) \

119 
	`XX
(404, 
NOT_FOUND
, 
NÙ
 
Found
) \

120 
	`XX
(405, 
METHOD_NOT_ALLOWED
, 
M‘hod
 
NÙ
 
AÎowed
) \

121 
	`XX
(406, 
NOT_ACCEPTABLE
, 
NÙ
 
Acû±abË
) \

122 
	`XX
(407, 
PROXY_AUTHENTICATION_REQUIRED
, 
Proxy
 
Auth’tiÿtiÚ
 
Requœed
) \

123 
	`XX
(408, 
REQUEST_TIMEOUT
, 
Reque¡
 
Timeout
) \

124 
	`XX
(409, 
CONFLICT
, 
CÚæiù
) \

125 
	`XX
(410, 
GONE
, 
GÚe
) \

126 
	`XX
(411, 
LENGTH_REQUIRED
, 
L’gth
 
Requœed
) \

127 
	`XX
(412, 
PRECONDITION_FAILED
, 
P»cÚd™iÚ
 
Faed
) \

128 
	`XX
(413, 
PAYLOAD_TOO_LARGE
, 
Paylßd
 
Too
 
L¬ge
) \

129 
	`XX
(414, 
URI_TOO_LONG
, 
URI
 
Too
 
LÚg
) \

130 
	`XX
(415, 
UNSUPPORTED_MEDIA_TYPE
, 
UnsuµÜ‹d
 
MedŸ
 
Ty³
) \

131 
	`XX
(416, 
RANGE_NOT_SATISFIABLE
, 
Rªge
 
NÙ
 
S©isfŸbË
) \

132 
	`XX
(417, 
EXPECTATION_FAILED
, 
Ex³ù©iÚ
 
Faed
) \

133 
	`XX
(421, 
MISDIRECTED_REQUEST
, 
Misdœeùed
 
Reque¡
) \

134 
	`XX
(422, 
UNPROCESSABLE_ENTITY
, 
UÅroûs§bË
 
EÁ™y
) \

135 
	`XX
(423, 
LOCKED
, 
Locked
) \

136 
	`XX
(424, 
FAILED_DEPENDENCY
, 
Faed
 
D•’d’cy
) \

137 
	`XX
(426, 
UPGRADE_REQUIRED
, 
Upg¿de
 
Requœed
) \

138 
	`XX
(428, 
PRECONDITION_REQUIRED
, 
P»cÚd™iÚ
 
Requœed
) \

139 
	`XX
(429, 
TOO_MANY_REQUESTS
, 
Too
 
Mªy
 
Reque¡s
) \

140 
	`XX
(431, 
REQUEST_HEADER_FIELDS_TOO_LARGE
, 
Reque¡
 
H—d”
 
F›lds
 
Too
 
L¬ge
) \

141 
	`XX
(451, 
UNAVAILABLE_FOR_LEGAL_REASONS
, 
UÇvaabË
 
FÜ
 
Leg®
 
R—sÚs
) \

142 
	`XX
(500, 
INTERNAL_SERVER_ERROR
, 
IÁ”Çl
 
S”v”
 
E¼Ü
) \

143 
	`XX
(501, 
NOT_IMPLEMENTED
, 
NÙ
 
Im¶em’‹d
) \

144 
	`XX
(502, 
BAD_GATEWAY
, 
Bad
 
G©eway
) \

145 
	`XX
(503, 
SERVICE_UNAVAILABLE
, 
S”viû
 
UÇvaabË
) \

146 
	`XX
(504, 
GATEWAY_TIMEOUT
, 
G©eway
 
Timeout
) \

147 
	`XX
(505, 
HTTP_VERSION_NOT_SUPPORTED
, 
HTTP
 
V”siÚ
 
NÙ
 
SuµÜ‹d
) \

148 
	`XX
(506, 
VARIANT_ALSO_NEGOTIATES
, 
V¬ŸÁ
 
Also
 
NegÙŸ‹s
) \

149 
	`XX
(507, 
INSUFFICIENT_STORAGE
, 
Insuffic›Á
 
StÜage
) \

150 
	`XX
(508, 
LOOP_DETECTED
, 
Loİ
 
D‘eùed
) \

151 
	`XX
(510, 
NOT_EXTENDED
, 
NÙ
 
Ex‹nded
) \

152 
	`XX
(511, 
NETWORK_AUTHENTICATION_REQUIRED
, 
N‘wÜk
 
Auth’tiÿtiÚ
 
Requœed
) \

153 

	)

154 
	eh‰p_¡©us


156 
	#XX
(
num
, 
Çme
, 
¡ršg
è
HTTP_STATUS_
##Çmğnum,

	)

157 
HTTP_STATUS_MAP
(
XX
)

158 #undeà
XX


163 
	#HTTP_METHOD_MAP
(
XX
) \

164 
	`XX
(0, 
DELETE
, DELETE) \

165 
	`XX
(1, 
GET
, GET) \

166 
	`XX
(2, 
HEAD
, HEAD) \

167 
	`XX
(3, 
POST
, POST) \

168 
	`XX
(4, 
PUT
, PUT) \

170 
	`XX
(5, 
CONNECT
, CONNECT) \

171 
	`XX
(6, 
OPTIONS
, OPTIONS) \

172 
	`XX
(7, 
TRACE
, TRACE) \

174 
	`XX
(8, 
COPY
, COPY) \

175 
	`XX
(9, 
LOCK
, LOCK) \

176 
	`XX
(10, 
MKCOL
, MKCOL) \

177 
	`XX
(11, 
MOVE
, MOVE) \

178 
	`XX
(12, 
PROPFIND
, PROPFIND) \

179 
	`XX
(13, 
PROPPATCH
, PROPPATCH) \

180 
	`XX
(14, 
SEARCH
, SEARCH) \

181 
	`XX
(15, 
UNLOCK
, UNLOCK) \

182 
	`XX
(16, 
BIND
, BIND) \

183 
	`XX
(17, 
REBIND
, REBIND) \

184 
	`XX
(18, 
UNBIND
, UNBIND) \

185 
	`XX
(19, 
ACL
, ACL) \

187 
	`XX
(20, 
REPORT
, REPORT) \

188 
	`XX
(21, 
MKACTIVITY
, MKACTIVITY) \

189 
	`XX
(22, 
CHECKOUT
, CHECKOUT) \

190 
	`XX
(23, 
MERGE
, MERGE) \

192 
	`XX
(24, 
MSEARCH
, 
M
-
SEARCH
) \

193 
	`XX
(25, 
NOTIFY
, NOTIFY) \

194 
	`XX
(26, 
SUBSCRIBE
, SUBSCRIBE) \

195 
	`XX
(27, 
UNSUBSCRIBE
, UNSUBSCRIBE) \

197 
	`XX
(28, 
PATCH
, PATCH) \

198 
	`XX
(29, 
PURGE
, PURGE) \

200 
	`XX
(30, 
MKCALENDAR
, MKCALENDAR) \

202 
	`XX
(31, 
LINK
, LINK) \

203 
	`XX
(32, 
UNLINK
, UNLINK) \

204 

	)

205 
	eh‰p_m‘hod


207 
	#XX
(
num
, 
Çme
, 
¡ršg
è
HTTP_
##Çmğnum,

	)

208 
HTTP_METHOD_MAP
(
XX
)

209 #undeà
XX


213 
	eh‰p_·r£r_ty³
 { 
HTTP_REQUEST
, 
HTTP_RESPONSE
, 
HTTP_BOTH
 };

217 
	eæags


218 { 
F_CHUNKED
 = 1 << 0

219 , 
F_CONNECTION_KEEP_ALIVE
 = 1 << 1

220 , 
F_CONNECTION_CLOSE
 = 1 << 2

221 , 
F_CONNECTION_UPGRADE
 = 1 << 3

222 , 
F_TRAILING
 = 1 << 4

223 , 
F_UPGRADE
 = 1 << 5

224 , 
F_SKIPBODY
 = 1 << 6

225 , 
F_CONTENTLENGTH
 = 1 << 7

233 
	#HTTP_ERRNO_MAP
(
XX
) \

235 
	`XX
(
OK
, "success") \

238 
	`XX
(
CB_mes§ge_begš
, "the on_message_begin callback failed") \

239 
	`XX
(
CB_u¾
, "the on_url callback failed") \

240 
	`XX
(
CB_h—d”_f›ld
, "the on_header_field callback failed") \

241 
	`XX
(
CB_h—d”_v®ue
, "the on_header_value callback failed") \

242 
	`XX
(
CB_h—d”s_com¶‘e
, "the on_headers_complete callback failed") \

243 
	`XX
(
CB_body
, "the on_body callback failed") \

244 
	`XX
(
CB_mes§ge_com¶‘e
, "the on_message_complete callback failed") \

245 
	`XX
(
CB_¡©us
, "the on_status callback failed") \

246 
	`XX
(
CB_chunk_h—d”
, "the on_chunk_header callback failed") \

247 
	`XX
(
CB_chunk_com¶‘e
, "the on_chunk_complete callback failed") \

250 
	`XX
(
INVALID_EOF_STATE
, "streamƒnded‡t‡n unexpectedime") \

251 
	`XX
(
HEADER_OVERFLOW
, \

253 
	`XX
(
CLOSED_CONNECTION
, \

255 
	`XX
(
INVALID_VERSION
, "invalid HTTP version") \

256 
	`XX
(
INVALID_STATUS
, "invalid HTTP status code") \

257 
	`XX
(
INVALID_METHOD
, "invalid HTTP method") \

258 
	`XX
(
INVALID_URL
, "invalid URL") \

259 
	`XX
(
INVALID_HOST
, "invalid host") \

260 
	`XX
(
INVALID_PORT
, "invalid…ort") \

261 
	`XX
(
INVALID_PATH
, "invalid…ath") \

262 
	`XX
(
INVALID_QUERY_STRING
, "invalid query string") \

263 
	`XX
(
INVALID_FRAGMENT
, "invalid fragment") \

264 
	`XX
(
LF_EXPECTED
, "LF characterƒxpected") \

265 
	`XX
(
INVALID_HEADER_TOKEN
, "invalid character in header") \

266 
	`XX
(
INVALID_CONTENT_LENGTH
, \

268 
	`XX
(
UNEXPECTED_CONTENT_LENGTH
, \

270 
	`XX
(
INVALID_CHUNK_SIZE
, \

272 
	`XX
(
INVALID_CONSTANT
, "invalid constant string") \

273 
	`XX
(
INVALID_INTERNAL_STATE
, "encountered unexpected internal state")\

274 
	`XX
(
STRICT
, "strict mode‡ssertion failed") \

275 
	`XX
(
PAUSED
, "parser is…aused") \

276 
	`XX
(
UNKNOWN
, "ª unknowÀ”rÜ occu¼ed")

	)

280 
	#HTTP_ERRNO_GEN
(
n
, 
s
è
HPE_
##n,

	)

281 
	eh‰p_”ºo
 {

282 
HTTP_ERRNO_MAP
(
HTTP_ERRNO_GEN
)

284 #undeà
HTTP_ERRNO_GEN


288 
	#HTTP_PARSER_ERRNO
(
p
è((
h‰p_”ºo
èÕ)->h‰p_”ºo)

	)

291 
	sh‰p_·r£r
 {

293 
ty³
 : 2;

294 
æags
 : 8;

295 
¡©e
 : 7;

296 
h—d”_¡©e
 : 7;

297 
šdex
 : 7;

298 
Ën›Á_h‰p_h—d”s
 : 1;

300 
ušt32_t
 
Ä—d
;

301 
ušt64_t
 
cÚ‹Á_Ëngth
;

304 
h‰p_majÜ
;

305 
h‰p_mšÜ
;

306 
¡©us_code
 : 16;

307 
m‘hod
 : 8;

308 
h‰p_”ºo
 : 7;

315 
upg¿de
 : 1;

318 *
d©a
;

322 
	sh‰p_·r£r_£‰šgs
 {

323 
h‰p_cb
 
Ú_mes§ge_begš
;

324 
h‰p_d©a_cb
 
Ú_u¾
;

325 
h‰p_d©a_cb
 
Ú_¡©us
;

326 
h‰p_d©a_cb
 
Ú_h—d”_f›ld
;

327 
h‰p_d©a_cb
 
Ú_h—d”_v®ue
;

328 
h‰p_cb
 
Ú_h—d”s_com¶‘e
;

329 
h‰p_d©a_cb
 
Ú_body
;

330 
h‰p_cb
 
Ú_mes§ge_com¶‘e
;

334 
h‰p_cb
 
Ú_chunk_h—d”
;

335 
h‰p_cb
 
Ú_chunk_com¶‘e
;

339 
	eh‰p_·r£r_u¾_f›lds


340 { 
UF_SCHEMA
 = 0

341 , 
UF_HOST
 = 1

342 , 
UF_PORT
 = 2

343 , 
UF_PATH
 = 3

344 , 
UF_QUERY
 = 4

345 , 
UF_FRAGMENT
 = 5

346 , 
UF_USERINFO
 = 6

347 , 
UF_MAX
 = 7

358 
	sh‰p_·r£r_u¾
 {

359 
ušt16_t
 
f›ld_£t
;

360 
ušt16_t
 
pÜt
;

363 
ušt16_t
 
off
;

364 
ušt16_t
 
Ën
;

365 } 
f›ld_d©a
[
UF_MAX
];

379 
h‰p_·r£r_v”siÚ
();

381 
h‰p_·r£r_š™
(
h‰p_·r£r
 *
·r£r
, 
h‰p_·r£r_ty³
 
ty³
);

386 
h‰p_·r£r_£‰šgs_š™
(
h‰p_·r£r_£‰šgs
 *
£‰šgs
);

391 
size_t
 
h‰p_·r£r_execu‹
(
h‰p_·r£r
 *
·r£r
,

392 cÚ¡ 
h‰p_·r£r_£‰šgs
 *
£‰šgs
,

393 cÚ¡ *
d©a
,

394 
size_t
 
Ën
);

403 
h‰p_should_k“p_®ive
(cÚ¡ 
h‰p_·r£r
 *
·r£r
);

406 cÚ¡ *
h‰p_m‘hod_¡r
(
h‰p_m‘hod
 
m
);

409 cÚ¡ *
h‰p_”ºo_Çme
(
h‰p_”ºo
 
”r
);

412 cÚ¡ *
h‰p_”ºo_desütiÚ
(
h‰p_”ºo
 
”r
);

415 
h‰p_·r£r_u¾_š™
(
h‰p_·r£r_u¾
 *
u
);

418 
h‰p_·r£r_·r£_u¾
(cÚ¡ *
buf
, 
size_t
 
buæ’
,

419 
is_cÚÃù
,

420 
h‰p_·r£r_u¾
 *
u
);

423 
h‰p_·r£r_·u£
(
h‰p_·r£r
 *
·r£r
, 
·u£d
);

426 
h‰p_body_is_fš®
(cÚ¡ 
h‰p_·r£r
 *
·r£r
);

428 #ifdeà
__ılu¥lus


	@third-party/http-parser/test.c

21 
	~"h‰p_·r£r.h
"

22 
	~<¡dlib.h
>

23 
	~<as£¹.h
>

24 
	~<¡dio.h
>

25 
	~<¡dlib.h
>

26 
	~<¡ršg.h
>

27 
	~<¡d¬g.h
>

29 #ià
defšed
(
__APPLE__
)

30 #undeà
¡¾ÿt


31 #undeà
¡¾nıy


32 #undeà
¡¾ıy


35 #undeà
TRUE


36 
	#TRUE
 1

	)

37 #undeà
FALSE


38 
	#FALSE
 0

	)

40 
	#MAX_HEADERS
 13

	)

41 
	#MAX_ELEMENT_SIZE
 2048

	)

42 
	#MAX_CHUNKS
 16

	)

44 
	#MIN
(
a
,
b
è(×è< (bè? (aè: (b))

	)

46 
h‰p_·r£r
 *
	g·r£r
;

48 
	smes§ge
 {

49 cÚ¡ *
	mÇme
;

50 cÚ¡ *
	m¿w
;

51 
h‰p_·r£r_ty³
 
	mty³
;

52 
h‰p_m‘hod
 
	mm‘hod
;

53 
	m¡©us_code
;

54 
	m»¥Ú£_¡©us
[
MAX_ELEMENT_SIZE
];

55 
	m»que¡_·th
[
MAX_ELEMENT_SIZE
];

56 
	m»que¡_u¾
[
MAX_ELEMENT_SIZE
];

57 
	mäagm’t
[
MAX_ELEMENT_SIZE
];

58 
	mqu”y_¡ršg
[
MAX_ELEMENT_SIZE
];

59 
	mbody
[
MAX_ELEMENT_SIZE
];

60 
size_t
 
	mbody_size
;

61 cÚ¡ *
	mho¡
;

62 cÚ¡ *
	mu£ršfo
;

63 
ušt16_t
 
	mpÜt
;

64 
	mnum_h—d”s
;

65 ’um { 
	mNONE
=0, 
	mFIELD
, 
	mVALUE
 } 
	mÏ¡_h—d”_–em’t
;

66 
	mh—d”s
 [
MAX_HEADERS
][2][
MAX_ELEMENT_SIZE
];

67 
	mshould_k“p_®ive
;

69 
	mnum_chunks
;

70 
	mnum_chunks_com¶‘e
;

71 
	mchunk_Ëngths
[
MAX_CHUNKS
];

73 cÚ¡ *
	mupg¿de
;

75 
	mh‰p_majÜ
;

76 
	mh‰p_mšÜ
;

78 
	mmes§ge_begš_cb_ÿÎed
;

79 
	mh—d”s_com¶‘e_cb_ÿÎed
;

80 
	mmes§ge_com¶‘e_cb_ÿÎed
;

81 
	m¡©us_cb_ÿÎed
;

82 
	mmes§ge_com¶‘e_Ú_eof
;

83 
	mbody_is_fš®
;

86 
	gcu¼’y_·rsšg_eof
;

88 
mes§ge
 
	gmes§ges
[5];

89 
	gnum_mes§ges
;

90 
h‰p_·r£r_£‰šgs
 *
	gcu¼’t_·u£_·r£r
;

93 cÚ¡ 
mes§ge
 
	g»que¡s
[] =

94 
	#CURL_GET
 0

	)

95 { {.
Çme
= "curl get"

96 ,.
	gty³
ğ
HTTP_REQUEST


97 ,.
	g¿w
= "GET /test HTTP/1.1\r\n"

102 ,.
	gshould_k“p_®ive
ğ
TRUE


103 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


104 ,.
	gh‰p_majÜ
= 1

105 ,.
	gh‰p_mšÜ
= 1

106 ,.
	gm‘hod
ğ
HTTP_GET


107 ,.
	gqu”y_¡ršg
= ""

108 ,.
	gäagm’t
= ""

109 ,.
	g»que¡_·th
= "/test"

110 ,.
	g»que¡_u¾
= "/test"

111 ,.
	gnum_h—d”s
= 3

112 ,.
	gh—d”s
=

117 ,.
	gbody
= ""

120 
	#FIREFOX_GET
 1

	)

121 , {.
	gÇme
= "firefox get"

122 ,.
	gty³
ğ
HTTP_REQUEST


123 ,.
	g¿w
= "GET /favicon.ico HTTP/1.1\r\n"

133 ,.
	gshould_k“p_®ive
ğ
TRUE


134 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


135 ,.
	gh‰p_majÜ
= 1

136 ,.
	gh‰p_mšÜ
= 1

137 ,.
	gm‘hod
ğ
HTTP_GET


138 ,.
	gqu”y_¡ršg
= ""

139 ,.
	gäagm’t
= ""

140 ,.
	g»que¡_·th
= "/favicon.ico"

141 ,.
	g»que¡_u¾
= "/favicon.ico"

142 ,.
	gnum_h—d”s
= 8

143 ,.
	gh—d”s
=

153 ,.
	gbody
= ""

156 
	#DUMBFUCK
 2

	)

157 , {.
	gÇme
= "dumbfuck"

158 ,.
	gty³
ğ
HTTP_REQUEST


159 ,.
	g¿w
= "GET /dumbfuck HTTP/1.1\r\n"

162 ,.
	gshould_k“p_®ive
ğ
TRUE


163 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


164 ,.
	gh‰p_majÜ
= 1

165 ,.
	gh‰p_mšÜ
= 1

166 ,.
	gm‘hod
ğ
HTTP_GET


167 ,.
	gqu”y_¡ršg
= ""

168 ,.
	gäagm’t
= ""

169 ,.
	g»que¡_·th
= "/dumbfuck"

170 ,.
	g»que¡_u¾
= "/dumbfuck"

171 ,.
	gnum_h—d”s
= 1

172 ,.
	gh—d”s
=

175 ,.
	gbody
= ""

178 
	#FRAGMENT_IN_URI
 3

	)

179 , {.
	gÇme
= "fragment in url"

180 ,.
	gty³
ğ
HTTP_REQUEST


181 ,.
	g¿w
= "GET /forums/1/topics/2375?page=1#posts-17408 HTTP/1.1\r\n"

183 ,.
	gshould_k“p_®ive
ğ
TRUE


184 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


185 ,.
	gh‰p_majÜ
= 1

186 ,.
	gh‰p_mšÜ
= 1

187 ,.
	gm‘hod
ğ
HTTP_GET


188 ,.
	gqu”y_¡ršg
= "page=1"

189 ,.
	gäagm’t
= "posts-17408"

190 ,.
	g»que¡_·th
= "/forums/1/topics/2375"

192 ,.
	g»que¡_u¾
= "/forums/1/topics/2375?page=1#posts-17408"

193 ,.
	gnum_h—d”s
= 0

194 ,.
	gbody
= ""

197 
	#GET_NO_HEADERS_NO_BODY
 4

	)

198 , {.
	gÇme
= "get‚o headers‚o body"

199 ,.
	gty³
ğ
HTTP_REQUEST


200 ,.
	g¿w
= "GET /get_no_headers_no_body/world HTTP/1.1\r\n"

202 ,.
	gshould_k“p_®ive
ğ
TRUE


203 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


204 ,.
	gh‰p_majÜ
= 1

205 ,.
	gh‰p_mšÜ
= 1

206 ,.
	gm‘hod
ğ
HTTP_GET


207 ,.
	gqu”y_¡ršg
= ""

208 ,.
	gäagm’t
= ""

209 ,.
	g»que¡_·th
= "/get_no_headers_no_body/world"

210 ,.
	g»que¡_u¾
= "/get_no_headers_no_body/world"

211 ,.
	gnum_h—d”s
= 0

212 ,.
	gbody
= ""

215 
	#GET_ONE_HEADER_NO_BODY
 5

	)

216 , {.
	gÇme
= "get one header‚o body"

217 ,.
	gty³
ğ
HTTP_REQUEST


218 ,.
	g¿w
= "GET /get_one_header_no_body HTTP/1.1\r\n"

221 ,.
	gshould_k“p_®ive
ğ
TRUE


222 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


223 ,.
	gh‰p_majÜ
= 1

224 ,.
	gh‰p_mšÜ
= 1

225 ,.
	gm‘hod
ğ
HTTP_GET


226 ,.
	gqu”y_¡ršg
= ""

227 ,.
	gäagm’t
= ""

228 ,.
	g»que¡_·th
= "/get_one_header_no_body"

229 ,.
	g»que¡_u¾
= "/get_one_header_no_body"

230 ,.
	gnum_h—d”s
= 1

231 ,.
	gh—d”s
=

234 ,.
	gbody
= ""

237 
	#GET_FUNKY_CONTENT_LENGTH
 6

	)

238 , {.
	gÇme
= "get funky content†ength body hello"

239 ,.
	gty³
ğ
HTTP_REQUEST


240 ,.
	g¿w
= "GET /get_funky_content_length_body_hello HTTP/1.0\r\n"

244 ,.
	gshould_k“p_®ive
ğ
FALSE


245 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


246 ,.
	gh‰p_majÜ
= 1

247 ,.
	gh‰p_mšÜ
= 0

248 ,.
	gm‘hod
ğ
HTTP_GET


249 ,.
	gqu”y_¡ršg
= ""

250 ,.
	gäagm’t
= ""

251 ,.
	g»que¡_·th
= "/get_funky_content_length_body_hello"

252 ,.
	g»que¡_u¾
= "/get_funky_content_length_body_hello"

253 ,.
	gnum_h—d”s
= 1

254 ,.
	gh—d”s
=

257 ,.
	gbody
= "HELLO"

260 
	#POST_IDENTITY_BODY_WORLD
 7

	)

261 , {.
	gÇme
= "post identity body world"

262 ,.
	gty³
ğ
HTTP_REQUEST


263 ,.
	g¿w
= "POST /post_identity_body_world?q=search#hey HTTP/1.1\r\n"

269 ,.
	gshould_k“p_®ive
ğ
TRUE


270 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


271 ,.
	gh‰p_majÜ
= 1

272 ,.
	gh‰p_mšÜ
= 1

273 ,.
	gm‘hod
ğ
HTTP_POST


274 ,.
	gqu”y_¡ršg
= "q=search"

275 ,.
	gäagm’t
= "hey"

276 ,.
	g»que¡_·th
= "/post_identity_body_world"

277 ,.
	g»que¡_u¾
= "/post_identity_body_world?q=search#hey"

278 ,.
	gnum_h—d”s
= 3

279 ,.
	gh—d”s
=

284 ,.
	gbody
= "World"

287 
	#POST_CHUNKED_ALL_YOUR_BASE
 8

	)

288 , {.
	gÇme
= "post - chunked body:‡ll your base‡re belongo us"

289 ,.
	gty³
ğ
HTTP_REQUEST


290 ,.
	g¿w
= "POST /post_chunked_all_your_base HTTP/1.1\r\n"

296 ,.
	gshould_k“p_®ive
ğ
TRUE


297 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


298 ,.
	gh‰p_majÜ
= 1

299 ,.
	gh‰p_mšÜ
= 1

300 ,.
	gm‘hod
ğ
HTTP_POST


301 ,.
	gqu”y_¡ršg
= ""

302 ,.
	gäagm’t
= ""

303 ,.
	g»que¡_·th
= "/post_chunked_all_your_base"

304 ,.
	g»que¡_u¾
= "/post_chunked_all_your_base"

305 ,.
	gnum_h—d”s
= 1

306 ,.
	gh—d”s
=

309 ,.
	gbody
= "all your base‡re belongo us"

310 ,.
	gnum_chunks_com¶‘e
= 2

311 ,.
	gchunk_Ëngths
= { 0x1e }

314 
	#TWO_CHUNKS_MULT_ZERO_END
 9

	)

315 , {.
	gÇme
= "two chunks ;riple zeroƒnding"

316 ,.
	gty³
ğ
HTTP_REQUEST


317 ,.
	g¿w
= "POST /two_chunks_mult_zero_end HTTP/1.1\r\n"

324 ,.
	gshould_k“p_®ive
ğ
TRUE


325 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


326 ,.
	gh‰p_majÜ
= 1

327 ,.
	gh‰p_mšÜ
= 1

328 ,.
	gm‘hod
ğ
HTTP_POST


329 ,.
	gqu”y_¡ršg
= ""

330 ,.
	gäagm’t
= ""

331 ,.
	g»que¡_·th
= "/two_chunks_mult_zero_end"

332 ,.
	g»que¡_u¾
= "/two_chunks_mult_zero_end"

333 ,.
	gnum_h—d”s
= 1

334 ,.
	gh—d”s
=

337 ,.
	gbody
= "hello world"

338 ,.
	gnum_chunks_com¶‘e
= 3

339 ,.
	gchunk_Ëngths
= { 5, 6 }

342 
	#CHUNKED_W_TRAILING_HEADERS
 10

	)

343 , {.
	gÇme
= "chunked withrailing headers. blech."

344 ,.
	gty³
ğ
HTTP_REQUEST


345 ,.
	g¿w
= "POST /chunked_w_trailing_headers HTTP/1.1\r\n"

354 ,.
	gshould_k“p_®ive
ğ
TRUE


355 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


356 ,.
	gh‰p_majÜ
= 1

357 ,.
	gh‰p_mšÜ
= 1

358 ,.
	gm‘hod
ğ
HTTP_POST


359 ,.
	gqu”y_¡ršg
= ""

360 ,.
	gäagm’t
= ""

361 ,.
	g»que¡_·th
= "/chunked_w_trailing_headers"

362 ,.
	g»que¡_u¾
= "/chunked_w_trailing_headers"

363 ,.
	gnum_h—d”s
= 3

364 ,.
	gh—d”s
=

369 ,.
	gbody
= "hello world"

370 ,.
	gnum_chunks_com¶‘e
= 3

371 ,.
	gchunk_Ëngths
= { 5, 6 }

374 
	#CHUNKED_W_BULLSHIT_AFTER_LENGTH
 11

	)

375 , {.
	gÇme
= "with bullshit‡fterhe†ength"

376 ,.
	gty³
ğ
HTTP_REQUEST


377 ,.
	g¿w
= "POST /chunked_w_bullshit_after_length HTTP/1.1\r\n"

384 ,.
	gshould_k“p_®ive
ğ
TRUE


385 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


386 ,.
	gh‰p_majÜ
= 1

387 ,.
	gh‰p_mšÜ
= 1

388 ,.
	gm‘hod
ğ
HTTP_POST


389 ,.
	gqu”y_¡ršg
= ""

390 ,.
	gäagm’t
= ""

391 ,.
	g»que¡_·th
= "/chunked_w_bullshit_after_length"

392 ,.
	g»que¡_u¾
= "/chunked_w_bullshit_after_length"

393 ,.
	gnum_h—d”s
= 1

394 ,.
	gh—d”s
=

397 ,.
	gbody
= "hello world"

398 ,.
	gnum_chunks_com¶‘e
= 3

399 ,.
	gchunk_Ëngths
= { 5, 6 }

402 
	#WITH_QUOTES
 12

	)

403 , {.
	gÇme
= "with quotes"

404 ,.
	gty³
ğ
HTTP_REQUEST


405 ,.
	g¿w
= "GET /with_\"stupid\"_quotes?foo=\"bar\" HTTP/1.1\r\n\r\n"

406 ,.
	gshould_k“p_®ive
ğ
TRUE


407 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


408 ,.
	gh‰p_majÜ
= 1

409 ,.
	gh‰p_mšÜ
= 1

410 ,.
	gm‘hod
ğ
HTTP_GET


411 ,.
	gqu”y_¡ršg
= "foo=\"bar\""

412 ,.
	gäagm’t
= ""

413 ,.
	g»que¡_·th
= "/with_\"stupid\"_quotes"

414 ,.
	g»que¡_u¾
= "/with_\"stupid\"_quotes?foo=\"bar\""

415 ,.
	gnum_h—d”s
= 0

416 ,.
	gh—d”s
= { }

417 ,.
	gbody
= ""

420 
	#APACHEBENCH_GET
 13

	)

426 , {.
	gÇme
 = "apachebench get"

427 ,.
	gty³
ğ
HTTP_REQUEST


428 ,.
	g¿w
= "GET /test HTTP/1.0\r\n"

432 ,.
	gshould_k“p_®ive
ğ
FALSE


433 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


434 ,.
	gh‰p_majÜ
= 1

435 ,.
	gh‰p_mšÜ
= 0

436 ,.
	gm‘hod
ğ
HTTP_GET


437 ,.
	gqu”y_¡ršg
= ""

438 ,.
	gäagm’t
= ""

439 ,.
	g»que¡_·th
= "/test"

440 ,.
	g»que¡_u¾
= "/test"

441 ,.
	gnum_h—d”s
= 3

442 ,.
	gh—d”s
= { { "Host", "0.0.0.0:5000" }

446 ,.
	gbody
= ""

449 
	#QUERY_URL_WITH_QUESTION_MARK_GET
 14

	)

452 , {.
	gÇme
 = "query url with question mark"

453 ,.
	gty³
ğ
HTTP_REQUEST


454 ,.
	g¿w
= "GET /test.cgi?foo=bar?baz HTTP/1.1\r\n\r\n"

455 ,.
	gshould_k“p_®ive
ğ
TRUE


456 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


457 ,.
	gh‰p_majÜ
= 1

458 ,.
	gh‰p_mšÜ
= 1

459 ,.
	gm‘hod
ğ
HTTP_GET


460 ,.
	gqu”y_¡ršg
= "foo=bar?baz"

461 ,.
	gäagm’t
= ""

462 ,.
	g»que¡_·th
= "/test.cgi"

463 ,.
	g»que¡_u¾
= "/test.cgi?foo=bar?baz"

464 ,.
	gnum_h—d”s
= 0

465 ,.
	gh—d”s
= {}

466 ,.
	gbody
= ""

469 
	#PREFIX_NEWLINE_GET
 15

	)

473 , {.
	gÇme
 = "newline…refix get"

474 ,.
	gty³
ğ
HTTP_REQUEST


475 ,.
	g¿w
= "\r\nGET /test HTTP/1.1\r\n\r\n"

476 ,.
	gshould_k“p_®ive
ğ
TRUE


477 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


478 ,.
	gh‰p_majÜ
= 1

479 ,.
	gh‰p_mšÜ
= 1

480 ,.
	gm‘hod
ğ
HTTP_GET


481 ,.
	gqu”y_¡ršg
= ""

482 ,.
	gäagm’t
= ""

483 ,.
	g»que¡_·th
= "/test"

484 ,.
	g»que¡_u¾
= "/test"

485 ,.
	gnum_h—d”s
= 0

486 ,.
	gh—d”s
= { }

487 ,.
	gbody
= ""

490 
	#UPGRADE_REQUEST
 16

	)

491 , {.
	gÇme
 = "upgrade„equest"

492 ,.
	gty³
ğ
HTTP_REQUEST


493 ,.
	g¿w
= "GET /demo HTTP/1.1\r\n"

503 ,.
	gshould_k“p_®ive
ğ
TRUE


504 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


505 ,.
	gh‰p_majÜ
= 1

506 ,.
	gh‰p_mšÜ
= 1

507 ,.
	gm‘hod
ğ
HTTP_GET


508 ,.
	gqu”y_¡ršg
= ""

509 ,.
	gäagm’t
= ""

510 ,.
	g»que¡_·th
= "/demo"

511 ,.
	g»que¡_u¾
= "/demo"

512 ,.
	gnum_h—d”s
= 7

513 ,.
	gupg¿de
="Hot diggity dogg"

514 ,.
	gh—d”s
= { { "Host", "example.com" }

522 ,.
	gbody
= ""

525 
	#CONNECT_REQUEST
 17

	)

526 , {.
	gÇme
 = "connect„equest"

527 ,.
	gty³
ğ
HTTP_REQUEST


528 ,.
	g¿w
= "CONNECT 0-home0.netscape.com:443 HTTP/1.0\r\n"

534 ,.
	gshould_k“p_®ive
ğ
FALSE


535 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


536 ,.
	gh‰p_majÜ
= 1

537 ,.
	gh‰p_mšÜ
= 0

538 ,.
	gm‘hod
ğ
HTTP_CONNECT


539 ,.
	gqu”y_¡ršg
= ""

540 ,.
	gäagm’t
= ""

541 ,.
	g»que¡_·th
= ""

542 ,.
	g»que¡_u¾
= "0-home0.netscape.com:443"

543 ,.
	gnum_h—d”s
= 2

544 ,.
	gupg¿de
="some data\r\nand yetƒven more data"

545 ,.
	gh—d”s
= { { "User-agent", "Mozilla/1.1N" }

548 ,.
	gbody
= ""

551 
	#REPORT_REQ
 18

	)

552 , {.
	gÇme
= "report„equest"

553 ,.
	gty³
ğ
HTTP_REQUEST


554 ,.
	g¿w
= "REPORT /test HTTP/1.1\r\n"

556 ,.
	gshould_k“p_®ive
ğ
TRUE


557 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


558 ,.
	gh‰p_majÜ
= 1

559 ,.
	gh‰p_mšÜ
= 1

560 ,.
	gm‘hod
ğ
HTTP_REPORT


561 ,.
	gqu”y_¡ršg
= ""

562 ,.
	gäagm’t
= ""

563 ,.
	g»que¡_·th
= "/test"

564 ,.
	g»que¡_u¾
= "/test"

565 ,.
	gnum_h—d”s
= 0

566 ,.
	gh—d”s
= {}

567 ,.
	gbody
= ""

570 
	#NO_HTTP_VERSION
 19

	)

571 , {.
	gÇme
= "request with‚o http version"

572 ,.
	gty³
ğ
HTTP_REQUEST


573 ,.
	g¿w
= "GET /\r\n"

575 ,.
	gshould_k“p_®ive
ğ
FALSE


576 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


577 ,.
	gh‰p_majÜ
= 0

578 ,.
	gh‰p_mšÜ
= 9

579 ,.
	gm‘hod
ğ
HTTP_GET


580 ,.
	gqu”y_¡ršg
= ""

581 ,.
	gäagm’t
= ""

582 ,.
	g»que¡_·th
= "/"

583 ,.
	g»que¡_u¾
= "/"

584 ,.
	gnum_h—d”s
= 0

585 ,.
	gh—d”s
= {}

586 ,.
	gbody
= ""

589 
	#MSEARCH_REQ
 20

	)

590 , {.
	gÇme
= "m-search„equest"

591 ,.
	gty³
ğ
HTTP_REQUEST


592 ,.
	g¿w
= "M-SEARCH * HTTP/1.1\r\n"

597 ,.
	gshould_k“p_®ive
ğ
TRUE


598 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


599 ,.
	gh‰p_majÜ
= 1

600 ,.
	gh‰p_mšÜ
= 1

601 ,.
	gm‘hod
ğ
HTTP_MSEARCH


602 ,.
	gqu”y_¡ršg
= ""

603 ,.
	gäagm’t
= ""

604 ,.
	g»que¡_·th
= "*"

605 ,.
	g»que¡_u¾
= "*"

606 ,.
	gnum_h—d”s
= 3

607 ,.
	gh—d”s
= { { "HOST", "239.255.255.250:1900" }

611 ,.
	gbody
= ""

614 
	#LINE_FOLDING_IN_HEADER
 21

	)

615 , {.
	gÇme
= "line folding in header value"

616 ,.
	gty³
ğ
HTTP_REQUEST


617 ,.
	g¿w
= "GET / HTTP/1.1\r\n"

632 ,.
	gshould_k“p_®ive
ğ
FALSE


633 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


634 ,.
	gh‰p_majÜ
= 1

635 ,.
	gh‰p_mšÜ
= 1

636 ,.
	gm‘hod
ğ
HTTP_GET


637 ,.
	gqu”y_¡ršg
= ""

638 ,.
	gäagm’t
= ""

639 ,.
	g»que¡_·th
= "/"

640 ,.
	g»que¡_u¾
= "/"

641 ,.
	gnum_h—d”s
= 5

642 ,.
	gh—d”s
= { { "Line1", "abc\tdef ghi\t\tjkl mno \t \tqrs" }

648 ,.
	gbody
= ""

652 
	#QUERY_TERMINATED_HOST
 22

	)

653 , {.
	gÇme
= "hosterminated by‡ query string"

654 ,.
	gty³
ğ
HTTP_REQUEST


655 ,.
	g¿w
= "GET http://hypnotoad.org?hail=all HTTP/1.1\r\n"

657 ,.
	gshould_k“p_®ive
ğ
TRUE


658 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


659 ,.
	gh‰p_majÜ
= 1

660 ,.
	gh‰p_mšÜ
= 1

661 ,.
	gm‘hod
ğ
HTTP_GET


662 ,.
	gqu”y_¡ršg
= "hail=all"

663 ,.
	gäagm’t
= ""

664 ,.
	g»que¡_·th
= ""

665 ,.
	g»que¡_u¾
= "http://hypnotoad.org?hail=all"

666 ,.
	gho¡
= "hypnotoad.org"

667 ,.
	gnum_h—d”s
= 0

668 ,.
	gh—d”s
= { }

669 ,.
	gbody
= ""

672 
	#QUERY_TERMINATED_HOSTPORT
 23

	)

673 , {.
	gÇme
= "host:porterminated by‡ query string"

674 ,.
	gty³
ğ
HTTP_REQUEST


675 ,.
	g¿w
= "GET http://hypnotoad.org:1234?hail=all HTTP/1.1\r\n"

677 ,.
	gshould_k“p_®ive
ğ
TRUE


678 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


679 ,.
	gh‰p_majÜ
= 1

680 ,.
	gh‰p_mšÜ
= 1

681 ,.
	gm‘hod
ğ
HTTP_GET


682 ,.
	gqu”y_¡ršg
= "hail=all"

683 ,.
	gäagm’t
= ""

684 ,.
	g»que¡_·th
= ""

685 ,.
	g»que¡_u¾
= "http://hypnotoad.org:1234?hail=all"

686 ,.
	gho¡
= "hypnotoad.org"

687 ,.
	gpÜt
= 1234

688 ,.
	gnum_h—d”s
= 0

689 ,.
	gh—d”s
= { }

690 ,.
	gbody
= ""

693 
	#SPACE_TERMINATED_HOSTPORT
 24

	)

694 , {.
	gÇme
= "host:porterminated by‡ space"

695 ,.
	gty³
ğ
HTTP_REQUEST


696 ,.
	g¿w
= "GET http://hypnotoad.org:1234 HTTP/1.1\r\n"

698 ,.
	gshould_k“p_®ive
ğ
TRUE


699 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


700 ,.
	gh‰p_majÜ
= 1

701 ,.
	gh‰p_mšÜ
= 1

702 ,.
	gm‘hod
ğ
HTTP_GET


703 ,.
	gqu”y_¡ršg
= ""

704 ,.
	gäagm’t
= ""

705 ,.
	g»que¡_·th
= ""

706 ,.
	g»que¡_u¾
= "http://hypnotoad.org:1234"

707 ,.
	gho¡
= "hypnotoad.org"

708 ,.
	gpÜt
= 1234

709 ,.
	gnum_h—d”s
= 0

710 ,.
	gh—d”s
= { }

711 ,.
	gbody
= ""

714 
	#PATCH_REQ
 25

	)

715 , {.
	gÇme
 = "PATCH„equest"

716 ,.
	gty³
ğ
HTTP_REQUEST


717 ,.
	g¿w
= "PATCH /file.txt HTTP/1.1\r\n"

724 ,.
	gshould_k“p_®ive
ğ
TRUE


725 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


726 ,.
	gh‰p_majÜ
= 1

727 ,.
	gh‰p_mšÜ
= 1

728 ,.
	gm‘hod
ğ
HTTP_PATCH


729 ,.
	gqu”y_¡ršg
= ""

730 ,.
	gäagm’t
= ""

731 ,.
	g»que¡_·th
= "/file.txt"

732 ,.
	g»que¡_u¾
= "/file.txt"

733 ,.
	gnum_h—d”s
= 4

734 ,.
	gh—d”s
= { { "Host", "www.example.com" }

739 ,.
	gbody
= "cccccccccc"

742 
	#CONNECT_CAPS_REQUEST
 26

	)

743 , {.
	gÇme
 = "connect caps„equest"

744 ,.
	gty³
ğ
HTTP_REQUEST


745 ,.
	g¿w
= "CONNECT HOME0.NETSCAPE.COM:443 HTTP/1.0\r\n"

749 ,.
	gshould_k“p_®ive
ğ
FALSE


750 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


751 ,.
	gh‰p_majÜ
= 1

752 ,.
	gh‰p_mšÜ
= 0

753 ,.
	gm‘hod
ğ
HTTP_CONNECT


754 ,.
	gqu”y_¡ršg
= ""

755 ,.
	gäagm’t
= ""

756 ,.
	g»que¡_·th
= ""

757 ,.
	g»que¡_u¾
= "HOME0.NETSCAPE.COM:443"

758 ,.
	gnum_h—d”s
= 2

759 ,.
	gupg¿de
=""

760 ,.
	gh—d”s
= { { "User-agent", "Mozilla/1.1N" }

763 ,.
	gbody
= ""

766 #ià!
HTTP_PARSER_STRICT


767 
	#UTF8_PATH_REQ
 27

	)

768 , {.
	gÇme
= "utf-8…ath„equest"

769 ,.
	gty³
ğ
HTTP_REQUEST


770 ,.
	g¿w
= "GET /Î´Â¶/Î´t/pope?q=1#narf HTTP/1.1\r\n"

773 ,.
	gshould_k“p_®ive
ğ
TRUE


774 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


775 ,.
	gh‰p_majÜ
= 1

776 ,.
	gh‰p_mšÜ
= 1

777 ,.
	gm‘hod
ğ
HTTP_GET


778 ,.
	gqu”y_¡ršg
= "q=1"

779 ,.
	gäagm’t
= "narf"

780 ,.
	g»que¡_·th
= "/Î´Â¶/Î´t/pope"

781 ,.
	g»que¡_u¾
= "/Î´Â¶/Î´t/pope?q=1#narf"

782 ,.
	gnum_h—d”s
= 1

783 ,.
	gh—d”s
= { {"Host", "github.com" }

785 ,.
	gbody
= ""

788 
	#HOSTNAME_UNDERSCORE
 28

	)

789 , {.
	gÇme
 = "hostname underscore"

790 ,.
	gty³
ğ
HTTP_REQUEST


791 ,.
	g¿w
= "CONNECT home_0.netscape.com:443 HTTP/1.0\r\n"

795 ,.
	gshould_k“p_®ive
ğ
FALSE


796 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


797 ,.
	gh‰p_majÜ
= 1

798 ,.
	gh‰p_mšÜ
= 0

799 ,.
	gm‘hod
ğ
HTTP_CONNECT


800 ,.
	gqu”y_¡ršg
= ""

801 ,.
	gäagm’t
= ""

802 ,.
	g»que¡_·th
= ""

803 ,.
	g»que¡_u¾
= "home_0.netscape.com:443"

804 ,.
	gnum_h—d”s
= 2

805 ,.
	gupg¿de
=""

806 ,.
	gh—d”s
= { { "User-agent", "Mozilla/1.1N" }

809 ,.
	gbody
= ""

814 
	#EAT_TRAILING_CRLF_NO_CONNECTION_CLOSE
 29

	)

815 , {.
	gÇme
 = "eat CRLF between„equests,‚o \"Connection: close\" header"

816 ,.
	g¿w
= "POST / HTTP/1.1\r\n"

822 ,.
	gshould_k“p_®ive
ğ
TRUE


823 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


824 ,.
	gh‰p_majÜ
= 1

825 ,.
	gh‰p_mšÜ
= 1

826 ,.
	gm‘hod
ğ
HTTP_POST


827 ,.
	gqu”y_¡ršg
= ""

828 ,.
	gäagm’t
= ""

829 ,.
	g»que¡_·th
= "/"

830 ,.
	g»que¡_u¾
= "/"

831 ,.
	gnum_h—d”s
= 3

832 ,.
	gupg¿de
= 0

833 ,.
	gh—d”s
= { { "Host", "www.example.com" }

837 ,.
	gbody
= "q=42"

841 
	#EAT_TRAILING_CRLF_WITH_CONNECTION_CLOSE
 30

	)

842 , {.
	gÇme
 = "eat CRLF between„equestsƒven if \"Connection: close\" is set"

843 ,.
	g¿w
= "POST / HTTP/1.1\r\n"

850 ,.
	gshould_k“p_®ive
ğ
FALSE


851 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


852 ,.
	gh‰p_majÜ
= 1

853 ,.
	gh‰p_mšÜ
= 1

854 ,.
	gm‘hod
ğ
HTTP_POST


855 ,.
	gqu”y_¡ršg
= ""

856 ,.
	gäagm’t
= ""

857 ,.
	g»que¡_·th
= "/"

858 ,.
	g»que¡_u¾
= "/"

859 ,.
	gnum_h—d”s
= 4

860 ,.
	gupg¿de
= 0

861 ,.
	gh—d”s
= { { "Host", "www.example.com" }

866 ,.
	gbody
= "q=42"

869 
	#PURGE_REQ
 31

	)

870 , {.
	gÇme
 = "PURGE„equest"

871 ,.
	gty³
ğ
HTTP_REQUEST


872 ,.
	g¿w
= "PURGE /file.txt HTTP/1.1\r\n"

875 ,.
	gshould_k“p_®ive
ğ
TRUE


876 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


877 ,.
	gh‰p_majÜ
= 1

878 ,.
	gh‰p_mšÜ
= 1

879 ,.
	gm‘hod
ğ
HTTP_PURGE


880 ,.
	gqu”y_¡ršg
= ""

881 ,.
	gäagm’t
= ""

882 ,.
	g»que¡_·th
= "/file.txt"

883 ,.
	g»que¡_u¾
= "/file.txt"

884 ,.
	gnum_h—d”s
= 1

885 ,.
	gh—d”s
= { { "Host", "www.example.com" } }

886 ,.
	gbody
= ""

889 
	#SEARCH_REQ
 32

	)

890 , {.
	gÇme
 = "SEARCH„equest"

891 ,.
	gty³
ğ
HTTP_REQUEST


892 ,.
	g¿w
= "SEARCH / HTTP/1.1\r\n"

895 ,.
	gshould_k“p_®ive
ğ
TRUE


896 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


897 ,.
	gh‰p_majÜ
= 1

898 ,.
	gh‰p_mšÜ
= 1

899 ,.
	gm‘hod
ğ
HTTP_SEARCH


900 ,.
	gqu”y_¡ršg
= ""

901 ,.
	gäagm’t
= ""

902 ,.
	g»que¡_·th
= "/"

903 ,.
	g»que¡_u¾
= "/"

904 ,.
	gnum_h—d”s
= 1

905 ,.
	gh—d”s
= { { "Host", "www.example.com" } }

906 ,.
	gbody
= ""

909 
	#PROXY_WITH_BASIC_AUTH
 33

	)

910 , {.
	gÇme
= "host:port‡nd basic_auth"

911 ,.
	gty³
ğ
HTTP_REQUEST


912 ,.
	g¿w
= "GET http://a%12:b!&*$@hypnotoad.org:1234/toto HTTP/1.1\r\n"

914 ,.
	gshould_k“p_®ive
ğ
TRUE


915 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


916 ,.
	gh‰p_majÜ
= 1

917 ,.
	gh‰p_mšÜ
= 1

918 ,.
	gm‘hod
ğ
HTTP_GET


919 ,.
	gäagm’t
= ""

920 ,.
	g»que¡_·th
= "/toto"

921 ,.
	g»que¡_u¾
= "http://a%12:b!&*$@hypnotoad.org:1234/toto"

922 ,.
	gho¡
= "hypnotoad.org"

923 ,.
	gu£ršfo
= "a%12:b!&*$"

924 ,.
	gpÜt
= 1234

925 ,.
	gnum_h—d”s
= 0

926 ,.
	gh—d”s
= { }

927 ,.
	gbody
= ""

930 
	#LINE_FOLDING_IN_HEADER_WITH_LF
 34

	)

931 , {.
	gÇme
= "line folding in header value"

932 ,.
	gty³
ğ
HTTP_REQUEST


933 ,.
	g¿w
= "GET / HTTP/1.1\n"

948 ,.
	gshould_k“p_®ive
ğ
FALSE


949 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


950 ,.
	gh‰p_majÜ
= 1

951 ,.
	gh‰p_mšÜ
= 1

952 ,.
	gm‘hod
ğ
HTTP_GET


953 ,.
	gqu”y_¡ršg
= ""

954 ,.
	gäagm’t
= ""

955 ,.
	g»que¡_·th
= "/"

956 ,.
	g»que¡_u¾
= "/"

957 ,.
	gnum_h—d”s
= 5

958 ,.
	gh—d”s
= { { "Line1", "abc\tdef ghi\t\tjkl mno \t \tqrs" }

964 ,.
	gbody
= ""

967 
	#CONNECTION_MULTI
 35

	)

968 , {.
	gÇme
 = "multiple connection header values with folding"

969 ,.
	gty³
ğ
HTTP_REQUEST


970 ,.
	g¿w
= "GET /demo HTTP/1.1\r\n"

981 ,.
	gshould_k“p_®ive
ğ
TRUE


982 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


983 ,.
	gh‰p_majÜ
= 1

984 ,.
	gh‰p_mšÜ
= 1

985 ,.
	gm‘hod
ğ
HTTP_GET


986 ,.
	gqu”y_¡ršg
= ""

987 ,.
	gäagm’t
= ""

988 ,.
	g»que¡_·th
= "/demo"

989 ,.
	g»que¡_u¾
= "/demo"

990 ,.
	gnum_h—d”s
= 7

991 ,.
	gupg¿de
="Hot diggity dogg"

992 ,.
	gh—d”s
= { { "Host", "example.com" }

1000 ,.
	gbody
= ""

1003 
	#CONNECTION_MULTI_LWS
 36

	)

1004 , {.
	gÇme
 = "multiple connection header values with folding‡nd†ws"

1005 ,.
	gty³
ğ
HTTP_REQUEST


1006 ,.
	g¿w
= "GET /demo HTTP/1.1\r\n"

1011 ,.
	gshould_k“p_®ive
ğ
TRUE


1012 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1013 ,.
	gh‰p_majÜ
= 1

1014 ,.
	gh‰p_mšÜ
= 1

1015 ,.
	gm‘hod
ğ
HTTP_GET


1016 ,.
	gqu”y_¡ršg
= ""

1017 ,.
	gäagm’t
= ""

1018 ,.
	g»que¡_·th
= "/demo"

1019 ,.
	g»que¡_u¾
= "/demo"

1020 ,.
	gnum_h—d”s
= 2

1021 ,.
	gupg¿de
="Hot diggity dogg"

1022 ,.
	gh—d”s
= { { "Connection", "keep-alive, upgrade" }

1025 ,.
	gbody
= ""

1028 
	#CONNECTION_MULTI_LWS_CRLF
 37

	)

1029 , {.
	gÇme
 = "multiple connection header values with folding‡nd†ws"

1030 ,.
	gty³
ğ
HTTP_REQUEST


1031 ,.
	g¿w
= "GET /demo HTTP/1.1\r\n"

1036 ,.
	gshould_k“p_®ive
ğ
TRUE


1037 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1038 ,.
	gh‰p_majÜ
= 1

1039 ,.
	gh‰p_mšÜ
= 1

1040 ,.
	gm‘hod
ğ
HTTP_GET


1041 ,.
	gqu”y_¡ršg
= ""

1042 ,.
	gäagm’t
= ""

1043 ,.
	g»que¡_·th
= "/demo"

1044 ,.
	g»que¡_u¾
= "/demo"

1045 ,.
	gnum_h—d”s
= 2

1046 ,.
	gupg¿de
="Hot diggity dogg"

1047 ,.
	gh—d”s
= { { "Connection", "keep-alive, upgrade" }

1050 ,.
	gbody
= ""

1053 
	#UPGRADE_POST_REQUEST
 38

	)

1054 , {.
	gÇme
 = "upgrade…ost„equest"

1055 ,.
	gty³
ğ
HTTP_REQUEST


1056 ,.
	g¿w
= "POST /demo HTTP/1.1\r\n"

1064 ,.
	gshould_k“p_®ive
ğ
TRUE


1065 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1066 ,.
	gh‰p_majÜ
= 1

1067 ,.
	gh‰p_mšÜ
= 1

1068 ,.
	gm‘hod
ğ
HTTP_POST


1069 ,.
	g»que¡_·th
= "/demo"

1070 ,.
	g»que¡_u¾
= "/demo"

1071 ,.
	gnum_h—d”s
= 4

1072 ,.
	gupg¿de
="Hot diggity dogg"

1073 ,.
	gh—d”s
= { { "Host", "example.com" }

1078 ,.
	gbody
= "sweet…ost body"

1081 
	#CONNECT_WITH_BODY_REQUEST
 39

	)

1082 , {.
	gÇme
 = "connect with body„equest"

1083 ,.
	gty³
ğ
HTTP_REQUEST


1084 ,.
	g¿w
= "CONNECT foo.bar.com:443 HTTP/1.0\r\n"

1090 ,.
	gshould_k“p_®ive
ğ
FALSE


1091 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1092 ,.
	gh‰p_majÜ
= 1

1093 ,.
	gh‰p_mšÜ
= 0

1094 ,.
	gm‘hod
ğ
HTTP_CONNECT


1095 ,.
	g»que¡_u¾
= "foo.bar.com:443"

1096 ,.
	gnum_h—d”s
= 3

1097 ,.
	gupg¿de
="blarfcicle"

1098 ,.
	gh—d”s
= { { "User-agent", "Mozilla/1.1N" }

1102 ,.
	gbody
= ""

1109 
	#LINK_REQUEST
 40

	)

1110 , {.
	gÇme
 = "link„equest"

1111 ,.
	gty³
ğ
HTTP_REQUEST


1112 ,.
	g¿w
= "LINK /images/my_dog.jpg HTTP/1.1\r\n"

1117 ,.
	gshould_k“p_®ive
ğ
TRUE


1118 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1119 ,.
	gh‰p_majÜ
= 1

1120 ,.
	gh‰p_mšÜ
= 1

1121 ,.
	gm‘hod
ğ
HTTP_LINK


1122 ,.
	g»que¡_·th
= "/images/my_dog.jpg"

1123 ,.
	g»que¡_u¾
= "/images/my_dog.jpg"

1124 ,.
	gqu”y_¡ršg
= ""

1125 ,.
	gäagm’t
= ""

1126 ,.
	gnum_h—d”s
= 3

1127 ,.
	gh—d”s
= { { "Host", "example.com" }

1131 ,.
	gbody
= ""

1134 
	#UNLINK_REQUEST
 41

	)

1135 , {.
	gÇme
 = "unlink„equest"

1136 ,.
	gty³
ğ
HTTP_REQUEST


1137 ,.
	g¿w
= "UNLINK /images/my_dog.jpg HTTP/1.1\r\n"

1141 ,.
	gshould_k“p_®ive
ğ
TRUE


1142 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1143 ,.
	gh‰p_majÜ
= 1

1144 ,.
	gh‰p_mšÜ
= 1

1145 ,.
	gm‘hod
ğ
HTTP_UNLINK


1146 ,.
	g»que¡_·th
= "/images/my_dog.jpg"

1147 ,.
	g»que¡_u¾
= "/images/my_dog.jpg"

1148 ,.
	gqu”y_¡ršg
= ""

1149 ,.
	gäagm’t
= ""

1150 ,.
	gnum_h—d”s
= 2

1151 ,.
	gh—d”s
= { { "Host", "example.com" }

1154 ,.
	gbody
= ""

1157 , {.
	gÇme
ğ
NULL
 }

1161 cÚ¡ 
mes§ge
 
	g»¥Ú£s
[] =

1162 
	#GOOGLE_301
 0

	)

1163 { {.
Çme
= "google 301"

1164 ,.
	gty³
ğ
HTTP_RESPONSE


1165 ,.
	g¿w
= "HTTP/1.1 301 Moved Permanently\r\n"

1181 ,.
	gshould_k“p_®ive
ğ
TRUE


1182 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1183 ,.
	gh‰p_majÜ
= 1

1184 ,.
	gh‰p_mšÜ
= 1

1185 ,.
	g¡©us_code
= 301

1186 ,.
	g»¥Ú£_¡©us
= "Moved Permanently"

1187 ,.
	gnum_h—d”s
= 8

1188 ,.
	gh—d”s
=

1198 ,.
	gbody
= "<HTML><HEAD><meta http-equiv=\"content-type\" content=\"text/html;charset=utf-8\">\n"

1206 
	#NO_CONTENT_LENGTH_RESPONSE
 1

	)

1212 , {.
	gÇme
= "no content-length„esponse"

1213 ,.
	gty³
ğ
HTTP_RESPONSE


1214 ,.
	g¿w
= "HTTP/1.1 200 OK\r\n"

1230 ,.
	gshould_k“p_®ive
ğ
FALSE


1231 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
TRUE


1232 ,.
	gh‰p_majÜ
= 1

1233 ,.
	gh‰p_mšÜ
= 1

1234 ,.
	g¡©us_code
= 200

1235 ,.
	g»¥Ú£_¡©us
= "OK"

1236 ,.
	gnum_h—d”s
= 5

1237 ,.
	gh—d”s
=

1244 ,.
	gbody
= "<?xml version=\"1.0\"ƒncoding=\"UTF-8\"?>\n"

1255 
	#NO_HEADERS_NO_BODY_404
 2

	)

1256 , {.
	gÇme
= "404‚o headers‚o body"

1257 ,.
	gty³
ğ
HTTP_RESPONSE


1258 ,.
	g¿w
= "HTTP/1.1 404 Not Found\r\n\r\n"

1259 ,.
	gshould_k“p_®ive
ğ
FALSE


1260 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
TRUE


1261 ,.
	gh‰p_majÜ
= 1

1262 ,.
	gh‰p_mšÜ
= 1

1263 ,.
	g¡©us_code
= 404

1264 ,.
	g»¥Ú£_¡©us
= "Not Found"

1265 ,.
	gnum_h—d”s
= 0

1266 ,.
	gh—d”s
= {}

1267 ,.
	gbody_size
= 0

1268 ,.
	gbody
= ""

1271 
	#NO_REASON_PHRASE
 3

	)

1272 , {.
	gÇme
= "301‚o„esponse…hrase"

1273 ,.
	gty³
ğ
HTTP_RESPONSE


1274 ,.
	g¿w
= "HTTP/1.1 301\r\n\r\n"

1275 ,.
	gshould_k“p_®ive
 = 
FALSE


1276 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
TRUE


1277 ,.
	gh‰p_majÜ
= 1

1278 ,.
	gh‰p_mšÜ
= 1

1279 ,.
	g¡©us_code
= 301

1280 ,.
	g»¥Ú£_¡©us
= ""

1281 ,.
	gnum_h—d”s
= 0

1282 ,.
	gh—d”s
= {}

1283 ,.
	gbody
= ""

1286 
	#TRAILING_SPACE_ON_CHUNKED_BODY
 4

	)

1287 , {.
	gÇme
="200railing space on chunked body"

1288 ,.
	gty³
ğ
HTTP_RESPONSE


1289 ,.
	g¿w
= "HTTP/1.1 200 OK\r\n"

1301 ,.
	gshould_k“p_®ive
ğ
TRUE


1302 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1303 ,.
	gh‰p_majÜ
= 1

1304 ,.
	gh‰p_mšÜ
= 1

1305 ,.
	g¡©us_code
= 200

1306 ,.
	g»¥Ú£_¡©us
= "OK"

1307 ,.
	gnum_h—d”s
= 2

1308 ,.
	gh—d”s
=

1312 ,.
	gbody_size
 = 37+28

1313 ,.
	gbody
 =

1316 ,.
	gnum_chunks_com¶‘e
= 3

1317 ,.
	gchunk_Ëngths
= { 0x25, 0x1c }

1320 
	#NO_CARRIAGE_RET
 5

	)

1321 , {.
	gÇme
="no carriage„et"

1322 ,.
	gty³
ğ
HTTP_RESPONSE


1323 ,.
	g¿w
= "HTTP/1.1 200 OK\n"

1328 ,.
	gshould_k“p_®ive
ğ
FALSE


1329 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
TRUE


1330 ,.
	gh‰p_majÜ
= 1

1331 ,.
	gh‰p_mšÜ
= 1

1332 ,.
	g¡©us_code
= 200

1333 ,.
	g»¥Ú£_¡©us
= "OK"

1334 ,.
	gnum_h—d”s
= 2

1335 ,.
	gh—d”s
=

1339 ,.
	gbody
= "these headers‡re from http://news.ycombinator.com/"

1342 
	#PROXY_CONNECTION
 6

	)

1343 , {.
	gÇme
="proxy connection"

1344 ,.
	gty³
ğ
HTTP_RESPONSE


1345 ,.
	g¿w
= "HTTP/1.1 200 OK\r\n"

1352 ,.
	gshould_k“p_®ive
ğ
FALSE


1353 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1354 ,.
	gh‰p_majÜ
= 1

1355 ,.
	gh‰p_mšÜ
= 1

1356 ,.
	g¡©us_code
= 200

1357 ,.
	g»¥Ú£_¡©us
= "OK"

1358 ,.
	gnum_h—d”s
= 4

1359 ,.
	gh—d”s
=

1365 ,.
	gbody
= "hello world"

1368 
	#UNDERSTORE_HEADER_KEY
 7

	)

1371 , {.
	gÇme
="underscore header key"

1372 ,.
	gty³
ğ
HTTP_RESPONSE


1373 ,.
	g¿w
= "HTTP/1.1 200 OK\r\n"

1378 ,.
	gshould_k“p_®ive
ğ
TRUE


1379 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1380 ,.
	gh‰p_majÜ
= 1

1381 ,.
	gh‰p_mšÜ
= 1

1382 ,.
	g¡©us_code
= 200

1383 ,.
	g»¥Ú£_¡©us
= "OK"

1384 ,.
	gnum_h—d”s
= 4

1385 ,.
	gh—d”s
=

1391 ,.
	gbody
= ""

1394 
	#BONJOUR_MADAME_FR
 8

	)

1398 , {.
	gÇme
= "bonjourmadame.fr"

1399 ,.
	gty³
ğ
HTTP_RESPONSE


1400 ,.
	g¿w
= "HTTP/1.0 301 Moved Permanently\r\n"

1411 ,.
	gshould_k“p_®ive
ğ
TRUE


1412 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1413 ,.
	gh‰p_majÜ
= 1

1414 ,.
	gh‰p_mšÜ
= 0

1415 ,.
	g¡©us_code
= 301

1416 ,.
	g»¥Ú£_¡©us
= "Moved Permanently"

1417 ,.
	gnum_h—d”s
= 9

1418 ,.
	gh—d”s
=

1429 ,.
	gbody
= ""

1432 
	#RES_FIELD_UNDERSCORE
 9

	)

1434 , {.
	gÇme
= "field underscore"

1435 ,.
	gty³
ğ
HTTP_RESPONSE


1436 ,.
	g¿w
= "HTTP/1.1 200 OK\r\n"

1450 ,.
	gshould_k“p_®ive
ğ
FALSE


1451 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1452 ,.
	gh‰p_majÜ
= 1

1453 ,.
	gh‰p_mšÜ
= 1

1454 ,.
	g¡©us_code
= 200

1455 ,.
	g»¥Ú£_¡©us
= "OK"

1456 ,.
	gnum_h—d”s
= 11

1457 ,.
	gh—d”s
=

1470 ,.
	gbody
= ""

1471 ,.
	gnum_chunks_com¶‘e
= 1

1472 ,.
	gchunk_Ëngths
= {}

1475 
	#NON_ASCII_IN_STATUS_LINE
 10

	)

1477 , {.
	gÇme
= "non-ASCII in status†ine"

1478 ,.
	gty³
ğ
HTTP_RESPONSE


1479 ,.
	g¿w
= "HTTP/1.1 500 OriÃ«ntatieprobleem\r\n"

1484 ,.
	gshould_k“p_®ive
ğ
FALSE


1485 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1486 ,.
	gh‰p_majÜ
= 1

1487 ,.
	gh‰p_mšÜ
= 1

1488 ,.
	g¡©us_code
= 500

1489 ,.
	g»¥Ú£_¡©us
= "OriÃ«ntatieprobleem"

1490 ,.
	gnum_h—d”s
= 3

1491 ,.
	gh—d”s
=

1496 ,.
	gbody
= ""

1499 
	#HTTP_VERSION_0_9
 11

	)

1501 , {.
	gÇme
= "http version 0.9"

1502 ,.
	gty³
ğ
HTTP_RESPONSE


1503 ,.
	g¿w
= "HTTP/0.9 200 OK\r\n"

1505 ,.
	gshould_k“p_®ive
ğ
FALSE


1506 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
TRUE


1507 ,.
	gh‰p_majÜ
= 0

1508 ,.
	gh‰p_mšÜ
= 9

1509 ,.
	g¡©us_code
= 200

1510 ,.
	g»¥Ú£_¡©us
= "OK"

1511 ,.
	gnum_h—d”s
= 0

1512 ,.
	gh—d”s
=

1514 ,.
	gbody
= ""

1517 
	#NO_CONTENT_LENGTH_NO_TRANSFER_ENCODING_RESPONSE
 12

	)

1522 , {.
	gÇme
= "neither content-length‚orransfer-encoding„esponse"

1523 ,.
	gty³
ğ
HTTP_RESPONSE


1524 ,.
	g¿w
= "HTTP/1.1 200 OK\r\n"

1528 ,.
	gshould_k“p_®ive
ğ
FALSE


1529 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
TRUE


1530 ,.
	gh‰p_majÜ
= 1

1531 ,.
	gh‰p_mšÜ
= 1

1532 ,.
	g¡©us_code
= 200

1533 ,.
	g»¥Ú£_¡©us
= "OK"

1534 ,.
	gnum_h—d”s
= 1

1535 ,.
	gh—d”s
=

1538 ,.
	gbody
= "hello world"

1541 
	#NO_BODY_HTTP10_KA_200
 13

	)

1542 , {.
	gÇme
= "HTTP/1.0 with keep-alive‡nd EOF-terminated 200 status"

1543 ,.
	gty³
ğ
HTTP_RESPONSE


1544 ,.
	g¿w
= "HTTP/1.0 200 OK\r\n"

1547 ,.
	gshould_k“p_®ive
ğ
FALSE


1548 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
TRUE


1549 ,.
	gh‰p_majÜ
= 1

1550 ,.
	gh‰p_mšÜ
= 0

1551 ,.
	g¡©us_code
= 200

1552 ,.
	g»¥Ú£_¡©us
= "OK"

1553 ,.
	gnum_h—d”s
= 1

1554 ,.
	gh—d”s
=

1557 ,.
	gbody_size
= 0

1558 ,.
	gbody
= ""

1561 
	#NO_BODY_HTTP10_KA_204
 14

	)

1562 , {.
	gÇme
= "HTTP/1.0 with keep-alive‡nd‡ 204 status"

1563 ,.
	gty³
ğ
HTTP_RESPONSE


1564 ,.
	g¿w
= "HTTP/1.0 204 No content\r\n"

1567 ,.
	gshould_k“p_®ive
ğ
TRUE


1568 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1569 ,.
	gh‰p_majÜ
= 1

1570 ,.
	gh‰p_mšÜ
= 0

1571 ,.
	g¡©us_code
= 204

1572 ,.
	g»¥Ú£_¡©us
= "No content"

1573 ,.
	gnum_h—d”s
= 1

1574 ,.
	gh—d”s
=

1577 ,.
	gbody_size
= 0

1578 ,.
	gbody
= ""

1581 
	#NO_BODY_HTTP11_KA_200
 15

	)

1582 , {.
	gÇme
= "HTTP/1.1 with‡n EOF-terminated 200 status"

1583 ,.
	gty³
ğ
HTTP_RESPONSE


1584 ,.
	g¿w
= "HTTP/1.1 200 OK\r\n"

1586 ,.
	gshould_k“p_®ive
ğ
FALSE


1587 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
TRUE


1588 ,.
	gh‰p_majÜ
= 1

1589 ,.
	gh‰p_mšÜ
= 1

1590 ,.
	g¡©us_code
= 200

1591 ,.
	g»¥Ú£_¡©us
= "OK"

1592 ,.
	gnum_h—d”s
= 0

1593 ,.
	gh—d”s
={}

1594 ,.
	gbody_size
= 0

1595 ,.
	gbody
= ""

1598 
	#NO_BODY_HTTP11_KA_204
 16

	)

1599 , {.
	gÇme
= "HTTP/1.1 with‡ 204 status"

1600 ,.
	gty³
ğ
HTTP_RESPONSE


1601 ,.
	g¿w
= "HTTP/1.1 204 No content\r\n"

1603 ,.
	gshould_k“p_®ive
ğ
TRUE


1604 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1605 ,.
	gh‰p_majÜ
= 1

1606 ,.
	gh‰p_mšÜ
= 1

1607 ,.
	g¡©us_code
= 204

1608 ,.
	g»¥Ú£_¡©us
= "No content"

1609 ,.
	gnum_h—d”s
= 0

1610 ,.
	gh—d”s
={}

1611 ,.
	gbody_size
= 0

1612 ,.
	gbody
= ""

1615 
	#NO_BODY_HTTP11_NOKA_204
 17

	)

1616 , {.
	gÇme
= "HTTP/1.1 with‡ 204 status‡nd keep-alive disabled"

1617 ,.
	gty³
ğ
HTTP_RESPONSE


1618 ,.
	g¿w
= "HTTP/1.1 204 No content\r\n"

1621 ,.
	gshould_k“p_®ive
ğ
FALSE


1622 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1623 ,.
	gh‰p_majÜ
= 1

1624 ,.
	gh‰p_mšÜ
= 1

1625 ,.
	g¡©us_code
= 204

1626 ,.
	g»¥Ú£_¡©us
= "No content"

1627 ,.
	gnum_h—d”s
= 1

1628 ,.
	gh—d”s
=

1631 ,.
	gbody_size
= 0

1632 ,.
	gbody
= ""

1635 
	#NO_BODY_HTTP11_KA_CHUNKED_200
 18

	)

1636 , {.
	gÇme
= "HTTP/1.1 with chunkedƒndocing‡nd‡ 200„esponse"

1637 ,.
	gty³
ğ
HTTP_RESPONSE


1638 ,.
	g¿w
= "HTTP/1.1 200 OK\r\n"

1643 ,.
	gshould_k“p_®ive
ğ
TRUE


1644 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1645 ,.
	gh‰p_majÜ
= 1

1646 ,.
	gh‰p_mšÜ
= 1

1647 ,.
	g¡©us_code
= 200

1648 ,.
	g»¥Ú£_¡©us
= "OK"

1649 ,.
	gnum_h—d”s
= 1

1650 ,.
	gh—d”s
=

1653 ,.
	gbody_size
= 0

1654 ,.
	gbody
= ""

1655 ,.
	gnum_chunks_com¶‘e
= 1

1658 #ià!
HTTP_PARSER_STRICT


1659 
	#SPACE_IN_FIELD_RES
 19

	)

1661 , {.
	gÇme
= "field space"

1662 ,.
	gty³
ğ
HTTP_RESPONSE


1663 ,.
	g¿w
= "HTTP/1.1 200 OK\r\n"

1673 ,.
	gshould_k“p_®ive
ğ
TRUE


1674 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1675 ,.
	gh‰p_majÜ
= 1

1676 ,.
	gh‰p_mšÜ
= 1

1677 ,.
	g¡©us_code
= 200

1678 ,.
	g»¥Ú£_¡©us
= "OK"

1679 ,.
	gnum_h—d”s
= 7

1680 ,.
	gh—d”s
=

1689 ,.
	gbody
= "<xml>hello</xml>"

1693 
	#AMAZON_COM
 20

	)

1694 , {.
	gÇme
= "amazon.com"

1695 ,.
	gty³
ğ
HTTP_RESPONSE


1696 ,.
	g¿w
= "HTTP/1.1 301 MovedPermanently\r\n"

1711 ,.
	gshould_k“p_®ive
ğ
TRUE


1712 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1713 ,.
	gh‰p_majÜ
= 1

1714 ,.
	gh‰p_mšÜ
= 1

1715 ,.
	g¡©us_code
= 301

1716 ,.
	g»¥Ú£_¡©us
= "MovedPermanently"

1717 ,.
	gnum_h—d”s
= 9

1718 ,.
	gh—d”s
= { { "Date", "Wed, 15 May 2013 17:06:33 GMT" }

1728 ,.
	gbody
= "\n"

1729 ,.
	gnum_chunks_com¶‘e
= 2

1730 ,.
	gchunk_Ëngths
= { 1 }

1733 
	#EMPTY_REASON_PHRASE_AFTER_SPACE
 20

	)

1734 , {.
	gÇme
= "empty„eason…hrase‡fter space"

1735 ,.
	gty³
ğ
HTTP_RESPONSE


1736 ,.
	g¿w
= "HTTP/1.1 200 \r\n"

1738 ,.
	gshould_k“p_®ive
ğ
FALSE


1739 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
TRUE


1740 ,.
	gh‰p_majÜ
= 1

1741 ,.
	gh‰p_mšÜ
= 1

1742 ,.
	g¡©us_code
= 200

1743 ,.
	g»¥Ú£_¡©us
= ""

1744 ,.
	gnum_h—d”s
= 0

1745 ,.
	gh—d”s
= {}

1746 ,.
	gbody
= ""

1749 
	#CONTENT_LENGTH_X
 21

	)

1750 , {.
	gÇme
= "Content-Length-X"

1751 ,.
	gty³
ğ
HTTP_RESPONSE


1752 ,.
	g¿w
= "HTTP/1.1 200 OK\r\n"

1760 ,.
	gshould_k“p_®ive
ğ
TRUE


1761 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1762 ,.
	gh‰p_majÜ
= 1

1763 ,.
	gh‰p_mšÜ
= 1

1764 ,.
	g¡©us_code
= 200

1765 ,.
	g»¥Ú£_¡©us
= "OK"

1766 ,.
	gnum_h—d”s
= 2

1767 ,.
	gh—d”s
= { { "Content-Length-X", "0" }

1770 ,.
	gbody
= "OK"

1771 ,.
	gnum_chunks_com¶‘e
= 2

1772 ,.
	gchunk_Ëngths
= { 2 }

1775 
	#HTTP_101_RESPONSE_WITH_UPGRADE_HEADER
 22

	)

1776 , {.
	gÇme
= "HTTP 101„esponse with Upgrade header"

1777 ,.
	gty³
ğ
HTTP_RESPONSE


1778 ,.
	g¿w
= "HTTP/1.1 101 Switching Protocols\r\n"

1783 ,.
	gshould_k“p_®ive
ğ
TRUE


1784 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1785 ,.
	gh‰p_majÜ
= 1

1786 ,.
	gh‰p_mšÜ
= 1

1787 ,.
	g¡©us_code
= 101

1788 ,.
	g»¥Ú£_¡©us
= "Switching Protocols"

1789 ,.
	gupg¿de
= "proto"

1790 ,.
	gnum_h—d”s
= 2

1791 ,.
	gh—d”s
=

1797 
	#HTTP_101_RESPONSE_WITH_UPGRADE_HEADER_AND_CONTENT_LENGTH
 23

	)

1798 , {.
	gÇme
= "HTTP 101„esponse with Upgrade‡nd Content-Length header"

1799 ,.
	gty³
ğ
HTTP_RESPONSE


1800 ,.
	g¿w
= "HTTP/1.1 101 Switching Protocols\r\n"

1807 ,.
	gshould_k“p_®ive
ğ
TRUE


1808 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1809 ,.
	gh‰p_majÜ
= 1

1810 ,.
	gh‰p_mšÜ
= 1

1811 ,.
	g¡©us_code
= 101

1812 ,.
	g»¥Ú£_¡©us
= "Switching Protocols"

1813 ,.
	gbody
= "body"

1814 ,.
	gupg¿de
= "proto"

1815 ,.
	gnum_h—d”s
= 3

1816 ,.
	gh—d”s
=

1823 
	#HTTP_101_RESPONSE_WITH_UPGRADE_HEADER_AND_TRANSFER_ENCODING
 24

	)

1824 , {.
	gÇme
= "HTTP 101„esponse with Upgrade‡nd Transfer-Encoding header"

1825 ,.
	gty³
ğ
HTTP_RESPONSE


1826 ,.
	g¿w
= "HTTP/1.1 101 Switching Protocols\r\n"

1838 ,.
	gshould_k“p_®ive
ğ
TRUE


1839 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1840 ,.
	gh‰p_majÜ
= 1

1841 ,.
	gh‰p_mšÜ
= 1

1842 ,.
	g¡©us_code
= 101

1843 ,.
	g»¥Ú£_¡©us
= "Switching Protocols"

1844 ,.
	gbody
= "body"

1845 ,.
	gupg¿de
= "proto"

1846 ,.
	gnum_h—d”s
= 3

1847 ,.
	gh—d”s
=

1852 ,.
	gnum_chunks_com¶‘e
= 3

1853 ,.
	gchunk_Ëngths
= { 2, 2 }

1856 
	#HTTP_200_RESPONSE_WITH_UPGRADE_HEADER
 25

	)

1857 , {.
	gÇme
= "HTTP 200„esponse with Upgrade header"

1858 ,.
	gty³
ğ
HTTP_RESPONSE


1859 ,.
	g¿w
= "HTTP/1.1 200 OK\r\n"

1864 ,.
	gshould_k“p_®ive
ğ
FALSE


1865 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
TRUE


1866 ,.
	gh‰p_majÜ
= 1

1867 ,.
	gh‰p_mšÜ
= 1

1868 ,.
	g¡©us_code
= 200

1869 ,.
	g»¥Ú£_¡©us
= "OK"

1870 ,.
	gbody
= "body"

1871 ,.
	gupg¿de
ğ
NULL


1872 ,.
	gnum_h—d”s
= 2

1873 ,.
	gh—d”s
=

1879 
	#HTTP_200_RESPONSE_WITH_UPGRADE_HEADER_AND_CONTENT_LENGTH
 26

	)

1880 , {.
	gÇme
= "HTTP 200„esponse with Upgrade‡nd Content-Length header"

1881 ,.
	gty³
ğ
HTTP_RESPONSE


1882 ,.
	g¿w
= "HTTP/1.1 200 OK\r\n"

1888 ,.
	gshould_k“p_®ive
ğ
TRUE


1889 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1890 ,.
	gh‰p_majÜ
= 1

1891 ,.
	gh‰p_mšÜ
= 1

1892 ,.
	g¡©us_code
= 200

1893 ,.
	g»¥Ú£_¡©us
= "OK"

1894 ,.
	gnum_h—d”s
= 3

1895 ,.
	gbody
= "body"

1896 ,.
	gupg¿de
ğ
NULL


1897 ,.
	gh—d”s
=

1904 
	#HTTP_200_RESPONSE_WITH_UPGRADE_HEADER_AND_TRANSFER_ENCODING
 27

	)

1905 , {.
	gÇme
= "HTTP 200„esponse with Upgrade‡nd Transfer-Encoding header"

1906 ,.
	gty³
ğ
HTTP_RESPONSE


1907 ,.
	g¿w
= "HTTP/1.1 200 OK\r\n"

1918 ,.
	gshould_k“p_®ive
ğ
TRUE


1919 ,.
	gmes§ge_com¶‘e_Ú_eof
ğ
FALSE


1920 ,.
	gh‰p_majÜ
= 1

1921 ,.
	gh‰p_mšÜ
= 1

1922 ,.
	g¡©us_code
= 200

1923 ,.
	g»¥Ú£_¡©us
= "OK"

1924 ,.
	gnum_h—d”s
= 3

1925 ,.
	gbody
= "body"

1926 ,.
	gupg¿de
ğ
NULL


1927 ,.
	gh—d”s
=

1932 ,.
	gnum_chunks_com¶‘e
= 3

1933 ,.
	gchunk_Ëngths
= { 2, 2 }

1936 , {.
	gÇme
ğ
NULL
 }

1942 
size_t


1943 
	$¡ºËn
(cÚ¡ *
s
, 
size_t
 
maxËn
)

1945 cÚ¡ *
p
;

1947 
p
 = 
	`memchr
(
s
, '\0', 
maxËn
);

1948 ià(
p
 =ğ
NULL
)

1949  
maxËn
;

1951  
p
 - 
s
;

1952 
	}
}

1954 
size_t


1955 
	$¡¾nÿt
(*
d¡
, 
size_t
 
Ën
, cÚ¡ *
¤c
, size_ˆ
n
)

1957 
size_t
 
¦’
;

1958 
size_t
 
dËn
;

1959 
size_t
 
¾’
;

1960 
size_t
 
nıy
;

1962 
¦’
 = 
	`¡ºËn
(
¤c
, 
n
);

1963 
dËn
 = 
	`¡ºËn
(
d¡
, 
Ën
);

1965 ià(
dËn
 < 
Ën
) {

1966 
¾’
 = 
Ën
 - 
dËn
;

1967 
nıy
 = 
¦’
 < 
¾’
 ? slen : (rlen - 1);

1968 
	`memıy
(
d¡
 + 
dËn
, 
¤c
, 
nıy
);

1969 
d¡
[
dËn
 + 
nıy
] = '\0';

1972 
	`as£¹
(
Ën
 > 
¦’
 + 
dËn
);

1973  
¦’
 + 
dËn
;

1974 
	}
}

1976 
size_t


1977 
	$¡¾ÿt
(*
d¡
, cÚ¡ *
¤c
, 
size_t
 
Ën
)

1979  
	`¡¾nÿt
(
d¡
, 
Ën
, 
¤c
, (
size_t
) -1);

1980 
	}
}

1982 
size_t


1983 
	$¡¾nıy
(*
d¡
, 
size_t
 
Ën
, cÚ¡ *
¤c
, size_ˆ
n
)

1985 
size_t
 
¦’
;

1986 
size_t
 
nıy
;

1988 
¦’
 = 
	`¡ºËn
(
¤c
, 
n
);

1990 ià(
Ën
 > 0) {

1991 
nıy
 = 
¦’
 < 
Ën
 ? slen : (len - 1);

1992 
	`memıy
(
d¡
, 
¤c
, 
nıy
);

1993 
d¡
[
nıy
] = '\0';

1996 
	`as£¹
(
Ën
 > 
¦’
);

1997  
¦’
;

1998 
	}
}

2000 
size_t


2001 
	$¡¾ıy
(*
d¡
, cÚ¡ *
¤c
, 
size_t
 
Ën
)

2003  
	`¡¾nıy
(
d¡
, 
Ën
, 
¤c
, (
size_t
) -1);

2004 
	}
}

2007 
	$»que¡_u¾_cb
 (
h‰p_·r£r
 *
p
, cÚ¡ *
buf
, 
size_t
 
Ën
)

2009 
	`as£¹
(
p
 =ğ
·r£r
);

2010 
	`¡¾nÿt
(
mes§ges
[
num_mes§ges
].
»que¡_u¾
,

2011 (
mes§ges
[
num_mes§ges
].
»que¡_u¾
),

2012 
buf
,

2013 
Ën
);

2015 
	}
}

2018 
	$h—d”_f›ld_cb
 (
h‰p_·r£r
 *
p
, cÚ¡ *
buf
, 
size_t
 
Ën
)

2020 
	`as£¹
(
p
 =ğ
·r£r
);

2021 
mes§ge
 *
m
 = &
mes§ges
[
num_mes§ges
];

2023 ià(
m
->
Ï¡_h—d”_–em’t
 !ğ
FIELD
)

2024 
m
->
num_h—d”s
++;

2026 
	`¡¾nÿt
(
m
->
h—d”s
[m->
num_h—d”s
-1][0],

2027 (
m
->
h—d”s
[m->
num_h—d”s
-1][0]),

2028 
buf
,

2029 
Ën
);

2031 
m
->
Ï¡_h—d”_–em’t
 = 
FIELD
;

2034 
	}
}

2037 
	$h—d”_v®ue_cb
 (
h‰p_·r£r
 *
p
, cÚ¡ *
buf
, 
size_t
 
Ën
)

2039 
	`as£¹
(
p
 =ğ
·r£r
);

2040 
mes§ge
 *
m
 = &
mes§ges
[
num_mes§ges
];

2042 
	`¡¾nÿt
(
m
->
h—d”s
[m->
num_h—d”s
-1][1],

2043 (
m
->
h—d”s
[m->
num_h—d”s
-1][1]),

2044 
buf
,

2045 
Ën
);

2047 
m
->
Ï¡_h—d”_–em’t
 = 
VALUE
;

2050 
	}
}

2053 
	$check_body_is_fš®
 (cÚ¡ 
h‰p_·r£r
 *
p
)

2055 ià(
mes§ges
[
num_mes§ges
].
body_is_fš®
) {

2056 
	`årštf
(
¡d”r
, "\n\n *** Error http_body_is_final() should„eturn 1 "

2059 
	`as£¹
(0);

2060 
	`abÜt
();

2062 
mes§ges
[
num_mes§ges
].
body_is_fš®
 = 
	`h‰p_body_is_fš®
(
p
);

2063 
	}
}

2066 
	$body_cb
 (
h‰p_·r£r
 *
p
, cÚ¡ *
buf
, 
size_t
 
Ën
)

2068 
	`as£¹
(
p
 =ğ
·r£r
);

2069 
	`¡¾nÿt
(
mes§ges
[
num_mes§ges
].
body
,

2070 (
mes§ges
[
num_mes§ges
].
body
),

2071 
buf
,

2072 
Ën
);

2073 
mes§ges
[
num_mes§ges
].
body_size
 +ğ
Ën
;

2074 
	`check_body_is_fš®
(
p
);

2077 
	}
}

2080 
	$couÁ_body_cb
 (
h‰p_·r£r
 *
p
, cÚ¡ *
buf
, 
size_t
 
Ën
)

2082 
	`as£¹
(
p
 =ğ
·r£r
);

2083 
	`as£¹
(
buf
);

2084 
mes§ges
[
num_mes§ges
].
body_size
 +ğ
Ën
;

2085 
	`check_body_is_fš®
(
p
);

2087 
	}
}

2090 
	$mes§ge_begš_cb
 (
h‰p_·r£r
 *
p
)

2092 
	`as£¹
(
p
 =ğ
·r£r
);

2093 
mes§ges
[
num_mes§ges
].
mes§ge_begš_cb_ÿÎed
 = 
TRUE
;

2095 
	}
}

2098 
	$h—d”s_com¶‘e_cb
 (
h‰p_·r£r
 *
p
)

2100 
	`as£¹
(
p
 =ğ
·r£r
);

2101 
mes§ges
[
num_mes§ges
].
m‘hod
 = 
·r£r
->method;

2102 
mes§ges
[
num_mes§ges
].
¡©us_code
 = 
·r£r
->status_code;

2103 
mes§ges
[
num_mes§ges
].
h‰p_majÜ
 = 
·r£r
->http_major;

2104 
mes§ges
[
num_mes§ges
].
h‰p_mšÜ
 = 
·r£r
->http_minor;

2105 
mes§ges
[
num_mes§ges
].
h—d”s_com¶‘e_cb_ÿÎed
 = 
TRUE
;

2106 
mes§ges
[
num_mes§ges
].
should_k“p_®ive
 = 
	`h‰p_should_k“p_®ive
(
·r£r
);

2108 
	}
}

2111 
	$mes§ge_com¶‘e_cb
 (
h‰p_·r£r
 *
p
)

2113 
	`as£¹
(
p
 =ğ
·r£r
);

2114 ià(
mes§ges
[
num_mes§ges
].
should_k“p_®ive
 !ğ
	`h‰p_should_k“p_®ive
(
·r£r
))

2116 
	`årštf
(
¡d”r
, "\n\n *** Error http_should_keep_alive() should have same "

2119 
	`as£¹
(0);

2120 
	`abÜt
();

2123 ià(
mes§ges
[
num_mes§ges
].
body_size
 &&

2124 
	`h‰p_body_is_fš®
(
p
) &&

2125 !
mes§ges
[
num_mes§ges
].
body_is_fš®
)

2127 
	`årštf
(
¡d”r
, "\n\n *** Error http_body_is_final() should„eturn 1 "

2130 
	`as£¹
(0);

2131 
	`abÜt
();

2134 
mes§ges
[
num_mes§ges
].
mes§ge_com¶‘e_cb_ÿÎed
 = 
TRUE
;

2136 
mes§ges
[
num_mes§ges
].
mes§ge_com¶‘e_Ú_eof
 = 
cu¼’y_·rsšg_eof
;

2138 
num_mes§ges
++;

2140 
	}
}

2143 
	$»¥Ú£_¡©us_cb
 (
h‰p_·r£r
 *
p
, cÚ¡ *
buf
, 
size_t
 
Ën
)

2145 
	`as£¹
(
p
 =ğ
·r£r
);

2147 
mes§ges
[
num_mes§ges
].
¡©us_cb_ÿÎed
 = 
TRUE
;

2149 
	`¡¾nÿt
(
mes§ges
[
num_mes§ges
].
»¥Ú£_¡©us
,

2150 (
mes§ges
[
num_mes§ges
].
»¥Ú£_¡©us
),

2151 
buf
,

2152 
Ën
);

2154 
	}
}

2157 
	$chunk_h—d”_cb
 (
h‰p_·r£r
 *
p
)

2159 
	`as£¹
(
p
 =ğ
·r£r
);

2160 
chunk_idx
 = 
mes§ges
[
num_mes§ges
].
num_chunks
;

2161 
mes§ges
[
num_mes§ges
].
num_chunks
++;

2162 ià(
chunk_idx
 < 
MAX_CHUNKS
) {

2163 
mes§ges
[
num_mes§ges
].
chunk_Ëngths
[
chunk_idx
] = 
p
->
cÚ‹Á_Ëngth
;

2167 
	}
}

2170 
	$chunk_com¶‘e_cb
 (
h‰p_·r£r
 *
p
)

2172 
	`as£¹
(
p
 =ğ
·r£r
);

2178 
	`as£¹
(
mes§ges
[
num_mes§ges
].
num_chunks
 ==

2179 
mes§ges
[
num_mes§ges
].
num_chunks_com¶‘e
 + 1);

2181 
mes§ges
[
num_mes§ges
].
num_chunks_com¶‘e
++;

2183 
	}
}

2188 
	$dÚtÿÎ_mes§ge_begš_cb
 (
h‰p_·r£r
 *
p
)

2190 ià(
p
) { }

2191 
	`årštf
(
¡d”r
, "\n\n*** on_message_begin() called on…aused…arser ***\n\n");

2192 
	`abÜt
();

2193 
	}
}

2196 
	$dÚtÿÎ_h—d”_f›ld_cb
 (
h‰p_·r£r
 *
p
, cÚ¡ *
buf
, 
size_t
 
Ën
)

2198 ià(
p
 || 
buf
 || 
Ën
) { }

2199 
	`årštf
(
¡d”r
, "\n\n*** on_header_field() called on…aused…arser ***\n\n");

2200 
	`abÜt
();

2201 
	}
}

2204 
	$dÚtÿÎ_h—d”_v®ue_cb
 (
h‰p_·r£r
 *
p
, cÚ¡ *
buf
, 
size_t
 
Ën
)

2206 ià(
p
 || 
buf
 || 
Ën
) { }

2207 
	`årštf
(
¡d”r
, "\n\n*** on_header_value() called on…aused…arser ***\n\n");

2208 
	`abÜt
();

2209 
	}
}

2212 
	$dÚtÿÎ_»que¡_u¾_cb
 (
h‰p_·r£r
 *
p
, cÚ¡ *
buf
, 
size_t
 
Ën
)

2214 ià(
p
 || 
buf
 || 
Ën
) { }

2215 
	`årštf
(
¡d”r
, "\n\n*** on_request_url() called on…aused…arser ***\n\n");

2216 
	`abÜt
();

2217 
	}
}

2220 
	$dÚtÿÎ_body_cb
 (
h‰p_·r£r
 *
p
, cÚ¡ *
buf
, 
size_t
 
Ën
)

2222 ià(
p
 || 
buf
 || 
Ën
) { }

2223 
	`årštf
(
¡d”r
, "\n\n*** on_body_cb() called on…aused…arser ***\n\n");

2224 
	`abÜt
();

2225 
	}
}

2228 
	$dÚtÿÎ_h—d”s_com¶‘e_cb
 (
h‰p_·r£r
 *
p
)

2230 ià(
p
) { }

2231 
	`årštf
(
¡d”r
, "\n\n*** on_headers_complete() called on…aused "

2233 
	`abÜt
();

2234 
	}
}

2237 
	$dÚtÿÎ_mes§ge_com¶‘e_cb
 (
h‰p_·r£r
 *
p
)

2239 ià(
p
) { }

2240 
	`årštf
(
¡d”r
, "\n\n*** on_message_complete() called on…aused "

2242 
	`abÜt
();

2243 
	}
}

2246 
	$dÚtÿÎ_»¥Ú£_¡©us_cb
 (
h‰p_·r£r
 *
p
, cÚ¡ *
buf
, 
size_t
 
Ën
)

2248 ià(
p
 || 
buf
 || 
Ën
) { }

2249 
	`årštf
(
¡d”r
, "\n\n*** on_status() called on…aused…arser ***\n\n");

2250 
	`abÜt
();

2251 
	}
}

2254 
	$dÚtÿÎ_chunk_h—d”_cb
 (
h‰p_·r£r
 *
p
)

2256 ià(
p
) { }

2257 
	`årštf
(
¡d”r
, "\n\n*** on_chunk_header() called on…aused…arser ***\n\n");

2258 
	`ex™
(1);

2259 
	}
}

2262 
	$dÚtÿÎ_chunk_com¶‘e_cb
 (
h‰p_·r£r
 *
p
)

2264 ià(
p
) { }

2265 
	`årštf
(
¡d”r
, "\n\n*** on_chunk_complete() "

2267 
	`ex™
(1);

2268 
	}
}

2270 
h‰p_·r£r_£‰šgs
 
	g£‰šgs_dÚtÿÎ
 =

2271 {.
Ú_mes§ge_begš
 = 
dÚtÿÎ_mes§ge_begš_cb


2272 ,.
	gÚ_h—d”_f›ld
 = 
dÚtÿÎ_h—d”_f›ld_cb


2273 ,.
	gÚ_h—d”_v®ue
 = 
dÚtÿÎ_h—d”_v®ue_cb


2274 ,.
	gÚ_u¾
 = 
dÚtÿÎ_»que¡_u¾_cb


2275 ,.
	gÚ_¡©us
 = 
dÚtÿÎ_»¥Ú£_¡©us_cb


2276 ,.
	gÚ_body
 = 
dÚtÿÎ_body_cb


2277 ,.
	gÚ_h—d”s_com¶‘e
 = 
dÚtÿÎ_h—d”s_com¶‘e_cb


2278 ,.
	gÚ_mes§ge_com¶‘e
 = 
dÚtÿÎ_mes§ge_com¶‘e_cb


2279 ,.
	gÚ_chunk_h—d”
 = 
dÚtÿÎ_chunk_h—d”_cb


2280 ,.
	gÚ_chunk_com¶‘e
 = 
dÚtÿÎ_chunk_com¶‘e_cb


2288 
	$·u£_mes§ge_begš_cb
 (
h‰p_·r£r
 *
p
)

2290 
	`h‰p_·r£r_·u£
(
p
, 1);

2291 *
cu¼’t_·u£_·r£r
 = 
£‰šgs_dÚtÿÎ
;

2292  
	`mes§ge_begš_cb
(
p
);

2293 
	}
}

2296 
	$·u£_h—d”_f›ld_cb
 (
h‰p_·r£r
 *
p
, cÚ¡ *
buf
, 
size_t
 
Ën
)

2298 
	`h‰p_·r£r_·u£
(
p
, 1);

2299 *
cu¼’t_·u£_·r£r
 = 
£‰šgs_dÚtÿÎ
;

2300  
	`h—d”_f›ld_cb
(
p
, 
buf
, 
Ën
);

2301 
	}
}

2304 
	$·u£_h—d”_v®ue_cb
 (
h‰p_·r£r
 *
p
, cÚ¡ *
buf
, 
size_t
 
Ën
)

2306 
	`h‰p_·r£r_·u£
(
p
, 1);

2307 *
cu¼’t_·u£_·r£r
 = 
£‰šgs_dÚtÿÎ
;

2308  
	`h—d”_v®ue_cb
(
p
, 
buf
, 
Ën
);

2309 
	}
}

2312 
	$·u£_»que¡_u¾_cb
 (
h‰p_·r£r
 *
p
, cÚ¡ *
buf
, 
size_t
 
Ën
)

2314 
	`h‰p_·r£r_·u£
(
p
, 1);

2315 *
cu¼’t_·u£_·r£r
 = 
£‰šgs_dÚtÿÎ
;

2316  
	`»que¡_u¾_cb
(
p
, 
buf
, 
Ën
);

2317 
	}
}

2320 
	$·u£_body_cb
 (
h‰p_·r£r
 *
p
, cÚ¡ *
buf
, 
size_t
 
Ën
)

2322 
	`h‰p_·r£r_·u£
(
p
, 1);

2323 *
cu¼’t_·u£_·r£r
 = 
£‰šgs_dÚtÿÎ
;

2324  
	`body_cb
(
p
, 
buf
, 
Ën
);

2325 
	}
}

2328 
	$·u£_h—d”s_com¶‘e_cb
 (
h‰p_·r£r
 *
p
)

2330 
	`h‰p_·r£r_·u£
(
p
, 1);

2331 *
cu¼’t_·u£_·r£r
 = 
£‰šgs_dÚtÿÎ
;

2332  
	`h—d”s_com¶‘e_cb
(
p
);

2333 
	}
}

2336 
	$·u£_mes§ge_com¶‘e_cb
 (
h‰p_·r£r
 *
p
)

2338 
	`h‰p_·r£r_·u£
(
p
, 1);

2339 *
cu¼’t_·u£_·r£r
 = 
£‰šgs_dÚtÿÎ
;

2340  
	`mes§ge_com¶‘e_cb
(
p
);

2341 
	}
}

2344 
	$·u£_»¥Ú£_¡©us_cb
 (
h‰p_·r£r
 *
p
, cÚ¡ *
buf
, 
size_t
 
Ën
)

2346 
	`h‰p_·r£r_·u£
(
p
, 1);

2347 *
cu¼’t_·u£_·r£r
 = 
£‰šgs_dÚtÿÎ
;

2348  
	`»¥Ú£_¡©us_cb
(
p
, 
buf
, 
Ën
);

2349 
	}
}

2352 
	$·u£_chunk_h—d”_cb
 (
h‰p_·r£r
 *
p
)

2354 
	`h‰p_·r£r_·u£
(
p
, 1);

2355 *
cu¼’t_·u£_·r£r
 = 
£‰šgs_dÚtÿÎ
;

2356  
	`chunk_h—d”_cb
(
p
);

2357 
	}
}

2360 
	$·u£_chunk_com¶‘e_cb
 (
h‰p_·r£r
 *
p
)

2362 
	`h‰p_·r£r_·u£
(
p
, 1);

2363 *
cu¼’t_·u£_·r£r
 = 
£‰šgs_dÚtÿÎ
;

2364  
	`chunk_com¶‘e_cb
(
p
);

2365 
	}
}

2368 
	$cÚÃù_h—d”s_com¶‘e_cb
 (
h‰p_·r£r
 *
p
)

2370 
	`h—d”s_com¶‘e_cb
(
p
);

2372 
	}
}

2375 
	$cÚÃù_mes§ge_com¶‘e_cb
 (
h‰p_·r£r
 *
p
)

2377 
mes§ges
[
num_mes§ges
].
should_k“p_®ive
 = 
	`h‰p_should_k“p_®ive
(
·r£r
);

2378  
	`mes§ge_com¶‘e_cb
(
p
);

2379 
	}
}

2381 
h‰p_·r£r_£‰šgs
 
	g£‰šgs_·u£
 =

2382 {.
Ú_mes§ge_begš
 = 
·u£_mes§ge_begš_cb


2383 ,.
	gÚ_h—d”_f›ld
 = 
·u£_h—d”_f›ld_cb


2384 ,.
	gÚ_h—d”_v®ue
 = 
·u£_h—d”_v®ue_cb


2385 ,.
	gÚ_u¾
 = 
·u£_»que¡_u¾_cb


2386 ,.
	gÚ_¡©us
 = 
·u£_»¥Ú£_¡©us_cb


2387 ,.
	gÚ_body
 = 
·u£_body_cb


2388 ,.
	gÚ_h—d”s_com¶‘e
 = 
·u£_h—d”s_com¶‘e_cb


2389 ,.
	gÚ_mes§ge_com¶‘e
 = 
·u£_mes§ge_com¶‘e_cb


2390 ,.
	gÚ_chunk_h—d”
 = 
·u£_chunk_h—d”_cb


2391 ,.
	gÚ_chunk_com¶‘e
 = 
·u£_chunk_com¶‘e_cb


2394 
h‰p_·r£r_£‰šgs
 
	g£‰šgs
 =

2395 {.
Ú_mes§ge_begš
 = 
mes§ge_begš_cb


2396 ,.
	gÚ_h—d”_f›ld
 = 
h—d”_f›ld_cb


2397 ,.
	gÚ_h—d”_v®ue
 = 
h—d”_v®ue_cb


2398 ,.
	gÚ_u¾
 = 
»que¡_u¾_cb


2399 ,.
	gÚ_¡©us
 = 
»¥Ú£_¡©us_cb


2400 ,.
	gÚ_body
 = 
body_cb


2401 ,.
	gÚ_h—d”s_com¶‘e
 = 
h—d”s_com¶‘e_cb


2402 ,.
	gÚ_mes§ge_com¶‘e
 = 
mes§ge_com¶‘e_cb


2403 ,.
	gÚ_chunk_h—d”
 = 
chunk_h—d”_cb


2404 ,.
	gÚ_chunk_com¶‘e
 = 
chunk_com¶‘e_cb


2407 
h‰p_·r£r_£‰šgs
 
	g£‰šgs_couÁ_body
 =

2408 {.
Ú_mes§ge_begš
 = 
mes§ge_begš_cb


2409 ,.
	gÚ_h—d”_f›ld
 = 
h—d”_f›ld_cb


2410 ,.
	gÚ_h—d”_v®ue
 = 
h—d”_v®ue_cb


2411 ,.
	gÚ_u¾
 = 
»que¡_u¾_cb


2412 ,.
	gÚ_¡©us
 = 
»¥Ú£_¡©us_cb


2413 ,.
	gÚ_body
 = 
couÁ_body_cb


2414 ,.
	gÚ_h—d”s_com¶‘e
 = 
h—d”s_com¶‘e_cb


2415 ,.
	gÚ_mes§ge_com¶‘e
 = 
mes§ge_com¶‘e_cb


2416 ,.
	gÚ_chunk_h—d”
 = 
chunk_h—d”_cb


2417 ,.
	gÚ_chunk_com¶‘e
 = 
chunk_com¶‘e_cb


2420 
h‰p_·r£r_£‰šgs
 
	g£‰šgs_cÚÃù
 =

2421 {.
Ú_mes§ge_begš
 = 
mes§ge_begš_cb


2422 ,.
	gÚ_h—d”_f›ld
 = 
h—d”_f›ld_cb


2423 ,.
	gÚ_h—d”_v®ue
 = 
h—d”_v®ue_cb


2424 ,.
	gÚ_u¾
 = 
»que¡_u¾_cb


2425 ,.
	gÚ_¡©us
 = 
»¥Ú£_¡©us_cb


2426 ,.
	gÚ_body
 = 
dÚtÿÎ_body_cb


2427 ,.
	gÚ_h—d”s_com¶‘e
 = 
cÚÃù_h—d”s_com¶‘e_cb


2428 ,.
	gÚ_mes§ge_com¶‘e
 = 
cÚÃù_mes§ge_com¶‘e_cb


2429 ,.
	gÚ_chunk_h—d”
 = 
chunk_h—d”_cb


2430 ,.
	gÚ_chunk_com¶‘e
 = 
chunk_com¶‘e_cb


2433 
h‰p_·r£r_£‰šgs
 
	g£‰šgs_nuÎ
 =

2434 {.
Ú_mes§ge_begš
 = 0

2435 ,.
	gÚ_h—d”_f›ld
 = 0

2436 ,.
	gÚ_h—d”_v®ue
 = 0

2437 ,.
	gÚ_u¾
 = 0

2438 ,.
	gÚ_¡©us
 = 0

2439 ,.
	gÚ_body
 = 0

2440 ,.
	gÚ_h—d”s_com¶‘e
 = 0

2441 ,.
	gÚ_mes§ge_com¶‘e
 = 0

2442 ,.
	gÚ_chunk_h—d”
 = 0

2443 ,.
	gÚ_chunk_com¶‘e
 = 0

2447 
	$·r£r_š™
 (
h‰p_·r£r_ty³
 
ty³
)

2449 
num_mes§ges
 = 0;

2451 
	`as£¹
(
·r£r
 =ğ
NULL
);

2453 
·r£r
 = 
	`m®loc
((
h‰p_·r£r
));

2455 
	`h‰p_·r£r_š™
(
·r£r
, 
ty³
);

2457 
	`mem£t
(&
mes§ges
, 0,  messages);

2459 
	}
}

2462 
	$·r£r_ä“
 ()

2464 
	`as£¹
(
·r£r
);

2465 
	`ä“
(
·r£r
);

2466 
·r£r
 = 
NULL
;

2467 
	}
}

2469 
size_t
 
	$·r£
 (cÚ¡ *
buf
, 
size_t
 
Ën
)

2471 
size_t
 
Å¬£d
;

2472 
cu¼’y_·rsšg_eof
 = (
Ën
 == 0);

2473 
Å¬£d
 = 
	`h‰p_·r£r_execu‹
(
·r£r
, &
£‰šgs
, 
buf
, 
Ën
);

2474  
Å¬£d
;

2475 
	}
}

2477 
size_t
 
	$·r£_couÁ_body
 (cÚ¡ *
buf
, 
size_t
 
Ën
)

2479 
size_t
 
Å¬£d
;

2480 
cu¼’y_·rsšg_eof
 = (
Ën
 == 0);

2481 
Å¬£d
 = 
	`h‰p_·r£r_execu‹
(
·r£r
, &
£‰šgs_couÁ_body
, 
buf
, 
Ën
);

2482  
Å¬£d
;

2483 
	}
}

2485 
size_t
 
	$·r£_·u£
 (cÚ¡ *
buf
, 
size_t
 
Ën
)

2487 
size_t
 
Å¬£d
;

2488 
h‰p_·r£r_£‰šgs
 
s
 = 
£‰šgs_·u£
;

2490 
cu¼’y_·rsšg_eof
 = (
Ën
 == 0);

2491 
cu¼’t_·u£_·r£r
 = &
s
;

2492 
Å¬£d
 = 
	`h‰p_·r£r_execu‹
(
·r£r
, 
cu¼’t_·u£_·r£r
, 
buf
, 
Ën
);

2493  
Å¬£d
;

2494 
	}
}

2496 
size_t
 
	$·r£_cÚÃù
 (cÚ¡ *
buf
, 
size_t
 
Ën
)

2498 
size_t
 
Å¬£d
;

2499 
cu¼’y_·rsšg_eof
 = (
Ën
 == 0);

2500 
Å¬£d
 = 
	`h‰p_·r£r_execu‹
(
·r£r
, &
£‰šgs_cÚÃù
, 
buf
, 
Ën
);

2501  
Å¬£d
;

2502 
	}
}

2504 
šlše
 

2505 
	$check_¡r_eq
 (cÚ¡ 
mes§ge
 *
m
,

2506 cÚ¡ *
´İ
,

2507 cÚ¡ *
ex³ùed
,

2508 cÚ¡ *
found
) {

2509 ià((
ex³ùed
 =ğ
NULL
è!ğ(
found
 == NULL)) {

2510 
	`´štf
("\n*** E¼Ü: % š '%s' ***\n\n", 
´İ
, 
m
->
Çme
);

2511 
	`´štf
("ex³ùed %s\n", (
ex³ùed
 =ğ
NULL
) ? "NULL" :ƒxpected);

2512 
	`´štf
(" found %s\n", (
found
 =ğ
NULL
) ? "NULL" : found);

2515 ià(
ex³ùed
 !ğ
NULL
 && 0 !ğ
	`¡rcmp
Óx³ùed, 
found
)) {

2516 
	`´štf
("\n*** E¼Ü: % š '%s' ***\n\n", 
´İ
, 
m
->
Çme
);

2517 
	`´štf
("ex³ùed '%s'\n", 
ex³ùed
);

2518 
	`´štf
(" found '%s'\n", 
found
);

2522 
	}
}

2524 
šlše
 

2525 
	$check_num_eq
 (cÚ¡ 
mes§ge
 *
m
,

2526 cÚ¡ *
´İ
,

2527 
ex³ùed
,

2528 
found
) {

2529 ià(
ex³ùed
 !ğ
found
) {

2530 
	`´štf
("\n*** E¼Ü: % š '%s' ***\n\n", 
´İ
, 
m
->
Çme
);

2531 
	`´štf
("ex³ùed %d\n", 
ex³ùed
);

2532 
	`´štf
(" found %d\n", 
found
);

2536 
	}
}

2538 
	#MESSAGE_CHECK_STR_EQ
(
ex³ùed
, 
found
, 
´İ
) \

2539 ià(!
	`check_¡r_eq
(
ex³ùed
, #´İ,ƒx³ùed->
´İ
, 
found
->´İ)è 0

	)

2541 
	#MESSAGE_CHECK_NUM_EQ
(
ex³ùed
, 
found
, 
´İ
) \

2542 ià(!
	`check_num_eq
(
ex³ùed
, #´İ,ƒx³ùed->
´İ
, 
found
->´İ)è 0

	)

2544 
	#MESSAGE_CHECK_URL_EQ
(
u
, 
ex³ùed
, 
found
, 
´İ
, 
â
) \

2546 
ubuf
[256]; \

2548 ià((
u
)->
f›ld_£t
 & (1 << (
â
))) { \

2549 
	`memıy
(
ubuf
, (
found
)->
»que¡_u¾
 + (
u
)->
f›ld_d©a
[(
â
)].
off
, \

2550 (
u
)->
f›ld_d©a
[(
â
)].
Ën
); \

2551 
ubuf
[(
u
)->
f›ld_d©a
[(
â
)].
Ën
] = '\0'; \

2553 
ubuf
[0] = '\0'; \

2556 
	`check_¡r_eq
(
ex³ùed
, #´İ,ƒx³ùed->
´İ
, 
ubuf
); \

2557 } 0)

	)

2560 
	$mes§ge_eq
 (
šdex
, 
cÚÃù
, cÚ¡ 
mes§ge
 *
ex³ùed
)

2562 
i
;

2563 
mes§ge
 *
m
 = &
mes§ges
[
šdex
];

2565 
	`MESSAGE_CHECK_NUM_EQ
(
ex³ùed
, 
m
, 
h‰p_majÜ
);

2566 
	`MESSAGE_CHECK_NUM_EQ
(
ex³ùed
, 
m
, 
h‰p_mšÜ
);

2568 ià(
ex³ùed
->
ty³
 =ğ
HTTP_REQUEST
) {

2569 
	`MESSAGE_CHECK_NUM_EQ
(
ex³ùed
, 
m
, 
m‘hod
);

2571 
	`MESSAGE_CHECK_NUM_EQ
(
ex³ùed
, 
m
, 
¡©us_code
);

2572 
	`MESSAGE_CHECK_STR_EQ
(
ex³ùed
, 
m
, 
»¥Ú£_¡©us
);

2573 
	`as£¹
(
m
->
¡©us_cb_ÿÎed
);

2576 ià(!
cÚÃù
) {

2577 
	`MESSAGE_CHECK_NUM_EQ
(
ex³ùed
, 
m
, 
should_k“p_®ive
);

2578 
	`MESSAGE_CHECK_NUM_EQ
(
ex³ùed
, 
m
, 
mes§ge_com¶‘e_Ú_eof
);

2581 
	`as£¹
(
m
->
mes§ge_begš_cb_ÿÎed
);

2582 
	`as£¹
(
m
->
h—d”s_com¶‘e_cb_ÿÎed
);

2583 
	`as£¹
(
m
->
mes§ge_com¶‘e_cb_ÿÎed
);

2586 
	`MESSAGE_CHECK_STR_EQ
(
ex³ùed
, 
m
, 
»que¡_u¾
);

2591 ià(*
m
->
»que¡_u¾
 && m->
m‘hod
 !ğ
HTTP_CONNECT
) {

2592 
h‰p_·r£r_u¾
 
u
;

2594 ià(
	`h‰p_·r£r_·r£_u¾
(
m
->
»que¡_u¾
, 
	`¡¾’
(m->»que¡_u¾), 0, &
u
)) {

2595 
	`årštf
(
¡d”r
, "\n\n*** failedo…arse URL %s ***\n\n",

2596 
m
->
»que¡_u¾
);

2597 
	`abÜt
();

2600 ià(
ex³ùed
->
ho¡
) {

2601 
	`MESSAGE_CHECK_URL_EQ
(&
u
, 
ex³ùed
, 
m
, 
ho¡
, 
UF_HOST
);

2604 ià(
ex³ùed
->
u£ršfo
) {

2605 
	`MESSAGE_CHECK_URL_EQ
(&
u
, 
ex³ùed
, 
m
, 
u£ršfo
, 
UF_USERINFO
);

2608 
m
->
pÜt
 = (
u
.
f›ld_£t
 & (1 << 
UF_PORT
)) ?

2609 
u
.
pÜt
 : 0;

2611 
	`MESSAGE_CHECK_URL_EQ
(&
u
, 
ex³ùed
, 
m
, 
qu”y_¡ršg
, 
UF_QUERY
);

2612 
	`MESSAGE_CHECK_URL_EQ
(&
u
, 
ex³ùed
, 
m
, 
äagm’t
, 
UF_FRAGMENT
);

2613 
	`MESSAGE_CHECK_URL_EQ
(&
u
, 
ex³ùed
, 
m
, 
»que¡_·th
, 
UF_PATH
);

2614 
	`MESSAGE_CHECK_NUM_EQ
(
ex³ùed
, 
m
, 
pÜt
);

2617 ià(
cÚÃù
) {

2618 
	`check_num_eq
(
m
, "body_size", 0, m->
body_size
);

2619 } ià(
ex³ùed
->
body_size
) {

2620 
	`MESSAGE_CHECK_NUM_EQ
(
ex³ùed
, 
m
, 
body_size
);

2622 
	`MESSAGE_CHECK_STR_EQ
(
ex³ùed
, 
m
, 
body
);

2625 ià(
cÚÃù
) {

2626 
	`check_num_eq
(
m
, "num_chunks_com¶‘e", 0, m->
num_chunks_com¶‘e
);

2628 
	`as£¹
(
m
->
num_chunks
 =ğm->
num_chunks_com¶‘e
);

2629 
	`MESSAGE_CHECK_NUM_EQ
(
ex³ùed
, 
m
, 
num_chunks_com¶‘e
);

2630 
i
 = 0; i < 
m
->
num_chunks
 && i < 
MAX_CHUNKS
; i++) {

2631 
	`MESSAGE_CHECK_NUM_EQ
(
ex³ùed
, 
m
, 
chunk_Ëngths
[
i
]);

2635 
	`MESSAGE_CHECK_NUM_EQ
(
ex³ùed
, 
m
, 
num_h—d”s
);

2637 
r
;

2638 
i
 = 0; i < 
m
->
num_h—d”s
; i++) {

2639 
r
 = 
	`check_¡r_eq
(
ex³ùed
, "h—d” f›ld",ƒx³ùed->
h—d”s
[
i
][0], 
m
->headers[i][0]);

2640 ià(!
r
)  0;

2641 
r
 = 
	`check_¡r_eq
(
ex³ùed
, "h—d” v®ue",ƒx³ùed->
h—d”s
[
i
][1], 
m
->headers[i][1]);

2642 ià(!
r
)  0;

2645 ià(!
cÚÃù
) {

2646 
	`MESSAGE_CHECK_STR_EQ
(
ex³ùed
, 
m
, 
upg¿de
);

2650 
	}
}

2656 
size_t


2657 
	$couÁ_·r£d_mes§ges
(cÚ¡ 
size_t
 
nmsgs
, ...) {

2658 
size_t
 
i
;

2659 
va_li¡
 
­
;

2661 
	`va_¡¬t
(
­
, 
nmsgs
);

2663 
i
 = 0; i < 
nmsgs
; i++) {

2664 
mes§ge
 *
m
 = 
	`va_¬g
(
­
, message *);

2666 ià(
m
->
upg¿de
) {

2667 
	`va_’d
(
­
);

2668  
i
 + 1;

2672 
	`va_’d
(
­
);

2673  
nmsgs
;

2674 
	}
}

2680 
	$upg¿de_mes§ge_fix
(*
body
, cÚ¡ 
size_t
 
Ä—d
, cÚ¡ size_ˆ
nmsgs
, ...) {

2681 
va_li¡
 
­
;

2682 
size_t
 
i
;

2683 
size_t
 
off
 = 0;

2685 
	`va_¡¬t
(
­
, 
nmsgs
);

2687 
i
 = 0; i < 
nmsgs
; i++) {

2688 
mes§ge
 *
m
 = 
	`va_¬g
(
­
, message *);

2690 
off
 +ğ
	`¡¾’
(
m
->
¿w
);

2692 ià(
m
->
upg¿de
) {

2693 
off
 -ğ
	`¡¾’
(
m
->
upg¿de
);

2696 ià(!
	`check_¡r_eq
(
m
, "upg¿de", 
body
 + 
off
, body + 
Ä—d
)) {

2697 
	`abÜt
();

2702 *(
body
 + 
Ä—d
 + 
	`¡¾’
(
m
->
upg¿de
)) = '\0';

2703 
mes§ges
[
num_mes§ges
 -1 ].
upg¿de
 = 
body
 + 
Ä—d
;

2705 
	`va_’d
(
­
);

2710 
	`va_’d
(
­
);

2711 
	`´štf
("\n\n*** Error:ƒxpected‡ message with upgrade ***\n");

2713 
	`abÜt
();

2714 
	}
}

2717 
	$´št_”rÜ
 (cÚ¡ *
¿w
, 
size_t
 
”rÜ_loÿtiÚ
)

2719 
	`årštf
(
¡d”r
, "\n*** %s ***\n\n",

2720 
	`h‰p_”ºo_desütiÚ
(
	`HTTP_PARSER_ERRNO
(
·r£r
)));

2722 
this_lše
 = 0, 
ch¬_Ën
 = 0;

2723 
size_t
 
i
, 
j
, 
Ën
 = 
	`¡¾’
(
¿w
), 
”rÜ_loÿtiÚ_lše
 = 0;

2724 
i
 = 0; i < 
Ën
; i++) {

2725 ià(
i
 =ğ
”rÜ_loÿtiÚ
è
this_lše
 = 1;

2726 
¿w
[
i
]) {

2728 
ch¬_Ën
 = 2;

2729 
	`årštf
(
¡d”r
, "\\r");

2733 
	`årštf
(
¡d”r
, "\\n\n");

2735 ià(
this_lše
è
´št
;

2737 
”rÜ_loÿtiÚ_lše
 = 0;

2741 
ch¬_Ën
 = 1;

2742 
	`åutc
(
¿w
[
i
], 
¡d”r
);

2745 ià(!
this_lše
è
”rÜ_loÿtiÚ_lše
 +ğ
ch¬_Ën
;

2748 
	`årštf
(
¡d”r
, "[eof]\n");

2750 
´št
:

2751 
j
 = 0; j < 
”rÜ_loÿtiÚ_lše
; j++) {

2752 
	`åutc
(' ', 
¡d”r
);

2754 
	`årštf
(
¡d”r
, "^\n\Ã¼Ü†oÿtiÚ: %u\n", ()
”rÜ_loÿtiÚ
);

2755 
	}
}

2758 
	$‹¡_´e£rve_d©a
 ()

2760 
my_d©a
[] = "application-specific data";

2761 
h‰p_·r£r
 
·r£r
;

2762 
·r£r
.
d©a
 = 
my_d©a
;

2763 
	`h‰p_·r£r_š™
(&
·r£r
, 
HTTP_REQUEST
);

2764 ià(
·r£r
.
d©a
 !ğ
my_d©a
) {

2765 
	`´štf
("\n***…arser.data‚ot…reserved‡ccross http_parser_init ***\n\n");

2766 
	`abÜt
();

2768 
	}
}

2770 
	su¾_‹¡
 {

2771 cÚ¡ *
	mÇme
;

2772 cÚ¡ *
	mu¾
;

2773 
	mis_cÚÃù
;

2774 
h‰p_·r£r_u¾
 
	mu
;

2775 
	mrv
;

2778 cÚ¡ 
u¾_‹¡
 
	gu¾_‹¡s
[] =

2779 { {.
Çme
="proxy„equest"

2780 ,.
	gu¾
="http://hostname/"

2781 ,.
	gis_cÚÃù
=0

2782 ,.
	gu
=

2783 {.
f›ld_£t
=(1 << 
UF_SCHEMA
è| (1 << 
UF_HOST
è| (1 << 
UF_PATH
)

2784 ,.
	gpÜt
=0

2785 ,.
	gf›ld_d©a
=

2795 ,.
	grv
=0

2798 , {.
	gÇme
="proxy„equest with…ort"

2799 ,.
	gu¾
="http://hostname:444/"

2800 ,.
	gis_cÚÃù
=0

2801 ,.
	gu
=

2802 {.
f›ld_£t
=(1 << 
UF_SCHEMA
è| (1 << 
UF_HOST
è| (1 << 
UF_PORT
è| (1 << 
UF_PATH
)

2803 ,.
	gpÜt
=444

2804 ,.
	gf›ld_d©a
=

2814 ,.
	grv
=0

2817 , {.
	gÇme
="CONNECT„equest"

2818 ,.
	gu¾
="hostname:443"

2819 ,.
	gis_cÚÃù
=1

2820 ,.
	gu
=

2821 {.
f›ld_£t
=(1 << 
UF_HOST
è| (1 << 
UF_PORT
)

2822 ,.
	gpÜt
=443

2823 ,.
	gf›ld_d©a
=

2833 ,.
	grv
=0

2836 , {.
	gÇme
="CONNECT„equest but‚ot connect"

2837 ,.
	gu¾
="hostname:443"

2838 ,.
	gis_cÚÃù
=0

2839 ,.
	grv
=1

2842 , {.
	gÇme
="proxy ipv6„equest"

2843 ,.
	gu¾
="http://[1:2::3:4]/"

2844 ,.
	gis_cÚÃù
=0

2845 ,.
	gu
=

2846 {.
f›ld_£t
=(1 << 
UF_SCHEMA
è| (1 << 
UF_HOST
è| (1 << 
UF_PATH
)

2847 ,.
	gpÜt
=0

2848 ,.
	gf›ld_d©a
=

2858 ,.
	grv
=0

2861 , {.
	gÇme
="proxy ipv6„equest with…ort"

2862 ,.
	gu¾
="http://[1:2::3:4]:67/"

2863 ,.
	gis_cÚÃù
=0

2864 ,.
	gu
=

2865 {.
f›ld_£t
=(1 << 
UF_SCHEMA
è| (1 << 
UF_HOST
è| (1 << 
UF_PORT
è| (1 << 
UF_PATH
)

2866 ,.
	gpÜt
=67

2867 ,.
	gf›ld_d©a
=

2877 ,.
	grv
=0

2880 , {.
	gÇme
="CONNECT ipv6‡ddress"

2881 ,.
	gu¾
="[1:2::3:4]:443"

2882 ,.
	gis_cÚÃù
=1

2883 ,.
	gu
=

2884 {.
f›ld_£t
=(1 << 
UF_HOST
è| (1 << 
UF_PORT
)

2885 ,.
	gpÜt
=443

2886 ,.
	gf›ld_d©a
=

2896 ,.
	grv
=0

2899 , {.
	gÇme
="ipv4 in ipv6‡ddress"

2900 ,.
	gu¾
="http://[2001:0000:0000:0000:0000:0000:1.9.1.1]/"

2901 ,.
	gis_cÚÃù
=0

2902 ,.
	gu
=

2903 {.
f›ld_£t
=(1 << 
UF_SCHEMA
è| (1 << 
UF_HOST
è| (1 << 
UF_PATH
)

2904 ,.
	gpÜt
=0

2905 ,.
	gf›ld_d©a
=

2915 ,.
	grv
=0

2918 , {.
	gÇme
="extra ? in query string"

2919 ,.
	gu¾
="http://a.tbcdn.cn/p/fp/2010c/??fp-header-min.css,fp-base-min.css,"

2922 ,.
	gis_cÚÃù
=0

2923 ,.
	gu
=

2924 {.
f›ld_£t
=(1<<
UF_SCHEMA
è| (1<<
UF_HOST
è| (1<<
UF_PATH
è| (1<<
UF_QUERY
)

2925 ,.
	gpÜt
=0

2926 ,.
	gf›ld_d©a
=

2936 ,.
	grv
=0

2939 , {.
	gÇme
="space URLƒncoded"

2940 ,.
	gu¾
="/toto.html?toto=a%20b"

2941 ,.
	gis_cÚÃù
=0

2942 ,.
	gu
=

2943 {.
f›ld_£t
ğ(1<<
UF_PATH
è| (1<<
UF_QUERY
)

2944 ,.
	gpÜt
=0

2945 ,.
	gf›ld_d©a
=

2955 ,.
	grv
=0

2959 , {.
	gÇme
="URL fragment"

2960 ,.
	gu¾
="/toto.html#titi"

2961 ,.
	gis_cÚÃù
=0

2962 ,.
	gu
=

2963 {.
f›ld_£t
ğ(1<<
UF_PATH
è| (1<<
UF_FRAGMENT
)

2964 ,.
	gpÜt
=0

2965 ,.
	gf›ld_d©a
=

2975 ,.
	grv
=0

2978 , {.
	gÇme
="complex URL fragment"

2979 ,.
	gu¾
="http://www.webmasterworld.com/r.cgi?f=21&d=8405&url="

2981 ,.
	gis_cÚÃù
=0

2982 ,.
	gu
=

2983 {.
f›ld_£t
ğ(1<<
UF_SCHEMA
è| (1<<
UF_HOST
è| (1<<
UF_PATH
è| (1<<
UF_QUERY
) |\

2984 (1<<
UF_FRAGMENT
)

2985 ,.
	gpÜt
=0

2986 ,.
	gf›ld_d©a
=

2996 ,.
	grv
=0

2999 , {.
	gÇme
="complex URL from‚ode js url…arser doc"

3000 ,.
	gu¾
="http://host.com:8080/p/a/t/h?query=string#hash"

3001 ,.
	gis_cÚÃù
=0

3002 ,.
	gu
=

3003 {.
f›ld_£t
ğ(1<<
UF_SCHEMA
è| (1<<
UF_HOST
è| (1<<
UF_PORT
è| (1<<
UF_PATH
) |\

3004 (1<<
UF_QUERY
è| (1<<
UF_FRAGMENT
)

3005 ,.
	gpÜt
=8080

3006 ,.
	gf›ld_d©a
=

3016 ,.
	grv
=0

3019 , {.
	gÇme
="complex URL with basic‡uth from‚ode js url…arser doc"

3020 ,.
	gu¾
="http://a:b@host.com:8080/p/a/t/h?query=string#hash"

3021 ,.
	gis_cÚÃù
=0

3022 ,.
	gu
=

3023 {.
f›ld_£t
ğ(1<<
UF_SCHEMA
è| (1<<
UF_HOST
è| (1<<
UF_PORT
è| (1<<
UF_PATH
) |\

3024 (1<<
UF_QUERY
è| (1<<
UF_FRAGMENT
è| (1<<
UF_USERINFO
)

3025 ,.
	gpÜt
=8080

3026 ,.
	gf›ld_d©a
=

3036 ,.
	grv
=0

3039 , {.
	gÇme
="double @"

3040 ,.
	gu¾
="http://a:b@@hostname:443/"

3041 ,.
	gis_cÚÃù
=0

3042 ,.
	grv
=1

3045 , {.
	gÇme
="proxyƒmpty host"

3046 ,.
	gu¾
="http://:443/"

3047 ,.
	gis_cÚÃù
=0

3048 ,.
	grv
=1

3051 , {.
	gÇme
="proxyƒmpty…ort"

3052 ,.
	gu¾
="http://hostname:/"

3053 ,.
	gis_cÚÃù
=0

3054 ,.
	grv
=1

3057 , {.
	gÇme
="CONNECT with basic‡uth"

3058 ,.
	gu¾
="a:b@hostname:443"

3059 ,.
	gis_cÚÃù
=1

3060 ,.
	grv
=1

3063 , {.
	gÇme
="CONNECTƒmpty host"

3064 ,.
	gu¾
=":443"

3065 ,.
	gis_cÚÃù
=1

3066 ,.
	grv
=1

3069 , {.
	gÇme
="CONNECTƒmpty…ort"

3070 ,.
	gu¾
="hostname:"

3071 ,.
	gis_cÚÃù
=1

3072 ,.
	grv
=1

3075 , {.
	gÇme
="CONNECT withƒxtra bits"

3076 ,.
	gu¾
="hostname:443/"

3077 ,.
	gis_cÚÃù
=1

3078 ,.
	grv
=1

3081 , {.
	gÇme
="space in URL"

3082 ,.
	gu¾
="/foo bar/"

3083 ,.
	grv
=1

3086 , {.
	gÇme
="proxy basic‡uth with space urlƒncoded"

3087 ,.
	gu¾
="http://a%20:b@host.com/"

3088 ,.
	gis_cÚÃù
=0

3089 ,.
	gu
=

3090 {.
f›ld_£t
ğ(1<<
UF_SCHEMA
è| (1<<
UF_HOST
è| (1<<
UF_PATH
è| (1<<
UF_USERINFO
)

3091 ,.
	gpÜt
=0

3092 ,.
	gf›ld_d©a
=

3102 ,.
	grv
=0

3105 , {.
	gÇme
="carriage„eturn in URL"

3106 ,.
	gu¾
="/foo\rbar/"

3107 ,.
	grv
=1

3110 , {.
	gÇme
="proxy double : in URL"

3111 ,.
	gu¾
="http://hostname::443/"

3112 ,.
	grv
=1

3115 , {.
	gÇme
="proxy basic‡uth with double :"

3116 ,.
	gu¾
="http://a::b@host.com/"

3117 ,.
	gis_cÚÃù
=0

3118 ,.
	gu
=

3119 {.
f›ld_£t
ğ(1<<
UF_SCHEMA
è| (1<<
UF_HOST
è| (1<<
UF_PATH
è| (1<<
UF_USERINFO
)

3120 ,.
	gpÜt
=0

3121 ,.
	gf›ld_d©a
=

3131 ,.
	grv
=0

3134 , {.
	gÇme
="line feed in URL"

3135 ,.
	gu¾
="/foo\nbar/"

3136 ,.
	grv
=1

3139 , {.
	gÇme
="proxyƒmpty basic‡uth"

3140 ,.
	gu¾
="http://@hostname/fo"

3141 ,.
	gu
=

3142 {.
f›ld_£t
ğ(1<<
UF_SCHEMA
è| (1<<
UF_HOST
è| (1<<
UF_PATH
)

3143 ,.
	gpÜt
=0

3144 ,.
	gf›ld_d©a
=

3154 ,.
	grv
=0

3156 , {.
	gÇme
="proxy†ine feed in hostname"

3157 ,.
	gu¾
="http://host\name/fo"

3158 ,.
	grv
=1

3161 , {.
	gÇme
="proxy % in hostname"

3162 ,.
	gu¾
="http://host%name/fo"

3163 ,.
	grv
=1

3166 , {.
	gÇme
="proxy ; in hostname"

3167 ,.
	gu¾
="http://host;ame/fo"

3168 ,.
	grv
=1

3171 , {.
	gÇme
="proxy basic‡uth with unreservedchars"

3172 ,.
	gu¾
="http://a!;-_!=+$@host.com/"

3173 ,.
	gis_cÚÃù
=0

3174 ,.
	gu
=

3175 {.
f›ld_£t
ğ(1<<
UF_SCHEMA
è| (1<<
UF_HOST
è| (1<<
UF_PATH
è| (1<<
UF_USERINFO
)

3176 ,.
	gpÜt
=0

3177 ,.
	gf›ld_d©a
=

3187 ,.
	grv
=0

3190 , {.
	gÇme
="proxy onlyƒmpty basic‡uth"

3191 ,.
	gu¾
="http://@/fo"

3192 ,.
	grv
=1

3195 , {.
	gÇme
="proxy only basic‡uth"

3196 ,.
	gu¾
="http://toto@/fo"

3197 ,.
	grv
=1

3200 , {.
	gÇme
="proxyƒmtpy hostname"

3201 ,.
	gu¾
="http:///fo"

3202 ,.
	grv
=1

3205 , {.
	gÇme
="proxy = in URL"

3206 ,.
	gu¾
="http://host=ame/fo"

3207 ,.
	grv
=1

3210 , {.
	gÇme
="ipv6‡ddress with Zone ID"

3211 ,.
	gu¾
="http://[fe80::a%25eth0]/"

3212 ,.
	gis_cÚÃù
=0

3213 ,.
	gu
=

3214 {.
f›ld_£t
ğ(1<<
UF_SCHEMA
è| (1<<
UF_HOST
è| (1<<
UF_PATH
)

3215 ,.
	gpÜt
=0

3216 ,.
	gf›ld_d©a
=

3226 ,.
	grv
=0

3229 , {.
	gÇme
="ipv6‡ddress with Zone ID, but '%' is‚ot…ercent-encoded"

3230 ,.
	gu¾
="http://[fe80::a%eth0]/"

3231 ,.
	gis_cÚÃù
=0

3232 ,.
	gu
=

3233 {.
f›ld_£t
ğ(1<<
UF_SCHEMA
è| (1<<
UF_HOST
è| (1<<
UF_PATH
)

3234 ,.
	gpÜt
=0

3235 ,.
	gf›ld_d©a
=

3245 ,.
	grv
=0

3248 , {.
	gÇme
="ipv6‡ddressƒnding with '%'"

3249 ,.
	gu¾
="http://[fe80::a%]/"

3250 ,.
	grv
=1

3253 , {.
	gÇme
="ipv6‡ddress with Zone ID including bad character"

3254 ,.
	gu¾
="http://[fe80::a%$HOME]/"

3255 ,.
	grv
=1

3258 , {.
	gÇme
="just ipv6 Zone ID"

3259 ,.
	gu¾
="http://[%eth0]/"

3260 ,.
	grv
=1

3263 #ià
HTTP_PARSER_STRICT


3265 , {.
	gÇme
="tab in URL"

3266 ,.
	gu¾
="/foo\tbar/"

3267 ,.
	grv
=1

3270 , {.
	gÇme
="form feed in URL"

3271 ,.
	gu¾
="/foo\fbar/"

3272 ,.
	grv
=1

3277 , {.
	gÇme
="tab in URL"

3278 ,.
	gu¾
="/foo\tbar/"

3279 ,.
	gu
=

3280 {.
f›ld_£t
=(1 << 
UF_PATH
)

3281 ,.
	gf›ld_d©a
=

3291 ,.
	grv
=0

3294 , {.
	gÇme
="form feed in URL"

3295 ,.
	gu¾
="/foo\fbar/"

3296 ,.
	gu
=

3297 {.
f›ld_£t
=(1 << 
UF_PATH
)

3298 ,.
	gf›ld_d©a
=

3308 ,.
	grv
=0

3314 
	$dump_u¾
 (cÚ¡ *
u¾
, cÚ¡ 
h‰p_·r£r_u¾
 *
u
)

3316 
i
;

3318 
	`´štf
("\tf›ld_£t: 0x%x,…Üt: %u\n", 
u
->
f›ld_£t
, u->
pÜt
);

3319 
i
 = 0; i < 
UF_MAX
; i++) {

3320 ià((
u
->
f›ld_£t
 & (1 << 
i
)) == 0) {

3321 
	`´štf
("\tf›ld_d©a[%u]: un£t\n", 
i
);

3325 
	`´štf
("\tfield_data[%u]: off: %u†en: %u…art: \"%.*s\n\"",

3326 
i
,

3327 
u
->
f›ld_d©a
[
i
].
off
,

3328 
u
->
f›ld_d©a
[
i
].
Ën
,

3329 
u
->
f›ld_d©a
[
i
].
Ën
,

3330 
u¾
 + 
u
->
f›ld_d©a
[
i
].
off
);

3332 
	}
}

3335 
	$‹¡_·r£_u¾
 ()

3337 
h‰p_·r£r_u¾
 
u
;

3338 cÚ¡ 
u¾_‹¡
 *
‹¡
;

3339 
i
;

3340 
rv
;

3342 
i
 = 0; i < ((
u¾_‹¡s
) / (url_tests[0])); i++) {

3343 
‹¡
 = &
u¾_‹¡s
[
i
];

3344 
	`mem£t
(&
u
, 0, (u));

3346 
rv
 = 
	`h‰p_·r£r_·r£_u¾
(
‹¡
->
u¾
,

3347 
	`¡¾’
(
‹¡
->
u¾
),

3348 
‹¡
->
is_cÚÃù
,

3349 &
u
);

3351 ià(
‹¡
->
rv
 == 0) {

3352 ià(
rv
 != 0) {

3353 
	`´štf
("\n*** http_parser_parse_url(\"%s\") \"%s\"est failed, "

3354 "uÃx³ùed„v %d ***\n\n", 
‹¡
->
u¾
,e¡->
Çme
, 
rv
);

3355 
	`abÜt
();

3358 ià(
	`memcmp
(&
u
, &
‹¡
->u, (u)) != 0) {

3359 
	`´štf
("\n*** http_parser_parse_url(\"%s\") \"%s\" failed ***\n",

3360 
‹¡
->
u¾
,e¡->
Çme
);

3362 
	`´štf
("target http_parser_url:\n");

3363 
	`dump_u¾
(
‹¡
->
u¾
, &‹¡->
u
);

3364 
	`´štf
("result http_parser_url:\n");

3365 
	`dump_u¾
(
‹¡
->
u¾
, &
u
);

3367 
	`abÜt
();

3371 ià(
rv
 == 0) {

3372 
	`´štf
("\n*** http_parser_parse_url(\"%s\") \"%s\"est failed, "

3373 "uÃx³ùed„v %d ***\n\n", 
‹¡
->
u¾
,e¡->
Çme
, 
rv
);

3374 
	`abÜt
();

3378 
	}
}

3381 
	$‹¡_m‘hod_¡r
 ()

3383 
	`as£¹
(0 =ğ
	`¡rcmp
("GET", 
	`h‰p_m‘hod_¡r
(
HTTP_GET
)));

3384 
	`as£¹
(0 =ğ
	`¡rcmp
("<unknown>", 
	`h‰p_m‘hod_¡r
(1337)));

3385 
	}
}

3388 
	$‹¡_mes§ge
 (cÚ¡ 
mes§ge
 *message)

3390 
size_t
 
¿w_Ën
 = 
	`¡¾’
(
mes§ge
->
¿w
);

3391 
size_t
 
msg1Ën
;

3392 
msg1Ën
 = 0; msg1ËÀ< 
¿w_Ën
; msg1len++) {

3393 
	`·r£r_š™
(
mes§ge
->
ty³
);

3395 
size_t
 
»ad
;

3396 cÚ¡ *
msg1
 = 
mes§ge
->
¿w
;

3397 cÚ¡ *
msg2
 = 
msg1
 + 
msg1Ën
;

3398 
size_t
 
msg2Ën
 = 
¿w_Ën
 - 
msg1Ën
;

3400 ià(
msg1Ën
) {

3401 
»ad
 = 
	`·r£
(
msg1
, 
msg1Ën
);

3403 ià(
mes§ge
->
upg¿de
 && 
·r£r
->upg¿d&& 
num_mes§ges
 > 0) {

3404 
mes§ges
[
num_mes§ges
 - 1].
upg¿de
 = 
msg1
 + 
»ad
;

3405 
‹¡
;

3408 ià(
»ad
 !ğ
msg1Ën
) {

3409 
	`´št_”rÜ
(
msg1
, 
»ad
);

3410 
	`abÜt
();

3415 
»ad
 = 
	`·r£
(
msg2
, 
msg2Ën
);

3417 ià(
mes§ge
->
upg¿de
 && 
·r£r
->upgrade) {

3418 
mes§ges
[
num_mes§ges
 - 1].
upg¿de
 = 
msg2
 + 
»ad
;

3419 
‹¡
;

3422 ià(
»ad
 !ğ
msg2Ën
) {

3423 
	`´št_”rÜ
(
msg2
, 
»ad
);

3424 
	`abÜt
();

3427 
»ad
 = 
	`·r£
(
NULL
, 0);

3429 ià(
»ad
 != 0) {

3430 
	`´št_”rÜ
(
mes§ge
->
¿w
, 
»ad
);

3431 
	`abÜt
();

3434 
‹¡
:

3436 ià(
num_mes§ges
 != 1) {

3437 
	`´štf
("\n***‚um_mes§ge !ğ1‡á”e¡šg '%s' ***\n\n", 
mes§ge
->
Çme
);

3438 
	`abÜt
();

3441 if(!
	`mes§ge_eq
(0, 0, 
mes§ge
)è
	`abÜt
();

3443 
	`·r£r_ä“
();

3445 
	}
}

3448 
	$‹¡_mes§ge_couÁ_body
 (cÚ¡ 
mes§ge
 *message)

3450 
	`·r£r_š™
(
mes§ge
->
ty³
);

3452 
size_t
 
»ad
;

3453 
size_t
 
l
 = 
	`¡¾’
(
mes§ge
->
¿w
);

3454 
size_t
 
i
, 
tÜ—d
;

3455 
size_t
 
chunk
 = 4024;

3457 
i
 = 0; i < 
l
; i+ğ
chunk
) {

3458 
tÜ—d
 = 
	`MIN
(
l
-
i
, 
chunk
);

3459 
»ad
 = 
	`·r£_couÁ_body
(
mes§ge
->
¿w
 + 
i
, 
tÜ—d
);

3460 ià(
»ad
 !ğ
tÜ—d
) {

3461 
	`´št_”rÜ
(
mes§ge
->
¿w
, 
»ad
);

3462 
	`abÜt
();

3467 
»ad
 = 
	`·r£_couÁ_body
(
NULL
, 0);

3468 ià(
»ad
 != 0) {

3469 
	`´št_”rÜ
(
mes§ge
->
¿w
, 
»ad
);

3470 
	`abÜt
();

3473 ià(
num_mes§ges
 != 1) {

3474 
	`´štf
("\n***‚um_mes§ge !ğ1‡á”e¡šg '%s' ***\n\n", 
mes§ge
->
Çme
);

3475 
	`abÜt
();

3478 if(!
	`mes§ge_eq
(0, 0, 
mes§ge
)è
	`abÜt
();

3480 
	`·r£r_ä“
();

3481 
	}
}

3484 
	$‹¡_sim¶e_ty³
 (cÚ¡ *
buf
,

3485 
h‰p_”ºo
 
”r_ex³ùed
,

3486 
h‰p_·r£r_ty³
 
ty³
)

3488 
	`·r£r_š™
(
ty³
);

3490 
h‰p_”ºo
 
”r
;

3492 
	`·r£
(
buf
, 
	`¡¾’
(buf));

3493 
”r
 = 
	`HTTP_PARSER_ERRNO
(
·r£r
);

3494 
	`·r£
(
NULL
, 0);

3496 
	`·r£r_ä“
();

3501 #ià
HTTP_PARSER_STRICT


3502 ià(
”r_ex³ùed
 !ğ
”r
 &&ƒ¼_ex³ùed !ğ
HPE_OK
 &&ƒ¼ !ğ
HPE_STRICT
) {

3504 ià(
”r_ex³ùed
 !ğ
”r
) {

3506 
	`årštf
(
¡d”r
, "\n***est_simpleƒxpected %s, but saw %s ***\n\n%s\n",

3507 
	`h‰p_”ºo_Çme
(
”r_ex³ùed
), h‰p_”ºo_Çme(
”r
), 
buf
);

3508 
	`abÜt
();

3510 
	}
}

3513 
	$‹¡_sim¶e
 (cÚ¡ *
buf
, 
h‰p_”ºo
 
”r_ex³ùed
)

3515 
	`‹¡_sim¶e_ty³
(
buf
, 
”r_ex³ùed
, 
HTTP_REQUEST
);

3516 
	}
}

3519 
	$‹¡_šv®id_h—d”_cÚ‹Á
 (
»q
, cÚ¡ * 
¡r
)

3521 
h‰p_·r£r
 
·r£r
;

3522 
	`h‰p_·r£r_š™
(&
·r£r
, 
»q
 ? 
HTTP_REQUEST
 : 
HTTP_RESPONSE
);

3523 
size_t
 
·r£d
;

3524 cÚ¡ *
buf
;

3525 
buf
 = 
»q
 ?

3528 
·r£d
 = 
	`h‰p_·r£r_execu‹
(&
·r£r
, &
£‰šgs_nuÎ
, 
buf
, 
	`¡¾’
(buf));

3529 
	`as£¹
(
·r£d
 =ğ
	`¡¾’
(
buf
));

3531 
buf
 = 
¡r
;

3532 
size_t
 
buæ’
 = 
	`¡¾’
(
buf
);

3534 
·r£d
 = 
	`h‰p_·r£r_execu‹
(&
·r£r
, &
£‰šgs_nuÎ
, 
buf
, 
buæ’
);

3535 ià(
·r£d
 !ğ
buæ’
) {

3536 
	`as£¹
(
	`HTTP_PARSER_ERRNO
(&
·r£r
è=ğ
HPE_INVALID_HEADER_TOKEN
);

3540 
	`årštf
(
¡d”r
,

3542 
	`abÜt
();

3543 
	}
}

3546 
	$‹¡_šv®id_h—d”_f›ld_cÚ‹Á_”rÜ
 (
»q
)

3548 
	`‹¡_šv®id_h—d”_cÚ‹Á
(
»q
, "Foo: F\01ailure");

3549 
	`‹¡_šv®id_h—d”_cÚ‹Á
(
»q
, "Foo: B\02ar");

3550 
	}
}

3553 
	$‹¡_šv®id_h—d”_f›ld
 (
»q
, cÚ¡ * 
¡r
)

3555 
h‰p_·r£r
 
·r£r
;

3556 
	`h‰p_·r£r_š™
(&
·r£r
, 
»q
 ? 
HTTP_REQUEST
 : 
HTTP_RESPONSE
);

3557 
size_t
 
·r£d
;

3558 cÚ¡ *
buf
;

3559 
buf
 = 
»q
 ?

3562 
·r£d
 = 
	`h‰p_·r£r_execu‹
(&
·r£r
, &
£‰šgs_nuÎ
, 
buf
, 
	`¡¾’
(buf));

3563 
	`as£¹
(
·r£d
 =ğ
	`¡¾’
(
buf
));

3565 
buf
 = 
¡r
;

3566 
size_t
 
buæ’
 = 
	`¡¾’
(
buf
);

3568 
·r£d
 = 
	`h‰p_·r£r_execu‹
(&
·r£r
, &
£‰šgs_nuÎ
, 
buf
, 
buæ’
);

3569 ià(
·r£d
 !ğ
buæ’
) {

3570 
	`as£¹
(
	`HTTP_PARSER_ERRNO
(&
·r£r
è=ğ
HPE_INVALID_HEADER_TOKEN
);

3574 
	`årštf
(
¡d”r
,

3576 
	`abÜt
();

3577 
	}
}

3580 
	$‹¡_šv®id_h—d”_f›ld_tok’_”rÜ
 (
»q
)

3582 
	`‹¡_šv®id_h—d”_f›ld
(
»q
, "Fo@: Failure");

3583 
	`‹¡_šv®id_h—d”_f›ld
(
»q
, "Foo\01\test: Bar");

3584 
	}
}

3587 
	$‹¡_doubË_cÚ‹Á_Ëngth_”rÜ
 (
»q
)

3589 
h‰p_·r£r
 
·r£r
;

3590 
	`h‰p_·r£r_š™
(&
·r£r
, 
»q
 ? 
HTTP_REQUEST
 : 
HTTP_RESPONSE
);

3591 
size_t
 
·r£d
;

3592 cÚ¡ *
buf
;

3593 
buf
 = 
»q
 ?

3596 
·r£d
 = 
	`h‰p_·r£r_execu‹
(&
·r£r
, &
£‰šgs_nuÎ
, 
buf
, 
	`¡¾’
(buf));

3597 
	`as£¹
(
·r£d
 =ğ
	`¡¾’
(
buf
));

3599 
buf
 = "Content-Length: 0\r\nContent-Length: 1\r\n\r\n";

3600 
size_t
 
buæ’
 = 
	`¡¾’
(
buf
);

3602 
·r£d
 = 
	`h‰p_·r£r_execu‹
(&
·r£r
, &
£‰šgs_nuÎ
, 
buf
, 
buæ’
);

3603 ià(
·r£d
 !ğ
buæ’
) {

3604 
	`as£¹
(
	`HTTP_PARSER_ERRNO
(&
·r£r
è=ğ
HPE_UNEXPECTED_CONTENT_LENGTH
);

3608 
	`årštf
(
¡d”r
,

3610 
	`abÜt
();

3611 
	}
}

3614 
	$‹¡_chunked_cÚ‹Á_Ëngth_”rÜ
 (
»q
)

3616 
h‰p_·r£r
 
·r£r
;

3617 
	`h‰p_·r£r_š™
(&
·r£r
, 
»q
 ? 
HTTP_REQUEST
 : 
HTTP_RESPONSE
);

3618 
size_t
 
·r£d
;

3619 cÚ¡ *
buf
;

3620 
buf
 = 
»q
 ?

3623 
·r£d
 = 
	`h‰p_·r£r_execu‹
(&
·r£r
, &
£‰šgs_nuÎ
, 
buf
, 
	`¡¾’
(buf));

3624 
	`as£¹
(
·r£d
 =ğ
	`¡¾’
(
buf
));

3626 
buf
 = "Transfer-Encoding: chunked\r\nContent-Length: 1\r\n\r\n";

3627 
size_t
 
buæ’
 = 
	`¡¾’
(
buf
);

3629 
·r£d
 = 
	`h‰p_·r£r_execu‹
(&
·r£r
, &
£‰šgs_nuÎ
, 
buf
, 
buæ’
);

3630 ià(
·r£d
 !ğ
buæ’
) {

3631 
	`as£¹
(
	`HTTP_PARSER_ERRNO
(&
·r£r
è=ğ
HPE_UNEXPECTED_CONTENT_LENGTH
);

3635 
	`årštf
(
¡d”r
,

3637 
	`abÜt
();

3638 
	}
}

3641 
	$‹¡_h—d”_ü_no_lf_”rÜ
 (
»q
)

3643 
h‰p_·r£r
 
·r£r
;

3644 
	`h‰p_·r£r_š™
(&
·r£r
, 
»q
 ? 
HTTP_REQUEST
 : 
HTTP_RESPONSE
);

3645 
size_t
 
·r£d
;

3646 cÚ¡ *
buf
;

3647 
buf
 = 
»q
 ?

3650 
·r£d
 = 
	`h‰p_·r£r_execu‹
(&
·r£r
, &
£‰šgs_nuÎ
, 
buf
, 
	`¡¾’
(buf));

3651 
	`as£¹
(
·r£d
 =ğ
	`¡¾’
(
buf
));

3653 
buf
 = "Foo: 1\rBar: 1\r\n\r\n";

3654 
size_t
 
buæ’
 = 
	`¡¾’
(
buf
);

3656 
·r£d
 = 
	`h‰p_·r£r_execu‹
(&
·r£r
, &
£‰šgs_nuÎ
, 
buf
, 
buæ’
);

3657 ià(
·r£d
 !ğ
buæ’
) {

3658 
	`as£¹
(
	`HTTP_PARSER_ERRNO
(&
·r£r
è=ğ
HPE_LF_EXPECTED
);

3662 
	`årštf
(
¡d”r
,

3664 
	`abÜt
();

3665 
	}
}

3668 
	$‹¡_h—d”_ov”æow_”rÜ
 (
»q
)

3670 
h‰p_·r£r
 
·r£r
;

3671 
	`h‰p_·r£r_š™
(&
·r£r
, 
»q
 ? 
HTTP_REQUEST
 : 
HTTP_RESPONSE
);

3672 
size_t
 
·r£d
;

3673 cÚ¡ *
buf
;

3674 
buf
 = 
»q
 ? "GET / HTTP/1.1\r\n" : "HTTP/1.0 200 OK\r\n";

3675 
·r£d
 = 
	`h‰p_·r£r_execu‹
(&
·r£r
, &
£‰šgs_nuÎ
, 
buf
, 
	`¡¾’
(buf));

3676 
	`as£¹
(
·r£d
 =ğ
	`¡¾’
(
buf
));

3678 
buf
 = "header-key: header-value\r\n";

3679 
size_t
 
buæ’
 = 
	`¡¾’
(
buf
);

3681 
i
;

3682 
i
 = 0; i < 10000; i++) {

3683 
·r£d
 = 
	`h‰p_·r£r_execu‹
(&
·r£r
, &
£‰šgs_nuÎ
, 
buf
, 
buæ’
);

3684 ià(
·r£d
 !ğ
buæ’
) {

3686 
	`as£¹
(
	`HTTP_PARSER_ERRNO
(&
·r£r
è=ğ
HPE_HEADER_OVERFLOW
);

3691 
	`årštf
(
¡d”r
, "\n*** Errorƒxpected but‚one in header overflowest ***\n");

3692 
	`abÜt
();

3693 
	}
}

3697 
	$‹¡_h—d”_Ä—d_v®ue
 ()

3699 
h‰p_·r£r
 
·r£r
;

3700 
	`h‰p_·r£r_š™
(&
·r£r
, 
HTTP_REQUEST
);

3701 
size_t
 
·r£d
;

3702 cÚ¡ *
buf
;

3703 
buf
 = "GET / HTTP/1.1\r\nheader: value\nhdr: value\r\n";

3704 
·r£d
 = 
	`h‰p_·r£r_execu‹
(&
·r£r
, &
£‰šgs_nuÎ
, 
buf
, 
	`¡¾’
(buf));

3705 
	`as£¹
(
·r£d
 =ğ
	`¡¾’
(
buf
));

3707 
	`as£¹
(
·r£r
.
Ä—d
 =ğ
	`¡¾’
(
buf
));

3708 
	}
}

3712 
	$‹¡_cÚ‹Á_Ëngth_ov”æow
 (cÚ¡ *
buf
, 
size_t
 
buæ’
, 
ex³ù_ok
)

3714 
h‰p_·r£r
 
·r£r
;

3715 
	`h‰p_·r£r_š™
(&
·r£r
, 
HTTP_RESPONSE
);

3716 
	`h‰p_·r£r_execu‹
(&
·r£r
, &
£‰šgs_nuÎ
, 
buf
, 
buæ’
);

3718 ià(
ex³ù_ok
)

3719 
	`as£¹
(
	`HTTP_PARSER_ERRNO
(&
·r£r
è=ğ
HPE_OK
);

3721 
	`as£¹
(
	`HTTP_PARSER_ERRNO
(&
·r£r
è=ğ
HPE_INVALID_CONTENT_LENGTH
);

3722 
	}
}

3725 
	$‹¡_h—d”_cÚ‹Á_Ëngth_ov”æow_”rÜ
 ()

3727 
	#X
(
size
) \

3730 "\r\n"

	)

3731 cÚ¡ 
a
[] = 
	`X
(1844674407370955160);

3732 cÚ¡ 
b
[] = 
	`X
(18446744073709551615);

3733 cÚ¡ 
c
[] = 
	`X
(18446744073709551616);

3734 #undeà
X


3735 
	`‹¡_cÚ‹Á_Ëngth_ov”æow
(
a
, (a) - 1, 1);

3736 
	`‹¡_cÚ‹Á_Ëngth_ov”æow
(
b
, (b) - 1, 0);

3737 
	`‹¡_cÚ‹Á_Ëngth_ov”æow
(
c
, (c) - 1, 0);

3738 
	}
}

3741 
	$‹¡_chunk_cÚ‹Á_Ëngth_ov”æow_”rÜ
 ()

3743 
	#X
(
size
) \

3748 "..."

	)

3749 cÚ¡ 
a
[] = 
	`X
(
FFFFFFFFFFFFFFE
);

3750 cÚ¡ 
b
[] = 
	`X
(
FFFFFFFFFFFFFFFF
);

3751 cÚ¡ 
c
[] = 
	`X
(10000000000000000);

3752 #undeà
X


3753 
	`‹¡_cÚ‹Á_Ëngth_ov”æow
(
a
, (a) - 1, 1);

3754 
	`‹¡_cÚ‹Á_Ëngth_ov”æow
(
b
, (b) - 1, 0);

3755 
	`‹¡_cÚ‹Á_Ëngth_ov”æow
(
c
, (c) - 1, 0);

3756 
	}
}

3759 
	$‹¡_no_ov”æow_lÚg_body
 (
»q
, 
size_t
 
Ëngth
)

3761 
h‰p_·r£r
 
·r£r
;

3762 
	`h‰p_·r£r_š™
(&
·r£r
, 
»q
 ? 
HTTP_REQUEST
 : 
HTTP_RESPONSE
);

3763 
size_t
 
·r£d
;

3764 
size_t
 
i
;

3765 
buf1
[3000];

3766 
size_t
 
buf1Ën
 = 
	`¥rštf
(
buf1
, "%s\r\nConnection: Keep-Alive\r\nContent-Length: %lu\r\n\r\n",

3767 
»q
 ? "POST / HTTP/1.0" : "HTTP/1.0 200 OK", ()
Ëngth
);

3768 
·r£d
 = 
	`h‰p_·r£r_execu‹
(&
·r£r
, &
£‰šgs_nuÎ
, 
buf1
, 
buf1Ën
);

3769 ià(
·r£d
 !ğ
buf1Ën
)

3770 
”r
;

3772 
i
 = 0; i < 
Ëngth
; i++) {

3773 
foo
 = 'a';

3774 
·r£d
 = 
	`h‰p_·r£r_execu‹
(&
·r£r
, &
£‰šgs_nuÎ
, &
foo
, 1);

3775 ià(
·r£d
 != 1)

3776 
”r
;

3779 
·r£d
 = 
	`h‰p_·r£r_execu‹
(&
·r£r
, &
£‰šgs_nuÎ
, 
buf1
, 
buf1Ën
);

3780 ià(
·r£d
 !ğ
buf1Ën
è
”r
;

3783 
”r
:

3784 
	`årštf
(
¡d”r
,

3786 
»q
 ? "REQUEST" : "RESPONSE",

3787 ()
Ëngth
);

3788 
	`abÜt
();

3789 
	}
}

3792 
	$‹¡_muÉË3
 (cÚ¡ 
mes§ge
 *
r1
, cÚ¡ mes§g*
r2
, cÚ¡ mes§g*
r3
)

3794 
mes§ge_couÁ
 = 
	`couÁ_·r£d_mes§ges
(3, 
r1
, 
r2
, 
r3
);

3796 
tÙ®
[ 
	`¡¾’
(
r1
->
¿w
)

3797 + 
	`¡¾’
(
r2
->
¿w
)

3798 + 
	`¡¾’
(
r3
->
¿w
)

3801 
tÙ®
[0] = '\0';

3803 
	`¡rÿt
(
tÙ®
, 
r1
->
¿w
);

3804 
	`¡rÿt
(
tÙ®
, 
r2
->
¿w
);

3805 
	`¡rÿt
(
tÙ®
, 
r3
->
¿w
);

3807 
	`·r£r_š™
(
r1
->
ty³
);

3809 
size_t
 
»ad
;

3811 
»ad
 = 
	`·r£
(
tÙ®
, 
	`¡¾’
(total));

3813 ià(
·r£r
->
upg¿de
) {

3814 
	`upg¿de_mes§ge_fix
(
tÙ®
, 
»ad
, 3, 
r1
, 
r2
, 
r3
);

3815 
‹¡
;

3818 ià(
»ad
 !ğ
	`¡¾’
(
tÙ®
)) {

3819 
	`´št_”rÜ
(
tÙ®
, 
»ad
);

3820 
	`abÜt
();

3823 
»ad
 = 
	`·r£
(
NULL
, 0);

3825 ià(
»ad
 != 0) {

3826 
	`´št_”rÜ
(
tÙ®
, 
»ad
);

3827 
	`abÜt
();

3830 
‹¡
:

3832 ià(
mes§ge_couÁ
 !ğ
num_mes§ges
) {

3833 
	`årštf
(
¡d”r
, "\n\n*** P¬£¸didn'ˆ£3 mes§ge Úly %d *** \n", 
num_mes§ges
);

3834 
	`abÜt
();

3837 ià(!
	`mes§ge_eq
(0, 0, 
r1
)è
	`abÜt
();

3838 ià(
mes§ge_couÁ
 > 1 && !
	`mes§ge_eq
(1, 0, 
r2
)è
	`abÜt
();

3839 ià(
mes§ge_couÁ
 > 2 && !
	`mes§ge_eq
(2, 0, 
r3
)è
	`abÜt
();

3841 
	`·r£r_ä“
();

3842 
	}
}

3849 
	$‹¡_sÿn
 (cÚ¡ 
mes§ge
 *
r1
, cÚ¡ mes§g*
r2
, cÚ¡ mes§g*
r3
)

3851 
tÙ®
[80*1024] = "\0";

3852 
buf1
[80*1024] = "\0";

3853 
buf2
[80*1024] = "\0";

3854 
buf3
[80*1024] = "\0";

3856 
	`¡rÿt
(
tÙ®
, 
r1
->
¿w
);

3857 
	`¡rÿt
(
tÙ®
, 
r2
->
¿w
);

3858 
	`¡rÿt
(
tÙ®
, 
r3
->
¿w
);

3860 
size_t
 
»ad
;

3862 
tÙ®_Ën
 = 
	`¡¾’
(
tÙ®
);

3864 
tÙ®_İs
 = 2 * (
tÙ®_Ën
 - 1) * (total_len - 2) / 2;

3865 
İs
 = 0 ;

3867 
size_t
 
buf1_Ën
, 
buf2_Ën
, 
buf3_Ën
;

3868 
mes§ge_couÁ
 = 
	`couÁ_·r£d_mes§ges
(3, 
r1
, 
r2
, 
r3
);

3870 
i
,
j
,
ty³_bÙh
;

3871 
ty³_bÙh
 = 0;ype_both < 2;ype_both ++ ) {

3872 
j
 = 2; j < 
tÙ®_Ën
; j ++ ) {

3873 
i
 = 1; i < 
j
; i ++ ) {

3875 ià(
İs
 % 1000 == 0) {

3876 
	`´štf
("\b\b\b\b%3.0f%%", 100 * ()
İs
 /()
tÙ®_İs
);

3877 
	`fæush
(
¡dout
);

3879 
İs
 += 1;

3881 
	`·r£r_š™
(
ty³_bÙh
 ? 
HTTP_BOTH
 : 
r1
->
ty³
);

3883 
buf1_Ën
 = 
i
;

3884 
	`¡¾nıy
(
buf1
, (buf1), 
tÙ®
, 
buf1_Ën
);

3885 
buf1
[
buf1_Ën
] = 0;

3887 
buf2_Ën
 = 
j
 - 
i
;

3888 
	`¡¾nıy
(
buf2
, (
buf1
), 
tÙ®
+
i
, 
buf2_Ën
);

3889 
buf2
[
buf2_Ën
] = 0;

3891 
buf3_Ën
 = 
tÙ®_Ën
 - 
j
;

3892 
	`¡¾nıy
(
buf3
, (
buf1
), 
tÙ®
+
j
, 
buf3_Ën
);

3893 
buf3
[
buf3_Ën
] = 0;

3895 
»ad
 = 
	`·r£
(
buf1
, 
buf1_Ën
);

3897 ià(
·r£r
->
upg¿de
è
‹¡
;

3899 ià(
»ad
 !ğ
buf1_Ën
) {

3900 
	`´št_”rÜ
(
buf1
, 
»ad
);

3901 
”rÜ
;

3904 
»ad
 +ğ
	`·r£
(
buf2
, 
buf2_Ën
);

3906 ià(
·r£r
->
upg¿de
è
‹¡
;

3908 ià(
»ad
 !ğ
buf1_Ën
 + 
buf2_Ën
) {

3909 
	`´št_”rÜ
(
buf2
, 
»ad
);

3910 
”rÜ
;

3913 
»ad
 +ğ
	`·r£
(
buf3
, 
buf3_Ën
);

3915 ià(
·r£r
->
upg¿de
è
‹¡
;

3917 ià(
»ad
 !ğ
buf1_Ën
 + 
buf2_Ën
 + 
buf3_Ën
) {

3918 
	`´št_”rÜ
(
buf3
, 
»ad
);

3919 
”rÜ
;

3922 
	`·r£
(
NULL
, 0);

3924 
‹¡
:

3925 ià(
·r£r
->
upg¿de
) {

3926 
	`upg¿de_mes§ge_fix
(
tÙ®
, 
»ad
, 3, 
r1
, 
r2
, 
r3
);

3929 ià(
mes§ge_couÁ
 !ğ
num_mes§ges
) {

3930 
	`årštf
(
¡d”r
, "\n\nParser didn't see %d messages only %d\n",

3931 
mes§ge_couÁ
, 
num_mes§ges
);

3932 
”rÜ
;

3935 ià(!
	`mes§ge_eq
(0, 0, 
r1
)) {

3936 
	`årštf
(
¡d”r
, "\n\nError matching messages[0] inest_scan.\n");

3937 
”rÜ
;

3940 ià(
mes§ge_couÁ
 > 1 && !
	`mes§ge_eq
(1, 0, 
r2
)) {

3941 
	`årštf
(
¡d”r
, "\n\nError matching messages[1] inest_scan.\n");

3942 
”rÜ
;

3945 ià(
mes§ge_couÁ
 > 2 && !
	`mes§ge_eq
(2, 0, 
r3
)) {

3946 
	`årštf
(
¡d”r
, "\n\nError matching messages[2] inest_scan.\n");

3947 
”rÜ
;

3950 
	`·r£r_ä“
();

3954 
	`puts
("\b\b\b\b100%");

3957 
”rÜ
:

3958 
	`årštf
(
¡d”r
, "i=%d j=%d\n", 
i
, 
j
);

3959 
	`årštf
(
¡d”r
, "buf1 (%uè%s\n\n", ()
buf1_Ën
, 
buf1
);

3960 
	`årštf
(
¡d”r
, "buf2 (%uè%s\n\n", ()
buf2_Ën
 , 
buf2
);

3961 
	`årštf
(
¡d”r
, "buf3 (%uè%s\n", ()
buf3_Ën
, 
buf3
);

3962 
	`abÜt
();

3963 
	}
}

3968 
	$ü—‹_Ïrge_chunked_mes§ge
 (
body_size_š_kb
, cÚ¡ * 
h—d”s
)

3970 
i
;

3971 
size_t
 
wrÙe
 = 0;

3972 
size_t
 
h—d”s_Ën
 = 
	`¡¾’
(
h—d”s
);

3973 
size_t
 
bufsize
 = 
h—d”s_Ën
 + (5+1024+2)*
body_size_š_kb
 + 6;

3974 * 
buf
 = 
	`m®loc
(
bufsize
);

3976 
	`memıy
(
buf
, 
h—d”s
, 
h—d”s_Ën
);

3977 
wrÙe
 +ğ
h—d”s_Ën
;

3979 
i
 = 0; i < 
body_size_š_kb
; i++) {

3981 
	`memıy
(
buf
 + 
wrÙe
, "400\r\n", 5);

3982 
wrÙe
 += 5;

3983 
	`mem£t
(
buf
 + 
wrÙe
, 'C', 1024);

3984 
wrÙe
 += 1024;

3985 
	`¡rıy
(
buf
 + 
wrÙe
, "\r\n");

3986 
wrÙe
 += 2;

3989 
	`memıy
(
buf
 + 
wrÙe
, "0\r\n\r\n", 6);

3990 
wrÙe
 += 6;

3991 
	`as£¹
(
wrÙe
 =ğ
bufsize
);

3993  
buf
;

3994 
	}
}

3999 
	$‹¡_mes§ge_·u£
 (cÚ¡ 
mes§ge
 *
msg
)

4001 *
buf
 = (*è
msg
->
¿w
;

4002 
size_t
 
buæ’
 = 
	`¡¾’
(
msg
->
¿w
);

4003 
size_t
 
Ä—d
;

4005 
	`·r£r_š™
(
msg
->
ty³
);

4008 
Ä—d
 = 
	`·r£_·u£
(
buf
, 
buæ’
);

4012 ià(
mes§ges
[0].
mes§ge_com¶‘e_cb_ÿÎed
 &&

4013 
msg
->
upg¿de
 &&

4014 
·r£r
->
upg¿de
) {

4015 
mes§ges
[0].
upg¿de
 = 
buf
 + 
Ä—d
;

4016 
‹¡
;

4019 ià(
Ä—d
 < 
buæ’
) {

4022 ià(
	`HTTP_PARSER_ERRNO
(
·r£r
è=ğ
HPE_STRICT
) {

4023 
	`·r£r_ä“
();

4027 
	`as£¹
 (
	`HTTP_PARSER_ERRNO
(
·r£r
è=ğ
HPE_PAUSED
);

4030 
buf
 +ğ
Ä—d
;

4031 
buæ’
 -ğ
Ä—d
;

4032 
	`h‰p_·r£r_·u£
(
·r£r
, 0);

4033 } 
buæ’
 > 0);

4035 
Ä—d
 = 
	`·r£_·u£
(
NULL
, 0);

4036 
	`as£¹
 (
Ä—d
 == 0);

4038 
‹¡
:

4039 ià(
num_mes§ges
 != 1) {

4040 
	`´štf
("\n***‚um_mes§ge !ğ1‡á”e¡šg '%s' ***\n\n", 
msg
->
Çme
);

4041 
	`abÜt
();

4044 if(!
	`mes§ge_eq
(0, 0, 
msg
)è
	`abÜt
();

4046 
	`·r£r_ä“
();

4047 
	}
}

4051 
	$‹¡_mes§ge_cÚÃù
 (cÚ¡ 
mes§ge
 *
msg
)

4053 *
buf
 = (*è
msg
->
¿w
;

4054 
size_t
 
buæ’
 = 
	`¡¾’
(
msg
->
¿w
);

4056 
	`·r£r_š™
(
msg
->
ty³
);

4058 
	`·r£_cÚÃù
(
buf
, 
buæ’
);

4060 ià(
num_mes§ges
 != 1) {

4061 
	`´štf
("\n***‚um_mes§ge !ğ1‡á”e¡šg '%s' ***\n\n", 
msg
->
Çme
);

4062 
	`abÜt
();

4065 if(!
	`mes§ge_eq
(0, 1, 
msg
)è
	`abÜt
();

4067 
	`·r£r_ä“
();

4068 
	}
}

4071 
	$maš
 ()

4073 
·r£r
 = 
NULL
;

4074 
i
, 
j
, 
k
;

4075 
»que¡_couÁ
;

4076 
»¥Ú£_couÁ
;

4077 
v”siÚ
;

4078 
majÜ
;

4079 
mšÜ
;

4080 
·tch
;

4082 
v”siÚ
 = 
	`h‰p_·r£r_v”siÚ
();

4083 
majÜ
 = (
v”siÚ
 >> 16) & 255;

4084 
mšÜ
 = (
v”siÚ
 >> 8) & 255;

4085 
·tch
 = 
v”siÚ
 & 255;

4086 
	`´štf
("h‰p_·r£¸v%u.%u.%u (0x%06lx)\n", 
majÜ
, 
mšÜ
, 
·tch
, 
v”siÚ
);

4088 
	`´štf
("sizeof(h‰p_·r£rèğ%u\n", ()(
h‰p_·r£r
));

4090 
»que¡_couÁ
 = 0; 
»que¡s
[»que¡_couÁ].
Çme
;„equest_count++);

4091 
»¥Ú£_couÁ
 = 0; 
»¥Ú£s
[»¥Ú£_couÁ].
Çme
;„esponse_count++);

4094 
	`‹¡_´e£rve_d©a
();

4095 
	`‹¡_·r£_u¾
();

4096 
	`‹¡_m‘hod_¡r
();

4099 
	`‹¡_h—d”_Ä—d_v®ue
();

4103 
	`‹¡_h—d”_ov”æow_”rÜ
(
HTTP_REQUEST
);

4104 
	`‹¡_no_ov”æow_lÚg_body
(
HTTP_REQUEST
, 1000);

4105 
	`‹¡_no_ov”æow_lÚg_body
(
HTTP_REQUEST
, 100000);

4107 
	`‹¡_h—d”_ov”æow_”rÜ
(
HTTP_RESPONSE
);

4108 
	`‹¡_no_ov”æow_lÚg_body
(
HTTP_RESPONSE
, 1000);

4109 
	`‹¡_no_ov”æow_lÚg_body
(
HTTP_RESPONSE
, 100000);

4111 
	`‹¡_h—d”_cÚ‹Á_Ëngth_ov”æow_”rÜ
();

4112 
	`‹¡_chunk_cÚ‹Á_Ëngth_ov”æow_”rÜ
();

4115 
	`‹¡_doubË_cÚ‹Á_Ëngth_”rÜ
(
HTTP_REQUEST
);

4116 
	`‹¡_chunked_cÚ‹Á_Ëngth_”rÜ
(
HTTP_REQUEST
);

4117 
	`‹¡_h—d”_ü_no_lf_”rÜ
(
HTTP_REQUEST
);

4118 
	`‹¡_šv®id_h—d”_f›ld_tok’_”rÜ
(
HTTP_REQUEST
);

4119 
	`‹¡_šv®id_h—d”_f›ld_cÚ‹Á_”rÜ
(
HTTP_REQUEST
);

4120 
	`‹¡_doubË_cÚ‹Á_Ëngth_”rÜ
(
HTTP_RESPONSE
);

4121 
	`‹¡_chunked_cÚ‹Á_Ëngth_”rÜ
(
HTTP_RESPONSE
);

4122 
	`‹¡_h—d”_ü_no_lf_”rÜ
(
HTTP_RESPONSE
);

4123 
	`‹¡_šv®id_h—d”_f›ld_tok’_”rÜ
(
HTTP_RESPONSE
);

4124 
	`‹¡_šv®id_h—d”_f›ld_cÚ‹Á_”rÜ
(
HTTP_RESPONSE
);

4128 
	`‹¡_sim¶e_ty³
("HTP/1.1 200 OK\r\n\r\n", 
HPE_INVALID_VERSION
, 
HTTP_RESPONSE
);

4129 
	`‹¡_sim¶e_ty³
("HTTP/01.1 200 OK\r\n\r\n", 
HPE_INVALID_VERSION
, 
HTTP_RESPONSE
);

4130 
	`‹¡_sim¶e_ty³
("HTTP/11.1 200 OK\r\n\r\n", 
HPE_INVALID_VERSION
, 
HTTP_RESPONSE
);

4131 
	`‹¡_sim¶e_ty³
("HTTP/1.01 200 OK\r\n\r\n", 
HPE_INVALID_VERSION
, 
HTTP_RESPONSE
);

4132 
	`‹¡_sim¶e_ty³
("HTTP/1.1\t200 OK\r\n\r\n", 
HPE_INVALID_VERSION
, 
HTTP_RESPONSE
);

4134 
i
 = 0; i < 
»¥Ú£_couÁ
; i++) {

4135 
	`‹¡_mes§ge
(&
»¥Ú£s
[
i
]);

4138 
i
 = 0; i < 
»¥Ú£_couÁ
; i++) {

4139 
	`‹¡_mes§ge_·u£
(&
»¥Ú£s
[
i
]);

4142 
i
 = 0; i < 
»¥Ú£_couÁ
; i++) {

4143 
	`‹¡_mes§ge_cÚÃù
(&
»¥Ú£s
[
i
]);

4146 
i
 = 0; i < 
»¥Ú£_couÁ
; i++) {

4147 ià(!
»¥Ú£s
[
i
].
should_k“p_®ive
) ;

4148 
j
 = 0; j < 
»¥Ú£_couÁ
; j++) {

4149 ià(!
»¥Ú£s
[
j
].
should_k“p_®ive
) ;

4150 
k
 = 0; k < 
»¥Ú£_couÁ
; k++) {

4151 
	`‹¡_muÉË3
(&
»¥Ú£s
[
i
], &»¥Ú£s[
j
], &»¥Ú£s[
k
]);

4156 
	`‹¡_mes§ge_couÁ_body
(&
»¥Ú£s
[
NO_HEADERS_NO_BODY_404
]);

4157 
	`‹¡_mes§ge_couÁ_body
(&
»¥Ú£s
[
TRAILING_SPACE_ON_CHUNKED_BODY
]);

4161 * 
msg
 = 
	`ü—‹_Ïrge_chunked_mes§ge
(31337,

4166 
mes§ge
 
Ïrge_chunked
 =

4167 {.
Çme
= "large chunked"

4168 ,.
ty³
ğ
HTTP_RESPONSE


4169 ,.
¿w
ğ
msg


4170 ,.
should_k“p_®ive
ğ
FALSE


4171 ,.
mes§ge_com¶‘e_Ú_eof
ğ
FALSE


4172 ,.
h‰p_majÜ
= 1

4173 ,.
h‰p_mšÜ
= 0

4174 ,.
¡©us_code
= 200

4175 ,.
»¥Ú£_¡©us
= "OK"

4176 ,.
num_h—d”s
= 2

4177 ,.
h—d”s
=

4181 ,.
body_size
= 31337*1024

4182 ,.
num_chunks_com¶‘e
= 31338

4184 
i
 = 0; i < 
MAX_CHUNKS
; i++) {

4185 
Ïrge_chunked
.
chunk_Ëngths
[
i
] = 1024;

4187 
	`‹¡_mes§ge_couÁ_body
(&
Ïrge_chunked
);

4188 
	`ä“
(
msg
);

4193 
	`´štf
("response scan 1/2 ");

4194 
	`‹¡_sÿn
Ğ&
»¥Ú£s
[
TRAILING_SPACE_ON_CHUNKED_BODY
]

4195 , &
»¥Ú£s
[
NO_BODY_HTTP10_KA_204
]

4196 , &
»¥Ú£s
[
NO_REASON_PHRASE
]

4199 
	`´štf
("response scan 2/2 ");

4200 
	`‹¡_sÿn
Ğ&
»¥Ú£s
[
BONJOUR_MADAME_FR
]

4201 , &
»¥Ú£s
[
UNDERSTORE_HEADER_KEY
]

4202 , &
»¥Ú£s
[
NO_CARRIAGE_RET
]

4205 
	`puts
("responses okay");

4210 
	`‹¡_sim¶e
("GET / HTP/1.1\r\n\r\n", 
HPE_INVALID_VERSION
);

4211 
	`‹¡_sim¶e
("GET / HTTP/01.1\r\n\r\n", 
HPE_INVALID_VERSION
);

4212 
	`‹¡_sim¶e
("GET / HTTP/11.1\r\n\r\n", 
HPE_INVALID_VERSION
);

4213 
	`‹¡_sim¶e
("GET / HTTP/1.01\r\n\r\n", 
HPE_INVALID_VERSION
);

4216 
	`‹¡_sim¶e
("GET / HTTP/1.1\r\n"

4218 
HPE_OK
);

4221 
	`‹¡_sim¶e
("GET / HTTP/1.1\r\n"

4226 
HPE_OK
);

4228 cÚ¡ *
®l_m‘hods
[] = {

4263 cÚ¡ **
this_m‘hod
;

4264 
this_m‘hod
 = 
®l_m‘hods
; *this_method;his_method++) {

4265 
buf
[200];

4266 
	`¥rštf
(
buf
, "% / HTTP/1.1\r\n\r\n", *
this_m‘hod
);

4267 
	`‹¡_sim¶e
(
buf
, 
HPE_OK
);

4270 cÚ¡ *
bad_m‘hods
[] = {

4284 
this_m‘hod
 = 
bad_m‘hods
; *this_method;his_method++) {

4285 
buf
[200];

4286 
	`¥rštf
(
buf
, "% / HTTP/1.1\r\n\r\n", *
this_m‘hod
);

4287 
	`‹¡_sim¶e
(
buf
, 
HPE_INVALID_METHOD
);

4291 
	`‹¡_sim¶e
("GET / HTTP/1.1\r\n"

4295 
HPE_INVALID_HEADER_TOKEN
);

4297 cÚ¡ *
dumbfuck2
 =

4332 
	`‹¡_sim¶e
(
dumbfuck2
, 
HPE_OK
);

4334 cÚ¡ *
cÜru±ed_cÚÃùiÚ
 =

4340 
	`‹¡_sim¶e
(
cÜru±ed_cÚÃùiÚ
, 
HPE_INVALID_HEADER_TOKEN
);

4342 cÚ¡ *
cÜru±ed_h—d”_Çme
 =

4348 
	`‹¡_sim¶e
(
cÜru±ed_h—d”_Çme
, 
HPE_INVALID_HEADER_TOKEN
);

4356 cÚ¡ *
bad_g‘_no_h—d”s_no_body
 = "GET /bad_get_no_headers_no_body/world HTTP/1.1\r\n"

4360 
	`‹¡_sim¶e
(
bad_g‘_no_h—d”s_no_body
, 0);

4366 
i
 = 0; 
»que¡s
[i].
Çme
; i++) {

4367 
	`‹¡_mes§ge
(&
»que¡s
[
i
]);

4370 
i
 = 0; i < 
»que¡_couÁ
; i++) {

4371 
	`‹¡_mes§ge_·u£
(&
»que¡s
[
i
]);

4374 
i
 = 0; i < 
»que¡_couÁ
; i++) {

4375 ià(!
»que¡s
[
i
].
should_k“p_®ive
) ;

4376 
j
 = 0; j < 
»que¡_couÁ
; j++) {

4377 ià(!
»que¡s
[
j
].
should_k“p_®ive
) ;

4378 
k
 = 0; k < 
»que¡_couÁ
; k++) {

4379 
	`‹¡_muÉË3
(&
»que¡s
[
i
], &»que¡s[
j
], &»que¡s[
k
]);

4384 
	`´štf
("request scan 1/4 ");

4385 
	`‹¡_sÿn
Ğ&
»que¡s
[
GET_NO_HEADERS_NO_BODY
]

4386 , &
»que¡s
[
GET_ONE_HEADER_NO_BODY
]

4387 , &
»que¡s
[
GET_NO_HEADERS_NO_BODY
]

4390 
	`´štf
("request scan 2/4 ");

4391 
	`‹¡_sÿn
Ğ&
»que¡s
[
POST_CHUNKED_ALL_YOUR_BASE
]

4392 , &
»que¡s
[
POST_IDENTITY_BODY_WORLD
]

4393 , &
»que¡s
[
GET_FUNKY_CONTENT_LENGTH
]

4396 
	`´štf
("request scan 3/4 ");

4397 
	`‹¡_sÿn
Ğ&
»que¡s
[
TWO_CHUNKS_MULT_ZERO_END
]

4398 , &
»que¡s
[
CHUNKED_W_TRAILING_HEADERS
]

4399 , &
»que¡s
[
CHUNKED_W_BULLSHIT_AFTER_LENGTH
]

4402 
	`´štf
("request scan 4/4 ");

4403 
	`‹¡_sÿn
Ğ&
»que¡s
[
QUERY_URL_WITH_QUESTION_MARK_GET
]

4404 , &
»que¡s
[
PREFIX_NEWLINE_GET
 ]

4405 , &
»que¡s
[
CONNECT_REQUEST
]

4408 
	`puts
("requests okay");

4411 
	}
}

	@
1
.
0
124
2617
config.h
examples/client.cc
examples/client.h
examples/crypto.cc
examples/crypto.h
examples/crypto_openssl.cc
examples/debug.cc
examples/debug.h
examples/examplestest.cc
examples/http.cc
examples/http.h
examples/keylog.cc
examples/keylog.h
examples/network.h
examples/server.cc
examples/server.h
examples/shared.h
examples/template.h
examples/util.cc
examples/util.h
examples/util_test.cc
examples/util_test.h
lib/includes/ngtcp2/ngtcp2.h
lib/includes/ngtcp2/version.h
lib/ngtcp2_acktr.c
lib/ngtcp2_acktr.h
lib/ngtcp2_addr.c
lib/ngtcp2_addr.h
lib/ngtcp2_buf.c
lib/ngtcp2_buf.h
lib/ngtcp2_cc.c
lib/ngtcp2_cc.h
lib/ngtcp2_cid.c
lib/ngtcp2_cid.h
lib/ngtcp2_conn.c
lib/ngtcp2_conn.h
lib/ngtcp2_conv.c
lib/ngtcp2_conv.h
lib/ngtcp2_crypto.c
lib/ngtcp2_crypto.h
lib/ngtcp2_err.c
lib/ngtcp2_err.h
lib/ngtcp2_gaptr.c
lib/ngtcp2_gaptr.h
lib/ngtcp2_idtr.c
lib/ngtcp2_idtr.h
lib/ngtcp2_ksl.c
lib/ngtcp2_ksl.h
lib/ngtcp2_log.c
lib/ngtcp2_log.h
lib/ngtcp2_macro.h
lib/ngtcp2_map.c
lib/ngtcp2_map.h
lib/ngtcp2_mem.c
lib/ngtcp2_mem.h
lib/ngtcp2_path.c
lib/ngtcp2_path.h
lib/ngtcp2_pkt.c
lib/ngtcp2_pkt.h
lib/ngtcp2_ppe.c
lib/ngtcp2_ppe.h
lib/ngtcp2_pq.c
lib/ngtcp2_pq.h
lib/ngtcp2_psl.c
lib/ngtcp2_psl.h
lib/ngtcp2_pv.c
lib/ngtcp2_pv.h
lib/ngtcp2_range.c
lib/ngtcp2_range.h
lib/ngtcp2_ringbuf.c
lib/ngtcp2_ringbuf.h
lib/ngtcp2_rob.c
lib/ngtcp2_rob.h
lib/ngtcp2_rtb.c
lib/ngtcp2_rtb.h
lib/ngtcp2_str.c
lib/ngtcp2_str.h
lib/ngtcp2_strm.c
lib/ngtcp2_strm.h
lib/ngtcp2_vec.c
lib/ngtcp2_vec.h
tests/main.c
tests/ngtcp2_acktr_test.c
tests/ngtcp2_acktr_test.h
tests/ngtcp2_conn_test.c
tests/ngtcp2_conn_test.h
tests/ngtcp2_conv_test.c
tests/ngtcp2_conv_test.h
tests/ngtcp2_crypto_test.c
tests/ngtcp2_crypto_test.h
tests/ngtcp2_gaptr_test.c
tests/ngtcp2_gaptr_test.h
tests/ngtcp2_idtr_test.c
tests/ngtcp2_idtr_test.h
tests/ngtcp2_ksl_test.c
tests/ngtcp2_ksl_test.h
tests/ngtcp2_map_test.c
tests/ngtcp2_map_test.h
tests/ngtcp2_pkt_test.c
tests/ngtcp2_pkt_test.h
tests/ngtcp2_psl_test.c
tests/ngtcp2_psl_test.h
tests/ngtcp2_pv_test.c
tests/ngtcp2_pv_test.h
tests/ngtcp2_range_test.c
tests/ngtcp2_range_test.h
tests/ngtcp2_ringbuf_test.c
tests/ngtcp2_ringbuf_test.h
tests/ngtcp2_rob_test.c
tests/ngtcp2_rob_test.h
tests/ngtcp2_rtb_test.c
tests/ngtcp2_rtb_test.h
tests/ngtcp2_strm_test.c
tests/ngtcp2_strm_test.h
tests/ngtcp2_test_helper.c
tests/ngtcp2_test_helper.h
tests/ngtcp2_vec_test.c
tests/ngtcp2_vec_test.h
third-party/http-parser/bench.c
third-party/http-parser/contrib/parsertrace.c
third-party/http-parser/contrib/url_parser.c
third-party/http-parser/http_parser.c
third-party/http-parser/http_parser.h
third-party/http-parser/test.c
